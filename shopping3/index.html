<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.14" />
    <style>
      :root {
        --c-bg: #fff;
      }

      html.dark {
        --c-bg: #22272e;
      }

      html,
      body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia('(prefers-color-scheme: dark)').matches

      if (userMode === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (userMode === 'dark' || systemDarkMode) {
        document.documentElement.classList.toggle('dark', true)
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <link rel="icon" href="/lucy.ico"><title>二手交易网项目 | 彗星文档</title><meta name="description" content="繁星似海 熠熠生辉">
    <link rel="preload" href="/assets/style-CPtAZutf.css" as="style"><link rel="stylesheet" href="/assets/style-CPtAZutf.css">
    <link rel="modulepreload" href="/assets/app-CiSBoDQ3.js"><link rel="modulepreload" href="/assets/index.html-ClZxc1st.js">
    <link rel="prefetch" href="/assets/about.html-wV2yNvuu.js" as="script"><link rel="prefetch" href="/assets/index.html-BYnnuSRx.js" as="script"><link rel="prefetch" href="/assets/activiti.html-Cb_jK_iq.js" as="script"><link rel="prefetch" href="/assets/index.html-DdsBykgo.js" as="script"><link rel="prefetch" href="/assets/css.html-CwCx0R0j.js" as="script"><link rel="prefetch" href="/assets/index.html-Ckud_eAb.js" as="script"><link rel="prefetch" href="/assets/datastructure.html-DcWEnLSc.js" as="script"><link rel="prefetch" href="/assets/index.html-CPQzaKp9.js" as="script"><link rel="prefetch" href="/assets/design.html-2FzvzKOk.js" as="script"><link rel="prefetch" href="/assets/index.html-JnI1BS5-.js" as="script"><link rel="prefetch" href="/assets/docker.html-Br3fXjmj.js" as="script"><link rel="prefetch" href="/assets/index.html-DfqN304W.js" as="script"><link rel="prefetch" href="/assets/elk1.html-B3oAIOxw.js" as="script"><link rel="prefetch" href="/assets/index.html-BiyOKAJn.js" as="script"><link rel="prefetch" href="/assets/elk2.html-CnHJFV9b.js" as="script"><link rel="prefetch" href="/assets/index.html-CJDBS2wV.js" as="script"><link rel="prefetch" href="/assets/html.html-D_mk2K_S.js" as="script"><link rel="prefetch" href="/assets/index.html-bWKnOvj3.js" as="script"><link rel="prefetch" href="/assets/abnormal.html-B3EwKTlY.js" as="script"><link rel="prefetch" href="/assets/api.html-BCTmaCdl.js" as="script"><link rel="prefetch" href="/assets/base.html-boeFwZlx.js" as="script"><link rel="prefetch" href="/assets/encapsulation.html-DjUI5-I-.js" as="script"><link rel="prefetch" href="/assets/Inheritance.html-clo1QiSy.js" as="script"><link rel="prefetch" href="/assets/JVM.html-Bq5SIjE7.js" as="script"><link rel="prefetch" href="/assets/other.html-CF2BLrRW.js" as="script"><link rel="prefetch" href="/assets/polymorphism.html-BgaWnHHM.js" as="script"><link rel="prefetch" href="/assets/index.html-CDcVLcEi.js" as="script"><link rel="prefetch" href="/assets/collection.html-i0k9SgMj.js" as="script"><link rel="prefetch" href="/assets/enum.html-DDCsi4Z-.js" as="script"><link rel="prefetch" href="/assets/format.html-CbNdZn9y.js" as="script"><link rel="prefetch" href="/assets/Generics.html-hU5FsvzJ.js" as="script"><link rel="prefetch" href="/assets/iostream.html-Db8Rc5Zy.js" as="script"><link rel="prefetch" href="/assets/NIO.html-DBlS8bNK.js" as="script"><link rel="prefetch" href="/assets/index.html-TBbOdnEb.js" as="script"><link rel="prefetch" href="/assets/reflection.html-CC70fnyj.js" as="script"><link rel="prefetch" href="/assets/socket.html-CLiBd0gb.js" as="script"><link rel="prefetch" href="/assets/thread.html-DMburY4V.js" as="script"><link rel="prefetch" href="/assets/tree.html-COhv9VtZ.js" as="script"><link rel="prefetch" href="/assets/jdbc.html-1CBYwwq-.js" as="script"><link rel="prefetch" href="/assets/index.html-CueiqX14.js" as="script"><link rel="prefetch" href="/assets/js.html-C9_NLBnY.js" as="script"><link rel="prefetch" href="/assets/index.html-C9mPge9P.js" as="script"><link rel="prefetch" href="/assets/log.html-Dh0Da6Hc.js" as="script"><link rel="prefetch" href="/assets/index.html-yLFEegXw.js" as="script"><link rel="prefetch" href="/assets/maven.html-DOdAv6Dm.js" as="script"><link rel="prefetch" href="/assets/index.html-CK3XceL4.js" as="script"><link rel="prefetch" href="/assets/message.html-CdC4TXuL.js" as="script"><link rel="prefetch" href="/assets/index.html-B0Sxc9Up.js" as="script"><link rel="prefetch" href="/assets/mybatis.html-DYWn_zKL.js" as="script"><link rel="prefetch" href="/assets/index.html-BIXAmUnG.js" as="script"><link rel="prefetch" href="/assets/mybatisplus.html-BMO44mtw.js" as="script"><link rel="prefetch" href="/assets/index.html-k_2IJtM3.js" as="script"><link rel="prefetch" href="/assets/mysql-rise.html-CJy7CAtY.js" as="script"><link rel="prefetch" href="/assets/index.html-CpMHL-FV.js" as="script"><link rel="prefetch" href="/assets/mysql-base.html-BblyU_z5.js" as="script"><link rel="prefetch" href="/assets/index.html-Bul-465b.js" as="script"><link rel="prefetch" href="/assets/nginx.html-Bf-he9CQ.js" as="script"><link rel="prefetch" href="/assets/index.html-rjZyarl0.js" as="script"><link rel="prefetch" href="/assets/archive1.html-DHoF1GVt.js" as="script"><link rel="prefetch" href="/assets/archive2.html-CaMpKLlM.js" as="script"><link rel="prefetch" href="/assets/article1.html-C7wj3Hnv.js" as="script"><link rel="prefetch" href="/assets/article10.html-BtPemjqh.js" as="script"><link rel="prefetch" href="/assets/article11.html-DBFUN38F.js" as="script"><link rel="prefetch" href="/assets/article12.html-Dzwejx3Q.js" as="script"><link rel="prefetch" href="/assets/article2.html-BYw8UrU9.js" as="script"><link rel="prefetch" href="/assets/article3.html-D7169oIX.js" as="script"><link rel="prefetch" href="/assets/article4.html-DiEowTEu.js" as="script"><link rel="prefetch" href="/assets/article5.html-C1N4DckH.js" as="script"><link rel="prefetch" href="/assets/article6.html-BN6iWA0i.js" as="script"><link rel="prefetch" href="/assets/article7.html-BENraJ5c.js" as="script"><link rel="prefetch" href="/assets/article8.html-DZ7RCxf7.js" as="script"><link rel="prefetch" href="/assets/article9.html-DyuvOqau.js" as="script"><link rel="prefetch" href="/assets/sticky.html-BNm6Btrk.js" as="script"><link rel="prefetch" href="/assets/sticky2.html-BKsRDd3r.js" as="script"><link rel="prefetch" href="/assets/questions.html-reTBywrv.js" as="script"><link rel="prefetch" href="/assets/index.html-NLEllAin.js" as="script"><link rel="prefetch" href="/assets/index.html-Dp-yObq6.js" as="script"><link rel="prefetch" href="/assets/redis.html-B5tiJguG.js" as="script"><link rel="prefetch" href="/assets/rabbitmq.html-HJNn-_qX.js" as="script"><link rel="prefetch" href="/assets/index.html-hRD04cS1.js" as="script"><link rel="prefetch" href="/assets/index.html-bBc3H7qI.js" as="script"><link rel="prefetch" href="/assets/rocketmq.html-BBIVwRGw.js" as="script"><link rel="prefetch" href="/assets/buy1.html-6OjYnxlq.js" as="script"><link rel="prefetch" href="/assets/index.html-DazXYzH-.js" as="script"><link rel="prefetch" href="/assets/buy2.html-eI4dxe1r.js" as="script"><link rel="prefetch" href="/assets/index.html-CuQYXhsJ.js" as="script"><link rel="prefetch" href="/assets/buy3.html-C5KdoHEF.js" as="script"><link rel="prefetch" href="/assets/index.html-BDlpmZ9-.js" as="script"><link rel="prefetch" href="/assets/sort.html-BQs0X5fF.js" as="script"><link rel="prefetch" href="/assets/index.html-CCcFhZPa.js" as="script"><link rel="prefetch" href="/assets/spring.html-B84j2uGJ.js" as="script"><link rel="prefetch" href="/assets/index.html-CJ7G0l91.js" as="script"><link rel="prefetch" href="/assets/springboot.html-6bL431Xo.js" as="script"><link rel="prefetch" href="/assets/index.html-v7I1pr8g.js" as="script"><link rel="prefetch" href="/assets/springcloudalibaba.html-t2WNLzKd.js" as="script"><link rel="prefetch" href="/assets/index.html-Bu1uLPky.js" as="script"><link rel="prefetch" href="/assets/springcloud.html-DYMN4LP5.js" as="script"><link rel="prefetch" href="/assets/index.html-DBwvEGhD.js" as="script"><link rel="prefetch" href="/assets/springdata-jpa.html-B9rkwgnb.js" as="script"><link rel="prefetch" href="/assets/index.html-BSk2K6RS.js" as="script"><link rel="prefetch" href="/assets/springmvc.html-Dj3KfPKx.js" as="script"><link rel="prefetch" href="/assets/index.html-VnyIy73e.js" as="script"><link rel="prefetch" href="/assets/springsecurity.html-pai0Fncc.js" as="script"><link rel="prefetch" href="/assets/index.html-BBwTmuaT.js" as="script"><link rel="prefetch" href="/assets/ssm.html--LJ51UoR.js" as="script"><link rel="prefetch" href="/assets/index.html-ChyaU-q1.js" as="script"><link rel="prefetch" href="/assets/linux.html-x7t9EqDd.js" as="script"><link rel="prefetch" href="/assets/index.html-BDWR3jgj.js" as="script"><link rel="prefetch" href="/assets/git.html-BTH3_mHD.js" as="script"><link rel="prefetch" href="/assets/index.html-BaRVV2Lg.js" as="script"><link rel="prefetch" href="/assets/index.html-DwkhEwFN.js" as="script"><link rel="prefetch" href="/assets/web.html-BQMzalyu.js" as="script"><link rel="prefetch" href="/assets/404.html-BQmZJoxb.js" as="script"><link rel="prefetch" href="/assets/index.html-B3-U4brV.js" as="script"><link rel="prefetch" href="/assets/index.html--TZaAjDD.js" as="script"><link rel="prefetch" href="/assets/index.html-B4yllirZ.js" as="script"><link rel="prefetch" href="/assets/index.html-DPYrzjiL.js" as="script"><link rel="prefetch" href="/assets/index.html-x3X7peOq.js" as="script"><link rel="prefetch" href="/assets/index.html-CdffHRxP.js" as="script"><link rel="prefetch" href="/assets/index.html-D-yEg0ev.js" as="script"><link rel="prefetch" href="/assets/index.html-0u-R21Sg.js" as="script"><link rel="prefetch" href="/assets/index.html-BFtfDIz1.js" as="script"><link rel="prefetch" href="/assets/index.html-DodGeBLO.js" as="script"><link rel="prefetch" href="/assets/index.html-ehzR16_a.js" as="script"><link rel="prefetch" href="/assets/index.html-YpqYXRC0.js" as="script"><link rel="prefetch" href="/assets/index.html-DoLH-5c5.js" as="script"><link rel="prefetch" href="/assets/index.html-BlQrOYeY.js" as="script"><link rel="prefetch" href="/assets/index.html-DhefNKm3.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon"><!--[--><header class="vp-navbar"><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/"><img class="vp-site-logo" src="/comet.png" alt="彗星文档"><span class="vp-site-name vp-hide-mobile" aria-hidden="true">彗星文档</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="主页"><!---->主页<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/about.html" aria-label="关于"><!---->关于<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/study-direction/" aria-label="学习路线"><!---->学习路线<!----></a></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="JavaSE"><span class="title">JavaSE</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="JavaSE"><span class="title">JavaSE</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>JavaSE上</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/JavaSE1/" aria-label="1.基础~8.异常处理"><!---->1.基础~8.异常处理<!----></a></li><!--]--></ul><!--]--></li><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>JavaSE下</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/JavaSE2/" aria-label="9.泛型~18.正则表达式"><!---->9.泛型~18.正则表达式<!----></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="运维工具"><span class="title">运维工具</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="运维工具"><span class="title">运维工具</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>虚拟机</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/virtual-system/" aria-label="Linux"><!---->Linux<!----></a></li><!--]--></ul><!--]--></li><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>多人协同</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/tools/" aria-label="Git"><!---->Git<!----></a></li><!--]--></ul><!--]--></li><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>镜像</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/docker/" aria-label="Docker"><!---->Docker<!----></a></li><!--]--></ul><!--]--></li><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>工作流</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/activiti/" aria-label="Activiti工作流引擎"><!---->Activiti工作流引擎<!----></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="数据库"><span class="title">数据库</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="数据库"><span class="title">数据库</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>MySQL</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/mysql1/" aria-label="MySQL上"><!---->MySQL上<!----></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/mysql2/" aria-label="MySQL下"><!---->MySQL下<!----></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="JavaWeb"><span class="title">JavaWeb</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="JavaWeb"><span class="title">JavaWeb</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/jdbc/" aria-label="1.JDBC"><!---->1.JDBC<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/html/" aria-label="2.HTML"><!---->2.HTML<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/css/" aria-label="3.CSS"><!---->3.CSS<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/js/" aria-label="4.JS"><!---->4.JS<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/web/" aria-label="5.Web"><!---->5.Web<!----></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="框架"><span class="title">框架</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="框架"><span class="title">框架</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/log/" aria-label="1.日志"><!---->1.日志<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/maven/" aria-label="2.Maven"><!---->2.Maven<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/design/" aria-label="3.设计模式"><!---->3.设计模式<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/mybatis/" aria-label="4.MyBatis"><!---->4.MyBatis<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/spring/" aria-label="5.Spring"><!---->5.Spring<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/springmvc/" aria-label="6.SpringMVC"><!---->6.SpringMVC<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/mybatis-plus/" aria-label="7.MyBatisPlus"><!---->7.MyBatisPlus<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/redis/" aria-label="8.Redis"><!---->8.Redis<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/springboot/" aria-label="9.SpringBoot"><!---->9.SpringBoot<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/springdata-jpa/" aria-label="10.SpringData-jpa"><!---->10.SpringData-jpa<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/springsecurity/" aria-label="11.SpringSecurity"><!---->11.SpringSecurity<!----></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="分布式组件"><span class="title">分布式组件</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="分布式组件"><span class="title">分布式组件</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/nginx/" aria-label="1.Nginx"><!---->1.Nginx<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/springcloud/" aria-label="2.SpringCloud"><!---->2.SpringCloud<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/springcloud-alibaba/" aria-label="3.SprngCloud-AliBaBa"><!---->3.SprngCloud-AliBaBa<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/elk1/" aria-label="4.ELK(上)"><!---->4.ELK(上)<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/elk2/" aria-label="5.ELK(下)"><!---->5.ELK(下)<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/rocketmq/" aria-label="6.RocketMQ"><!---->6.RocketMQ<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/rabbitmq/" aria-label="7.RabbitMQ"><!---->7.RabbitMQ<!----></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="项目"><span class="title">项目</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="项目"><span class="title">项目</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>综合项目</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/ssm/" aria-label="1.SSM小项目"><!---->1.SSM小项目<!----></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/message/" aria-label="2.短信调度"><!---->2.短信调度<!----></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/shopping1/" aria-label="二手交易网(上)"><!---->二手交易网(上)<!----></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/shopping2/" aria-label="二手交易网(中)"><!---->二手交易网(中)<!----></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link route-link-active auto-link" href="/shopping3/" aria-label="二手交易网(下)"><!---->二手交易网(下)<!----></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="算法"><span class="title">算法</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="算法"><span class="title">算法</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/sort/" aria-label="1.排序算法"><!---->1.排序算法<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/datastructure/" aria-label="2.基本数据结构与算法"><!---->2.基本数据结构与算法<!----></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/question/" aria-label="遇到的问题"><!---->遇到的问题<!----></a></div><!--]--></nav><!--[--><!--]--><button class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar"><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="主页"><!---->主页<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/about.html" aria-label="关于"><!---->关于<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/study-direction/" aria-label="学习路线"><!---->学习路线<!----></a></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="JavaSE"><span class="title">JavaSE</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="JavaSE"><span class="title">JavaSE</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>JavaSE上</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/JavaSE1/" aria-label="1.基础~8.异常处理"><!---->1.基础~8.异常处理<!----></a></li><!--]--></ul><!--]--></li><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>JavaSE下</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/JavaSE2/" aria-label="9.泛型~18.正则表达式"><!---->9.泛型~18.正则表达式<!----></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="运维工具"><span class="title">运维工具</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="运维工具"><span class="title">运维工具</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>虚拟机</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/virtual-system/" aria-label="Linux"><!---->Linux<!----></a></li><!--]--></ul><!--]--></li><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>多人协同</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/tools/" aria-label="Git"><!---->Git<!----></a></li><!--]--></ul><!--]--></li><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>镜像</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/docker/" aria-label="Docker"><!---->Docker<!----></a></li><!--]--></ul><!--]--></li><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>工作流</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/activiti/" aria-label="Activiti工作流引擎"><!---->Activiti工作流引擎<!----></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="数据库"><span class="title">数据库</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="数据库"><span class="title">数据库</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>MySQL</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/mysql1/" aria-label="MySQL上"><!---->MySQL上<!----></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/mysql2/" aria-label="MySQL下"><!---->MySQL下<!----></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="JavaWeb"><span class="title">JavaWeb</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="JavaWeb"><span class="title">JavaWeb</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/jdbc/" aria-label="1.JDBC"><!---->1.JDBC<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/html/" aria-label="2.HTML"><!---->2.HTML<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/css/" aria-label="3.CSS"><!---->3.CSS<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/js/" aria-label="4.JS"><!---->4.JS<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/web/" aria-label="5.Web"><!---->5.Web<!----></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="框架"><span class="title">框架</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="框架"><span class="title">框架</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/log/" aria-label="1.日志"><!---->1.日志<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/maven/" aria-label="2.Maven"><!---->2.Maven<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/design/" aria-label="3.设计模式"><!---->3.设计模式<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/mybatis/" aria-label="4.MyBatis"><!---->4.MyBatis<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/spring/" aria-label="5.Spring"><!---->5.Spring<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/springmvc/" aria-label="6.SpringMVC"><!---->6.SpringMVC<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/mybatis-plus/" aria-label="7.MyBatisPlus"><!---->7.MyBatisPlus<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/redis/" aria-label="8.Redis"><!---->8.Redis<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/springboot/" aria-label="9.SpringBoot"><!---->9.SpringBoot<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/springdata-jpa/" aria-label="10.SpringData-jpa"><!---->10.SpringData-jpa<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/springsecurity/" aria-label="11.SpringSecurity"><!---->11.SpringSecurity<!----></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="分布式组件"><span class="title">分布式组件</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="分布式组件"><span class="title">分布式组件</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/nginx/" aria-label="1.Nginx"><!---->1.Nginx<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/springcloud/" aria-label="2.SpringCloud"><!---->2.SpringCloud<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/springcloud-alibaba/" aria-label="3.SprngCloud-AliBaBa"><!---->3.SprngCloud-AliBaBa<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/elk1/" aria-label="4.ELK(上)"><!---->4.ELK(上)<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/elk2/" aria-label="5.ELK(下)"><!---->5.ELK(下)<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/rocketmq/" aria-label="6.RocketMQ"><!---->6.RocketMQ<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/rabbitmq/" aria-label="7.RabbitMQ"><!---->7.RabbitMQ<!----></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="项目"><span class="title">项目</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="项目"><span class="title">项目</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>综合项目</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/ssm/" aria-label="1.SSM小项目"><!---->1.SSM小项目<!----></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/message/" aria-label="2.短信调度"><!---->2.短信调度<!----></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/shopping1/" aria-label="二手交易网(上)"><!---->二手交易网(上)<!----></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/shopping2/" aria-label="二手交易网(中)"><!---->二手交易网(中)<!----></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link route-link-active auto-link" href="/shopping3/" aria-label="二手交易网(下)"><!---->二手交易网(下)<!----></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="算法"><span class="title">算法</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="算法"><span class="title">算法</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/sort/" aria-label="1.排序算法"><!---->1.排序算法<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/datastructure/" aria-label="2.基本数据结构与算法"><!---->2.基本数据结构与算法<!----></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/question/" aria-label="遇到的问题"><!---->遇到的问题<!----></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading collapsible">目录 <span class="right arrow"></span></p><ul style="display:none;" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/shopping3/buy3.html" aria-label="二手交易网(下)"><!---->二手交易网(下)<!----></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="二手交易网项目" tabindex="-1"><a class="header-anchor" href="#二手交易网项目"><span>二手交易网项目</span></a></h1><h2 id="第11章-订单" tabindex="-1"><a class="header-anchor" href="#第11章-订单"><span>第11章 订单</span></a></h2><p><strong>角色</strong>： 订单模块，后端开发工程师。</p><h2 id="课程内容" tabindex="-1"><a class="header-anchor" href="#课程内容"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#%E8%AF%BE%E7%A8%8B%E5%86%85%E5%AE%B9" target="_blank" rel="noopener noreferrer">#</a>课程内容</span></a></h2><ol><li>完成订单结算页渲染</li><li>完成用户下单实现</li><li>完成库存变更实现</li></ol><h2 id="_1-订单结算页" tabindex="-1"><a class="header-anchor" href="#_1-订单结算页"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-%E8%AE%A2%E5%8D%95%E7%BB%93%E7%AE%97%E9%A1%B5" target="_blank" rel="noopener noreferrer">#</a>1 订单结算页</span></a></h2><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211205120105277.822cd0df.png" alt="image-20211205120105277"></p><h3 id="_1-1-收件地址分析" tabindex="-1"><a class="header-anchor" href="#_1-1-收件地址分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-1-%E6%94%B6%E4%BB%B6%E5%9C%B0%E5%9D%80%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>1.1 收件地址分析</span></a></h3><p>1展示 打开前台 order.html</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211205115918039.116ade03.png" alt="image-20211205115918039"></p><p>收件地址分析 td_address表。表结构分析：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211205120007359.1be8e26e.png" alt="image-20211205120007359"></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">CREATE TABLE `tb_address` (</span>
<span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,</span>
<span class="line">  `username` varchar(50) DEFAULT NULL COMMENT &#39;用户名&#39;,</span>
<span class="line">  `provinceid` varchar(20) DEFAULT NULL COMMENT &#39;省&#39;,</span>
<span class="line">  `cityid` varchar(20) DEFAULT NULL COMMENT &#39;市&#39;,</span>
<span class="line">  `areaid` varchar(20) DEFAULT NULL COMMENT &#39;县/区&#39;,</span>
<span class="line">  `phone` varchar(20) DEFAULT NULL COMMENT &#39;电话&#39;,</span>
<span class="line">  `address` varchar(200) DEFAULT NULL COMMENT &#39;详细地址&#39;,</span>
<span class="line">  `contact` varchar(50) DEFAULT NULL COMMENT &#39;联系人&#39;,</span>
<span class="line">  `is_default` varchar(1) DEFAULT NULL COMMENT &#39;是否是默认 1默认 0否&#39;,</span>
<span class="line">  `alias` varchar(50) DEFAULT NULL COMMENT &#39;别名&#39;,</span>
<span class="line">  PRIMARY KEY (`id`)</span>
<span class="line">) ENGINE=InnoDB AUTO_INCREMENT=66 DEFAULT CHARSET=utf8;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13</p><p>我们可以根据用户登录名去tb_address表中查询对应的数据。</p><h3 id="_1-2-实现用户收件地址查询" tabindex="-1"><a class="header-anchor" href="#_1-2-实现用户收件地址查询"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-2-%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E6%94%B6%E4%BB%B6%E5%9C%B0%E5%9D%80%E6%9F%A5%E8%AF%A2" target="_blank" rel="noopener noreferrer">#</a>1.2 实现用户收件地址查询</span></a></h3><h4 id="_1-2-1-代码实现-ydles-service-user" tabindex="-1"><a class="header-anchor" href="#_1-2-1-代码实现-ydles-service-user"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-2-1-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-ydles-service-user" target="_blank" rel="noopener noreferrer">#</a>1.2.1 代码实现 ydles-service-user</span></a></h4><p>1需改com.ydles.user.service.AddressService接口，添加根据用户名字查询用户收件地址信息，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token comment">//根据username 查询</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Address</span><span class="token punctuation">&gt;</span></span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><p>2业务层接口实现类</p><p>修改com.ydles.user.service.impl.AddressServiceImpl类，添加根据用户查询用户收件地址信息实现方法，如下代码：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Address</span><span class="token punctuation">&gt;</span></span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Address</span> address<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        address<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Address</span><span class="token punctuation">&gt;</span></span> addressList <span class="token operator">=</span> addressMapper<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> addressList<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9</p><p>3控制层</p><p>修改com.ydles.user.controller.AddressController，添加根据用户名查询用户收件信息方法，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">TokenDecode</span> tokenDecode<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">	<span class="token comment">//根据username 查询 lsit&lt;Address&gt;</span></span>
<span class="line">    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/list&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Address</span><span class="token punctuation">&gt;</span></span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//当前登录人</span></span>
<span class="line">        <span class="token class-name">String</span> username <span class="token operator">=</span> tokenDecode<span class="token punctuation">.</span><span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Address</span><span class="token punctuation">&gt;</span></span> addressList <span class="token operator">=</span> addressService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> addressList<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13</p><p>4创建TokenDecode</p><p>com.ydles.UserApplication中创建TokenDecode,代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Bean</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">TokenDecode</span> <span class="token function">tokenDecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span>  <span class="token keyword">new</span> <span class="token class-name">TokenDecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p>测试：通过网关访问，修改网关配置信息</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">      routes:</span>
<span class="line">        - id: ydles_goods_route</span>
<span class="line">          uri: lb://goods</span>
<span class="line">          predicates:</span>
<span class="line">            - Path=/api/album/**,/api/brand/**,/api/cache/**,/api/categoryBrand/**,/api/category/**,/api/para/**,/api/pref/**,/api/sku/**,/api/spec/**,/api/spu/**,/api/stockBack/**,/api/template/**</span>
<span class="line">          filters:</span>
<span class="line">            #- PrefixPath=/brand</span>
<span class="line">            - StripPrefix=1</span>
<span class="line">          #用户微服务</span>
<span class="line">        - id: ydles_user_route</span>
<span class="line">          uri: lb://user</span>
<span class="line">          predicates:</span>
<span class="line">            - Path=/api/user/**,/api/address/**,/api/areas/**,/api/cities/**,/api/provinces/**</span>
<span class="line">          filters:</span>
<span class="line">            - StripPrefix=1</span>
<span class="line">          #认证微服务</span>
<span class="line">        - id: ydles_oauth_user</span>
<span class="line">          uri: lb://user-auth</span>
<span class="line">          predicates:</span>
<span class="line">            - Path=/api/oauth/**</span>
<span class="line">          filters:</span>
<span class="line">            - StripPrefix=1</span>
<span class="line">        #订单微服务</span>
<span class="line">        - id: ydles_order_route</span>
<span class="line">          uri: lb://order</span>
<span class="line">          predicates:</span>
<span class="line">            - Path=/api/cart/**,/api/categoryReport/**,/api/orderConfig/**,/api/order/**,/api/orderItem/**,/api/orderLog/**,/api/preferential/**,/api/returnCause/**,/api/returnOrder/**,/api/returnOrderItem/**</span>
<span class="line">          filters:</span>
<span class="line">            - StripPrefix=1</span>
<span class="line">        #购物车订单渲染微服务</span>
<span class="line">        - id: ydles_order_web_route</span>
<span class="line">          uri: lb://order-web</span>
<span class="line">          predicates:</span>
<span class="line">            - Path=/api/wcart/**,/api/worder/**</span>
<span class="line">          filters:</span>
<span class="line">            - StripPrefix=1</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>先登录 Postman访问 http://localhost:8001/api/oauth/login</p><p>再请求数据 Postman访问 http://localhost:8001/api/address/list</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211205121817519.09881489.png" alt="image-20211205121817519"></p><h3 id="_1-3-页面模板渲染" tabindex="-1"><a class="header-anchor" href="#_1-3-页面模板渲染"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-3-%E9%A1%B5%E9%9D%A2%E6%A8%A1%E6%9D%BF%E6%B8%B2%E6%9F%93" target="_blank" rel="noopener noreferrer">#</a>1.3 页面模板渲染</span></a></h3><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211205120105277.822cd0df.png" alt="image-20211205120105277"></p><p>购物车这块也使用的是模板渲染，用户先请求经过微服务网关，微服务网关转发到订单购物车模板渲染服务，模板渲染服务条用用户微服务和订单购物车微服务查询用户收件地址和购物车清单，然后到页面显示。</p><h4 id="_1-3-1-准备工作" tabindex="-1"><a class="header-anchor" href="#_1-3-1-准备工作"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-3-1-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C" target="_blank" rel="noopener noreferrer">#</a>1.3.1 准备工作</span></a></h4><p>(1)静态资源导入</p><p>将资料中的<code>order.html</code>拷贝到<code>ydles-web-order</code>工程的templates中。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211206091251118.74887e4a.png" alt="image-20211206091251118"></p><p>(2)页面跳转实现</p><p>在ydles-web-order中创建<code>com.ydles.order.controller.OrderController</code>实现页面跳转，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Controller</span></span>
<span class="line"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/worder&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderController</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/ready/order&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">readyOrder</span><span class="token punctuation">(</span><span class="token class-name">Model</span> model<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">&quot;order&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8</p><p>(3)网关配置</p><p>修改ydles-gateway-web的application.yml文件，将订单的路由过滤地址添加上去，代码如下：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211206091646934.6c1ed852.png" alt="image-20211206091646934"></p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line">		<span class="token comment">#购物车订单渲染微服务</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> ydles_order_web_route</span>
<span class="line">          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//order<span class="token punctuation">-</span>web</span>
<span class="line">          <span class="token key atrule">predicates</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> Path=/api/wcart/<span class="token important">**</span><span class="token punctuation">,</span>/api/worder/<span class="token important">**</span></span>
<span class="line">          <span class="token key atrule">filters</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> StripPrefix=1</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><p>同时不要忘了把该地址添加到登录过滤地址中，修改<code>com.ydles.filter.URLFilter</code>，在orderFilterPath里添加<code>/api/worder/**</code>过滤，代码如下：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211206091746759.f00abe96.png" alt="image-20211206091746759"></p><h4 id="_1-3-2-信息查询-重点" tabindex="-1"><a class="header-anchor" href="#_1-3-2-信息查询-重点"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-3-2-%E4%BF%A1%E6%81%AF%E6%9F%A5%E8%AF%A2-%E9%87%8D%E7%82%B9" target="_blank" rel="noopener noreferrer">#</a>1.3.2 信息查询-重点</span></a></h4><p>需求：</p><p>因为一会儿要调用ydles-service-user查询用户的收件地址信息，调用ydles-service-order查询购物车清单信息，所以我们需要创建Feign。购物车的Feign之前已经创建过了，所以只需要创建用户地址相关的即可。</p><p>(1)用户地址信息查询</p><p>在ydles-service-user-api中创建AddressFeign，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AddressFeign</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/***</span>
<span class="line">     * 查询用户的收件地址信息</span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/list&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Address</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10</p><p>(2) ydles_web_order项目启动类OrderWebApplication加入调用的feign包</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ydles_service_user_api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@SpringBootApplication</span></span>
<span class="line"><span class="token annotation punctuation">@EnableEurekaClient</span></span>
<span class="line"><span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;com.ydles.order.feign&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;com.ydles.user.feign&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderWebApplication</span> <span class="token punctuation">{</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p>(3)查询购物车和用户收件地址信息</p><p>修改ydles-web-order中的<code>com.ydles.order.controller.OrderController</code>的readyOrder方法，在该方法中，使用feign调用查询收件地址信息和用户购物车信息，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Controller</span></span>
<span class="line"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/worder&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderController</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">AddressFeign</span> addressFeign<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">CartFeign</span> cartFeign<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/ready/order&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">readyOrder</span><span class="token punctuation">(</span><span class="token class-name">Model</span> model<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		 <span class="token comment">//1收件人的地址信息</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Address</span><span class="token punctuation">&gt;</span></span> addressList <span class="token operator">=</span> addressFeign<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;address&quot;</span><span class="token punctuation">,</span>addressList<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//2购物车信息</span></span>
<span class="line">        <span class="token class-name">Map</span> map <span class="token operator">=</span> cartFeign<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItem</span><span class="token punctuation">&gt;</span></span> orderItemList <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItem</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;orderItemList&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Integer</span> totalMoney <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;totalMoney&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Integer</span> totalNum <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;totalNum&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;carts&quot;</span><span class="token punctuation">,</span>orderItemList<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;totalMoney&quot;</span><span class="token punctuation">,</span>totalMoney<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;totalNum&quot;</span><span class="token punctuation">,</span>totalNum<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">&quot;order&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28</p><p>(3)数据回显-了解</p><p>修改order.html，与静态原型中的order.html打开对比。</p><div class="language-html line-numbers-mode" data-highlighter="prismjs" data-ext="html" data-title="html"><pre><code><span class="line">2 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>th</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.thymeleaf.org<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><div class="language-html line-numbers-mode" data-highlighter="prismjs" data-ext="html" data-title="html"><pre><code><span class="line">82 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>cart py-container<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><div class="language-html line-numbers-mode" data-highlighter="prismjs" data-ext="html" data-title="html"><pre><code><span class="line">97</span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>choose-address<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>addr:${address}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">									<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>con name <span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>|chooseAddr(&#39;${addr.contact}&#39;,&#39;${addr.phone}&#39;,&#39;${addr.address}&#39;)|<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>classappend</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${addr.isDefault}==1?&#39;selected&#39;:&#39;&#39;<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>javascript:;<span class="token punctuation">&quot;</span></span> <span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>em</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${addr.contact}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>em</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>点击取消选择<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">									<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>con address<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">										<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>place<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>em</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${addr.address}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>em</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">										<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>phone<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>em</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${addr.phone}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>em</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">										<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>base<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${addr.isDefault}==1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>默认地址<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">									<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">									<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>clearfix<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">								<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10</p><div class="language-html line-numbers-mode" data-highlighter="prismjs" data-ext="html" data-title="html"><pre><code><span class="line">118</span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>payType<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">							<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>selected<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>|order.payType=1|<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>在线支付<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>点击取消选择<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">							<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name"><span class="token namespace">th:</span>@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>|order.payType=0|<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>货到付款<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>点击取消选择<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">						<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><div class="language-html line-numbers-mode" data-highlighter="prismjs" data-ext="html" data-title="html"><pre><code><span class="line">141</span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>yui3-g<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>cart,cartsList:${carts}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">										<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>yui3-u-1-9<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">											<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name"><span class="token namespace">th:</span>src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${cart.image}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">										<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">										<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>yui3-u-5-12<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">											<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>desc<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${cart.name}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">											<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>seven<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>7天无理由退货<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">										<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">										<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>yui3-u-1-12<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">											<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>price<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${cart.price}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">										<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">										<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>yui3-u-1-12<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">											<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>num<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${cart.num}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">										<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">										<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>yui3-u-1-12<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">											<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>num<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${cart.num}*${cart.price}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">										<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">										<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>yui3-u-1-12<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">											<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>exit<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>有货<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">										<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">									<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22</p><div class="language-html line-numbers-mode" data-highlighter="prismjs" data-ext="html" data-title="html"><pre><code><span class="line">193</span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fc-receiverInfo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">			寄送至:</span>
<span class="line">			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>receive-address<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{order.receiveAddress}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">			收货人：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>receive-name<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{order.receiveContact}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>receive-phone<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{order.receiveMobile}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><div class="language-html line-numbers-mode" data-highlighter="prismjs" data-ext="html" data-title="html"><pre><code><span class="line">201</span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>list<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>number<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>em</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${totalNum}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>em</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span>件商品，商品总金额<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>em</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>allprice<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>¥<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>em</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${totalMoney}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>em</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>em</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><div class="language-html line-numbers-mode" data-highlighter="prismjs" data-ext="html" data-title="html"><pre><code><span class="line">211</span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>clearfix trade<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fc-price<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>应付金额:　<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>final-price<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>¥<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>em</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${totalMoney}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>em</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><div class="language-html line-numbers-mode" data-highlighter="prismjs" data-ext="html" data-title="html"><pre><code><span class="line">318</span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name"><span class="token namespace">th:</span>inline</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>javascript<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript"></span>
<span class="line">		<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">			<span class="token literal-property property">el</span><span class="token operator">:</span><span class="token string">&quot;#app&quot;</span><span class="token punctuation">,</span></span>
<span class="line">			<span class="token literal-property property">data</span><span class="token operator">:</span><span class="token punctuation">{</span></span>
<span class="line">				<span class="token literal-property property">order</span><span class="token operator">:</span><span class="token punctuation">{</span></span>
<span class="line">					<span class="token string-property property">&#39;receiveContact&#39;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>$<span class="token punctuation">{</span>deAddr<span class="token punctuation">.</span>contact<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">					<span class="token string-property property">&#39;receiveMobile&#39;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>$<span class="token punctuation">{</span>deAddr<span class="token punctuation">.</span>phone<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">					<span class="token string-property property">&#39;receiveAddress&#39;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>$<span class="token punctuation">{</span>deAddr<span class="token punctuation">.</span>address<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">					<span class="token string-property property">&#39;payType&#39;</span><span class="token operator">:</span><span class="token number">1</span></span>
<span class="line">				<span class="token punctuation">}</span></span>
<span class="line">			<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">			<span class="token literal-property property">methods</span><span class="token operator">:</span><span class="token punctuation">{</span></span>
<span class="line">				<span class="token function-variable function">chooseAddr</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">contact<span class="token punctuation">,</span>mobile<span class="token punctuation">,</span>address</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">					app<span class="token punctuation">.</span><span class="token function">$set</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>order<span class="token punctuation">,</span><span class="token string">&#39;receiveContact&#39;</span><span class="token punctuation">,</span>contact<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">					app<span class="token punctuation">.</span><span class="token function">$set</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>order<span class="token punctuation">,</span><span class="token string">&#39;receiveMobile&#39;</span><span class="token punctuation">,</span>mobile<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">					app<span class="token punctuation">.</span><span class="token function">$set</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>order<span class="token punctuation">,</span><span class="token string">&#39;receiveAddress&#39;</span><span class="token punctuation">,</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">				<span class="token punctuation">}</span></span>
<span class="line">			<span class="token punctuation">}</span></span>
<span class="line">		<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">	</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21</p><p>测试：先登录，再访问</p><p>http://localhost:8001/api/worder/ready/order</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211206114046064.3cc7aec8.png" alt="image-20211206114046064"></p><h4 id="_1-3-3-记录选中收件人-了解" tabindex="-1"><a class="header-anchor" href="#_1-3-3-记录选中收件人-了解"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-3-3-%E8%AE%B0%E5%BD%95%E9%80%89%E4%B8%AD%E6%94%B6%E4%BB%B6%E4%BA%BA-%E4%BA%86%E8%A7%A3" target="_blank" rel="noopener noreferrer">#</a>1.3.3 记录选中收件人-了解</span></a></h4><p><strong>收件人动态展示</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">73 &lt;div class=&quot;cart py-container&quot; id=&quot;app&quot;&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><div class="language-html line-numbers-mode" data-highlighter="prismjs" data-ext="html" data-title="html"><pre><code><span class="line">371-395</span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name"><span class="token namespace">th:</span>inline</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>javascript<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript"></span>
<span class="line">	<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">		<span class="token literal-property property">el</span><span class="token operator">:</span><span class="token string">&quot;#app&quot;</span><span class="token punctuation">,</span></span>
<span class="line">		<span class="token literal-property property">data</span><span class="token operator">:</span><span class="token punctuation">{</span></span>
<span class="line">			<span class="token literal-property property">order</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string-property property">&#39;receiveContact&#39;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">[</span>$<span class="token punctuation">{</span>deAddr<span class="token punctuation">.</span>contact<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string-property property">&#39;receiveMobile&#39;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">[</span>$<span class="token punctuation">{</span>deAddr<span class="token punctuation">.</span>phone<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string-property property">&#39;receiveAddress&#39;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">[</span>$<span class="token punctuation">{</span>deAddr<span class="token punctuation">.</span>address<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string-property property">&#39;payType&#39;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span></span>
<span class="line">		<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">		<span class="token literal-property property">methods</span><span class="token operator">:</span><span class="token punctuation">{</span></span>
<span class="line">			<span class="token function-variable function">chooseAddr</span><span class="token operator">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">contact<span class="token punctuation">,</span>mobile<span class="token punctuation">,</span>address</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">				app<span class="token punctuation">.</span><span class="token function">$set</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>order<span class="token punctuation">,</span><span class="token string">&#39;receiveContact&#39;</span><span class="token punctuation">,</span>contact<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">				app<span class="token punctuation">.</span><span class="token function">$set</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>order<span class="token punctuation">,</span><span class="token string">&#39;receiveMobile&#39;</span><span class="token punctuation">,</span>mobile<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">				app<span class="token punctuation">.</span><span class="token function">$set</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>order<span class="token punctuation">,</span><span class="token string">&#39;receiveAddress&#39;</span><span class="token punctuation">,</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">			<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">			<span class="token function-variable function">add</span><span class="token operator">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">				axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/api/worder/add&#39;</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>order<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">					<span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>flag<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">						<span class="token comment">//添加订单成功</span></span>
<span class="line">						<span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;添加订单成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">					<span class="token punctuation">}</span> <span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">						<span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;添加订单失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">					<span class="token punctuation">}</span></span>
<span class="line">				<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">			<span class="token punctuation">}</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">	<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26</p><div class="language-html line-numbers-mode" data-highlighter="prismjs" data-ext="html" data-title="html"><pre><code><span class="line">199-207</span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>clearfix trade<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fc-price<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>应付金额:　<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>price<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>¥<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>em</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${totalMoney}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>em</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fc-receiverInfo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">				寄送至:</span>
<span class="line">				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>receive-address<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{order.receiveAddress}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">				收货人：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>receive-name<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{order.receiveContact}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>receive-phone<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{order.receiveMobile}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10</p><p><strong>后端设置默认收件人</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">        <span class="token comment">//默认收件人信息</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Address</span> address <span class="token operator">:</span> addressList<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>address<span class="token punctuation">.</span><span class="token function">getIsDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">//默认收件人</span></span>
<span class="line">                model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;deAddr&quot;</span><span class="token punctuation">,</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8</p><p>前端：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">375</span>
<span class="line">order:{&#39;receiveContact&#39;:[[${deAddr.contact}]],&#39;receiveMobile&#39;:[[${deAddr.phone}]],&#39;receiveAddress&#39;:[[${deAddr.address}]],&#39;payType&#39;:1}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><p><strong>支付方式</strong></p><div class="language-html line-numbers-mode" data-highlighter="prismjs" data-ext="html" data-title="html"><pre><code><span class="line">109-114</span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>step-cont<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">						<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>payType<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">							<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>selected<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>|order.payType=1|<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>在线支付<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>点击取消选择<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">							<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name"><span class="token namespace">th:</span>@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>|order.payType=0|<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>货到付款<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>点击取消选择<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">						<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><p><strong>购物车跳转结算页面</strong></p><p>cart.html</p><div class="language-html line-numbers-mode" data-highlighter="prismjs" data-ext="html" data-title="html"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sum-btn<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/api/worder/ready/order<span class="token punctuation">&quot;</span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>_blank<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>结算<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><h2 id="_2-下单-重点" tabindex="-1"><a class="header-anchor" href="#_2-下单-重点"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-%E4%B8%8B%E5%8D%95-%E9%87%8D%E7%82%B9" target="_blank" rel="noopener noreferrer">#</a>2 下单-重点</span></a></h2><h3 id="_2-1-业务分析" tabindex="-1"><a class="header-anchor" href="#_2-1-业务分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-1-%E4%B8%9A%E5%8A%A1%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>2.1 业务分析</span></a></h3><p>点击提交订单的时候，会立即创建订单数据，创建订单数据会将数据存入到2张表中，分别是订单表和订单明细表，此处还需要修改商品对应的库存数量。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211206121803107.736bdb4d.png" alt="image-20211206121803107"></p><p>订单表结构如下：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>tb_order<span class="token punctuation">`</span></span> <span class="token punctuation">(</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8_bin <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;订单id&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>total_num<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;数量合计&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>total_money<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;金额合计&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>pre_money<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;优惠金额&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>post_fee<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;邮费&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>pay_money<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;实付金额&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>pay_type<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8_bin <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;支付类型，1、在线支付、0 货到付款&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;订单创建时间&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>update_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;订单更新时间&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>pay_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;付款时间&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>consign_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;发货时间&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>end_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;交易完成时间&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>close_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;交易关闭时间&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>shipping_name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8_bin <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;物流名称&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>shipping_code<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8_bin <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;物流单号&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8_bin <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;用户名称&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>buyer_message<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8_bin <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;买家留言&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>buyer_rate<span class="token punctuation">`</span></span> <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8_bin <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;是否评价&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>receiver_contact<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8_bin <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;收货人&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>receiver_mobile<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8_bin <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;收货人手机&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>receiver_address<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8_bin <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;收货人地址&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>source_type<span class="token punctuation">`</span></span> <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8_bin <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;订单来源：1:web，2：app，3：微信公众号，4：微信小程序  5 H5手机页面&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>transaction_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8_bin <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;交易流水号&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>order_status<span class="token punctuation">`</span></span> <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8_bin <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;订单状态,0:未完成,1:已完成，2：已退货&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>pay_status<span class="token punctuation">`</span></span> <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8_bin <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;支付状态,0:未支付，1：已支付，2：支付失败&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>consign_status<span class="token punctuation">`</span></span> <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8_bin <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;发货状态,0:未发货，1：已发货，2：已收货&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>is_delete<span class="token punctuation">`</span></span> <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8_bin <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;是否删除&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>status<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>order_status<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>payment_type<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>pay_type<span class="token punctuation">`</span></span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33</p><p>订单明细表结构如下：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>tb_order_item<span class="token punctuation">`</span></span> <span class="token punctuation">(</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8_bin <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;ID&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>category_id1<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;1级分类&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>category_id2<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;2级分类&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>category_id3<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;3级分类&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>spu_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8_bin <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;SPU_ID&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;SKU_ID&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>order_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;订单ID&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8_bin <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;商品名称&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>price<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;单价&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>num<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;数量&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>money<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;总金额&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>pay_money<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;实付金额&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>image<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8_bin <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;图片地址&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>weight<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;重量&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>post_fee<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;运费&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>is_return<span class="token punctuation">`</span></span> <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> utf8_bin <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;是否退货,0:未退货，1：已退货&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>item_id<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>order_id<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>order_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21</p><h3 id="_2-2-下单实现" tabindex="-1"><a class="header-anchor" href="#_2-2-下单实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-2-%E4%B8%8B%E5%8D%95%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>2.2 下单实现</span></a></h3><p>下单的时候，先往tb_order表中增加数据，再往tb_order_item表中增加数据。</p><h4 id="_2-2-1-代码实现" tabindex="-1"><a class="header-anchor" href="#_2-2-1-代码实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-2-1-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>2.2.1 代码实现</span></a></h4><p>这里先修改ydles-service-order微服务，实现下单操作，这里会生成订单号，我们首先需要在启动类中创建一个IdWorker对象。</p><p>在<code>com.ydles.OrderApplication</code>中创建IdWorker，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token annotation punctuation">@Bean</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">IdWorker</span> <span class="token function">idWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">IdWorker</span><span class="token punctuation">(</span>workerId<span class="token punctuation">,</span> datacenterId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p>(1)业务层</p><p>实现逻辑：</p><p>1）获取所有购物车</p><p>2）统计计算：总金额，总支付金额，总数量</p><p>3）填充订单数据并保存</p><p>4）获取每一个购物项保存到orderItem</p><p>5）删除购物车中数据</p><p>修改订单微服务添加com.ydles.order.service.impl.OrderServiceImpl,代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line">     * 下单</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">order</span></span>
<span class="line">     * 缺啥补啥</span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//1 获取 购物车信息</span></span>
<span class="line">        <span class="token class-name">Map</span> cartMap <span class="token operator">=</span> cartService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//map.put(&quot;orderItemList&quot;,orderItemList);</span></span>
<span class="line">        <span class="token class-name">Integer</span> totalNum <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span> cartMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;totalNum&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Integer</span> totalMoney <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span> cartMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;totalMoney&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//2 order表里存数据</span></span>
<span class="line">        <span class="token class-name">String</span> orderId <span class="token operator">=</span> idWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;&quot;</span><span class="token punctuation">;</span></span>
<span class="line">        order<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        order<span class="token punctuation">.</span><span class="token function">setTotalNum</span><span class="token punctuation">(</span>totalNum<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        order<span class="token punctuation">.</span><span class="token function">setTotalMoney</span><span class="token punctuation">(</span>totalMoney<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//作业：优惠金额 怎么算      本店满50-5 跨店 300-50</span></span>
<span class="line">        <span class="token comment">//作业：邮费金额 怎么算</span></span>
<span class="line">        order<span class="token punctuation">.</span><span class="token function">setPayMoney</span><span class="token punctuation">(</span>totalMoney<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        order<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        order<span class="token punctuation">.</span><span class="token function">setUpdateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//作业：买家留言</span></span>
<span class="line">        order<span class="token punctuation">.</span><span class="token function">setBuyerRate</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        order<span class="token punctuation">.</span><span class="token function">setSourceType</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        order<span class="token punctuation">.</span><span class="token function">setOrderStatus</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        order<span class="token punctuation">.</span><span class="token function">setPayStatus</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        order<span class="token punctuation">.</span><span class="token function">setConsignStatus</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        order<span class="token punctuation">.</span><span class="token function">setIsDelete</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        orderMapper<span class="token punctuation">.</span><span class="token function">insertSelective</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//3 orderItem表里存数据</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItem</span><span class="token punctuation">&gt;</span></span> orderItemList <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItem</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> cartMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;orderItemList&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">OrderItem</span> orderItem <span class="token operator">:</span> orderItemList<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            orderItem<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            orderItem<span class="token punctuation">.</span><span class="token function">setPostFee</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            orderItem<span class="token punctuation">.</span><span class="token function">setIsReturn</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            orderItemMapper<span class="token punctuation">.</span><span class="token function">insertSelective</span><span class="token punctuation">(</span>orderItem<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//4 删除购物车信息</span></span>
<span class="line">        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token constant">CART</span><span class="token operator">+</span>order<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47</p><p>(2)控制层</p><p>修改ydles-service-order微服务，修改com.ydles.order.controller.OrderController类，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">TokenDecode</span> tokenDecode<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/***</span>
<span class="line">     * 下单</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">order</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@PostMapping</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Order</span> order<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">String</span> username <span class="token operator">=</span> tokenDecode<span class="token punctuation">.</span><span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        order<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        orderService<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span><span class="token string">&quot;添加成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16</p><h4 id="_2-2-2-渲染服务对接" tabindex="-1"><a class="header-anchor" href="#_2-2-2-渲染服务对接"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-2-2-%E6%B8%B2%E6%9F%93%E6%9C%8D%E5%8A%A1%E5%AF%B9%E6%8E%A5" target="_blank" rel="noopener noreferrer">#</a>2.2.2 渲染服务对接</span></a></h4><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211206142024505.5d1cc433.png" alt="image-20211206142024505"></p><p>我们需要在模板渲染端调用订单微服务实现下单操作,下单操作需要调用订单微服务，所以需要创建对应的Feign。</p><p>(1)Feign创建</p><p>修改ydles-service-order-api，添加OrderFeign，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderFeign</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/order&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Order</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6</p><p>(2)下单调用</p><p>修改ydles-web-order的<code>com.ydles.order.controller.OrderController</code>添加下单方法，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">OrderFeign</span> orderFeign<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/add&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token annotation punctuation">@ResponseBody</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Order</span> order<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Result</span> result <span class="token operator">=</span> orderFeign<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> result<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9</p><p>(3)页面调用</p><p>order.html</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token number">383</span><span class="token operator">-</span><span class="token number">392</span></span>
<span class="line"><span class="token function-variable function">add</span><span class="token operator">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">				axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/api/worder/add&#39;</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>order<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">					<span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>flag<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">						<span class="token comment">//添加订单成功</span></span>
<span class="line">						<span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;添加订单成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">					<span class="token punctuation">}</span> <span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">						<span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;添加订单失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">					<span class="token punctuation">}</span></span>
<span class="line">				<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">			<span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11</p><div class="language-html line-numbers-mode" data-highlighter="prismjs" data-ext="html" data-title="html"><pre><code><span class="line">209</span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sui-btn btn-danger btn-xlarge<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>javascript:void(0)<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>add()<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>提交订单<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><p>点击提交订单调用</p><p>保存订单测试，表数据变化如下：</p><p>tb_order表数据：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211206143109177.1a498af3.png" alt="image-20211206143109177"></p><p>tb_order_item表数据：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211206143122426.df5ec577.png" alt="image-20211206143122426"></p><h3 id="_2-3-库存变更" tabindex="-1"><a class="header-anchor" href="#_2-3-库存变更"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-3-%E5%BA%93%E5%AD%98%E5%8F%98%E6%9B%B4" target="_blank" rel="noopener noreferrer">#</a>2.3 库存变更</span></a></h3><h4 id="_2-3-1-业务分析" tabindex="-1"><a class="header-anchor" href="#_2-3-1-业务分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-3-1-%E4%B8%9A%E5%8A%A1%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>2.3.1 业务分析</span></a></h4><p>上面操作只实现了下单操作，但对应的库存还没跟着一起减少，我们在下单之后，应该调用商品微服务，将下单的商品库存减少，销量增加。每次订单微服务只需要将用户名传到商品微服务，商品微服务通过用户名到Redis中查询对应的购物车数据，然后执行库存减少，库存减少需要控制当前商品库存&gt;=销售数量。</p><p>如何控制库存数量&gt;=购买数量呢？其实可以通过SQL语句实现，每次减少数量之前，加个条件判断。</p><p><code>where num&gt;=#{num}</code>即可。</p><p>商品服务需要查询购物车数据，所以需要引入订单的api，在pom.xml中添加如下依赖：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">&lt;!--order api 依赖--&gt;</span>
<span class="line">&lt;dependency&gt;</span>
<span class="line">    &lt;groupId&gt;com.ydles&lt;/groupId&gt;</span>
<span class="line">    &lt;artifactId&gt;ydles_service_order_api&lt;/artifactId&gt;</span>
<span class="line">    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span>
<span class="line">&lt;/dependency&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6</p><h4 id="_2-3-2-代码实现" tabindex="-1"><a class="header-anchor" href="#_2-3-2-代码实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-3-2-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>2.3.2 代码实现</span></a></h4><p>要调用其他微服务，需要将头文件中的令牌数据携带到其他微服务中取，所以我们不能使用hystrix的多线程模式，修改ydles-service-order的applicatin.yml配置，代码如下：</p><div class="language-properties line-numbers-mode" data-highlighter="prismjs" data-ext="properties" data-title="properties"><pre><code><span class="line"><span class="token comment">#hystrix 配置</span></span>
<span class="line"><span class="token key attr-name">hystrix</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token key attr-name">  command</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token key attr-name">    default</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token key attr-name">      execution</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token key attr-name">        isolation</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token key attr-name">          thread</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token key attr-name">            timeoutInMilliseconds</span><span class="token punctuation">:</span> <span class="token value attr-value">10000</span></span>
<span class="line"><span class="token key attr-name">          strategy</span><span class="token punctuation">:</span> <span class="token value attr-value">SEMAPHORE</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9</p><p>每次还需要使用拦截器添加头文件信息，添加拦截器，代码如下：</p><p>(1)Dao层</p><p>修改ydles-service-goods微服务的<code>com.ydles.goods.dao.SkuMapper</code>接口，增加库存递减方法,代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 递减库存</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">orderItem</span></span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@Update</span><span class="token punctuation">(</span><span class="token string">&quot;UPDATE tb_sku SET num=num-#{num},sale_num=sale_num+#{num} WHERE id=#{skuId} AND num&gt;=#{num}&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">decrCount</span><span class="token punctuation">(</span><span class="token class-name">OrderItem</span> orderItem<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><p>(2)业务层</p><p>修改ydles-service-goods微服务的<code>com.ydles.goods.service.SkuService</code>接口，添加如下方法：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/***</span>
<span class="line"> * 库存递减</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">username</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">decrCount</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p>修改ydles-service-goods微服务的<code>com.ydles.goods.service.impl.SkuServiceImpl</code>实现类，添加一个实现方法，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Autowired</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token doc-comment comment">/***</span>
<span class="line"> * 库存递减</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">username</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">decrCount</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//获取购物车数据</span></span>
<span class="line">    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItem</span><span class="token punctuation">&gt;</span></span> orderItems <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token string">&quot;Cart_&quot;</span> <span class="token operator">+</span> username<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//循环递减</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">OrderItem</span> orderItem <span class="token operator">:</span> orderItems<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//递减库存</span></span>
<span class="line">        <span class="token keyword">int</span> count <span class="token operator">=</span> skuMapper<span class="token punctuation">.</span><span class="token function">decrCount</span><span class="token punctuation">(</span>orderItem<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span>count<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;库存不足，递减失败！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21</p><p>(3)控制层</p><p>修改ydles-service-goods的<code>com.ydles.goods.controller.SkuController</code>类，添加库存递减方法，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/***</span>
<span class="line"> * 库存递减</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">username</span></span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/decr/count&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">decrCount</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> username<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//库存递减</span></span>
<span class="line">    skuService<span class="token punctuation">.</span><span class="token function">decrCount</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span><span class="token string">&quot;库存递减成功！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11</p><p>(4)创建feign</p><p>同时在ydles-service-goods-api工程添加<code>com.ydles.goods.feign.SkuFeign</code>的实现，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/***</span>
<span class="line"> * 库存递减</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">username</span></span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/decr/count&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token class-name">Result</span> <span class="token function">decrCount</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><h4 id="_2-3-3-调用库存递减" tabindex="-1"><a class="header-anchor" href="#_2-3-3-调用库存递减"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-3-3-%E8%B0%83%E7%94%A8%E5%BA%93%E5%AD%98%E9%80%92%E5%87%8F" target="_blank" rel="noopener noreferrer">#</a>2.3.3 调用库存递减</span></a></h4><p>需求：</p><p>ydles_service_order服务调用 ydles_service_goods服务, ydles_web_order服务的Application启动类</p><p>都需要添加下面拦截器</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Bean</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">FeignInterceptor</span> <span class="token function">feignInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FeignInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p>ydles_service_goods加入配置信息</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">spring</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">application</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> goods</span>
<span class="line">  <span class="token key atrule">redis</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.200.128</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p><strong>调用库存递减</strong></p><p>修改ydles-service-order微服务的com.ydles.order.service.impl.OrderServiceImpl类的add方法，增加库存递减的调用。</p><p>先注入SkuFeign</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Autowired</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token class-name">SkuFeign</span> skuFeign<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><p>再调用库存递减方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">//库存减库存</span></span>
<span class="line">skuFeign<span class="token punctuation">.</span><span class="token function">decrCount</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><p>完整代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 增加</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">order</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//查询出用户的所有购物车</span></span>
<span class="line">    <span class="token class-name">Map</span> orderItemMap <span class="token operator">=</span> cartService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//统计计算</span></span>
<span class="line">    <span class="token class-name">Integer</span> totalMoney <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>orderItemMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;totalPrice&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">Integer</span> num <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>orderItemMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;totalNum&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//购买商品数量</span></span>
<span class="line">    order<span class="token punctuation">.</span><span class="token function">setTotalNum</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//购买金额</span></span>
<span class="line">    order<span class="token punctuation">.</span><span class="token function">setTotalMoney</span><span class="token punctuation">(</span>totalMoney<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//支付金额</span></span>
<span class="line">    order<span class="token punctuation">.</span><span class="token function">setPayMoney</span><span class="token punctuation">(</span>totalMoney<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//优惠金额</span></span>
<span class="line">    order<span class="token punctuation">.</span><span class="token function">setPreMoney</span><span class="token punctuation">(</span>totalMoney<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//其他数据完善</span></span>
<span class="line">    order<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    order<span class="token punctuation">.</span><span class="token function">setUpdateTime</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getCreateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    order<span class="token punctuation">.</span><span class="token function">setBuyerRate</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//0:未评价，1：已评价</span></span>
<span class="line">    order<span class="token punctuation">.</span><span class="token function">setSourceType</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//来源，1：WEB</span></span>
<span class="line">    order<span class="token punctuation">.</span><span class="token function">setOrderStatus</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//0:未完成,1:已完成，2：已退货</span></span>
<span class="line">    order<span class="token punctuation">.</span><span class="token function">setPayStatus</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//0:未支付，1：已支付，2：支付失败</span></span>
<span class="line">    order<span class="token punctuation">.</span><span class="token function">setConsignStatus</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//0:未发货，1：已发货，2：已收货</span></span>
<span class="line">    order<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>idWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">int</span> count <span class="token operator">=</span> orderMapper<span class="token punctuation">.</span><span class="token function">insertSelective</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//保存待支付订单到redis中</span></span>
<span class="line">    redisTemplate<span class="token punctuation">.</span><span class="token function">boundValueOps</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">ORDER_PAY</span> <span class="token operator">+</span> order<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">//添加订单明细</span></span>
<span class="line">    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItem</span><span class="token punctuation">&gt;</span></span> orderItemList <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItem</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>orderItemMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;orderItemList&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">OrderItem</span> orderItem <span class="token operator">:</span> orderItemList<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        orderItem<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>idWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        orderItem<span class="token punctuation">.</span><span class="token function">setIsReturn</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        orderItem<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        orderItemMapper<span class="token punctuation">.</span><span class="token function">insertSelective</span><span class="token punctuation">(</span>orderItem<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//扣减库存</span></span>
<span class="line">    skuFeign<span class="token punctuation">.</span><span class="token function">decrCount</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//清除Redis缓存购物车数据</span></span>
<span class="line">    redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;Cart_&quot;</span><span class="token operator">+</span>order<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53</p><h4 id="测试" tabindex="-1"><a class="header-anchor" href="#测试"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#%E6%B5%8B%E8%AF%95" target="_blank" rel="noopener noreferrer">#</a>测试</span></a></h4><p>1购物车添加商品</p><p>http://localhost:8001/api/wcart/add?skuId=1450862568724758528&amp;num=5</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211206152606093.8f79cdb1.png" alt="image-20211206152606093"></p><p>2查看购物车</p><p>http://localhost:8001/api/wcart/list</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211206152627024.ef696722.png" alt="image-20211206152627024"></p><p>3点击结算</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211206152646505.8b258555.png" alt="image-20211206152646505"></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211206152654362.19689c7c.png" alt="image-20211206152654362"></p><p>4点击提交订单</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211206152743660.153c1b1c.png" alt="image-20211206152743660"></p><p>tb_order 有数据</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211206152848108.da521fd6.png" alt="image-20211206152848108"></p><p>tb_order_item也有数据</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211206152906228.365a41ac.png" alt="image-20211206152906228"></p><p>tb_sku表查看库存和销量是否更改</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211206152831101.841c5709.png" alt="image-20211206152831101"></p><p>库存减少前，查询数据库Sku数据如下：95库存，5销量 库存94，销量6</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211206152957078.0326cc88.png" alt="image-20211206152957078"></p><h3 id="_2-4-增加积分-学员练习" tabindex="-1"><a class="header-anchor" href="#_2-4-增加积分-学员练习"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-4-%E5%A2%9E%E5%8A%A0%E7%A7%AF%E5%88%86-%E5%AD%A6%E5%91%98%E7%BB%83%E4%B9%A0" target="_blank" rel="noopener noreferrer">#</a>2.4 增加积分(学员练习)</span></a></h3><p>tb_user表</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">`points` int(11) DEFAULT NULL COMMENT &#39;积分&#39;,</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>需求：</p><p>在增加订单的时候，同时添加用户积分。与减库存道理相同。</p><p>(1)dao层</p><p>修改ydles-service-user微服务的<code>com.ydles.user.dao.UserMapper</code>接口，增加用户积分方法，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/***</span>
<span class="line"> * 增加用户积分</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">username</span></span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">pint</span></span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@Update</span><span class="token punctuation">(</span><span class="token string">&quot;UPDATE tb_user SET points=points+#{point} WHERE  username=#{username}&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">addUserPoints</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;point&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> pint<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8</p><p>(2)业务层</p><p>修改ydles-service-user微服务的<code>com.ydles.user.service.UserService</code>接口，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/***</span>
<span class="line"> * 添加用户积分</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">username</span></span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">pint</span></span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">addUserPoints</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span><span class="token class-name">Integer</span> pint<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><p>修改ydles-service-user微服务的<code>com.ydles.user.service.impl.UserServiceImpl</code>，增加添加积分方法实现，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/***</span>
<span class="line"> * 修改用户积分</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">username</span></span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">pint</span></span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">addUserPoints</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">Integer</span> pint<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> userMapper<span class="token punctuation">.</span><span class="token function">addUserPoints</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>pint<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10</p><p>(3)控制层</p><p>修改ydles-service-user微服务的<code>com.ydles.user.controller.UserController</code>，添加增加用户积分方法，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Autowired</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token class-name">TokenDecode</span> tokenDecode<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token doc-comment comment">/***</span>
<span class="line"> * 增加用户积分</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">points</span>:要添加的积分</span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/points/add&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">addPoints</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> points<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//获取用户名</span></span>
<span class="line">    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> userMap <span class="token operator">=</span> tokenDecode<span class="token punctuation">.</span><span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">String</span> username <span class="token operator">=</span> userMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//添加积分</span></span>
<span class="line">    userService<span class="token punctuation">.</span><span class="token function">addUserPoints</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>points<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span><span class="token string">&quot;添加积分成功！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17</p><p>(4)Feign添加</p><p>修改ydles-service-user-api工程，修改<code>com.ydles.user.feign.UserFeign</code>，添加增加用户积分方法，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/***</span>
<span class="line"> * 添加用户积分</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">points</span></span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/points/add&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token class-name">Result</span> <span class="token function">addPoints</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;points&quot;</span><span class="token punctuation">)</span><span class="token class-name">Integer</span> points<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><h4 id="_4-4-2-增加积分调用" tabindex="-1"><a class="header-anchor" href="#_4-4-2-增加积分调用"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_4-4-2-%E5%A2%9E%E5%8A%A0%E7%A7%AF%E5%88%86%E8%B0%83%E7%94%A8" target="_blank" rel="noopener noreferrer">#</a>4.4.2 增加积分调用</span></a></h4><p>修改ydles-service-order，添加ydles-service-user-api的依赖，修改pom.xml,添加如下依赖：</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token comment">&lt;!--user api 依赖--&gt;</span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ydles-service-user-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6</p><p>在加订单的时候，同时添加用户积分，修改ydles-service-order微服务的<code>com.ydles.order.service.impl.OrderServiceImpl</code>下单方法，增加调用添加积分方法</p><p>修改ydles-service-order的启动类<code>com.ydles.OrderApplication</code>，添加feign的包路径</p><p>总结：</p><p>1订单结算页</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211206153405594.3f61cffa.png" alt="image-20211206153405594"></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211206153523449.50edd4d3.png" alt="image-20211206153523449"></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211206153555752.139fc0c1.png" alt="image-20211206153555752"></p><p>2下单</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211206153608375.d7e5f17c.png" alt="image-20211206153608375"></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211206153617157.5d8b78ff.png" alt="image-20211206153617157"></p><h2 id="第12章-分布式事务解决方案" tabindex="-1"><a class="header-anchor" href="#第12章-分布式事务解决方案"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#%E7%AC%AC12%E7%AB%A0-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" target="_blank" rel="noopener noreferrer">#</a>第12章 分布式事务解决方案</span></a></h2><p><strong>角色</strong>：架构师</p><h2 id="学习目标" tabindex="-1"><a class="header-anchor" href="#学习目标"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87" target="_blank" rel="noopener noreferrer">#</a>学习目标：</span></a></h2><ul><li>能够说出cap定理</li><li>能够说出BASE定理</li><li>能够说出常见的分布式事务解决方案</li><li>能够说出seata框架如何在项目中实现分布式事务</li></ul><h2 id="_1-分布式事务解决方案" tabindex="-1"><a class="header-anchor" href="#_1-分布式事务解决方案"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" target="_blank" rel="noopener noreferrer">#</a>1.分布式事务解决方案</span></a></h2><p>刚才我们编写的扣减库存与保存订单是在两个服务中存在的，如果扣减库存后订单保存失败了是不会回滚的，这样就会造成数据不一致的情况，这其实就是我们所说的分布式事务的问题，接下来我们来学习分布式事务的解决方案。</p><h3 id="_1-1-本地事务与分布式事务" tabindex="-1"><a class="header-anchor" href="#_1-1-本地事务与分布式事务"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-1-%E6%9C%AC%E5%9C%B0%E4%BA%8B%E5%8A%A1%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1" target="_blank" rel="noopener noreferrer">#</a>1.1 本地事务与分布式事务</span></a></h3><h4 id="_1-1-1-事务" tabindex="-1"><a class="header-anchor" href="#_1-1-1-事务"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-1-1-%E4%BA%8B%E5%8A%A1" target="_blank" rel="noopener noreferrer">#</a>1.1.1 事务</span></a></h4><p>数据库事务(简称：事务，Transaction)是指数据库执行过程中的一个逻辑单位，由一个有限的数据库操作序列构成。</p><p>事务拥有以下<strong>四个特性</strong>，习惯上被称为<strong>ACID</strong>特性：</p><p><strong>原子性(Atomicity)</strong>：事务作为一个整体被执行，包含在其中的对数据库的操作要么全部被执行，要么都不执行。</p><p><strong>一致性(Consistency)</strong>：事务应确保数据库的状态从一个一致状态转变为另一个一致状态。一致状态是指数据库中的数据应满足完整性约束。除此之外，一致性还有另外一层语义，就是事务的中间状态不能被观察到(这层语义也有说应该属于原子性)。</p><p><strong>隔离性(Isolation)</strong>：多个事务并发执行时，一个事务的执行不应影响其他事务的执行，如同只有这一个操作在被数据库所执行一样。</p><p><strong>持久性(Durability)</strong>：已被提交的事务对数据库的修改应该永久保存在数据库中。在事务结束时，此操作将不可逆转。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211208154640726.c51a8532.png" alt="image-20211208154640726"></p><p>作业：隔离级别 传播机制</p><h4 id="_1-1-2-本地事务" tabindex="-1"><a class="header-anchor" href="#_1-1-2-本地事务"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-1-2-%E6%9C%AC%E5%9C%B0%E4%BA%8B%E5%8A%A1" target="_blank" rel="noopener noreferrer">#</a>1.1.2 本地事务</span></a></h4><p>起初，事务仅限于对单一数据库资源的访问控制,架构服务化以后，事务的概念延伸到了服务中。倘若将一个单一的服务操作作为一个事务，那么整个服务操作只能涉及一个单一的数据库资源,这类基于单个服务单一数据库资源访问的事务，被称为本地事务(Local Transaction)。</p><p>解决方案：@Transactional</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211208155006738.89a7a19b.png" alt="image-20211208155006738"></p><h4 id="_1-1-3-分布式事务" tabindex="-1"><a class="header-anchor" href="#_1-1-3-分布式事务"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-1-3-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1" target="_blank" rel="noopener noreferrer">#</a>1.1.3 分布式事务</span></a></h4><p>分布式事务指事务的参与者、支持事务的服务器、资源服务器以及事务管理器分别位于不同的分布式系统的不同节点之上,且属于不同的应用，分布式事务需要保证这些操作要么全部成功，要么全部失败。本质上来说，分布式事务就是为了保证不同数据库的数据一致性。</p><p>最早的分布式事务应用架构很简单，不涉及服务间的访问调用，仅仅是服务内操作涉及到对多个数据库资源的访问。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211208155238640.903b1d47.png" alt="image-20211208155238640"></p><p>当一个服务操作访问不同的数据库资源，又希望对它们的访问具有事务特性时，就需要采用分布式事务来协调所有的事务参与者。</p><p>对于上面介绍的分布式事务应用架构，尽管一个服务操作会访问多个数据库资源，但是毕竟整个事务还是控制在单一服务的内部。如果一个服务操作需要调用另外一个服务，这时的事务就需要跨越多个服务了。在这种情况下，起始于某个服务的事务在调用另外一个服务的时候，需要以某种机制流转到另外一个服务，从而使被调用的服务访问的资源也自动加入到该事务当中来。下图反映了这样一个跨越多个服务的分布式事务：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211208155459473.ccf268f3.png" alt="image-20211208155459473"></p><p>如果将上面这两种场景(一个服务可以调用多个数据库资源，也可以调用其他服务)结合在一起，对此进行延伸，整个分布式事务的参与者将会组成如下图所示的树形拓扑结构。在一个跨服务的分布式事务中，事务的发起者和提交均系同一个，它可以是整个调用的客户端，也可以是客户端最先调用的那个服务。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211208155810435.3f408ab7.png" alt="image-20211208155810435"></p><p>较之基于单一数据库资源访问的本地事务，分布式事务的应用架构更为复杂。在不同的分布式应用架构下，实现一个分布式事务要考虑的问题并不完全一样，比如对多资源的协调、事务的跨服务传播等，实现机制也是复杂多变。</p><p><strong>只要是涉及到多个微服务之间远程调用的话，那就回涉及到分布式事务。</strong></p><p>分布式事务的作用：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">保证每个事务的数据一致性。</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><h3 id="_1-2-分布式事务相关理论" tabindex="-1"><a class="header-anchor" href="#_1-2-分布式事务相关理论"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-2-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%9B%B8%E5%85%B3%E7%90%86%E8%AE%BA" target="_blank" rel="noopener noreferrer">#</a>1.2 分布式事务相关理论</span></a></h3><h4 id="_1-2-1-cap定理-重点" tabindex="-1"><a class="header-anchor" href="#_1-2-1-cap定理-重点"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-2-1-cap%E5%AE%9A%E7%90%86-%E9%87%8D%E7%82%B9" target="_blank" rel="noopener noreferrer">#</a>1.2.1 CAP定理-重点</span></a></h4><p><img src="https://www.ydlclass.com/doc21xnv/assets/9-20.4fe95d9e.jpg" alt="img"></p><p>CAP定理是在 1998年加州大学的计算机科学家 Eric Brewer （埃里克.布鲁尔）提出，分布式系统有三个指标</p><ul><li>Consistency 强一致性</li><li>Availability 可用性</li><li>Partition tolerance 分区容错</li></ul><p>它们的第一个字母分别是 C、A、P。Eric Brewer 说，这三个指标不可能同时做到。这个结论就叫做 CAP 定理。</p><p><strong>因为：强一致性和可用性 互斥！</strong></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211208164142661.5a2bb1a1.png" alt="image-20211208164142661"></p><p><strong>真实情况</strong>：</p><p>1 ac 传统项目。ssm管理系统，一个程序，一个数据库。</p><p>2 cp 信息重要的场景。手机银行转账。转圈圈，在做数据同步，这段时间内，可用性是没有的。</p><p>3 ap 互联网。 放弃强一致性，慢慢数据同步。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211208164958537.650d2ce3.png" alt="image-20211208164958537"></p><h5 id="分区容错-partition-tolerance" tabindex="-1"><a class="header-anchor" href="#分区容错-partition-tolerance"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#%E5%88%86%E5%8C%BA%E5%AE%B9%E9%94%99-partition-tolerance" target="_blank" rel="noopener noreferrer">#</a>分区容错 Partition tolerance</span></a></h5><p><strong>理解: 分布式系统集群中, 一个机器坏掉不应该影响其他机器</strong></p><p>大多数分布式系统都分布在多个子网络。每个子网络就叫做一个区（partition）。分区容错的意思是，区间通信可能失败。比如，一台服务器放在中国，另一台服务器放在美国，这就是两个区，它们之间可能无法通信。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/9-21.65abc22c.png" alt="img"></p><p>上图中，G1 和 G2 是两台跨区的服务器。G1 向 G2 发送一条消息，G2 可能无法收到。系统设计的时候，必须考虑到这种情况。</p><p>一般来说，分区容错无法避免，因此可以认为 CAP 的 P 总是成立。CAP 定理告诉我们，剩下的 C 和 A 无法同时做到。</p><h5 id="可用性-availability" tabindex="-1"><a class="header-anchor" href="#可用性-availability"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#%E5%8F%AF%E7%94%A8%E6%80%A7-availability" target="_blank" rel="noopener noreferrer">#</a>可用性 Availability</span></a></h5><p><strong>理解: 一个请求, 必须返回一个响应</strong></p><p><strong>Availability 中文叫做&quot;可用性&quot;，意思是只要收到用户的请求，服务器就必须给出回应。</strong></p><p>用户可以选择向 G1 或 G2 发起读操作。不管是哪台服务器，只要收到请求，就必须告诉用户，到底是 v0 还是 v1，否则就不满足可用性。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/9-22.f384e01f.png" alt="img"></p><h5 id="一致性-consistency" tabindex="-1"><a class="header-anchor" href="#一致性-consistency"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#%E4%B8%80%E8%87%B4%E6%80%A7-consistency" target="_blank" rel="noopener noreferrer">#</a>一致性 Consistency</span></a></h5><p><strong>理解: 一定能读取到最新的数据</strong></p><p><strong>Consistency 中文叫做&quot;一致性&quot;。意思是，写操作之后的读操作，必须返回该值。</strong></p><p>举例来说，某条记录是 v0，用户向 G1 发起一个写操作，将其改为 v1。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/9-23.2e1375d4.png" alt="img"></p><p>问题是，用户有可能向 G2 发起读操作，由于 G2 的值没有发生变化，因此返回的是 v0。G1 和 G2 读操作的结果不一致，这就不满足一致性了。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/9-24.f1b242df.png" alt="img"></p><p>为了让 G2 也能变为 v1，就要在 G1 写操作的时候，让 G1 向 G2 发送一条消息，要求 G2 也改成 v1。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/9-25.6b2e1648.png" alt="img"></p><h5 id="一致性和可用性的矛盾" tabindex="-1"><a class="header-anchor" href="#一致性和可用性的矛盾"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#%E4%B8%80%E8%87%B4%E6%80%A7%E5%92%8C%E5%8F%AF%E7%94%A8%E6%80%A7%E7%9A%84%E7%9F%9B%E7%9B%BE" target="_blank" rel="noopener noreferrer">#</a>一致性和可用性的矛盾</span></a></h5><p>一致性(C)和可用性(A)，为什么不可能同时成立？答案很简单，因为可能通信失败（即出现分区容错）。</p><p>如果保证 G2 的一致性，那么 G1 必须在写操作时，锁定 G2 的读操作和写操作。只有数据同步后，才能重新开放读写。锁定期间，G2 不能读写，没有可用性(CP)。</p><p>如果保证 G2 的可用性，那么势必不能锁定 G2，所以一致性不成立(AP)。</p><p>综上所述，G2 无法同时做到一致性和可用性。系统设计时只能选择一个目标。如果追求一致性，那么无法保证所有节点的可用性；如果追求所有节点的可用性，那就没法做到一致性。</p><h4 id="_1-2-2-base理论" tabindex="-1"><a class="header-anchor" href="#_1-2-2-base理论"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-2-2-base%E7%90%86%E8%AE%BA" target="_blank" rel="noopener noreferrer">#</a>1.2.2 BASE理论</span></a></h4><p>BASE：全称：Basically Available(基本可用)，Soft state（软状态）,和 Eventually consistent（最终一致性）三个短语的缩写，来自 ebay 的架构师提出。BASE 理论是对 CAP 中一致性和可用性权衡的结果，其来源于对大型互联网分布式实践的总结，是基于 CAP 定理逐步演化而来的。其核心思想是：</p><blockquote><p>既是无法做到强一致性（Strong consistency），但每个应用都可以根据自身的业务特点，采用适当的方式来使系统达到最终一致性（Eventual consistency）。</p></blockquote><h5 id="basically-available-基本可用" tabindex="-1"><a class="header-anchor" href="#basically-available-基本可用"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#basically-available-%E5%9F%BA%E6%9C%AC%E5%8F%AF%E7%94%A8" target="_blank" rel="noopener noreferrer">#</a>Basically Available(基本可用)</span></a></h5><p><strong>理解: 允许服务降级或者允许响应时间受到一定损失</strong></p><p>什么是基本可用呢？假设系统，出现了不可预知的故障，但还是能用，相比较正常的系统而言：</p><ol><li>响应时间上的损失：正常情况下的搜索引擎 0.5 秒即返回给用户结果，而<strong>基本可用</strong>的搜索引擎可以在 1 秒作用返回结果。</li><li>功能上的损失：在一个电商网站上，正常情况下，用户可以顺利完成每一笔订单，但是到了大促期间，为了保护购物系统的稳定性，部分消费者可能会被引导到一个降级页面。</li></ol><h5 id="soft-state-软状态" tabindex="-1"><a class="header-anchor" href="#soft-state-软状态"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#soft-state-%E8%BD%AF%E7%8A%B6%E6%80%81" target="_blank" rel="noopener noreferrer">#</a>Soft state（软状态）</span></a></h5><p><strong>理解: 允许同步数据的时候出现一定时间延迟</strong></p><p>什么是软状态呢？相对于原子性而言，要求多个节点的数据副本都是一致的，这是一种 “硬状态”。</p><p>软状态指的是：允许系统中的数据存在中间状态，并认为该状态不影响系统的整体可用性，即允许系统在多个不同节点的数据副本存在数据延时。</p><h5 id="eventually-consistent-最终一致性" tabindex="-1"><a class="header-anchor" href="#eventually-consistent-最终一致性"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#eventually-consistent-%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7" target="_blank" rel="noopener noreferrer">#</a>Eventually consistent（最终一致性）</span></a></h5><p>**理解: 经过一段时间的同步数据之后，最终都能够达到一个一致的状态 **</p><p>系统能够保证在没有其他新的更新操作的情况下，数据最终一定能够达到一致的状态，因此所有客户端对系统的数据访问最终都能够获取到最新的值。</p><h3 id="_1-3-分布式事务解决方案-面试" tabindex="-1"><a class="header-anchor" href="#_1-3-分布式事务解决方案-面试"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-3-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-%E9%9D%A2%E8%AF%95" target="_blank" rel="noopener noreferrer">#</a>1.3 分布式事务解决方案-面试</span></a></h3><p>1.XA两段提交(低效率)-2PC</p><p>2.TCC三段提交(3段,高效率[不推荐(补偿代码)])</p><p>3.本地消息表(MQ+Table)</p><p>4.事务消息(RocketMQ[alibaba])</p><p>5.Seata(alibaba)</p><p>6.RabbitMQ的ACK机制实现分布式事务(作业)</p><h4 id="_1-3-1-基于xa协议的两阶段提交-2pc" tabindex="-1"><a class="header-anchor" href="#_1-3-1-基于xa协议的两阶段提交-2pc"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-3-1-%E5%9F%BA%E4%BA%8Exa%E5%8D%8F%E8%AE%AE%E7%9A%84%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4-2pc" target="_blank" rel="noopener noreferrer">#</a>1.3.1 基于XA协议的两阶段提交 2pc</span></a></h4><p>首先我们来简要看下分布式事务处理的XA规范 ：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/9-14.ef61865d.png" alt="img"></p><p>可知XA规范中分布式事务有AP，RM，TM组成：</p><p>其中应用程序(Application Program ，简称AP)：AP定义事务边界（定义事务开始和结束）并访问事务边界内的资源。</p><p>资源管理器(Resource Manager，简称RM)：Rm管理计算机共享的资源，许多软件都可以去访问这些资源，资源包含比如<strong>数据库</strong>、文件系统、打印机服务器等。</p><p>事务管理器(Transaction Manager ，简称TM)：负责管理全局事务，分配事务唯一标识，监控事务的执行进度，并负责事务的提交、回滚、失败恢复等。</p><p><strong>二阶段协议:</strong></p><p><strong>第一阶段</strong>TM要求所有的RM准备提交对应的事务分支，询问RM是否有能力保证成功的提交事务分支，RM根据自己的情况，如果判断自己进行的工作可以被提交，那就对工作内容进行持久化，并给TM回执OK；否者给TM的回执NO。RM在发送了否定答复并回滚了已经的工作后，就可以丢弃这个事务分支信息了。</p><p><strong>第二阶段</strong>TM根据阶段1各个RM prepare的结果，决定是提交还是回滚事务。如果所有的RM都prepare成功，那么TM通知所有的RM进行提交；如果有RM prepare回执NO的话，则TM通知所有RM回滚自己的事务分支。</p><p>也就是TM与RM之间是通过两阶段提交协议进行交互的.</p><p><strong>优点：</strong> 尽量保证了数据的强一致，适合对数据强一致要求很高的关键领域。（其实也不能100%保证强一致）</p><p><strong>缺点：</strong> 实现复杂，牺牲了可用性，对性能影响较大，不适合高并发高性能场景。</p><p><strong>流程看我的图</strong>：</p><p>mysql</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211208174923396.817f1b12.png" alt="image-20211208174923396"></p><p>悲观锁 mysql行级锁 oracle表级锁</p><p>两阶段提交协议(Two Phase Commitment Protocol)中，涉及到两种角色</p><p>一个事务协调者（coordinator）：负责协调多个参与者进行事务投票及提交(回滚) 多个事务参与者（participants）：即本地事务执行者</p><p>总共处理步骤有两个 （1）<strong>投票阶段</strong>（voting phase）：协调者将通知事务参与者准备提交或取消事务，然后进入表决过程。参与者将告知协调者自己的决策：同意（事务参与者本地事务执行成功，但未提交）或取消（本地事务执行故障）； （2）<strong>提交阶段</strong>（commit phase）：收到参与者的通知后，协调者再向参与者发出通知，根据反馈情况决定各参与者是否要提交还是回滚；</p><h4 id="_1-3-2-tcc补偿机制" tabindex="-1"><a class="header-anchor" href="#_1-3-2-tcc补偿机制"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-3-2-tcc%E8%A1%A5%E5%81%BF%E6%9C%BA%E5%88%B6" target="_blank" rel="noopener noreferrer">#</a>1.3.2 TCC补偿机制</span></a></h4><p>TCC 其实就是采用的补偿机制，其核心思想是：针对每个操作，都要注册一个与其对应的确认和补偿（撤销）操作。它分为三个阶段：</p><ul><li>Try 阶段主要是对业务系统做检测及资源预留</li><li>Confirm 阶段主要是对业务系统做确认提交，Try阶段执行成功并开始执行 Confirm阶段时，默认 Confirm阶段是不会出错的。即：只要Try成功，Confirm一定成功。</li><li>Cancel 阶段主要是在业务执行错误，需要回滚的状态下执行的业务取消，预留资源释放。</li></ul><p>例如： A要向 B 转账，思路大概是：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">我们有一个本地方法，里面依次调用 </span>
<span class="line">1、首先在 Try 阶段，要先调用远程接口把 B和 A的钱给冻结起来。 </span>
<span class="line">2、在 Confirm 阶段，执行远程调用的转账的操作，转账成功进行解冻。 </span>
<span class="line">3、如果第2步执行成功，那么转账成功，如果第二步执行失败，则调用远程冻结接口对应的解冻方法 (Cancel)。 </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p><strong>优点：</strong> 相比两阶段提交，可用性比较强</p><p><strong>缺点：</strong> 数据的一致性要差一些。TCC属于应用层的一种补偿方式，所以需要程序员在实现的时候多写很多补偿的代码，在一些场景中，一些业务流程可能用TCC不太好定义及处理。</p><p><strong>流程看我的图：</strong></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211208180127771.c41710b3.png" alt="image-20211208180127771"></p><h4 id="_1-3-3-消息最终一致性-重点" tabindex="-1"><a class="header-anchor" href="#_1-3-3-消息最终一致性-重点"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-3-3-%E6%B6%88%E6%81%AF%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7-%E9%87%8D%E7%82%B9" target="_blank" rel="noopener noreferrer">#</a>1.3.3 消息最终一致性-重点</span></a></h4><p>消息最终一致性应该是业界使用最多的，其核心思想是将分布式事务拆分成本地事务进行处理，这种思路是来源于ebay。我们可以从下面的流程图中看出其中的一些细节：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/9-16.49b5f93c.png" alt="img"></p><p>基本思路就是：</p><p>消息生产方，需要额外建一个消息表，并记录消息发送状态。消息表和业务数据要在一个事务里提交，也就是说他们要在一个数据库里面。然后消息会经过MQ发送到消息的消费方。如果消息发送失败，会进行重试发送。</p><p>消息消费方，需要处理这个消息，并完成自己的业务逻辑。此时如果本地事务处理成功，表明已经处理成功了，如果处理失败，那么就会重试执行。如果是业务上面的失败，可以给生产方发送一个业务补偿消息，通知生产方进行回滚等操作。</p><p>生产方和消费方定时扫描本地消息表，把还没处理完成的消息或者失败的消息再发送一遍。如果有靠谱的自动对账补账逻辑，这种方案还是非常实用的。</p><p><strong>优点：</strong> 一种非常经典的实现，避免了分布式事务，实现了最终一致性。</p><p><strong>缺点：</strong> 消息表会耦合到业务系统中，如果没有封装好的解决方案，会有很多杂活需要处理。</p><p><strong>流程看我的图：</strong></p><p>需求：下单同时，减库存</p><p>参与者A 订单服务</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211208221414338.fafd85a5.png" alt="image-20211208221414338"></p><p>1订单服务</p><p>1.1 订单表插入数据，订单消息表添加数据101。本地事务，可以控制住。</p><p>1.2 定时任务：扫描订单消息表---》mq发一条消息，订单信息</p><p>2商品服务</p><p>2.1监听消息队列，收到消息订单详情。</p><p>2.2sku 减库存，接受到商品订单的消息表。本地事务，可以控制住。</p><p>2.3 定时任务：扫描接受到商品订单的消息表---》mq发一条消息，我已经减库存了</p><p>2.4 mq发一条消息 接受到商品订单的消息表 101 staus 2 已经发了消息了</p><p>3订单服务</p><p>3.1监听消息队列（已经减库存了） 订单消息表 删除</p><h2 id="_2-分布式事务框架seata" tabindex="-1"><a class="header-anchor" href="#_2-分布式事务框架seata"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%A1%86%E6%9E%B6seata" target="_blank" rel="noopener noreferrer">#</a>2. 分布式事务框架seata</span></a></h2><h3 id="_2-1-seata简介" tabindex="-1"><a class="header-anchor" href="#_2-1-seata简介"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-1-seata%E7%AE%80%E4%BB%8B" target="_blank" rel="noopener noreferrer">#</a>2.1 seata简介</span></a></h3><p>Seata（原名Fescar） 是阿里18年开源的分布式事务的框架。Fescar的开源对分布式事务框架领域影响很大。作为开源大户，Fescar来自阿里的GTS，经历了好几次双十一的考验，一经开源便颇受关注。后来Fescar改名为Seata。 https://github.com/seata/seata</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">Fescar虽然是二阶段提交协议的分布式事务，但是其解决了XA的一些缺点:</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>单点问题:虽然目前Fescar(0.4.2)还是单server的，但是Fescar官方预计将会在0.5.x中推出HA-Cluster，到时候就可以解决单点问题。</li><li>同步阻塞:Fescar的二阶段，其再<strong>第一阶段的时候本地事务</strong>就已经提交释放资源了，不会像XA会再两个prepare和commit阶段资源都锁住，并且<strong>Fescar,commit是异步操作</strong>，也是提升性能的一大关键。</li><li>数据不一致:如果出现部分commit失败，那么fescar-server会根据当前的事务模式和分支事务的返回状态的结果来进行不同的重试策略。并且fescar的本地事务会在一阶段的时候进行提交，其实单看数据库来说在commit的时候数据库已经是一致的了。</li><li>只能用于单一数据库: Fescar提供了三种模式，<strong>AT和TCC和混合模式</strong>。在AT模式下事务资源可以是任何支持ACID的数据库，在TCC模式下事务资源没有限制，可以是缓存，可以是文件，可以是其他的等等。当然这两个模式也可以混用。</li></ul><p>同时Fescar也保留了接近0业务入侵的优点，只需要简单的配置Fescar的数据代理和加个注解，加一个Undolog表，就可以达到我们想要的目的。</p><h3 id="_2-2-实现原理" tabindex="-1"><a class="header-anchor" href="#_2-2-实现原理"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-2-%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86" target="_blank" rel="noopener noreferrer">#</a>2.2 实现原理</span></a></h3><p>Fescar将一个本地事务做为一个分布式事务分支，所以若干个分布在不同微服务中的本地事务共同组成了一个全局事务，结构如下。</p><p>官帮助文档： https://seata.io/zh-cn/index.html</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20200304154454364.9fa0e831.png" alt="image-20200304154454364"></p><p>TM：全局事务管理器，在标注开启fescar分布式事务的服务端开启，并将全局事务发送到TC事务控制端管理</p><p>TC：事务控制中心，控制全局事务的提交或者回滚。这个组件需要独立部署维护，目前只支持单机版本，后续迭代计划会有集群版本</p><p>RM：资源管理器，主要负责分支事务的上报，本地事务的管理</p><p>一段话简述其实现过程：服务起始方发起全局事务并注册到TC。在调用协同服务时，协同服务的事务分支事务会先完成阶段一的事务提交或回滚，并生成事务回滚的undo_log日志，同时注册当前协同服务到TC并上报其事务状态，归并到同一个业务的全局事务中。此时若没有问题继续下一个协同服务的调用，期间任何协同服务的分支事务回滚，都会通知到TC，TC在通知全局事务包含的所有已完成一阶段提交的分支事务回滚。如果所有分支事务都正常，最后回到全局事务发起方时，也会通知到TC，TC在通知全局事务包含的所有分支删除回滚日志。在这个过程中为了解决写隔离和度隔离的问题会涉及到TC管理的全局锁。</p><p>（增加订单(branchId=901)，减库存(branchId=109)） xid=101</p><h3 id="_2-3-fescar模式" tabindex="-1"><a class="header-anchor" href="#_2-3-fescar模式"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-3-fescar%E6%A8%A1%E5%BC%8F" target="_blank" rel="noopener noreferrer">#</a>2.3 Fescar模式</span></a></h3><p>Fescar对分布式事务的实现提供了3种模式，AT模式和TCC模式、saga模式：</p><h4 id="_2-3-1-at模式" tabindex="-1"><a class="header-anchor" href="#_2-3-1-at模式"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-3-1-at%E6%A8%A1%E5%BC%8F" target="_blank" rel="noopener noreferrer">#</a>2.3.1 AT模式</span></a></h4><p><strong>AT模式</strong>：主要关注多 DB 访问的数据一致性，实现起来比较简单，对业务的侵入较小，但性能没有TCC高，这种模式推荐大家使用。</p><p>AT模式部分代码如下：不需要关注执行状态，对业务代码侵入较小。</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line">  * 此代码为示例代码, 不需要演示, 主要看AT和TCC代码的区别使用</span>
<span class="line">  */</span></span>
<span class="line"><span class="token annotation punctuation">@GlobalTransactional</span><span class="token punctuation">(</span>timeoutMills <span class="token operator">=</span> <span class="token number">300000</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">&quot;dubbo-demo-tx&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">purchase</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> commodityCode<span class="token punctuation">,</span> <span class="token keyword">int</span> orderCount<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;purchase begin ... xid: &quot;</span> <span class="token operator">+</span> <span class="token class-name">RootContext</span><span class="token punctuation">.</span><span class="token function">getXID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    storageService<span class="token punctuation">.</span><span class="token function">deduct</span><span class="token punctuation">(</span>commodityCode<span class="token punctuation">,</span> orderCount<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    orderService<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> commodityCode<span class="token punctuation">,</span> orderCount<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;AT 模式发生异常，回滚事务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10</p><p>AT模式的核心是对业务无侵入，是一种改进后的两阶段提交，其设计思路如图：</p><p><strong>第一阶段：</strong></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/1558409540227.537f2214.png" alt="img"></p><p>核心在于对业务sql进行解析，转换成undolog，两阶段提交往往对资源的锁定需要持续到第二阶段实际的提交或者回滚操作，而有了回滚日志之后，可以在第一阶段释放对资源的锁定，降低了锁范围，提高效率，即使第二阶段发生异常需要回滚，只需找对undolog中对应数据并反解析成sql来达到回滚目的。Seata通过代理数据源将业务sql的执行解析成undolog来与业务数据的更新同时入库，达到了对业务无侵入的效果。</p><p><strong>第二阶段：</strong></p><p>如果决议是全局提交，此时分支事务此时已经完成提交，不需要同步协调处理（只需要异步清理回滚日志），Phase2 可以非常快速地完成。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/1558409853936.0fbc96dc.png" alt="img"></p><p>如果决议是全局回滚，RM 收到协调器发来的回滚请求，通过 XID 和 Branch ID 找到相应的回滚日志记录，<strong>通过回滚记录生成反向的更新 SQL 并执行</strong>，以完成分支的回滚。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/1558409898660.37b574ad.png" alt="img"></p><h4 id="_2-3-3-tcc模式" tabindex="-1"><a class="header-anchor" href="#_2-3-3-tcc模式"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-3-3-tcc%E6%A8%A1%E5%BC%8F" target="_blank" rel="noopener noreferrer">#</a>2.3.3 TCC模式</span></a></h4><p><strong>TCC模式</strong>：TCC补偿机制，对代码造成一定的侵入,实现难度较大，这种方式不推荐，不过TCC模式的特点是性能高。</p><p>TCC模式部分代码如下：可以看到执行事务回滚，都需要根据不同阶段执行的状态判断，侵入了业务代码。</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 此代码为示例代码, 不需要演示, 主要看AT和TCC代码的区别使用</span>
<span class="line"> * 转账操作</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">from</span>  扣钱账户</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">to</span>  加钱账户</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">amount</span>  转账金额</span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token annotation punctuation">@GlobalTransactional</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> from<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token keyword">to</span><span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">double</span> amount<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//扣钱参与者，一阶段执行</span></span>
<span class="line">    <span class="token keyword">boolean</span> ret <span class="token operator">=</span> firstTccAction<span class="token punctuation">.</span><span class="token function">prepareMinus</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> from<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//扣钱参与者，一阶段失败; 回滚本地事务和分布式事务</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;账号:[&quot;</span><span class="token operator">+</span>from<span class="token operator">+</span><span class="token string">&quot;] 预扣款失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//加钱参与者，一阶段执行</span></span>
<span class="line">    ret <span class="token operator">=</span> secondTccAction<span class="token punctuation">.</span><span class="token function">prepareAdd</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">to</span><span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;账号:[&quot;</span><span class="token operator">+</span><span class="token keyword">to</span><span class="token operator">+</span><span class="token string">&quot;] 预收款失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;transfer amount[%s] from [%s] to [%s] finish.&quot;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">,</span> from<span class="token punctuation">,</span> <span class="token keyword">to</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29</p><h4 id="_2-3-3-saga模式" tabindex="-1"><a class="header-anchor" href="#_2-3-3-saga模式"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-3-3-saga%E6%A8%A1%E5%BC%8F" target="_blank" rel="noopener noreferrer">#</a>2.3.3 Saga模式</span></a></h4><p>详见 https://seata.io/zh-cn/docs/dev/mode/saga-mode.html</p><h2 id="_3-seata案例" tabindex="-1"><a class="header-anchor" href="#_3-seata案例"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-seata%E6%A1%88%E4%BE%8B" target="_blank" rel="noopener noreferrer">#</a>3 Seata案例</span></a></h2><h3 id="_3-1准备工作" tabindex="-1"><a class="header-anchor" href="#_3-1准备工作"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-1%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C" target="_blank" rel="noopener noreferrer">#</a>3.1准备工作</span></a></h3><p>1导入资料中的ydles_common_fescar。注意总父工程中加入模块</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">&lt;module&gt;ydles_common_fescar&lt;/module&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>2观察模块中的三个类。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211209000033506.c324735a.png" alt="image-20211209000033506"></p><p>3数据库ydles_order中的undo_log表为记录相关操作的表</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211209000144424.e15a585c.png" alt="image-20211209000144424"></p><p>4资料中的fescar-server-0.4.2解压，bin目录中双击fescar-server.bat。<strong>注意</strong>：这是fescar的服务，并且放到一个短目录才能执行。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211209000404624.d97345d0.png" alt="image-20211209000404624"></p><h3 id="_3-2分布式事务错误演示" tabindex="-1"><a class="header-anchor" href="#_3-2分布式事务错误演示"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-2%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E9%94%99%E8%AF%AF%E6%BC%94%E7%A4%BA" target="_blank" rel="noopener noreferrer">#</a>3.2分布式事务错误演示</span></a></h3><p>1order服务 com.ydles.order.service.impl 的 add方法中增加一个错误 本地事务控制注解增加@Transactional</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">		//减库存</span>
<span class="line">        skuFeign.decrCount(order.getUsername());</span>
<span class="line"></span>
<span class="line">        int i=1/0;</span>
<span class="line"></span>
<span class="line">        // 5）删除购物车中数据</span>
<span class="line">        redisTemplate.delete(&quot;cart_&quot;+order.getUsername());</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8</p><p>2goods 服务 com.ydles.goods.service.impl decrCount减库存方法上增加本地事务控制注解@Transactional</p><p>3查看数据库 tb_order tb_order_item中没数据。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211209001159153.6bf084e1.png" alt="image-20211209001159153"></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211209001206890.ab28a1d3.png" alt="image-20211209001206890"></p><p>tb_sku查看一条数据库存量 100</p><p>4登陆购物车并登陆 http://localhost:8001/api/wcart/list</p><p>5往购物车添加数据 http://localhost:8001/api/wcart/add?skuId=1450862568724758528&amp;num=5</p><p>6购物车页面点击结算到订单页面</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211209001242965.52894bc4.png" alt="image-20211209001242965"></p><p>7点击提交订单</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211209001233900.dc70a307.png" alt="image-20211209001233900"></p><p>8代码中 order服务报错</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211209001252770.1eb805bc.png" alt="image-20211209001252770"></p><p>9观察数据库</p><p>tb_order tb_order_item没变</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211209001159153.6bf084e1.png" alt="image-20211209001159153"></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211209001206890.ab28a1d3.png" alt="image-20211209001206890"></p><p>tb_sku 1450862568724758528商品库存减少了5</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211209001328489.52ca7c07.png" alt="image-20211209001328489"></p><p>10 为什么</p><p>order goods服务是两个服务，即使加上@Transactional也是本地事务控制。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211209001403817.97cc1736.png" alt="image-20211209001403817"></p><h3 id="_3-3-分布式事务正确演示" tabindex="-1"><a class="header-anchor" href="#_3-3-分布式事务正确演示"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-3-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%AD%A3%E7%A1%AE%E6%BC%94%E7%A4%BA" target="_blank" rel="noopener noreferrer">#</a>3.3 分布式事务正确演示</span></a></h3><p>1 goods order 增加fescar依赖</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">        &lt;dependency&gt;</span>
<span class="line">            &lt;groupId&gt;com.ydles&lt;/groupId&gt;</span>
<span class="line">            &lt;artifactId&gt;ydles_common_fescar&lt;/artifactId&gt;</span>
<span class="line">            &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span>
<span class="line">        &lt;/dependency&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p>2在订单微服务的OrderServiceImpl的add方法上增加@GlobalTransactional(name = &quot;order_add&quot;)注解</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211209001555985.643dfe75.png" alt="image-20211209001555985"></p><p>我的购物车</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211209001721316.38d5d8e1.png" alt="image-20211209001721316"></p><p>到结算页</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211209001737111.f8df4cdb.png" alt="image-20211209001737111"></p><p>下单失败了</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211209001813785.c968a192.png" alt="image-20211209001813785"></p><p>3order 服务重启 观察 fescar控制台输出</p><p>4goods 服务重启 观察 fescar控制台输出</p><p>5重新提交订单 依然失败 但库存不扣减了</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211209001946242.ef4fae3f.png" alt="image-20211209001946242"></p><h2 id="_4消息队列实现分布式事务-整个项目的重点" tabindex="-1"><a class="header-anchor" href="#_4消息队列实现分布式事务-整个项目的重点"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_4%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1-%E6%95%B4%E4%B8%AA%E9%A1%B9%E7%9B%AE%E7%9A%84%E9%87%8D%E7%82%B9" target="_blank" rel="noopener noreferrer">#</a>4消息队列实现分布式事务---整个项目的重点</span></a></h2><h4 id="_1业务流程-重点" tabindex="-1"><a class="header-anchor" href="#_1业务流程-重点"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B-%E9%87%8D%E7%82%B9" target="_blank" rel="noopener noreferrer">#</a>1业务流程-重点</span></a></h4><p>需求：（一次下单---》用户积分增加一次） 事务</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211209011831937.4975c2d0.png" alt="image-20211209011831937"></p><p>1 order</p><p>1.1 order task.本地事务控制。</p><p>1.2 spring-task扫表 task-----》mq发消息</p><p>2user</p><p>2.1监听消息 6</p><p>2.2 8相当于锁 11释放锁</p><p>2.3 mq（另一个队列） task 积分加上了</p><p>3order</p><p>3.1监听消息 task_his 加上，后期查看，task 删除</p><h4 id="_2代码实现" tabindex="-1"><a class="header-anchor" href="#_2代码实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>2代码实现</span></a></h4><h5 id="_2-1准备" tabindex="-1"><a class="header-anchor" href="#_2-1准备"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-1%E5%87%86%E5%A4%87" target="_blank" rel="noopener noreferrer">#</a>2.1准备</span></a></h5><h6 id="_1order中添加两张表" tabindex="-1"><a class="header-anchor" href="#_1order中添加两张表"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1order%E4%B8%AD%E6%B7%BB%E5%8A%A0%E4%B8%A4%E5%BC%A0%E8%A1%A8" target="_blank" rel="noopener noreferrer">#</a>1order中添加两张表</span></a></h6><p>tb_task 任务表</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211209012241987.10f3aeca.png" alt="image-20211209012241987"></p><p>tb_task_his 历史任务表</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211209012312800.ac75811f.png" alt="image-20211209012312800"></p><h6 id="_2order-api中添加对应的实体类" tabindex="-1"><a class="header-anchor" href="#_2order-api中添加对应的实体类"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2order-api%E4%B8%AD%E6%B7%BB%E5%8A%A0%E5%AF%B9%E5%BA%94%E7%9A%84%E5%AE%9E%E4%BD%93%E7%B1%BB" target="_blank" rel="noopener noreferrer">#</a>2order-api中添加对应的实体类</span></a></h6><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>order<span class="token punctuation">.</span>pojo</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span></span><span class="token class-name">Column</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span></span><span class="token class-name">Id</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span></span><span class="token class-name">Table</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;tb_task&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Task</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Id</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;create_time&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Date</span> createTime<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;update_time&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Date</span> updateTime<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;delete_time&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Date</span> deleteTime<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;task_type&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> taskType<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;mq_exchange&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> mqExchange<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;mq_routingkey&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> mqRoutingkey<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;request_body&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> requestBody<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;status&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> status<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;errormsg&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> errormsg<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> id<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Date</span> <span class="token function">getCreateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> createTime<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token class-name">Date</span> createTime<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>createTime <span class="token operator">=</span> createTime<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Date</span> <span class="token function">getUpdateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> updateTime<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUpdateTime</span><span class="token punctuation">(</span><span class="token class-name">Date</span> updateTime<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>updateTime <span class="token operator">=</span> updateTime<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Date</span> <span class="token function">getDeleteTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> deleteTime<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDeleteTime</span><span class="token punctuation">(</span><span class="token class-name">Date</span> deleteTime<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>deleteTime <span class="token operator">=</span> deleteTime<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getTaskType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> taskType<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setTaskType</span><span class="token punctuation">(</span><span class="token class-name">String</span> taskType<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>taskType <span class="token operator">=</span> taskType<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMqExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> mqExchange<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMqExchange</span><span class="token punctuation">(</span><span class="token class-name">String</span> mqExchange<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>mqExchange <span class="token operator">=</span> mqExchange<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMqRoutingkey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> mqRoutingkey<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMqRoutingkey</span><span class="token punctuation">(</span><span class="token class-name">String</span> mqRoutingkey<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>mqRoutingkey <span class="token operator">=</span> mqRoutingkey<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getRequestBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> requestBody<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setRequestBody</span><span class="token punctuation">(</span><span class="token class-name">String</span> requestBody<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>requestBody <span class="token operator">=</span> requestBody<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> status<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">String</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> status<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getErrormsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> errormsg<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setErrormsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> errormsg<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>errormsg <span class="token operator">=</span> errormsg<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>order<span class="token punctuation">.</span>pojo</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span></span><span class="token class-name">Column</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span></span><span class="token class-name">Id</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span></span><span class="token class-name">Table</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;tb_task_his&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TaskHis</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Id</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;create_time&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Date</span> createTime<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;update_time&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Date</span> updateTime<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;delete_time&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Date</span> deleteTime<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;task_type&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> taskType<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;mq_exchange&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> mqExchange<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;mq_routingkey&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> mqRoutingkey<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;request_body&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> requestBody<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;status&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> status<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;errormsg&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> errormsg<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> id<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Date</span> <span class="token function">getCreateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> createTime<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token class-name">Date</span> createTime<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>createTime <span class="token operator">=</span> createTime<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Date</span> <span class="token function">getUpdateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> updateTime<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUpdateTime</span><span class="token punctuation">(</span><span class="token class-name">Date</span> updateTime<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>updateTime <span class="token operator">=</span> updateTime<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Date</span> <span class="token function">getDeleteTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> deleteTime<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDeleteTime</span><span class="token punctuation">(</span><span class="token class-name">Date</span> deleteTime<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>deleteTime <span class="token operator">=</span> deleteTime<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getTaskType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> taskType<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setTaskType</span><span class="token punctuation">(</span><span class="token class-name">String</span> taskType<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>taskType <span class="token operator">=</span> taskType<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMqExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> mqExchange<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMqExchange</span><span class="token punctuation">(</span><span class="token class-name">String</span> mqExchange<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>mqExchange <span class="token operator">=</span> mqExchange<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMqRoutingkey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> mqRoutingkey<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMqRoutingkey</span><span class="token punctuation">(</span><span class="token class-name">String</span> mqRoutingkey<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>mqRoutingkey <span class="token operator">=</span> mqRoutingkey<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getRequestBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> requestBody<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setRequestBody</span><span class="token punctuation">(</span><span class="token class-name">String</span> requestBody<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>requestBody <span class="token operator">=</span> requestBody<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> status<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">String</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> status<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getErrormsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> errormsg<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setErrormsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> errormsg<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>errormsg <span class="token operator">=</span> errormsg<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121</p><h6 id="_3-ydles-user新增积分日志表" tabindex="-1"><a class="header-anchor" href="#_3-ydles-user新增积分日志表"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-ydles-user%E6%96%B0%E5%A2%9E%E7%A7%AF%E5%88%86%E6%97%A5%E5%BF%97%E8%A1%A8" target="_blank" rel="noopener noreferrer">#</a>3 ydles_user新增积分日志表</span></a></h6><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211209012706482.2e5c4330.png" alt="image-20211209012706482"></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211209012742948.cad23f23.png" alt="image-20211209012742948"></p><h6 id="_4-ydles-service-user-api添加实体类-pointlog" tabindex="-1"><a class="header-anchor" href="#_4-ydles-service-user-api添加实体类-pointlog"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_4-ydles-service-user-api%E6%B7%BB%E5%8A%A0%E5%AE%9E%E4%BD%93%E7%B1%BB-pointlog" target="_blank" rel="noopener noreferrer">#</a>4 ydles_service_user_api添加实体类 PointLog</span></a></h6><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>user<span class="token punctuation">.</span>pojo</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span></span><span class="token class-name">Table</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;tb_point_log&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PointLog</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> orderId<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> userId<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Integer</span> point<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> orderId<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>orderId <span class="token operator">=</span> orderId<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> userId<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>userId <span class="token operator">=</span> userId<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> point<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPoint</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> point<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>point <span class="token operator">=</span> point<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35</p><h6 id="_5rabbitmq" tabindex="-1"><a class="header-anchor" href="#_5rabbitmq"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_5rabbitmq" target="_blank" rel="noopener noreferrer">#</a>5rabbitMQ</span></a></h6><p>1 order 服务 导包</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">        &lt;dependency&gt;</span>
<span class="line">            &lt;groupId&gt;org.springframework.amqp&lt;/groupId&gt;</span>
<span class="line">            &lt;artifactId&gt;spring-rabbit&lt;/artifactId&gt;</span>
<span class="line">        &lt;/dependency&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p>2config 下 rabbitMQ配置类</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>order<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Qualifier</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token annotation punctuation">@Configuration</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitMQConfig</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//添加积分任务交换机</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">EX_BUYING_ADDPOINTUSER</span> <span class="token operator">=</span> <span class="token string">&quot;ex_buying_addpointuser&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//添加积分消息队列</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CG_BUYING_ADDPOINT</span> <span class="token operator">=</span> <span class="token string">&quot;cg_buying_addpoint&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//完成添加积分消息队列</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CG_BUYING_FINISHADDPOINT</span> <span class="token operator">=</span> <span class="token string">&quot;cg_buying_finishaddpoint&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//添加积分路由key</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CG_BUYING_ADDPOINT_KEY</span> <span class="token operator">=</span> <span class="token string">&quot;addpoint&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//完成添加积分路由key</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CG_BUYING_FINISHADDPOINT_KEY</span> <span class="token operator">=</span> <span class="token string">&quot;finishaddpoint&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//声明交换机</span></span>
<span class="line">    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token constant">EX_BUYING_ADDPOINTUSER</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Exchange</span> <span class="token function">EX_BUYING_ADDPOINTUSER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token class-name">ExchangeBuilder</span><span class="token punctuation">.</span><span class="token function">directExchange</span><span class="token punctuation">(</span><span class="token constant">EX_BUYING_ADDPOINTUSER</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//声明队列</span></span>
<span class="line">    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token constant">CG_BUYING_ADDPOINT</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">CG_BUYING_ADDPOINT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Queue</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token constant">CG_BUYING_ADDPOINT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> queue<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token constant">CG_BUYING_FINISHADDPOINT</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">CG_BUYING_FINISHADDPOINT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Queue</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token constant">CG_BUYING_FINISHADDPOINT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> queue<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//队列绑定交换机</span></span>
<span class="line">    <span class="token annotation punctuation">@Bean</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">BINDING_CG_BUYING_ADDPOINT</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token constant">CG_BUYING_ADDPOINT</span><span class="token punctuation">)</span> <span class="token class-name">Queue</span> queue<span class="token punctuation">,</span> <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token constant">EX_BUYING_ADDPOINTUSER</span><span class="token punctuation">)</span><span class="token class-name">Exchange</span> exchange<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token constant">CG_BUYING_ADDPOINT_KEY</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">noargs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token annotation punctuation">@Bean</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">BINDING_CG_BUYING_FINISHADDPOINT</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token constant">CG_BUYING_FINISHADDPOINT</span><span class="token punctuation">)</span> <span class="token class-name">Queue</span> queue<span class="token punctuation">,</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token constant">EX_BUYING_ADDPOINTUSER</span><span class="token punctuation">)</span><span class="token class-name">Exchange</span> exchange<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token constant">CG_BUYING_FINISHADDPOINT_KEY</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">noargs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54</p><p>3配置文件 rabbitmq</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">  rabbitmq:</span>
<span class="line">    host: 192.168.200.128</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><h5 id="_2-2-订单服务逻辑" tabindex="-1"><a class="header-anchor" href="#_2-2-订单服务逻辑"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-2-%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1%E9%80%BB%E8%BE%91" target="_blank" rel="noopener noreferrer">#</a>2.2 订单服务逻辑</span></a></h5><p>需求：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211209014056551.f6f18d2b.png" alt="image-20211209014056551"></p><h6 id="_1dao层-增加mapper" tabindex="-1"><a class="header-anchor" href="#_1dao层-增加mapper"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1dao%E5%B1%82-%E5%A2%9E%E5%8A%A0mapper" target="_blank" rel="noopener noreferrer">#</a>1dao层 增加mapper</span></a></h6><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">package com.ydles.order.dao;</span>
<span class="line"></span>
<span class="line">import com.ydles.order.pojo.Task;</span>
<span class="line">import tk.mybatis.mapper.common.Mapper;</span>
<span class="line"></span>
<span class="line">public interface TaskMapper extends Mapper&lt;Task&gt; {</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">package com.ydles.order.dao;</span>
<span class="line"></span>
<span class="line">import com.ydles.order.pojo.TaskHis;</span>
<span class="line">import tk.mybatis.mapper.common.Mapper;</span>
<span class="line"></span>
<span class="line">public interface TaskHisMapper extends Mapper&lt;TaskHis&gt; {</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><h6 id="_2下单逻辑中增加任务" tabindex="-1"><a class="header-anchor" href="#_2下单逻辑中增加任务"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2%E4%B8%8B%E5%8D%95%E9%80%BB%E8%BE%91%E4%B8%AD%E5%A2%9E%E5%8A%A0%E4%BB%BB%E5%8A%A1" target="_blank" rel="noopener noreferrer">#</a>2下单逻辑中增加任务</span></a></h6><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">    @Autowired</span>
<span class="line">    TaskMapper taskMapper;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">		<span class="token comment">// int i=1/0;</span></span>
<span class="line">        <span class="token comment">//添加任务数据</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;向订单数据库中的任务表去添加任务数据&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Task</span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        task<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        task<span class="token punctuation">.</span><span class="token function">setUpdateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        task<span class="token punctuation">.</span><span class="token function">setMqExchange</span><span class="token punctuation">(</span><span class="token class-name">RabbitMQConfig</span><span class="token punctuation">.</span><span class="token constant">EX_BUYING_ADDPOINTUSER</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        task<span class="token punctuation">.</span><span class="token function">setMqRoutingkey</span><span class="token punctuation">(</span><span class="token class-name">RabbitMQConfig</span><span class="token punctuation">.</span><span class="token constant">CG_BUYING_ADDPOINT_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">Map</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">,</span>order<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;orderId&quot;</span><span class="token punctuation">,</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;point&quot;</span><span class="token punctuation">,</span>order<span class="token punctuation">.</span><span class="token function">getPayMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        task<span class="token punctuation">.</span><span class="token function">setRequestBody</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        taskMapper<span class="token punctuation">.</span><span class="token function">insertSelective</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15</p><h6 id="_3定时任务-定时发送任务表信息到mq" tabindex="-1"><a class="header-anchor" href="#_3定时任务-定时发送任务表信息到mq"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1-%E5%AE%9A%E6%97%B6%E5%8F%91%E9%80%81%E4%BB%BB%E5%8A%A1%E8%A1%A8%E4%BF%A1%E6%81%AF%E5%88%B0mq" target="_blank" rel="noopener noreferrer">#</a>3定时任务，定时发送任务表信息到mq</span></a></h6><p>启动类增加</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">@EnableScheduling //开启定时任务</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>新建task包，加入定时任务类</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueryPointTask</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">TaskMapper</span> taskMapper<span class="token punctuation">;</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span></span>
<span class="line">    <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">&quot;0/2 * * * * ?&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">queryTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//1. 获取小于系统当前时间的数据</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">&gt;</span></span> taskList <span class="token operator">=</span> taskMapper<span class="token punctuation">.</span><span class="token function">findTaskLessThanCurrentTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>taskList <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> taskList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//2.将任务发送到消息队列上</span></span>
<span class="line">            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Task</span> task <span class="token operator">:</span> taskList<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token class-name">RabbitMQConfig</span><span class="token punctuation">.</span><span class="token constant">EX_BUYING_ADDPOINTUSER</span><span class="token punctuation">,</span> <span class="token class-name">RabbitMQConfig</span><span class="token punctuation">.</span><span class="token constant">CG_BUYING_ADDPOINT_KEY</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;订单服务向添加积分队列发送了一条消息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19</p><p>taskmapper中自定义查询小于当前时间的方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">&quot;select * from tb_task where update_time&lt;#{currentTime}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token annotation punctuation">@Results</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token annotation punctuation">@Result</span><span class="token punctuation">(</span>column <span class="token operator">=</span> <span class="token string">&quot;create_time&quot;</span><span class="token punctuation">,</span>property <span class="token operator">=</span> <span class="token string">&quot;createTime&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token annotation punctuation">@Result</span><span class="token punctuation">(</span>column <span class="token operator">=</span> <span class="token string">&quot;update_time&quot;</span><span class="token punctuation">,</span>property <span class="token operator">=</span> <span class="token string">&quot;updateTime&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token annotation punctuation">@Result</span><span class="token punctuation">(</span>column <span class="token operator">=</span> <span class="token string">&quot;delete_time&quot;</span><span class="token punctuation">,</span>property <span class="token operator">=</span> <span class="token string">&quot;deleteTime&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token annotation punctuation">@Result</span><span class="token punctuation">(</span>column <span class="token operator">=</span> <span class="token string">&quot;task_type&quot;</span><span class="token punctuation">,</span>property <span class="token operator">=</span> <span class="token string">&quot;taskType&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token annotation punctuation">@Result</span><span class="token punctuation">(</span>column <span class="token operator">=</span> <span class="token string">&quot;mq_exchange&quot;</span><span class="token punctuation">,</span>property <span class="token operator">=</span> <span class="token string">&quot;mqExchange&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token annotation punctuation">@Result</span><span class="token punctuation">(</span>column <span class="token operator">=</span> <span class="token string">&quot;mq_routingkey&quot;</span><span class="token punctuation">,</span>property <span class="token operator">=</span> <span class="token string">&quot;mqRoutingkey&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token annotation punctuation">@Result</span><span class="token punctuation">(</span>column <span class="token operator">=</span> <span class="token string">&quot;request_body&quot;</span><span class="token punctuation">,</span>property <span class="token operator">=</span> <span class="token string">&quot;requestBody&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token annotation punctuation">@Result</span><span class="token punctuation">(</span>column <span class="token operator">=</span> <span class="token string">&quot;status&quot;</span><span class="token punctuation">,</span>property <span class="token operator">=</span> <span class="token string">&quot;status&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token annotation punctuation">@Result</span><span class="token punctuation">(</span>column <span class="token operator">=</span> <span class="token string">&quot;errormsg&quot;</span><span class="token punctuation">,</span>property <span class="token operator">=</span> <span class="token string">&quot;errormsg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">&gt;</span></span> <span class="token function">findTaskLessThanCurrentTime</span><span class="token punctuation">(</span><span class="token class-name">Date</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11</p><h5 id="_2-3-用户服务逻辑" tabindex="-1"><a class="header-anchor" href="#_2-3-用户服务逻辑"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-3-%E7%94%A8%E6%88%B7%E6%9C%8D%E5%8A%A1%E9%80%BB%E8%BE%91" target="_blank" rel="noopener noreferrer">#</a>2.3 用户服务逻辑</span></a></h5><p>需求：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211209021057873.ed693ff9.png" alt="image-20211209021057873"></p><h6 id="_1配置文件增加redis-rabbitmq配置" tabindex="-1"><a class="header-anchor" href="#_1配置文件增加redis-rabbitmq配置"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%A2%9E%E5%8A%A0redis-rabbitmq%E9%85%8D%E7%BD%AE" target="_blank" rel="noopener noreferrer">#</a>1配置文件增加redis rabbitMQ配置</span></a></h6><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">spring</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">application</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> user</span>
<span class="line">  <span class="token key atrule">datasource</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver</span>
<span class="line">    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//192.168.200.128<span class="token punctuation">:</span>3306/ydles_user<span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC</span></span>
<span class="line">    <span class="token key atrule">username</span><span class="token punctuation">:</span> root</span>
<span class="line">    <span class="token key atrule">password</span><span class="token punctuation">:</span> root</span>
<span class="line">  <span class="token key atrule">main</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">allow-bean-definition-overriding</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment">#当遇到同样名字的时候，是否允许覆盖注册</span></span>
<span class="line">  <span class="token key atrule">redis</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.200.128</span>
<span class="line">  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.200.128</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14</p><h6 id="_2导入mq依赖" tabindex="-1"><a class="header-anchor" href="#_2导入mq依赖"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2%E5%AF%BC%E5%85%A5mq%E4%BE%9D%E8%B5%96" target="_blank" rel="noopener noreferrer">#</a>2导入mq依赖</span></a></h6><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">        &lt;dependency&gt;</span>
<span class="line">            &lt;groupId&gt;org.springframework.amqp&lt;/groupId&gt;</span>
<span class="line">            &lt;artifactId&gt;spring-rabbit&lt;/artifactId&gt;</span>
<span class="line">        &lt;/dependency&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><h6 id="_3mq配置类" tabindex="-1"><a class="header-anchor" href="#_3mq配置类"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3mq%E9%85%8D%E7%BD%AE%E7%B1%BB" target="_blank" rel="noopener noreferrer">#</a>3mq配置类</span></a></h6><p>RabbitMQConfig ，从order服务copy</p><h6 id="_4添加依赖" tabindex="-1"><a class="header-anchor" href="#_4添加依赖"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_4%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96" target="_blank" rel="noopener noreferrer">#</a>4添加依赖</span></a></h6><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">        &lt;dependency&gt;</span>
<span class="line">            &lt;groupId&gt;com.ydles&lt;/groupId&gt;</span>
<span class="line">            &lt;artifactId&gt;ydles_service_order_api&lt;/artifactId&gt;</span>
<span class="line">            &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span>
<span class="line">        &lt;/dependency&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><h6 id="_4监听mq队列" tabindex="-1"><a class="header-anchor" href="#_4监听mq队列"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_4%E7%9B%91%E5%90%ACmq%E9%98%9F%E5%88%97" target="_blank" rel="noopener noreferrer">#</a>4监听mq队列</span></a></h6><p>com.ydles.user.listener创建AddPointListener</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>user<span class="token punctuation">.</span>listener</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>order<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Task</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>user<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">RabbitMQConfig</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>user<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">UserService</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RabbitListener</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RabbitTemplate</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RedisTemplate</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AddPointListener</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token class-name">RabbitMQConfig</span><span class="token punctuation">.</span><span class="token constant">CG_BUYING_ADDPOINT</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveAddPointMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;用户服务接收到了任务消息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//转换消息</span></span>
<span class="line">        <span class="token class-name">Task</span> task <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token class-name">Task</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getRequestBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//判断redis中当前的任务是否存在</span></span>
<span class="line">        <span class="token class-name">Object</span> value <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundValueOps</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">     </span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42</p><h6 id="_5更新积分方法实现" tabindex="-1"><a class="header-anchor" href="#_5更新积分方法实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_5%E6%9B%B4%E6%96%B0%E7%A7%AF%E5%88%86%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>5更新积分方法实现</span></a></h6><p>1userService 定义接口</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">int</span> <span class="token function">updateUserPoint</span><span class="token punctuation">(</span><span class="token class-name">Task</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>实现类</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token annotation punctuation">@Transactional</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">updateUserPoint</span><span class="token punctuation">(</span><span class="token class-name">Task</span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;用户服务现在开始对任务进行处理&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//1.从task中获取相关数据</span></span>
<span class="line">        <span class="token class-name">Map</span> map <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getRequestBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">String</span> username <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">String</span> orderId <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;orderId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">int</span> point <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;point&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//2.判断当前的任务是否操作过</span></span>
<span class="line">        <span class="token class-name">PointLog</span> pointLog <span class="token operator">=</span> pointLogMapper<span class="token punctuation">.</span><span class="token function">findPointLogByOrderId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>pointLog <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//3.将任务存入到redis中</span></span>
<span class="line">        redisTemplate<span class="token punctuation">.</span><span class="token function">boundValueOps</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;exist&quot;</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//4.修改用户积分</span></span>
<span class="line">        <span class="token keyword">int</span> result <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">updateUserPoint</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>point<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//5.记录积分日志信息</span></span>
<span class="line">        pointLog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PointLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        pointLog<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        pointLog<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        pointLog<span class="token punctuation">.</span><span class="token function">setPoint</span><span class="token punctuation">(</span>point<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        result <span class="token operator">=</span> pointLogMapper<span class="token punctuation">.</span><span class="token function">insertSelective</span><span class="token punctuation">(</span>pointLog<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//6.删除redis中的任务信息</span></span>
<span class="line">        redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;用户服务完成了更改用户积分的操作&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40</p><p>2dao层新建mapper,查询当前任务是否操作过</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>user<span class="token punctuation">.</span>dao</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>user<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">PointLog</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">Param</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">Select</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">tk<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Mapper</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PointLogMapper</span> <span class="token keyword">extends</span> <span class="token class-name">Mapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PointLog</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">&quot;select * from tb_point_log where order_id =#{orderId}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token class-name">PointLog</span> <span class="token function">findPointLogByOrderId</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;orderId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13</p><p>3userMapper新增一个修改用户积分方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>user<span class="token punctuation">.</span>dao</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>user<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">User</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">Param</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">Update</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">tk<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Mapper</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserMapper</span> <span class="token keyword">extends</span> <span class="token class-name">Mapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Update</span><span class="token punctuation">(</span><span class="token string">&quot;update tb_user set points=points+#{point} where username=#{username}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">int</span> <span class="token function">updateUserPoint</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;point&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> point<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12</p><p>4AddPointListener完善</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>user<span class="token punctuation">.</span>listener</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>order<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Task</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>user<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">RabbitMQConfig</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>user<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">UserService</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RabbitListener</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RabbitTemplate</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RedisTemplate</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AddPointListener</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token class-name">RabbitMQConfig</span><span class="token punctuation">.</span><span class="token constant">CG_BUYING_ADDPOINT</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveAddPointMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;用户服务接收到了任务消息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//1转换消息</span></span>
<span class="line">        <span class="token class-name">Task</span> task <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token class-name">Task</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getRequestBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//2判断redis中当前的任务是否存在</span></span>
<span class="line">        <span class="token class-name">Object</span> value <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundValueOps</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//3更新用户积分</span></span>
<span class="line">        <span class="token keyword">int</span> result <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">updateUserPoint</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//4向订单服务返回通知消息</span></span>
<span class="line">        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token class-name">RabbitMQConfig</span><span class="token punctuation">.</span><span class="token constant">EX_BUYING_ADDPOINTUSER</span><span class="token punctuation">,</span><span class="token class-name">RabbitMQConfig</span><span class="token punctuation">.</span><span class="token constant">CG_BUYING_FINISHADDPOINT_KEY</span><span class="token punctuation">,</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;用户服务向完成添加积分队列发送了一条消息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52</p><h5 id="_2-4订单服务收尾" tabindex="-1"><a class="header-anchor" href="#_2-4订单服务收尾"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-4%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1%E6%94%B6%E5%B0%BE" target="_blank" rel="noopener noreferrer">#</a>2.4订单服务收尾</span></a></h5><p>需求：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211209025157447.aeb92e16.png" alt="image-20211209025157447"></p><p>建立监听类DelTaskListener</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>order<span class="token punctuation">.</span>listener</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>order<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">RabbitMQConfig</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>order<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Task</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>order<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">TaskService</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RabbitListener</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DelTaskListener</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">TaskService</span> taskService<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token class-name">RabbitMQConfig</span><span class="token punctuation">.</span><span class="token constant">CG_BUYING_FINISHADDPOINT</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveDelTaskMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;订单服务接收到了删除任务操作的消息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">Task</span> task <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token class-name">Task</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//删除原有的任务数据,并向历史任务表中添加记录</span></span>
<span class="line">        taskService<span class="token punctuation">.</span><span class="token function">delTask</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26</p><p>创建taskService写出删除任务的方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TaskService</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">void</span> <span class="token function">delTask</span><span class="token punctuation">(</span><span class="token class-name">Task</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3</p><p>实现taskService</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>order<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>order<span class="token punctuation">.</span>dao<span class="token punctuation">.</span></span><span class="token class-name">TaskHisMapper</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>order<span class="token punctuation">.</span>dao<span class="token punctuation">.</span></span><span class="token class-name">TaskMapper</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>order<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Task</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>order<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">TaskHis</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>order<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">TaskService</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">BeanUtils</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Transactional</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token annotation punctuation">@Service</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TaskServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">TaskService</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">TaskHisMapper</span> taskHisMapper<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">TaskMapper</span> taskMapper<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token annotation punctuation">@Transactional</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delTask</span><span class="token punctuation">(</span><span class="token class-name">Task</span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//1.记录删除时间</span></span>
<span class="line">        task<span class="token punctuation">.</span><span class="token function">setDeleteTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Long</span> taskId <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        task<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//2bean拷贝</span></span>
<span class="line">        <span class="token class-name">TaskHis</span> taskHis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TaskHis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span>taskHis<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//3记录历史任务数据</span></span>
<span class="line">        taskHisMapper<span class="token punctuation">.</span><span class="token function">insertSelective</span><span class="token punctuation">(</span>taskHis<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//4删除原有任务数据</span></span>
<span class="line">        <span class="token comment">//taskMapper.deleteByPrimaryKey(id);</span></span>
<span class="line">        task<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        taskMapper<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;订单服务完成了添加历史任务并删除原有任务的操作&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46</p><h5 id="_2-5效果测试" tabindex="-1"><a class="header-anchor" href="#_2-5效果测试"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-5%E6%95%88%E6%9E%9C%E6%B5%8B%E8%AF%95" target="_blank" rel="noopener noreferrer">#</a>2.5效果测试</span></a></h5><p>order user服务以dubug打开。</p><p>从头到最后一步一步测试。关键点：</p><p>1order下单任务表中数据</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211209031308844.2811c4fc.png" alt="image-20211209031308844"></p><p>2order 定时任务扫描表，发信息</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211209031315436.18d67ccf.png" alt="image-20211209031315436"></p><p>3user收到信息，检查redis,修改积分</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211209031335319.40546e9b.png" alt="image-20211209031335319"></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211209031344811.26114b41.png" alt="image-20211209031344811"></p><p>4order收到成功消息</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211209031259362.016343a5.png" alt="image-20211209031259362"></p><p>总结：</p><p>1分布式事务解决方案</p><p>事务：ACID 面试必问，隔离级别，传播行为</p><p>本地事务：@transactional</p><p>分布式事务</p><p>2解决方案</p><p>2.1xa 2pc mysql</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211208174923396.817f1b12.png" alt="image-20211208174923396"></p><p>2.2 tcc</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211208180127771.c41710b3.png" alt="image-20211208180127771"></p><p>2.3 消息队列</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211208221414338.fafd85a5.png" alt="image-20211208221414338"></p><p>3Seata</p><p>4下单 使用消息队列实现分布式事务</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211209011831937.4975c2d0.png" alt="image-20211209011831937"></p><h2 id="第13章-微信扫码支付" tabindex="-1"><a class="header-anchor" href="#第13章-微信扫码支付"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#%E7%AC%AC13%E7%AB%A0-%E5%BE%AE%E4%BF%A1%E6%89%AB%E7%A0%81%E6%94%AF%E4%BB%98" target="_blank" rel="noopener noreferrer">#</a>第13章 微信扫码支付</span></a></h2><p><strong>角色</strong>： 支付相关模块的开发工程师，难。</p><h2 id="学习目标-1" tabindex="-1"><a class="header-anchor" href="#学习目标-1"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87-1" target="_blank" rel="noopener noreferrer">#</a>学习目标：</span></a></h2><ul><li>能够根据微信支付的开发文档调用微信支付的api</li><li>完成统一下单生成微信支付二维码功能</li><li>完成支付回调的逻辑处理</li><li>完成推送支付通知功能</li></ul><h2 id="_1-微信支付快速入门" tabindex="-1"><a class="header-anchor" href="#_1-微信支付快速入门"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8" target="_blank" rel="noopener noreferrer">#</a>1. 微信支付快速入门</span></a></h2><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPUAAABUCAYAAABa8XEuAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAEnQAABJ0Ad5mH3gAAApBSURBVHhe7Z2/zxTHHYfzt/gfSMo0SZUGJUUi0biIoIpl0yZQ87oGOxWgWERCFEGyBZESFyQNDbL0KpFBMkUsJEtRIuQGLGMKNxee833kYTK7O7OzezfM+3mkr8zdOzv74+bZ78zs3PkHG2NMV1hqYzrDUhvTGZbamM6w1MZ0hqU2pjMstTGdYamN6QxLbUxnWGpjOsNSG9MZltqYzrDUxnSGpTamMyy1MZ1hqY3pDEttTGdYamM6w1Ib0xmW2pjOsNTGdIalNqYzLLUxnWGpjemM11LqT7785+aPn/9p8/tHH2zeun9+8+a9d/4v+NtHX/x1W9aYk8RrIfW/v/nvVmJkfePDHxfHj/78s6381PHVt1/vajWmT5qW+pMv/7GVMSVqTfzu+N1t3cb0SJNSI9zcrFwS7OOzp//a7dWYPmhKarrG7376XlLANYPxt2mTBw8ebB4/frx7ZXJoRmoy5i/+/uukdPsI9s3YfU2eP3++uXz58ubJkye7d17l7t2725iCRn7hwoXN/fv3d+/Mg33duXNn92ocHfvNmzd37+yHU6dObc6fP797tTwXL14c/DxyuHr16vazaIkmpEZoJrNSsu0zOIY1u+MIQSMdEoPGm9OAVQ9ZrIZz585t68lp1Eh9+vTpbeyTNaXmpkj9iDkXjo06WuLgUt/9z72kYIeKtcRGHIQ4c+bMVpAUuVIv0ZA4HupA7Fxo/GyT05tYCva3ltSXLl3a1l/TvbfUEa1k6Dg4pqUffdHNC4VQtg2JpSYTUybOyLxHfTVwHNRz+/bt3TvT6EaADPuC/a0ltW6yNVjqAKRpTegfvjye9z/7w+Jja3XzwsY5V2rVVSJjCjVGRNUYPScQIfV+KsIMWLKPMDjGkn2GMdajWKLrDZY6YI3nz3PjJx//cnN9pYUpNGYaJRGOXedKrS5jWFcpyrjK9trP0hEe91r7GIuhuQtQz6nmOoKl3sFz6JRc+4437729+fCLv+yO6lU4RmbEa8bXjJ01GRVnjblSc3PgvbGYQmPjsN5W4TjDa7IEuqktUa+l3vHTj3+VlGxf8ZuXvYShFWV0vVlxprIsUJlDKHRqDDpHao2DqVdlCe0n3n4Ibgy1Y8l9ofNaEl378JEgPaqHDx8Wh659/H5tD6CGvUt9yNnu3x4fjY6XWYSSGufPGWNLSD50gegSVA0rbAiUJfSaZ8iU0TY0bl7HDUay56CyS4uyFksfqx7NxddL13apGOv6r83epSZLxtKsGZr8Ghsvk7XHeg9Hn763K1kGk1nh4yte84EjlqTOCaRWl/Hs2bO72r4nlfWHIENTNiXKrVu3NtevX6+O4+PjXY31DB3rXHRTi6+XPpPS0PWM39eN+BDsVWrESkmTCkT6+d/mrzBj8ovx8pjMZOCcNeYIvwRqAIiOpHzwOUF5TZDFjRFoRGGPYIiwQQ9Jrb/XRMtS6zMglkAZviX2KnXJBBkgJHKn/j4UY5Nfgnrpaqe2H4rax1wSas4zXmVpRdz9pmHlNHwatLqeqfLPnj1bLHLIGcdyrOGQJBVhb2gM9ZRS3e+5nHip6QanhElFKCbjcLrRqXKKscmvEH44Yc5EHcdQgzJELGQOevxCRua/ZO8QGv3UzULb6r85N4G1kRC1wZAkviYxGkvzOegaLMGJl5qJqpQwqYi7vN91ld9+pQyiT01+CR5N1XydkxvSXJQhQvGePn26uXLlymRcu3Ztuz3b0nCph9chvEdDHYIbSTjjTfkWpA5vNBpqlIakmrpZavjCjLelXpBYyqlIZV4yOPVMTX4Jyizxdc65UksoNV6B1Lw3FUgN1EO24b3w5kAXlvdo4EMo06sM/05JzZj6xo0b1ZE7plb2zJkPSKHtp3opnHd4zjlSc+PMWW1mqQulnvuMWPDzRUstRZ0rtYQiQqlfvHiRHSGxBBqrj40rydBaPQaUH5Jax1oTJRNlEozzKEWLaKaytK6RyuVInTtcstSFUhNzJqjI8Et/N3uO1GpMqUw9l7gRkaXUrR6CTBU2TrZPSf3o0aPFIhduRhw/12jsxhSj7Ju7dju8aeRIrc9uqhdw4qVGjJQwY8GYORduAOFqsCWDteElhGu+1UCWkFoNUl1phJhqeDFsn5L6UEhQvoSRA/IzOca5l9wIRI7UkJOtT7zUjIdTwkxFTrYeWg22VOTMrIeo283EjBptLDVZJv5mURhhdhEaQ7Ot/h0ud8yBbVqSGtSVzrnxSSTd2ErJlTo1wRlz4qVmBjolzFSMdX2RbR9ryUuhwamBDkmtBjEUQw2c7E+mkgil2YpthqTmWFPPgnODG81cdD1SNzOBYJTJ7XanyJWa66qh01C2PvFSAyu9UtKMRepHC757xDX/EVVJ8Ay8himpY4bKCzVsGlxp1xvYdkhq/lYTQ/XmgERMAlJPSmyd95xzDsmVGlR2aJ+W+iWlK8QUytZzVoPVxtQKtSmWllrdbmJqdjYF241JjVgcQ2mM1ZsL56PsKLGR/ejoaJH6oURqjmdsv0Of4SHZu9Rk2JQ4OcGM9r5/LYUFLjnPw8dQg58rNY07lFcNjcY/B7YdaqRjf5uiZtsQTTJSH79gquxdm6FFidTA5zGEpd5RsrLs0DH3+XTIkNQ01pSYYXl1OcMx5NCz71zYrmWpIeyKzz3PIUqlHsNS7yBbT63lbiEY/y9BSmoaLe+Fi0KEyitbhRlKM7JIToOiTOnkFNu3LDXXhgxNfQqeBswZaqSw1CvBc9+USC1F6WOsIVJS06XmvXgdN0hcIhRaY2k9n9VrMhqvc2GbFqXmHLhGuplRF+coCQn+XXKuKSz1iuz7BxNKYolut4ilplHySIrGm2qgKh/OAIfjzDAz6wbARFIulG9Jas6HzKzz46YVz35TRgJRrkbuJaXWApWWOKjUTEDV/BDCWlGyii2HUGoaosaKkjxFKG4odNzYQeNuxMiBsmNSc3ypZ9BTMVZvDF1pfq4pHDenZI5hoY1EIjhnrm8JS0mtejiHljio1NCa2EsLDXGmplHmzuTS+MeEhvBGkbMog3JjUtfEmNQIiYT0UuJtpmSOoS62Ux3UyTfawpvhEDVSc30Z34fnULqib20OLjUg9pwveywdc3+LbIpY6tIJH4SdavSInZPpgGMZko9jrImx/es6EJwT5Wsnv9ieIUiY8acyN/ul3BzCGwn/bk1oaEJqcahHXczE1y4wGYOGR0Mq7SaK3LFjriBT8q0JEtSKPAT15kjG58A16JWmpIaUdGsGk3U5Xxgx5nWhKanphqfEWyPo7i/1yMqYlmhK6rV/6F+/abbG/6rWmFZoSurUlz30+91kVaSnTMmkGmXZpvbXQI15XWhK6vh70SwAGfsyBWNhZE+Fx8nmpNKM1OF4muxqKY2ZR1OZmplod5ONqaMpqY0x9VhqYzrDUhvTGZbamM6w1MZ0hqU2pjMstTGdYamN6QxLbUxnWGpjOsNSG9MZltqYzrDUxnSGpTamMyy1MZ1hqY3pDEttTFdsNv8DLp6z9A0FTv8AAAAASUVORK5CYII=" alt="img"></p><p>native 支付文档：https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=6_1</p><h3 id="_1-1-微信支付申请-了解" tabindex="-1"><a class="header-anchor" href="#_1-1-微信支付申请-了解"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-1-%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E7%94%B3%E8%AF%B7-%E4%BA%86%E8%A7%A3" target="_blank" rel="noopener noreferrer">#</a>1.1 微信支付申请（了解）</span></a></h3><p><strong>第一步：注册公众号（类型须为：服务号）</strong></p><p>请根据营业执照类型选择以下主体注册：<a href="http://kf.qq.com/faq/120911VrYVrA151009JB3i2Q.html" target="_blank" rel="noopener noreferrer">个体工商户open in new window</a>| <a href="http://kf.qq.com/faq/120911VrYVrA151013MfYvYV.html" target="_blank" rel="noopener noreferrer">企业/公司open in new window</a>| <a href="http://kf.qq.com/faq/161220eaAJjE161220IJn6zU.html" target="_blank" rel="noopener noreferrer">政府open in new window</a>| <a href="http://kf.qq.com/faq/161220IFBJFv161220YnqAbQ.html" target="_blank" rel="noopener noreferrer">媒体open in new window</a>| <a href="http://kf.qq.com/faq/120911VrYVrA151013nYFZ7Z.html" target="_blank" rel="noopener noreferrer">其他类型open in new window</a>。</p><p><strong>第二步：认证公众号</strong></p><p>公众号认证后才可申请微信支付，认证费：<strong>300元/次</strong>。</p><p><strong>第三步：提交资料申请微信支付</strong></p><p>登录公众平台，点击左侧菜单【微信支付】，开始填写资料等待审核，审核时间为1-5个工作日内。</p><p><strong>第四步：开户成功，登录商户平台进行验证</strong></p><p>资料审核通过后，请登录联系人邮箱查收商户号和密码，并登录商户平台填写财付通备付金打的小额资金数额，完成账户验证。</p><p><strong>第五步：在线签署协议</strong></p><p>本协议为线上电子协议，签署后方可进行交易及资金结算，签署完立即生效。</p><p>本课程已经提供好“元动力教育”的微信支付账号，学员无需申请。</p><p>完成上述步骤，你可以得到调用API用到的账号和密钥</p><p><strong>！！！！真实地测试，所以，我们写的接口，钱都会给我们元动力。钱一定设置成1分钱。</strong></p><p><strong>appid</strong>：微信公众账号或开放平台APP的唯一标识 wxababcd122d1618eb</p><p><strong>mch_id</strong>：商户号 1611671554</p><p><strong>key</strong>：商户密钥 ydlclass66666688888YDLCLASS66688</p><h3 id="_1-2-微信支付开发文档与sdk" tabindex="-1"><a class="header-anchor" href="#_1-2-微信支付开发文档与sdk"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-2-%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3%E4%B8%8Esdk" target="_blank" rel="noopener noreferrer">#</a>1.2 微信支付开发文档与SDK</span></a></h3><p>在线微信支付开发文档：</p><p>https://pay.weixin.qq.com/wiki/doc/api/index.html</p><p>https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=9_1</p><p>微信支付接口调用的整体思路：</p><p>按API要求组装参数，以XML方式发送（POST）给微信支付接口（URL）,微信支付接口也是以XML方式给予响应。程序根据返回的结果（其中包括支付URL）生成二维码或判断订单状态。</p><p>我们解压从官网下载的sdk ,安装到本地仓库</p><p>com.github.wxpay.sdk.WXPay类下提供了对应的方法：</p><table><thead><tr><th>方法名</th><th>说明</th></tr></thead><tbody><tr><td>microPay</td><td>刷卡支付</td></tr><tr><td>unifiedOrder</td><td>统一下单</td></tr><tr><td>orderQuery</td><td>查询订单</td></tr><tr><td>reverse</td><td>撤销订单</td></tr><tr><td>closeOrder</td><td>关闭订单</td></tr><tr><td>refund</td><td>申请退款</td></tr><tr><td>refundQuery</td><td>查询退款</td></tr><tr><td>downloadBill</td><td>下载对账单</td></tr><tr><td>report</td><td>交易保障</td></tr><tr><td>shortUrl</td><td>转换短链接</td></tr><tr><td>authCodeToOpenid</td><td>授权码查询openid</td></tr></tbody></table><p><strong>测试工程</strong></p><p>1创建test_pay ,导入依赖。<strong>将我的仓库com.github.wxpay相关包发给学生。</strong></p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.github.wxpay<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>wxpay-sdk<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.0.9<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>commons-logging<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-logging<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12</p><p>2创建配置类 <strong>注意</strong>：包名必须为com.github.wxpay.sdk</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>wxpay<span class="token punctuation">.</span>sdk</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">InputStream</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WXPayConfig</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//正式</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getAppID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">&quot;wxababcd122d1618eb&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMchID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">&quot;1611671554&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//测试</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">&quot;ydlclass66666688888YDLCLASS66688&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">//正式</span></span>
<span class="line">    <span class="token comment">//public String getKey() {</span></span>
<span class="line">    <span class="token comment">//    return &quot;0c804332f41cbf77b014d7096ae900f6&quot;;</span></span>
<span class="line">    <span class="token comment">//}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">InputStream</span> <span class="token function">getCertStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">IWXPayDomain</span> <span class="token function">getWXPayDomain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">IWXPayDomain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">report</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">,</span> <span class="token keyword">long</span> l<span class="token punctuation">,</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">            <span class="token keyword">public</span> <span class="token class-name">DomainInfo</span> <span class="token function">getDomain</span><span class="token punctuation">(</span><span class="token class-name">WXPayConfig</span> wxPayConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DomainInfo</span><span class="token punctuation">(</span><span class="token string">&quot;api.mch.weixin.qq.com&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39</p><p>3测试类 包名随意</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">ydles<span class="token punctuation">.</span>test</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>wxpay<span class="token punctuation">.</span>sdk<span class="token punctuation">.</span></span><span class="token class-name">MyConfig</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>wxpay<span class="token punctuation">.</span>sdk<span class="token punctuation">.</span></span><span class="token class-name">WXPay</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * creste by ydles.itcast</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PayTest</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">MyConfig</span> myConfig<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">MyConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">WXPay</span> wxPay<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">WXPay</span><span class="token punctuation">(</span>myConfig<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//根据官方文档 必填值封装数据</span></span>
<span class="line">        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;body&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;元动力二奢&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;out_trade_no&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;123654&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;total_fee&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;spbill_create_ip&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;notify_url&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;http://www.baidu.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;trade_type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;NATIVE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> resultMap <span class="token operator">=</span> wxPay<span class="token punctuation">.</span><span class="token function">unifiedOrder</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>resultMap<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30</p><p>4得到</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">{nonce_str=l1pTBT12JvPIN0lO, code_url=weixin://wxpay/bizpayurl?pr=PFNjrIXzz, appid=wxababcd122d1618eb, sign=FF218956CA8C00145F4BACBC0AA843012E2DE2498FAAD4809769EB367582340A, trade_type=NATIVE, return_msg=OK, result_code=SUCCESS, mch_id=1611671554, return_code=SUCCESS, prepay_id=wx15174918803690023343d15a9737140000}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p><strong>QRcode</strong></p><p>1打开资源文件夹 weixinpay.html</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211215175333830.b1e5218d.png" alt="image-20211215175333830"></p><p>支付图片为qrcode.js生成。修改源代码为本人生成的，即可微信扫描。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">222 qrcode.makeCode(&quot;weixin://wxpay/bizpayurl?pr=PFNjrIXzz&quot;);</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211215175246842.329dfb39.png" alt="image-20211215175246842"></p><h2 id="_2-微信支付二维码" tabindex="-1"><a class="header-anchor" href="#_2-微信支付二维码"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E4%BA%8C%E7%BB%B4%E7%A0%81" target="_blank" rel="noopener noreferrer">#</a>2. 微信支付二维码</span></a></h2><h3 id="_2-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_2-1-需求分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>2.1 需求分析</span></a></h3><p>用户在提交订单后，如果是选择支付方式为微信支付，那应该跳转到微信支付二维码页面，用户扫描二维码可以进行支付，金额与订单金额相同。</p><p><strong>流程：商品详情页-----》购物车-----》订单----》支付方式pay.html------》微信支付页weixinpay.html--------》支付成功</strong></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211221110506739.ccd04c86.png" alt="image-20211221110506739"></p><h3 id="_2-2-实现思路" tabindex="-1"><a class="header-anchor" href="#_2-2-实现思路"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-2-%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF" target="_blank" rel="noopener noreferrer">#</a>2.2 实现思路</span></a></h3><p>前端页面向后端传递订单号，后端根据订单号查询订单，检查是否为当前用户的未支付订单，如果是则根据订单号和金额生成支付url返给前端，前端得到支付url生成支付二维码。</p><h3 id="_2-3-代码实现" tabindex="-1"><a class="header-anchor" href="#_2-3-代码实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-3-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>2.3 代码实现</span></a></h3><h4 id="_2-3-1-提交订单跳转支付页" tabindex="-1"><a class="header-anchor" href="#_2-3-1-提交订单跳转支付页"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-3-1-%E6%8F%90%E4%BA%A4%E8%AE%A2%E5%8D%95%E8%B7%B3%E8%BD%AC%E6%94%AF%E4%BB%98%E9%A1%B5" target="_blank" rel="noopener noreferrer">#</a>2.3.1 提交订单跳转支付页</span></a></h4><p><strong>订单----》支付方式pay.html</strong></p><p>1更新ydles_service_order</p><p>OrderServiceImpl中add() ,设置返回值为订单Id</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">public String add(Order order) </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">//最后返回</span>
<span class="line">return order.getId();</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><p>OrderService</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">String add(Order order);</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>OrderController</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">String orderId = orderService.add(order);</span>
<span class="line">return new Result(true,StatusCode.OK,&quot;添加成功&quot;,orderId);</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><p>2修改web-order中提交订单页面，下单成功跳转至选择支付页面。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line"> 					if (response.data.flag){</span>
<span class="line">                        //添加订单成功</span>
<span class="line">                        alert(&quot;添加订单成功&quot;);</span>
<span class="line">                        var orderId = response.data.data;</span>
<span class="line">                        location.href=&quot;/api/worder/toPayPage?orderId=&quot;+orderId;</span>
<span class="line">                    } else{</span>
<span class="line">                        alert(&quot;添加订单失败&quot;);</span>
<span class="line">                    }</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8</p><p>3在OrderController中新增方法，用于跳转支付页</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/toPayPage&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toPayPage</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">,</span><span class="token class-name">Model</span> model<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//获取到订单的相关信息</span></span>
<span class="line">        <span class="token class-name">Order</span> order <span class="token operator">=</span> orderFeign<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;orderId&quot;</span><span class="token punctuation">,</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;payMoney&quot;</span><span class="token punctuation">,</span>order<span class="token punctuation">.</span><span class="token function">getPayMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">&quot;pay&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8</p><p>4order服务中已经有方法：orderController中 根据订单id查询订单信息 findById</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/***</span>
<span class="line">     * 根据ID查询数据</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">id</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/{id}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Order</span> order <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span><span class="token string">&quot;查询成功&quot;</span><span class="token punctuation">,</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10</p><p>把它暴露出去 OrderFeign</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderFeign</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/order&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Order</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/order/{id}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10</p><p>5相关页面放至resources</p><p>6测试</p><p>登陆 http://localhost:8001/api/oauth/toLogin</p><p>添加商品： http://localhost:8001/api/wcart/add?skuId=1450862568724758528&amp;num=5</p><p>查看购物车： http://localhost:8001/api/wcart/list</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211221114601627.e567585a.png" alt="image-20211221114601627"></p><p>点击结算</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211221114628720.ea35e002.png" alt="image-20211221114628720"></p><p>点击提交订单，跳转至支付页面</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211221114637493.2fe67dc8.png" alt="image-20211221114637493"></p><h4 id="_2-3-2-支付微服务权限集成" tabindex="-1"><a class="header-anchor" href="#_2-3-2-支付微服务权限集成"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-3-2-%E6%94%AF%E4%BB%98%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9D%83%E9%99%90%E9%9B%86%E6%88%90" target="_blank" rel="noopener noreferrer">#</a>2.3.2 支付微服务权限集成</span></a></h4><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211221144256113.660d33ae.png" alt="image-20211221144256113"></p><p>1service二级目录下，新建微服务ydles_service_pay</p><p>2依赖</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ydles_common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.github.wxpay<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>wxpay-sdk<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.0.9<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-logging<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26</p><p>3配置文件 application.yml</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">server</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9010</span></span>
<span class="line"><span class="token key atrule">spring</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">application</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> pay</span>
<span class="line">  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.200.128</span>
<span class="line">  <span class="token key atrule">main</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">allow-bean-definition-overriding</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment">#当遇到同样名字的时候，是否允许覆盖注册</span></span>
<span class="line"><span class="token key atrule">eureka</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">client</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">service-url</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>6868/eureka</span>
<span class="line">  <span class="token key atrule">instance</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line"><span class="token key atrule">wxpay</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">notify_url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//itlils.cross.echosite.cn/wxpay/notify <span class="token comment">#回调地址</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17</p><p>4微信支付配置类，copy。注意包名</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>wxpay<span class="token punctuation">.</span>sdk</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">InputStream</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * @Created by IT李老师</span>
<span class="line"> * 公主号 “IT李哥交朋友”</span>
<span class="line"> * 个人微 itlils</span>
<span class="line"> *  微信支付配置类，放着商户的相关信息</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WXPayConfig</span><span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token class-name">String</span> <span class="token function">getAppID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">&quot;wxababcd122d1618eb&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token class-name">String</span> <span class="token function">getMchID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">&quot;1611671554&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token class-name">String</span> <span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">&quot;ydlclass66666688888YDLCLASS66688&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token class-name">InputStream</span> <span class="token function">getCertStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token class-name">IWXPayDomain</span> <span class="token function">getWXPayDomain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">IWXPayDomain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token annotation punctuation">@Override</span></span>
<span class="line">            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">report</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">,</span> <span class="token keyword">long</span> l<span class="token punctuation">,</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">            <span class="token annotation punctuation">@Override</span></span>
<span class="line">            <span class="token keyword">public</span> <span class="token class-name">DomainInfo</span> <span class="token function">getDomain</span><span class="token punctuation">(</span><span class="token class-name">WXPayConfig</span> wxPayConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DomainInfo</span><span class="token punctuation">(</span><span class="token string">&quot;api.mch.weixin.qq.com&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48</p><p>5启动类 com.ydles.pay下</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>pay</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>wxpay<span class="token punctuation">.</span>sdk<span class="token punctuation">.</span></span><span class="token class-name">MyConfig</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>wxpay<span class="token punctuation">.</span>sdk<span class="token punctuation">.</span></span><span class="token class-name">WXPay</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">SpringApplication</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">SpringBootApplication</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>eureka<span class="token punctuation">.</span></span><span class="token class-name">EnableEurekaClient</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token annotation punctuation">@SpringBootApplication</span></span>
<span class="line"><span class="token annotation punctuation">@EnableEurekaClient</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PayApplication</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">PayApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Bean</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">WXPay</span> <span class="token function">wxPay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WXPay</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span>  <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26</p><h4 id="_2-3-3-支付微服务-下单" tabindex="-1"><a class="header-anchor" href="#_2-3-3-支付微服务-下单"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-3-3-%E6%94%AF%E4%BB%98%E5%BE%AE%E6%9C%8D%E5%8A%A1-%E4%B8%8B%E5%8D%95" target="_blank" rel="noopener noreferrer">#</a>2.3.3 支付微服务-下单</span></a></h4><p>ydles_service_pay服务</p><p>（1）创建com.ydles.pay.service包，包下创建接口WxPayService</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * @Created by IT李老师</span>
<span class="line"> * 公主号 “IT李哥交朋友”</span>
<span class="line"> * 个人微 itlils</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">WxPayService</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//微信下单要二维码</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Map</span> <span class="token function">nativePay</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">,</span><span class="token class-name">Integer</span> money<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14</p><p>（2）创建com.ydles.pay.service.impl 包 ,新增服务类WxPayServiceImpl 拓展：涉及钱的计算，注意用BigDecimal https://www.cnblogs.com/zhangyinhua/p/11545305.html</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>wxpay<span class="token punctuation">.</span>sdk<span class="token punctuation">.</span></span><span class="token class-name">MyConfig</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>wxpay<span class="token punctuation">.</span>sdk<span class="token punctuation">.</span></span><span class="token class-name">WXPay</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">WxPayService</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">BigDecimal</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * @Created by IT李老师</span>
<span class="line"> * 公主号 “IT李哥交朋友”</span>
<span class="line"> * 个人微 itlils</span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@Service</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WxPayServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">WxPayService</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">WXPay</span> wxPay<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Map</span> <span class="token function">nativePay</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> money<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//根据官方文档 请求接口</span></span>
<span class="line">            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> reqData<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            reqData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;body&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;动力二奢下单支付&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            reqData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;out_trade_no&quot;</span><span class="token punctuation">,</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">//金钱计算 BigDecimal:金额和计算都用他的</span></span>
<span class="line">            <span class="token class-name">BigDecimal</span> yuan<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;0.01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">BigDecimal</span> beishu<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">BigDecimal</span> fen <span class="token operator">=</span> yuan<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>beishu<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            fen<span class="token operator">=</span>fen<span class="token punctuation">.</span><span class="token function">setScale</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ROUND_UP</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            reqData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;total_fee&quot;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>fen<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            reqData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;spbill_create_ip&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;192.168.1.1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            reqData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;notify_url&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;http://www.baidu.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            reqData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;trade_type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;NATIVE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> resultMap <span class="token operator">=</span> wxPay<span class="token punctuation">.</span><span class="token function">unifiedOrder</span><span class="token punctuation">(</span>reqData<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>resultMap<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> resultMap<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52</p><p>（3）创建com.ydles.pay.controller包 ，新增WxPayController</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">Result</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">StatusCode</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">WxPayService</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestParam</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * @Created by IT李老师</span>
<span class="line"> * 公主号 “IT李哥交朋友”</span>
<span class="line"> * 个人微 itlils</span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@RestController</span></span>
<span class="line"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/wxpay&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WxPayController</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">WxPayService</span> wxPayService<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//微信下单</span></span>
<span class="line">    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/nativePay&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&gt;</span></span> <span class="token function">nativePay</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;orderId&quot;</span><span class="token punctuation">)</span><span class="token class-name">String</span> orderId<span class="token punctuation">,</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;money&quot;</span><span class="token punctuation">)</span><span class="token class-name">Integer</span> money<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Map</span> map <span class="token operator">=</span> wxPayService<span class="token punctuation">.</span><span class="token function">nativePay</span><span class="token punctuation">(</span>orderId<span class="token punctuation">,</span> money<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span><span class="token string">&quot;微信下单成功&quot;</span><span class="token punctuation">,</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32</p><p>测试：http://localhost:9010/wxpay/nativePay?orderId=123321&amp;money=1 订单号可能重复，大家换一下就好了。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211221150107575.b9d3c8e2.png" alt="image-20211221150107575"></p><h4 id="_2-3-3-支付渲染页面微服务" tabindex="-1"><a class="header-anchor" href="#_2-3-3-支付渲染页面微服务"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-3-3-%E6%94%AF%E4%BB%98%E6%B8%B2%E6%9F%93%E9%A1%B5%E9%9D%A2%E5%BE%AE%E6%9C%8D%E5%8A%A1" target="_blank" rel="noopener noreferrer">#</a>2.3.3 支付渲染页面微服务</span></a></h4><p><strong>支付方式pay.html------》微信支付页weixinpay.html</strong></p><p>页面需要调用我们的微服务，所以：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211221151905932.8bd5dc61.png" alt="image-20211221151905932"></p><p>（1）新增ydles_service_pay_api模块 ，pom.xml中加入依赖</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ydles_common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><p>新增com.ydles.pay.feign包，包下创建接口</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>feign</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">Result</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestParam</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;pay&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PayFeign</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/wxpay/nativePay&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">nativePay</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;orderId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> orderId<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;money&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> money<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16</p><p>（2）ydles_web_order的pom.xml加入依赖</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ydles_service_pay_api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p>启动类增加扫包</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">@EnableFeignClients(basePackages = {&quot;com.ydles.pay.feign&quot;,&quot;com.ydles.order.feign&quot;,&quot;com.ydles.user.feign&quot;})</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211221152256881.fd55b30b.png" alt="image-20211221152256881"></p><p>ydles_web_order新增PayController</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>order<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>feign<span class="token punctuation">.</span></span><span class="token class-name">WxPayFeign</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Controller</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>ui<span class="token punctuation">.</span></span><span class="token class-name">Model</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token annotation punctuation">@Controller</span></span>
<span class="line"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/wxpay&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PayController</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">OrderFeign</span> orderFeign<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">PayFeign</span> payFeign<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//跳转到微信支付二维码页面</span></span>
<span class="line">    <span class="token annotation punctuation">@GetMapping</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">wxPay</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId <span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//1.根据orderid查询订单,如果订单不存在,跳转到错误页面</span></span>
<span class="line">        <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> orderResult <span class="token operator">=</span> orderFeign<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>orderResult<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token string">&quot;fail&quot;</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//2.根据订单的支付状态进行判断,如果不是未支付的订单,跳转到错误页面</span></span>
<span class="line">        <span class="token class-name">Order</span> order <span class="token operator">=</span> orderResult<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getPayStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token string">&quot;fail&quot;</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//3.基于payFeign调用统计下单接口,并获取返回结果</span></span>
<span class="line">        <span class="token class-name">Result</span> payResult <span class="token operator">=</span> payFeign<span class="token punctuation">.</span><span class="token function">nativePay</span><span class="token punctuation">(</span>orderId<span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getPayMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>payResult<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token string">&quot;fail&quot;</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//4.封装结果数据</span></span>
<span class="line">        <span class="token class-name">Map</span> payMap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span> payResult<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        payMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;orderId&quot;</span><span class="token punctuation">,</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        payMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;payMoney&quot;</span><span class="token punctuation">,</span>order<span class="token punctuation">.</span><span class="token function">getPayMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        model<span class="token punctuation">.</span><span class="token function">addAllAttributes</span><span class="token punctuation">(</span>payMap<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">&quot;wxpay&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50</p><p>（4）将静态原型中wxpay.html拷贝到templates文件夹下作为模板，修改模板，部分代码如下：</p><p>二维码地址渲染</p><div class="language-html line-numbers-mode" data-highlighter="prismjs" data-ext="html" data-title="html"><pre><code><span class="line">222 qrcode.makeCode([[${code_url}]]);</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>查看显示订单号与金额</p><div class="language-html line-numbers-mode" data-highlighter="prismjs" data-ext="html" data-title="html"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h4</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fl tit-txt<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>success-icon<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span>  <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>success-info<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>|订单提交成功，请您及时付款！订单号：${orderId}|<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h4</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fr<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>em</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sui-lead<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>应付金额：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>em</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>em</span>  <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>orange money<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${#numbers.formatDecimal(payMoney/100.0,1,2)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>em</span><span class="token punctuation">&gt;</span></span>元<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><p>pay.html</p><div class="language-html line-numbers-mode" data-highlighter="prismjs" data-ext="html" data-title="html"><pre><code><span class="line">109 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>|/api/wxpay?orderId=${orderId}|<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/./image/_/pay3.jpg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211221154450109.3f3ae6ab.png" alt="image-20211221154450109"></p><p>ydles_gateway_web项目的application.yml文件加入</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token comment">#购物车订单渲染微服务</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> ydles_order_web_route</span>
<span class="line">          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//order<span class="token punctuation">-</span>web</span>
<span class="line">          <span class="token key atrule">predicates</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> Path=/api/wcart/<span class="token important">**</span><span class="token punctuation">,</span>/api/worder/<span class="token important">**</span><span class="token punctuation">,</span>/api/wxpay/<span class="token important">**</span></span>
<span class="line">          <span class="token key atrule">filters</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> StripPrefix=1</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><p>查看ydles_gateway_web项目的UrlFilter.java中</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> orderFilterPath <span class="token operator">=</span> &quot;<span class="token operator">/</span>api<span class="token operator">/</span>wpay<span class="token punctuation">,</span><span class="token operator">/</span>api<span class="token operator">/</span>wpay<span class="token doc-comment comment">/**,/api/worder/**,/api/user/**,</span>
<span class="line"></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p><strong>测试</strong></p><p>1重启gatewaty-web service-pay web-order</p><p>2添加商品： http://localhost:8001/api/wcart/add?skuId=1450862568724758528&amp;num=5</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211221162207178.7d37ab54.png" alt="image-20211221162207178"></p><p>3查看购物车： http://localhost:8001/api/wcart/list</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211221162214876.3626ccaa.png" alt="image-20211221162214876"></p><p>4点击：结算---》提交订单--》选择微信支付--》跳到二维码页面--》扫描二维码，你将损失1分钱。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211221200858087.5edd9c41.png" alt="image-20211221200858087"></p><h2 id="_3-支付回调逻辑处理" tabindex="-1"><a class="header-anchor" href="#_3-支付回调逻辑处理"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-%E6%94%AF%E4%BB%98%E5%9B%9E%E8%B0%83%E9%80%BB%E8%BE%91%E5%A4%84%E7%90%86" target="_blank" rel="noopener noreferrer">#</a>3. 支付回调逻辑处理</span></a></h2><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211221203416360.5ddbce4d.png" alt="image-20211221203416360"></p><h3 id="_3-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_3-1-需求分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>3.1 需求分析</span></a></h3><p>在完成支付后，修改订单状态为已支付，并记录订单日志。</p><h3 id="_3-2-实现思路" tabindex="-1"><a class="header-anchor" href="#_3-2-实现思路"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-2-%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF" target="_blank" rel="noopener noreferrer">#</a>3.2 实现思路</span></a></h3><p>（1）接受微信支付平台的回调信息（xml）</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xml</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appid</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[wx8397f8696b538317]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appid</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bank_type</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[CFT]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bank_type</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>cash_fee</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[1]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>cash_fee</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>fee_type</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[CNY]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>fee_type</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>is_subscribe</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[N]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>is_subscribe</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mch_id</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[1473426802]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mch_id</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nonce_str</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[c6bea293399a40e0a873df51e667f45a]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nonce_str</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>openid</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[oNpSGwbtNBQROpN_dL8WUZG3wRkM]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>openid</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>out_trade_no</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[1553063775279]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>out_trade_no</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result_code</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[SUCCESS]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>result_code</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>return_code</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[SUCCESS]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>return_code</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>sign</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[DD4E5DF5AF8D8D8061B0B8BF210127DE]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>sign</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>time_end</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[20190320143646]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>time_end</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>total_fee</span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>total_fee</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>trade_type</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[NATIVE]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>trade_type</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>transaction_id</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[4200000248201903206581106357]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>transaction_id</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xml</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17</p><p>（2）收到通知后，调用查询接口查询订单。</p><p>（3）如果支付结果为成功，则调用修改订单状态和记录订单日志的方法。</p><h3 id="_3-3-代码实现" tabindex="-1"><a class="header-anchor" href="#_3-3-代码实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-3-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>3.3 代码实现</span></a></h3><h4 id="_3-3-1-内网穿透工具" tabindex="-1"><a class="header-anchor" href="#_3-3-1-内网穿透工具"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-3-1-%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E5%B7%A5%E5%85%B7" target="_blank" rel="noopener noreferrer">#</a>3.3.1 内网穿透工具</span></a></h4><p>natapp https://natapp.cn/</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211221204125489.5f8703f8.png" alt="image-20211221204125489"></p><h4 id="_3-3-2下载配置文件和客户端" tabindex="-1"><a class="header-anchor" href="#_3-3-2下载配置文件和客户端"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-3-2%E4%B8%8B%E8%BD%BD%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%92%8C%E5%AE%A2%E6%88%B7%E7%AB%AF" target="_blank" rel="noopener noreferrer">#</a>3.3.2下载配置文件和客户端</span></a></h4><p>如何使用：https://natapp.cn/article/natapp_newbie</p><p>解压资料，将配置文件与程序平行放置。修改配置文件。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAA4CAYAAABUv9KRAAAHgElEQVR4nO3cXWxT5xnA8f9JUoyauJQSLmg2aQW7QEfHEBUT9roLGEgOahZ1HZqmoSgX2BqTGksbC632EXV0IqPTbC4yxbmIGJ2moRYxpNmbAkjbmlSbSKdUFNBsIjaRhIRApuarcey8uzi2ExMbH8d2CEfPTzoi55z347Hy+M1zjo/RlFIKIUyi7FEHIEQxSUILU5GEFqYiCS1MRRJamIoktDCVikwHByeWOwwhikNWaGEqktDCVDKWHNmcOvEzPun7KLU/NzdHPB5HKUVZWRnl5eVomgbA1he/jPfNnxc3WiFyMJTQU1OTbHhqFZ/0fcT+/fuprq5menqa0eHblE/dZo0lxt3YetY9uwmr1crIyAgXL15kTcUsQ59GefLJylK/DiEAgyXH8NAglauf0DuUlTE6OsrN8A2eL79Kw0tR9m+O8c3NwwwODnL//n0qKvT3SeXqJxgeGixd9ItE6NirUWPVaG7zU2d10tGf5xD9BvsZbSeWlaEV+t7oXcAOwNDQELFYjOjYf6n/Whkdlwfo/vckT69dS6yqilgstqjvc5vsRQ88k1ttDbR8McjAJZeecM3LMq1YQQwl9Gw0mvr5zp07zM3NMTv5Gb4Lo7y2w8Ke51bzx74xum+XMTk5SXl5eca+pdZ/o4edWxJvno1NXBhvyn8Qo/2WOr4oqbwuCgGGh4dRSjEzM8Pvb83yr5tjbFkX542vVzL65/9wZWAGi8VSiliFyGlJt+2UUqwpn+b7L45RHpvm7tg0fHqXVXOf5TFKiGarXu/WWDXq2iIZj9dYPVxO6+Oko82zqN/l1zUOdUJvs13v0++nblHf5JiJMfb6ufVgWGn9ss/HovHFSrCkhNY0jZl4GfHpaX7tGOWH2/9H24cx/nZ3feqC8OFCNFtrud4aZmBcMTCuuHDElvH4wDk4lJY4PbTcqNfP9fmguYGOfthzSnGmEXa2hhkYb2dPhvk4lxhz/DS8HzD4ajPPJ1amvBK6pqYG0BM6VlHJbwdtuC5v41sfbOO90S2srlqTqp+TbTPqOs+7u3ycOmLLfXzfUVp2BfhLV/KAgxavS/9x4wFe2WUg8MS439uXPGDj8DG3gY5LnE88MnnV0Nu2bWP37t2G2o6NjS0poMwc2DYVcThhWnkl9JUrV5iammJkZITZ2dms7axWK1VVVXi93swN9tXz3Vdr+U1XE637AEJ0tNk5fEQ//nrbgUQJAnSdpIWDdG/MJ9Jc80XoOBEAfPr5fj9128/ySl83hwuYRjx6hhN6Jg4bNmygt7eXiYmJRfebH7R161Zm4tnOumjt81G3XUMvTNycGW8HbLSOB2m22qlJ3UN2c2a8iS8YDdTQfA5aWt3wfkGDihVIy/St7wcfH/3nhx+wrno9L+/YnNfgf+29ztj9e+za/dWCgiyJLg81J16g+1Khbxaxkhhaodc+s45zf/gdPzn6D6IGPyixWCzseOkrfOO1bxcUYHFE6Nh7kk2Xknc/QjS/GmBna1iS2WQMrdATE+MMDdxm7P494jlKjaTyigrWPrOOZz/3eSorq4oSbEH6/dRt99Kb2N3ZGp6v04VpGEpoIR4X8oC/MBVJaGEqGS8K372+3GEIURwZE/ppC7i/tNyhCFE4KTmEqUhCC1Mx9MHKL375q4ImefNHPyiovxBGlWSFftnpSPtXiOVi+OGkxkPfyWtg20b9Q+W/d/fkF5EQBcj7O4UA1dXVxY7DoAh+p51rP1a0ux5RCGJFW1JCA6z66c20/ehbm+js7Ew71tjYuNThhViSgmropyxlWCq01H5jY2Pall0Ij+bE7/egaRqapuH0R+ZPR/w4E8c1TcMTSvax4+2BQK2G5vQTydoW9NVcwxMK4VnS+Uwxa4vijfidaJqHZLeQR0NLDZK5jyidghJ6Jq6Ixuefbers7EzbHq4H77V6lFKosA+8Dei/7wj+k3BaKf1c0E2g1kMIF+0qjM8B7qBCdTdhy9p2XqD2PPUFnNeF8GjHeSGcaKfCHDxrxxMCW1M3QXeA4/4IhDzUXvURbnc9tI8oIZVBe1/6/tut76jBwcHUFo1GFceuK+2N64pj+haNRjNub7e+k2GGoHLjUL5wcj+sfI6F+0qFfQ4FJDa3CqbaodzB9NGMt114LNf5heG6F4w/vzlSAQeVGxQLX1POPqIUClqhH3zw1Pjq/BCJEqKB06nVO+vNv3zaFsrhI5xcyRNbd1OO56mX0kcUpKj3oY3VzzmEr9Hj8HE68YuP/OksWW/8GWgbOD//Nz7ib8Db46beZeB8xI9Tc+plkKsed4+XkwvKhZBnYd1cy1VfGL1yStT2OfqI0ljyXY7oWyX6fwVcR/Edt2PX9G+MO9zuBauujQMHHXhrNQIOH+Huh7XVuTmPptWm9oKqHVce5xNB0R724bRrJC+B3UFFO/pFoF4327BxGt9ZO3bP86j27H1E6WT8xkrg4/Sn7R7Pj75z3bOWe9pmZGiFlmcxxONCnrYTpmKo5BDicSErtDAVSWhhKlkvCgMfL2cYQhRHxhpaiMeVlBzCVCShhalIQgtTkYQWpiIJLUzl/x4cl3YeZRvGAAAAAElFTkSuQmCC" alt="image-20211221205259145"></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211221205320127.d3014723.png" alt="image-20211221205320127"></p><h4 id="_3-3-3-启动" tabindex="-1"><a class="header-anchor" href="#_3-3-3-启动"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-3-3-%E5%90%AF%E5%8A%A8" target="_blank" rel="noopener noreferrer">#</a><strong>3.3.3 启动</strong></span></a></h4><p>双击natapp.exe</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211221205424476.a7e3fbf7.png" alt="image-20211221205424476"></p><p>外网地址默认映射本地的80端口 可以修改</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211221205450080.c69f4636.png" alt="image-20211221205450080"></p><h4 id="_3-3-4-测试" tabindex="-1"><a class="header-anchor" href="#_3-3-4-测试"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-3-4-%E6%B5%8B%E8%AF%95" target="_blank" rel="noopener noreferrer">#</a><strong>3.3.4 测试</strong></span></a></h4><p>1ydles_service_pay 微服务 WXPayController 增加一个测试方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/notify&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notifyLogic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;支付成功回调&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p>2重启ydles_service_pay</p><p>3访问 http://localhost:9010/wxpay/notify 程序打印输出</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211221205220246.f5d79981.png" alt="image-20211221205220246"></p><p>4访问 http://lizihao.cross.echosite.cn/wxpay/notify 程序打印输出</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211221205220246.f5d79981.png" alt="image-20211221205221905"></p><h4 id="_3-3-5-接收回调信息" tabindex="-1"><a class="header-anchor" href="#_3-3-5-接收回调信息"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-3-5-%E6%8E%A5%E6%94%B6%E5%9B%9E%E8%B0%83%E4%BF%A1%E6%81%AF" target="_blank" rel="noopener noreferrer">#</a>3.3.5 接收回调信息</span></a></h4><p>1 修改支付微服务配置文件</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">wxpay</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">notify_url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//mp93g5.natappfree.cc/wxpay/notify <span class="token comment">#回调地址</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><p>2修改WxPayServiceImpl ，引入</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${wxpay.notify_url}&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token class-name">String</span> notifyUrl<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><p>3修改WxPayServiceImpl 的nativePay方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;notify_url&quot;</span><span class="token punctuation">,</span>notifyUrl<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//回调地址</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>4测试：</p><p>4.1重启ydles_service_pay</p><p>4.2添加商品： http://localhost:8001/api/wcart/add?skuId=1450862568724758528&amp;num=5</p><p>4.3查看购物车： http://localhost:8001/api/wcart/list</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211221232224662.b901e7ea.png" alt="image-20211221232224662"></p><p>4.4点击：结算---》提交订单--》选择微信支付--》跳到二维码页面--》扫描二维码 查看可以回调多次</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211221232328432.ed3fc658.png" alt="image-20211221232328432"></p><p>为什么多次回调？ https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=9_7&amp;index=8</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">注意：</span>
<span class="line">1、同样的通知可能会多次发送给商户系统。商户系统必须能够正确处理重复的通知。</span>
<span class="line">2、后台通知交互时，如果微信收到商户的应答不符合规范或超时，微信会判定本次通知失败，重新发送通知，直到成功为止（在通知一直不成功的情况下，微信总共会发起多次通知，通知频率为15s/15s/30s/3m/10m/20m/30m/30m/30m/60m/3h/3h/3h/6h/6h - 总计 24h4m），但微信不保证通知最终一定能成功。</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3</p><h4 id="_3-3-6-处理回调通知-重点" tabindex="-1"><a class="header-anchor" href="#_3-3-6-处理回调通知-重点"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-3-6-%E5%A4%84%E7%90%86%E5%9B%9E%E8%B0%83%E9%80%9A%E7%9F%A5-%E9%87%8D%E7%82%B9" target="_blank" rel="noopener noreferrer">#</a>3.3.6 处理回调通知-重点</span></a></h4><p>1资源文件夹 ConvertUtils 放到 common工程的utils包下</p><p>2微信支付平台发送给回调地址的是二进制流，我们需要提取二进制流转换为字符串，这个字符串就是xml格式。</p><p>修改notify方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 回调</span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/notify&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">wxPayNotify</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;支付成功回调。。。。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">	<span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">	        <span class="token comment">//1输入流转换为字符串</span></span>
<span class="line">            <span class="token class-name">String</span> xml <span class="token operator">=</span> <span class="token class-name">ConvertUtils</span><span class="token punctuation">.</span><span class="token function">convertToString</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>xml<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">		<span class="token comment">//如果成功，给微信支付一个成功的响应</span></span>
<span class="line">        <span class="token comment">//响应数据设置</span></span>
<span class="line">        <span class="token comment">//2给微信一个结果通知</span></span>
<span class="line">            response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;text/xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">String</span> data <span class="token operator">=</span> <span class="token string">&quot;&lt;xml&gt;&lt;return_code&gt;&lt;![CDATA[SUCCESS]]&gt;&lt;/return_code&gt;&lt;return_msg&gt;&lt;![CDATA[OK]]&gt;&lt;/return_msg&gt;&lt;/xml&gt;&quot;</span><span class="token punctuation">;</span></span>
<span class="line">            response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">		</span>
<span class="line">	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22</p><p>**注意：**1、同样的通知可能会多次发送给商户系统。商户系统必须能够正确处理重复的通知。2、后台通知交互时，如果微信收到商户的应答不符合规范或超时，微信会判定本次通知失败，重新发送通知，直到成功为止（在通知一直不成功的情况下，微信总共会发起10次通知，通知频率为15s/15s/30s/3m/10m/20m/30m/30m/30m/60m/3h/3h/3h/6h/6h - 总计 24h4m），但微信不保证通知最终一定能成功。</p><p>测试后，在控制台看到输出的消息</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">访问到 notify接口了！</span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xml</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appid</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[wxababcd122d1618eb]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appid</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bank_type</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[OTHERS]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bank_type</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>cash_fee</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[1]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>cash_fee</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>fee_type</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[CNY]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>fee_type</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>is_subscribe</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[Y]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>is_subscribe</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mch_id</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[1611671554]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mch_id</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nonce_str</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[WNXFCMMCQSYiM09qrr4nwDH41iJnwuSs]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nonce_str</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>openid</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[o9tV755anFQYm27bYNC1ALQ5Ovfs]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>openid</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>out_trade_no</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[1473316925973991424]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>out_trade_no</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result_code</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[SUCCESS]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>result_code</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>return_code</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[SUCCESS]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>return_code</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>sign</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[E6A69A88C986B64411ACB2DA7E945EB48BF6391C06B0972DA6AEC80C00FC74F9]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>sign</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>time_end</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[20211221233851]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>time_end</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>total_fee</span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>total_fee</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>trade_type</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[NATIVE]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>trade_type</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>transaction_id</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[4200001414202112216382710751]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>transaction_id</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xml</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19</p><p>我们可以将此xml字符串，转换为map，提取其中的out_trade_no（订单号），根据订单号修改订单状态。</p><h4 id="_3-3-7-收到微信通知后的逻辑" tabindex="-1"><a class="header-anchor" href="#_3-3-7-收到微信通知后的逻辑"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-3-7-%E6%94%B6%E5%88%B0%E5%BE%AE%E4%BF%A1%E9%80%9A%E7%9F%A5%E5%90%8E%E7%9A%84%E9%80%BB%E8%BE%91" target="_blank" rel="noopener noreferrer">#</a>3.3.7 收到微信通知后的逻辑</span></a></h4><p><strong>支付服务：查询订单验证通知</strong></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211221235105274.1009b630.png" alt="image-20211221235105274"></p><p>微信方面查询订单如何做 https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=9_2</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211221235203111.b2b94980.png" alt="image-20211221235203111"></p><p>（1）WxPayService新增方法定义</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 查询订单</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">orderId</span></span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token class-name">Map</span> <span class="token function">queryOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6</p><p>（2）WxPayServiceImpl实现方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Map</span> <span class="token function">queryOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span> <span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;out_trade_no&quot;</span><span class="token punctuation">,</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> resultMap <span class="token operator">=</span> wxPay<span class="token punctuation">.</span><span class="token function">orderQuery</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> resultMap<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12</p><p>（3）修改notify方法</p><p>下单：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211222001359665.119fb165.png" alt="image-20211222001359665"></p><p>下单<strong>通知</strong>成功与否在哪儿？ https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=9_7&amp;index=8</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA64AAAA6CAYAAACwGQS6AAAPQklEQVR4nO3dT2gbd97H8Y8fCuklzaXyo911IWHkshBfnJpgSMEK1LUJPAsFIR9jYvmwJlnYk62efIrk0wOJ8VIsB+ewhwhBDg8Eex2wDA2YoFgUbFgaDxueuF1h9dLmEp+8h5GsmZHkkWLLHlvvFwTi0fz5jeaPft/5/b6/6djf39+Xh0LhFwWDn3rNBgAAAABoU62MG/+rJWsFAAAAAOCYELgCAAAAAHyNwBUAAAAA4GsErgAAAAAAXyNwBQAAAAD4GoErAAAAAMDXCFwBAAAAAL72UaMzFgq/tLIcAAAAAADU1HDg2qoXyQIAAAAAzr5WNnbSVRgAAAAA4GsErgAAAAAAXyNwBQAAAAD4GoErAAAAAMDXCFwBAAAAAL5G4AoAAAAA8DUCVwAAAACArxG4AgAAAAB87aPTLgDayN++OO0SnC1/fnXaJQAAAAB8gRZXAAAAAICvEbgCAAAAAHyNwBUAAAAA4GunELgWlb5jKJEr/ZlLyLiTVrGBZcYyh8/lUEhrzBhTuuCxfZd80pBhNPAvmW+8LDgle/rL9IauPN077YIc2Hr6Wh3Tu9o67YKctkJaY57XWa3rtw25v6sPvPcUM2MyjIRacecqZsZq3seLmbG6922rPK5jXdrXevfnc+2w45xL1D12+WSdcyKXcF5PNX9nrd9D+3yV7776s6pyeZ2bx3Tu4hxq6/PdVqet81tYfQ/MK1F3v6q/l7rfE3DGnYEW16LSd/oVX5Oyk/11K7nOi7yo9LfLGnqxoGjQHYxa60qN1K8gx56YMs3yv4xiiilj2qY9iZ30l4Bj4b9Atr25rivHv3UlBk67fD5QSGvsRlwh2z1pPTRbVdlq6qFeC8o4NRlS5lFUgYOJViWrfzJbc5FiZkz9z4a0fnC8rXu1glEtPIkpNdKaANu3PI9zc/JJQ8aInNfXhKn+qkp4v5ZvrTuuO2PO+XsYnll3XptTvY2V+Zj3CedIu5/vuZTiazHdjZTvmGElXjh/A+N97mWWlBoIK7y2rFUe6KKN+XxU4bwSRsS6WKWDQLSiFNQqoZjtIs8n+2VOmIoHrc/NCVPmlHMZc6LGjaEkNWIo5Z5muKaMDx9lxwAopYj7unIIK3FiZfGn/GJc2fGMFmz3qkBkQfEPWFcgsiAzcmxFO5BfjEsz6+otTyikNXbD1F1zXcadfi27FygHuqY90LXpiykx0K/ZTEwLkZpznDvHeZyLmTFF5mPKmPHKMZGkvrjMg/XnlbhhHTfndxxQ9NHCsZT5OPcJ50u7n+/55ylpPOMsr9f2n6cUvrWuu5/3a/b7oqJtcm8E3E6kxbWZLgvFzFhp3qLSdyLSE1PmowUtmHdl3qisx+pmVnp6ZnvSb93Eyi2q/Yp/nqkboNZDi2uLvHyrjom3evzyrTomNhxdZh/PbVjTXNMry1V/9nhuQx1zvzk2Ubcr7s6urkxs6eGu9GZlSx0TG/r6pXeRt56+rmx74q0eV63zkHK798tV1oa2ca7R4tqQH1/XTqUotSDYe6NYT/et1s5ErtS1rNSjxNmdtzyPs3tcVcutqxtbeZ2VVoS8lubDGvrSVokKRrXgrkTaFL9fVnZ8+JBKW0A3b4WVfbbqkUJyztQ7zk3JKzWZVexJ/e9fkoqZWaUGEkoetfLrVeZj2SecS217vue1NC/FvmoqbD24z3aF2vDeCNicSODaO5pQeH6pga5fRa0+y5Yu6ICij+ytor2KmxnF5iMyDEP9k1LihVn1RD4QWagElwMJrU/1uipfNboKu3IGnN2II0oppYi9a/LIYa1EOFxRo7lL2p+7pv3pTl0tdd8dVciaNndNi5076ikHeTu7urL4Xve+tT7bj0nfNRBwVunq1L/mrupep3R58Kr2567pH9cPX2Tr6Wv1rHysxVK59ucu6VW5m/HLt+q4v6Pu0WvOcrsC69HNQGX5vl/Vs/LOsY3Hcxvq+eGSNkvzbA6+12jb5MC6riujukt/u+sdTSi8Fld/rbymYFQLpQC/3L3N/pAuNbKkYXs33BpSI1PS/VK3tpmwspNTlW5zpa5vOug6ty5jLuLsjZJbUkohdddZfy0721mFQ3Lmk7kebAa+HFJ4zdRO46s90w49zs0ovNa2wjK6Dp9tZzsrfd5du8W7QV5lPrZ9wrnTzud7OYiONdOgkltSamBIN4Ple2NcKbrco02dTI5r8KaGBlKa9crDKvX7H+5TdaK9YcgwyhUxU6aZlL6tN5hLXomRbSXul1pig1Et1G3ZMR0tthItrq11Uff+9Enlz5e7ergb0OJEZdrtP3Xp8uavVsvjz3t6o4/1RfmHqatTDzwCzuPxm/668k6Do5/p9sG0T/TgmwuS9vSXZ0WpJ+QIfm9PhDS4u6O/vrSW//umnMtf/0yLPbZN7OxqevOi7sU6dbU06eo3/63B3V/13XmvsXtdkx4BV9sIRrXwolQhqtUieojwTMyzK1p4JnnwHQcidxVTVmbp3Ct+v6yso5UioOj9hMLulQwY8qg32hT1+kcpOzl7EDCbLxIKz0ec+xbsVkjbet0uuVxHOM4OO6ayng8SrGMQDjV21NxjSxy0tnuV+bj2CedP257vVuNM+NZNVxCdVfyGvS5rz/EvKj2XqiwTvKmhASn1vK1GAQAOnFCOa0DRiZjic6sqRm7WnSv/PKVwOVeqLy7TdGUHFNIaMxK6a8bVW2qRjVatpdzFOGN1LZYUe7IuY65+C07YlvfQO2V65x04cifQHFsQKmnrp/eS3ml0oqhRx3wX9WpHun39kgYXtzU6UdT04FX965sLJ1PMl79qRQEt1gyS9/TPXWnw1ieu6Rf0x07p/37aq7t83+8uSrulP37e0xu908P7G3ro3sTPx7ETflTKW29qmbASVfntbSQY1YIZtQY0muyXMVkjn6uG0GXv9oX685QrWElnBSvYrZB9rjfbkgzP7bjZA2YFo0rOLKv/2aqKkTp5r+3gA49zq4Wr8gJtvMrs032CD/j03Gjp+V5Y1fJaWEP33es/5DeusKrlNSk0UXmAePNWWJpcUn6q99S/L+CkndzgTH3Diq1FlMqt167mFNKanQ9r6EXAMW3sRlzucSmzNQZ0iT0pdZMrXeTZtSVlTLOUGF9Uus6NIZ80NGv979AKddXgTNZWfXGjPfM6u7Q5XWl1dPpE/5i7ZnXNXdxSx4o0OOrdzffsCGhxzt6qe971Kn5wXdp5D5rW7qzBlaz7VCQ5XBnt8jTLdDnkPROaUvM4dxkKa1mvC1LvYQ9wugyFFddSLq7eutdRQN2fS/FjfFDgdW768dyFP7TT+X4wgFMTD2GL3y8rKylbNWhotq0GsAPKTvB1OL0aHpdSz1drfrq6GFd2/K4zsHR1J8yM1xiq3FxXYsCW43CwTLMBpVWhNqu2l1BMMSVmwjW2TdB6VFf/8LHUSNfY659ZeaQ90krOyn+1Wi/fO/JBc/9+V3v5Zv3+gi7rvV7VLJfVsvr6J/drdayW2O4/XKiz/J6++8FWvt9f0GUV9fcPydk9B/LJ6u5Uzvxy3uVarVexmarOui1gVfay264LILdU/XCvqVzU0sBL7vW6FV5ru8nc2fPFdZyD3QrZunFXWN0gDwZ6CUZ1d1xKzR2eZ1fOxzvePDmvc/Okzl2cPe1wvn/IoEylni9VdU+rfsogTWhHJ/oe194pU+ZU7a7CN6fMw5/C5hKKzNvfe+XBliM7lmkmYbAyyubSV6YWIt2SpO7IgpKaqj3yJj7c9U7d63ynhynbgEQ7u7pSHpzp5Vvb6L97erUrXf6d1V24Kuh9+Vajm96bfPPvBt7j2tWp6Z53enjfNsrvzq6+fron6YIe3ArozcqWY2Tix3PbWuns0v9el9R1Sf/j2q+tp/+vh7vubUgri/aRhH/T1+0wOFMhrdn56q6qzvxy8lzzSfc7qq1RNN35Wp6B4Afo/SomzUccIwgn3APT9Q0r1mQuauDLIYXt6y2kNTWZVWzC1hqyYyrbVO7s2eZ9nK1KsPv9tsXMVGVciPKcUxnFag0Sk0tUBsEKRpWcCSs1UuMd6Hcae1jkVeZGz120n7Y833NLSslZdk+5lOJrrlHbS3q/ikm80xVtyOfvcZUq73JNaL3We/8Kq1peC+luuXKbS1ij/o5nbDmyRaWfWcnvtd6pFZ6RrVty6UXQNSrL5fcgWq/iyartc++OxQU9mA7pnxPb6pkoVb47u7Q5Xcofvd6pP05vqGOxNHtPSPvlPNfrn2kxt6HRco5oZ5cWBy9q9IdDtnUroIeL2+qY8O5yfHvimjS3Ucm/7ezS5nRl2/uSOhZdZSuXWxf0YPqqNL1V2a+ekDYHpZ4f7Nu4qlfTW7YcX6vrcO1u0+dEebTa8Zi2RwwZ4xmZU1Rma+mdMqWkIWOkMi32xLS9K7A0fsBIRMa8LWXiOPTFZT6RjIMuamElXmQUuzFrG8WzV8Pj2ebeKxiMauGFNFYag6C8T5VylwcjWW+bfFfv42z9/qxrTP2GLdmm5u+i1XtoOGmo37D94o1nHA+HA5EFmV+mHceh1m9adrJfxqRt9QMJrT+Kepa5kX1Ce2q/8710T7O/77oB+ecpaSChm7XqmH3Diimi+GJe0XqNPvPW74KtRKS34czr2N/f3/eaqVD4RcHgpx+2hTp5ql4qAypV31jySUMR28V4aDK9JOup2pR0v06Oa+iw5fNKGEsa5mI/ur99cdolOFv+/Oq0S3D8CmmN3VjWkO2adl/P1XhA5BuFtMZumKUB8g6ZdhS5hIwRUcECcD7U+N0DzrMjxY0eWh+4AmUErs05j4Erzo5cQsZz+8Ajpd4vrpYMyeqF0v9sSOuPjjj4SelBZ+g4W44B4BTlk4YiPyaOfn8EzggCV5wPBK7NIXDFKbNe61DpL+PduwUAALSzVsaNZyDHFWiRnV1dub+jN1UfXNS9b7v1gLRLtLlyXj8AAMBpo8UVAAAAAHBkrYwbT/R1OAAAAAAANIvAFQAAAADgawSuAAAAAABfI3AFAAAAAPgagSsAAAAAwNcIXAEAAAAAvkbgCgAAAADwNQJXAAAAAICvEbgCAAAAAHzto0ZnLBR+aWU5AAAAAACoqeHANRj8tJXlAAAAAACcYa1s7KSrMAAAAADA1whcAQAAAAC+RuAKAAAAAPA1AlcAAAAAgK8RuAIAAAAAfI3AFQAAAADgawSuAAAAAABfI3AFAAAAAPgagSsAAAAAwNf+AyavE0+XQ6H4AAAAAElFTkSuQmCC" alt="image-20200305014740028"></p><p>我们的<strong>订单号</strong>在哪儿？ 在下单后微信回调的请求里。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211221235940049.37e099e7.png" alt="image-20211221235940049"></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20200305012941294.3c13dd66.png" alt="image-20200305012941294"></p><p>=================================================================================================</p><p>查询：https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=9_2</p><p><strong>查询结果</strong>如何？</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20200305015926052.167e538f.png" alt="image-20200305015926052"></p><p>查询<strong>订单结果</strong>结果如何？</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA5sAAAAvCAYAAABt2N7uAAAOzklEQVR4nO3dT2gbVx4H8K+XgntJc6m82taFhJFLwb4oNUHggscQ1yawhYKQjzHR+FDhFHqy1JNPHvm0kBiVYikohx4sBDksBLsOWIYEhFEsCjaU2kPDxm2F1UubS3zyHmYkzYxmNJIzsmXp+4FAPJo/bzR/9H7zfu9N3+np6SlMSqU/4fW+b55MREREREREBMA5bvzHOZaFiIiIiIiIegSDTSIiIiIiInLdO3YflEp/nmc5iIiIiIiIqIvYBpvss0lERERERER2nBoomUZLRERERERErmOwSURERERERK5jsElERERERESuY7BJRERERERErmOwSURERERERK5jsElERERERESuY7BJRERERERErmOwSURERERERK5756ILQF3su08vugSXy1cvLroERERERESuYcsmERERERERuY7BJhEREREREbmOwSYRERERERG57hyCzTIydwXIBe3PggzhbgblJpYJZxvPZVDKICyEkSk5bN+kGBcgCE38ixebLwtdkBN8vbiL649PLrogVfuPD9C3eIz9iy7IRStlEHa8zqyu3x5k/q7OeO8pZ8MQBBntuHOVs2HL+3g5G7a9b6vlMR1rbV/t7s9drdFxLsi2x64YtzknCrLxerL8nVV/D/Xz1b77+s/qyuV0brp07lIX6unzXVentfktrL8HFiHb7lf992L7PRF1gA5s2SwjczeA2DaQWwjYVkyNF2YZmW83MPU8hZDXHECq60rO2FdqpTUFilL5l4UECVlFN21NOu8vgVzRecFnbzNdV4Z/ecjjF12+DlDKIDwWg093T8r7VuoqSC09iGtDGaMLPmQfhuCpTlQrRoGFnOUi5WwYgSdTyFePt3qvhjeE1JqE5Ex7guKO5XicW1OMCxBmYLy+IgoCdRXnADZu5w3XnZAw/h6Ky3njtRn1N1dml/eJukivn++FJGLbEuaDlTumCPm58TcwNmpeZh3JcRHi9ga2+BCWLrkOG422CFkIqhcYUA0ea7RAFDIk3YVZjAegRBTEvOrnSkSBEjUuo0QsLmZNckZA0jxNME2Zm36bHSMiJBE0X1cGIuRzK0tnKqZjyM1lkdLdqzzBFGJnWJcnmIISdK1oVcV0DFjOw1+ZUMogPKZgXslDuBvAhnmBSnCq6INTnVEJ8ngAK1kJqaDlHF3HzeNczoYRXJWQVWK1YwIAozEo1fUXIY+px834HXsQephypcxu7hN1l14/34tPk8Bc1lhep+0/TUK8ncf8xwGsPCsj1CP3RupObWnZbKU5v5wNa/OWkbkbBNYUKA9TSCnzUMZq61FTsLSnVLon6uqNp9JyGUDs46xtUGmHLZttsvMKfZFXeLTzCn2RXUM66aPErjrNNL22XP1njxK76Ev8bdiEbZrq0TGuR/bx4Bh4ubmPvsguPt9xLvL+44PatiOv8KhunQ3Kbd4vU1mb2kZXY8tmU345sO5moD2p12d9qE/R1VZFuaClXWmZG8ZU18o8xtSxuhZSU4pXZZ21p/VFrK+KmPpMV/HxhpAyV/x0ys82kJubblDR8mDitojcky2H7hVdxu44t6SI5EIO0pr99w8A5ewKkuMy4m9bYXUqsyv7RF2pZ8/3ItZXAelWS6Fm9T476OvBeyN1nbYEm/5ZGeLqehNpUWVsPclpF6EHoYf61kc/YkoW0moQgiAgsADIz5W6J9+eYKoWEI7LyEf9pgqTRRqtKQfemGIbRBJJBPVpuzONWmOosTJmC1dxmriB08UBDGuprbPwqdMSN5AeOMJIJTA7Osb19Bvc+1b97FQCvm8iSKwzOIBfE8O4NwBcmxzGaeIGfrzZeJH9xwcY2XwXaa1cp4mreFFJwd15hb6lIwzN3jCW2xQMz+55asuP/oWRzdeGbTxK7GLkp6vY0+bZm3yD2Z7p02m6roT6dPde55+VIW7HELDqp+MNIaUF5ZXUL/2DteTMOqb1KaoWkjNRYElL+VoWkVuI1lLKtLQwVNPK8hASQWPWR2EdSfgwZLN+K0eHOYg+GPtHmR5Gej6bgrit4Kj51V5qDY9zK0oHOIQIYbDxbEeHOeDjIeuW5SY5ldm1faKu08vneyXwlVppBCmsIzk+hQlv5d4YQ5Lp6HSJtafPpncCU+NJrDj1K9Ly2KdHUd/ZWxAgCJXKkwJFiQPf2g0oUoQ8cwh5SWvx9IaQsm1BUQwtowBbNtvrCu598V7tz51jPDj2IB2pTbvzxSCu7f2ltvD9foKXeBefVn5MBgdw3yFIdMff+GbzNSZnP8Kd6rT3cP/LfgAn+PpJGRjxGQLWOxEfJo+P8M2OuvwPezAuf/MjpEd0mzg6xuLeFdyTBjCsTRr+8p+YPP4L33d7LdvpmnQIknqGN4TUc60SY9Xy2IC4LDmmaYnL8ep37AnOQ0IOinbulZ9tIGdoDfAgtCRDNK9kXIBDXU+njINfgNzCSjXIVZ7LEFeDxn3zDsGHQxz0St+ktzjOBkcKco7Bv3oMRF9zR808VkK1VdupzG7tE3Wfnj3f1QYV8faEKfDNITamr8vq+6yXkUkka8t4JzA1DiSf9lSvduoybeqz6UEoIiGW2EI5OGE7V/FpEmKl789oDIpiynYvZRAWZMwrMfi1ls9Q3Voq6bdZNe0WgLSWh5CwbykRdXn8/qjinEdv6AtArdEFjgD2f3sD4DVmI2XMGua7ghdHwJ2bVzGZPsRspIzFyWH8+mX/+RRz5y9swoO0ZWB7gp+Pgcnb75mm9+OTAeC/v53YLj/6ryvAsfbH7yd4idd4sLSLB+ZN/O7GTnQirR92S8uIkOv6a/cQbwgpJaQOqrMQgLBg0T/Jgu+a83N8+3kqlaK4sVLkHYJPP9fLQwCC43bM9EEuvCHElzcQeLKFctCmH2cvOONxbjexrp+bjlOZO3SfqAN06LnR1vO9tIWNbRFTS+b1N/iNK21hYxvwRWoP/SZui8DCOopR/4V/X0Rn0b4BgkanIW0HkSzkrasmpQxWVkVMPfcYpoXHYjCPZ5izGFREWtNSyLQLM7e9jqyiaJ2zy8jYXMzFuIAV9X8NK8F1AwSpW+2Im+OlNzCIvcVa657Re/gxcUNNW03vo28TmJx1ToG9PDxIJ/Stp93Oj1j1utRzHrir16kD/Kj3qWB8ujZK4kWW6ZrPeSZqieVxHhQgYgMHJcDf6KHLoAARMawXYvDbXkceDH0MxFwM7p3OzU48d6kz9NL5Xh1EqIUHp+VnG8gByNUNXJnrqUHUqLu08dUnfkzPAcmnW5afbqVjyM3NG4NBU6pdds5iWGolD3lcl7NfXabVIFCtBCt125MhQYK8LFpsm4Hm2xr+8F2gmbTRmx+p/SJHgM2C2p9TbSV8Y+jfWPjjtfXyrfqgH9fwBi8sy6W2YB78Zn6FitriOfRhv83yJ/j+J135PujHNZTxw1n6oHaBYrw+1cjYX5rv2qznh7Rcl8jaBmoFLXdougAK6/UP5FrqW6kN/mNer1npAIct9gXtLqbj7B2CT5fiXKOmCFYHG/GGMD8HJBON+41V+pe52+/L6dw8r3OXLp9eON/PMjCQlmFSV/dU66ccKIguq7a+Z9MfVaBErdNoJ6JK46edBRnBVf17iRzo+nyGs610gKuNzrh+S0EqOAQAGAqmEEfUesRGOrubA7g38BoPkrpBcY6Ocb0yQNDOK92osSd4cQxc+5eaSlsXqO68wuye8yZf/tHEezYHB7A48hoPlnSjwx4d4/PHJwD6cf+2By839w0j2j5KHGJzYBD/uQlg8Cr+bdqv/cf/w4Nj8zaAzbR+BNq/8XkvDBBUymBltT6N09hfmv02i3HzO4TV0RfN/Y8cg7cz8N+SgNWgYeRZ2Tw42ug0pBb7Vno+m4KoX28pg+hCDlJE1+pwpCDXUl/Qy835OKsVV/P7R8vZaG2cg8qc0Swkq4FKCnJtICZvCPFlEckZi3dU323uAY9TmZs9d6n39OT5XlhHEsayOyokEds2jfat8d+SAL5zky6pDnvPJlB716aMvNV72Upb2Nj2Yb5SIS3I6mixc1ldn88yMk/UDthW7zwSl6FL2dVermtRwa28p0597UoOPd+XzBX9uL/ow8+RQ4xEtArzwCD2FrX+kDcH8MniLvrS2uwjPpxW+m3e/Ajpwi5mK30eBwaRnryC2Z8abOu2Bw/Sh+iLOKfj3oncABK7tf6kA4PYW6xt+xRAX9pUtkq50Y/7i8PA4n5tv0Z82JsERn7Sb2MYLxb3dX1W1bRa65TiLlEZ5XROwuGMAGEuCyXKCqgVf1QBtBeWV0hriu5dblp/+JkghFVddwI3jMagrAFCNX1LhPw8C2lsRTf6ox/Tc7nW3vvmDSH1HAhrfeor+1Qrd2VAjHzP9N90Ps7q708eYQQEXUcUy99FNUtnOi4gIOh+8eayhge6nmAKymcZw3Gw+k3LLQQgLOhWPy4j/zDkWOZm9ol6U++d79o9Tf8+4iYUnyaBcRkTVnXM0WlICCKWLiJk11Czqv4u6ErErl/UEfpOT09PzRNLpT/h9b5/tjXa9Lt0UhvUp/5mUIwLCOouoIYdugGoT6+iwJJNn01fo+WLkIV1TPMCfXvffXrRJbhcvnpx0SVwXymD8NgGpnTXtPl6rseHOh2jlEF4TNEGaWsw7W0UZAgzYKWIiLqDxe8eUTdzihvdDzaJKhhstqYbg026PAoyhKf6wS+0LBNTiwGgZnsEnkwh//AtB+DQHk763GyhJSK6QMW4gOAv8tvfH4kuCQabdHEYbLaGwSZdMHUI/1peinMWCREREfUyp7ixA/tsErXJ0TGuLx3hZd0HV3Dv2yHcZzdC6nGVfupEREREbmDLJhEREREREbXMKW5s66tPiIiIiIiIqDcx2CQiIiIiIiLXMdgkIiIiIiIi1zHYJCIiIiIiItcx2CQiIiIiIiLXMdgkIiIiIiIi1zHYJCIiIiIiItcx2CQiIiIiIiLXMdgkIiIiIiIi171j90Gp9Od5loOIiIiIiIi6iG2w6fW+f57lICIiIiIiokvEqYGSabRERERERETkOgabRERERERE5DoGm0REREREROS6/wP4kBM5a8SD3wAAAABJRU5ErkJggg==" alt="image-20200305015403233"></p><p>此次查询下单我们商品的订单号是什么？</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20200305020047787.0115833e.png" alt="image-20200305020047787"></p><p>此次支付动作的id在哪儿？</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20200305015219298.084b4177.png" alt="image-20200305015219298"></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/wxpay&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token annotation punctuation">@RestController</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WXPayController</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">WXPayService</span> wxPayService<span class="token punctuation">;</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//下单</span></span>
<span class="line">    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/nativePay&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">nativePay</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;orderId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> orderId<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;money&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> money<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Map</span> resultMap <span class="token operator">=</span> wxPayService<span class="token punctuation">.</span><span class="token function">nativePay</span><span class="token punctuation">(</span>orderId<span class="token punctuation">,</span> money<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> resultMap<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/notify&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notifyLogic</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;支付成功回调&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//1输入流转换为字符串</span></span>
<span class="line">            <span class="token class-name">String</span> xml <span class="token operator">=</span> <span class="token class-name">ConvertUtils</span><span class="token punctuation">.</span><span class="token function">convertToString</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>xml<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">//3基于微信发送的通知内容,完成后续的业务逻辑处理</span></span>
<span class="line">            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token class-name">WXPayUtil</span><span class="token punctuation">.</span><span class="token function">xmlToMap</span><span class="token punctuation">(</span>xml<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;SUCCESS&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;result_code&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">                <span class="token comment">//查询订单</span></span>
<span class="line">                <span class="token class-name">Map</span> result <span class="token operator">=</span> wxPayService<span class="token punctuation">.</span><span class="token function">queryOrder</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;out_trade_no&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;查询订单结果:&quot;</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;SUCCESS&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;result_code&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">                    <span class="token comment">//将订单的消息发送到mq&#39;</span></span>
<span class="line">                    <span class="token class-name">Map</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    message<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;orderId&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;out_trade_no&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    message<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;transactionId&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;transaction_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">                    <span class="token comment">//消息的发送</span></span>
<span class="line">                    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token class-name">RabbitMQConfig</span><span class="token punctuation">.</span><span class="token constant">ORDER_PAY</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">                    </span>
<span class="line">                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token comment">//输出错误原因</span></span>
<span class="line">                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;err_code_des&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">//输出错误原因</span></span>
<span class="line">                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;err_code_des&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">//2给微信一个结果通知</span></span>
<span class="line">            response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;text/xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">String</span> data <span class="token operator">=</span> <span class="token string">&quot;&lt;xml&gt;&lt;return_code&gt;&lt;![CDATA[SUCCESS]]&gt;&lt;/return_code&gt;&lt;return_msg&gt;&lt;![CDATA[OK]]&gt;&lt;/return_msg&gt;&lt;/xml&gt;&quot;</span><span class="token punctuation">;</span></span>
<span class="line">            response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65</p><p>config包下增加rebbitMQ配置类。并检查依赖和配置文件。</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Queue</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token annotation punctuation">@Configuration</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitMQConfig</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ORDER_PAY</span><span class="token operator">=</span><span class="token string">&quot;order_pay&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Bean</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span>  <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token constant">ORDER_PAY</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16</p><h4 id="_3-3-8-订单服务修改订单状态" tabindex="-1"><a class="header-anchor" href="#_3-3-8-订单服务修改订单状态"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-3-8-%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1%E4%BF%AE%E6%94%B9%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81" target="_blank" rel="noopener noreferrer">#</a>3.3.8 订单服务修改订单状态</span></a></h4><p>需求：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211222001437864.e620d18f.png" alt="image-20211222001437864"></p><p>1rabbitMQ配置类，把支付服务定义的队列定义</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ORDER_PAY</span><span class="token operator">=</span><span class="token string">&quot;order_pay&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Bean</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span>  <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token constant">ORDER_PAY</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6</p><p>2 com.ydles.order.listener包下创建OrderPayListener</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderPayListener</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token class-name">RabbitMQConfig</span><span class="token punctuation">.</span><span class="token constant">ORDER_PAY</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receivePayMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;接收到了订单支付的消息:&quot;</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Map</span> map <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//调用业务层,完成订单数据库的修改</span></span>
<span class="line">        orderService<span class="token punctuation">.</span><span class="token function">updatePayStatus</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;orderId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;transactionId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13</p><p>3OrderService接口新增方法定义</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 修改订单状态为已支付</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">orderId</span></span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">transactionId</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">updatePayStatus</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">,</span><span class="token class-name">String</span> transactionId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6</p><p>4OrderServiceImpl新增方法实现</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Autowired</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token class-name">OrderLogMapper</span> orderLogMapper<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updatePayStatus</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">,</span> <span class="token class-name">String</span> transactionId<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token class-name">Order</span> order <span class="token operator">=</span> orderMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">	<span class="token keyword">if</span><span class="token punctuation">(</span>order<span class="token operator">!=</span><span class="token keyword">null</span>  <span class="token operator">&amp;&amp;</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getPayStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment">//存在订单且状态为0</span></span>
<span class="line">		order<span class="token punctuation">.</span><span class="token function">setPayStatus</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">		order<span class="token punctuation">.</span><span class="token function">setOrderStatus</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">		order<span class="token punctuation">.</span><span class="token function">setUpdateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">		order<span class="token punctuation">.</span><span class="token function">setPayTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">		order<span class="token punctuation">.</span><span class="token function">setTransactionId</span><span class="token punctuation">(</span>transactionId<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//微信返回的交易流水号</span></span>
<span class="line">		orderMapper<span class="token punctuation">.</span><span class="token function">updateByPrimaryKeySelective</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">		<span class="token comment">//记录订单变动日志</span></span>
<span class="line">		<span class="token class-name">OrderLog</span> orderLog<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">OrderLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">		orderLog<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span> idWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">		orderLog<span class="token punctuation">.</span><span class="token function">setOperater</span><span class="token punctuation">(</span><span class="token string">&quot;system&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 系统</span></span>
<span class="line">		orderLog<span class="token punctuation">.</span><span class="token function">setOperateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//当前日期</span></span>
<span class="line">		orderLog<span class="token punctuation">.</span><span class="token function">setOrderStatus</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">		orderLog<span class="token punctuation">.</span><span class="token function">setPayStatus</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">		orderLog<span class="token punctuation">.</span><span class="token function">setRemarks</span><span class="token punctuation">(</span><span class="token string">&quot;支付流水号&quot;</span><span class="token operator">+</span>transactionId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">		orderLog<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">		orderLogMapper<span class="token punctuation">.</span><span class="token function">insertSelective</span><span class="token punctuation">(</span>orderLog<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25</p><h4 id="_3-3-9-整个流程测试" tabindex="-1"><a class="header-anchor" href="#_3-3-9-整个流程测试"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-3-9-%E6%95%B4%E4%B8%AA%E6%B5%81%E7%A8%8B%E6%B5%8B%E8%AF%95" target="_blank" rel="noopener noreferrer">#</a>3.3.9 整个流程测试</span></a></h4><p>1重启ydles_service_pay ydles_service_order</p><p>2添加商品： http://localhost:8001/api/cart/addCart?skuId=100000006163&amp;num=10</p><p>3查看购物车： http://localhost:8001/api/wcart/list</p><p>4点击：结算---》提交订单--》选择微信支付--》跳到二维码页面--》扫描二维码</p><p>4.1扫码支付之前，查看订单状态</p><p>4.1扫码支付之后，查看订单状态</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211222003719250.574a7d55.png" alt="image-20211222003719250"></p><p>订单日志表，也有一条数据了</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211222003728955.4ad46170.png" alt="image-20211222003728955"></p><h2 id="_4-推送支付通知" tabindex="-1"><a class="header-anchor" href="#_4-推送支付通知"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_4-%E6%8E%A8%E9%80%81%E6%94%AF%E4%BB%98%E9%80%9A%E7%9F%A5" target="_blank" rel="noopener noreferrer">#</a>4. 推送支付通知</span></a></h2><h3 id="_4-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_4-1-需求分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_4-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>4.1 需求分析</span></a></h3><p>当用户完成扫码支付后，跳转到支付成功页面</p><h3 id="_4-2-服务端推送方案" tabindex="-1"><a class="header-anchor" href="#_4-2-服务端推送方案"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_4-2-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%8E%A8%E9%80%81%E6%96%B9%E6%A1%88" target="_blank" rel="noopener noreferrer">#</a>4.2 服务端推送方案</span></a></h3><p>需求：我们需要将支付的结果通知前端页面，其实就是我们通过所说的服务器端推送，主要有三种实现方案</p><p>（1）Ajax 短轮询 setInterval Ajax 轮询主要通过页面端的 JS 定时异步刷新任务来实现数据的加载</p><p>如果我们使用ajax短轮询方式，需要后端提供方法，通过调用微信支付接口实现根据订单号查询支付状态的方法（参见查询订单API） 。 前端每间隔三秒查询一次，如果后端返回支付成功则执行页面跳转。</p><p>缺点：这种方式实时效果较差，而且对服务端的压力也较大。</p><p>（2）长轮询</p><p>长轮询主要也是通过 Ajax 机制，但区别于传统的 Ajax 应用，长轮询的服务器端会在没有数据时阻塞请求直到有新的数据产生或者请求超时才返回，之后客户端再重新建立连接获取数据。</p><p>如果使用长轮询，也同样需要后端提供方法，通过调用微信支付接口实现根据订单号查询支付状态的方法，只不过循环是写在后端的。</p><p>缺点：长轮询服务端会长时间地占用资源，如果消息频繁发送的话会给服务端带来较大的压力。</p><p>（3）WebSocket 双向通信 WebSocket 是 HTML5 中一种新的通信协议，能够实现浏览器与服务器之间全双工通信。如果浏览器和服务端都支持 WebSocket 协议的话，该方式实现的消息推送无疑是最高效、简洁的。并且最新版本的 IE、Firefox、Chrome 等浏览器都已经支持 WebSocket 协议，Apache Tomcat 7.0.27 以后的版本也开始支持 WebSocket。</p><h3 id="_4-3-rabbitmq-web-stomp-插件" tabindex="-1"><a class="header-anchor" href="#_4-3-rabbitmq-web-stomp-插件"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_4-3-rabbitmq-web-stomp-%E6%8F%92%E4%BB%B6" target="_blank" rel="noopener noreferrer">#</a>4.3 RabbitMQ Web STOMP 插件</span></a></h3><p>借助于 RabbitMQ 的 Web STOMP 插件，实现浏览器与服务端的全双工通信。从本质上说，RabbitMQ 的 Web STOMP 插件也是利用 WebSocket 对 STOMP 协议进行了一次桥接，从而实现浏览器与服务端的双向通信。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/10-5.93e1e7fd.png" alt="img"></p><h4 id="_4-3-1-stomp协议" tabindex="-1"><a class="header-anchor" href="#_4-3-1-stomp协议"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_4-3-1-stomp%E5%8D%8F%E8%AE%AE" target="_blank" rel="noopener noreferrer">#</a>4.3.1 STOMP协议</span></a></h4><p><strong>STOMP即Simple (or Streaming) Text Orientated Messaging Protocol</strong>，<strong>简单(流)文本定向消息协议</strong>。前身是TTMP协议（一个简单的基于文本的协议），专为消息中间件设计。它提供了一个可互操作的连接格式，允许STOMP客户端与任意STOMP消息代理（Broker）进行交互。STOMP协议由于设计简单，易于开发客户端，因此在多种语言和多种平台上得到广泛地应用。</p><h4 id="_4-3-2-插件安装" tabindex="-1"><a class="header-anchor" href="#_4-3-2-插件安装"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_4-3-2-%E6%8F%92%E4%BB%B6%E5%AE%89%E8%A3%85" target="_blank" rel="noopener noreferrer">#</a>4.3.2 插件安装</span></a></h4><p>1查询所有docker 容器</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">docker ps</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20200305023436779.f59f618b.png" alt="image-20200305023436779"></p><p>2我们进入rabbitmq容器</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">docker exec -it 410a37e15588 /bin/bash</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20200305023655720.57f7c2cb.png" alt="image-20200305023655720"></p><p>执行下面的命令开启stomp插件</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">rabbitmq-plugins <span class="token builtin class-name">enable</span> rabbitmq_web_stomp rabbitmq_web_stomp_examples</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20200305023810038.3d7f2413.png" alt="image-20200305023810038"></p><p>退出容器</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">exit</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAX0AAAA+CAYAAADHwssnAAAJf0lEQVR4nO2dYXarug6FlbveaEqHc5MznKbDafqGk5zp5P5ItFAUyZZsCLTsj+XVcwIyxpY3trFhR0RXAgAAsAn+WToBAAAAXgdEHwAANgRE3+JMt0EvGQAAfZzoVpdOSydk20D0JXu6OeVg7LsS0fG1yQHgV7G///1cNBXrRDY0Z+b3if5At4w7J+32NLZAvoloJwI76QfZNwQrLtlLiNgQjS2hK40VJILulWTO2QLnsQ6lPD86Nl7IXH+WTD7rsvSCld89trU4Iq3lHtup4QbTNxFdCsdxmnW5/OYe954efSDauGzUut8n+i1iMdBYEQ73IDmK3z4C8WUrFQtiNu1sZ3FuSEeEPflOxk44p2D30JrPS1ESaE8cp7Cdg3/vf78rx5VugKWbxU9G3wijot9Rfpn21/rDka50pSudEzbnu80xeNwQOIb/lo7fi2Ou6v/7SlrksSe17yT21a4pG/ZO3g7qWlrj7rGPxNuazxl/msJWlqH2H5nXVtw9tnOETD5w2mW6h4T9lkKL1t3CChK/ZEZkHIrj9oSC91/psXJ5oq9FW9rUxOisbHWQFf9VeS/FtHRjrF3T1DeqnnxeSvRr6SvldY/tHIF9MVKufKyVXs/XtxomFX3LWaWIRE9kbdEKHbXVLczaptPN11Wr/DJfaunYU0z0j+q8UTGKxB2JS5dptoxa0lXLW13hrSB7UZH8as1nry5kr2lu0Z/S1svr1lb2EDiXVZ61LVJfsyHjV5HedKk3rnufcovkZWTzy6yQ2HPlRF6knphELixr25sRVpxWGqSQWy0O3fJuEcCoGEXu8NKBtVNG8yxbaY4dtpFWfqmiZM77E0S/1lMr9fR6bL3yrJVNLY7SuZYW/Va/Kg2jkdhnXftqRd8r8NKY6NGx0XZWgnpsdRyRimaJuOeAXKhWIVrnnFP02dksZ7IcQx83FM4h8zlTyfXQVmuli+RNyTciQwA/QfTZ1/Q1R5+d9NhaZZr1B52OqE9Y+ZXpjWdDr195PaFsD6nledYswzulArNaC6UMtOL2utxZ29aM0GP0lq0uiNI1Ww+fMg4fFSOvVSxbHqdkXmTz0OoNtYpbpOVZ6wlk8rtF9L1tLlt93XqL3Nx6bHUcr7jpeT1p6+HuVKHXr+R+TndLA+iFol+fsvlO9lSpv8ZvcgqRN+1ITk+Sx/fYtvJ2/8vXwtPKeF4+Tx8rTRX7EjZLTSnTUyXf6Xna6RLpiCDnKHuLdgZxjOcbMu/fnGPm4Er5NSEZ2/87v0eusceWeafbWpX3hA3D05u9dESZqzyn8KsLjXVtf4+Hr/tAq5xmWhd9L9EHujmDFBfOlNpcXOuG0WPby4UeHYDToG8Keg7x8f7bhZZbrXuiUTh4UVnU0bwFU5G1CFz+Msg0RYWfz1VatCMrW6kNw0y5ME0v1LOuV67zmMqW6LEsPu927Jt8g/Wutcd2CiKCqtH1TcZFNL2ATuVX3zTm7Yfx28pYZnEWF2rLHbzHVvNm/Fs6llfIf+/7uID/TJCWDJwHH1Ru3ZcqUVTcM0hhicQdaeWvGXm92Z5nzVb2AN5pFM4DPba6rZ5Cj+1USPErIRsefPP7IFt09XFrQte9FfvzMqLvidHctha69SDj1eeSNwZZUa0XtJ2d/VO0rmQaL+S37r28+hL/5u679dqJFmRrskakla/xWs4yvLLXJfM2W7aerWwlW0MEckiB6NEXe2yn5Ke9Z6fXr/QN9Ms8ahVMK/rRVrglRj22c6Fb/+zIrzh3CVmRvV6GrPy69yJb10uNOWZa+T3C+kp68tIbO/Z8zcuTHtup4HpyoXqeHGkUVW4wyKFD7pnIobKpnldNlQ88zEs0Dt2Vhu1WwDRPkvWT7OxqwB5b64l2JO1ncZyeaSDjkXP0szMRMk/wM7NKajMxeMaDTm/kHFfHNhKic8Cjx0Wvd2o/jYaedHm2kVlq3jX02JbKqeW1Jtm8tWbpzL0at9evrPxumfbcM3snq9OTJUAXnHXBMpG1RSVZW8uha46ql3zrLbvy00vHHKIfffeOFY+XP3pedlb05Va65pbXAOi0ecdMPU8/cg3ZehKxreVlyb7HtpTnEQGLrMD1gvVuK07D1K/mmMKvrOmaVrwRH2/R3Pb3KE2UAM+prK1UMXtsOZRW9VqvluBCsYS09eVlEdGPrD4uxVGz99KrHd3KY8+RIqsna06ebeVn8qvWmMim/ZWry706mM3rHtuSn2TendOzkMtKw1yi3+NXsi6U/NzaH12FHG245myNH6d426HneNm7Xta2FofMiDkd6hWir88jt5b8Oal9WdGPlE/Pyl0O3pZ9x1DkGkq2tXT22NbiyAhwi60u72hLsqdsrbyZczVuj1+dK/uJyiugpxJ9opjWibC7/2ObDHR76n6htsUnAIARXpj0TcssDgQhft9HVDLw7IKB8ClEAHqJfigFLMq2RZ/o8VOI1hQrXsgEAPDhKbgXguivnG0P7zDyfRkeu8p+AAD4AUD0JVZOYHwSAPCLgOgDAMCGwJg+AABsCIg+AABsCIg+AABsCIg+AABsCIg+AABsCIg+AABsCIg+AABsCIg+AABsiHWLvvy2LAAAgG7WK/ryG6pE8bdg8gvS9IeKAQAArFj0v+nxo8pR0d/XDwEAgK3yv6UTUAQfNgEAgElZb0sfAADA5NRFXz5M5eANoZzEMd5wzF4coz9aIvfp4DGo4z6c3zlgrB8AsGF80WcBHox9LO6aA41fzfko2BLhPfUAALAQ5a+4HwtfXj857XL+0rv+Grv3e+Qr79Ev2h+T50BAQEDYULBb+l/3v5/0PEzzTeMDVj2tkvlz/zvQ2LI/imP/PFkAAAB4Ac+iP9Aozt64vJxK+ebs56GbPT1+g/ag7AEAALyMZ9GXIl7qJDBWS5/o1iOQ4/v6NwAAAC9n3imb+kHt56xnAwAAUKG8OGvXGbueHvlFWHAFAAAL8tzS/yv+7Q3dRJAPbvnmIR/sAgAAeDnPoi8fsn487Y2xp8cHt/IvP9idm54bFgAA/GKeH9PyXPfSHPkj2fP05Rx/vV/GOwTmlLbM05fnx1x9BAQEBB2cHSe6VjdL9M9UFurS/vPTGeytJualtONGgICAsOHgz945UPlB7oGeZ+ecaRxW8V6xIBdmXQvx92ClDQAAAO1oPukFAACwMvBqZQAA2BAQfQAA2BAQfQAA2BAQfQAA2BAQfQAA2BAQfQAA2BDlF64BAMBKuV7bZ5vvdr1vk/y5/AeCEmWi5N/GHQAAAABJRU5ErkJggg==" alt="image-20200305023840612"></p><p>将当前的容器提交为新的镜像</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> commit 410a37e15588 rabbitmq:stomp</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20200305024558360.e35417d3.png" alt="image-20200305024558360"></p><p>停止当前的容器</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> stop 410a37e15588</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAApMAAABCCAYAAAAL611eAAAPD0lEQVR4nO2daVYruQ6AxT1vNTcsp0Mvh7CcG3o50Nvh/UjUEUbyXEPg++r4EJJSlS0PpfIgP4jIhwAAAAAAdPBr6wgAAAAAwP2CMQkAAAAA3WBMAgAAAEA3GJMAAAAA0A3GJAAAAAB0gzEJAAAAAN3cjMmjXJwEeeGwRdTugDf5qquInH6/IyPpVb2eFosdKAeJ8+m4Ybx6Ockl7m9bR8SwxzgBAEyEnske1FDyjGyMIAAAAPhBfDUm30XkIQnv60ZqFbRHprW34Cgi5+vnV/msp5fr98/y1dBMz31qj/Jd8dPSq/SWq60Yre/6YpX2Yn7nXndYnnurRzNJR3VqRwbP0jeqsPZoZDQaksvrUyCzxahKi55zI3QlfY/Ilq5xzsh0yv7cnsmewnaQmyKf5KuBdDLfPXfGC+6bexwaHiHXkH3Hl1BYh59Wjyw1D3qLGlqtOlM5j7eOeNRwlNhoVCNzr3nfq+etyBmNUSfAgOzPNSZ7+HP9+yKXnjePV7k8RI/CXFP4/vy+/v3XfEe5B+hDDa2aFzF9qGvHRcvoz9HIpaNIr+acJaZseaMhj+Z3z4g5OTJpsOmPns89jOhZ8dJcOxrUI2t1+Cixrr1Or05ZjMlaDtfwLuUK9s/17+/sWQDfB9ugeQYmAOQ5ye1F7O+K89PpVi31zRqSqXH0JDdjbPYI26t8NkiU9yQePS+kGteX7FntjOh5K7TX8Em+GptW12rXTJAdMybVYrfd1nY+Qe2cF29cvvaNqFY2nafxHHwfxbuloGoGLNFDM6KrXvk0T3vuO4I3X6aG2eXKK8uj5eoesV4MtOHx5tQcnfOWikeq/xJb1KMIm47c0KKX3pxeZ7XPI2xVj1rzR3WrbXZvm9PLQdp7vl7En25Vcy9NZ/Q8s99HZWz2c2HESLMjgaX7t9ajXj3fCyPTkRLZizqP8iEf8iFvbvHwg5U5XD97R3TNc0ZGj+jerbK5+NXE2bumF4ejude5Qne5NM7SVY380ZGp1VlLWak5/83E6U3i+x4W0NWpIJeWi9Fytcdg9Z/7veWIrtUTSnmU0/MW9Ujj68XJ6jIqz8cvd6mL82j7vGQeLVWPevPXlvncEeXRrDqnz4xDxz2tTK6+5cqjVy5Pmfu06rm2zPTqL43rjHrUq+e0DramaUTW1oOa8jZHdiDiXuacgt9TpZ8CmVTOi8+IbHqNmvR6xmH0QNWKH2WUF8/S/UfTawuHF6eTkz823d5v9r65CtyT3lS3Ns6H4PsZujpkZFW+VF5aytVeQ8mYtMFL67lBvjXYPMzl/xLtRm89iuJkjyi9uTJZ0sVI+zwStqpHI/mba3OkIDsavLQuaUxqOfbKjGcopufNfC54eddqsNc8W0bqUa+e7bXXNiZtmbVpTvN3ruxAxNPGyisEnhVbamzSax8nyXqFtya9p+Ranmyq4FLBrDWuRtNbI98bWnTYa0x6cY7uO6qr1t7iUZ3MzIOWxrBW/6WGMuqB14fVEr04pR6IpcrGSD3KtRelclJKb87o6G2fR8MW9Wg0f0ttjpWdWa6j/FvSmIzKVPqy1NuW1ch5Pci9bWZNGR6pR716TsuNdywl65Vre9TU90bZeQtwHsUfe/fmQdj5CdH8Bl0VnZ4/IttLuqDgr+tfnVeiczWWcIUyml6dh1OzcGhvvIgf52hO6qiubFm9B12d5OscQZ0nl6JVfo2V1kstPLPzolpXa+6pHmn+vIu/GEGxc9uie3oLnzxa2udRtqhHs54LUZtjy9vM8m09hGzlSit1yfMo28wP7HENZNuEaP7nzHo0mw/pn7dcI/tP8H1NGhtl5xmTUUV4kq/L9jUypQeC19CNyI7yLp8LpsYhNTZnPrBH0ztjZW3kMHZvvjRHdfUun1cxajr3ip2wn7ptsIajbZxnPrCisrXUy5W9buu191CP9GGp8cgZkvaeIvk+BHv9iJb2eZQt6tEaz4XZCyt19faWL/pnuRkkulq5tm6NPBe03Nlg41RrUNpV6VG8Z9ajVlK3S156rf/qWbIin/PiRT67fdK2KEprh+y+XQNpxe95UxiRTfntfLYFN8qQNV0IlNLbExctNHszGkfJ6cpbtaeNzZ5WYtsyp5Vc/ZEpumpRG5sZLjPsA0Svaw0G2yin590DS9QjxRpZ390P7V7r0cznwgh29XaNG6CZqA6eJd8bmXtZXOK5YA2WmmvX9ErumdSn50xZW8ce5fay8iSfX2K9utgpu29jcqQ3YLavu/Stx143vZdncC7NEr79/pjPqfNSu33kvVHSlX0jtGksvc2tiXVkm2IbGuVJ7mPofmuW9pFpffi1GFUlh80Psr/83WM92osPVGsAeK5q3oLfZ+jMpl3bEe9ZFelqyeeC7f0qUdMrmbK3ejSy2UMka0dPS74iRT6XxQHZbYzJ2rdDrzCPyC5FajyqgmfcezS96TzPWlJfZPewNd4SZUN3XijtGrA30mGkWTtC2J0o9Jr2Xqona0jMGkKtGWaMyvlW9cjDNtK54d/vtKvQ0vVo6eeCbQ/voS3MYeMf9YpG6d3Lc6GlV/Je6tEsf4+2DkTlPNLJgOw2xqR9+4i6d6PJ9iOyHrWFKz1PlX6Sr28FR+mb1+Uxml47j7N3MVKUjr0ZVbPLhsUOUdaw50ZrNl4v/dL38fL3LLHe91CPLOn8Vg9b7/ZW13pZqh4tWfdFPut/xotZaXtAWz5s79/MZ4pIXK7sgrMovUs8F2xvY+15JZ3suR7VprdXtqY9rplrWin7eRl6r2ugWhkN1jVAulzfujspOdVsldVgl/eX0qz30/89lwbp0eIyYEldpfGNXO148Y30k7qjWco1UI2Lj5m6OmXSUusapqVc7TXUugbS86wrDdXxbDdU6T3TvE/roKf7repRjbuiqKykdS06p+Rncs3ys1U9GsnfXJtjr7uE79RS+me7BkrLRuTaK7rOzOeCd91SmnvcNI3UoxE916ShtX7WyJZ0mZPvl00iuJYxmUbKO3IZOyKrIbdbwptznirWq4i5hkykfteQSP+j6S0duYdg7p5RnEfSO2JMjuhqZGeVnnK111BrTHp5sLQxmdt94yzldqy3bMyoRyVH+SO7uuzNmNyqHvXmb017tVSZLpXzkZ2+ctcoyZd8ueZ0HOVRjZ5LBmKvb9TeejSi5zV3+Yvqfquu+2WTC6xpTOYiXvPGMSJbuobVw4wH5KgxOSO9kXzOaPBkzslvezMmR3SVq0izy9Vew4gxueTuN9690zJc046tXY9KTpxreymiI7rvVsZkTkdr1KOe/M21V1vU2TWMyfQ+NWUwp+PR50JNuRjZKae3Hi1lTJbiOSJbukaNLdMo+3D9cJlPcpayI92fyEEuK+rQDfwE3uRS5u3KY4DvjJb5yGk5AGTZt2ugvaCLaQ5CQwMAAABgwJisRd0PPIvvhNnubgEAAADwQ/hqTKpRZMNPcnMS8So3g1L3P7ZhT7ujANRCfQcAgEHomWxBfYN5vGZ+AwAAAPim3BbgAAAAAAA0Qs8kAAAAAHSDMQkAAAAA3WBMAgAAAEA3GJMAAAAA0A3GJAAAAAB0gzEJAAAAAN1gTAIAAABANxiTAAAAANANxiQAAAAAdOMbk+ne07V79Z6NzLEhFunewEvvD+ztR1zaX/sUyEShJf2ttOjZ20e8Vt8jsqVrnAvxHpUFAACAVfCNydaHtRparQaUynm8dcSjhqPERqMamUsagiP06nkrcoafGopRWkZkAQAAYDW+GpNqaL1XSOtD/fn6/1PDnY9G7lUuu4RreDXnnBquWct7cr8HEXk0v3tGzMmRSYNN/2t6gQFG9Kx4abYhl989slaHjxLr+lm+MiILAAAAq3MbQDzJx3/HIfnsDTjqcb7+b2WOhcHRt0Q2DWdzrbYB5v5wrEhzTZpOk+M1omdN09uAPnpkS/HL6XpElkAgEAgEwqrh1jN5kPaer5frua09ZQe5zbN7yVxbiYYz7dxBG3p7M//tlBO5xFHTVLr/m3yNc27ItlfP90JNL/gSsgAAADDMzZj8c/37KvVDtKeGcy1qOL1LbAz8MZ/TBR6luY3P199746Vxa0EN8cg41ut/iL9gRQ1jj149b4nGN5r3+JycN0sWAAAAVuViTJ7kYuC8yzq9X7+vf72eQDUUrcH12zlP5BLX3LzFlh7Kk9yMlMfciQ41vZIHuRlHLxLH+busVLZpsr3Faf565W1EFgAAAFYmmhtZM2cyDbVz+aK5hXae5Fluczhb5+zVyNl7fXTeJ01PNP8zl+YefffMmYyOpWTTdKdHTlczZAkEAoFAIKwSfv03nPwi280/S4etH2WbXqce10C2VzIa4rZzRKOeS6v7qCd2CT4k719zVPaf4PuaNI7IAgAAwCr8+m94ewkXPDWc5WaQqIugWqM2ciRe4zLGGyK3cao1KO38vSje1vjJ2fbKTIftqdslL712CH6WrMjnvNChfZ3n6E1nmCULAAAAq3GZM/n3ynfVuZLPku+NjOZWqjEx28+gNVhqrl3TK7lnUp+eM2Vtj+Wj3F5WnuTznFSvZ3NEFgAAAFblYkx6rmrsg9r+PqM3yBqH6hDb69WLjEm70jt1av0gY4ad7f0qUdMrmVJyfP4g6/YSW9225m0ka4f1n+SrbtKFXtYYHZEFAACA1fG3U1waayBEvaLWqHgPvt9ynmdLr+SIwbYms/w92mH9yHdnpJMRWQAAAFidX2HvmB1OtL1/M4w36x8wGk7W798l9icYxWVk+LvWh2FLr6T9fW9bAI74bKyRrVksUzPXtFUWAAAAVsNfDrKkayCRz25nUlcv58J1Ilc+djvIHlc/9siluWc7vzRu0Tk1bm9a9FyThlo3Py2yJV3m5EdkCQQCgUAgrB2CH2qMSc9XY3R41yjJRz4ZU8MsPfS6njEZ+S6sNSTtNVr9Hdboy7vmiJ5rZEfiG8mWfFTmdD0iSyAQCAQCYdWwzZxJJV2da8ktRDmJ74dSXdn0brOnw/m5oVPdLUikfaGPuiPK/b6mf83Uzc9M2VJeqLsfT9cjsgAAALAqD3KxKgEAAAAAmtm2ZxIAAAAA7hqMSQAAAADoBmMSAAAAALrBmAQAAACAbjAmAQAAAKAbjEkAAAAA6OZ/W0cAAKDEx0e/B7OHh15nqgAAUMP/AQ14qUdUE7pGAAAAAElFTkSuQmCC" alt="image-20200305024622094"></p><p>删除当前的容器</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> <span class="token function">rm</span> 410a37e15588</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAoIAAABECAYAAAAV3lSVAAAO/UlEQVR4nO2dW3LjOg5Aka5ZTTvLGecuJ85y2unlOHc7mQ8bE4QmSPAhW47OcbHSbQsSCYIUxAf0JCKfAgAAAACb49e9MwAAAAAA9wFHEAAAAGCj4AgCAAAAbBQcQQAAAICNgiMIAAAAsFGuHcG9nPcR59Lulll7IE5yrSuPkn5/IiPlVb0eFssdKDvx62l/x3z1cpBz3k/3zohhjXkCgM3DiOAI6uTkHGQcGAAAAFg5viP4ISJPSfq4TaZuio6EtD6l70XkePn3u3zX09vl+1e5dhLTY1/as/xQbK28Sq9d3YvR9q4PReno4U8e7YZtkM5qRGfGjtI3qn7r2ThvNqDUdx0cmXvMKrTouTRDVdP3iGztHMeCzAzZCowI9hjoTr6U/yLXzs3BfPfamS94bB5xOnWEUuf3Ex8gYTu03mjVSWrtA1Qux6kjHxH24jt86iCutS/r1fO9KDlt3oP0DNkAOII9/Ln8fZPziFeOdznfAPfC2kr4+fy+/P3XfIfdw6OjTlLkYUZvyPrw3zL7sTdy6SzKuzlmieVGudmAZ/N7zgE5ZGTSZMvv3Sd7GNGzkitzdDakR9bq8Fl8XecGjkZkg+AItrK7pA+pN8q/l7+/i0cB/BxsJ5hzDgEehYN8Pcz8Ezg+XSrUYvfWCUwdmxf5cqRmzzC9y3dnQvlI8tHzUKd5fSse1c6Inu+Fjta9yLWjaHWt/sUs2SBzHEH10O0Qs523j66Vys1/R5+AorLpeohX53sv3y3GrZW2xMjIiK565dM67bnuCLl1KRFm21XOlkft6hGxu+W1s8qtXdlnjlsqH6n+a9yjHXnYcpSmAXPlLel1Vv/cSu91tXwi39u86tXa01LtaCftI05vkl8qFLmW3iO8+4r93qvr2f3ziINlZ8Jq12+15149PwojS2kGZL9XwV4+5VM+5ZQ1qXyyMrvLv3Mf75zHgox+vGu3ypbyF8lz7py5POzNtY4B3ZXKOEtXEfl9RiaqsxZbiRx/Mnk6iX/d3QK6OlTkUrsYtas1Jqv/0u8tH+9cPalWRyU936MdaX5zebK69Ox5f3WVWJ5H++fe1Htda3c5vaafw+R82zxo323z79VPmqxMye5LdpGzj7S8M/tnr3316q9UN7323Kvn1CZH7LlV1vYXEXubJRtPEwpba5z297SiDo5MKpfLz4hseo5IeXOOnXcz1M6iVkEtjtFoea1B5fJ0yNSPLXfuN3vdSIfc4wjm8rxzvp+hq11BVuVr9tJiV2tNNUfQplxZjw3yrcnWYan+l+g3etuRlyf78cpbssmaLkb651l11HJd2+61PKpz/c3qc+wGGKunJR1BLVuuHDknLz1uZv+cayPR8uauuYQ99+rZnvvWjqCYPNoyp/W7hGwsTShs2uBzhpPzWms33PTc+0myOYOPlPeQnCsnm1ZKzZijjtFoeSPyvalFh72OYC7P3nVHddU6Sjuqk5l10NKBRvVf61y9kW+9wbXeSFry5tXvUrYx0o5K/UXNTmrlLTkqvf3zaOq9rm33OfveJ+ef2cY8PS7pCHp1mz5w9PYpEbncCHevXiO2NGLPvXrO2WT6WUo2Z9v2E2l3I7KVNH+zyLPk56lz6w3sOgBvHYHuvk2PH5HtJV38/t/LX12/oWsilgiXMVpeXe8S2eSyNt4kn2dvDeaorqytPoKuDnK9Jk7XUaVo07/Fjt6lNknZ9UetuxHX1I60fj4kv2BfsWvIvGvmNunkaOmfZ9Jz3dx6uXeZuwM1xUaEuFfYozRsy7PcZz1cT/gY2za99Y4z7Xk2n9K/7jQi+9f5PlLGEdkK8x1Br/G8yPWWci1ArWHnOosR2VE+5Lsxax5SR3HmzXa0vDN2cHpBRNcWK3FUVx/yfZeelnOt2EXtaUgB6/TZDn3mTc6zraUejOx5W8+9hnakN1jNR8kJtNcUKT/X2/N7tPTPM+m57q0dVt0lfM+H5aN8ORO6KzZq4yP9s9aDTTZPUWfQ7n728j3TnltJQ/PkymvjBM+SFfleF2/yPTSQ9gleWUdkAzxG+Bht/D2e74hsyu/Mv62xexVxy+3ttfL25EUNbW0O3yglXeV2pWkHtaYdv9bmtGPQOFeK7srTDmpGOAd709HzWqfZduTpcY/AEu1IsQ8axBldB3aXcCRUzEzUll6lPApYeuBaon+2zkbk3JHRwDWTxmycKWvvGc/y9aDxIt8fBL1d9L2yQR7DERx5Cp8dyyx9yrHnTa+VcxaXZonYbX/Mv9OAlvaVeo9GTVf2CdCWccIT2DRscNMU2zkpL/IY0933ZukYiDY2XEsHXgvi+yTUbw/25p0LZ3Jyfp/RB1gb0/acu2d4Nrlk/2xHnWpERgNT1mbPIwHxPVk7e1iLBSjy3RZHZBu4ryMYHa3LNYAR2aVIHT+tlBnXHi1vuq4xShrj6hFeF7aEbWgk/UmR3G9GOuUza32VfbOAntNeS/VknelZ046R+Jyend+rHeWwHXtp6QFva/nZ2D7VG420/XA6C7WG/rllNPBR7HlWPD/b13j3Gk8nI7IN3NcRtE8bnifrLQwfkc0RVWB6nFbUQa6fAvbSt44px2h57brF3o0zXjnW5hDNtg2LndaLsOaObja50fGlr5Or36P4el9DO7Kk6zlz2Ha3trb2U6i9Ms3Wkx11m9m3i/j1azcpef3PEv2zHeWLHlfTyZrtOVreXtlIvxhZW9kqGyC/Rbo3fEzr1mW7bT3dSm5DBtQCLbbKarJbz2tl1uvp/3Pb7dNPy3b2JXWV5tcLx5LLr6efNGTJUuFjImE+ZurqUChLNHxIi12tNUXDx+hxNsyD6niJYL/2mmndp20wp/t7taNISBvPVtK25h1TiyN4S/vpvW7O7nL2tET4GC8tGT4m1ZUXhsk7z8z+2bPzUpn3weNm2fOIniNlaLXXiGxNlyX5Edl4cgp1K0cwLUjuUzKGEVlNpbcEnDLHaWXkGm/pJiMSfxuDp//R8tY+pRtY6ZpenkfKO+IIjuhq5I0VPXa11hR1BHN1sLQjWHqbwlHq/VivbcxoR7Ug5iNvQ8ERXN7eRt5kVDpHTb4WM7NkE56eIv1zzbnrjUHZa88jer7lW8y8ttCq6xHZYFrHZpHS+qFaDKURWSX63kKdFtIpodz6J7tOaolFrqPlLcnbBeyWgyOj5V8yrtcIvbryymtlayE/RH72+zBrLL1RKt0ZrUR1fo92VCJ9efync95cme3vW7W3n0C6C9RSup8s1T/rFHipDdslUa2bUtZmz96muxmytbrQkDA5XY/IBnmStMvZy3mNTS3I6RbZyXnHGLqBLXCSs833ODYAAPAQrGNE8FHQjR87IUQDAAAAPDw4gq3o8Per5APketM6AAAAACvDdwTVobFpS6EwPN7lyxnU97natKa3TgBEob0DAGwSRgR70JhTOd4LvwEAAACsiOvNIgAAAACwCRgRBAAAANgoOIIAAAAAGwVHEAAAAGCj4AgCAAAAbBQcQQAAAICNgiMIAAAAsFFwBAEAAAA2Co4gAAAAwEbBEQQAAADYKGVHMH2XbvTdo0cjs2/ITfqu06Xfd5p7v2rtfcEHR8ZLLeVvpUXPufciR/U9Ils7x7GS71FZAAAAcCk7gq03WnWSWp0flctx6shHhL34Dp86iEs6cSP06vlelJw2dfK8sozIAgAAQBHfEVQn6SNwFr0hv17+/9KQg72Re5fz2481vZtjDg3njPKRXO9JRJ7N7zkH5JCRSZMt/3t6ggFG9KzkymxTqb57ZK0On8XX9atcMyILAAAAIa4n3Q7y+f/PLvl37nj9HC//tzL7yoTiKZFN09Gcq21Stj/tA2WOlOkwOV8jetYynQb00SNby19J1yOyJBKJRCKRqul6RHAn7SNOb5djW0eodvK1ruytcG7FmwK0a+Vs6h1F/LdTTuScRy1T7fonuc5zaZqzV8+PQmT0eQlZAACAjXLtCP65/H2X+LTmoeFYizo9H+LfyP+Yf6ebEWpr+V4vv/fmS/PWgjrRnmOr5/+U/OYKdWpz9Or5nmh+vXV+r8lxs2QBAACgyndH8CBn5+RDbjPq9PvyNzcCp06edZZ+Z44TOee1tE6vZWTwIF8OxnPpwAyR0cCdfDk2b+Ln+afsiLVlsqO0af3m7G1EFgAAAEKcJyW9tYCRNYJpiq5d89bS2XWBR/las9i6Ri0iZ6/12XmdtDzeesdSmXv03bNG0PssJZuWO/2UdDVDlkQikUgkkpu+RgR1CvZN7rfeKp3qfZb7jPb0hI+xo4HetLBdE+mNGFrdeyOgS/Ap5fiJo7J/ne8jZRyRBQAAAJezI2inhJcI0xLhKF/OhIaRiTqkXpDnSFiR3LSyzVPUGbTr1bx8W8el5J8rM4Npp6F5cuW109azZEW+14VOh+u6vtwSgFmyAAAAUKE2Fbnk1HBuWjZ3DT0unQrcZeRzn56p3mODbDSMSW2KNf3Uws+0TA1Hyxud6o3K2mndVDdp/c2UJZFIJBKJVE2/vo145cKZnJzfZ4zC2E0iGqw4N5rmbSqxO4rTgMNPUt65W8OOOtWIjAam1IJSP8ltR2etblvr1pO1U+Evcq2bdFOStcURWQAAAAhRfsXc0tib+z/OMdYh+HC+v+e6xsjaQGXE2bols+L52alwLzajp5MRWQAAAAjxq/rKNBtCxY66zXC8bPw3bz2ffv8hfrw4Ly8jrx6LxqhrGQ20v6/ttWgjMfkispGNHZG1la2yAAAAUKQ8f7zkGkGR7+vm0jWAx8p5vDWA9hV5PWsEa2sWc3mP6ibNm3dMJDTKjDWC6brF2bI1XZbkR2RJJBKJRCJFUuWAiCOY2/ThfUqbQbyPt2kidarST2nDhxebLuoE2nO0xrOL6Ct3zhE9R2RH8uvJRjfI5HQ9IksikUgkEqma7rtGUHkR/y0epU0TB8nHGdRwJ72vHtMp8NJ0o4bcEWnflKIha0q/3zJ+YhoKZqZsrS40JExO1yOyAAAAUOVJzh4hAAAAAGyMdYwIAgAAAMDNwREEAAAA2Cg4ggAAAAAbBUcQAAAAYKPgCAIAAABsFBxBAAAAgI3yn3tnAAAgyudnf7Srp6feYJkAAD8XRgQBAAAANgqOIAAAAMBGwREEAAAA2Cj/A/ICCOkNt/nhAAAAAElFTkSuQmCC" alt="image-20200305024639584"></p><p>根据新的镜像重新创建容器</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> run <span class="token parameter variable">-di</span> <span class="token parameter variable">--name</span><span class="token operator">=</span>ydles_rabbitmq1 <span class="token parameter variable">-p</span> <span class="token number">5671</span>:5617 <span class="token parameter variable">-p</span> <span class="token number">5672</span>:5672 <span class="token parameter variable">-p</span> <span class="token number">4369</span>:4369 <span class="token parameter variable">-p</span> <span class="token number">15671</span>:15671 <span class="token parameter variable">-p</span> <span class="token number">15672</span>:15672 <span class="token parameter variable">-p</span> <span class="token number">25672</span>:25672 <span class="token parameter variable">-p</span> <span class="token number">15670</span>:15670 <span class="token parameter variable">-p</span> <span class="token number">15674</span>:15674 rabbitmq:stomp</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>设置容器开机自动启动</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> update <span class="token parameter variable">--restart</span><span class="token operator">=</span>always 54b0eea9edbb <span class="token comment">#根据上面生成的容器号改变</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20200305024852480.ea9a3885.png" alt="image-20200305024852480"></p><p>插件已经安转好了http://192.168.200.128:15670/</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211222005732519.a1963786.png" alt="image-20211222005732519"></p><h4 id="_4-3-3-消息推送测试" tabindex="-1"><a class="header-anchor" href="#_4-3-3-消息推送测试"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_4-3-3-%E6%B6%88%E6%81%AF%E6%8E%A8%E9%80%81%E6%B5%8B%E8%AF%95" target="_blank" rel="noopener noreferrer">#</a>4.3.3 消息推送测试</span></a></h4><p>1观察wxpay.html</p><div class="language-html line-numbers-mode" data-highlighter="prismjs" data-ext="html" data-title="html"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/js/plugins/qrcode.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/js/plugins/stomp.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>inline</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>javascript<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript"></span>
<span class="line"><span class="token keyword">let</span> qrcode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QRCode</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;qrcode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token literal-property property">width</span> <span class="token operator">:</span> <span class="token number">240</span><span class="token punctuation">,</span></span>
<span class="line">	<span class="token literal-property property">height</span> <span class="token operator">:</span> <span class="token number">240</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">qrcode<span class="token punctuation">.</span><span class="token function">makeCode</span><span class="token punctuation">(</span><span class="token string">&quot;weixin://wxpay/bizpayurl?pr=XzofHwG&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">let</span> client <span class="token operator">=</span> Stomp<span class="token punctuation">.</span><span class="token function">client</span><span class="token punctuation">(</span><span class="token string">&#39;ws://192.168.200.128:15674/ws&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> <span class="token function-variable function">on_connect</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    id <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">&quot;/exchange/paynotify&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        </span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> <span class="token function-variable function">on_error</span> <span class="token operator">=</span>  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;error&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">client<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">&#39;guest&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;guest&#39;</span><span class="token punctuation">,</span> on_connect<span class="token punctuation">,</span> on_error<span class="token punctuation">,</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21</p><p>所以我们需要创建一个交换机paynotify</p><blockquote><p>destination 在 RabbitMQ Web STOM 中进行了相关的定义，根据使用场景的不同，主要有以下 4 种：</p><ul><li><code>1./exchange/&lt;exchangeName&gt;</code></li></ul><p>对于 SUBCRIBE frame，destination 一般为<code>/exchange/&lt;exchangeName&gt;/[/pattern]</code> 的形式。该 destination 会创建一个唯一的、自动删除的、名为<code>&lt;exchangeName&gt;</code>的 queue，并根据 pattern 将该 queue 绑定到所给的 exchange，实现对该队列的消息订阅。 对于 SEND frame，destination 一般为<code>/exchange/&lt;exchangeName&gt;/[/routingKey]</code> 的形式。这种情况下消息就会被发送到定义的 exchange 中，并且指定了 routingKey。</p><ul><li>2.<code>/queue/&lt;queueName&gt;</code> 对于 SUBCRIBE frame，destination 会定义<code>&lt;queueName&gt;</code>的共享 queue，并且实现对该队列的消息订阅。 对于 SEND frame，destination 只会在第一次发送消息的时候会定义<code>&lt;queueName&gt;</code>的共享 queue。该消息会被发送到默认的 exchange 中，routingKey 即为<code>&lt;queueName&gt;</code>。</li><li>3.<code>/amq/queue/&lt;queueName&gt;</code> 这种情况下无论是 SUBCRIBE frame 还是 SEND frame 都不会产生 queue。但如果该 queue 不存在，SUBCRIBE frame 会报错。 对于 SUBCRIBE frame，destination 会实现对队列<code>&lt;queueName&gt;</code>的消息订阅。 对于 SEND frame，消息会通过默认的 exhcange 直接被发送到队列<code>&lt;queueName&gt;</code>中。</li><li>4.<code>/topic/&lt;topicName&gt;</code> 对于 SUBCRIBE frame，destination 创建出自动删除的、非持久的 queue 并根据 routingkey 为<code>&lt;topicName&gt;</code>绑定到 amq.topic exchange 上，同时实现对该 queue 的订阅。 对于 SEND frame，消息会被发送到 amq.topic exchange 中，routingKey 为<code>&lt;topicName&gt;</code>。</li></ul></blockquote><p>2 http://192.168.200.128:15672/#/exchanges 新建交换机。名字：paynotify 。类型 ：fanout。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20200305025600949.da1a31f6.png" alt="image-20200305025600949"></p><p>3修改wxpay.html</p><div class="language-html line-numbers-mode" data-highlighter="prismjs" data-ext="html" data-title="html"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/js/plugins/qrcode.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/js/plugins/stomp.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>inline</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>javascript<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript"></span>
<span class="line"><span class="token keyword">let</span> qrcode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QRCode</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;qrcode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token literal-property property">width</span> <span class="token operator">:</span> <span class="token number">240</span><span class="token punctuation">,</span></span>
<span class="line">	<span class="token literal-property property">height</span> <span class="token operator">:</span> <span class="token number">240</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">qrcode<span class="token punctuation">.</span><span class="token function">makeCode</span><span class="token punctuation">(</span><span class="token string">&quot;weixin://wxpay/bizpayurl?pr=XzofHwG&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//自己的微信图片</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">let</span> client <span class="token operator">=</span> Stomp<span class="token punctuation">.</span><span class="token function">client</span><span class="token punctuation">(</span><span class="token string">&#39;ws://192.168.200.128:15674/ws&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> <span class="token function-variable function">on_connect</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    id <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">&quot;/exchange/paynotify&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">         <span class="token function">alert</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> <span class="token function-variable function">on_error</span> <span class="token operator">=</span>  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;error&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">client<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">&#39;guest&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;guest&#39;</span><span class="token punctuation">,</span> on_connect<span class="token punctuation">,</span> on_error<span class="token punctuation">,</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20</p><p>4将wxpay.html放到static中。因为对比静态页面文件夹，页面获取的是平级的js。打开页面，观察console。如果有错，将static打包，发给大家。</p><p>页面效果</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211222012152665.81c35747.png" alt="image-20211222012152665"></p><p>5尝试发送一条消息</p><p>点击rabbitMQ队列交换机页面的paynotify</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211222012132026.ccd25173.png" alt="image-20211222012132026"></p><p>点击发送消息</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211222012123305.a8281baf.png" alt="image-20211222012123305"></p><p>效果</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211222012108075.e6e3776e.png" alt="image-20211222012108075"></p><p>6新建用户</p><p>为了安全，我们在页面上不能用我们的rabbitmq的超级管理员用户guest，所以我们需要在rabbitmq中新建一个普通用户webguest（普通用户无法登录管理后台）</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20200306075452263.a700224f.png" alt="image-20200306075452263"></p><p>设置虚拟目录权限，打开这个用户权限页：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20200306075534030.6667d3b8.png" alt="image-20200306075534030"></p><p>点击设置权限</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/13-3.9801a07a.png" alt="img"></p><p>页面用户名和密码修改</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">client.connect(&#39;webguest&#39;, &#39;webguest&#39;, on_connect, on_error, &#39;/&#39;);</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>刷新页面，还可以看到连接信息即可。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20200306075942810.3fedba8a.png" alt="image-20200306075942810"></p><h3 id="_4-4-代码实现" tabindex="-1"><a class="header-anchor" href="#_4-4-代码实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_4-4-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>4.4 代码实现</span></a></h3><p>实现思路：后端在收到回调通知后发送订单号给mq（paynotify交换器），前端通过stomp连接到mq订阅</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211222013147811.3cb78af5.png" alt="image-20211222013147811"></p><p>1 修改notifyLogic方法，在<code>&quot;SUCCESS&quot;.equals(result.get(&quot;result_code&quot;))</code> 后添加</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;SUCCESS&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;result_code&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token comment">//将订单的消息发送到mq&#39;</span></span>
<span class="line">                    <span class="token class-name">Map</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    message<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;orderId&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;out_trade_no&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    message<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;transactionId&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;transaction_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token comment">//消息的发送</span></span>
<span class="line">                    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token class-name">RabbitMQConfig</span><span class="token punctuation">.</span><span class="token constant">ORDER_PAY</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">                    <span class="token comment">//完成双向通信</span></span>
<span class="line">                    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;paynotify&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;out_trade_no&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11</p><p>2 ydles_web_order的PayController中新增跳转支付成功接口</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token comment">//支付成功跳转</span></span>
<span class="line">    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/topaysuccess&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">topaysuccess</span><span class="token punctuation">(</span><span class="token class-name">String</span> payMoney<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;payMoney&quot;</span><span class="token punctuation">,</span> payMoney<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">&quot;paysuccess&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20200423120048804.4b80e771.png" alt="image-20200423120048804"></p><p>3 修改ydles_web_order项目的wxpay.html ，渲染js代码订单号和支付金额部分</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;/js/plugins/qrcode.min.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;/js/plugins/stomp.min.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;text/javascript&quot;</span> <span class="token literal-property property">th</span><span class="token operator">:</span>inline<span class="token operator">=</span><span class="token string">&quot;javascript&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token keyword">let</span> qrcode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QRCode</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;qrcode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">240</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">240</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    qrcode<span class="token punctuation">.</span><span class="token function">makeCode</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>$<span class="token punctuation">{</span>code_url<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">let</span> client <span class="token operator">=</span> Stomp<span class="token punctuation">.</span><span class="token function">client</span><span class="token punctuation">(</span><span class="token string">&#39;ws://192.168.200.128:15674/ws&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token function-variable function">on_connect</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        id <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">&quot;/exchange/paynotify&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">alert</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">let</span> orderId <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>$<span class="token punctuation">{</span>orderId<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token punctuation">.</span>body <span class="token operator">==</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">//跳转页面</span></span>
<span class="line">                location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">&quot;/api/wxpay/toPaySuccess?payMoney=&quot;</span> <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>$<span class="token punctuation">{</span>payMoney<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token function-variable function">on_error</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;error&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    client<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">&#39;webguest&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;webguest&#39;</span><span class="token punctuation">,</span> on_connect<span class="token punctuation">,</span> on_error<span class="token punctuation">,</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26</p><p>（3）将paysuccess.html拷贝到templates文件夹 。</p><h2 id="_5-测试访问路径" tabindex="-1"><a class="header-anchor" href="#_5-测试访问路径"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_5-%E6%B5%8B%E8%AF%95%E8%AE%BF%E9%97%AE%E8%B7%AF%E5%BE%84" target="_blank" rel="noopener noreferrer">#</a>5. 测试访问路径</span></a></h2><p>1重启ydles_service_pay ydles_service_order</p><p>2添加商品： http://localhost:8001/api/cart/addCart?skuId=100000006163&amp;num=10</p><p>3查看购物车： http://localhost:8001/api/wcart/list</p><p>4点击：结算---》提交订单--》选择微信支付--》跳到二维码页面--》扫描二维码</p><p>5 支付完成 回传订单数据</p><p>6确定后，跳转至支付成功页面</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211222014108729.e4521203.png" alt="image-20211222014108729"></p><p>总结：</p><p>1了解微信支付怎么做</p><p>第三方接口平台对接：第三方官网文档一步一步做</p><p>2申请支付的二维码</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211221144256113.660d33ae.png" alt="image-20211221144256113"></p><p>3支付回推</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211221203416360.5ddbce4d.png" alt="image-20211221203416360"></p><p>natapp 内网穿透</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211221235105274.1009b630.png" alt="image-20211221235105274"></p><p>4用户回推 支付成功消息</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211222013147811.3cb78af5.png" alt="image-20211222013147811"></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211222014807522.f05b12ce.png" alt="image-20211222014807522"></p><h2 id="第14章-订单处理" tabindex="-1"><a class="header-anchor" href="#第14章-订单处理"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#%E7%AC%AC14%E7%AB%A0-%E8%AE%A2%E5%8D%95%E5%A4%84%E7%90%86" target="_blank" rel="noopener noreferrer">#</a>第14章 订单处理</span></a></h2><p><strong>角色</strong>:还是订单组，资深架构师。</p><h2 id="课程内容-1" tabindex="-1"><a class="header-anchor" href="#课程内容-1"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#%E8%AF%BE%E7%A8%8B%E5%86%85%E5%AE%B9-1" target="_blank" rel="noopener noreferrer">#</a>课程内容：</span></a></h2><ul><li>通过rabbitmq的延迟消息完成超时订单处理</li><li>完成批量发货功能，了解第三方物流系统</li><li>完成自动收货功能</li></ul><h2 id="_1-超时未支付订单处理-重点" tabindex="-1"><a class="header-anchor" href="#_1-超时未支付订单处理-重点"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-%E8%B6%85%E6%97%B6%E6%9C%AA%E6%94%AF%E4%BB%98%E8%AE%A2%E5%8D%95%E5%A4%84%E7%90%86-%E9%87%8D%E7%82%B9" target="_blank" rel="noopener noreferrer">#</a>1. 超时未支付订单处理-重点</span></a></h2><h3 id="_1-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_1-1-需求分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>1.1 需求分析</span></a></h3><p>超过限定时间并未支付的订单，我们需要进行超时订单的处理：先调用微信支付api，查询该订单的支付状态。如果未支付调用关闭订单的api，并修改订单状态为已关闭，并回滚库存数。如果该订单已经支付，则做补偿操作（修改订单状态和记录）。</p><h3 id="_1-2-实现思路" tabindex="-1"><a class="header-anchor" href="#_1-2-实现思路"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-2-%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF" target="_blank" rel="noopener noreferrer">#</a>1.2 实现思路</span></a></h3><p>如何获取超过限定时间的订单？我们可以使用<strong>延迟消息</strong>队列（死信队列）来实现。</p><p>所谓延迟消息队列，就是消息的生产者发送的消息并不会立刻被消费，而是在设定的时间之后才可以消费。</p><p>我们可以在订单创建时发送一个延迟消息，消息为订单号，系统会在限定时间之后取出这个消息，然后查询订单的支付状态，根据结果做出相应的处理。</p><h3 id="_1-3-rabbitmq延迟消息" tabindex="-1"><a class="header-anchor" href="#_1-3-rabbitmq延迟消息"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-3-rabbitmq%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF" target="_blank" rel="noopener noreferrer">#</a>1.3 rabbitmq延迟消息</span></a></h3><p>使用RabbitMQ来实现延迟消息必须先了解RabbitMQ的两个概念：消息的<strong>TTL</strong>和<strong>死信Exchange</strong>，通过这两者的组合来实现上述需求。</p><h4 id="_1-3-1-消息的ttl-time-to-live" tabindex="-1"><a class="header-anchor" href="#_1-3-1-消息的ttl-time-to-live"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-3-1-%E6%B6%88%E6%81%AF%E7%9A%84ttl-time-to-live" target="_blank" rel="noopener noreferrer">#</a>1.3.1 消息的TTL（Time To Live）</span></a></h4><p>消息的TTL就是消息的存活时间。RabbitMQ可以对队列和消息分别设置TTL。对队列设置就是队列没有消费者连着的保留时间，也可以对每一个单独的消息做单独的设置。超过了这个时间，我们认为这个消息就死了，称之为死信。</p><p>我们创建一个队列queue.temp，在Arguments 中添加x-message-ttl 为5000 （单位是毫秒），那每一个进入这个队列的消息在5秒后会消失。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211227105923204.9990ae46.png" alt="image-20211227105923204"></p><h4 id="_1-3-2-死信交换器-dead-letter-exchanges" tabindex="-1"><a class="header-anchor" href="#_1-3-2-死信交换器-dead-letter-exchanges"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-3-2-%E6%AD%BB%E4%BF%A1%E4%BA%A4%E6%8D%A2%E5%99%A8-dead-letter-exchanges" target="_blank" rel="noopener noreferrer">#</a>1.3.2 死信交换器 Dead Letter Exchanges</span></a></h4><p><strong>面试：什么时候死信？</strong></p><p>一个消息在满足如下条件下，会进死信交换机，记住这里是交换机而不是队列，一个交换机可以对应很多队列。</p><p><strong>（1）</strong> 一个消息被Consumer拒收了，并且reject方法的参数里requeue是false。也就是说不会被再次放在队列里，被其他消费者使用。</p><p>**（2）**<strong>上面的消息的TTL到了，消息过期了</strong>。</p><p>**（3）**队列的长度限制满了。排在前面的消息会被丢弃或者扔到死信交换机上。</p><p>Dead Letter Exchange其实就是一种普通的exchange，和创建其他exchange没有两样。只是在某一个设置Dead Letter Exchange的队列中有消息过期了，会自动触发消息的转发，发送到Dead Letter Exchange中去。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211227111258327.bfab614d.png" alt="image-20211227111258327"></p><p>我们现在可以测试一下延迟队列。</p><p>（1）创建死信交换器 exchange.ordertimeout （<strong>fanout</strong>）</p><p>（2）创建队列queue.ordertimeout</p><p>（3）建立死信交换器 exchange.ordertimeout 与队列queue.ordertimeout 之间的绑定</p><p>（4）创建队列queue.ordercreate，Arguments添加</p><p>x-message-ttl=10000</p><p>x-dead-letter-exchange： exchange.ordertimeout</p><p>（5）测试：向queue.ordercreate队列添加消息，等待10秒后消息从queue.ordercreate队列消失，</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211227111214185.813f14aa.png" alt="image-20211227111214185"></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211227111247704.898b8747.png" alt="image-20211227111247704"></p><h3 id="_1-4-代码实现" tabindex="-1"><a class="header-anchor" href="#_1-4-代码实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-4-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>1.4 代码实现</span></a></h3><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211227113439128.705912ed.png" alt="image-20211227113439128"></p><h4 id="_1-4-1-微信支付-关闭订单" tabindex="-1"><a class="header-anchor" href="#_1-4-1-微信支付-关闭订单"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-4-1-%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98-%E5%85%B3%E9%97%AD%E8%AE%A2%E5%8D%95" target="_blank" rel="noopener noreferrer">#</a>1.4.1 微信支付-关闭订单</span></a></h4><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211227114511089.d5943859.png" alt="image-20211227114511089"></p><p>（1）WxPayController新增方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 关闭微信订单</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">orderId</span></span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@PutMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/close/{orderId}&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">closeOrder</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> orderId<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">Map</span> map <span class="token operator">=</span> wxPayService<span class="token punctuation">.</span><span class="token function">closeOrder</span><span class="token punctuation">(</span> orderId <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>map <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10</p><p>（2）ydles_service_pay的WxPayService新增方法定义</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 关闭订单</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">orderId</span></span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token class-name">Map</span> <span class="token function">closeOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6</p><p>（3）ydles_service_pay的 WxPayServiceImpl实现该方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Map</span> <span class="token function">closeOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">Map</span> map<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span> <span class="token string">&quot;out_trade_no&quot;</span><span class="token punctuation">,</span>orderId <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span>  wxPay<span class="token punctuation">.</span><span class="token function">closeOrder</span><span class="token punctuation">(</span> map <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11</p><p>（4）ydles_service_pay_api的WxPayFeign新增方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 关闭微信订单</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">orderId</span></span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@PutMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/wxpay/close/{orderId}&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">closeOrder</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;orderId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><h4 id="_1-4-2-微信支付-查询订单" tabindex="-1"><a class="header-anchor" href="#_1-4-2-微信支付-查询订单"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-4-2-%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98-%E6%9F%A5%E8%AF%A2%E8%AE%A2%E5%8D%95" target="_blank" rel="noopener noreferrer">#</a>1.4.2 微信支付-查询订单</span></a></h4><p>（1）WxPayController新增方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 查询微信订单</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">orderId</span></span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/query/{orderId}&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryOrder</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> orderId<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">Map</span> map <span class="token operator">=</span> wxPayService<span class="token punctuation">.</span><span class="token function">queryOrder</span><span class="token punctuation">(</span> orderId <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>map <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10</p><p>（2）WxPayFeign新增方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 查询微信订单</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">orderId</span></span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/wxpay/query/{orderId}&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryOrder</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;orderId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><p>商品服务回滚库存</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211227115532726.c3ad6c7a.png" alt="image-20211227115532726"></p><p>（1）dao</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">//回滚库存</span></span>
<span class="line">    <span class="token annotation punctuation">@Update</span><span class="token punctuation">(</span><span class="token string">&quot;update tb_sku set num=num+#{num},sale_num=sale_num-#{num} where id=#{skuId}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">void</span> <span class="token function">resumeStockNum</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> skuId<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3</p><p>（2）service</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">//回滚库存</span></span>
<span class="line">    <span class="token keyword">void</span> <span class="token function">resumeStockNum</span><span class="token punctuation">(</span><span class="token class-name">String</span> skuId<span class="token punctuation">,</span><span class="token class-name">Integer</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><p>（3）serivceImpl</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">resumeStockNum</span><span class="token punctuation">(</span><span class="token class-name">String</span> skuId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> num<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        skuMapper<span class="token punctuation">.</span><span class="token function">resumeStockNum</span><span class="token punctuation">(</span>skuId<span class="token punctuation">,</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p>(4)controller</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">//回滚库存</span></span>
<span class="line">    <span class="token annotation punctuation">@PutMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/resumeStockNum&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">resumeStockNum</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> skuId<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">)</span><span class="token class-name">Integer</span> num<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        skuService<span class="token punctuation">.</span><span class="token function">resumeStockNum</span><span class="token punctuation">(</span>skuId<span class="token punctuation">,</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span><span class="token string">&quot;回滚库存成功！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6</p><p>(4)skuFeign</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@PutMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/sku/resumeStockNum&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">resumeStockNum</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> skuId<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">)</span><span class="token class-name">Integer</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><h4 id="_1-4-3-订单关闭逻辑" tabindex="-1"><a class="header-anchor" href="#_1-4-3-订单关闭逻辑"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-4-3-%E8%AE%A2%E5%8D%95%E5%85%B3%E9%97%AD%E9%80%BB%E8%BE%91" target="_blank" rel="noopener noreferrer">#</a>1.4.3 订单关闭逻辑</span></a></h4><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211227121318859.ef07bedb.png" alt="image-20211227121318859"></p><p>如果为未支付，查询微信订单</p><p>如果确认为未支付，调用关闭本地订单（ 修改订单表的订单状态、记录订单日志、恢复商品表库存）和微信订单的逻辑。</p><p>如果为已支付进行状态补偿。</p><p>（1）ydles_service_order新增依赖</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ydles_service_pay_api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p>（2）ydles_service_order的OrderService新增方法定义</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 关闭订单</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">orderId</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">closeOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p>（3）OrderServiceImpl实现该方法</p><p>实现逻辑：</p><p>1）根据id查询订单信息，判断订单是否存在，订单支付状态是否为未支付</p><p>2）基于微信查询订单支付状态</p><p>2.1）如果为success，则修改订单状态</p><p>2.2）如果为未支付，则修改订单，新增日志，恢复库存，关闭订单</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">PayFeign</span> payFeign<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//关闭订单</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token annotation punctuation">@Transactional</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">closeOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;关闭订单开启了:&quot;</span><span class="token operator">+</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">Order</span> order <span class="token operator">=</span> orderMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span>order<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;这笔订单不存在！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>order<span class="token punctuation">.</span><span class="token function">getOrderStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;这笔订单不用关闭&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;关闭订单逻辑通过校验：&quot;</span><span class="token operator">+</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//1支付服务 微信查询订单</span></span>
<span class="line">        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> wxQueryMap <span class="token operator">=</span> payFeign<span class="token punctuation">.</span><span class="token function">queryOrder</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//2.1支付了 order表修改</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span>wxQueryMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;trade_state&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;SUCCESS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">updatePayStatus</span><span class="token punctuation">(</span>orderId<span class="token punctuation">,</span>wxQueryMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;transaction_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;已支付&quot;</span><span class="token operator">+</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//2.2未支付 关闭订单微信 内部回滚库存 订单状态关闭</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span>wxQueryMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;trade_state&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;NOTPAY&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//1关闭订单微信</span></span>
<span class="line">            payFeign<span class="token punctuation">.</span><span class="token function">closeOrder</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">//2订单状态关闭</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;本项目关闭订单了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            order<span class="token punctuation">.</span><span class="token function">setOrderStatus</span><span class="token punctuation">(</span><span class="token string">&quot;9&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//订单状态 0下单 1支付 2发货 3收货 4退货 9关闭</span></span>
<span class="line">            order<span class="token punctuation">.</span><span class="token function">setCloseTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            orderMapper<span class="token punctuation">.</span><span class="token function">updateByPrimaryKeySelective</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">//orderLog表 新增数据</span></span>
<span class="line">            <span class="token class-name">OrderLog</span> orderLog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            orderLog<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>idWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            orderLog<span class="token punctuation">.</span><span class="token function">setOperater</span><span class="token punctuation">(</span><span class="token string">&quot;system&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            orderLog<span class="token punctuation">.</span><span class="token function">setOperateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            orderLog<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            orderLog<span class="token punctuation">.</span><span class="token function">setOrderStatus</span><span class="token punctuation">(</span><span class="token string">&quot;9&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            orderLog<span class="token punctuation">.</span><span class="token function">setPayStatus</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            orderLog<span class="token punctuation">.</span><span class="token function">setConsignStatus</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            orderLog<span class="token punctuation">.</span><span class="token function">setRemarks</span><span class="token punctuation">(</span><span class="token string">&quot;超时未支付！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            orderLogMapper<span class="token punctuation">.</span><span class="token function">insertSelective</span><span class="token punctuation">(</span>orderLog<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">            <span class="token comment">//3内部回滚库存</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">//查出来这笔订单的所有购物项</span></span>
<span class="line">            <span class="token class-name">OrderItem</span> orderItem<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">OrderItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            orderItem<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItem</span><span class="token punctuation">&gt;</span></span> orderItemList <span class="token operator">=</span> orderItemMapper<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>orderItem<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">OrderItem</span> orderItem1 <span class="token operator">:</span> orderItemList<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                skuFeign<span class="token punctuation">.</span><span class="token function">resumeStock</span><span class="token punctuation">(</span>orderItem1<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>orderItem1<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//还有各种支付状态 都需要考虑。REFUND CLOSED USERPAYING</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69</p><h4 id="_1-4-4-延迟消息处理" tabindex="-1"><a class="header-anchor" href="#_1-4-4-延迟消息处理"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-4-4-%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86" target="_blank" rel="noopener noreferrer">#</a>1.4.4 延迟消息处理</span></a></h4><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211227170736337.701672bd.png" alt="image-20211227170736337"></p><p>从消息队列queue.ordertimeout 中提取消息</p><p>（1）修改OrderServiceImpl的add方法，追加代码，实现mq发送</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;queue.ordercreate&quot;</span><span class="token punctuation">,</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>（2）ydles_service_order新建监听类</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderTimeoutListener</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 更新支付状态</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">orderId</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">&quot;queue.ordertimeout&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">closeOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;接收到关闭订单消息：&quot;</span><span class="token operator">+</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            orderService<span class="token punctuation">.</span><span class="token function">closeOrder</span><span class="token punctuation">(</span> orderId <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20</p><p><strong>测试关键点</strong>：</p><p>1 10秒后，能不能order服务接受消息</p><p>2 微信支付了，本地order没支付 ---》下单，回调接口写错。</p><p>3 没支付---------》二维码页面，等10秒。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAJsAAABdCAYAAACy0BQlAAAGrUlEQVR4nO3cX2hb1wHH8e9dS81gawadoB0MFkWKsiWGPISOKDQUPFhlyuKXxWYM0zVUCh7EcjqTBWo/2Bte8DbfGFZihaxe2EPsvbglk7JSU8jAJqUPgTl/FF2cQCnLUAv2ozrG3YP++FqRFNu5OjLO7wN6sO/5J/PzOUfX59paWVlxETHga60egDw9FDYxRmETYxQ2MUZhE2MUNjFGYRNjFDYxRmETYxQ2MUZhE2MUNjFGYRNjFDYxRmETY579z3+//sSNPLP6Gf/b9V0fhiN+e2b1M/bs2dPqYQCa2cQghU2MUdjEGIVNjNm+YZvvIxKb5EGrxyG+2b5hkx1HYcNhOtbG8LzfZaWawibGNCls1xgOtBGpvPq4XrlWnh1KZSr7sqo6PZcattl9wXlMe496cOGVqjFdYziwn7FPYabHU3d5km5PX8WZrEbZ5Um6ve+t6utH+2s1BztqkchkSFgWVumVyHiL2EQfuVasF7WdtXKZBFbUxqE2x45W2rCsBBkyPOv/G7rGcOAY2dFbZE+Git+a7yMS6ONi/l2OlkrN9HzAxXyBEU8drhTIdhSvX3+7jbdue9v8LcEbBbJBKAZsP8PhAiMdtdqrYXmSM0PtXMz/szIGgKP5WwRj+1n+Vbkth+k/wbl8ge+Vx97Tx4/y7zJSXXZ5sv6PoU5/20Gqc4606zIFxdB0Juhyp4jhYI/DZdclVHUtORRnYPQqTjJJCMjMpYgPlcpVc2x6B9pJuwvEPN/2f2ab/4CZQ+OcO+kZRsdpzh66xEeevU73lbXgleu82bF2/WjnifVt8gljPyzPEsUZJptzardXS3AvES7xVuAVppcbFQzxxh9OQXlWemSG3aAN92dePD21FoLYIBOHU8xlAEIkp5JQnpU6U2uVYl3EF2e56gBkmEvF6YpVt1wSitBOik4rincyNLhne5ng7ieofmicf+QLZD2vmZM1f6/qeI2RfIFs/j34ZRuReiEoLaFneK/Yz41xDm5pwBvsbzspLaG9XMZ1XdzcBIcrF2MMTsDsVQfHHiUV76Je1iDGlOviupeh18Iqhc7/sHX8hO5PBzlzwRPp+T8yxk95Ndi4zp8rM5/D9O8vNbgO19/e5B5oeZLpeYAQb2RucfbQJyzfr1Hu/l1uembmBx/+jZsNG/4Xy6UQrSu70f5aIDW3tklz7F4GFkuzVO4Oi4cnuJwsvnfn6iyLnnqh14/D7DjjszAxWD9qODZ2eaZcyDFxeJE7uabMbK8xkn+fyNB+z2YfLmZOFfdA9epcOVHceAfaiAR+AcdOrL9+Y5xsz9qm/aPOxyyb1YKnCKY9y/AP3i/t0UK8euzltU1/x2nOMsiPS/2cybV7ZraqssFTnBulsryvK1u3v9aLM1fZvIcH2km7pWU1NsgEA4RL13rvtHtmNiCUZKg9RYrjvN5oUQklicyVPxyEGWhPMxUDK5svPPG/zNIRo+1r/REjBzsa5s6Qy1SDiamRTMJi9Ps5FpKb2cIUNeHTqOxYjs1oKs6Qu/mgwY68qVt9j897r0y2KpOwsMIDtHs/ybL+fl3N+3YeWkZ3OJ3UlaeSwibGWI7j6B84ixGW67pPHLbV1VW+9bt/+zEe8dnKr19i165drR4GoGVUDFLYxBiFTYxR2MQYhU2MaU7YXgyQG9uHO7YPd2w39otN6UW2xPsnpiOcr3euuwmaELbnSfe/QG7mLtbZu1gzX9H/swBR/zuSTXM4f6STJTtXPByZPkAynKDOnzJ953/YDn6TWP5LflM+RXjzC87zDY5rdms95+/MLsR5p790aiM2iB0tHwlvPkN7tjb2Kmytl7vNwrrj3CH2HoCle2bWUv/D9vArnMALvFM+snrw2/QHfO9FtsC5t9TS/v0/PPkwT3jmOdzufbjdQP5Lzt8qwEPfe5JNCu09ALcfX65ZmnNS9+bnWJUnP54nPfYcc39tSk+yWUv3cIiVnvd0uLcEB7q2dvJ2s5q+Z4v//DuEP/6C1OOLSrPFBrFJMl7+QJAZJ4lNowel/NSEma0N+/Tuyj7N+fg+4Q8L/ncjWxCi/y82R8IWFgBx0m5/7afam0BHjHY4HTGSp5LCJsYobGKMwibGKGxijLWysqKnq8QIX259iGyEllExRmETYxQ2MUZhE2MUNjFGYRNjFDYxRmETYxQ2MUZhE2MUNjFGYRNjFDYxRmETYxQ2MUZhE2MUNjFGYRNjFDYxRmETYxQ2MUZhE2MUNjFGYRNjFDYxRmETYxQ2MUZhE2MUNjFGYRNjFDYxRmETY/4PQZVWqzpA5L4AAAAASUVORK5CYII=" alt="image-20211227172604859"></p><h2 id="_2-订单批量发货" tabindex="-1"><a class="header-anchor" href="#_2-订单批量发货"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-%E8%AE%A2%E5%8D%95%E6%89%B9%E9%87%8F%E5%8F%91%E8%B4%A7" target="_blank" rel="noopener noreferrer">#</a>2. 订单批量发货</span></a></h2><p>角色：店主</p><h3 id="_2-1-批量发货业务逻辑" tabindex="-1"><a class="header-anchor" href="#_2-1-批量发货业务逻辑"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-1-%E6%89%B9%E9%87%8F%E5%8F%91%E8%B4%A7%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91" target="_blank" rel="noopener noreferrer">#</a>2.1 批量发货业务逻辑</span></a></h3><h4 id="_2-1-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_2-1-1-需求分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-1-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>2.1.1 需求分析</span></a></h4><p>实现批量发货的业务逻辑</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211227173827318.03d9a628.png" alt="image-20211227173827318"></p><h4 id="_2-1-2-代码实现" tabindex="-1"><a class="header-anchor" href="#_2-1-2-代码实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-1-2-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>2.1.2 代码实现</span></a></h4><p>（1）OrderController新增方法</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">[</span>
<span class="line">{</span>
<span class="line">orderId:8345,</span>
<span class="line">shipping_name:顺丰,</span>
<span class="line">shipping_code:123,</span>
<span class="line">.......</span>
<span class="line">},{</span>
<span class="line"></span>
<span class="line">},{</span>
<span class="line"></span>
<span class="line">}</span>
<span class="line">]</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 批量发货</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">orders</span>  订单列表</span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/batchSend&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">batchSend</span><span class="token punctuation">(</span> <span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> orders<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    orderService<span class="token punctuation">.</span><span class="token function">batchSend</span><span class="token punctuation">(</span> orders <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span><span class="token string">&quot;发货成功&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9</p><p>（2）OrderService新增方法定义</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 批量发货</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">orders</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">batchSend</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> orders<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p>（3）OrderServiceImpl实现该方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token annotation punctuation">@Transactional</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">batchSend</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> orderList<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//循环1 物流公司和物流单号 不能为空</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Order</span> order <span class="token operator">:</span> orderList<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;订单号为空！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getShippingName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token keyword">null</span><span class="token operator">||</span>order<span class="token punctuation">.</span><span class="token function">getShippingCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;物流公司或单号为空！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//循环2 查询订单状态 校验</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Order</span> order <span class="token operator">:</span> orderList<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">Order</span> queryOrder <span class="token operator">=</span> orderMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>queryOrder<span class="token punctuation">.</span><span class="token function">getOrderStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token operator">!</span>queryOrder<span class="token punctuation">.</span><span class="token function">getConsignStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;订单状态不对，不能发货！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//循环3 发货</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Order</span> order <span class="token operator">:</span> orderList<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            order<span class="token punctuation">.</span><span class="token function">setOrderStatus</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            order<span class="token punctuation">.</span><span class="token function">setConsignStatus</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            order<span class="token punctuation">.</span><span class="token function">setUpdateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            order<span class="token punctuation">.</span><span class="token function">setConsignTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            orderMapper<span class="token punctuation">.</span><span class="token function">updateByPrimaryKeySelective</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">//orderLog表 新增数据</span></span>
<span class="line">            <span class="token class-name">OrderLog</span> orderLog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            orderLog<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>idWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            orderLog<span class="token punctuation">.</span><span class="token function">setOperater</span><span class="token punctuation">(</span><span class="token string">&quot;店小二&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            orderLog<span class="token punctuation">.</span><span class="token function">setOperateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            orderLog<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            orderLog<span class="token punctuation">.</span><span class="token function">setOrderStatus</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            orderLog<span class="token punctuation">.</span><span class="token function">setPayStatus</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            orderLog<span class="token punctuation">.</span><span class="token function">setConsignStatus</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            orderLog<span class="token punctuation">.</span><span class="token function">setRemarks</span><span class="token punctuation">(</span><span class="token string">&quot;批量发货&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            orderLogMapper<span class="token punctuation">.</span><span class="token function">insertSelective</span><span class="token punctuation">(</span>orderLog<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43</p><h3 id="_2-2-对接第三方物流-了解" tabindex="-1"><a class="header-anchor" href="#_2-2-对接第三方物流-了解"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-2-%E5%AF%B9%E6%8E%A5%E7%AC%AC%E4%B8%89%E6%96%B9%E7%89%A9%E6%B5%81-%E4%BA%86%E8%A7%A3" target="_blank" rel="noopener noreferrer">#</a>2.2 对接第三方物流（了解）</span></a></h3><p>当我们在电商平台购买了商品后，一般会非常关心商品的物流轨迹。那这些信息是如何获取的呢？我们需要对接第三方的物流系统。比较常用的有菜鸟物流、快递鸟等。</p><p>我们这里推荐使用快递鸟 http://www.kdniao.com</p><p>我们可以使用快递鸟提供的以下接口：</p><p>（1）预约取件API</p><p>预约取件API为用户提供了在线下单，预约快递员上门揽件的功能，为用户解决在线发货需求。</p><p>我们可以在实现批量发货功能后调用预约取件API</p><p>（2）即时查询API</p><p>物流查询API提供实时查询物流轨迹的服务，用户提供运单号和快递公司，即可查询当前时刻的最新物流轨迹。</p><p>用户可以在用户中心调用此API完成物流信息的查询，电商平台也可以调用此API完成运单的跟踪。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211227180923988.743ab9cb.png" alt="image-20211227180923988"></p><h2 id="_3-确认收货与自动收货" tabindex="-1"><a class="header-anchor" href="#_3-确认收货与自动收货"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-%E7%A1%AE%E8%AE%A4%E6%94%B6%E8%B4%A7%E4%B8%8E%E8%87%AA%E5%8A%A8%E6%94%B6%E8%B4%A7" target="_blank" rel="noopener noreferrer">#</a>3. 确认收货与自动收货</span></a></h2><h3 id="_3-1-确认收货" tabindex="-1"><a class="header-anchor" href="#_3-1-确认收货"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-1-%E7%A1%AE%E8%AE%A4%E6%94%B6%E8%B4%A7" target="_blank" rel="noopener noreferrer">#</a>3.1 确认收货</span></a></h3><h4 id="_3-1-1-需求分析与实现思路" tabindex="-1"><a class="header-anchor" href="#_3-1-1-需求分析与实现思路"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-1-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90%E4%B8%8E%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF" target="_blank" rel="noopener noreferrer">#</a>3.1.1 需求分析与实现思路</span></a></h4><p>当物流公司将货物送到了用户收货地址之后，需要用户点击确认收货，当用户点击了确认收货之后，会修改订单状态为已完成</p><h4 id="_3-1-2-代码实现" tabindex="-1"><a class="header-anchor" href="#_3-1-2-代码实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-1-2-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>3.1.2 代码实现</span></a></h4><p>（1）OrderController新增方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 确认收货 </span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">orderId</span>  订单号</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">operator</span> 操作者</span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@PutMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/take/{orderId}/operator/{operator}&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> orderId<span class="token punctuation">,</span> <span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> operator<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    orderService<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span> orderId<span class="token punctuation">,</span>operator <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span><span class="token string">&quot;&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11</p><p>（2）OrderService新增方法定义</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 确认收货</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">orderId</span></span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">operator</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">confirmTask</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">,</span><span class="token class-name">String</span> operator<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6</p><p>（3）OrderServiceImpl实现该方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">confirmTask</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">,</span> <span class="token class-name">String</span> operator<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">Order</span> order <span class="token operator">=</span> orderMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span> orderId <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span>order<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span> <span class="token string">&quot;订单不存在&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span> order<span class="token punctuation">.</span><span class="token function">getConsignStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span> <span class="token string">&quot;订单未发货&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    order<span class="token punctuation">.</span><span class="token function">setConsignStatus</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//已送达</span></span>
<span class="line">    order<span class="token punctuation">.</span><span class="token function">setOrderStatus</span><span class="token punctuation">(</span> <span class="token string">&quot;3&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//已完成</span></span>
<span class="line">    order<span class="token punctuation">.</span><span class="token function">setUpdateTime</span><span class="token punctuation">(</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    order<span class="token punctuation">.</span><span class="token function">setEndTime</span><span class="token punctuation">(</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//交易结束</span></span>
<span class="line">    orderMapper<span class="token punctuation">.</span><span class="token function">updateByPrimaryKeySelective</span><span class="token punctuation">(</span> order <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//记录订单变动日志</span></span>
<span class="line">    <span class="token class-name">OrderLog</span> orderLog<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">OrderLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    orderLog<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span> idWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    orderLog<span class="token punctuation">.</span><span class="token function">setOperateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//当前日期</span></span>
<span class="line">    orderLog<span class="token punctuation">.</span><span class="token function">setOperater</span><span class="token punctuation">(</span> operator <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//系统？管理员？用户？</span></span>
<span class="line">    orderLog<span class="token punctuation">.</span><span class="token function">setOrderStatus</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    orderLog<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    orderLogMapper<span class="token punctuation">.</span><span class="token function">insertSelective</span><span class="token punctuation">(</span>orderLog<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23</p><h3 id="_3-2-自动收货处理" tabindex="-1"><a class="header-anchor" href="#_3-2-自动收货处理"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-2-%E8%87%AA%E5%8A%A8%E6%94%B6%E8%B4%A7%E5%A4%84%E7%90%86" target="_blank" rel="noopener noreferrer">#</a>3.2 自动收货处理</span></a></h3><h4 id="_3-2-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_3-2-1-需求分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-2-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>3.2.1 需求分析</span></a></h4><p>如果用户在15天（可以在订单配置表中配置）没有确认收货，系统将自动收货。如何实现？我们这里采用定时任务springTask来实现。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211227184231554.597edc2b.png" alt="image-20211227184231554"></p><p><strong>逻辑</strong>：每天凌晨2点，查询order,发货15天，自动收货。</p><p>每天凌晨1点，删除生产环境，删除log。</p><p>技术：</p><p>spring---&gt;quartz</p><p>spring task 定时任务</p><p>xxl-job</p><h4 id="_3-2-2-cron表达式" tabindex="-1"><a class="header-anchor" href="#_3-2-2-cron表达式"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-2-2-cron%E8%A1%A8%E8%BE%BE%E5%BC%8F" target="_blank" rel="noopener noreferrer">#</a>3.2.2 Cron表达式</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">&quot;0 * * * * *&quot;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>Cron表达式是一个字符串，字符串分为七个部分，每一个域代表一个含义。</p><p>Cron表达式7个域格式为： 秒 分 小时 日 月 星期几 年</p><p>Cron表达式6个域格式为： 秒 分 小时 日 月 周</p><table><thead><tr><th>序号</th><th>说明</th><th>是否必填</th><th>允许填写的值</th><th>允许的通配符</th></tr></thead><tbody><tr><td>1</td><td>秒</td><td>是</td><td>0-59</td><td>, - * /</td></tr><tr><td>2</td><td>分</td><td>是</td><td>0-59</td><td>, - * /</td></tr><tr><td>3</td><td>小时</td><td>是</td><td>0-23</td><td>, - * /</td></tr><tr><td>4</td><td>日</td><td>是</td><td>1-31</td><td>, - * ? / L W</td></tr><tr><td>5</td><td>月</td><td>是</td><td>1-12或JAN-DEC</td><td>, - * /</td></tr><tr><td>6</td><td>星期几</td><td>是</td><td>1-7或SUN-SAT</td><td>, - * ? / L W</td></tr><tr><td>7</td><td>年</td><td>否</td><td>empty 或1970-2099</td><td>, - * /</td></tr></tbody></table><p>使用说明：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">通配符说明:</span>
<span class="line">* 表示所有值. 例如:在分的字段上设置 &quot;*&quot;,表示每一分钟都会触发。</span>
<span class="line"></span>
<span class="line">? 表示不指定值。使用的场景为不需要关心当前设置这个字段的值。</span>
<span class="line"></span>
<span class="line">例如:要在每月的10号触发一个操作，但不关心是周几，所以需要周位置的那个字段设置为&quot;?&quot; 具体设置为 0 0 0 10 * ?</span>
<span class="line"></span>
<span class="line">- 表示区间。例如 在小时上设置 &quot;10-12&quot;,表示 10,11,12点都会触发。</span>
<span class="line"></span>
<span class="line">, 表示指定多个值，例如在周字段上设置 &quot;MON,WED,FRI&quot; 表示周一，周三和周五触发</span>
<span class="line"></span>
<span class="line">/ 用于递增触发。如在秒上面设置&quot;5/15&quot; 表示从5秒开始，每增15秒触发(5,20,35,50)。 在月字段上设置&#39;1/3&#39;所示每月1号开始，每隔三天触发一次。</span>
<span class="line"></span>
<span class="line">L 表示最后的意思。在日字段设置上，表示当月的最后一天(依据当前月份，如果是二月还会依据是否是润年[leap]), 在周字段上表示星期六，相当于&quot;7&quot;或&quot;SAT&quot;。如果在&quot;L&quot;前加上数字，则表示该数据的最后一个。例如在周字段上设置&quot;6L&quot;这样的格式,则表示“本月最后一个星期五&quot;</span>
<span class="line"></span>
<span class="line">W 表示离指定日期的最近那个工作日(周一至周五). 例如在日字段上设置&quot;15W&quot;，表示离每月15号最近的那个工作日触发。如果15号正好是周六，则找最近的周五(14号)触发, 如果15号是周未，则找最近的下周一(16号)触发.如果15号正好在工作日(周一至周五)，则就在该天触发。如果指定格式为 &quot;1W&quot;,它则表示每月1号往后最近的工作日触发。如果1号正是周六，则将在3号下周一触发。(注，&quot;W&quot;前只能设置具体的数字,不允许区间&quot;-&quot;).</span>
<span class="line"></span>
<span class="line"># 序号(表示每月的第几个周几)，例如在周字段上设置&quot;6#3&quot;表示在每月的第三个周六.注意如果指定&quot;#5&quot;,正好第五周没有周六，则不会触发该配置(用在母亲节和父亲节再合适不过了) ；</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18</p><p>常用表达式</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">0 0 10,14,16 * * ? 每天上午10点，下午2点，4点 </span>
<span class="line">0 0/30 9-17 * * ? 朝九晚五工作时间内每半小时 </span>
<span class="line">0 0 12 ? * WED 表示每个星期三中午12点 </span>
<span class="line">&quot;0 0 12 * * ?&quot; 每天中午12点触发 </span>
<span class="line">&quot;0 15 10 ? * *&quot; 每天上午10:15触发 </span>
<span class="line">&quot;0 15 10 * * ?&quot; 每天上午10:15触发 </span>
<span class="line">&quot;0 15 10 * * ? *&quot; 每天上午10:15触发 </span>
<span class="line">&quot;0 15 10 * * ? 2005&quot; 2005年的每天上午10:15触发 </span>
<span class="line">&quot;0 * 14 * * ?&quot; 在每天下午2点到下午2:59期间的每1分钟触发 </span>
<span class="line">&quot;0 0/5 14 * * ?&quot; 在每天下午2点到下午2:55期间的每5分钟触发 </span>
<span class="line">&quot;0 0/5 14,18 * * ?&quot; 在每天下午2点到2:55期间和下午6点到6:55期间的每5分钟触发 </span>
<span class="line">&quot;0 0-5 14 * * ?&quot; 在每天下午2点到下午2:05期间的每1分钟触发 </span>
<span class="line">&quot;0 10,44 14 ? 3 WED&quot; 每年三月的星期三的下午2:10和2:44触发 </span>
<span class="line">&quot;0 15 10 ? * MON-FRI&quot; 周一至周五的上午10:15触发 </span>
<span class="line">&quot;0 15 10 15 * ?&quot; 每月15日上午10:15触发 </span>
<span class="line">&quot;0 15 10 L * ?&quot; 每月最后一日的上午10:15触发 </span>
<span class="line">&quot;0 15 10 ? * 6L&quot; 每月的最后一个星期五上午10:15触发 </span>
<span class="line">&quot;0 15 10 ? * 6L 2002-2005&quot; 2002年至2005年的每月的最后一个星期五上午10:15触发 </span>
<span class="line">&quot;0 15 10 ? * 6#3&quot; 每月的第三个星期五上午10:15触发</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19</p><h4 id="_3-2-3-代码实现" tabindex="-1"><a class="header-anchor" href="#_3-2-3-代码实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-2-3-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>3.2.3 代码实现</span></a></h4><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211227195336675.d630d236.png" alt="image-20211227195336675"></p><h5 id="_3-2-3-1-发送消息" tabindex="-1"><a class="header-anchor" href="#_3-2-3-1-发送消息"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-2-3-1-%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF" target="_blank" rel="noopener noreferrer">#</a>3.2.3.1 发送消息</span></a></h5><p>（1）创建order_tack队列 。</p><p>（2）创建工程ydles_task，引入依赖</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-rabbit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10</p><p>（3）创建配置文件 application.yml</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">server</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9202</span></span>
<span class="line"><span class="token key atrule">spring</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">application</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> task</span>
<span class="line">  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.200.128</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><p>（4）创建启动类 com.ydles.task</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@SpringBootApplication</span></span>
<span class="line"><span class="token annotation punctuation">@EnableScheduling</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TaskApplication</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span> <span class="token class-name">TaskApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8</p><p><code>@EnableScheduling</code> 注解用于开启任务调度</p><p>（5）创建com.ydles.task包，包下创建类OrderTask</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderTask</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 订单自动收货</span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">&quot;0 0 0 * * ?&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">autoTake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>  <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;order_tack&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;-&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16</p><h5 id="_3-2-3-2-接收消息" tabindex="-1"><a class="header-anchor" href="#_3-2-3-2-接收消息"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-2-3-2-%E6%8E%A5%E6%94%B6%E6%B6%88%E6%81%AF" target="_blank" rel="noopener noreferrer">#</a>3.2.3.2 接收消息</span></a></h5><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211227200800397.fe61d6f4.png" alt="image-20211227200800397"></p><p>（1）ydles_service_order工程，编写消息监听类</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderTackListener</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">&quot;order_tack&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">autoTack</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;收到自动确认收货消息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        orderService<span class="token punctuation">.</span><span class="token function">autoTack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//自动确认收货</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13</p><p>（2）OrderService新增方法定义</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 自动确认收货</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">autoTack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p>（3）OrderServiceImpl实现此方法</p><p>实现思路：</p><p>1）从订单配置表中获取订单自动确认期限</p><p>2）得到当前日期向前数（订单自动确认期限）天。作为过期时间节点</p><p>3）从订单表中获取过期订单（发货时间小于过期时间，且为未确认收货状态）</p><p>4）循环批量处理，执行确认收货</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">OrderConfigMapper</span> orderConfigMapper<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">autoTack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//1 从配置表中获取15天值</span></span>
<span class="line">        <span class="token class-name">OrderConfig</span> orderConfig <span class="token operator">=</span> orderConfigMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Integer</span> takeTimeout <span class="token operator">=</span> orderConfig<span class="token punctuation">.</span><span class="token function">getTakeTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//15</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//2 推算拿几号之前发货的订单</span></span>
<span class="line">        <span class="token class-name">LocalDate</span> now<span class="token operator">=</span><span class="token class-name">LocalDate</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//当前</span></span>
<span class="line">        <span class="token class-name">LocalDate</span> date <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">plusDays</span><span class="token punctuation">(</span><span class="token operator">-</span>takeTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//3 查询发货超过15天的订单</span></span>
<span class="line">        <span class="token class-name">Example</span> example<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Example</span><span class="token punctuation">(</span><span class="token class-name">Order</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Example<span class="token punctuation">.</span>Criteria</span> criteria <span class="token operator">=</span> example<span class="token punctuation">.</span><span class="token function">createCriteria</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        criteria<span class="token punctuation">.</span><span class="token function">andEqualTo</span><span class="token punctuation">(</span><span class="token string">&quot;orderStatus&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        criteria<span class="token punctuation">.</span><span class="token function">andLessThan</span><span class="token punctuation">(</span><span class="token string">&quot;consignTime&quot;</span><span class="token punctuation">,</span> date<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> orderList <span class="token operator">=</span> orderMapper<span class="token punctuation">.</span><span class="token function">selectByExample</span><span class="token punctuation">(</span>example<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//4 循环 把这些订单 收货</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Order</span> order <span class="token operator">:</span> orderList<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">take</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;system&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26</p><p>总结：</p><p>1超时未支付订单处理</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211227113439128.705912ed.png" alt="image-20211227113439128"></p><p>2订单批量发货（店主）</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211227173827318.03d9a628.png" alt="image-20211227173827318"></p><p>3确认收货与自动收货</p><p>手动：/take/{orderId}/operator/{operator}</p><p>自动：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211227184231554.597edc2b.png" alt="image-20211227184231554"></p><h2 id="第15章-秒杀前端" tabindex="-1"><a class="header-anchor" href="#第15章-秒杀前端"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#%E7%AC%AC15%E7%AB%A0-%E7%A7%92%E6%9D%80%E5%89%8D%E7%AB%AF" target="_blank" rel="noopener noreferrer">#</a>第15章-秒杀前端</span></a></h2><p><strong>角色</strong>：独立模块 秒杀模块。<strong>架构师</strong>。</p><h2 id="课程内容-2" tabindex="-1"><a class="header-anchor" href="#课程内容-2"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#%E8%AF%BE%E7%A8%8B%E5%86%85%E5%AE%B9-2" target="_blank" rel="noopener noreferrer">#</a>课程内容:</span></a></h2><ul><li><p>秒杀业务分析</p><div class="language-properties line-numbers-mode" data-highlighter="prismjs" data-ext="properties" data-title="properties"><pre><code><span class="line">1.什么是秒杀</span>
<span class="line">2.秒杀实现的流程-&gt;架构分析流程-&gt;重点</span>
<span class="line">3.业务流程</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3</p></li><li><p>秒杀商品压入Redis缓存</p><div class="language-properties line-numbers-mode" data-highlighter="prismjs" data-ext="properties" data-title="properties"><pre><code><span class="line">秒杀商品存入到Redis来提升访问速度</span>
<span class="line">1.秒杀列表数据</span>
<span class="line">2.秒杀详情页数据</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3</p></li><li><p>Spring定时任务了解-定时将秒杀商品存入到Redis中</p><div class="language-properties line-numbers-mode" data-highlighter="prismjs" data-ext="properties" data-title="properties"><pre><code><span class="line">定时将秒杀商品存入到Redis缓存</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p></li><li><p>秒杀商品频道页实现-秒杀商品列表页</p></li><li><p>秒杀商品详情页实现</p></li></ul><h2 id="_1-秒杀业务分析" tabindex="-1"><a class="header-anchor" href="#_1-秒杀业务分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-%E7%A7%92%E6%9D%80%E4%B8%9A%E5%8A%A1%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>1 秒杀业务分析</span></a></h2><h4 id="_1-1-需求分析-1" tabindex="-1"><a class="header-anchor" href="#_1-1-需求分析-1"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90-1" target="_blank" rel="noopener noreferrer">#</a>1.1 需求分析</span></a></h4><p>所谓“秒杀”，就是网络卖家发布一些超低价格的商品，所有买家在同一时间网上抢购的一种销售方式。通俗一点讲就是网络商家为促销等目的组织的网上限时抢购活动。由于商品价格低廉，往往一上架就被抢购一空，有时只用一秒钟。</p><p>秒杀商品通常有<strong>两种限制</strong>：库存限制、时间限制。</p><p>需求：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">（1）秒杀频道首页列出秒杀商品</span>
<span class="line">（4）点击立即抢购实现秒杀下单，下单时扣减库存。当库存为0或不在活动期范围内时无法秒杀。</span>
<span class="line">（5）秒杀下单成功，直接跳转到支付页面（微信扫码），支付成功，跳转到成功页，填写收货地址、电话、收件人等信息，完成订单。</span>
<span class="line">（6）当用户秒杀下单5分钟内未支付，取消预订单，调用微信支付的关闭订单接口，恢复库存。</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211227221818494.8ebee597.png" alt="image-20211227221818494"></p><h4 id="_1-2-表结构说明" tabindex="-1"><a class="header-anchor" href="#_1-2-表结构说明"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-2-%E8%A1%A8%E7%BB%93%E6%9E%84%E8%AF%B4%E6%98%8E" target="_blank" rel="noopener noreferrer">#</a>1.2 表结构说明</span></a></h4><p><strong>秒杀商品信息表</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">CREATE TABLE `tb_seckill_goods` (</span>
<span class="line">  `id` bigint(20) NOT NULL AUTO_INCREMENT,</span>
<span class="line">  `goods_id` bigint(20) DEFAULT NULL COMMENT &#39;spu ID&#39;,</span>
<span class="line">  `item_id` bigint(20) DEFAULT NULL COMMENT &#39;sku ID&#39;,</span>
<span class="line">  `title` varchar(100) DEFAULT NULL COMMENT &#39;标题&#39;,</span>
<span class="line">  `small_pic` varchar(150) DEFAULT NULL COMMENT &#39;商品图片&#39;,</span>
<span class="line">  `price` decimal(10,2) DEFAULT NULL COMMENT &#39;原价格&#39;,</span>
<span class="line">  `cost_price` decimal(10,2) DEFAULT NULL COMMENT &#39;秒杀价格&#39;,</span>
<span class="line">  `seller_id` varchar(100) DEFAULT NULL COMMENT &#39;商家ID&#39;,</span>
<span class="line">  `create_time` datetime DEFAULT NULL COMMENT &#39;添加日期&#39;,</span>
<span class="line">  `check_time` datetime DEFAULT NULL COMMENT &#39;审核日期&#39;,</span>
<span class="line">  `status` char(1) DEFAULT NULL COMMENT &#39;审核状态，0未审核，1审核通过，2审核不通过&#39;,</span>
<span class="line">  `start_time` datetime DEFAULT NULL COMMENT &#39;开始时间&#39;,</span>
<span class="line">  `end_time` datetime DEFAULT NULL COMMENT &#39;结束时间&#39;,</span>
<span class="line">  `num` int(11) DEFAULT NULL COMMENT &#39;秒杀商品数&#39;,</span>
<span class="line">  `stock_count` int(11) DEFAULT NULL COMMENT &#39;剩余库存数&#39;,</span>
<span class="line">  `introduction` varchar(2000) DEFAULT NULL COMMENT &#39;描述&#39;,</span>
<span class="line">  PRIMARY KEY (`id`)</span>
<span class="line">) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211227221948208.fc0ab4b4.png" alt="image-20211227221948208"></p><p><strong>秒杀订单表</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">CREATE TABLE `tb_seckill_order` (</span>
<span class="line">  `id` bigint(20) NOT NULL COMMENT &#39;主键&#39;,</span>
<span class="line">  `seckill_id` bigint(20) DEFAULT NULL COMMENT &#39;秒杀商品ID&#39;,</span>
<span class="line">  `money` decimal(10,2) DEFAULT NULL COMMENT &#39;支付金额&#39;,</span>
<span class="line">  `user_id` varchar(50) DEFAULT NULL COMMENT &#39;用户&#39;,</span>
<span class="line">  `seller_id` varchar(50) DEFAULT NULL COMMENT &#39;商家&#39;,</span>
<span class="line">  `create_time` datetime DEFAULT NULL COMMENT &#39;创建时间&#39;,</span>
<span class="line">  `pay_time` datetime DEFAULT NULL COMMENT &#39;支付时间&#39;,</span>
<span class="line">  `status` char(1) DEFAULT NULL COMMENT &#39;状态，0未支付，1已支付&#39;,</span>
<span class="line">  `receiver_address` varchar(200) DEFAULT NULL COMMENT &#39;收货人地址&#39;,</span>
<span class="line">  `receiver_mobile` varchar(20) DEFAULT NULL COMMENT &#39;收货人电话&#39;,</span>
<span class="line">  `receiver` varchar(20) DEFAULT NULL COMMENT &#39;收货人&#39;,</span>
<span class="line">  `transaction_id` varchar(30) DEFAULT NULL COMMENT &#39;交易流水&#39;,</span>
<span class="line">  PRIMARY KEY (`id`)</span>
<span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211227222002467.e63d1cd6.png" alt="image-20211227222002467"></p><h4 id="_1-3-秒杀需求分析-拓展内容" tabindex="-1"><a class="header-anchor" href="#_1-3-秒杀需求分析-拓展内容"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-3-%E7%A7%92%E6%9D%80%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90-%E6%8B%93%E5%B1%95%E5%86%85%E5%AE%B9" target="_blank" rel="noopener noreferrer">#</a>1.3 秒杀需求分析==拓展内容</span></a></h4><p>秒杀技术实现核心思想是运用缓存减少数据库瞬间的访问压力！读取商品详细信息时运用缓存，当用户点击抢购时减少缓存中的库存数量，当库存数为0时或活动期结束时，同步到数据库。 产生的秒杀预订单也不会立刻写到数据库中，而是先写到缓存，当用户付款成功后再写入数据库。</p><p>当然，上面实现的思路只是一种最简单的方式，并未考虑其中一些问题，例如并发状况容易产生的问题。我们看看下面这张思路更严谨的图：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/1578267434606.dd456a46.png" alt="1578267434606"></p><h2 id="_2-秒杀商品存入缓存-重点" tabindex="-1"><a class="header-anchor" href="#_2-秒杀商品存入缓存-重点"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-%E7%A7%92%E6%9D%80%E5%95%86%E5%93%81%E5%AD%98%E5%85%A5%E7%BC%93%E5%AD%98-%E9%87%8D%E7%82%B9" target="_blank" rel="noopener noreferrer">#</a>2 秒杀商品存入缓存-重点</span></a></h2><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211228160425046.ef44d61e.png" alt="image-20211228160425046"></p><p>秒杀商品由B端存入Mysql，设置定时任务，每隔一段时间就从Mysql中将符合条件的数据从Mysql中查询出来并存入缓存中，redis以Hash类型进行数据存储。</p><p>KEY的设计：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">seckill_goods_2021122812 map</span>
<span class="line">                  id SecKillGoods</span>
<span class="line">                  1 Prada包包</span>
<span class="line">                  3  guccy包包</span>
<span class="line">seckill_goods_2021122814 map</span>
<span class="line">                  id SecKillGoods</span>
<span class="line">                  2 lv包包</span>
<span class="line">seckill_goods_2021122816 map          </span>
<span class="line">seckill_goods_2021122818 map</span>
<span class="line">seckill_goods_2021122820 map</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10</p><ul><li>我们这里秒杀商品列表和秒杀商品详情都是从Redis中取出来的，所以我们首先要将符合参与秒杀的商品定时查询出来，并将数据存入到Redis缓存中。</li><li>数据存储类型我们可以选择Hash类型。</li><li>秒杀分页列表这里可以通过获取redisTemplate.boundHashOps(key).values()获取结果数据。</li><li>秒杀商品详情，可以通过redisTemplate.boundHashOps(key).get(key)获取详情。</li></ul><h3 id="_2-1-秒杀服务搭建" tabindex="-1"><a class="header-anchor" href="#_2-1-秒杀服务搭建"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-1-%E7%A7%92%E6%9D%80%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BA" target="_blank" rel="noopener noreferrer">#</a>2.1 秒杀服务搭建</span></a></h3><p>我们将商品数据压入到Reids缓存，可以在秒杀工程的服务工程中完成，可以按照如下步骤实现：</p><div class="language-properties line-numbers-mode" data-highlighter="prismjs" data-ext="properties" data-title="properties"><pre><code><span class="line">1.查询活动没结束的所有秒杀商品</span>
<span class="line"><span class="token key attr-name">	1)状态必须为审核通过</span> <span class="token value attr-value">status=1</span></span>
<span class="line">	2)商品库存个数&gt;0</span>
<span class="line"><span class="token key attr-name">	3)活动没有结束</span> <span class="token value attr-value"> endTime&gt;=now()</span></span>
<span class="line">	4)在Redis中没有该商品的缓存</span>
<span class="line">	5)执行查询获取对应的结果集</span>
<span class="line">2.将活动没有结束的秒杀商品入库</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><p>我们首先搭建一个秒杀服务工程，然后按照上面步骤实现。</p><p>搭建ydles-service-seckill，作为秒杀工程的服务提供工程。</p><p>1）新建服务ydles_service_seckill</p><p>2）添加依赖信息，详情如下：</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ydles_common_db<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ydles_service_order_api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ydles_service_seckill_api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ydles_service_goods_api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-rabbit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token comment">&lt;!--oauth依赖--&gt;</span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-oauth2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35</p><ul><li>ydles_service_seckill_api创建</li></ul><p>依赖</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ydles_common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><p>添加包 com.ydles.seckill.feign com.ydles.seckill.pojo</p><p>pojo中将资料中的两个实体类放入，对应数据库的两张表</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211228161100576.817ff531.png" alt="image-20211228161100576"></p><ol><li>回到ydles_service_seckill工程。添加启动类 com.ydles.seckill</li></ol><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@SpringBootApplication</span></span>
<span class="line"><span class="token annotation punctuation">@EnableEurekaClient</span></span>
<span class="line"><span class="token annotation punctuation">@EnableFeignClients</span></span>
<span class="line"><span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;com.ydles.seckill.dao&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token annotation punctuation">@EnableScheduling</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SeckillApplication</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SeckillApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Bean</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">IdWorker</span> <span class="token function">idWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">IdWorker</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">//设置redistemplate的序列化</span></span>
<span class="line">    <span class="token annotation punctuation">@Bean</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> redisConnectionFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 1.创建 redisTemplate 模版</span></span>
<span class="line">        <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> template <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 2.关联 redisConnectionFactory</span></span>
<span class="line">        template<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 3.创建 序列化类</span></span>
<span class="line">        <span class="token class-name">GenericToStringSerializer</span> genericToStringSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GenericToStringSerializer</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 6.序列化类，对象映射设置</span></span>
<span class="line">        <span class="token comment">// 7.设置 value 的转化格式和 key 的转化格式</span></span>
<span class="line">        template<span class="token punctuation">.</span><span class="token function">setValueSerializer</span><span class="token punctuation">(</span>genericToStringSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        template<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        template<span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> template<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34</p><ol><li>添加dao层的两个mapper</li></ol><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SeckillGoodsMapper</span> <span class="token keyword">extends</span> <span class="token class-name">Mapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SeckillOrderMapper</span> <span class="token keyword">extends</span> <span class="token class-name">Mapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillOrder</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><ol><li>添加application.yml</li></ol><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">server</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9016</span></span>
<span class="line"><span class="token key atrule">spring</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">jackson</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">time-zone</span><span class="token punctuation">:</span> GMT+8</span>
<span class="line">  <span class="token key atrule">application</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> seckill</span>
<span class="line">  <span class="token key atrule">datasource</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver</span>
<span class="line">    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//192.168.200.128<span class="token punctuation">:</span>3306/ydles_seckill<span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;characterEncoding=utf-8&amp;useSSL=false&amp;allowMultiQueries=true&amp;serverTimezone=GMT%2b8</span></span>
<span class="line">    <span class="token key atrule">username</span><span class="token punctuation">:</span> root</span>
<span class="line">    <span class="token key atrule">password</span><span class="token punctuation">:</span> root</span>
<span class="line">  <span class="token key atrule">main</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">allow-bean-definition-overriding</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment">#当遇到同样名字的时候，是否允许覆盖注册</span></span>
<span class="line">  <span class="token key atrule">redis</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.200.128</span>
<span class="line">  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.200.128</span>
<span class="line"><span class="token key atrule">eureka</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">client</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">service-url</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>6868/eureka</span>
<span class="line">  <span class="token key atrule">instance</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line"><span class="token key atrule">feign</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">hystrix</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">  <span class="token key atrule">client</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">config</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">default</span><span class="token punctuation">:</span>   <span class="token comment">#配置全局的feign的调用超时时间  如果 有指定的服务配置 默认的配置不会生效</span></span>
<span class="line">        <span class="token key atrule">connectTimeout</span><span class="token punctuation">:</span> <span class="token number">60000</span> <span class="token comment"># 指定的是 消费者 连接服务提供者的连接超时时间 是否能连接  单位是毫秒</span></span>
<span class="line">        <span class="token key atrule">readTimeout</span><span class="token punctuation">:</span> <span class="token number">20000</span>  <span class="token comment"># 指定的是调用服务提供者的 服务 的超时时间（）  单位是毫秒</span></span>
<span class="line"><span class="token comment">#hystrix 配置</span></span>
<span class="line"><span class="token key atrule">hystrix</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">command</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">default</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">execution</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">timeout</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token comment">#如果enabled设置为false，则请求超时交给ribbon控制</span></span>
<span class="line">          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">        <span class="token key atrule">isolation</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">strategy</span><span class="token punctuation">:</span> SEMAPHORE</span>
<span class="line">          <span class="token key atrule">thread</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># 熔断器超时时间，默认：1000/毫秒</span></span>
<span class="line">            <span class="token key atrule">timeoutInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">20000</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45</p><ol><li>添加公钥 copy认证服务的公钥</li><li>添加Oauth配置类 config包</li></ol><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Configuration</span></span>
<span class="line"><span class="token annotation punctuation">@EnableResourceServer</span></span>
<span class="line"><span class="token comment">//开启方法上的PreAuthorize注解</span></span>
<span class="line"><span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>prePostEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> securedEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ResourceServerConfig</span> <span class="token keyword">extends</span> <span class="token class-name">ResourceServerConfigurerAdapter</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//公钥</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PUBLIC_KEY</span> <span class="token operator">=</span> <span class="token string">&quot;public.key&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/***</span>
<span class="line">     * 定义JwtTokenStore</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">jwtAccessTokenConverter</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@Bean</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">TokenStore</span> <span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token class-name">JwtAccessTokenConverter</span> jwtAccessTokenConverter<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JwtTokenStore</span><span class="token punctuation">(</span>jwtAccessTokenConverter<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/***</span>
<span class="line">     * 定义JJwtAccessTokenConverter</span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@Bean</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">JwtAccessTokenConverter</span> <span class="token function">jwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">JwtAccessTokenConverter</span> converter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        converter<span class="token punctuation">.</span><span class="token function">setVerifierKey</span><span class="token punctuation">(</span><span class="token function">getPubKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> converter<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 获取非对称加密公钥 Key</span>
<span class="line">     * <span class="token keyword">@return</span> 公钥 Key</span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getPubKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Resource</span> resource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token constant">PUBLIC_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">InputStreamReader</span> inputStreamReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">BufferedReader</span> br <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span>inputStreamReader<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> br<span class="token punctuation">.</span><span class="token function">lines</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ioe<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/***</span>
<span class="line">     * Http安全配置，对每个到达系统的http请求链接进行校验</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">http</span></span>
<span class="line">     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//所有请求必须认证通过</span></span>
<span class="line">        http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span></span>
<span class="line">                <span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//其他地址需要认证授权</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57</p><ol><li>更改网关路径过滤类，添加秒杀工程过滤信息</li></ol><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211228162810677.a4fbb12f.png" alt="image-20211228162810677"></p><ol><li>更改网关配置文件，添加请求路由转发</li></ol><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line">        <span class="token comment">#秒杀微服务</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> ydles_seckill_route</span>
<span class="line">          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//seckill</span>
<span class="line">          <span class="token key atrule">predicates</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> Path=/api/seckill/<span class="token important">**</span></span>
<span class="line">          <span class="token key atrule">filters</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> StripPrefix=1</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><h3 id="_2-2-时间操作" tabindex="-1"><a class="header-anchor" href="#_2-2-时间操作"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-2-%E6%97%B6%E9%97%B4%E6%93%8D%E4%BD%9C" target="_blank" rel="noopener noreferrer">#</a>2.2 时间操作</span></a></h3><h4 id="_2-2-1-秒杀商品时间段分析" tabindex="-1"><a class="header-anchor" href="#_2-2-1-秒杀商品时间段分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-2-1-%E7%A7%92%E6%9D%80%E5%95%86%E5%93%81%E6%97%B6%E9%97%B4%E6%AE%B5%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>2.2.1 秒杀商品时间段分析</span></a></h4><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211228171058257.0677530e.png" alt="image-20211228171058257"></p><p>根据产品原型图结合秒杀商品表设计可以得知，秒杀商品是存在开始时间与结束时间的，当前秒杀商品是按照秒杀时间段进行显示，如果当前时间在符合条件的时间段范围之内，则用户可以秒杀购买当前时间段之内的秒杀商品。</p><p>缓存数据加载思路：定义定时任务，每天凌晨会进行当天所有时间段秒杀商品预加载。并且在B端进行限制，添加秒杀商品的话，只能添加当前日期+1的时间限制，比如说：当前日期为8月5日，则添加秒杀商品时，开始时间必须为6日的某一个时间段，否则不能添加。</p><h4 id="_2-2-2-秒杀商品时间段计算" tabindex="-1"><a class="header-anchor" href="#_2-2-2-秒杀商品时间段计算"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-2-2-%E7%A7%92%E6%9D%80%E5%95%86%E5%93%81%E6%97%B6%E9%97%B4%E6%AE%B5%E8%AE%A1%E7%AE%97" target="_blank" rel="noopener noreferrer">#</a>2.2.2 秒杀商品时间段计算</span></a></h4><p>将<code>资源/DateUtil.java</code>添加到公共服务中。基于当前工具类可以进行时间段的计算。</p><p>在该工具类中，进行时间计算测试：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//定义存储结果的集合</span></span>
<span class="line">    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Date</span><span class="token punctuation">&gt;</span></span> dateList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//获取本日凌晨时间点</span></span>
<span class="line">    <span class="token class-name">Date</span> currentData <span class="token operator">=</span> <span class="token function">toDayStartHour</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//循环12次 （因为要获取每隔两个时间为一个时间段的值）</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">12</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        dateList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">addDateHour</span><span class="token punctuation">(</span>currentData<span class="token punctuation">,</span>i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Date</span> date <span class="token operator">:</span> dateList<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">SimpleDateFormat</span> simpleDateFormat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">String</span> format <span class="token operator">=</span> simpleDateFormat<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18</p><p>测试结果：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211228171813908.6e66583f.png" alt="image-20211228171813908"></p><h4 id="_2-2-3-当前业务整体流程分析" tabindex="-1"><a class="header-anchor" href="#_2-2-3-当前业务整体流程分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-2-3-%E5%BD%93%E5%89%8D%E4%B8%9A%E5%8A%A1%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>2.2.3 当前业务整体流程分析</span></a></h4><div class="language-properties line-numbers-mode" data-highlighter="prismjs" data-ext="properties" data-title="properties"><pre><code><span class="line">1.定时任务：查询所有符合条件的秒杀商品</span>
<span class="line"><span class="token key attr-name">    1)</span> <span class="token value attr-value">获取时间段集合并循环遍历出每一个时间段</span></span>
<span class="line"><span class="token key attr-name">    2)</span> <span class="token value attr-value">获取每一个时间段名称,用于后续redis中key的设置</span></span>
<span class="line"><span class="token key attr-name">    3)</span> <span class="token value attr-value">状态必须为审核通过 status=1</span></span>
<span class="line"><span class="token key attr-name">    4)</span> <span class="token value attr-value">商品库存个数&gt;0 </span></span>
<span class="line"><span class="token key attr-name">    5)</span> <span class="token value attr-value">秒杀商品开始时间&gt;=当前时间段</span></span>
<span class="line"><span class="token key attr-name">    6)</span> <span class="token value attr-value">秒杀商品结束&lt;当前时间段+2小时</span></span>
<span class="line"><span class="token key attr-name">    7)</span> <span class="token value attr-value">排除之前已经加载到Redis缓存中的商品数据</span></span>
<span class="line"><span class="token key attr-name">    8)</span> <span class="token value attr-value">执行查询获取对应的结果集</span></span>
<span class="line">2.将秒杀商品存入缓存</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10</p><h3 id="_2-3-代码实现-1" tabindex="-1"><a class="header-anchor" href="#_2-3-代码实现-1"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-3-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-1" target="_blank" rel="noopener noreferrer">#</a>2.3 代码实现</span></a></h3><h4 id="_2-3-1-更改启动类-添加开启定时任务注解" tabindex="-1"><a class="header-anchor" href="#_2-3-1-更改启动类-添加开启定时任务注解"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-3-1-%E6%9B%B4%E6%94%B9%E5%90%AF%E5%8A%A8%E7%B1%BB-%E6%B7%BB%E5%8A%A0%E5%BC%80%E5%90%AF%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%B3%A8%E8%A7%A3" target="_blank" rel="noopener noreferrer">#</a>2.3.1 更改启动类，添加开启定时任务注解</span></a></h4><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@EnableScheduling</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><h4 id="_2-3-2-时间菜单分析" tabindex="-1"><a class="header-anchor" href="#_2-3-2-时间菜单分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-3-2-%E6%97%B6%E9%97%B4%E8%8F%9C%E5%8D%95%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>2.3.2 时间菜单分析</span></a></h4><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211227224705978.2b56d226.png" alt="image-20211227224705978"></p><p>我们将商品数据从数据库中查询出来，并存入Redis缓存，但页面每次显示的时候，只显示当前正在秒杀以及往后延时2个小时、4个小时、6个小时、8个小时的秒杀商品数据。我们要做的第一个事是计算出秒杀时间菜单，这个菜单是从后台获取的。</p><p>这个时间菜单的计算我们来分析下，可以先求出当前时间的凌晨，然后每2个小时后作为下一个抢购的开始时间，这样可以分出12个抢购时间段,如下：</p><div class="language-properties line-numbers-mode" data-highlighter="prismjs" data-ext="properties" data-title="properties"><pre><code><span class="line"><span class="token key attr-name">00</span><span class="token punctuation">:</span><span class="token value attr-value">00-02:00</span></span>
<span class="line"><span class="token key attr-name">02</span><span class="token punctuation">:</span><span class="token value attr-value">00-04:00</span></span>
<span class="line"><span class="token key attr-name">04</span><span class="token punctuation">:</span><span class="token value attr-value">00-06:00</span></span>
<span class="line"><span class="token key attr-name">06</span><span class="token punctuation">:</span><span class="token value attr-value">00-08:00</span></span>
<span class="line"><span class="token key attr-name">08</span><span class="token punctuation">:</span><span class="token value attr-value">00-10:00</span></span>
<span class="line"><span class="token key attr-name">10</span><span class="token punctuation">:</span><span class="token value attr-value">00-12:00</span></span>
<span class="line"><span class="token key attr-name">12</span><span class="token punctuation">:</span><span class="token value attr-value">00-14:00</span></span>
<span class="line"><span class="token key attr-name">14</span><span class="token punctuation">:</span><span class="token value attr-value">00-16:00</span></span>
<span class="line"><span class="token key attr-name">16</span><span class="token punctuation">:</span><span class="token value attr-value">00-18:00</span></span>
<span class="line"><span class="token key attr-name">18</span><span class="token punctuation">:</span><span class="token value attr-value">00-20:00</span></span>
<span class="line"><span class="token key attr-name">20</span><span class="token punctuation">:</span><span class="token value attr-value">00-22:00</span></span>
<span class="line"><span class="token key attr-name">22</span><span class="token punctuation">:</span><span class="token value attr-value">00-00:00</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12</p><p>而现实的菜单只需要计算出当前时间在哪个时间段范围，该时间段范围就属于正在秒杀的时间段，而后面即将开始的秒杀时间段的计算也就出来了，可以在当前时间段基础之上+2小时、+4小时、+6小时、+8小时。</p><p>关于时间菜单的运算，在给出的DateUtil包里已经实现，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/***</span>
<span class="line"> * 获取时间菜单</span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Date</span><span class="token punctuation">&gt;</span></span> <span class="token function">getDateMenus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//定义一个List&lt;Date&gt;集合，存储所有时间段</span></span>
<span class="line">    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Date</span><span class="token punctuation">&gt;</span></span> dates <span class="token operator">=</span> <span class="token function">getDates</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//判断当前时间属于哪个时间范围</span></span>
<span class="line">    <span class="token class-name">Date</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Date</span> cdate <span class="token operator">:</span> dates<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//开始时间&lt;=当前时间&lt;开始时间+2小时</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span>cdate<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span>now<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> now<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token function">addDateHour</span><span class="token punctuation">(</span>cdate<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            now <span class="token operator">=</span> cdate<span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//当前需要显示的时间菜单</span></span>
<span class="line">    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Date</span><span class="token punctuation">&gt;</span></span> dateMenus <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Date</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span><span class="token number">5</span> <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dateMenus<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">addDateHour</span><span class="token punctuation">(</span>now<span class="token punctuation">,</span>i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> dateMenus<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token doc-comment comment">/***</span>
<span class="line"> * 指定时间往后N个时间间隔</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">hours</span></span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Date</span><span class="token punctuation">&gt;</span></span> <span class="token function">getDates</span><span class="token punctuation">(</span><span class="token keyword">int</span> hours<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Date</span><span class="token punctuation">&gt;</span></span> dates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Date</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//循环12次</span></span>
<span class="line">    <span class="token class-name">Date</span> date <span class="token operator">=</span> <span class="token function">toDayStartHour</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//凌晨</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span>hours <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//每次递增2小时,将每次递增的时间存入到List&lt;Date&gt;集合中</span></span>
<span class="line">        dates<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">addDateHour</span><span class="token punctuation">(</span>date<span class="token punctuation">,</span>i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> dates<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40</p><h4 id="_2-3-2-定义定时任务类" tabindex="-1"><a class="header-anchor" href="#_2-3-2-定义定时任务类"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-3-2-%E5%AE%9A%E4%B9%89%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%B1%BB" target="_blank" rel="noopener noreferrer">#</a>2.3.2 定义定时任务类</span></a></h4><p>秒杀工程新建task包，并新建任务类SeckillGoodsPushTask</p><p>业务逻辑：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line">         * 1.查询所有符合条件的秒杀商品</span>
<span class="line">         * 	1) 获取时间段集合并循环遍历出每一个时间段</span>
<span class="line">         * 	2) 获取每一个时间段名称,用于后续redis中key的设置</span>
<span class="line">         * 	3) 状态必须为审核通过 status=1</span>
<span class="line">         * 	4) 商品库存个数&gt;0</span>
<span class="line">         * 	5) 秒杀商品开始时间&gt;=当前时间段</span>
<span class="line">         * 	6) 秒杀商品结束&lt;当前时间段+2小时</span>
<span class="line">         * 	7) 排除之前已经加载到Redis缓存中的商品数据</span>
<span class="line">         * 	8) 执行查询获取对应的结果集</span>
<span class="line">         * 2.将秒杀商品存入缓存</span>
<span class="line">         */</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12</p><p><strong>注意</strong>：用到很多工具类，了解功能即可</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 添加秒杀秒伤定时任务</span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SeckillGoodsPushTask</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">SeckillGoodsMapper</span> seckillGoodsMapper<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//redis key开头</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SECKILL_GOODS_KEY</span> <span class="token operator">=</span> <span class="token string">&quot;seckill_goods_&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 定时将秒杀商品存入redis</span>
<span class="line">     * 暂定为30秒一次，正常业务为每天凌晨触发</span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">&quot;0/30 * * * * ?&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">loadSecKillGoodsToRedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token doc-comment comment">/**</span>
<span class="line">         * 1.查询所有符合条件的秒杀商品</span>
<span class="line">         * 	1) 获取时间段集合并循环遍历出每一个时间段</span>
<span class="line">         * 	2) 获取每一个时间段名称,用于后续redis中key的设置</span>
<span class="line">         * 	3) 状态必须为审核通过 status=1</span>
<span class="line">         * 	4) 商品库存个数&gt;0</span>
<span class="line">         * 	5) 秒杀商品开始时间&gt;=当前时间段</span>
<span class="line">         * 	6) 秒杀商品结束&lt;当前时间段+2小时</span>
<span class="line">         * 	7) 排除之前已经加载到Redis缓存中的商品数据</span>
<span class="line">         * 	8) 执行查询获取对应的结果集</span>
<span class="line">         * 2.将秒杀商品存入缓存</span>
<span class="line">         */</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//1) 获取时间段集合并循环遍历出每一个时间段</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Date</span><span class="token punctuation">&gt;</span></span> dateMenus <span class="token operator">=</span> <span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">getDateMenus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 5个</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Date</span> dateMenu <span class="token operator">:</span> dateMenus<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">SimpleDateFormat</span> simpleDateFormat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">// 2) 获取每一个时间段名称,用于后续redis中key的设置</span></span>
<span class="line">            <span class="token class-name">String</span> redisExtName <span class="token operator">=</span> <span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">date2Str</span><span class="token punctuation">(</span>dateMenu<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token class-name">Example</span> example <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Example</span><span class="token punctuation">(</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">Example<span class="token punctuation">.</span>Criteria</span> criteria <span class="token operator">=</span> example<span class="token punctuation">.</span><span class="token function">createCriteria</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// 3) 状态必须为审核通过 status=1</span></span>
<span class="line">            criteria<span class="token punctuation">.</span><span class="token function">andEqualTo</span><span class="token punctuation">(</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// 4) 商品库存个数&gt;0 gt</span></span>
<span class="line">            criteria<span class="token punctuation">.</span><span class="token function">andGreaterThan</span><span class="token punctuation">(</span><span class="token string">&quot;stockCount&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// 5) 秒杀商品开始时间&gt;=当前时间段 gte</span></span>
<span class="line">            criteria<span class="token punctuation">.</span><span class="token function">andGreaterThanOrEqualTo</span><span class="token punctuation">(</span><span class="token string">&quot;startTime&quot;</span><span class="token punctuation">,</span> simpleDateFormat<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>dateMenu<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// 6) 秒杀商品结束&lt;当前时间段+2小时 lt</span></span>
<span class="line">            criteria<span class="token punctuation">.</span><span class="token function">andLessThan</span><span class="token punctuation">(</span><span class="token string">&quot;endTime&quot;</span><span class="token punctuation">,</span> simpleDateFormat<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">addDateHour</span><span class="token punctuation">(</span>dateMenu<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">// 7) 排除之前已经加载到Redis缓存中的商品数据</span></span>
<span class="line">            <span class="token class-name">Set</span> keys <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token constant">SECKILL_GOODS_KEY</span> <span class="token operator">+</span> redisExtName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//key field value</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>keys <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> keys<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                criteria<span class="token punctuation">.</span><span class="token function">andNotIn</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> keys<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">// 8) 执行查询获取对应的结果集</span></span>
<span class="line">            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span> seckillGoodsList <span class="token operator">=</span> seckillGoodsMapper<span class="token punctuation">.</span><span class="token function">selectByExample</span><span class="token punctuation">(</span>example<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">//2.将秒杀商品存入缓存</span></span>
<span class="line">            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SeckillGoods</span> seckillGoods <span class="token operator">:</span> seckillGoodsList<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token constant">SECKILL_GOODS_KEY</span> <span class="token operator">+</span> redisExtName<span class="token punctuation">,</span> seckillGoods<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> seckillGoods<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71</p><p><strong>测试</strong>：</p><p>1修改一条数据，满足搜索条件</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211228180524421.d1c0979e.png" alt="image-20211228180524421"></p><p>2结果查看redis</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211228180537463.722f9d9d.png" alt="image-20211228180537463"></p><h2 id="_3-秒杀商品-首页-了解" tabindex="-1"><a class="header-anchor" href="#_3-秒杀商品-首页-了解"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-%E7%A7%92%E6%9D%80%E5%95%86%E5%93%81-%E9%A6%96%E9%A1%B5-%E4%BA%86%E8%A7%A3" target="_blank" rel="noopener noreferrer">#</a>3 秒杀商品-首页-了解</span></a></h2><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211228181401546.bb601793.png" alt="image-20211228181401546"></p><p>秒杀商品首页会显示处于秒杀中以及未开始秒杀的商品。</p><h3 id="_3-1-秒杀首页实现分析" tabindex="-1"><a class="header-anchor" href="#_3-1-秒杀首页实现分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-1-%E7%A7%92%E6%9D%80%E9%A6%96%E9%A1%B5%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>3.1 秒杀首页实现分析</span></a></h3><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211227224737382.409ca1b9.png" alt="image-20211227224737382"></p><p>秒杀首页需要显示不同时间段的秒杀商品信息，然后当用户选择不同的时间段，查询该时间段下的秒杀商品，实现过程分为两大过程：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">1) 加载时间菜单</span>
<span class="line">2）加载时间菜单下秒杀商品信息</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><h4 id="_3-1-1-加载时间菜单分析" tabindex="-1"><a class="header-anchor" href="#_3-1-1-加载时间菜单分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-1-1-%E5%8A%A0%E8%BD%BD%E6%97%B6%E9%97%B4%E8%8F%9C%E5%8D%95%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>3.1.1 加载时间菜单分析</span></a></h4><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211228181433725.37340631.png" alt="image-20211228181433725"></p><p>每2个小时就会切换一次抢购活动，所以商品发布的时候，我们将时间定格在2小时内抢购，每次发布商品的时候，商品抢购开始时间和结束时间是这2小时的边界。</p><p>每2小时会有一批商品参与抢购，所以我们可以将24小时切分为12个菜单，每个菜单都是个2小时的时间段，当前选中的时间菜单需要根据当前时间判断，判断当前时间属于哪个秒杀时间段，然后将该时间段作为选中的第1个时间菜单。</p><h4 id="_3-1-2-加载对应秒杀商品分析" tabindex="-1"><a class="header-anchor" href="#_3-1-2-加载对应秒杀商品分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-1-2-%E5%8A%A0%E8%BD%BD%E5%AF%B9%E5%BA%94%E7%A7%92%E6%9D%80%E5%95%86%E5%93%81%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>3.1.2 加载对应秒杀商品分析</span></a></h4><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211228181441279.fab14fd1.png" alt="image-20211228181441279"></p><p>进入首页时，到后台查询时间菜单信息，然后将第1个菜单的时间段作为key，在Redis中查询秒杀商品集合，并显示到页面，页面每次点击切换不同时间段菜单的时候，都将时间段传入到后台，后台根据时间段获取对应的秒杀商品集合。</p><h3 id="_3-2-秒杀渲染服务-渲染秒杀首页" tabindex="-1"><a class="header-anchor" href="#_3-2-秒杀渲染服务-渲染秒杀首页"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-2-%E7%A7%92%E6%9D%80%E6%B8%B2%E6%9F%93%E6%9C%8D%E5%8A%A1-%E6%B8%B2%E6%9F%93%E7%A7%92%E6%9D%80%E9%A6%96%E9%A1%B5" target="_blank" rel="noopener noreferrer">#</a>3.2 秒杀渲染服务 - 渲染秒杀首页</span></a></h3><h4 id="_3-2-1-新建秒杀渲染服务" tabindex="-1"><a class="header-anchor" href="#_3-2-1-新建秒杀渲染服务"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-2-1-%E6%96%B0%E5%BB%BA%E7%A7%92%E6%9D%80%E6%B8%B2%E6%9F%93%E6%9C%8D%E5%8A%A1" target="_blank" rel="noopener noreferrer">#</a>3.2.1 新建秒杀渲染服务</span></a></h4><p>1）创建工程ydles_web_seckill,用于秒杀页面渲染</p><ol><li>添加依赖</li></ol><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ydles_service_seckill_api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-thymeleaf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11</p><ol><li>添加启动类 com.ydles.seckill.web</li></ol><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@SpringBootApplication</span></span>
<span class="line"><span class="token annotation punctuation">@EnableDiscoveryClient</span></span>
<span class="line"><span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">&quot;com.ydles.seckill.feign&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecKillApplication</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">WebSecKillApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Bean</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">FeignInterceptor</span> <span class="token function">feignInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FeignInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 设置 redisTemplate 的序列化设置</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">redisConnectionFactory</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@Bean</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> redisConnectionFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 1.创建 redisTemplate 模版</span></span>
<span class="line">        <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> template <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 2.关联 redisConnectionFactory</span></span>
<span class="line">        template<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 3.创建 序列化类</span></span>
<span class="line">        <span class="token class-name">GenericToStringSerializer</span> genericToStringSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GenericToStringSerializer</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 6.序列化类，对象映射设置</span></span>
<span class="line">        <span class="token comment">// 7.设置 value 的转化格式和 key 的转化格式</span></span>
<span class="line">        template<span class="token punctuation">.</span><span class="token function">setValueSerializer</span><span class="token punctuation">(</span>genericToStringSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        template<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        template<span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> template<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35</p><ol><li>添加application.yml</li></ol><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">server</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9104</span></span>
<span class="line"><span class="token key atrule">eureka</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">client</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">service-url</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>6868/eureka</span>
<span class="line">  <span class="token key atrule">instance</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line"><span class="token key atrule">feign</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">hystrix</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line"><span class="token key atrule">spring</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">jackson</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">time-zone</span><span class="token punctuation">:</span> GMT+8</span>
<span class="line">  <span class="token key atrule">thymeleaf</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">cache</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></span>
<span class="line">  <span class="token key atrule">application</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> seckill<span class="token punctuation">-</span>web</span>
<span class="line">  <span class="token key atrule">main</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">allow-bean-definition-overriding</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">  <span class="token key atrule">redis</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.200.128</span>
<span class="line"><span class="token comment">#hystrix 配置</span></span>
<span class="line"><span class="token key atrule">hystrix</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">command</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">default</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">execution</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">timeout</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token comment">#如果enabled设置为false，则请求超时交给ribbon控制</span></span>
<span class="line">          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">        <span class="token key atrule">isolation</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">strategy</span><span class="token punctuation">:</span> SEMAPHORE</span>
<span class="line">          <span class="token key atrule">thread</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">timeoutInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">60000</span></span>
<span class="line"><span class="token comment">#请求处理的超时时间</span></span>
<span class="line"><span class="token key atrule">ribbon</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">ReadTimeout</span><span class="token punctuation">:</span> <span class="token number">4000</span></span>
<span class="line">  <span class="token comment">#请求连接的超时时间</span></span>
<span class="line">  <span class="token key atrule">ConnectTimeout</span><span class="token punctuation">:</span> <span class="token number">3000</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39</p><ol><li>添加静态化资源</li></ol><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211228181821971.e398a676.png" alt="image-20211228181821971"></p><p>6）对接网关</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line">		<span class="token comment">#秒杀渲染微服务</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> ydles_seckill_web_route</span>
<span class="line">          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//seckill<span class="token punctuation">-</span>web</span>
<span class="line">          <span class="token key atrule">predicates</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> Path=/api/wseckillgoods/<span class="token important">**</span></span>
<span class="line">          <span class="token key atrule">filters</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> StripPrefix=1</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><h3 id="_3-3-时间菜单实现" tabindex="-1"><a class="header-anchor" href="#_3-3-时间菜单实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-3-%E6%97%B6%E9%97%B4%E8%8F%9C%E5%8D%95%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>3.3 时间菜单实现</span></a></h3><p>时间菜单显示，先运算出每2小时一个抢购，就需要实现12个菜单，可以先计算出每个时间的临界值，然后根据当前时间判断需要显示12个时间段菜单中的哪个菜单，再在该时间菜单的基础之上往后挪4个菜单，一直显示5个时间菜单。</p><h4 id="_3-3-1-时间菜单获取" tabindex="-1"><a class="header-anchor" href="#_3-3-1-时间菜单获取"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-3-1-%E6%97%B6%E9%97%B4%E8%8F%9C%E5%8D%95%E8%8E%B7%E5%8F%96" target="_blank" rel="noopener noreferrer">#</a>3.3.1 时间菜单获取</span></a></h4><p>ydles_web_seckill com.ydles.seckill.web.controller 新增控制类SecKillGoodsController</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Controller</span></span>
<span class="line"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/wseckillgoods&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecKillGoodsController</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">SecKillGoodsFeign</span> secKillGoodsFeign<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//跳转秒杀首页</span></span>
<span class="line">    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/toIndex&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">&quot;seckill-index&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//获取秒杀时间段集合信息</span></span>
<span class="line">    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/timeMenus&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token annotation punctuation">@ResponseBody</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">dateMenus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//获取当前时间段相关的信息集合</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Date</span><span class="token punctuation">&gt;</span></span> dateMenus <span class="token operator">=</span> <span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">getDateMenus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//5个</span></span>
<span class="line">        <span class="token comment">//返回值</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">SimpleDateFormat</span> simpleDateFormat  <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//格式化时间段</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Date</span> dateMenu <span class="token operator">:</span> dateMenus<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">String</span> format <span class="token operator">=</span> simpleDateFormat<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>dateMenu<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span>  result<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35</p><h4 id="_3-3-2-页面加载时间菜单" tabindex="-1"><a class="header-anchor" href="#_3-3-2-页面加载时间菜单"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-3-2-%E9%A1%B5%E9%9D%A2%E5%8A%A0%E8%BD%BD%E6%97%B6%E9%97%B4%E8%8F%9C%E5%8D%95" target="_blank" rel="noopener noreferrer">#</a>3.3.2 页面加载时间菜单</span></a></h4><p>修改seckill-index.html</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211228183316377.9385b4e4.png" alt="image-20211228183316377"></p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token number">333</span></span>
<span class="line">          <span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">el</span><span class="token operator">:</span> <span class="token string">&#39;#app&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token literal-property property">goodslist</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token literal-property property">dateMenus</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">methods</span><span class="token operator">:</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token function-variable function">loadMenus</span><span class="token operator">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/api/wseckillgoods/timeMenus&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                        app<span class="token punctuation">.</span>dateMenus<span class="token operator">=</span>response<span class="token punctuation">.</span>data<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">                        <span class="token comment">//查询当前时间段对应的秒杀商品</span></span>
<span class="line">                    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token function-variable function">created</span><span class="token operator">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loadMenus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22</p><p>1查看以下代码</p><div class="language-html line-numbers-mode" data-highlighter="prismjs" data-ext="html" data-title="html"><pre><code><span class="line">114 - 123</span>
<span class="line">			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item-time active<span class="token punctuation">&quot;</span></span></span>
<span class="line">				 <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>(item,index) in dateMenus<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>time-clock<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{item}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>time-state-on<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>on-text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>index==0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>快抢中<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>on-over<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>index==0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>距离结束：01:02:03<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span>
<span class="line">					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>on-text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>index&gt;0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>即将开始<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>on-over<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>index&gt;0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>距离开始：03:02:01<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12</p><p>2通过网关访问，需要将 moment.min.js 放入网关的静态资源中</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211228183457892.72e70fbf.png" alt="image-20211228183457892"></p><p>3启动web-seckill 重启,访问 http://localhost:8001/api/wseckillgoods/toIndex</p><p>效果如下：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211228184523710.39f0d525.png" alt="image-20211228184523710"></p><h4 id="_3-3-3-时间格式化" tabindex="-1"><a class="header-anchor" href="#_3-3-3-时间格式化"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-3-3-%E6%97%B6%E9%97%B4%E6%A0%BC%E5%BC%8F%E5%8C%96" target="_blank" rel="noopener noreferrer">#</a>3.3.3 时间格式化</span></a></h4><p>上面菜单循环输出后，会出现如上图效果，时间格式全部不对，我们需要引入一个moment.min.js来格式化时间。</p><p>1）引入moment.min.js</p><p>2）添加过滤器</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token number">356</span></span>
<span class="line"><span class="token comment">//过滤器</span></span>
<span class="line">Vue<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token string">&quot;dateFilter&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">date<span class="token punctuation">,</span> formatPattern</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">moment</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>formatPattern <span class="token operator">||</span> <span class="token string">&quot;YYYY-MM-DD HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><ol><li>取值格式化</li></ol><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">94</span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>time-clock<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{item | dateFilter(&#39;HH:mm&#39;)}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><p>重启webseckill,重新访问：http://localhost:8001/api/wseckillgoods/toIndex 。时间菜单效果如下</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211228220700312.51c6c1f3.png" alt="image-20211228220700312"></p><h4 id="_3-3-4-选中实现-了解" tabindex="-1"><a class="header-anchor" href="#_3-3-4-选中实现-了解"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-3-4-%E9%80%89%E4%B8%AD%E5%AE%9E%E7%8E%B0-%E4%BA%86%E8%A7%A3" target="_blank" rel="noopener noreferrer">#</a>3.3.4 选中实现 -了解</span></a></h4><h5 id="_3-3-4-1-思路分析" tabindex="-1"><a class="header-anchor" href="#_3-3-4-1-思路分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-3-4-1-%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>3.3.4.1 思路分析</span></a></h5><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211227225123244.a6b4bd7b.png" alt="image-20211227225123244"></p><p>根据原型图，是让当前第一个时间菜单为选中状态，并且加载第一个菜单对应的数据。</p><p>我们可以先定义一个ctime=0，用来记录当前选中的菜单下标，因为默认第一个选中，第一个下标为0，所以初始值为0，每次点击对应菜单的时候，将被点击的菜单的下标值赋值给ctime,然后在每个菜单上判断，下标=ctime则让该菜单选中。</p><h5 id="_3-3-4-2-代码实现" tabindex="-1"><a class="header-anchor" href="#_3-3-4-2-代码实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-3-4-2-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>3.3.4.2 代码实现</span></a></h5><p>1）定义ctime=0</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">el</span><span class="token operator">:</span> <span class="token string">&#39;#app&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">goodslist</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">dateMenus</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">ctime</span><span class="token operator">:</span><span class="token number">0</span>     <span class="token comment">//当前时间菜单选中的下标</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10</p><p>2）页面样式控制：</p><div class="language-html line-numbers-mode" data-highlighter="prismjs" data-ext="html" data-title="html"><pre><code><span class="line">114-123</span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item-time <span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>(item,index) in dateMenus<span class="token punctuation">&quot;</span></span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>[&#39;item-time&#39;,index==ctime?&#39;active&#39;:&#39;&#39;]<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ctime=index;<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>time-clock<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{item | dateFilter(&#39;HH:mm&#39;)}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>time-state-on<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>on-text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>index==0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>快抢中<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>on-over<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>index==0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>距离结束：01:02:34<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span>
<span class="line">                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>on-text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>index&gt;0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>即将开始<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>on-over<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>index&gt;0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>距离开始：01:02:34<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11</p><p>重启webseckill,重新访问：http://localhost:8001/api/wseckillgoods/toIndex 。时间菜单效果如下</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211228221742713.c804fc90.png" alt="image-20211228221742713"></p><h4 id="_3-3-5-倒计时实现" tabindex="-1"><a class="header-anchor" href="#_3-3-5-倒计时实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-3-5-%E5%80%92%E8%AE%A1%E6%97%B6%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>3.3.5 倒计时实现</span></a></h4><h5 id="_3-3-5-1-倒计时实现" tabindex="-1"><a class="header-anchor" href="#_3-3-5-1-倒计时实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-3-5-1-%E5%80%92%E8%AE%A1%E6%97%B6%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>3.3.5.1 倒计时实现</span></a></h5><h6 id="_3-3-5-1-1-基础数据显示" tabindex="-1"><a class="header-anchor" href="#_3-3-5-1-1-基础数据显示"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-3-5-1-1-%E5%9F%BA%E7%A1%80%E6%95%B0%E6%8D%AE%E6%98%BE%E7%A4%BA" target="_blank" rel="noopener noreferrer">#</a>3.3.5.1.1 基础数据显示</span></a></h6><p>定义一个集合，用于存放五个时间段的倒计时时间差，集合中每一个角标都对应一个倒计时时间差，比如：集合角标为0，对应第一个倒计时时间差。集合角标为1，对应第二个倒计时时间差，依次类推。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211228233511074.5642d26d.png" alt="image-20211228233511074"></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">alltimes:[5555555,66666666,77777777,888888888,9999999999]</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>2从该集合中获取内容，并更新倒计时时间</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211228233617374.a6178690.png" alt="image-20211228233617374"></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">118 &lt;span class=&quot;on-over&quot; v-if=&quot;index==0&quot;&gt;距离结束：{{alltimes[index]}}&lt;/span&gt;</span>
<span class="line">122  &lt;span class=&quot;on-over&quot; v-if=&quot;index&gt;0&quot;&gt;距离开始：{{alltimes[index]}}&lt;/span&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><p>重启webseckill,重新访问：http://localhost:8001/api/wseckillgoods/toIndex 。时间菜单效果如下</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211228222758434.8465bb69.png" alt="image-20211228222758434"></p><h6 id="_3-3-5-1-2-每个时间差倒计时实现" tabindex="-1"><a class="header-anchor" href="#_3-3-5-1-2-每个时间差倒计时实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-3-5-1-2-%E6%AF%8F%E4%B8%AA%E6%97%B6%E9%97%B4%E5%B7%AE%E5%80%92%E8%AE%A1%E6%97%B6%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>3.3.5.1.2 每个时间差倒计时实现</span></a></h6><p>周期执行函数用法如下：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">window.setInterval(function(){//要做的事},1000);</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>结束执行周期函数用法如下：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">window.clearInterval(timers);</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>具体代码如下：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211228233649926.2b77aac3.png" alt="image-20211228233649926"></p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token number">354</span></span>
<span class="line"><span class="token comment">//时间差递减</span></span>
<span class="line"><span class="token keyword">let</span> timers <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>app<span class="token punctuation">.</span>alltimes<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//时间递减</span></span>
<span class="line">        app<span class="token punctuation">.</span><span class="token function">$set</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>alltimes<span class="token punctuation">,</span>i<span class="token punctuation">,</span>app<span class="token punctuation">.</span>alltimes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>alltimes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//停止倒计时</span></span>
<span class="line">            window<span class="token punctuation">.</span><span class="token function">clearInterval</span><span class="token punctuation">(</span>timers<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">//当任意一个时间&lt;=0的时候，需要重新刷新菜单，并刷新对应的数据</span></span>
<span class="line">            app<span class="token punctuation">.</span><span class="token function">loadMenus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14</p><p>重启webseckill,重新访问：http://localhost:8001/api/wseckillgoods/toIndex 。时间菜单效果如下可以发现每一个时间段的时间都在每秒递减。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211228223420084.224a7a1f.png" alt="image-20211228223420084"></p><h6 id="_3-3-5-1-3-倒计时时间格式化" tabindex="-1"><a class="header-anchor" href="#_3-3-5-1-3-倒计时时间格式化"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-3-5-1-3-%E5%80%92%E8%AE%A1%E6%97%B6%E6%97%B6%E9%97%B4%E6%A0%BC%E5%BC%8F%E5%8C%96" target="_blank" rel="noopener noreferrer">#</a>3.3.5.1.3 倒计时时间格式化</span></a></h6><p>将此工具引入页面js方法中，用于时间计算。注意和loadMenus方法平行</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token number">369</span><span class="token operator">-</span><span class="token number">383</span></span>
<span class="line"><span class="token comment">//将毫秒转换成时分秒</span></span>
<span class="line"><span class="token function-variable function">timedown</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> oneSecond <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">var</span> oneMinute<span class="token operator">=</span>oneSecond<span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">var</span> oneHour<span class="token operator">=</span>oneMinute<span class="token operator">*</span><span class="token number">60</span></span>
<span class="line">    <span class="token comment">//小时</span></span>
<span class="line">    <span class="token keyword">var</span> hours <span class="token operator">=</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>num<span class="token operator">/</span>oneHour<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//分钟</span></span>
<span class="line">    <span class="token keyword">var</span> minutes<span class="token operator">=</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>num<span class="token operator">%</span>oneHour<span class="token punctuation">)</span><span class="token operator">/</span>oneMinute<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//秒</span></span>
<span class="line">    <span class="token keyword">var</span> seconds<span class="token operator">=</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>num<span class="token operator">%</span>oneMinute<span class="token punctuation">)</span><span class="token operator">/</span>oneSecond<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//拼接时间格式</span></span>
<span class="line">    <span class="token keyword">var</span> str <span class="token operator">=</span> hours<span class="token operator">+</span><span class="token string">&#39;:&#39;</span><span class="token operator">+</span>minutes<span class="token operator">+</span><span class="token string">&#39;:&#39;</span><span class="token operator">+</span>seconds<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> str<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16</p><p>修改时间差显示设置</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211228233710801.d1626944.png" alt="image-20211228233710801"></p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">117-123</span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>time-state-on<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>on-text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>index==0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>快抢中<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>on-over<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>index==0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>距离结束：{{timedown(alltimes[index])}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>on-text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>index&gt;0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>即将开始<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>on-over<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>index&gt;0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>距离开始：{{timedown(alltimes[index])}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8</p><p>重新访问进行测试。效果如下：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211228223724484.7663f5b3.png" alt="image-20211228223724484"></p><h6 id="_3-3-5-1-4-正确倒计时时间显示" tabindex="-1"><a class="header-anchor" href="#_3-3-5-1-4-正确倒计时时间显示"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-3-5-1-4-%E6%AD%A3%E7%A1%AE%E5%80%92%E8%AE%A1%E6%97%B6%E6%97%B6%E9%97%B4%E6%98%BE%E7%A4%BA" target="_blank" rel="noopener noreferrer">#</a>3.3.5.1.4 正确倒计时时间显示</span></a></h6><p>现在页面中，对于倒计时时间集合内的数据，暂时写的为假数据，现在需要让集合内容的数据是经过计算得出的。第一个是距离结束时间倒计时，后面的4个都是距离开始倒计时，每个倒计时其实就是2个时差，计算方式如下：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">第1个时差：第2个抢购开始时间-当前时间，距离结束时间</span>
<span class="line">第2个时差：第2个抢购开始时间-当前时间，距离开始时间</span>
<span class="line">第3个时差：第3个抢购开始时间-当前时间，距离开始时间</span>
<span class="line">第4个时差：第4个抢购开始时间-当前时间，距离开始时间</span>
<span class="line">第5个时差：第5个抢购开始时间-当前时间，距离开始时间</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211228233749415.e772a6da.png" alt="image-20211228233749415"></p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token function-variable function">loadMenus</span><span class="token operator">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/wseckill/timeMenus&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        app<span class="token punctuation">.</span>dateMenus<span class="token operator">=</span>response<span class="token punctuation">.</span>data<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//查询当前时间段对应的秒杀商品</span></span>
<span class="line"></span>
<span class="line"><span class="token number">353</span><span class="token operator">-</span><span class="token number">362</span> <span class="token comment">//循环所有时间菜单</span></span>
<span class="line">        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>app<span class="token punctuation">.</span>dateMenus<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//运算每个时间菜单倒计时时间差</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">//距离结束时间</span></span>
<span class="line">                <span class="token keyword">var</span> x <span class="token operator">=</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">                app<span class="token punctuation">.</span><span class="token function">$set</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>alltimes<span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>dateMenus<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">//距离开始时间</span></span>
<span class="line">                app<span class="token punctuation">.</span><span class="token function">$set</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>alltimes<span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>dateMenus<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//时间差递减</span></span>
<span class="line">        <span class="token keyword">let</span> timers <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>app<span class="token punctuation">.</span>alltimes<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">//时间递减</span></span>
<span class="line">                app<span class="token punctuation">.</span><span class="token function">$set</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>alltimes<span class="token punctuation">,</span>i<span class="token punctuation">,</span>app<span class="token punctuation">.</span>alltimes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28</p><p>清空alltimes数据</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">alltimes:[]</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>重启webseckill,重新访问：http://localhost:8001/api/wseckillgoods/toIndex 。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211228224140244.15daa036.png" alt="image-20211228224140244"></p><h3 id="_3-4-加载秒杀商品实现" tabindex="-1"><a class="header-anchor" href="#_3-4-加载秒杀商品实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-4-%E5%8A%A0%E8%BD%BD%E7%A7%92%E6%9D%80%E5%95%86%E5%93%81%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>3.4 加载秒杀商品实现</span></a></h3><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211228224817607.5264046a.png" alt="image-20211228224817607"></p><p>当前已经完成了秒杀时间段菜单的显示，那么当用户在切换不同的时间段的时候，需要按照用户所选择的时间去显示相对应时间段下的秒杀商品。</p><h4 id="_3-4-1-秒杀服务-查询秒杀商品列表" tabindex="-1"><a class="header-anchor" href="#_3-4-1-秒杀服务-查询秒杀商品列表"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-4-1-%E7%A7%92%E6%9D%80%E6%9C%8D%E5%8A%A1-%E6%9F%A5%E8%AF%A2%E7%A7%92%E6%9D%80%E5%95%86%E5%93%81%E5%88%97%E8%A1%A8" target="_blank" rel="noopener noreferrer">#</a>3.4.1 秒杀服务-查询秒杀商品列表</span></a></h4><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211228224907652.e418be13.png" alt="image-20211228224907652"></p><h5 id="_3-4-1-1-秒杀服务-service" tabindex="-1"><a class="header-anchor" href="#_3-4-1-1-秒杀服务-service"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-4-1-1-%E7%A7%92%E6%9D%80%E6%9C%8D%E5%8A%A1-service" target="_blank" rel="noopener noreferrer">#</a>3.4.1.1 秒杀服务- service</span></a></h5><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SecKillGoodsService</span> <span class="token punctuation">{</span></span>
<span class="line">     <span class="token comment">//查询秒杀商品列表</span></span>
<span class="line">    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token class-name">String</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p>实现类</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Service</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecKillGoodsServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">SecKillGoodsService</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SECKILL_KEY</span> <span class="token operator">=</span> <span class="token string">&quot;seckill_goods_&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 查询秒杀商品列表</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">time</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token class-name">String</span> time<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token constant">SECKILL_KEY</span><span class="token operator">+</span>time<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18</p><h5 id="_3-4-1-2-秒杀服务-controller" tabindex="-1"><a class="header-anchor" href="#_3-4-1-2-秒杀服务-controller"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-4-1-2-%E7%A7%92%E6%9D%80%E6%9C%8D%E5%8A%A1-controller" target="_blank" rel="noopener noreferrer">#</a>3.4.1.2 秒杀服务-controller</span></a></h5><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@RestController</span></span>
<span class="line"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/seckillgoods&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecKillController</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">SecKillGoodsService</span> secKillGoodsService<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 查询秒杀商品列表</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">time</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/list&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;time&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> time<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span> seckillGoodsList  <span class="token operator">=</span> secKillGoodsService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span><span class="token string">&quot;查询秒杀商品成功&quot;</span><span class="token punctuation">,</span>seckillGoodsList<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18</p><h5 id="_3-4-1-3-杀服务api-feign接口定义" tabindex="-1"><a class="header-anchor" href="#_3-4-1-3-杀服务api-feign接口定义"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-4-1-3-%E6%9D%80%E6%9C%8D%E5%8A%A1api-feign%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89" target="_blank" rel="noopener noreferrer">#</a>3.4.1.3 杀服务Api- feign接口定义</span></a></h5><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;seckill&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SecKillFeign</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 查询秒杀商品列表</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">time</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/seckillgoods/list&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;time&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11</p><h5 id="_3-4-1-4-查询秒杀商品放行-想想为什么" tabindex="-1"><a class="header-anchor" href="#_3-4-1-4-查询秒杀商品放行-想想为什么"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-4-1-4-%E6%9F%A5%E8%AF%A2%E7%A7%92%E6%9D%80%E5%95%86%E5%93%81%E6%94%BE%E8%A1%8C-%E6%83%B3%E6%83%B3%E4%B8%BA%E4%BB%80%E4%B9%88" target="_blank" rel="noopener noreferrer">#</a>3.4.1.4 查询秒杀商品放行-想想为什么</span></a></h5><p>更改秒杀微服务的ResourceServerConfig类，对查询方法放行</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//所有请求必须认证通过</span></span>
<span class="line">    http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">//下边的路径放行</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token string">&quot;/seckillgoods/list/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token comment">//配置地址放行</span></span>
<span class="line">        <span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span></span>
<span class="line">        <span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//其他地址需要认证授权</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11</p><h4 id="_3-4-2-秒杀渲染服务-查询秒杀商品列表" tabindex="-1"><a class="header-anchor" href="#_3-4-2-秒杀渲染服务-查询秒杀商品列表"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-4-2-%E7%A7%92%E6%9D%80%E6%B8%B2%E6%9F%93%E6%9C%8D%E5%8A%A1-%E6%9F%A5%E8%AF%A2%E7%A7%92%E6%9D%80%E5%95%86%E5%93%81%E5%88%97%E8%A1%A8" target="_blank" rel="noopener noreferrer">#</a>3.4.2 秒杀渲染服务-查询秒杀商品列表</span></a></h4><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211228230009990.8720a9b4.png" alt="image-20211228230009990"></p><p>oauth2 :1 导包 2公钥 3配置类</p><p>调用feign：1导包 api 2EnableFeignClients 3feign拦截器</p><h5 id="_3-4-2-1-更新ydles-web-seckill的启动类" tabindex="-1"><a class="header-anchor" href="#_3-4-2-1-更新ydles-web-seckill的启动类"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-4-2-1-%E6%9B%B4%E6%96%B0ydles-web-seckill%E7%9A%84%E5%90%AF%E5%8A%A8%E7%B1%BB" target="_blank" rel="noopener noreferrer">#</a>3.4.2.1 更新ydles_web_seckill的启动类</span></a></h5><p>添加feign接口扫描</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">&quot;com.ydles.seckill.feign&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><h5 id="_3-4-2-2-更新ydles-web-seckill的seckillgoodscontroller" tabindex="-1"><a class="header-anchor" href="#_3-4-2-2-更新ydles-web-seckill的seckillgoodscontroller"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-4-2-2-%E6%9B%B4%E6%96%B0ydles-web-seckill%E7%9A%84seckillgoodscontroller" target="_blank" rel="noopener noreferrer">#</a>3.4.2.2 更新ydles_web_seckill的SecKillGoodsController</span></a></h5><p>注入secKillFeign，并添加获取秒杀商品列表方法实现</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line">     * 获取秒杀商品列表</span>
<span class="line">     * 默认当前时间</span>
<span class="line">     */</span></span>
<span class="line"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/list&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token annotation punctuation">@ResponseBody</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token class-name">String</span> time<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    	<span class="token class-name">String</span> timeStr <span class="token operator">=</span> <span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">formatStr</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>timeStr<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> secKillGoodsFeign<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span>timeStr<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11</p><h5 id="_3-4-2-3-更新seckill-index-html。添加按照时间查询方法" tabindex="-1"><a class="header-anchor" href="#_3-4-2-3-更新seckill-index-html。添加按照时间查询方法"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-4-2-3-%E6%9B%B4%E6%96%B0seckill-index-html%E3%80%82%E6%B7%BB%E5%8A%A0%E6%8C%89%E7%85%A7%E6%97%B6%E9%97%B4%E6%9F%A5%E8%AF%A2%E6%96%B9%E6%B3%95" target="_blank" rel="noopener noreferrer">#</a>3.4.2.3 更新secKill-index.html。添加按照时间查询方法</span></a></h5><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20200310181130832.b7ad38fc.png" alt="image-20200310181130832"></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token number">395</span><span class="token operator">-</span><span class="token number">402</span></span>
<span class="line"><span class="token comment">//按照时间查询秒杀商品列表</span></span>
<span class="line">searchList<span class="token operator">:</span>function <span class="token punctuation">(</span>time<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>&#39;<span class="token operator">/</span>api<span class="token operator">/</span>wseckillgoods<span class="token operator">/</span>list<span class="token operator">?</span>time<span class="token operator">=</span>&#39;<span class="token operator">+</span>time<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>function <span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>flag<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            app<span class="token punctuation">.</span>goodslist <span class="token operator">=</span> response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>data<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9</p><h5 id="_3-4-2-4-更新seckill-index-html。-加载页面时-默认当前时间查询" tabindex="-1"><a class="header-anchor" href="#_3-4-2-4-更新seckill-index-html。-加载页面时-默认当前时间查询"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-4-2-4-%E6%9B%B4%E6%96%B0seckill-index-html%E3%80%82-%E5%8A%A0%E8%BD%BD%E9%A1%B5%E9%9D%A2%E6%97%B6-%E9%BB%98%E8%AE%A4%E5%BD%93%E5%89%8D%E6%97%B6%E9%97%B4%E6%9F%A5%E8%AF%A2" target="_blank" rel="noopener noreferrer">#</a>3.4.2.4 更新secKill-index.html。 加载页面时，默认当前时间查询</span></a></h5><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211228233810290.2e074c3a.png" alt="image-20211228233810290"></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token number">352</span><span class="token operator">-</span><span class="token number">353</span></span>
<span class="line"><span class="token comment">//查询当前时间段对应的秒杀商品</span></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">searchList</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>dateMenus<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3</p><h5 id="_3-4-2-5-更新seckill-index-html。切换时间菜单-查询秒杀商品" tabindex="-1"><a class="header-anchor" href="#_3-4-2-5-更新seckill-index-html。切换时间菜单-查询秒杀商品"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-4-2-5-%E6%9B%B4%E6%96%B0seckill-index-html%E3%80%82%E5%88%87%E6%8D%A2%E6%97%B6%E9%97%B4%E8%8F%9C%E5%8D%95-%E6%9F%A5%E8%AF%A2%E7%A7%92%E6%9D%80%E5%95%86%E5%93%81" target="_blank" rel="noopener noreferrer">#</a>3.4.2.5 更新secKill-index.html。切换时间菜单,查询秒杀商品</span></a></h5><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211228233831720.d51ed71c.png" alt="image-20211228233831720"></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token number">114</span><span class="token operator">-</span><span class="token number">117</span></span>
<span class="line">    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;item-time &quot;</span></span>
<span class="line">     v<span class="token operator">-</span><span class="token keyword">for</span><span class="token operator">=</span><span class="token string">&quot;(item,index) in dateMenus&quot;</span></span>
<span class="line">     <span class="token operator">:</span><span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;[&#39;item-time&#39;,index==ctime?&#39;active&#39;:&#39;&#39;]&quot;</span></span>
<span class="line">     <span class="token annotation punctuation">@click</span><span class="token operator">=</span><span class="token string">&quot;ctime=index;searchList(item)&quot;</span><span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p>重启秒杀和秒杀页面服务， http://localhost:8001/api/wseckillgoods/toIndex</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211228232748991.0450b613.png" alt="image-20211228232748991"></p><h3 id="_3-5-抢购按钮" tabindex="-1"><a class="header-anchor" href="#_3-5-抢购按钮"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-5-%E6%8A%A2%E8%B4%AD%E6%8C%89%E9%92%AE" target="_blank" rel="noopener noreferrer">#</a>3.5 抢购按钮</span></a></h3><p>因为当前业务设定为用户秒杀商品为sku，所以当用户点击立即抢购按钮的时候，则直接进行下单操作。</p><h4 id="_3-5-1-js定义" tabindex="-1"><a class="header-anchor" href="#_3-5-1-js定义"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-5-1-js%E5%AE%9A%E4%B9%89" target="_blank" rel="noopener noreferrer">#</a>3.5.1 js定义</span></a></h4><p>在秒杀首页添加下单方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token number">407</span><span class="token operator">-</span><span class="token number">416</span></span>
<span class="line"><span class="token comment">//秒杀下单</span></span>
<span class="line">add<span class="token operator">:</span><span class="token function">function</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    app<span class="token punctuation">.</span>msg <span class="token operator">=</span><span class="token char">&#39;正在下单&#39;</span><span class="token punctuation">;</span></span>
<span class="line">    axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/api/wseckillorder/add?time=&quot;</span><span class="token operator">+</span><span class="token function">moment</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>dateMenus<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;YYYYMMDDHH&quot;</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;&amp;id=&quot;</span><span class="token operator">+</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>function <span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>flag<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            app<span class="token punctuation">.</span>msg<span class="token operator">=</span>&#39;抢单成功，即将进入支付<span class="token operator">!</span>&#39;<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">            app<span class="token punctuation">.</span>msg<span class="token operator">=</span><span class="token char">&#39;抢单失败&#39;</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12</p><h4 id="_3-5-2-调用下单方法" tabindex="-1"><a class="header-anchor" href="#_3-5-2-调用下单方法"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-5-2-%E8%B0%83%E7%94%A8%E4%B8%8B%E5%8D%95%E6%96%B9%E6%B3%95" target="_blank" rel="noopener noreferrer">#</a>3.5.2 调用下单方法</span></a></h4><p>修改抢购按钮，添加事件</p><div class="language-html line-numbers-mode" data-highlighter="prismjs" data-ext="html" data-title="html"><pre><code><span class="line">156</span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&#39;</span>sui-btn btn-block btn-buy<span class="token punctuation">&#39;</span></span>  <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&#39;</span>javascript:void(0)<span class="token punctuation">&#39;</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>add(item.id)<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>立即抢购<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><h4 id="_3-5-3-秒杀web页面-新增controller" tabindex="-1"><a class="header-anchor" href="#_3-5-3-秒杀web页面-新增controller"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-5-3-%E7%A7%92%E6%9D%80web%E9%A1%B5%E9%9D%A2-%E6%96%B0%E5%A2%9Econtroller" target="_blank" rel="noopener noreferrer">#</a>3.5.3 秒杀web页面 新增Controller</span></a></h4><p>SecKillOrderController</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@RestController</span></span>
<span class="line"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/wseckillorder&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecKillOrderController</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/add&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;time&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> time<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"> 		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;进入秒杀订单逻辑了！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10</p><p>网关配置：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">        #秒杀渲染微服务</span>
<span class="line">        - id: ydles_seckill_web_route</span>
<span class="line">          uri: lb://seckill-web</span>
<span class="line">          predicates:</span>
<span class="line">            - Path=/api/wseckillgoods/**,/api/wseckillorder/**</span>
<span class="line">          filters:</span>
<span class="line">            - StripPrefix=1</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><p>测试：重启秒杀页面，网关服务， 访问http://localhost:8001/api/wseckillgoods/toIndex ，点击立即抢购</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211228235033816.c450b648.png" alt="image-20211228235033816"></p><p>后台打印：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIEAAAAmCAYAAADjufgGAAAH7ElEQVR4nO2b607bXBaGH4/mMuIcZIw0f+Y/iRJZOXAJ7YgISmtAQy/gS0WmJJSCPnoBTTUktFCl+ugdDDnIShVyDyRWTtzHnh8OIecTaT9pxo/ED+x4ey/v1+vdawWklb/9XWDzf81f/uwJ2Pz52CKwsUVgY4vABlsENtgisMEWgQ22CGywRWCDLQIb5hSBUJThY+EkX450IsrTus+qnuE4PDz+z0YNj567qif/lPmMQgiF3aMkuz9pPjOJQFWC7B5lKH5KjXwwDurkTGn6OGGdXT2IKvofuggnST0HXAydewpCBDk+Ck78zF2uTiB+wXH48b5CBNnyyU+4r8LuRYZjPYgqlJExz4MkmTSQcVJbeIxJ/HXcCVUJomnQaHoIbHhpnbwilJi+0JOo5jPcCYX1nSPiTshefaXh2ST1m8z1/ivOTQmk0fdQlSBuz3z3c/tjeL0SX/Qm2xlz5GckqchVOUrKH4J8EYDVnQB8e8Xb/GLxSpJJo+3AR5OqZHJnaFzmLig/xLggrfrCl05krAiqZpGqaanaveEdOq8qQagVuOv8LhSFVWpUpwQpSSa5TJIbobD3+SMxxz2V69OpD+dhPoMIobD3+QBORjzgfJHzMeOpepItSpSaQPOW6yZEwkHAQ8DZptQMEQlDYCOKXD4dK6JZkMwM2YqXgGcFFaiaj2ONE3dgI4Zcfv2k+87KWBFMQggFLR7DV27yomkdk0wT99EFWz9OeZufPHEhFNbfHeBrn7F/Alr8I3nfPZVv069dHjIyTXI994sc/YfAj3Xe9mY8fxS3UQOGRSoUnfdxmda3Eo2Bc27ucfg0Ik2XdeBHlpLrgE8xmduz/W6cveJW9QxxLMHlOlnpVzBSBEIorEZcuAHw4ATQQhzHY6y1zwgdgtNRIZuuQeTxupvDLIHcR764xitYDets+WVKV6dsd96I6qsihp7hUyzFF9f+L1H/spAdUMoVyA3YmCDAc399YDGL5DKzjdu/BuCWwamFiHSyxjIy1AMjRSBJJtW8SRVL7VEHlI0C55lOQCs6cqU0FLgkFbm6jpLyaajpGtWe82pYR3NBw0h3vVbVM8Sdt2Sv0uQyOv9sJkltDF87C04PMO/zcGpEwq7ur24ZZJdlA73HFkb2oArRjUUNK1RnzHR9ayAU9jagZRTImVLHoqE1JkPNy3Q78MjIkoxTW0GtdRbHI9P+kR45gTvjloqzPrSI1XyGqhVe/wUto1tZVPNJwnlAklAVpc87p9EixO5RFB8dUc2yAWsZ/Xbgj+FsFsj1bAgj/mj3bZyLept7h4wbOgsZZOu3GPKELDmZNo3lrPkQE0VgKXANIdq0mhrx3AHl/Vc0/FA6HJ6QEArrpPs8VQ0Hxz5Et+UzfW8jAP4ob7wy7T/msIZ6gfN8ESOcJJ66IXb/nf2X6bkzyvzIuCOhriu6N6L4yqe8SNdp48W9ApiwuhNl7f47++na2ApoPC6ctDGWPPMHJmeCyCa+9neu8UI9Tbbixe0J4W595XxEIKs7B8Seg7unFKrmi50MMIzqiuKj/20EIF8kt0g0WNnkRV3nMvWM1Ls64cSEDdYy7OD+FiNXoCpJ3bRdNmpIkkmpEiPgAVFT0HwO7svGYqJc8SC3B7Pr8jLD2GaREAp7fsgePuovl9AxACM93LQQik78OY/1/hgiRxl2Bzp0QihE9Kd3HR+QzAwvPlSotJqTP9gyyOWL3Z9GG9rNQv+xcnto5z8rjdY9a/4QRDZ5/rCRnoOHDu2q5oW+WFw4HQtOagRjRbC6swlXCW4GjlfzxT5FSvkkocMme/FnMKXeF4pOdM2BTwv1ddAkyeQmbcDWBcf6clqjUj7J2wlWUs3oM1lNLpMkZ1p7lJFdv6E39JE745b7tSiXG2tUPiSGNtIjcWrs6kmO9SCr1Kxy3Gdll5/F6BJRCaI1EzN1t7o1/5TGhhAKe/FntD+8tmpkSULtOS9JJjeHp7g/fyTv+zl+Plh2DTLKDgBwBXjzDy/i9nf2DwuP8/LI0Op1ahdOR5tSJ01bTaJnxOTvnOTopm41HISOhajhIJo/gE+WgTbZE4Ncd0MsdSw5y3bvWqx4kO8Xz1CDjC4RzeLMAtj7fIBvhnp1/d0Bzm+vJzaDJMnk3y/PcOZi0/18AXrLrlGMqg4seur7HmGuumTKRg1VCXW6foG+xRHhJFG5wr3jGfF3dbYTRevN9nswHjY9rig+spycFIa6rUIEeb8B2ZeFBTaTs7NQxxAeumVe+HbK9pTaV9WTBGboJMJjr2HN119jj8fyx9Ycc18GQihozluMGlSlInfoXKbW4PqrtUkMJ7n0tzl5meZuJcT7VIz8hYezkzpOHi2kmtHZBgZ3eEIEef85QOlkhI14ZBzt0tIy5dwiEEqQva0ozlaWqxlSthrW0YwEbzsqF0JhfWeTqE9GlmXafwxfc5c+5cyYv2H0S4ls4vyR6M5RMjNsr1vpwvpe4ivbCcv2JLPIv/bhfTzGm08S4vb3iUMLRef9Fly9TPQ0mnS2NrzIgCzL3J4lWFbTQJr2b2hCKOy902hcGeBxQb3Z41mLIxSdyzicPNH7+96YJ3xDZ8V5AFfTv+kTIsjeTpPzAQu0BK6BMb5ZJZQg6xo00oWRcau6jtY0OB+TNSNHGaJk2V6iVU4Vgc3/Pvafl9nYIrCxRWCDLQIbbBHYYIvABlsENtgisMEWgQ3wX5K5h5p/QsH/AAAAAElFTkSuQmCC" alt="image-20211228235038565"></p><p>总结：</p><p>1秒杀业务</p><p>三高：</p><p>控制：时间段 数量</p><p>单独：数据库 微服务 页面</p><p>2秒杀商品 存入缓存</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211228160425046.ef44d61e.png" alt="image-20211228160425046"></p><p>3首页</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211228235345701.d0c4208b.png" alt="image-20211228235345701"></p><h2 id="第16章-秒杀后端" tabindex="-1"><a class="header-anchor" href="#第16章-秒杀后端"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#%E7%AC%AC16%E7%AB%A0-%E7%A7%92%E6%9D%80%E5%90%8E%E7%AB%AF" target="_blank" rel="noopener noreferrer">#</a>第16章-秒杀后端</span></a></h2><p>角色：<strong>架构师</strong></p><p>测试：功能测试 压力测试 1万/s 20万/s</p><p>1实现秒杀<strong>异步</strong>下单,掌握如何保证生产者&amp;消费者消息不丢失</p><p>2实现防止恶意刷单</p><p>3实现防止相同商品重复秒杀</p><p>4实现秒杀下单接口隐藏</p><p>5实现下单接口限流</p><h2 id="_1-秒杀异步下单-重点-难点" tabindex="-1"><a class="header-anchor" href="#_1-秒杀异步下单-重点-难点"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-%E7%A7%92%E6%9D%80%E5%BC%82%E6%AD%A5%E4%B8%8B%E5%8D%95-%E9%87%8D%E7%82%B9-%E9%9A%BE%E7%82%B9" target="_blank" rel="noopener noreferrer">#</a>1 秒杀异步下单-重点-难点</span></a></h2><p>用户在下单的时候，需要基于JWT令牌信息进行登陆人信息认证，确定当前订单是属于谁的。</p><p><strong>为什么要异步下单</strong>：针对秒杀的特殊业务场景，仅仅依靠对象缓存或者页面静态化等技术去解决服务端压力还是远远不够。对于数据库压力还是很大，所以需要异步下单，异步是最好的解决办法，但会带来一些额外的程序上的<strong>复杂性</strong>。</p><p><strong>流程：异步 service_seckill接收下单消息---》MQ ------》service_consume 完成剩余操作</strong></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220102104824795.df62ce2b.png" alt="image-20220102104824795"></p><h3 id="_1-1-秒杀服务-下单实现" tabindex="-1"><a class="header-anchor" href="#_1-1-秒杀服务-下单实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-1-%E7%A7%92%E6%9D%80%E6%9C%8D%E5%8A%A1-%E4%B8%8B%E5%8D%95%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>1.1 秒杀服务-下单实现</span></a></h3><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220102115218841.bc39368d.png" alt="image-20220102115218841"></p><p><strong>1）将tokenDecode工具类从order工程放入秒杀服务并声明Bean, ydles_service_seckill服务</strong></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220102115503524.416a3769.png" alt="image-20220102115503524"></p><p>启动类添加</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token annotation punctuation">@Bean</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">TokenDecode</span> <span class="token function">tokenDecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TokenDecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p><strong>2）新建下单controller并声明方法</strong></p><p>ydles_service_seckill服务</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@RestController</span></span>
<span class="line"><span class="token annotation punctuation">@CrossOrigin</span></span>
<span class="line"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/seckillorder&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecKillOrderController</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">TokenDecode</span> tokenDecode<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">SecKillOrderService</span> secKillOrderService<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 秒杀下单</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">time</span> 当前时间段</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">id</span> 秒杀商品id</span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/add&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;time&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> time<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//获取当前登陆人</span></span>
<span class="line">        <span class="token class-name">String</span> username <span class="token operator">=</span> tokenDecode<span class="token punctuation">.</span><span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">boolean</span> result <span class="token operator">=</span> secKillOrderService<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>time<span class="token punctuation">,</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span><span class="token string">&quot;下单成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">ERROR</span><span class="token punctuation">,</span><span class="token string">&quot;下单失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>3) 新建service接口</strong></p><p>ydles_service_seckill服务</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SecKillOrderService</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 秒杀下单</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">id</span> 商品id</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">time</span> 时间段</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">username</span> 登陆人姓名</span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token class-name">String</span> time<span class="token punctuation">,</span> <span class="token class-name">String</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220102121935545.aab9ee49.png" alt="image-20220102121935545"></p><p><strong>4）更改预加载秒杀商品</strong></p><p>当预加载秒杀商品的时候，提前加载每一个商品的库存信息，后续减库存操作也会先<strong>预扣减缓存中的库存再异步扣减mysql数据</strong>。</p><p>预扣减库存会基于redis原子性操作实现</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220102122324659.08477586.png" alt="image-20220102122324659"></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">//秒杀商品库存头</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SECKILL_GOODS_STOCK_COUNT_KEY</span><span class="token operator">=</span><span class="token string">&quot;seckill_goods_stock_count_&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">        </span>
<span class="line"><span class="token comment">//加载秒杀商品的库存</span></span>
<span class="line">redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">SECKILL_GOODS_STOCK_COUNT_KEY</span> <span class="token operator">+</span> seckillGoods<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> seckillGoods<span class="token punctuation">.</span><span class="token function">getStockCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6</p><p><strong>5）秒杀下单业务层实现</strong></p><p>业务逻辑：</p><p>获取秒杀商品数据与库存量数据，如果没有库存则抛出异常</p><p>预扣减库存，如果扣完库存量&lt;0，删除商品数据与库存数据</p><p>如果库存量&gt;=0，创建秒杀订单，并存入redis</p><p>基于mq异步方式完成与mysql数据同步（最终一致性）</p><p><strong>注意：库存数据从redis中取出，转换成String</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">SeckillGoods</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">SeckillOrder</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">SecKillOrderService</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">IdWorker</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RedisTemplate</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * @Created by IT李老师</span>
<span class="line"> * 公主号 “IT李哥交朋友”</span>
<span class="line"> * 个人微 itlils</span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@Service</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecKillOrderServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">SecKillOrderService</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">IdWorker</span> idWorker<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//redis 秒杀商品key开头</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SECKILL_GOODS_KEY</span> <span class="token operator">=</span> <span class="token string">&quot;seckill_goods_&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//秒杀商品库存key头</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SECKILL_GOODS_STOCK_COUNT_KEY</span> <span class="token operator">=</span> <span class="token string">&quot;seckill_goods_stock_count_&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//秒杀下单</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token class-name">String</span> time<span class="token punctuation">,</span> <span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//1redis获取商品的数据以及库存量，如果没有，抛出异常</span></span>
<span class="line">        <span class="token class-name">SeckillGoods</span> seckillGoods <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token constant">SECKILL_GOODS_KEY</span> <span class="token operator">+</span> time<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>seckillGoods <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token comment">//redisTemplate用的是string序列化</span></span>
<span class="line">        <span class="token class-name">String</span> redisStock <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundValueOps</span><span class="token punctuation">(</span><span class="token constant">SECKILL_GOODS_STOCK_COUNT_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>redisStock<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">int</span> stock <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>redisStock<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>stock <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//2预扣减库存，如果扣成0，删除商品信息和库存信息</span></span>
<span class="line">        <span class="token comment">//Integer integer = (Integer) redisTemplate.opsForValue().get(SECKILL_GOODS_STOCK_COUNT_KEY + id);//100</span></span>
<span class="line">        <span class="token comment">//integer=integer-1;//99</span></span>
<span class="line">        <span class="token comment">//redisTemplate.boundValueOps(SECKILL_GOODS_STOCK_COUNT_KEY + id).set(integer);//99</span></span>
<span class="line">        <span class="token class-name">Long</span> decrement <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decrement</span><span class="token punctuation">(</span><span class="token constant">SECKILL_GOODS_STOCK_COUNT_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span>decrement<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//如果扣成0，删除商品信息</span></span>
<span class="line">            redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token constant">SECKILL_GOODS_KEY</span> <span class="token operator">+</span> time<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">//库存信息</span></span>
<span class="line">            redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token constant">SECKILL_GOODS_STOCK_COUNT_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//3生成秒杀订单</span></span>
<span class="line">        <span class="token class-name">SeckillOrder</span> seckillOrder<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">SeckillOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        seckillOrder<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>idWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        seckillOrder<span class="token punctuation">.</span><span class="token function">setSeckillId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        seckillOrder<span class="token punctuation">.</span><span class="token function">setMoney</span><span class="token punctuation">(</span>seckillGoods<span class="token punctuation">.</span><span class="token function">getCostPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        seckillOrder<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        seckillOrder<span class="token punctuation">.</span><span class="token function">setSeckillId</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>seckillGoods<span class="token punctuation">.</span><span class="token function">getSellerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        seckillOrder<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        seckillOrder<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//4订单数据往mq发</span></span>
<span class="line">		</span>
<span class="line">		</span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-2-生产者保证消息不丢失-面试常问问题-重点" tabindex="-1"><a class="header-anchor" href="#_1-2-生产者保证消息不丢失-面试常问问题-重点"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-2-%E7%94%9F%E4%BA%A7%E8%80%85%E4%BF%9D%E8%AF%81%E6%B6%88%E6%81%AF%E4%B8%8D%E4%B8%A2%E5%A4%B1-%E9%9D%A2%E8%AF%95%E5%B8%B8%E9%97%AE%E9%97%AE%E9%A2%98-%E9%87%8D%E7%82%B9" target="_blank" rel="noopener noreferrer">#</a>1.2 生产者保证消息不丢失--面试常问问题-重点</span></a></h3><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220102172807666.d0aa508c.png" alt="image-20220102172807666"></p><p>1rabbitMQ 工作流程。</p><p>生产者：tcp ---&gt;channel--&gt; exchang</p><p>消费者：tcp ------&gt;channal------&gt;queue 一个消费者监听<strong>一个</strong> <strong>队列</strong></p><p>绑定关系：交换机类型----绑定到队列----routingkey</p><p>2持久化</p><p>按照现有rabbitMQ的相关知识，生产者会发送消息到达消息服务器。但是在实际生产环境下，消息生产者发送的消息很有可能当到达了消息服务器之后，由于消息服务器的问题导致消息丢失，如宕机。因为消息服务器默认会将消息存储在内存中。一旦消息服务器宕机，则消息会产生丢失。因此要保证生产者的消息不丢失，要开始<strong>持久化策略</strong>。</p><div class="language-properties line-numbers-mode" data-highlighter="prismjs" data-ext="properties" data-title="properties"><pre><code><span class="line">rabbitMQ持久化：</span>
<span class="line"><span class="token key attr-name">	1.</span> <span class="token value attr-value">交换机持久化</span></span>
<span class="line"><span class="token key attr-name">	2.</span> <span class="token value attr-value">队列持久化</span></span>
<span class="line"><span class="token key attr-name">	3.</span> <span class="token value attr-value">消息持久化</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p>3rabbitmq数据保护机制</p><p>但是如果仅仅只是开启这两部分的持久化，也很有可能造成消息丢失。因为消息服务器很有可能在持久化的过程中出现宕机。因此需要通过数据保护机制来保证消息一定会成功进行持久化，否则将一直进行消息发送。</p><div class="language-properties line-numbers-mode" data-highlighter="prismjs" data-ext="properties" data-title="properties"><pre><code><span class="line">RabbitMQ数据保护机制</span>
<span class="line"><span class="token key attr-name">  1</span> <span class="token value attr-value">事务机制</span></span>
<span class="line">    事务机制采用类数据库的事务机制进行数据保护，当消息到达消息服务器，首先会开启一个事务，接着进行数据磁盘持久化，只有持久化成功才会进行事务提交，向消息生产者返回成功通知，消息生产者一旦接收成功通知则不会再发送此条消息。当出现异常，则返回失败通知.消息生产者一旦接收失败通知，则继续发送该条消息。</span>
<span class="line">    事务机制虽然能够保证数据安全，但是此机制采用的是同步机制，会产生系统间消息阻塞，影响整个系统的消息吞吐量。从而导致整个系统的性能下降，因此不建议使用。</span>
<span class="line">    </span>
<span class="line"><span class="token key attr-name">  2</span> <span class="token value attr-value">confirm机制</span></span>
<span class="line"><span class="token key attr-name">    confirm模式需要基于channel进行设置,</span> <span class="token value attr-value">一旦某条消息被投递到队列之后,消息队列就会发送一个确认信息给生产者,如果队列与消息是可持久化的, 那么确认消息会等到消息成功写入到磁盘之后发出.</span></span>
<span class="line"><span class="token key attr-name">	confirm的性能高,主要得益于它是异步的.生产者在将第一条消息发出之后等待确认消息的同时也可以继续发送后续的消息.当确认消息到达之后,就可以通过回调方法处理这条确认消息.</span> <span class="token value attr-value">如果MQ服务宕机了,则会返回nack消息. 生产者同样在回调方法中进行后续处理。</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220102174038302.25426ed2.png" alt="image-20220102174038302"></p><p>拓展资料： https://www.cnblogs.com/vipstone/p/9350075.html</p><p>4即使我们设计得这么完美，也不能保证数据100%全部发送、接受。</p><p>99.9999999% 机器运行成功率。 aws---&gt;paypal youtube</p><h4 id="_1-2-1-开启confirm机制" tabindex="-1"><a class="header-anchor" href="#_1-2-1-开启confirm机制"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-2-1-%E5%BC%80%E5%90%AFconfirm%E6%9C%BA%E5%88%B6" target="_blank" rel="noopener noreferrer">#</a>1.2.1 开启confirm机制</span></a></h4><p><strong>ydles_service_seckill服务</strong></p><p><strong>1）更改秒杀服务配置文件</strong></p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.200.128</span>
<span class="line">    <span class="token key atrule">publisher-confirms</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment">#开启confirm机制</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3</p><p><strong>2）开启队列持久化</strong> rabbit配置文件</p><p>rabbitMq使用：1导包 2配置文件 3配置类</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Configuration</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitMQConfig</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//秒杀商品订单消息</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SECKILL_ORDER_QUEUE</span><span class="token operator">=</span><span class="token string">&quot;seckill_order&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//声明队列，并开启持久化</span></span>
<span class="line">    <span class="token annotation punctuation">@Bean</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token doc-comment comment">/**</span>
<span class="line">         * 第一个参数：队列名称</span>
<span class="line">         * 第二个参数：是否开启队列持久化</span>
<span class="line">         */</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token constant">SECKILL_ORDER_QUEUE</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16</p><p><strong>3）消息持久化源码查看</strong></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220102175146418.9c7a01b4.png" alt="image-20220102175146418"></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220102175205923.5f2f320e.png" alt="image-20220102175205923"></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220102180304161.ea2c6fb5.png" alt="image-20220102180304161"></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220102180334328.9edf9ec6.png" alt="image-20220102180334328"></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220102180355716.3b529d86.png" alt="image-20220102180355716"></p><p>的确，在消息convert转换的时候，设置属性是持久化的。</p><p>**4）增强rabbitTemplate ** config包下新建。重要：此类相当于我们手动完成confirm逻辑！</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>connection<span class="token punctuation">.</span></span><span class="token class-name">CorrelationData</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RabbitTemplate</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RedisTemplate</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">UUID</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * @Created by IT李老师</span>
<span class="line"> * 公主号 “IT李哥交朋友”</span>
<span class="line"> * 个人微 itlils</span>
<span class="line"> * 消息待发器</span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfirmMessageSender</span> <span class="token keyword">implements</span> <span class="token class-name">RabbitTemplate<span class="token punctuation">.</span>ConfirmCallback</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//redis 放的时候 开头的key</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">MESSAGE_CONFIRM_KEY</span><span class="token operator">=</span><span class="token string">&quot;message_confirm_&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//规定 有个构造器</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">ConfirmMessageSender</span><span class="token punctuation">(</span><span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//本类和容器中的rabbitTemplate 建立联系</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>rabbitTemplate<span class="token operator">=</span>rabbitTemplate<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//使用rabbitTemplate发的消息，必须有回调，回调给本类</span></span>
<span class="line">        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setConfirmCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//回调方法 exchange异步告知这条消息发送成功</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">confirm</span><span class="token punctuation">(</span><span class="token class-name">CorrelationData</span> correlationData<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ack<span class="token punctuation">,</span> <span class="token class-name">String</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span>ack<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//发送成功  删除掉存储空间的数据</span></span>
<span class="line">            redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>correlationData<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token constant">MESSAGE_CONFIRM_KEY</span><span class="token operator">+</span>correlationData<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//发送失败  重发</span></span>
<span class="line">            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token constant">MESSAGE_CONFIRM_KEY</span> <span class="token operator">+</span> correlationData<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">String</span> exchange <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;exchange&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">String</span> routingKey <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;routingKey&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">String</span> message <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">//重发</span></span>
<span class="line">            rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span>routingKey<span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">//预警 调用第三方接口：发短信，发邮件给到运维技术组长。log.warn</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//自定义发送的方法</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">String</span> exchange<span class="token punctuation">,</span><span class="token class-name">String</span> routingKey<span class="token punctuation">,</span><span class="token class-name">String</span> message<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//设置消息的唯一id</span></span>
<span class="line">        <span class="token class-name">CorrelationData</span> correlationData<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">CorrelationData</span><span class="token punctuation">(</span><span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//运维快速的看哪个msg有问题了</span></span>
<span class="line">        redisTemplate<span class="token punctuation">.</span><span class="token function">boundValueOps</span><span class="token punctuation">(</span>correlationData<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//保存发送的信息到 redis</span></span>
<span class="line">        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;exchange&quot;</span><span class="token punctuation">,</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;routingKey&quot;</span><span class="token punctuation">,</span>routingKey<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token constant">MESSAGE_CONFIRM_KEY</span><span class="token operator">+</span>correlationData<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//真正发送</span></span>
<span class="line">        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span>routingKey<span class="token punctuation">,</span>message<span class="token punctuation">,</span>correlationData<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-2-2发送消息" tabindex="-1"><a class="header-anchor" href="#_1-2-2发送消息"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-2-2%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF" target="_blank" rel="noopener noreferrer">#</a><strong>1.2.2发送消息</strong></span></a></h4><p>更改下单业务层实现</p><p>ydles_service_seckill服务SecKillOrderServiceImpl类</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">ConfirmMessageSender</span> confirmMessageSender<span class="token punctuation">;</span>		</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">	<span class="token comment">//发送消息</span></span>
<span class="line">    confirmMessageSender<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token class-name">RabbitMQConfig</span><span class="token punctuation">.</span><span class="token constant">SECKILL_ORDER_KEY</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>seckillOrder<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><p>测试：三个关键位置打断点：</p><p>1add方法</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220102183240326.2c17e172.png" alt="image-20220102183240326"></p><p>2confirmSender 的send</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220102183257423.337a507e.png" alt="image-20220102183257423"></p><p>3confirmSender 回调方法</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220102183310057.583b8381.png" alt="image-20220102183310057"></p><p>4基于网关访问 修改网关路由</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">        #秒杀微服务</span>
<span class="line">        - id: ydles_seckill_route</span>
<span class="line">          uri: lb://seckill</span>
<span class="line">          predicates:</span>
<span class="line">            - Path=/api/seckill/**,/api/seckillorder/**</span>
<span class="line">          filters:</span>
<span class="line">            - StripPrefix=1</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>5重启网关、秒杀服务。</p><p>登陆： http://localhost:8001/api/oauth/toLogin</p><p>根据时间 模拟秒杀： http://localhost:8001/api/seckillorder/add?time=2022-01-02%2018:00:00&amp;id=1</p><h3 id="_1-3-秒杀下单服务-更新库存库" tabindex="-1"><a class="header-anchor" href="#_1-3-秒杀下单服务-更新库存库"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-3-%E7%A7%92%E6%9D%80%E4%B8%8B%E5%8D%95%E6%9C%8D%E5%8A%A1-%E6%9B%B4%E6%96%B0%E5%BA%93%E5%AD%98%E5%BA%93" target="_blank" rel="noopener noreferrer">#</a>1.3 秒杀下单服务-更新库存库</span></a></h3><h4 id="_1-3-1-异步下单服务ydles-service-consume" tabindex="-1"><a class="header-anchor" href="#_1-3-1-异步下单服务ydles-service-consume"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-3-1-%E5%BC%82%E6%AD%A5%E4%B8%8B%E5%8D%95%E6%9C%8D%E5%8A%A1ydles-service-consume" target="_blank" rel="noopener noreferrer">#</a>1.3.1 异步下单服务ydles_service_consume</span></a></h4><p><strong>1）添加依赖</strong></p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ydles_common_db<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ydles_service_order_api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ydles_service_seckill_api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ydles_service_goods_api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-rabbit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2）新建application.yml</strong></p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">server</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9022</span></span>
<span class="line"><span class="token key atrule">spring</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">jackson</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">time-zone</span><span class="token punctuation">:</span> GMT+8</span>
<span class="line">  <span class="token key atrule">application</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> sec<span class="token punctuation">-</span>consume</span>
<span class="line">  <span class="token key atrule">datasource</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver</span>
<span class="line">    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//192.168.200.128<span class="token punctuation">:</span>3306/ydles_seckill<span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;characterEncoding=utf-8&amp;useSSL=false&amp;allowMultiQueries=true&amp;serverTimezone=GMT%2b8</span></span>
<span class="line">    <span class="token key atrule">username</span><span class="token punctuation">:</span> root</span>
<span class="line">    <span class="token key atrule">password</span><span class="token punctuation">:</span> root</span>
<span class="line">  <span class="token key atrule">main</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">allow-bean-definition-overriding</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment">#当遇到同样名字的时候，是否允许覆盖注册</span></span>
<span class="line">  <span class="token key atrule">redis</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.200.128</span>
<span class="line">  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.200.128</span>
<span class="line"><span class="token key atrule">eureka</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">client</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">service-url</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>6868/eureka</span>
<span class="line">  <span class="token key atrule">instance</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line"><span class="token key atrule">feign</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">hystrix</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">  <span class="token key atrule">client</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">config</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">default</span><span class="token punctuation">:</span>   <span class="token comment">#配置全局的feign的调用超时时间  如果 有指定的服务配置 默认的配置不会生效</span></span>
<span class="line">        <span class="token key atrule">connectTimeout</span><span class="token punctuation">:</span> <span class="token number">60000</span> <span class="token comment"># 指定的是 消费者 连接服务提供者的连接超时时间 是否能连接  单位是毫秒</span></span>
<span class="line">        <span class="token key atrule">readTimeout</span><span class="token punctuation">:</span> <span class="token number">20000</span>  <span class="token comment"># 指定的是调用服务提供者的 服务 的超时时间（）  单位是毫秒</span></span>
<span class="line"><span class="token comment">#hystrix 配置</span></span>
<span class="line"><span class="token key atrule">hystrix</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">command</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">default</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">execution</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">timeout</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token comment">#如果enabled设置为false，则请求超时交给ribbon控制</span></span>
<span class="line">          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">        <span class="token key atrule">isolation</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">strategy</span><span class="token punctuation">:</span> SEMAPHORE</span>
<span class="line">          <span class="token key atrule">thread</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># 熔断器超时时间，默认：1000/毫秒</span></span>
<span class="line">            <span class="token key atrule">timeoutInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">20000</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>3）新建启动类</strong> com.ydles.consume</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@SpringBootApplication</span></span>
<span class="line"><span class="token annotation punctuation">@EnableDiscoveryClient</span></span>
<span class="line"><span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;com.ydles.consume.dao&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderConsumerApplication</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">OrderConsumerApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9</p><h4 id="_1-3-2-消费者手动ack下单实现-面试重点-认真听" tabindex="-1"><a class="header-anchor" href="#_1-3-2-消费者手动ack下单实现-面试重点-认真听"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-3-2-%E6%B6%88%E8%B4%B9%E8%80%85%E6%89%8B%E5%8A%A8ack%E4%B8%8B%E5%8D%95%E5%AE%9E%E7%8E%B0-%E9%9D%A2%E8%AF%95%E9%87%8D%E7%82%B9-%E8%AE%A4%E7%9C%9F%E5%90%AC" target="_blank" rel="noopener noreferrer">#</a>1.3.2 消费者手动ACK下单实现--面试重点-认真听</span></a></h4><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220102191752824.0b9d634b.png" alt="image-20220102191752824"></p><p>按照现有RabbitMQ知识，可以得知当消息消费者成功接收到消息后，会进行消费并自动通知消息服务器将该条消息删除。此种方式的实现使用的是消费者自动应答机制。但是此种方式非常的不安全。</p><p>在生产环境下，当消息消费者接收到消息，很有可能在处理消息的过程中出现意外情况从而导致消息丢失，因为如果使用自动应答机制是非常不安全。</p><p>我们需要确保消费者当把消息成功处理完成之后，消息服务器才会将该条消息删除。此时要实现这种效果的话，就需要将<strong>自动应答转换为手动应答</strong>,只有在消息消费者将消息处理完，才会通知消息服务器将该条消息删除。</p><p><strong>1）更改配置文件</strong></p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.200.128</span>
<span class="line">    <span class="token key atrule">listener</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">simple</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">acknowledge-mode</span><span class="token punctuation">:</span> manual <span class="token comment">#手动</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p>mq配置类</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Configuration</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitMQConfig</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//秒杀商品订单消息</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SECKILL_ORDER_QUEUE</span><span class="token operator">=</span><span class="token string">&quot;seckill_order&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//声明队列，并开启持久化</span></span>
<span class="line">    <span class="token annotation punctuation">@Bean</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token doc-comment comment">/**</span>
<span class="line">         * 第一个参数：队列名称</span>
<span class="line">         * 第二个参数：是否开启队列持久化</span>
<span class="line">         */</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token constant">SECKILL_ORDER_QUEUE</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16</p><p><strong>2）定义监听类</strong> <strong>回顾</strong>rabbitMQ与springboot整合时，形参Channel channel, Message message意义。</p><p>com.ydles.consumer.listener</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>consume<span class="token punctuation">.</span>listener</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Channel</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>consume<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">RabbitMQConfig</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>consume<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">SeckillOrderService</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">SeckillOrder</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Message</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RabbitListener</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * @Created by IT李老师</span>
<span class="line"> * 公主号 “IT李哥交朋友”</span>
<span class="line"> * 个人微 itlils</span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecKillOrderListener</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">SeckillOrderService</span> seckillOrderService<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token class-name">RabbitMQConfig</span><span class="token punctuation">.</span><span class="token constant">SECKILL_ORDER_QUEUE</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveMsg</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">String</span> msgStr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;接受到了秒杀订单&quot;</span><span class="token operator">+</span>msgStr<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//1监听 order</span></span>
<span class="line">        <span class="token class-name">SeckillOrder</span> seckillOrder <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SeckillOrder</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//2先做业务逻辑</span></span>
<span class="line">        <span class="token keyword">int</span> result <span class="token operator">=</span> seckillOrderService<span class="token punctuation">.</span><span class="token function">createOrder</span><span class="token punctuation">(</span>seckillOrder<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//2.1没问题    告诉mq收到消息了，可删</span></span>
<span class="line">            <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">                channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">//log.error</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//2.2有问题    告诉mq没收到消息，重回队列</span></span>
<span class="line">            <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">                channel<span class="token punctuation">.</span><span class="token function">basicNack</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">//log.error</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54</p><p>3）定义业务层接口与实现类</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220103094738284.6a1cdef8.png" alt="image-20220103094738284"></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SecKillOrderService</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">int</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">SeckillOrder</span> seckillOrder<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Service</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecKillOrderServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">SecKillOrderService</span>  <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">SeckillGoodsMapper</span> seckillGoodsMapper<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">SeckillOrderMapper</span> seckillOrderMapper<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 同步数据库，更改库存，添加订单</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">seckillOrder</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token annotation punctuation">@Transactional</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">SeckillOrder</span> seckillOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//更改库存</span></span>
<span class="line">        <span class="token keyword">int</span> result <span class="token operator">=</span> seckillGoodsMapper<span class="token punctuation">.</span><span class="token function">updateStockCountById</span><span class="token punctuation">(</span>seckillOrder<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> result<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//添加订单</span></span>
<span class="line">        result <span class="token operator">=</span> seckillOrderMapper<span class="token punctuation">.</span><span class="token function">insertSelective</span><span class="token punctuation">(</span>seckillOrder<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> result<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> result<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32</p><p>4）dao层两个mapper从秒杀服务copy</p><p>5）启动类扫包</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;com.ydles.consumer.dao&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>6)完善 SeckillGoodsMapper</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SeckillGoodsMapper</span> <span class="token keyword">extends</span> <span class="token class-name">Mapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Update</span><span class="token punctuation">(</span><span class="token string">&quot;update tb_seckill_goods set stock_count=stock_count-1 where id=#{id} and stock_count&gt;=1&quot;</span><span class="token punctuation">)</span></span>
<span class="line">   <span class="token keyword">int</span> <span class="token function">updateStockCount</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><div class="language-properties line-numbers-mode" data-highlighter="prismjs" data-ext="properties" data-title="properties"><pre><code><span class="line">数据库字段unsigned介绍</span>
<span class="line"><span class="token key attr-name">	unsigned-----无符号，修饰int</span> <span class="token value attr-value">、char</span></span>
<span class="line">	</span>
<span class="line"><span class="token key attr-name">ALTER</span> <span class="token value attr-value">TABLE tb_seckill_goods MODIFY COLUMN stock_count int(11) UNSIGNED DEFAULT NULL COMMENT &#39;剩余库存数&#39;;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><h3 id="_1-5-流量削峰" tabindex="-1"><a class="header-anchor" href="#_1-5-流量削峰"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-5-%E6%B5%81%E9%87%8F%E5%89%8A%E5%B3%B0" target="_blank" rel="noopener noreferrer">#</a>1.5 流量削峰</span></a></h3><p>在秒杀这种高并发的场景下，每秒都有可能产生几万甚至十几万条消息，如果没有对消息处理量进行任何限制的话，很有可能因为过多的消息堆积从而导致消费者宕机的情况。因此官网建议对每一个消息消费者都设置处理消息总数（<strong>消息抓取总数</strong>）。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220103100123839.90b0ac25.png" alt="image-20220103100123839"></p><p>消息抓取总数的值，设置过大或者过小都不好，过小的话，会导致整个系统消息吞吐能力下降，造成性能浪费。过大的话，则很有可能导致消息过多，导致整个系统OOM(out of memory)内存溢出。因此官网建议每一个消费者将该值设置在<strong>100-300</strong>之间。</p><p>1）更新消费者。</p><p>ydles_service_consume服务SecKillOrderListener监听器</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line">  * 预抓取总数</span>
<span class="line">  */</span></span>
<span class="line"><span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">    channel<span class="token punctuation">.</span><span class="token function">basicQos</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8</p><h3 id="_1-6-秒杀渲染服务-下单实现" tabindex="-1"><a class="header-anchor" href="#_1-6-秒杀渲染服务-下单实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-6-%E7%A7%92%E6%9D%80%E6%B8%B2%E6%9F%93%E6%9C%8D%E5%8A%A1-%E4%B8%8B%E5%8D%95%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>1.6 秒杀渲染服务-下单实现</span></a></h3><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220103100219129.751db1c3.png" alt="image-20220103100219129"></p><p><strong>1）ydles_service_seckill_api服务定义feign接口</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;seckill&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SecKillOrderFeign</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 秒杀下单</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">time</span> 当前时间段</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">id</span> 秒杀商品id</span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/seckillorder/add&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;time&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> time<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13</p><p><strong>2）ydles_web_seckill服务定义controller</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@RestController</span></span>
<span class="line"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/wseckillorder&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecKillOrderController</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">SecKillOrderFeign</span> secKillOrderFeign<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/add&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;time&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> time<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// System.out.println(&quot;进入秒杀订单逻辑了！&quot;);</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">Result</span> result <span class="token operator">=</span> secKillOrderFeign<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> result<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14</p><p><strong>测试：</strong> 重启相关服务，登陆，秒杀 http://localhost:8001/api/wseckillgoods/toIndex</p><p>查看秒杀商品表和秒杀订单表数据变化。redis变化。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGoAAAAxCAYAAAAyaDyjAAADQElEQVR4nO2cP27bMBTGPxbdc4jIKRqkB6ByAhsZOmVMN2mMM2Tsli2D6NEeM2bKUIgniHOAFCkKMndwTvA6yJFkWRLdIrbE9P0AAZYf+R6JT/xjPcKCiAhLnp+fsb+/D6Z7qlp86LAtzF/QoVAWKhSIdXct8AareET5wj8I9b+MhB71MxjziPKFVqGsCiGEWF4xNDRiMcDFAzAbCYhQwQIANOK83GvZMqv2UNm6YAiFgGh9hJv8tMS3CmHjvUYsQigVV3w29bMjrAKohLW2uDEJSUSUUhVDiQRFuSGlCCCZmKJIGhHyujX2qp80IkDSWpEVmvw44lf7sXKf1cVrZ0xCMm9HtZ+7papF84gKPuELZhiJEHUDIEffYSYT3IyD4rvhJRI5w51usJe5iyFGQEpzNBVpjLNJfCcSyeUw+xic4FRuUmf3tEx9Q0yJQHQDnAkIl2BrSHweuEvNHh8h8Yjfbz63bBbfF5qFsgpKA0CA8dwgkQ/4ZWrKDb8ierjAWVlFfY0LnOIkKOzX+dOtoUplo+9zzM0pbgeOHVaTH1d8ACg9CPbHLR5awvSWxnmRiNIIBCyv0mRtEpl9JxPKVoblXJ9flbXNJCTXbPVr3Vpdpx93/Ly9AMkoqqxR5bXRUCKL+/V+7o7qGiWI+F1fH+F3fZ7SQ6Gqv4myqxdvCDrkY9cNWCfbbU67bkbP6OGIYupgoTxBWGvJXYzpmpXt+cvLC/b29rpsD7OkqgVPfZ7AQnkCC+UJLJQnsFCewEJtCzvBcf4K7BgTu6Gt3hkLtR004sEYRymBiEDpEcbfJsX5kkZbC+UcyGKx2F3C5T2TRoRQlXJYhlQYkjIOW4lVLUzLmQnmjZnjqS5D7rRlsFDbYHCIcD4ujg3oa4znG9ha6GGa4x0QnOM+fYIYCcwAIFRQUQgMHLYWeERti+E02ywQge4P8DQ7wkGwga0BHlE7QMcj/FSmNhnaZivDI2orWEyOi2MEV4cG9+fBBrZmOM3RUzjN4SkslCewUJ7AQnkCC+UJYrFY8CkkD+DteU/h7bmnsFCewEJ5AgvlCSyUJ7BQ28J10kjHLX+gsuaMhdoOjpNGOoa4OoR5TR7SFEOHxz/LV5VGiZTmHAAAAABJRU5ErkJggg==" alt="image-20220103101942966"></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220103101928814.908ea721.png" alt="image-20220103101928814"></p><h3 id="_1-7秒杀商品真实数量获取" tabindex="-1"><a class="header-anchor" href="#_1-7秒杀商品真实数量获取"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1-7%E7%A7%92%E6%9D%80%E5%95%86%E5%93%81%E7%9C%9F%E5%AE%9E%E6%95%B0%E9%87%8F%E8%8E%B7%E5%8F%96" target="_blank" rel="noopener noreferrer">#</a>1.7秒杀商品真实数量获取</span></a></h3><p>需求：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220103102444911.31132342.png" alt="image-20220103102444911"></p><p>1从秒杀任务类中拿出 redis秒杀商品库存头</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">	<span class="token comment">//秒杀商品库存头</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SECKILL_GOODS_STOCK_COUNT_KEY</span><span class="token operator">=</span><span class="token string">&quot;seckill_goods_stock_count_&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><p>2修改获取数据的业务方法 SecKillGoodsServiceImpl</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Service</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecKillGoodsServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">SecKillGoodsService</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SECKILL_KEY</span> <span class="token operator">=</span> <span class="token string">&quot;seckill_goods_&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//秒杀商品库存头</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SECKILL_GOODS_STOCK_COUNT_KEY</span><span class="token operator">=</span><span class="token string">&quot;seckill_goods_stock_count_&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 查询秒杀商品列表</span>
<span class="line">     *</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">time</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token class-name">String</span> time<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillGoods</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token constant">SECKILL_KEY</span> <span class="token operator">+</span> time<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//更新库存数据的来源</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SeckillGoods</span> seckillGoods <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">String</span> value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">SECKILL_GOODS_STOCK_COUNT_KEY</span><span class="token operator">+</span>seckillGoods<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            seckillGoods<span class="token punctuation">.</span><span class="token function">setStockCount</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> list<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28</p><p><strong>测试：</strong> 重启相关服务，登陆，秒杀 http://localhost:8001/api/wseckillgoods/toIndex</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220103102806192.aefb2901.png" alt="image-20220103102806192"></p><h2 id="_2-防止恶意刷单解决" tabindex="-1"><a class="header-anchor" href="#_2-防止恶意刷单解决"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-%E9%98%B2%E6%AD%A2%E6%81%B6%E6%84%8F%E5%88%B7%E5%8D%95%E8%A7%A3%E5%86%B3" target="_blank" rel="noopener noreferrer">#</a>2 防止恶意刷单解决</span></a></h2><p>在生产场景下，很有可能会存在某些用户恶意刷单的情况出现。这样的操作对于系统而言，会导致业务出错、脏数据、后端访问压力大等问题的出现。</p><p>一般要解决这个问题的话，需要前端进行控制，同时后端也需要进行控制。后端实现可以通过Redis incrde 原子性递增来进行解决。</p><h3 id="_2-1-更新秒杀服务下单" tabindex="-1"><a class="header-anchor" href="#_2-1-更新秒杀服务下单"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-1-%E6%9B%B4%E6%96%B0%E7%A7%92%E6%9D%80%E6%9C%8D%E5%8A%A1%E4%B8%8B%E5%8D%95" target="_blank" rel="noopener noreferrer">#</a>2.1 更新秒杀服务下单</span></a></h3><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220103111001121.5f8b9ce9.png" alt="image-20220103111001121"></p><p><strong>ydles_service_seckill服务的SecKillOrderServiceImpl类</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token class-name">String</span> time<span class="token punctuation">,</span> <span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token comment">//防止用户恶意刷单</span></span>
<span class="line">        <span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">preventRepeatCommit</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;fail&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><h3 id="_2-2-防重方法实现" tabindex="-1"><a class="header-anchor" href="#_2-2-防重方法实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2-2-%E9%98%B2%E9%87%8D%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>2.2 防重方法实现</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line">  * 防止用户恶意刷单</span>
<span class="line">  * <span class="token keyword">@param</span> <span class="token parameter">username</span>  用户名</span>
<span class="line">  * <span class="token keyword">@param</span> <span class="token parameter">id</span>        秒杀商品id</span>
<span class="line">  * <span class="token keyword">@return</span></span>
<span class="line">  */</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">preventRepeatCommit</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">String</span> redis_key <span class="token operator">=</span> <span class="token string">&quot;seckill_user_&quot;</span><span class="token operator">+</span>username<span class="token operator">+</span><span class="token string">&quot;_id_&quot;</span><span class="token operator">+</span>id<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">long</span> count <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span>redis_key<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//代表当前用户是第一次访问.</span></span>
<span class="line">            <span class="token comment">//对当前的key设置一个五分钟的有效期</span></span>
<span class="line">            redisTemplate<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span>redis_key<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token string">&quot;success&quot;</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>count<span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token string">&quot;fail&quot;</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">&quot;fail&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23</p><h2 id="_3-防止相同商品重复秒杀" tabindex="-1"><a class="header-anchor" href="#_3-防止相同商品重复秒杀"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-%E9%98%B2%E6%AD%A2%E7%9B%B8%E5%90%8C%E5%95%86%E5%93%81%E9%87%8D%E5%A4%8D%E7%A7%92%E6%9D%80" target="_blank" rel="noopener noreferrer">#</a>3 防止相同商品重复秒杀</span></a></h2><p>需求：一个userID,只能买一个秒杀商品。</p><p>解决：秒杀订单表根据userName和秒杀商品Id控制。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220103112122408.25328d6b.png" alt="image-20220103112122408"></p><h3 id="_3-1-修改下单业务层实现" tabindex="-1"><a class="header-anchor" href="#_3-1-修改下单业务层实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-1-%E4%BF%AE%E6%94%B9%E4%B8%8B%E5%8D%95%E4%B8%9A%E5%8A%A1%E5%B1%82%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>3.1 修改下单业务层实现</span></a></h3><p><strong>ydles_service_seckill服务的SecKillOrderServiceImpl类</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">        <span class="token comment">//防止重复购买</span></span>
<span class="line">        <span class="token class-name">SeckillOrder</span> querySeckillOrder<span class="token operator">=</span>seckillOrderMapper<span class="token punctuation">.</span><span class="token function">getOrderInfoByUserNameAndGoodsId</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span>querySeckillOrder<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><h3 id="_3-2-dao层新增查询方法" tabindex="-1"><a class="header-anchor" href="#_3-2-dao层新增查询方法"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3-2-dao%E5%B1%82%E6%96%B0%E5%A2%9E%E6%9F%A5%E8%AF%A2%E6%96%B9%E6%B3%95" target="_blank" rel="noopener noreferrer">#</a>3.2 dao层新增查询方法</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SeckillOrderMapper</span> <span class="token keyword">extends</span> <span class="token class-name">Mapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillOrder</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 查询秒杀订单信息</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">username</span></span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">id</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">&quot;select * from tb_seckill_order where user_id=#{username} and seckill_id=#{id}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token class-name">SeckillOrder</span> <span class="token function">getSecKillOrderByUserNameAndGoodsId</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11</p><h2 id="_4-秒杀下单接口隐藏" tabindex="-1"><a class="header-anchor" href="#_4-秒杀下单接口隐藏"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_4-%E7%A7%92%E6%9D%80%E4%B8%8B%E5%8D%95%E6%8E%A5%E5%8F%A3%E9%9A%90%E8%97%8F" target="_blank" rel="noopener noreferrer">#</a>4 秒杀下单接口隐藏</span></a></h2><p>背景：当前虽然可以确保用户只有在登录的情况下才可以进行秒杀下单，但是无法方法有一些恶意的用户在登录了之后，猜测秒杀下单的接口地址进行恶意刷单。所以需要对秒杀接口地址进行隐藏。</p><p>需求：在用户每一次点击抢购的时候，都首先去生成一个随机数并存入redis，接着用户携带着这个随机数去访问秒杀下单，下单接口首先会从redis中获取该随机数进行匹配，如果匹配成功，则进行后续下单操作，如果匹配不成功，则认定为非法访问。</p><p>这样可有防止黑客恶意大量调取后端的秒杀下单接口。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220103114529621.be934541.png" alt="image-20220103114529621"></p><h3 id="_4-1-将随机数工具类放入common工程中" tabindex="-1"><a class="header-anchor" href="#_4-1-将随机数工具类放入common工程中"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_4-1-%E5%B0%86%E9%9A%8F%E6%9C%BA%E6%95%B0%E5%B7%A5%E5%85%B7%E7%B1%BB%E6%94%BE%E5%85%A5common%E5%B7%A5%E7%A8%8B%E4%B8%AD" target="_blank" rel="noopener noreferrer">#</a>4.1 将随机数工具类放入common工程中</span></a></h3><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220103114547263.0b90e207.png" alt="image-20220103114547263"></p><p>RandomUtil.java放入util包下</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220103114754530.a5482486.png" alt="image-20220103114754530"></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RandomUtil</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getRandomString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">int</span> length <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">String</span> base <span class="token operator">=</span> <span class="token string">&quot;abcdefghijklmnopqrstuvwxyz0123456789&quot;</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">StringBuffer</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">int</span> number <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>base<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>base<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">String</span> randomString <span class="token operator">=</span> <span class="token class-name">RandomUtil</span><span class="token punctuation">.</span><span class="token function">getRandomString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>randomString<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18</p><h3 id="_4-2-秒杀渲染服务定义随机数接口" tabindex="-1"><a class="header-anchor" href="#_4-2-秒杀渲染服务定义随机数接口"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_4-2-%E7%A7%92%E6%9D%80%E6%B8%B2%E6%9F%93%E6%9C%8D%E5%8A%A1%E5%AE%9A%E4%B9%89%E9%9A%8F%E6%9C%BA%E6%95%B0%E6%8E%A5%E5%8F%A3" target="_blank" rel="noopener noreferrer">#</a>4.2 秒杀渲染服务定义随机数接口</span></a></h3><p><strong>1ydles_web_seckill服务 util包下放入资料中的CookieUtil.java工具类</strong></p><p><strong>2ydles_web_seckill服务WSecKillOrderController类</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Autowired</span></span>
<span class="line"><span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span></span>
<span class="line"><span class="token doc-comment comment">/**</span>
<span class="line">  * 生成随机数作为接口令牌, 有效期10秒</span>
<span class="line">  * <span class="token keyword">@return</span></span>
<span class="line">  */</span></span>
<span class="line">    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/getToken&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token annotation punctuation">@ResponseBody</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//获取随机字符串</span></span>
<span class="line">        <span class="token class-name">String</span> randomString <span class="token operator">=</span> <span class="token class-name">RandomUtil</span><span class="token punctuation">.</span><span class="token function">getRandomString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//获取jti</span></span>
<span class="line">        <span class="token class-name">String</span> cookieValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">readCookie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//短令牌作为key, 随机字符串作为value</span></span>
<span class="line">        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;randomcode_&quot;</span> <span class="token operator">+</span> cookieValue<span class="token punctuation">,</span> randomString<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//返回随机字符串</span></span>
<span class="line">        <span class="token keyword">return</span> randomString<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 读取cookie获取jti短令牌</span>
<span class="line">     *</span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">readCookie</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ServletRequestAttributes</span><span class="token punctuation">)</span> <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">String</span> jti <span class="token operator">=</span> <span class="token class-name">CookieUtil</span><span class="token punctuation">.</span><span class="token function">readCookie</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">&quot;uid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;uid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> jti<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29</p><h3 id="_4-3-js修改" tabindex="-1"><a class="header-anchor" href="#_4-3-js修改"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_4-3-js%E4%BF%AE%E6%94%B9" target="_blank" rel="noopener noreferrer">#</a>4.3 js修改</span></a></h3><p>修改js下单方法</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token comment">//秒杀下单</span></span>
<span class="line"><span class="token function-variable function">add</span><span class="token operator">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">					axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/api/wseckillorder/getToken&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">						<span class="token keyword">var</span> random <span class="token operator">=</span>response<span class="token punctuation">.</span>data<span class="token punctuation">;</span></span>
<span class="line">						axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/api/wseckillorder/add?time=&quot;</span><span class="token operator">+</span><span class="token function">moment</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>dateMenus<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;YYYYMMDDHH&quot;</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;&amp;id=&quot;</span><span class="token operator">+</span>id<span class="token operator">+</span><span class="token string">&quot;&amp;random=&quot;</span><span class="token operator">+</span>random<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">							<span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>flag<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">								<span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;抢单成功,即将进入支付&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">							<span class="token punctuation">}</span> <span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">								<span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;抢单失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">							<span class="token punctuation">}</span></span>
<span class="line">						<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">					<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">				<span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13</p><h3 id="_4-4-秒杀渲染服务更改" tabindex="-1"><a class="header-anchor" href="#_4-4-秒杀渲染服务更改"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_4-4-%E7%A7%92%E6%9D%80%E6%B8%B2%E6%9F%93%E6%9C%8D%E5%8A%A1%E6%9B%B4%E6%94%B9" target="_blank" rel="noopener noreferrer">#</a>4.4 秒杀渲染服务更改</span></a></h3><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220103153812440.30635975.png" alt="image-20220103153812440"></p><p>修改秒杀渲染服务下单接口</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@RestController</span></span>
<span class="line"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/wseckillorder&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WSecKillOrderController</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">SecKillOrderFeign</span> secKillOrderFeign<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 秒杀下单</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">time</span></span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">id</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/add&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;time&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> time<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token class-name">String</span> random<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">String</span> cookieValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">readCookie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">String</span> redisRandomCode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;randomcode_&quot;</span> <span class="token operator">+</span> cookieValue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>redisRandomCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">ERROR</span><span class="token punctuation">,</span> <span class="token string">&quot;下单失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>random<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>redisRandomCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">ERROR</span><span class="token punctuation">,</span> <span class="token string">&quot;下单失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">Result</span> result <span class="token operator">=</span> secKillOrderFeign<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> result<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31</p><h2 id="_5秒杀下单接口限流-难点-不是重点" tabindex="-1"><a class="header-anchor" href="#_5秒杀下单接口限流-难点-不是重点"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_5%E7%A7%92%E6%9D%80%E4%B8%8B%E5%8D%95%E6%8E%A5%E5%8F%A3%E9%99%90%E6%B5%81-%E9%9A%BE%E7%82%B9-%E4%B8%8D%E6%98%AF%E9%87%8D%E7%82%B9" target="_blank" rel="noopener noreferrer">#</a>5秒杀下单接口限流-难点-不是重点</span></a></h2><p>因为秒杀的特殊业务场景，生产场景下，还有可能要对秒杀下单接口进行访问流量控制，防止过多的请求进入到后端服务器。对于限流的实现方式，我们之前已经接触过通过<strong>nginx限流</strong>，<strong>网关限流</strong>。但是他们都是对一个大的服务进行访问限流，如果现在只是要对某一个服务中的<strong>接口方法进行限流</strong>呢？这里推荐使用google提供的<strong>guava工具包</strong>中的<strong>RateLimiter</strong>进行实现，其内部是基于令牌桶算法进行限流计算。</p><p>1限流 技术：guava</p><p>2自定义注解：@interface 基础的元注解信息</p><p>3aop 注解方式面向切面编程：前置增强、后置增强、环绕增强、最终增强</p><p>4springmvc 自带 HttpServletResponse response</p><p>5流 首先定义出来，最后关流</p><p><strong>ydles_web_seckill服务</strong>：</p><h3 id="_1添加依赖" tabindex="-1"><a class="header-anchor" href="#_1添加依赖"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_1%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96" target="_blank" rel="noopener noreferrer">#</a>1添加依赖</span></a></h3><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.google.guava<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>guava<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>28.0-jre<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><h3 id="_2自定义限流注解" tabindex="-1"><a class="header-anchor" href="#_2自定义限流注解"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_2%E8%87%AA%E5%AE%9A%E4%B9%89%E9%99%90%E6%B5%81%E6%B3%A8%E8%A7%A3" target="_blank" rel="noopener noreferrer">#</a>2自定义限流注解</span></a></h3><p>com.ydles.seckill.web.aspect</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Inherited</span></span>
<span class="line"><span class="token annotation punctuation">@Documented</span></span>
<span class="line"><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">FIELD</span><span class="token punctuation">,</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span><span class="token punctuation">,</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span> <span class="token comment">//不仅保存到class文件中,并且jvm加载class之后,该注解仍然存在</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">AccessLimit</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6</p><h3 id="_3自定义切面类" tabindex="-1"><a class="header-anchor" href="#_3自定义切面类"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_3%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%87%E9%9D%A2%E7%B1%BB" target="_blank" rel="noopener noreferrer">#</a>3自定义切面类</span></a></h3><p>com.ydles.seckill.web.aspect包下</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>web<span class="token punctuation">.</span>aspect</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">RateLimiter</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">Result</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">StatusCode</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>aspectj<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span><span class="token class-name">ProceedingJoinPoint</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>aspectj<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Around</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>aspectj<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Aspect</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>aspectj<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Pointcut</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Scope</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">ResponseBody</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletOutputStream</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span></span><span class="token class-name">StandardCharsets</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * @Created by IT李老师</span>
<span class="line"> * 公主号 “IT李哥交朋友”</span>
<span class="line"> * 个人微 itlils</span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token annotation punctuation">@Scope</span></span>
<span class="line"><span class="token annotation punctuation">@Aspect</span> <span class="token comment">//标明切面类</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccessLimitAop</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//设置令牌的生成速率</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">RateLimiter</span> rateLimiter <span class="token operator">=</span> <span class="token class-name">RateLimiter</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//每秒生成两个令牌存入桶中</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">&quot;@annotation(com.ydles.seckill.web.aspect.AccessLimit)&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">&quot;limit()&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">around</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> proceedingJoinPoint<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//限流逻辑</span></span>
<span class="line">        <span class="token comment">//拿令牌</span></span>
<span class="line">        <span class="token keyword">boolean</span> result <span class="token operator">=</span> rateLimiter<span class="token punctuation">.</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Object</span> object <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//拿到令牌了</span></span>
<span class="line">            <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">//切面往后走</span></span>
<span class="line">                object <span class="token operator">=</span> proceedingJoinPoint<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                throwable<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//拿不到令牌</span></span>
<span class="line">            <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> objectResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">ACCESSLIMIT</span><span class="token punctuation">,</span> <span class="token string">&quot;限流了，请售后再试&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>objectResult<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">//将信息写回到用户的浏览器</span></span>
<span class="line">            <span class="token function">writeMsg</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> object<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//给用户写回数据</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span>  <span class="token function">writeMsg</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">ServletOutputStream</span> outputStream<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;application/json;charset=utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            outputStream <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            outputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">                outputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84</p><h3 id="_4使用自定义限流注解" tabindex="-1"><a class="header-anchor" href="#_4使用自定义限流注解"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/03/#_4%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E9%99%90%E6%B5%81%E6%B3%A8%E8%A7%A3" target="_blank" rel="noopener noreferrer">#</a>4使用自定义限流注解</span></a></h3><p>@AccessLimit放在下单方法上即可</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220103165242789.9ed396eb.png" alt="image-20220103165242789"></p><p>总结：</p><p>1秒杀后台异步下单</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220103165527365.e46a02ec.png" alt="image-20220103165527365"></p><p>mq 保证消息不丢</p><p>1交换机 队列 消息 持久化</p><p>2生产者：comfirm机制</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220103165641227.18037575.png" alt="image-20220103165641227"></p><p>3消费者：手动ack</p><p>2防止恶意刷单</p><p>redis：key username_id 5min</p><p>3防止相同商品秒杀</p><p>数据库order查询 拒绝</p><p>4秒杀接口隐藏</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220103170003264.b1e1f3f6.png" alt="image-20220103170003264"></p><p>5秒杀 接口限流</p><p>自定义注解 aop</p></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><!----><!----></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-CiSBoDQ3.js" defer></script>
  </body>
</html>
