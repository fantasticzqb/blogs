<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.14" />
    <style>
      :root {
        --c-bg: #fff;
      }

      html.dark {
        --c-bg: #22272e;
      }

      html,
      body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia('(prefers-color-scheme: dark)').matches

      if (userMode === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (userMode === 'dark' || systemDarkMode) {
        document.documentElement.classList.toggle('dark', true)
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <link rel="icon" href="/lucy.ico"><title>二手交易网项目 | 彗星文档</title><meta name="description" content="繁星似海 熠熠生辉">
    <link rel="preload" href="/blogs/assets/style-CPtAZutf.css" as="style"><link rel="stylesheet" href="/blogs/assets/style-CPtAZutf.css">
    <link rel="modulepreload" href="/blogs/assets/app-lCTfir8o.js"><link rel="modulepreload" href="/blogs/assets/buy2.html-D_3HYsB2.js">
    <link rel="prefetch" href="/blogs/assets/about.html-CwGac_md.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-Bmlc_r66.js" as="script"><link rel="prefetch" href="/blogs/assets/activiti.html-CcVZM8Nf.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-DsTkj-ck.js" as="script"><link rel="prefetch" href="/blogs/assets/css.html-CxNsDRZ0.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-DMb5SD8N.js" as="script"><link rel="prefetch" href="/blogs/assets/datastructure.html-BS9NK5Ec.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-DSpeADom.js" as="script"><link rel="prefetch" href="/blogs/assets/design.html-Bn970E7i.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-DxtolBES.js" as="script"><link rel="prefetch" href="/blogs/assets/docker.html-DJiB5ffn.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-Bh8haqme.js" as="script"><link rel="prefetch" href="/blogs/assets/elk1.html-DVw7yBTc.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-rMbIwsB0.js" as="script"><link rel="prefetch" href="/blogs/assets/elk2.html-6lHNVoJu.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-DN_CU-HS.js" as="script"><link rel="prefetch" href="/blogs/assets/html.html-CoqSyGRp.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-DTSxBCYN.js" as="script"><link rel="prefetch" href="/blogs/assets/abnormal.html-BLVlFLx7.js" as="script"><link rel="prefetch" href="/blogs/assets/api.html-CJqzCtEn.js" as="script"><link rel="prefetch" href="/blogs/assets/base.html-CFYUzLSs.js" as="script"><link rel="prefetch" href="/blogs/assets/encapsulation.html-BqUEU85s.js" as="script"><link rel="prefetch" href="/blogs/assets/Inheritance.html-CWKD1mwW.js" as="script"><link rel="prefetch" href="/blogs/assets/JVM.html-CHhTxott.js" as="script"><link rel="prefetch" href="/blogs/assets/other.html-esHez3i2.js" as="script"><link rel="prefetch" href="/blogs/assets/polymorphism.html-Cw23OCdP.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-C-sGRpwE.js" as="script"><link rel="prefetch" href="/blogs/assets/collection.html-CkZbKPTl.js" as="script"><link rel="prefetch" href="/blogs/assets/enum.html-BTy0PmP6.js" as="script"><link rel="prefetch" href="/blogs/assets/format.html-f_JlLynv.js" as="script"><link rel="prefetch" href="/blogs/assets/Generics.html-DgOxAMe0.js" as="script"><link rel="prefetch" href="/blogs/assets/iostream.html-B-cr8Oq-.js" as="script"><link rel="prefetch" href="/blogs/assets/NIO.html-BXDqR3KD.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-pO5428dm.js" as="script"><link rel="prefetch" href="/blogs/assets/reflection.html-CbgItrqf.js" as="script"><link rel="prefetch" href="/blogs/assets/socket.html-B3mSLPlW.js" as="script"><link rel="prefetch" href="/blogs/assets/thread.html-CYtNBg5m.js" as="script"><link rel="prefetch" href="/blogs/assets/tree.html-DGlurv8q.js" as="script"><link rel="prefetch" href="/blogs/assets/jdbc.html-BKij-WDL.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-BXtSsA3o.js" as="script"><link rel="prefetch" href="/blogs/assets/js.html-B5dmvd_Q.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-OiTBnnTU.js" as="script"><link rel="prefetch" href="/blogs/assets/log.html-BRBpaHaM.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-D5nLRe-s.js" as="script"><link rel="prefetch" href="/blogs/assets/message.html-BiZ-uOTo.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-DtZLZM2t.js" as="script"><link rel="prefetch" href="/blogs/assets/maven.html-DRA46MVg.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-BYhJnwg6.js" as="script"><link rel="prefetch" href="/blogs/assets/mybatis.html-BlszuFDB.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-DRRarCVZ.js" as="script"><link rel="prefetch" href="/blogs/assets/mybatisplus.html-BCWOq2Ku.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-BKVPKwfI.js" as="script"><link rel="prefetch" href="/blogs/assets/mysql-base.html-C47GTOUM.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-ewE9MR5N.js" as="script"><link rel="prefetch" href="/blogs/assets/mysql-rise.html-BQtltpil.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-CStunAJJ.js" as="script"><link rel="prefetch" href="/blogs/assets/nginx.html-g_s-XCn4.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-C1U4oioN.js" as="script"><link rel="prefetch" href="/blogs/assets/archive1.html-nDCm_xpK.js" as="script"><link rel="prefetch" href="/blogs/assets/archive2.html-u0znmk-K.js" as="script"><link rel="prefetch" href="/blogs/assets/article1.html-p9DJnEcE.js" as="script"><link rel="prefetch" href="/blogs/assets/article10.html-CejbM4lO.js" as="script"><link rel="prefetch" href="/blogs/assets/article11.html-DCE1rh06.js" as="script"><link rel="prefetch" href="/blogs/assets/article12.html-BSidm-Ba.js" as="script"><link rel="prefetch" href="/blogs/assets/article2.html-CQpOnyZR.js" as="script"><link rel="prefetch" href="/blogs/assets/article3.html-DuEkqrM7.js" as="script"><link rel="prefetch" href="/blogs/assets/article4.html-DA64BfGU.js" as="script"><link rel="prefetch" href="/blogs/assets/article5.html-s6mxYA_p.js" as="script"><link rel="prefetch" href="/blogs/assets/article6.html-B197gRU7.js" as="script"><link rel="prefetch" href="/blogs/assets/article7.html-pcnVqP9L.js" as="script"><link rel="prefetch" href="/blogs/assets/article8.html-CbfNWJEj.js" as="script"><link rel="prefetch" href="/blogs/assets/article9.html-62x9ZAGs.js" as="script"><link rel="prefetch" href="/blogs/assets/sticky.html-CEy0fMvF.js" as="script"><link rel="prefetch" href="/blogs/assets/sticky2.html-CQoTTOFc.js" as="script"><link rel="prefetch" href="/blogs/assets/questions.html-Dlhv6JCe.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-D1HsJXcM.js" as="script"><link rel="prefetch" href="/blogs/assets/rabbitmq.html-C8fManfe.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-BBFrymvP.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-DOczPhHx.js" as="script"><link rel="prefetch" href="/blogs/assets/redis.html-D8IWpCPQ.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-MQBMT9st.js" as="script"><link rel="prefetch" href="/blogs/assets/rocketmq.html-lnPaq8nc.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-B1SqRI5z.js" as="script"><link rel="prefetch" href="/blogs/assets/buy1.html-CWFQovuV.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-rAVfNoMu.js" as="script"><link rel="prefetch" href="/blogs/assets/buy3.html-DGqysypB.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-CvtAyC4m.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-Bfuui3Zu.js" as="script"><link rel="prefetch" href="/blogs/assets/springboot.html-fEHFCAcM.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-rsGlUjEP.js" as="script"><link rel="prefetch" href="/blogs/assets/spring.html-Bm_O6OE3.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-Bhvpf5rk.js" as="script"><link rel="prefetch" href="/blogs/assets/springcloud.html-BjHWqyWy.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-b6YY5CsR.js" as="script"><link rel="prefetch" href="/blogs/assets/sort.html-joQ5eRAc.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-B3Tp5pbT.js" as="script"><link rel="prefetch" href="/blogs/assets/springdata-jpa.html-u-02xmMZ.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-CKv9bCmE.js" as="script"><link rel="prefetch" href="/blogs/assets/springmvc.html-B-a-J7G-.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-Cob0X_yF.js" as="script"><link rel="prefetch" href="/blogs/assets/springsecurity.html-DwdZqar9.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-DaEP4Ra5.js" as="script"><link rel="prefetch" href="/blogs/assets/springcloudalibaba.html-BBN5s4dO.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-BrsTW-lC.js" as="script"><link rel="prefetch" href="/blogs/assets/ssm.html-ouUOQOUc.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-KtY1sCgk.js" as="script"><link rel="prefetch" href="/blogs/assets/git.html-DqNFMCHU.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-CmqEuZ7T.js" as="script"><link rel="prefetch" href="/blogs/assets/linux.html-B7-z166i.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-HWeIG5KW.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-T8le10LB.js" as="script"><link rel="prefetch" href="/blogs/assets/web.html-DFbBf6pK.js" as="script"><link rel="prefetch" href="/blogs/assets/404.html-C3uFSwJ9.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-CPUHdlNd.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-CPnK-iCi.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-DF__Rx4f.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-Bli0azJb.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-S_aKhGFb.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-B8N8CgD2.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-2pAFkgiN.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-Sd4lJVSX.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-DeWCtPaP.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-sjnxI3kQ.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-BAM5dfnV.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-BzVEjl4A.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-CP1X2dZe.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-Bd7ryFjl.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-Ca4ztyKw.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon"><!--[--><header class="vp-navbar"><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/blogs/"><img class="vp-site-logo" src="/blogs/comet.png" alt="彗星文档"><span class="vp-site-name vp-hide-mobile" aria-hidden="true">彗星文档</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/blogs/" aria-label="主页"><!---->主页<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/blogs/about.html" aria-label="关于"><!---->关于<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/blogs/study-direction/" aria-label="学习路线"><!---->学习路线<!----></a></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="JavaSE"><span class="title">JavaSE</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="JavaSE"><span class="title">JavaSE</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>JavaSE上</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blogs/JavaSE1/" aria-label="1.基础~8.异常处理"><!---->1.基础~8.异常处理<!----></a></li><!--]--></ul><!--]--></li><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>JavaSE下</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blogs/JavaSE2/" aria-label="9.泛型~18.正则表达式"><!---->9.泛型~18.正则表达式<!----></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="运维工具"><span class="title">运维工具</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="运维工具"><span class="title">运维工具</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>虚拟机</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blogs/virtual-system/" aria-label="Linux"><!---->Linux<!----></a></li><!--]--></ul><!--]--></li><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>多人协同</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blogs/tools/" aria-label="Git"><!---->Git<!----></a></li><!--]--></ul><!--]--></li><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>镜像</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blogs/docker/" aria-label="Docker"><!---->Docker<!----></a></li><!--]--></ul><!--]--></li><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>工作流</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blogs/activiti/" aria-label="Activiti工作流引擎"><!---->Activiti工作流引擎<!----></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="数据库"><span class="title">数据库</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="数据库"><span class="title">数据库</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>MySQL</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blogs/mysql1/" aria-label="MySQL上"><!---->MySQL上<!----></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blogs/mysql2/" aria-label="MySQL下"><!---->MySQL下<!----></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="JavaWeb"><span class="title">JavaWeb</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="JavaWeb"><span class="title">JavaWeb</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/jdbc/" aria-label="1.JDBC"><!---->1.JDBC<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/html/" aria-label="2.HTML"><!---->2.HTML<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/css/" aria-label="3.CSS"><!---->3.CSS<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/js/" aria-label="4.JS"><!---->4.JS<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/web/" aria-label="5.Web"><!---->5.Web<!----></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="框架"><span class="title">框架</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="框架"><span class="title">框架</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/log/" aria-label="1.日志"><!---->1.日志<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/maven/" aria-label="2.Maven"><!---->2.Maven<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/design/" aria-label="3.设计模式"><!---->3.设计模式<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/mybatis/" aria-label="4.MyBatis"><!---->4.MyBatis<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/spring/" aria-label="5.Spring"><!---->5.Spring<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/springmvc/" aria-label="6.SpringMVC"><!---->6.SpringMVC<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/mybatis-plus/" aria-label="7.MyBatisPlus"><!---->7.MyBatisPlus<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/redis/" aria-label="8.Redis"><!---->8.Redis<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/springboot/" aria-label="9.SpringBoot"><!---->9.SpringBoot<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/springdata-jpa/" aria-label="10.SpringData-jpa"><!---->10.SpringData-jpa<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/springsecurity/" aria-label="11.SpringSecurity"><!---->11.SpringSecurity<!----></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="分布式组件"><span class="title">分布式组件</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="分布式组件"><span class="title">分布式组件</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/nginx/" aria-label="1.Nginx"><!---->1.Nginx<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/springcloud/" aria-label="2.SpringCloud"><!---->2.SpringCloud<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/springcloud-alibaba/" aria-label="3.SprngCloud-AliBaBa"><!---->3.SprngCloud-AliBaBa<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/elk1/" aria-label="4.ELK(上)"><!---->4.ELK(上)<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/elk2/" aria-label="5.ELK(下)"><!---->5.ELK(下)<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/rocketmq/" aria-label="6.RocketMQ"><!---->6.RocketMQ<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/rabbitmq/" aria-label="7.RabbitMQ"><!---->7.RabbitMQ<!----></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="项目"><span class="title">项目</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="项目"><span class="title">项目</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>综合项目</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blogs/ssm/" aria-label="1.SSM小项目"><!---->1.SSM小项目<!----></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blogs/message/" aria-label="2.短信调度"><!---->2.短信调度<!----></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blogs/shopping1/" aria-label="二手交易网(上)"><!---->二手交易网(上)<!----></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link route-link-active auto-link" href="/blogs/shopping2/" aria-label="二手交易网(中)"><!---->二手交易网(中)<!----></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blogs/shopping3/" aria-label="二手交易网(下)"><!---->二手交易网(下)<!----></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="算法"><span class="title">算法</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="算法"><span class="title">算法</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/sort/" aria-label="1.排序算法"><!---->1.排序算法<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/datastructure/" aria-label="2.基本数据结构与算法"><!---->2.基本数据结构与算法<!----></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/blogs/question/" aria-label="遇到的问题"><!---->遇到的问题<!----></a></div><!--]--></nav><!--[--><!--]--><button class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar"><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/blogs/" aria-label="主页"><!---->主页<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/blogs/about.html" aria-label="关于"><!---->关于<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/blogs/study-direction/" aria-label="学习路线"><!---->学习路线<!----></a></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="JavaSE"><span class="title">JavaSE</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="JavaSE"><span class="title">JavaSE</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>JavaSE上</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blogs/JavaSE1/" aria-label="1.基础~8.异常处理"><!---->1.基础~8.异常处理<!----></a></li><!--]--></ul><!--]--></li><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>JavaSE下</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blogs/JavaSE2/" aria-label="9.泛型~18.正则表达式"><!---->9.泛型~18.正则表达式<!----></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="运维工具"><span class="title">运维工具</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="运维工具"><span class="title">运维工具</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>虚拟机</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blogs/virtual-system/" aria-label="Linux"><!---->Linux<!----></a></li><!--]--></ul><!--]--></li><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>多人协同</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blogs/tools/" aria-label="Git"><!---->Git<!----></a></li><!--]--></ul><!--]--></li><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>镜像</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blogs/docker/" aria-label="Docker"><!---->Docker<!----></a></li><!--]--></ul><!--]--></li><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>工作流</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blogs/activiti/" aria-label="Activiti工作流引擎"><!---->Activiti工作流引擎<!----></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="数据库"><span class="title">数据库</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="数据库"><span class="title">数据库</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>MySQL</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blogs/mysql1/" aria-label="MySQL上"><!---->MySQL上<!----></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blogs/mysql2/" aria-label="MySQL下"><!---->MySQL下<!----></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="JavaWeb"><span class="title">JavaWeb</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="JavaWeb"><span class="title">JavaWeb</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/jdbc/" aria-label="1.JDBC"><!---->1.JDBC<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/html/" aria-label="2.HTML"><!---->2.HTML<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/css/" aria-label="3.CSS"><!---->3.CSS<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/js/" aria-label="4.JS"><!---->4.JS<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/web/" aria-label="5.Web"><!---->5.Web<!----></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="框架"><span class="title">框架</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="框架"><span class="title">框架</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/log/" aria-label="1.日志"><!---->1.日志<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/maven/" aria-label="2.Maven"><!---->2.Maven<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/design/" aria-label="3.设计模式"><!---->3.设计模式<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/mybatis/" aria-label="4.MyBatis"><!---->4.MyBatis<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/spring/" aria-label="5.Spring"><!---->5.Spring<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/springmvc/" aria-label="6.SpringMVC"><!---->6.SpringMVC<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/mybatis-plus/" aria-label="7.MyBatisPlus"><!---->7.MyBatisPlus<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/redis/" aria-label="8.Redis"><!---->8.Redis<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/springboot/" aria-label="9.SpringBoot"><!---->9.SpringBoot<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/springdata-jpa/" aria-label="10.SpringData-jpa"><!---->10.SpringData-jpa<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/springsecurity/" aria-label="11.SpringSecurity"><!---->11.SpringSecurity<!----></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="分布式组件"><span class="title">分布式组件</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="分布式组件"><span class="title">分布式组件</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/nginx/" aria-label="1.Nginx"><!---->1.Nginx<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/springcloud/" aria-label="2.SpringCloud"><!---->2.SpringCloud<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/springcloud-alibaba/" aria-label="3.SprngCloud-AliBaBa"><!---->3.SprngCloud-AliBaBa<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/elk1/" aria-label="4.ELK(上)"><!---->4.ELK(上)<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/elk2/" aria-label="5.ELK(下)"><!---->5.ELK(下)<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/rocketmq/" aria-label="6.RocketMQ"><!---->6.RocketMQ<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/rabbitmq/" aria-label="7.RabbitMQ"><!---->7.RabbitMQ<!----></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="项目"><span class="title">项目</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="项目"><span class="title">项目</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>综合项目</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blogs/ssm/" aria-label="1.SSM小项目"><!---->1.SSM小项目<!----></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blogs/message/" aria-label="2.短信调度"><!---->2.短信调度<!----></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blogs/shopping1/" aria-label="二手交易网(上)"><!---->二手交易网(上)<!----></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link route-link-active auto-link" href="/blogs/shopping2/" aria-label="二手交易网(中)"><!---->二手交易网(中)<!----></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blogs/shopping3/" aria-label="二手交易网(下)"><!---->二手交易网(下)<!----></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="算法"><span class="title">算法</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="算法"><span class="title">算法</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/sort/" aria-label="1.排序算法"><!---->1.排序算法<!----></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/blogs/datastructure/" aria-label="2.基本数据结构与算法"><!---->2.基本数据结构与算法<!----></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/blogs/question/" aria-label="遇到的问题"><!---->遇到的问题<!----></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading active collapsible">目录 <span class="down arrow"></span></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link route-link-active auto-link vp-sidebar-item active" href="/blogs/shopping2/buy2.html" aria-label="二手交易网(中)"><!---->二手交易网(中)<!----></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="二手交易网项目" tabindex="-1"><a class="header-anchor" href="#二手交易网项目"><span>二手交易网项目</span></a></h1><h2 id="第6章-数据同步解决方案-canal" tabindex="-1"><a class="header-anchor" href="#第6章-数据同步解决方案-canal"><span>第6章 数据同步解决方案-canal</span></a></h2><p><strong>角色</strong>：数据监控同步组。后端开发人员。</p><h2 id="学习目标" tabindex="-1"><a class="header-anchor" href="#学习目标"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87" target="_blank" rel="noopener noreferrer">#</a>学习目标</span></a></h2><ul><li>能够完成数据监控微服务的开发</li><li>能够完成首页广告缓存更新的功能</li><li>能够完成商品上架索引库导入数据功能，能够画出流程图和说出实现思路</li><li>能够完成商品下架索引库删除数据功能，能够画出流程图和说出实现思路</li></ul><h2 id="_1-canal" tabindex="-1"><a class="header-anchor" href="#_1-canal"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_1-canal" target="_blank" rel="noopener noreferrer">#</a>1. canal</span></a></h2><p>拓展：mysql 主备</p><h3 id="_1-1-canal简介" tabindex="-1"><a class="header-anchor" href="#_1-1-canal简介"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_1-1-canal%E7%AE%80%E4%BB%8B" target="_blank" rel="noopener noreferrer">#</a>1.1 canal简介</span></a></h3><ol><li><p>背景：</p><p>早期阿里巴巴因为杭州和美国双机房部署，存在跨机房同步的业务需求，实现方式主要是基于业务 trigger 获取增量变更。从 2010 年开始，业务逐步尝试数据库日志解析获取增量变更进行同步，由此衍生出了大量的数据库增量订阅和消费业务。</p><p>原理：</p><p>一、MySQL主备复制原理: 拓展资料（mysql主从备份原理）</p><p>binlog关键</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20191210153213237.181c00c0.png" alt="image-20191210153213237"></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211028111415755.36a192a3.png" alt="image-20211028111415755"></p><ul><li>MySQL master 将数据变更写入二进制日志( binary log, 其中记录叫做二进制日志事件binary log events，可以通过 show binlog events 进行查看) binlog</li></ul></li></ol><ul><li><p>MySQL slave 将 master 的 binary log events 拷贝到它的中继日志(relay log)</p><ul><li>MySQL slave 重放 relay log 中事件，将数据变更反映它自己的数据</li></ul><p>二、canal 工作原理:</p><ul><li><ol><li>canal模拟mysql slave的交互协议，伪装自己为mysql slave，向mysql master发送dump协议</li></ol></li></ul></li><li><ol><li>mysql master收到dump请求，开始推送binary log给slave(也就是canal)</li></ol><ul><li><ol><li>canal解析binary log对象(原始为byte流)</li></ol></li></ul><p>本项目虚拟机已经安装好canal。具体安装文档推荐看官网文档。 https://github.com/alibaba/canal/wiki/QuickStart</p></li></ul><h3 id="_1-2-环境部署" tabindex="-1"><a class="header-anchor" href="#_1-2-环境部署"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_1-2-%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2" target="_blank" rel="noopener noreferrer">#</a>1.2 环境部署</span></a></h3><h4 id="_1-2-1-mysql开启binlog模式" tabindex="-1"><a class="header-anchor" href="#_1-2-1-mysql开启binlog模式"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_1-2-1-mysql%E5%BC%80%E5%90%AFbinlog%E6%A8%A1%E5%BC%8F" target="_blank" rel="noopener noreferrer">#</a>1.2.1 mysql开启binlog模式</span></a></h4><p>（1）查看当前mysql是否开启binlog模式。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">SHOW VARIABLES LIKE &#39;%log_bin%&#39;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>如果log_bin的值为OFF是未开启，为ON是已开启。</p><p>（2）修改/etc/my.cnf 需要开启binlog模式。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">[mysqld]</span>
<span class="line">log-bin=mysql-bin</span>
<span class="line">binlog-format=ROW</span>
<span class="line">server_id=1</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p>修改完成之后，重启mysqld的服务。</p><p>(3) 进入mysql</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">mysql -h localhost -u root -p</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>（4）创建账号 用于测试使用</p><p>使用root账号创建用户并授予权限</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">create user canal@&#39;%&#39; IDENTIFIED by &#39;canal&#39;;</span>
<span class="line">GRANT SELECT, REPLICATION SLAVE, REPLICATION CLIENT,SUPER ON *.* TO &#39;canal&#39;@&#39;%&#39;;</span>
<span class="line">FLUSH PRIVILEGES;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3</p><h4 id="_1-2-2-canal服务端安装配置" tabindex="-1"><a class="header-anchor" href="#_1-2-2-canal服务端安装配置"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_1-2-2-canal%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE" target="_blank" rel="noopener noreferrer">#</a>1.2.2 canal服务端安装配置</span></a></h4><p>（1）下载地址canal</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">https://github.com/alibaba/canal/releases/tag/canal-1.0.24</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/1559118907783.92366fbb.png" alt="1559118907783"></p><p>（2）下载之后 上传到linux系统中，解压缩到指定的目录/usr/local/canal</p><p>解压缩之后的目录结构如下：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/1559119163725.63f79df8.png" alt="1559119163725"></p><p>（3）修改 exmaple下的实例配置</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">vi conf/example/instance.properties</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/6-7.2d74ff70.png" alt="img"></p><p>修改如图所示的几个参数。</p><p>（3）指定读取位置</p><p>进入mysql中执行下面语句查看binlog所在位置</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">mysql&gt; show master status;</span>
<span class="line">显示如下:</span>
<span class="line">+------------------+----------+--------------+------------------+-------------------+</span>
<span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span>
<span class="line">+------------------+----------+--------------+------------------+-------------------+</span>
<span class="line">| mysql-bin.000001 |      120 |              |                  |                   |</span>
<span class="line">+------------------+----------+--------------+------------------+-------------------+</span>
<span class="line">1 row in set (0.00 sec)</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8</p><p>如果file中binlog文件不为 mysql-bin.000001 可以重置mysql</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">mysql&gt; reset master;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>查看canal配置文件</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">vim /usr/local/canal/conf/example/meta.dat</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>找到对应的binlog信息更改一致即可</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">&quot;journalName&quot;:&quot;mysql-bin.000001&quot;,&quot;position&quot;:120,&quot;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>注意：如果不一致，可能导致以下错误</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">2019-06-17 19:35:20.918 [New I/O server worker #1-2] ERROR c.a.otter.canal.server.netty.handler.SessionHandler - something goes wrong with channel:[id: 0x7f2e9be3, /192.168.200.56:52225 =&gt; /192.168.200.128:11111], exception=java.io.IOException: Connection reset by peer</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>（4）启动服务：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">[root@localhost canal]# ./bin/startup.sh</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>（5）查看日志：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">cat /usr/local/canal/logs/canal/canal.log</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/1559119507451.2144b023.png" alt="1559119507451"></p><p>这样就表示启动成功了。</p><h3 id="_1-3-数据监控微服务" tabindex="-1"><a class="header-anchor" href="#_1-3-数据监控微服务"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_1-3-%E6%95%B0%E6%8D%AE%E7%9B%91%E6%8E%A7%E5%BE%AE%E6%9C%8D%E5%8A%A1" target="_blank" rel="noopener noreferrer">#</a>1.3 数据监控微服务</span></a></h3><p>当用户执行数据库的操作的时候，binlog 日志会被canal捕获到，并解析出数据。我们就可以将解析出来的数据进行相应的逻辑处理。</p><p>我们这里使用的一个开源的项目，它实现了springboot与canal的集成。比原生的canal更加优雅。</p><p>https://github.com/chenqian56131/spring-boot-starter-canal</p><p>使用前需要将starter-canal安装到本地仓库。</p><p>我们可以参照它提供的canal-test，进行代码实现。</p><h4 id="_1-3-1-微服务搭建" tabindex="-1"><a class="header-anchor" href="#_1-3-1-微服务搭建"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_1-3-1-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BA" target="_blank" rel="noopener noreferrer">#</a>1.3.1 微服务搭建</span></a></h4><p>（1）创建工程模块ydles_canal，pom引入依赖</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">        <span class="token comment">&lt;!--canal相关--&gt;</span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.xpand<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>starter-canal<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token comment">&lt;!--rabbitMq相关--&gt;</span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-rabbit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11</p><p>（2）创建包com.ydles.canal ，包下创建启动类</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@EnableCanalClient</span> <span class="token comment">//标注为canal客户端</span></span>
<span class="line"><span class="token annotation punctuation">@SpringBootApplication</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CanalApplication</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">CanalApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><p>（3）添加配置文件application.properties</p><div class="language-properties line-numbers-mode" data-highlighter="prismjs" data-ext="properties" data-title="properties"><pre><code><span class="line"><span class="token key attr-name">canal.client.instances.example.host</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.200.128</span></span>
<span class="line"><span class="token key attr-name">canal.client.instances.example.port</span><span class="token punctuation">=</span><span class="token value attr-value">11111</span></span>
<span class="line"><span class="token key attr-name">canal.client.instances.example.batchSize</span><span class="token punctuation">=</span><span class="token value attr-value">1000</span></span>
<span class="line"><span class="token key attr-name">spring.rabbitmq.host</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.200.128</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p>（4）创建com.ydles.canal.listener包，包下创建类</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * @Created by IT李老师</span>
<span class="line"> * 公主号 “IT李哥交朋友”</span>
<span class="line"> * 个人微 itlils</span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@CanalEventListener</span> <span class="token comment">//这个类是canal的监听类</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BusinessListener</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     *</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">eventType</span> 改变 insert update delete</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">rowData</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@ListenPoint</span><span class="token punctuation">(</span>schema <span class="token operator">=</span> <span class="token string">&quot;ydles_business&quot;</span><span class="token punctuation">,</span>table <span class="token operator">=</span> <span class="token string">&quot;tb_ad&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">adUpdate</span><span class="token punctuation">(</span><span class="token class-name">CanalEntry<span class="token punctuation">.</span>EventType</span> eventType<span class="token punctuation">,</span><span class="token class-name">CanalEntry<span class="token punctuation">.</span>RowData</span> rowData<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;EventType:&quot;</span><span class="token operator">+</span>eventType<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//改变之前 这一行数据</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CanalEntry<span class="token punctuation">.</span>Column</span><span class="token punctuation">&gt;</span></span> beforeColumnsList <span class="token operator">=</span> rowData<span class="token punctuation">.</span><span class="token function">getBeforeColumnsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CanalEntry<span class="token punctuation">.</span>Column</span> column <span class="token operator">:</span> beforeColumnsList<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;改变之前，列名字：&quot;</span><span class="token operator">+</span>column<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;列值：&quot;</span><span class="token operator">+</span>column<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;======================================&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//改变之后 这一行数据</span></span>
<span class="line">        rowData<span class="token punctuation">.</span><span class="token function">getAfterColumnsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>c<span class="token operator">-&gt;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;改变之后，列名字：&quot;</span><span class="token operator">+</span>c<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;列值：&quot;</span><span class="token operator">+</span>c<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30</p><p>测试：启动数据监控微服务，修改ydles_business的tb_ad表，观察控制台输出。</p><h2 id="_2-首页广告缓存更新" tabindex="-1"><a class="header-anchor" href="#_2-首页广告缓存更新"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_2-%E9%A6%96%E9%A1%B5%E5%B9%BF%E5%91%8A%E7%BC%93%E5%AD%98%E6%9B%B4%E6%96%B0" target="_blank" rel="noopener noreferrer">#</a>2. 首页广告缓存更新</span></a></h2><h3 id="_2-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_2-1-需求分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_2-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>2.1 需求分析</span></a></h3><p>当tb_ad（广告）表的数据发生变化时，更新redis中的广告数据。</p><h3 id="_2-2-实现思路" tabindex="-1"><a class="header-anchor" href="#_2-2-实现思路"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_2-2-%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF" target="_blank" rel="noopener noreferrer">#</a>2.2 实现思路</span></a></h3><p>需求：双11来了，广告要变了！如何更新</p><p>http://192.168.200.128/ad_update?position=web_index_lb</p><p>想一下：怎么实现，微服务拆分。微服务之间如何通讯：rabbitmq。</p><p>方案：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211028152330037.20bfbf9c.png" alt="image-20211028152330037"></p><p>（1）数据监控微服务，监控tb_ad表，当发生增删改操作时，提取position值（广告位置key）， 发送到rabbitmq</p><p>（2）运营微服务从rabbitmq中提取消息，通过OkHttpClient调用ad_update来实现对广告缓存数据的更新。</p><p>http://192.168.200.128/ad_update?position=web_index_lb</p><h3 id="_2-3-代码实现" tabindex="-1"><a class="header-anchor" href="#_2-3-代码实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_2-3-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>2.3 代码实现</span></a></h3><h4 id="_2-3-1-发送消息到mq" tabindex="-1"><a class="header-anchor" href="#_2-3-1-发送消息到mq"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_2-3-1-%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E5%88%B0mq" target="_blank" rel="noopener noreferrer">#</a>2.3.1 发送消息到mq</span></a></h4><p>（1）在rabbitmq管理后台创建队列 ad_update_queue ，用于接收广告更新通知</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/5-1.a79d3d8f.png" alt="img"></p><p>（2）引入rabbitmq起步依赖</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-rabbit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p>（3）配置文件application.properties 添加内容</p><div class="language-properties line-numbers-mode" data-highlighter="prismjs" data-ext="properties" data-title="properties"><pre><code><span class="line"><span class="token key attr-name">spring.rabbitmq.host</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.200.128</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>（4）新增rabbitMQ配置类 com.ydles.canal.config</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Configuration</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitMQConfig</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//定义队列名称</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">AD_UPDATE_QUEUE</span><span class="token operator">=</span><span class="token string">&quot;ad_update_queue&quot;</span><span class="token punctuation">;</span></span>
<span class="line">   </span>
<span class="line"></span>
<span class="line">    <span class="token comment">//声明队列</span></span>
<span class="line">    <span class="token annotation punctuation">@Bean</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token constant">AD_UPDATE_QUEUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14</p><p>（4）修改BusinessListener类</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@CanalEventListener</span> <span class="token comment">//声明当前的类是canal的监听类</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BusinessListener</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line"> *</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">eventType</span> 当前操作数据库的类型</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">rowData</span> 当前操作数据库的数据</span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@ListenPoint</span><span class="token punctuation">(</span>schema <span class="token operator">=</span> <span class="token string">&quot;ydles_business&quot;</span><span class="token punctuation">,</span>table <span class="token operator">=</span> <span class="token string">&quot;tb_ad&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">adUpdate</span><span class="token punctuation">(</span><span class="token class-name">CanalEntry<span class="token punctuation">.</span>EventType</span> eventType<span class="token punctuation">,</span><span class="token class-name">CanalEntry<span class="token punctuation">.</span>RowData</span> rowData<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;广告表数据发生改变&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//        rowData.getBeforeColumnsList().forEach((c)-&gt; System.out.println(&quot;改变前的数据：&quot;+c.getName()+&quot;::&quot;+c.getValue()));</span></span>
<span class="line"><span class="token comment">//        System.out.println(&quot;========================================&quot;);</span></span>
<span class="line"><span class="token comment">//        rowData.getAfterColumnsList().forEach((c)-&gt; System.out.println(&quot;改变后的数据：&quot;+c.getName()+&quot;::&quot;+c.getValue()));</span></span>
<span class="line"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CanalEntry<span class="token punctuation">.</span>Column</span> column <span class="token operator">:</span> rowData<span class="token punctuation">.</span><span class="token function">getAfterColumnsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span>column<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;position&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;发送数据到mq&quot;</span><span class="token operator">+</span>column<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">//发送消息</span></span>
<span class="line">            rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token class-name">RabbitMQConfig</span><span class="token punctuation">.</span><span class="token constant">AD_UPDATE_QUEQU</span><span class="token punctuation">,</span> column<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25</p><p>（5）测试：</p><p>重启canal服务</p><p>打开 http://192.168.200.128:15672/ 观察mq</p><p>修改数据库一条数据，查看程序输出、mq</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/5-6.3cf8f106.png" alt="img"></p><h4 id="_2-3-2-从mq中提取消息执行更新" tabindex="-1"><a class="header-anchor" href="#_2-3-2-从mq中提取消息执行更新"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_2-3-2-%E4%BB%8Emq%E4%B8%AD%E6%8F%90%E5%8F%96%E6%B6%88%E6%81%AF%E6%89%A7%E8%A1%8C%E6%9B%B4%E6%96%B0" target="_blank" rel="noopener noreferrer">#</a>2.3.2 从mq中提取消息执行更新</span></a></h4><p>ydles_service_business工程</p><p>（1）pom.xml引入依赖</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">    <span class="token comment">&lt;!-- mq依赖 --&gt;</span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token comment">&lt;!-- 远程调用依赖 --&gt;</span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.squareup.okhttp3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>okhttp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.9.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11</p><p>（2）在spring节点下添加rabbitmq配置</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line">  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.200.128</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><p>（3）com.ydles.business.listener下添加监听类</p><p>需求：发送http://192.168.200.128/ad_update?position=web_index_lb</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AdListener</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">&quot;ad_update_queue&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">reveiveMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> position<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;接受到了广告消息，位置:&quot;</span> <span class="token operator">+</span> position<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//发请求 http://192.168.200.128/ad_update?position=web_index_lb</span></span>
<span class="line">        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">&quot;http://192.168.200.128/ad_update?position=&quot;</span> <span class="token operator">+</span> position<span class="token punctuation">;</span></span>
<span class="line">        restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">////1,创建okHttpClient对象</span></span>
<span class="line">        <span class="token comment">//OkHttpClient okHttpClient = new OkHttpClient();</span></span>
<span class="line">        <span class="token comment">////2,创建一个Request</span></span>
<span class="line">        <span class="token comment">//String url = &quot;http://192.168.200.128/ad_update?position=&quot; + position;</span></span>
<span class="line">        <span class="token comment">//final Request request = new Request.Builder()</span></span>
<span class="line">        <span class="token comment">//        .url(url)</span></span>
<span class="line">        <span class="token comment">//        .build();</span></span>
<span class="line">        <span class="token comment">////3,新建一个call对象</span></span>
<span class="line">        <span class="token comment">//Call call = okHttpClient.newCall(request);</span></span>
<span class="line">        <span class="token comment">////4，请求加入调度，这里是异步Get请求回调</span></span>
<span class="line">        <span class="token comment">//call.enqueue(new Callback() {</span></span>
<span class="line">        <span class="token comment">//    //失败了怎么样</span></span>
<span class="line">        <span class="token comment">//    @Override</span></span>
<span class="line">        <span class="token comment">//    public void onFailure(Call call, IOException e) {</span></span>
<span class="line">        <span class="token comment">//        System.out.println(&quot;发送请求失败&quot;);</span></span>
<span class="line">        <span class="token comment">//    }</span></span>
<span class="line">        <span class="token comment">//</span></span>
<span class="line">        <span class="token comment">//    //成功了应该怎么样</span></span>
<span class="line">        <span class="token comment">//    @Override</span></span>
<span class="line">        <span class="token comment">//    public void onResponse(Call call, Response response) throws IOException {</span></span>
<span class="line">        <span class="token comment">//        System.out.println(&quot;发送请求成功&quot;+response.message());</span></span>
<span class="line">        <span class="token comment">//    }</span></span>
<span class="line">        <span class="token comment">//});</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40</p><p>（7）测试，启动eureka和business微服务，观察控制台输出和数据同步效果。</p><p><strong>拓展</strong>：java 发送请求 三个原生客户端</p><p>okhttp</p><p>httpclient</p><p>URLconnection</p><h2 id="_3-商品上架索引库导入数据" tabindex="-1"><a class="header-anchor" href="#_3-商品上架索引库导入数据"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-%E5%95%86%E5%93%81%E4%B8%8A%E6%9E%B6%E7%B4%A2%E5%BC%95%E5%BA%93%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE" target="_blank" rel="noopener noreferrer">#</a>3. 商品上架索引库导入数据</span></a></h2><h3 id="_3-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_3-1-需求分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>3.1 需求分析</span></a></h3><p>商品上架将商品的sku列表导入或更新索引库。</p><h3 id="_3-2-实现思路" tabindex="-1"><a class="header-anchor" href="#_3-2-实现思路"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-2-%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF" target="_blank" rel="noopener noreferrer">#</a>3.2 实现思路</span></a></h3><p>（1）商品上架（spu.is_marketable 0变为1） --&gt;canal监控--&gt;mq发送spuId。</p><p>（2）在rabbitmq管理后台创建商品上架交换机（fanout订阅发布模式）。<strong>为什么</strong>？</p><ol><li>导入索引库。</li><li>详情页面静态化。</li></ol><p>（3）spuId--&gt;搜索服务--&gt;feign商品服务获取skulList--&gt;放入Es索引库。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211030153926557.56a47431.png" alt="image-20211030153926557"></p><h3 id="_3-3-代码实现" tabindex="-1"><a class="header-anchor" href="#_3-3-代码实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-3-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>3.3 代码实现</span></a></h3><h4 id="_3-3-1-发送消息到mq" tabindex="-1"><a class="header-anchor" href="#_3-3-1-发送消息到mq"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-3-1-%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E5%88%B0mq" target="_blank" rel="noopener noreferrer">#</a>3.3.1 发送消息到mq</span></a></h4><p>（1）在rabbitmq后台创建交换器goods_up_exchange（类型为fanout），创建队列search_add_queue绑定交换器goods_up_exchange,更新rabbitmq配置类</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211030173218523.2e0fd07d.png" alt="image-20211030173218523"></p><p><strong>回顾</strong>：rabbitMq五种工作模式。</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * @Created by IT李老师</span>
<span class="line"> * 公主号 “IT李哥交朋友”</span>
<span class="line"> * 个人微 itlils</span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@Configuration</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitMQConfig</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//定义队列名称</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">AD_UPDATE_QUEUE</span><span class="token operator">=</span><span class="token string">&quot;ad_update_queue&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Bean</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token constant">AD_UPDATE_QUEUE</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//上架交换机名称</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">GOODS_UP_EXCHANGE</span> <span class="token operator">=</span> <span class="token string">&quot;goods_up_exchange&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//定义上架队列名称</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SEARCH_ADD_QUEUE</span> <span class="token operator">=</span> <span class="token string">&quot;search_add_queue&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//定义上架队列</span></span>
<span class="line">    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token constant">SEARCH_ADD_QUEUE</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">SEARCH_ADD_QUEUE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token constant">SEARCH_ADD_QUEUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//定义上架交换机</span></span>
<span class="line">    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token constant">GOODS_UP_EXCHANGE</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Exchange</span> <span class="token function">GOODS_UP_EXCHANGE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token class-name">ExchangeBuilder</span><span class="token punctuation">.</span><span class="token function">fanoutExchange</span><span class="token punctuation">(</span><span class="token constant">GOODS_UP_EXCHANGE</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//上架队列和上架交换机绑定关系构建</span></span>
<span class="line">    <span class="token annotation punctuation">@Bean</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">GOODS_UP_EXCHANGE_SEARCH_ADD_QUEUE</span><span class="token punctuation">(</span></span>
<span class="line">            <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token constant">SEARCH_ADD_QUEUE</span><span class="token punctuation">)</span><span class="token class-name">Queue</span> queue</span>
<span class="line">            <span class="token punctuation">,</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token constant">GOODS_UP_EXCHANGE</span><span class="token punctuation">)</span><span class="token class-name">Exchange</span> exchange <span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">noargs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41</p><p>（2）数据监控微服务新增com.ydles.canal.listener.SpuListener，添加以下代码：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * @Created by IT李老师</span>
<span class="line"> * 公主号 “IT李哥交朋友”</span>
<span class="line"> * 个人微 itlils</span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@CanalEventListener</span> <span class="token comment">//这个类是canal的监听类</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpuListener</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@ListenPoint</span><span class="token punctuation">(</span>schema <span class="token operator">=</span> <span class="token string">&quot;ydles_goods&quot;</span><span class="token punctuation">,</span>table <span class="token operator">=</span> <span class="token string">&quot;tb_spu&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">goodsUp</span><span class="token punctuation">(</span><span class="token class-name">CanalEntry<span class="token punctuation">.</span>EventType</span> eventType<span class="token punctuation">,</span> <span class="token class-name">CanalEntry<span class="token punctuation">.</span>RowData</span> rowData<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;监听到了spu数据变了：&quot;</span><span class="token operator">+</span>eventType<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//isMarketable 0-&gt;1</span></span>
<span class="line">        <span class="token comment">//改变之前的数据 ---&gt;map  {id:123,name:prada}</span></span>
<span class="line">        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> oldMap<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        rowData<span class="token punctuation">.</span><span class="token function">getBeforeColumnsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>column <span class="token operator">-&gt;</span> oldMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>column<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> column<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//改变之后的数据 ---&gt;map  {id:123,name:prada}</span></span>
<span class="line">        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> newMap<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        rowData<span class="token punctuation">.</span><span class="token function">getAfterColumnsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>column <span class="token operator">-&gt;</span> newMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>column<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> column<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;is_marketable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span> newMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;is_marketable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//mq发spuId</span></span>
<span class="line">            <span class="token class-name">String</span> spuId <span class="token operator">=</span> newMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;商品上架了，往mq发消息&quot;</span><span class="token operator">+</span>spuId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token class-name">RabbitMQConfig</span><span class="token punctuation">.</span><span class="token constant">GOODS_UP_EXCHANGE</span><span class="token punctuation">,</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>spuId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30</p><p>测试：修改一条数据，查看mq中消息。</p><h4 id="_3-3-2-索引库环境准备" tabindex="-1"><a class="header-anchor" href="#_3-3-2-索引库环境准备"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-3-2-%E7%B4%A2%E5%BC%95%E5%BA%93%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87" target="_blank" rel="noopener noreferrer">#</a>3.3.2 索引库环境准备</span></a></h4><p>我们提供的虚拟机镜像中已经包含了elasticsearch的相关docker镜像</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211030162259387.7052ea33.png" alt="image-20211030162259387"></p><h4 id="_3-3-3-创建索引结构" tabindex="-1"><a class="header-anchor" href="#_3-3-3-创建索引结构"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-3-3-%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E7%BB%93%E6%9E%84" target="_blank" rel="noopener noreferrer">#</a>3.3.3 创建索引结构</span></a></h4><p>新建ydles_service_search_api模块,并添加索引库实体类</p><p>(1) 添加依赖</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">        <span class="token comment">&lt;!--公共包--&gt;</span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ydles_common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token comment">&lt;!--spring boot 与es 结合包--&gt;</span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-elasticsearch<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11</p><p>(2) 创建实体类com.ydles.search.pojo</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Document</span><span class="token punctuation">(</span>indexName <span class="token operator">=</span> <span class="token string">&quot;skuinfo&quot;</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">&quot;docs&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SkuInfo</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//商品id，同时也是商品编号</span></span>
<span class="line">    <span class="token annotation punctuation">@Id</span></span>
<span class="line">    <span class="token annotation punctuation">@Field</span><span class="token punctuation">(</span>index <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> store <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">FieldType<span class="token punctuation">.</span>Keyword</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//SKU名称</span></span>
<span class="line">    <span class="token annotation punctuation">@Field</span><span class="token punctuation">(</span>index <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> store <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">FieldType<span class="token punctuation">.</span>Text</span><span class="token punctuation">,</span> analyzer <span class="token operator">=</span> <span class="token string">&quot;ik_smart&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//商品价格，单位为：元</span></span>
<span class="line">    <span class="token annotation punctuation">@Field</span><span class="token punctuation">(</span>index <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> store <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">FieldType<span class="token punctuation">.</span>Double</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Long</span> price<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//库存数量</span></span>
<span class="line">    <span class="token annotation punctuation">@Field</span><span class="token punctuation">(</span>index <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> store <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">FieldType<span class="token punctuation">.</span>Integer</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Integer</span> num<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//商品图片</span></span>
<span class="line">    <span class="token annotation punctuation">@Field</span><span class="token punctuation">(</span>index <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> store <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">FieldType<span class="token punctuation">.</span>Text</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> image<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//商品状态，1-正常，2-下架，3-删除</span></span>
<span class="line">    <span class="token annotation punctuation">@Field</span><span class="token punctuation">(</span>index <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> store <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">FieldType<span class="token punctuation">.</span>Keyword</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> status<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//创建时间</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Date</span> createTime<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//更新时间</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Date</span> updateTime<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//是否默认</span></span>
<span class="line">    <span class="token annotation punctuation">@Field</span><span class="token punctuation">(</span>index <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> store <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">FieldType<span class="token punctuation">.</span>Keyword</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> isDefault<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//SPUID</span></span>
<span class="line">    <span class="token annotation punctuation">@Field</span><span class="token punctuation">(</span>index <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> store <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">FieldType<span class="token punctuation">.</span>Long</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Long</span> spuId<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//类目ID</span></span>
<span class="line">    <span class="token annotation punctuation">@Field</span><span class="token punctuation">(</span>index <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> store <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">FieldType<span class="token punctuation">.</span>Long</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Long</span> categoryId<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//类目名称</span></span>
<span class="line">    <span class="token annotation punctuation">@Field</span><span class="token punctuation">(</span>index <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> store <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">FieldType<span class="token punctuation">.</span>Keyword</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> categoryName<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//品牌名称</span></span>
<span class="line">    <span class="token annotation punctuation">@Field</span><span class="token punctuation">(</span>index <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> store <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">FieldType<span class="token punctuation">.</span>Keyword</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> brandName<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//规格</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> spec<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//规格参数</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> specMap<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">//getter &amp; setter略</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61</p><h4 id="_3-3-4-搜索微服务搭建" tabindex="-1"><a class="header-anchor" href="#_3-3-4-搜索微服务搭建"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-3-4-%E6%90%9C%E7%B4%A2%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BA" target="_blank" rel="noopener noreferrer">#</a>3.3.4 搜索微服务搭建</span></a></h4><p>（1）创建ydles_service_search模块，pom.xml引入依赖</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">		<span class="token comment">&lt;!--公共包--&gt;</span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ydles_common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token comment">&lt;!--注册中心--&gt;</span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token comment">&lt;!--spring boot 与es 结合包--&gt;</span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-elasticsearch<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token comment">&lt;!--商品实体类--&gt;</span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ydles_service_goods_api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token comment">&lt;!--搜索实体类--&gt;</span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ydles_service_search_api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token comment">&lt;!--rabbitmq依赖--&gt;</span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33</p><p>（2）ydles_service_search的application.yml</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">server</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9009</span></span>
<span class="line"><span class="token key atrule">spring</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">application</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> search</span>
<span class="line">  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.200.128</span>
<span class="line">  <span class="token key atrule">redis</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.200.128</span>
<span class="line">  <span class="token key atrule">main</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">allow-bean-definition-overriding</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment">#当遇到同样名字的时候，是否允许覆盖注册</span></span>
<span class="line">  <span class="token key atrule">data</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">elasticsearch</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">cluster-name</span><span class="token punctuation">:</span> elasticsearch</span>
<span class="line">      <span class="token key atrule">cluster-nodes</span><span class="token punctuation">:</span> 192.168.200.128<span class="token punctuation">:</span><span class="token number">9300</span></span>
<span class="line"><span class="token key atrule">eureka</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">client</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">service-url</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>6868/eureka</span>
<span class="line">  <span class="token key atrule">instance</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line"><span class="token key atrule">feign</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">hystrix</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">  <span class="token key atrule">client</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">config</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">default</span><span class="token punctuation">:</span>   <span class="token comment">#配置全局的feign的调用超时时间  如果 有指定的服务配置 默认的配置不会生效</span></span>
<span class="line">        <span class="token key atrule">connectTimeout</span><span class="token punctuation">:</span> <span class="token number">600000</span> <span class="token comment"># 指定的是 消费者 连接服务提供者的连接超时时间 是否能连接  单位是毫秒</span></span>
<span class="line">        <span class="token key atrule">readTimeout</span><span class="token punctuation">:</span> <span class="token number">600000</span>  <span class="token comment"># 指定的是调用服务提供者的 服务 的超时时间（）  单位是毫秒</span></span>
<span class="line"><span class="token comment">#hystrix 配置</span></span>
<span class="line"><span class="token key atrule">hystrix</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">command</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">default</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">execution</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">timeout</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token comment">#如果enabled设置为false，则请求超时交给ribbon控制</span></span>
<span class="line">          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></span>
<span class="line">        <span class="token key atrule">isolation</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">strategy</span><span class="token punctuation">:</span> SEMAPHORE</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39</p><p>（3）创建com.ydles.search包，包下创建SearchApplication</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@SpringBootApplication</span></span>
<span class="line"><span class="token annotation punctuation">@EnableEurekaClient</span></span>
<span class="line"><span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;com.ydles.goods.feign&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SearchApplication</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SearchApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8</p><p>(4) 将rabbitmq配置类放入该模块下</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Configuration</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitMQConfig</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//上架交换机名称</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">GOODS_UP_EXCHANGE</span> <span class="token operator">=</span> <span class="token string">&quot;goods_up_exchange&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//定义队列名称</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">AD_UPDATE_QUEQU</span> <span class="token operator">=</span> <span class="token string">&quot;ad_update_quequ&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">//定义上架队列名称</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SEARCH_ADD_QUEUE</span> <span class="token operator">=</span> <span class="token string">&quot;search_add_queue&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">//声明队列</span></span>
<span class="line"><span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token constant">AD_UPDATE_QUEQU</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token constant">AD_UPDATE_QUEQU</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">//声明上架队列</span></span>
<span class="line"><span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token constant">SEARCH_ADD_QUEUE</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">SEARCH_ADD_QUEUE</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token constant">SEARCH_ADD_QUEUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">//声明上架交换机</span></span>
<span class="line"><span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token constant">GOODS_UP_EXCHANGE</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Exchange</span> <span class="token function">GOODS_UP_EXCHANGE</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token class-name">ExchangeBuilder</span><span class="token punctuation">.</span><span class="token function">fanoutExchange</span><span class="token punctuation">(</span><span class="token constant">GOODS_UP_EXCHANGE</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 队列和交换机绑定</span></span>
<span class="line"><span class="token annotation punctuation">@Bean</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">GOODS_UP_EXCHANGE_BINDING</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token constant">SEARCH_ADD_QUEUE</span><span class="token punctuation">)</span> <span class="token class-name">Queue</span> queue<span class="token punctuation">,</span></span>
<span class="line">        <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token constant">GOODS_UP_EXCHANGE</span><span class="token punctuation">)</span> <span class="token class-name">Exchange</span> exchange<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">noargs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34</p><h4 id="_3-3-5-商品服务查询商品信息" tabindex="-1"><a class="header-anchor" href="#_3-3-5-商品服务查询商品信息"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-3-5-%E5%95%86%E5%93%81%E6%9C%8D%E5%8A%A1%E6%9F%A5%E8%AF%A2%E5%95%86%E5%93%81%E4%BF%A1%E6%81%AF" target="_blank" rel="noopener noreferrer">#</a>3.3.5 商品服务查询商品信息</span></a></h4><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211030173302665.751a5156.png" alt="image-20211030173302665"></p><p>(1) SkuController新增方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/spu/{spuId}&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Sku</span><span class="token punctuation">&gt;</span></span> <span class="token function">findSkuListBySpuId</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;spuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> spuId<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> searchMap <span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//搜索全部，传来的spuId为all</span></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">&quot;all&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>spuId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//spuId作为条件传入搜索列表</span></span>
<span class="line">        searchMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;spuId&quot;</span><span class="token punctuation">,</span> spuId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">//审核通过的</span></span>
<span class="line">    searchMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Sku</span><span class="token punctuation">&gt;</span></span> skuList <span class="token operator">=</span> skuService<span class="token punctuation">.</span><span class="token function">findList</span><span class="token punctuation">(</span>searchMap<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span>  skuList<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15</p><p>(2) ydles_service_goods_api新增common依赖</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token generics"><span class="token punctuation">&lt;</span>dependencies<span class="token punctuation">&gt;</span></span></span>
<span class="line">  <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>com<span class="token punctuation">.</span>ydles<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>ydles_common<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">1.0</span><span class="token operator">-</span><span class="token constant">SNAPSHOT</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span></span>
<span class="line">  <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span><span class="token operator">/</span>dependencies<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><p>(3) 定义skuFegin接口</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;goods&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SkuFeign</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//根据spuId查询skuList</span></span>
<span class="line">    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/sku/spu/{spuId}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Sku</span><span class="token punctuation">&gt;</span></span> <span class="token function">findSkuListBySpuId</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;spuId&quot;</span><span class="token punctuation">)</span><span class="token class-name">String</span> spuId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><p>4测试 http://localhost:9001/sku/spu/1205332629172256768</p><h4 id="_3-3-6-搜索微服务批量导入数据逻辑" tabindex="-1"><a class="header-anchor" href="#_3-3-6-搜索微服务批量导入数据逻辑"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-3-6-%E6%90%9C%E7%B4%A2%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%89%B9%E9%87%8F%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E9%80%BB%E8%BE%91" target="_blank" rel="noopener noreferrer">#</a>3.3.6 搜索微服务批量导入数据逻辑</span></a></h4><p>(1) 创建 com.ydles.search.dao包,并新增ESManagerMapper接口</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ESManagerMapper</span> <span class="token keyword">extends</span> <span class="token class-name">ElasticsearchRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuInfo</span><span class="token punctuation">,</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>（2）创建 com.ydles.search.service包，包下创建接口EsManagerService</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * @Created by IT李老师</span>
<span class="line"> * 公主号 “IT李哥交朋友”</span>
<span class="line"> * 个人微 itlils</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">EsManagerService</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//1创建索引库，映射</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createIndexAndMapping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//2 现有所有sku导入es</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">importData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//3 根据spuId,将他的skuList导入es</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">importDataBySpuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17</p><p>（2）创建com.ydles.search.service.impl包，包下创建服务实现类</p><p><strong>Template</strong>:帮助我们创建连接，关闭连接。类比rabbitTemplate redisTemplate jdbcTemplate</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Service</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EsManagerServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">EsManagerService</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">ElasticsearchTemplate</span> elasticsearchTemplate<span class="token punctuation">;</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">SkuFeign</span> skuFeign<span class="token punctuation">;</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">ESManagerMapper</span> esManagerMapper<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//1创建索引库，映射</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createIndexAndMapping</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//创建索引</span></span>
<span class="line">        elasticsearchTemplate<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span><span class="token class-name">SkuInfo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//创建映射</span></span>
<span class="line">        elasticsearchTemplate<span class="token punctuation">.</span><span class="token function">putMapping</span><span class="token punctuation">(</span><span class="token class-name">SkuInfo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//2 现有所有sku导入es</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">importData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//1 查到现有所有sku</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Sku</span><span class="token punctuation">&gt;</span></span> skuList <span class="token operator">=</span> skuFeign<span class="token punctuation">.</span><span class="token function">findSkuListBySpuId</span><span class="token punctuation">(</span><span class="token string">&quot;all&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;查询出的skulist多少：&quot;</span><span class="token operator">+</span>skuList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//2导入es</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuInfo</span><span class="token punctuation">&gt;</span></span> skuinfoList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Sku</span> sku <span class="token operator">:</span> skuList<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">String</span> skuStr <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>sku<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//{id:12,name:asda}</span></span>
<span class="line">            <span class="token class-name">SkuInfo</span> skuInfo <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>skuStr<span class="token punctuation">,</span> <span class="token class-name">SkuInfo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">//需求 Sku.spec string ------&gt;SkuInfo.specMap Map</span></span>
<span class="line">            <span class="token class-name">Map</span> map <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>sku<span class="token punctuation">.</span><span class="token function">getSpec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            skuInfo<span class="token punctuation">.</span><span class="token function">setSpecMap</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            skuinfoList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>skuInfo<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        esManagerMapper<span class="token punctuation">.</span><span class="token function">saveAll</span><span class="token punctuation">(</span>skuinfoList<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">importDataBySpuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45</p><p>(3) 创建com.ydles.search.controller.定义ESManagerController</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * @Created by IT李老师</span>
<span class="line"> * 公主号 “IT李哥交朋友”</span>
<span class="line"> * 个人微 itlils</span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@RestController</span></span>
<span class="line"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/manager&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ESManagerController</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">EsManagerService</span> esManagerService<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/create&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        esManagerService<span class="token punctuation">.</span><span class="token function">createIndexAndMapping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span><span class="token string">&quot;创建索引库成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/importData&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">importData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        esManagerService<span class="token punctuation">.</span><span class="token function">importData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span><span class="token string">&quot;导入数据成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24</p><p><strong>测试</strong>：</p><p>1head插件查看es中索引状态为空</p><p>2启动搜索服务</p><p>3postman测试 http://localhost:9009/manager/create</p><p>4结果 es中添加skuinfo索引</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211030183741103.ea662a6d.png" alt="image-20211030183741103"></p><p>5postman测试 http://localhost:9009/manager/importData</p><p>6结果 es中skuinfo索引添加了数据</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211030183728380.6b89b562.png" alt="image-20211030183728380"></p><h4 id="_3-3-7-接收mq消息执行导入" tabindex="-1"><a class="header-anchor" href="#_3-3-7-接收mq消息执行导入"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-3-7-%E6%8E%A5%E6%94%B6mq%E6%B6%88%E6%81%AF%E6%89%A7%E8%A1%8C%E5%AF%BC%E5%85%A5" target="_blank" rel="noopener noreferrer">#</a>3.3.7 接收mq消息执行导入</span></a></h4><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211030184417465.f6557934.png" alt="image-20211030184417465"></p><p><strong>梳理逻辑</strong>：canal监听到某个spu上架，发送到mq之后，搜索服务接受消息，将此spu对应的sku查出来，放到es索引库。</p><p>ydles_service_search工程创建com.ydles.search.listener包，包下创建类</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * @Created by IT李老师</span>
<span class="line"> * 公主号 “IT李哥交朋友”</span>
<span class="line"> * 个人微 itlils</span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GoodUpListener</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">EsManagerService</span> esManagerService<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token class-name">RabbitMQConfig</span><span class="token punctuation">.</span><span class="token constant">SEARCH_ADD_QUEUE</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">recieveMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> spuId<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;监听到了商品上架了！：&quot;</span><span class="token operator">+</span>spuId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        esManagerService<span class="token punctuation">.</span><span class="token function">importDataBySpuId</span><span class="token punctuation">(</span>spuId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17</p><h4 id="_3-3-8-测试" tabindex="-1"><a class="header-anchor" href="#_3-3-8-测试"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-3-8-%E6%B5%8B%E8%AF%95" target="_blank" rel="noopener noreferrer">#</a>3.3.8 测试</span></a></h4><p>1启动canal、search等微服务</p><p>2将数据库中spu一条数据由下架改为上架</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211030185406174.8d5981a0.png" alt="image-20211030185406174"></p><p>3search输出数据</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211030185418805.5f834ec6.png" alt="image-20211030185418805"></p><p><img src="data:image/png;base64,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" alt="image-20211030185424901"></p><p>4索引库中数据添加</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211030185438761.3216308b.png" alt="image-20211030185438761"></p><h2 id="_4-商品下架索引库删除数据" tabindex="-1"><a class="header-anchor" href="#_4-商品下架索引库删除数据"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_4-%E5%95%86%E5%93%81%E4%B8%8B%E6%9E%B6%E7%B4%A2%E5%BC%95%E5%BA%93%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE" target="_blank" rel="noopener noreferrer">#</a>4. 商品下架索引库删除数据</span></a></h2><h3 id="_4-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_4-1-需求分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_4-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>4.1 需求分析</span></a></h3><p>商品下架后将商品从索引库中移除。</p><h3 id="_4-2-实现思路" tabindex="-1"><a class="header-anchor" href="#_4-2-实现思路"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_4-2-%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF" target="_blank" rel="noopener noreferrer">#</a>4.2 实现思路</span></a></h3><p>与商品上架的实现思路非常类似。</p><p>（1）在数据监控微服务中监控tb_spu表的数据，当tb_spu发生更改且is_marketable为0时，表示商品下架，将spu的id发送到rabbitmq。</p><p>（2）在rabbitmq管理后台创建商品下架交换器（fanout）。使用分列模式的交换器是考虑商品下架会有很多种逻辑需要处理，索引库删除数据只是其中一项，另外还有删除商品详细页等操作。</p><p>（3）搜索微服务从rabbitmq的的队列中提取spu的id，通过调用elasticsearch的高级restAPI 将相关的sku列表从索引库删除。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211030222900601.48fac74f.png" alt="image-20211030222900601"></p><h3 id="_4-3-代码实现" tabindex="-1"><a class="header-anchor" href="#_4-3-代码实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_4-3-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>4.3 代码实现</span></a></h3><p>根据上边讲解的实现思路完成商品下架索引库删除数据的功能</p><h4 id="_4-3-1-创建交换器与队列" tabindex="-1"><a class="header-anchor" href="#_4-3-1-创建交换器与队列"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_4-3-1-%E5%88%9B%E5%BB%BA%E4%BA%A4%E6%8D%A2%E5%99%A8%E4%B8%8E%E9%98%9F%E5%88%97" target="_blank" rel="noopener noreferrer">#</a>4.3.1 创建交换器与队列</span></a></h4><p>完成商品下架交换器的创建，队列的创建与绑定，将spuId发送消息到mq</p><p>商品下架交换器：goods_down_exchange</p><p>队列名称： search_delete_queue</p><p>绑定 search_delete_queue到goods_down_exchange</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"> <span class="token comment">//下架交换机名称</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">GOODS_DOWN_EXCHANGE</span> <span class="token operator">=</span> <span class="token string">&quot;goods_down_exchange&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//定义下架队列名称</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SEARCH_DEL_QUEUE</span> <span class="token operator">=</span> <span class="token string">&quot;search_del_queue&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//定义下架队列</span></span>
<span class="line">    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token constant">SEARCH_DEL_QUEUE</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">SEARCH_DEL_QUEUE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token constant">SEARCH_DEL_QUEUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//定义下架交换机</span></span>
<span class="line">    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token constant">GOODS_DOWN_EXCHANGE</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Exchange</span> <span class="token function">GOODS_DOWN_EXCHANGE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token class-name">ExchangeBuilder</span><span class="token punctuation">.</span><span class="token function">fanoutExchange</span><span class="token punctuation">(</span><span class="token constant">GOODS_DOWN_EXCHANGE</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//下架队列和下架交换机绑定关系构建</span></span>
<span class="line">    <span class="token annotation punctuation">@Bean</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">GOODS_DOWN_EXCHANGE_SEARCH_DEL_QUEUE</span><span class="token punctuation">(</span></span>
<span class="line">            <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token constant">SEARCH_DEL_QUEUE</span><span class="token punctuation">)</span><span class="token class-name">Queue</span> queue</span>
<span class="line">            <span class="token punctuation">,</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token constant">GOODS_DOWN_EXCHANGE</span><span class="token punctuation">)</span><span class="token class-name">Exchange</span> exchange <span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">noargs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25</p><p>2将RabbitMQConfig 复制到搜索服务</p><h4 id="_4-3-2-canal监听下架" tabindex="-1"><a class="header-anchor" href="#_4-3-2-canal监听下架"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_4-3-2-canal%E7%9B%91%E5%90%AC%E4%B8%8B%E6%9E%B6" target="_blank" rel="noopener noreferrer">#</a>4.3.2 canal监听下架</span></a></h4><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211030223121917.9663121e.png" alt="image-20211030223121917"></p><p>修改ydles_canal的SpuListener的spuUpdate方法，添加以下代码</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">//获取最新下架的商品 1-&gt;0</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>oldData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;is_marketable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>newData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;is_marketable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//将商品的spuid发送到mq</span></span>
<span class="line">    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token class-name">RabbitMQConfig</span><span class="token punctuation">.</span><span class="token constant">GOODS_DOWN_EXCHANGE</span><span class="token punctuation">,</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>newData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><h4 id="_4-3-3-根据spuid删除索引数据" tabindex="-1"><a class="header-anchor" href="#_4-3-3-根据spuid删除索引数据"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_4-3-3-%E6%A0%B9%E6%8D%AEspuid%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95%E6%95%B0%E6%8D%AE" target="_blank" rel="noopener noreferrer">#</a>4.3.3 根据spuId删除索引数据</span></a></h4><p>编写业务逻辑，实现根据spuId删除索引库数据的方法。</p><p>（1）ESManagerService新增方法定义</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">//根据souid删除es索引库中相关的sku数据</span></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">delDataBySpuId</span><span class="token punctuation">(</span><span class="token class-name">String</span> spuId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><p>（2）ESManagerServiceImpl实现方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delDataBySpuId</span><span class="token punctuation">(</span><span class="token class-name">String</span> spuId<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Sku</span><span class="token punctuation">&gt;</span></span> skuList <span class="token operator">=</span> skuFeign<span class="token punctuation">.</span><span class="token function">findSkuListBySpuId</span><span class="token punctuation">(</span>spuId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>skuList <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> skuList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;当前没有数据被查询到,无法导入索引库&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Sku</span> sku <span class="token operator">:</span> skuList<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        esManagerMapper<span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>sku<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10</p><h4 id="_4-3-4-接收mq消息-执行索引库删除" tabindex="-1"><a class="header-anchor" href="#_4-3-4-接收mq消息-执行索引库删除"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_4-3-4-%E6%8E%A5%E6%94%B6mq%E6%B6%88%E6%81%AF-%E6%89%A7%E8%A1%8C%E7%B4%A2%E5%BC%95%E5%BA%93%E5%88%A0%E9%99%A4" target="_blank" rel="noopener noreferrer">#</a>4.3.4 接收mq消息，执行索引库删除</span></a></h4><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211030223326342.c60e958f.png" alt="image-20211030223326342"></p><p>从rabbitmq中提取消息，调动根据spuId删除索引库数据的方法 ydles_service_search新增监听类</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GoodsDelListener</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">ESManagerService</span> esManagerService<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token class-name">RabbitMQConfig</span><span class="token punctuation">.</span><span class="token constant">SEARCH_DEL_QUEUE</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> spuId<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;删除索引库监听类,接收到的spuId:  &quot;</span><span class="token operator">+</span>spuId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//调用业务层完成索引库数据删除</span></span>
<span class="line">        esManagerService<span class="token punctuation">.</span><span class="token function">delDataBySpuId</span><span class="token punctuation">(</span>spuId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14</p><p><strong>测试</strong>：</p><p>1重启canal、搜索服务</p><p>2修改数据库中一条数据，将上架状态改为架</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211030224154522.2f211d56.png" alt="image-20211030224154522"></p><p>3观察canal应用输出</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211030224202732.27a60f04.png" alt="image-20211030224202732"></p><p>4观察es输出</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211030224218009.aac4cc08.png" alt="image-20211030224218009"></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211030224223867.60d41aab.png" alt="image-20211030224223867"></p><p>总结：</p><p>1canal</p><p>mysql 主从复制 binlog</p><p>canal伪装slave</p><p>代码</p><p>2广告更新</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211028152330037.20bfbf9c.png" alt="image-20211028152330037"></p><p>3商品上架 同步到es库</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211030153926557.56a47431.png" alt="image-20211030153926557"></p><p>4商品下架 es库删除</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211030222900601.48fac74f.png" alt="image-20211030222900601"></p><p>知识点：boot cloud(feign) rabbitmq(5种工作模式) es</p><h2 id="第7章-商品搜索-elastaicsearch" tabindex="-1"><a class="header-anchor" href="#第7章-商品搜索-elastaicsearch"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#%E7%AC%AC7%E7%AB%A0-%E5%95%86%E5%93%81%E6%90%9C%E7%B4%A2-elastaicsearch" target="_blank" rel="noopener noreferrer">#</a>第7章 商品搜索-elastaicSearch</span></a></h2><p><strong>角色</strong>：搜索后端组 search-service</p><p>前置内容：2天elasticsearch入门 倒排索引 全文检索</p><h2 id="_1课程目标" tabindex="-1"><a class="header-anchor" href="#_1课程目标"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_1%E8%AF%BE%E7%A8%8B%E7%9B%AE%E6%A0%87" target="_blank" rel="noopener noreferrer">#</a>1课程目标</span></a></h2><ul><li>根据搜索关键字查询</li><li>条件筛选</li><li>规格过滤</li><li>价格区间搜索</li><li>分页查询</li><li>排序查询</li><li>高亮查询</li></ul><h2 id="_2搭建框架" tabindex="-1"><a class="header-anchor" href="#_2搭建框架"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_2%E6%90%AD%E5%BB%BA%E6%A1%86%E6%9E%B6" target="_blank" rel="noopener noreferrer">#</a>2搭建框架</span></a></h2><h3 id="_2-1关键字查询-构建搜索条件" tabindex="-1"><a class="header-anchor" href="#_2-1关键字查询-构建搜索条件"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_2-1%E5%85%B3%E9%94%AE%E5%AD%97%E6%9F%A5%E8%AF%A2-%E6%9E%84%E5%BB%BA%E6%90%9C%E7%B4%A2%E6%9D%A1%E4%BB%B6" target="_blank" rel="noopener noreferrer">#</a>2.1关键字查询-构建搜索条件</span></a></h3><p>需求：day01页面原型-》search.html</p><p>1搜索服务 com.ydles.search.service</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SearchService</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//按照查询条件进行数据查询</span></span>
<span class="line">    <span class="token class-name">Map</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> searchMap<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p>2com.ydles.search.service.impl</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Service</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SearchServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">SearchService</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token annotation punctuation">@Autowired</span></span>
<span class="line"><span class="token class-name">ElasticsearchTemplate</span> elasticsearchTemplate<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Map</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> searchMap<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//构建查询</span></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span>searchMap<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">         <span class="token comment">//  条件构建对象</span></span>
<span class="line">        <span class="token class-name">NativeSearchQueryBuilder</span> nativeSearchQueryBuilder<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">NativeSearchQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">BoolQueryBuilder</span> boolQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//关键字查询</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>searchMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;keywords&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            boolQueryBuilder<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> searchMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;keywords&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">operator</span><span class="token punctuation">(</span><span class="token class-name">Operator</span><span class="token punctuation">.</span><span class="token constant">AND</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        nativeSearchQueryBuilder<span class="token punctuation">.</span><span class="token function">withQuery</span><span class="token punctuation">(</span>boolQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//开启查询</span></span>
<span class="line">        <span class="token doc-comment comment">/**</span>
<span class="line">         * 条件构建对象</span>
<span class="line">         * 查询实体类</span>
<span class="line">         * 查询结果对象</span>
<span class="line">         */</span></span>
<span class="line">        <span class="token class-name">AggregatedPage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuInfo</span><span class="token punctuation">&gt;</span></span> resultInfo <span class="token operator">=</span> elasticsearchTemplate<span class="token punctuation">.</span><span class="token function">queryForPage</span><span class="token punctuation">(</span>nativeSearchQueryBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SkuInfo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SearchResultMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token annotation punctuation">@Override</span></span>
<span class="line">            <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">AggregatedPage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">mapResults</span><span class="token punctuation">(</span><span class="token class-name">SearchResponse</span> searchResponse<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> aClass<span class="token punctuation">,</span> <span class="token class-name">Pageable</span> pageable<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38</p><h3 id="_2-2封装查询结果" tabindex="-1"><a class="header-anchor" href="#_2-2封装查询结果"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_2-2%E5%B0%81%E8%A3%85%E6%9F%A5%E8%AF%A2%E7%BB%93%E6%9E%9C" target="_blank" rel="noopener noreferrer">#</a>2.2封装查询结果</span></a></h3><p>完善com.ydles.search.service.impl</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Service</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SearchServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">SearchService</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token annotation punctuation">@Autowired</span></span>
<span class="line"><span class="token class-name">ElasticsearchTemplate</span> elasticsearchTemplate<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Map</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> searchMap<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//结果map</span></span>
<span class="line">    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> resultMap<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//构建查询</span></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span>searchMap<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">         <span class="token comment">//  条件构建对象</span></span>
<span class="line">        <span class="token class-name">NativeSearchQueryBuilder</span> nativeSearchQueryBuilder<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">NativeSearchQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">BoolQueryBuilder</span> boolQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//关键字查询</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>searchMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;keywords&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            boolQueryBuilder<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> searchMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;keywords&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">operator</span><span class="token punctuation">(</span><span class="token class-name">Operator</span><span class="token punctuation">.</span><span class="token constant">AND</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        nativeSearchQueryBuilder<span class="token punctuation">.</span><span class="token function">withQuery</span><span class="token punctuation">(</span>boolQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//开启查询</span></span>
<span class="line">        <span class="token doc-comment comment">/**</span>
<span class="line">         * 条件构建对象</span>
<span class="line">         * 查询实体类</span>
<span class="line">         * 查询结果对象</span>
<span class="line">         */</span></span>
<span class="line">        <span class="token comment">//封装查询结果</span></span>
<span class="line">        <span class="token class-name">AggregatedPage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuInfo</span><span class="token punctuation">&gt;</span></span> resultInfo <span class="token operator">=</span> elasticsearchTemplate<span class="token punctuation">.</span><span class="token function">queryForPage</span><span class="token punctuation">(</span>nativeSearchQueryBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SkuInfo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SearchResultMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token annotation punctuation">@Override</span></span>
<span class="line">            <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">AggregatedPage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">mapResults</span><span class="token punctuation">(</span><span class="token class-name">SearchResponse</span> searchResponse<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> aClass<span class="token punctuation">,</span> <span class="token class-name">Pageable</span> pageable<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// 查询结果操作</span></span>
<span class="line">                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> list<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">                <span class="token comment">// 获取结果</span></span>
<span class="line">                <span class="token class-name">SearchHits</span> hits <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>hits<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token comment">// hit对象转为skuinfo</span></span>
<span class="line">                        <span class="token class-name">SkuInfo</span> skuInfo <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SkuInfo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">                        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> skuInfo<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                <span class="token comment">//构建返回对象</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AggregatedPageImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>list<span class="token punctuation">,</span>pageable<span class="token punctuation">,</span>hits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>searchResponse<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">// 封装最终返回结果</span></span>
<span class="line">        <span class="token comment">//总记录数</span></span>
<span class="line">        resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;total&quot;</span><span class="token punctuation">,</span> resultInfo<span class="token punctuation">.</span><span class="token function">getTotalElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//总页数</span></span>
<span class="line">        resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;totalPages&quot;</span><span class="token punctuation">,</span>resultInfo<span class="token punctuation">.</span><span class="token function">getTotalPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//数据集合</span></span>
<span class="line">        resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;rows&quot;</span><span class="token punctuation">,</span> resultInfo<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> resultMap<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61</p><h3 id="_2-3表现层定义" tabindex="-1"><a class="header-anchor" href="#_2-3表现层定义"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_2-3%E8%A1%A8%E7%8E%B0%E5%B1%82%E5%AE%9A%E4%B9%89" target="_blank" rel="noopener noreferrer">#</a>2.3表现层定义</span></a></h3><p>1 com.ydles.search.controller</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@RestController</span></span>
<span class="line"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/search&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SearchController</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">SearchService</span> searchService<span class="token punctuation">;</span></span>
<span class="line">    <span class="token annotation punctuation">@GetMapping</span></span>
<span class="line"><span class="token keyword">public</span>  <span class="token class-name">Map</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> searchMap<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//特殊符号处理</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleSearchMap</span><span class="token punctuation">(</span>searchMap<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token class-name">Map</span> searchResult <span class="token operator">=</span> searchService<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchMap<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> searchResult<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleSearchMap</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> searchMap<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> entries <span class="token operator">=</span> searchMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> entries<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;spec_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            searchMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;+&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;%2B&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23</p><h3 id="_2-4测试" tabindex="-1"><a class="header-anchor" href="#_2-4测试"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_2-4%E6%B5%8B%E8%AF%95" target="_blank" rel="noopener noreferrer">#</a>2.4测试</span></a></h3><p>postman测试 http://localhost:9009/search?keywords=包包</p><p>结果：默认分页 每页10条</p><h2 id="_3各种查询" tabindex="-1"><a class="header-anchor" href="#_3各种查询"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3%E5%90%84%E7%A7%8D%E6%9F%A5%E8%AF%A2" target="_blank" rel="noopener noreferrer">#</a>3各种查询</span></a></h2><h3 id="_3-1条件查询需求" tabindex="-1"><a class="header-anchor" href="#_3-1条件查询需求"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-1%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2%E9%9C%80%E6%B1%82" target="_blank" rel="noopener noreferrer">#</a>3.1条件查询需求</span></a></h3><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211102225212890.8aa7e7c2.png" alt="image-20211102225212890"></p><h3 id="_3-2品牌过滤查询" tabindex="-1"><a class="header-anchor" href="#_3-2品牌过滤查询"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-2%E5%93%81%E7%89%8C%E8%BF%87%E6%BB%A4%E6%9F%A5%E8%AF%A2" target="_blank" rel="noopener noreferrer">#</a>3.2品牌过滤查询</span></a></h3><p>需求：search.ydles.com/search?keywords=PRADA包包&amp;brand=prada</p><p>1完善 SearchServiceImpl</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">//按照品牌查询       </span></span>
<span class="line"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>searchMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;brand&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>         </span>
<span class="line">	boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;brandName&quot;</span><span class="token punctuation">,</span> searchMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;brand&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p>测试 http://localhost:9009/search?keywords=包包&amp;brand=PRADA</p><p>http://localhost:9009/search?keywords=%E5%8C%85%E5%8C%852019%E7%A7%8B%E5%AD%A3%E9%99%90%E9%87%8F%E7%89%88&amp;brand=PRADA</p><h3 id="_3-3品牌聚合查询" tabindex="-1"><a class="header-anchor" href="#_3-3品牌聚合查询"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-3%E5%93%81%E7%89%8C%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2" target="_blank" rel="noopener noreferrer">#</a>3.3品牌聚合查询</span></a></h3><p>需求：查看静态页面，品牌的显示要根据搜索结果不同展现。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211102230717607.e564f23c.png" alt="image-20211102230717607"></p><p>1完善 SearchServiceImpl</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">//按照品牌聚合</span></span>
<span class="line"><span class="token class-name">String</span> skuBrand<span class="token operator">=</span><span class="token string">&quot;skuBrand&quot;</span><span class="token punctuation">;</span>        nativeSearchQueryBuilder<span class="token punctuation">.</span><span class="token function">addAggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span>skuBrand<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;brandName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">//封装品牌分组结果</span></span>
<span class="line"><span class="token class-name">StringTerms</span> brandTerms <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StringTerms</span><span class="token punctuation">)</span> resultInfo<span class="token punctuation">.</span><span class="token function">getAggregation</span><span class="token punctuation">(</span>skuBrand<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> brandList <span class="token operator">=</span> brandTerms<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>bucket <span class="token operator">-&gt;</span> bucket<span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;brandList&quot;</span><span class="token punctuation">,</span> brandList<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6</p><p>测试： http://localhost:9009/search?keywords=包包</p><p><img src="data:image/png;base64,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" alt="image-20211102234740360"></p><h3 id="_3-4按照规格过滤" tabindex="-1"><a class="header-anchor" href="#_3-4按照规格过滤"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-4%E6%8C%89%E7%85%A7%E8%A7%84%E6%A0%BC%E8%BF%87%E6%BB%A4" target="_blank" rel="noopener noreferrer">#</a>3.4按照规格过滤</span></a></h3><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211102173855296.19ad5acf.png" alt="image-20211102173855296"></p><p>需求：</p><p>（1）前端发来规格查询：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line"> http://localhost:9009/search?keywords=包包&amp;spec_颜色=黑色&amp;spec_二手程度=崭新出厂</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>（2）后台接到数据后，可以根据前缀spec_来区分是否是规格，如果以 spec_xxx 开始的数据 则为规格数据，需要根据指定规格找信息。</p><p>（3）</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211102174007624.5f3f6f27.png" alt="image-20211102174007624"></p><p>上图是规格的索引存储格式，真实数据在 &quot;specMap.二手程度.keyword&quot; 中，所以找数据 也是按照如下格式去找。</p><p>1完善 SearchServiceImpl</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">//按照规格过滤查询</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> searchMap<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;spec_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token class-name">String</span> value <span class="token operator">=</span> searchMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;%2B&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;specMap.&quot;</span><span class="token operator">+</span>key<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;.keyword&quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6</p><p>测试： http://localhost:9009/search?keywords=包包&amp;spec_颜色=黑色</p><h3 id="_3-5按照规格聚合" tabindex="-1"><a class="header-anchor" href="#_3-5按照规格聚合"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-5%E6%8C%89%E7%85%A7%E8%A7%84%E6%A0%BC%E8%81%9A%E5%90%88" target="_blank" rel="noopener noreferrer">#</a>3.5按照规格聚合</span></a></h3><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211102234249164.fed24d4b.png" alt="image-20211102234249164"></p><p>1完善 SearchServiceImpl</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">//按照规格聚合</span></span>
<span class="line"><span class="token class-name">String</span> skuSpec<span class="token operator">=</span><span class="token string">&quot;skuSpec&quot;</span><span class="token punctuation">;</span>        nativeSearchQueryBuilder<span class="token punctuation">.</span><span class="token function">addAggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span>skuSpec<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;spec.keyword&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">//封装规格分组结果</span></span>
<span class="line"><span class="token class-name">StringTerms</span> specTerms <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StringTerms</span><span class="token punctuation">)</span> resultInfo<span class="token punctuation">.</span><span class="token function">getAggregation</span><span class="token punctuation">(</span>skuSpec<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> specList <span class="token operator">=</span> specTerms<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>bucket <span class="token operator">-&gt;</span> bucket<span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;specList&quot;</span><span class="token punctuation">,</span> specList<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6</p><p>测试： http://localhost:9009/search?keywords=包包</p><p><img src="data:image/png;base64,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" alt="image-20211102234642879"></p><p>text 类型 不能进行聚合和排序</p><p>keyword 类型 能进行聚合和排序</p><h3 id="_3-6价格区间查询" tabindex="-1"><a class="header-anchor" href="#_3-6价格区间查询"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-6%E4%BB%B7%E6%A0%BC%E5%8C%BA%E9%97%B4%E6%9F%A5%E8%AF%A2" target="_blank" rel="noopener noreferrer">#</a>3.6价格区间查询</span></a></h3><p><img src="data:image/png;base64,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" alt="image-20191216030113126"></p><p>price=0-5000 price=30000</p><p>需求：价格区间查询，每次需要将价格传入到后台，前端传入后台的价格大概是 price=0‐500 或者 price=500‐1000 依次类推，最后一个是 price=3000 ,后台可以根据-分割，如果分割 得到的结果最多有2个，第1个表示 x&lt;price ，第2个表示 price&lt;=y。</p><p>1完善 SearchServiceImpl</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">			<span class="token comment">//价格区间查询  price=0-5000     price=30000</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>searchMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token class-name">String</span> price <span class="token operator">=</span> searchMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> split <span class="token operator">=</span> price<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">                <span class="token comment">//代码优化 codeReview</span></span>
<span class="line">                <span class="token class-name">RangeQueryBuilder</span> rangeQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">rangeQuery</span><span class="token punctuation">(</span><span class="token string">&quot;price&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span>split<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">if</span><span class="token punctuation">(</span>split<span class="token punctuation">.</span>length<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token comment">//price=0-5000</span></span>
<span class="line">                    rangeQueryBuilder<span class="token punctuation">.</span><span class="token function">lte</span><span class="token punctuation">(</span>split<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token comment">//else {</span></span>
<span class="line">                    <span class="token comment">//price=30000</span></span>
<span class="line">                <span class="token comment">//}</span></span>
<span class="line">                boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>rangeQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15</p><p>测试： http://localhost:9009/search?keywords=包包&amp;price=0-500</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211103001912295.d8c53705.png" alt="image-20211103001912295"></p><h3 id="_3-7分页" tabindex="-1"><a class="header-anchor" href="#_3-7分页"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-7%E5%88%86%E9%A1%B5" target="_blank" rel="noopener noreferrer">#</a>3.7分页</span></a></h3><p>需求：http://localhost:9009/search?keywords=包包&amp;pageNum=1&amp;pageSize=30</p><p>没有带分页参数，你得给我默认查询第一页，每页30条数据。</p><p>es:<img src="https://www.ydlclass.com/doc21xnv/assets/image-20211103002507920.47d5c2de.png" alt="image-20211103002507920"></p><p>1完善 SearchServiceImpl</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">        <span class="token comment">//分页查询</span></span>
<span class="line">        <span class="token class-name">String</span> pageNum <span class="token operator">=</span> searchMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;pageNum&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">String</span> pageSize <span class="token operator">=</span> searchMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;pageSize&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>pageNum<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            pageNum<span class="token operator">=</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            pageSize<span class="token operator">=</span><span class="token string">&quot;30&quot;</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        nativeSearchQueryBuilder<span class="token punctuation">.</span><span class="token function">withPageable</span><span class="token punctuation">(</span><span class="token class-name">PageRequest</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>pageNum<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">		<span class="token comment">// 当前页</span></span>
<span class="line">        resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;pageNum&quot;</span><span class="token punctuation">,</span> pageNum<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13</p><p>测试： http://localhost:9009/search?keywords=包包&amp;pageNum=5&amp;pageSize=20</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211103003227039.9be97aa8.png" alt="image-20211103003227039"></p><h3 id="_3-8排序" tabindex="-1"><a class="header-anchor" href="#_3-8排序"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-8%E6%8E%92%E5%BA%8F" target="_blank" rel="noopener noreferrer">#</a>3.8排序</span></a></h3><p><img src="data:image/png;base64,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" alt="image-20211103005340413"></p><ul><li><p>排序这里总共有根据价格排序、根据评价排序、根据新品排序、根据销量排序，排序要 想实现非常简单，只需要告知排序的域以及排序方式即可实现。</p></li><li><p>价格排序：只需要根据价格高低排序即可，降序价格高-&gt;低，升序价格低-&gt;高 评价排序：评价分为好评、中评、差评，可以在数据库中设计3个列，用来记录好评、中 评、差评的量，每次排序的时候，好评的比例来排序，当然还要有</p></li><li><p>条数限制，评价条数 需要超过N条。</p></li><li><p>新品排序：直接根据商品的发布时间或者更新时间排序。</p></li><li><p>销量排序：销量排序除了销售数量外，还应该要有时间段限制。</p><p>需求：http://localhost:9009/search?keywords=包包&amp;sortField=price&amp;sortRule=Desc</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211103004713364.32ade5b0.png" alt="image-20211103004713364"></p><p>1完善 SearchServiceImpl</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">      <span class="token comment">//排序</span></span>
<span class="line">      <span class="token comment">//1当前域2升序降序</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>searchMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;sortField&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>searchMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;sortRule&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;ASC&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>searchMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;sortRule&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">              <span class="token comment">//升序</span></span>
<span class="line">              nativeSearchQueryBuilder<span class="token punctuation">.</span><span class="token function">withSort</span><span class="token punctuation">(</span><span class="token class-name">SortBuilders</span><span class="token punctuation">.</span><span class="token function">fieldSort</span><span class="token punctuation">(</span>searchMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;sortField&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name">SortOrder</span><span class="token punctuation">.</span><span class="token constant">ASC</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">              <span class="token comment">//降序</span></span>
<span class="line">           nativeSearchQueryBuilder<span class="token punctuation">.</span><span class="token function">withSort</span><span class="token punctuation">(</span><span class="token class-name">SortBuilders</span><span class="token punctuation">.</span><span class="token function">fieldSort</span><span class="token punctuation">(</span>searchMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;sortField&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name">SortOrder</span><span class="token punctuation">.</span><span class="token constant">DESC</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">          <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11</p><p>测试： http://localhost:9009/search?keywords=包包&amp;pageSize=1000&amp;sortField=price&amp;sortRule=Desc</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211103005326846.4c55a377.png" alt="image-20211103005326846"></p></li></ul><h3 id="_3-9高亮介绍" tabindex="-1"><a class="header-anchor" href="#_3-9高亮介绍"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-9%E9%AB%98%E4%BA%AE%E4%BB%8B%E7%BB%8D" target="_blank" rel="noopener noreferrer">#</a>3.9高亮介绍</span></a></h3><p>需求：京东搜索电脑</p><p>什么是高亮：搜索结果文字样式不同于其他。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">&lt;font class=&quot;skcolor_ljg&quot;&gt;包包&lt;/font&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>实现步骤：</p><p>1.指定高亮字段：name字段。关键词前后加标签。</p><p>2.将高亮字段提取，替换高亮字段:name。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211103012436922.74aa5a87.png" alt="image-20211103012436922"></p><h3 id="_3-10高亮实现" tabindex="-1"><a class="header-anchor" href="#_3-10高亮实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-10%E9%AB%98%E4%BA%AE%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>3.10高亮实现</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">//1设置高亮域</span></span>
<span class="line"><span class="token class-name">HighlightBuilder<span class="token punctuation">.</span>Field</span> field <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HighlightBuilder<span class="token punctuation">.</span>Field</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">//前缀</span></span>
<span class="line">field<span class="token punctuation">.</span><span class="token function">preTags</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;span style=&#39;color:red&#39;&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">//后缀</span></span>
<span class="line">field<span class="token punctuation">.</span><span class="token function">postTags</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;/span&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      </span>
<span class="line">nativeSearchQueryBuilder<span class="token punctuation">.</span><span class="token function">withHighlightFields</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token comment">//2获取高亮字段</span></span>
<span class="line"><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">HighlightField</span><span class="token punctuation">&gt;</span></span> highlightFields <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getHighlightFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>highlightFields <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token operator">&amp;&amp;</span>highlightFields<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                       	    skuInfo<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>highlightFields<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13</p><p>测试： http://localhost:9009/search?keywords=包包</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211103013157887.3f9778e7.png" alt="image-20211103013157887"></p><p>总结 搜索后台开发工程师</p><p>1 estemplate.queryForPage(构建搜索条件，实体类，结果映射)</p><p>2各种查询</p><h2 id="第8章-thymeleaf" tabindex="-1"><a class="header-anchor" href="#第8章-thymeleaf"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#%E7%AC%AC8%E7%AB%A0-thymeleaf" target="_blank" rel="noopener noreferrer">#</a>第8章 Thymeleaf</span></a></h2><p><strong>角色</strong>： 前端 展现到前台。</p><h2 id="学习目标-1" tabindex="-1"><a class="header-anchor" href="#学习目标-1"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87-1" target="_blank" rel="noopener noreferrer">#</a>学习目标</span></a></h2><ul><li>Thymeleaf的介绍</li><li>Thymeleaf的入门</li><li>Thymeleaf的语法及标签</li><li>搜索页面渲染</li><li>商品详情页静态化功能实现</li></ul><h2 id="_1-thymeleaf介绍" tabindex="-1"><a class="header-anchor" href="#_1-thymeleaf介绍"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_1-thymeleaf%E4%BB%8B%E7%BB%8D" target="_blank" rel="noopener noreferrer">#</a>1.Thymeleaf介绍</span></a></h2><h3 id="_1动态页面" tabindex="-1"><a class="header-anchor" href="#_1动态页面"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_1%E5%8A%A8%E6%80%81%E9%A1%B5%E9%9D%A2" target="_blank" rel="noopener noreferrer">#</a>1动态页面：</span></a></h3><p>html+java</p><p>通过执行asp、php、jsp和.net等程序生成客户端网页代码的网页。通常可以通过网站后台管理系统对网站的内容进行更新管理。发布新闻，发布公司产品，交流互动，博客，网上调查等，这都是动态网站的一些功能。也是我们常见的。 常见的扩展名有：.asp、php、jsp、cgi和aspx 等。 注意：动态页面的“动态”是网站与客户端用户互动的意思，而非网页上有动画的就是动态页面。</p><p>A．交互性好。</p><p>B．动态网页的信息都需要从数据库中读取，每打开一个一面就需要去获取一次数据库，如果访问人数很多，也就会对服务器增加很大的荷载，从而影响这个网站的运行速度。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211110150650096.1671585d.png" alt="image-20211110150650096"></p><h3 id="_2静态页面" tabindex="-1"><a class="header-anchor" href="#_2静态页面"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_2%E9%9D%99%E6%80%81%E9%A1%B5%E9%9D%A2" target="_blank" rel="noopener noreferrer">#</a>2静态页面：</span></a></h3><p>最早的时候，网站内容是通过在主机空间中放置大量的静态网页实现的。为了方便对这些分散在不同目录的静态网页的管理，（一般是通过FTP)，象frontpage/dreamweaver这样软件甚至直接提供了向主页空间以FTP方式直接访问文件的功能。以静态网页为主的网站最大的困难在于对网页的管理，在这种框架里，网页框架和网页中的内容混杂在一起，很大程度地加大了内容管理的难度。为了减轻这种管理的成本，发展出了一系列的技术，甚至连css本身，原本也是针对这种乱七八糟的网页维护而设计的，目的就是把网页表达的框架和内容本身抽象分离出来。</p><p>A．静态网页的内容稳定，页面加载速度快。</p><p>B．静态网页的没有数据库支持，在网站制作和维护方面的工作量较大。</p><p>C．静态网页的交互性差，有很大的局限性。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211110150711346.5dae188e.png" alt="image-20211110150711346"></p><h3 id="_3为什么需要动态页面静态化" tabindex="-1"><a class="header-anchor" href="#_3为什么需要动态页面静态化"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%8A%A8%E6%80%81%E9%A1%B5%E9%9D%A2%E9%9D%99%E6%80%81%E5%8C%96" target="_blank" rel="noopener noreferrer">#</a>3为什么需要动态页面静态化：</span></a></h3><ol><li>搜索引擎的优化</li></ol><p>尽管搜索机器人有点讨厌，各个网站不但不会再象从前一样把它封起来，反而热情无比地搞<strong>SEO</strong>，所谓的面向搜索引擎的优化，其中就包括访问地址的改写，令动态网页看上去是静态网页，以便更多更大量地被搜索引擎收录，从而最大限度地提高自已的内容被目标接收的机会。但是，在完全以动态技术开发的网站，转眼中要求变换成静态网页提供，同时，无论如何，动态网页的内容管理功能也是必须保留的；就如同一辆飞驶的奔驰忽然要求180度转弯，要付出的成本代价是非常大的，是否真的值得，也确实让人怀疑。</p><ol><li>提高程序性能 10w/s</li></ol><p>很多大型网站，进去的时候看它很复杂的页面，但是加载也没有耗费多长时间，除了其它必要原因以外，静态化也是其中必需考虑的技术之一。</p><p>先于用户获取资源或数据库数据进而通过静态化处理，生成静态页面，所有人都访问这一个静态页面，而静态化处理的页面本身的访问速度要较动态页面快很多倍，因此程序性能会有大大的提升。</p><p>静态化在页面上的体现为：访问速度加快，用户体验性明显提升；在后台体现为：访问脱离数据库，减轻了数据库访问压力。</p><p><strong>模板+数据=文本</strong></p><p>thymeleaf是一个XML/XHTML/HTML5模板引擎，可用于Web与非Web环境中的应用开发。它是一个开源的Java库，基于Apache License 2.0许可，由Daniel Fernández创建，该作者还是Java加密库Jasypt的作者。</p><p>Thymeleaf提供了一个用于整合Spring MVC的可选模块，在应用开发中，你可以使用Thymeleaf来完全代替JSP或其他模板引擎，如Velocity、FreeMarker等。Thymeleaf的主要目标在于提供一种可被浏览器正确显示的、格式良好的模板创建方式，因此也可以用作静态建模。你可以使用它创建经过验证的XML与HTML模板。相对于编写逻辑或代码，开发者只需将标签属性添加到模板中即可。接下来，这些标签属性就会在DOM（文档对象模型）上执行预先制定好的逻辑。</p><p>它的特点便是：开箱即用，Thymeleaf允许您处理六种模板，每种模板称为模板模式：</p><ul><li>XML</li><li>有效的XML</li><li>XHTML</li><li>有效的XHTML</li><li>HTML5</li><li>旧版HTML5</li></ul><p>所有这些模式都指的是格式良好的XML文件，但<em>Legacy HTML5</em>模式除外，它允许您处理HTML5文件，其中包含独立（非关闭）标记，没有值的标记属性或不在引号之间写入的标记属性。为了在这种特定模式下处理文件，Thymeleaf将首先执行转换，将您的文件转换为格式良好的XML文件，这些文件仍然是完全有效的HTML5（实际上是创建HTML5代码的推荐方法）<a href="https://www.thymeleaf.org/doc/tutorials/2.1/usingthymeleaf.html#fn1" target="_blank" rel="noopener noreferrer">1open in new window</a>。</p><p>另请注意，验证仅适用于XML和XHTML模板。</p><p>然而，这些并不是Thymeleaf可以处理的唯一模板类型，并且用户始终能够通过指定在此模式下<em>解析</em>模板的方法和<em>编写</em>结果的方式来定义他/她自己的模式。这样，任何可以建模为DOM树（无论是否为XML）的东西都可以被Thymeleaf有效地作为模板处理。</p><h3 id="_4thymeleaf介绍" tabindex="-1"><a class="header-anchor" href="#_4thymeleaf介绍"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_4thymeleaf%E4%BB%8B%E7%BB%8D" target="_blank" rel="noopener noreferrer">#</a>4Thymeleaf介绍</span></a></h3><p>1概念：XML/XHTML/HTML5模板引擎。</p><p>2其他模板引擎：Velocity、FreeMarker、jsp</p><p>3为什么使用它：<strong>springboot内置支持</strong></p><p>4特点：开箱即用，Thymeleaf允许您处理六种模板，每种模板称为模板模式：</p><ul><li>XML</li><li>有效的XML</li><li>XHTML</li><li>有效的XHTML</li><li>HTML5</li><li>旧版HTML5</li></ul><h2 id="_2-springboot整合thymeleaf" tabindex="-1"><a class="header-anchor" href="#_2-springboot整合thymeleaf"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_2-springboot%E6%95%B4%E5%90%88thymeleaf" target="_blank" rel="noopener noreferrer">#</a>2.Springboot整合thymeleaf</span></a></h2><p>使用springboot 来集成使用Thymeleaf可以大大减少单纯使用thymleaf的代码量，所以我们接下来使用springboot集成使用thymeleaf.</p><p>实现的步骤为：</p><ul><li>创建一个sprinboot项目</li><li>添加thymeleaf的起步依赖</li><li>添加spring web的起步依赖</li><li>编写html 使用thymleaf的语法获取变量对应后台传递的值</li><li>编写controller 设置变量的值到model中</li></ul><p>(1)创建工程</p><p>创建一个独立的工程springboot-thymeleaf,该工程为案例工程，不需要放到ydles工程中。</p><p><strong>pom.xml依赖</strong></p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">&quot;</span></span></span>
<span class="line">         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span></span>
<span class="line">         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>springboot-thymeleaf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.4.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token comment">&lt;!--web起步依赖--&gt;</span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">&lt;!--thymeleaf配置--&gt;</span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-thymeleaf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30</p><p>(2)创建包com.ydles.thymeleaf.并创建启动类ThymeleafApplication</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@SpringBootApplication</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThymeleafApplication</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ThymeleafApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><p>(3)创建application.yml</p><p>设置thymeleaf的缓存设置，设置为false。默认加缓存的，用于测试。</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">spring</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">thymeleaf</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">cache</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3</p><p>(4)控制层</p><p>创建controller用于测试后台 设置数据到model中。</p><p>创建com.ydles.controller.TestController，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Controller</span></span>
<span class="line"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestController</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/***</span>
<span class="line">     * 访问/test/hello  跳转到demo1页面</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">model</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/hello&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token class-name">Model</span> model<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;hello welcome&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">&quot;demo&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15</p><p>(2)创建html</p><p>在resources中创建templates目录，在templates目录创建 demo.html,代码如下：</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>th</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.thymeleaf.org<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Thymeleaf的入门<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Content-Type<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/html; charset=UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token comment">&lt;!--输出hello数据--&gt;</span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${hello}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11</p><p>解释：</p><p><code>html xmlns:th=&quot;http://www.thymeleaf.org&quot;</code>:这句声明使用thymeleaf标签</p><p>:这句使用 th:text=&quot;${变量名}&quot; 表示 使用thymeleaf获取文本数据，类似于EL表达式。</p><p>(5)测试</p><p>启动系统，并在浏览器访问</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">http://localhost:8080/test/hello</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211110152322446.87380524.png" alt="image-20211110152322446"></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211110152329656.fa56afc3.png" alt="image-20211110152329656"></p><h2 id="_3-thymeleaf基本语法" tabindex="-1"><a class="header-anchor" href="#_3-thymeleaf基本语法"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-thymeleaf%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95" target="_blank" rel="noopener noreferrer">#</a>3 Thymeleaf基本语法</span></a></h2><p>(1)th:action</p><p>定义后台控制器路径，类似<code>&lt;form&gt;</code>标签的action属性。</p><p>例如：</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name"><span class="token namespace">th:</span>action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{/demo/test}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name"><span class="token namespace">th:</span>type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>id<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span><span class="token punctuation">&gt;</span></span>提交<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p>action</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token class-name">Model</span> model<span class="token punctuation">,</span><span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>    </span>
<span class="line">	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3</p><p><img src="data:image/png;base64,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" alt="image-20211110154323405"></p><p>(2)th:each</p><p>对象遍历，功能类似jstl中的&lt;c:forEach&gt;标签。</p><p>创建com.ydles.model.User,代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token class-name">Integer</span> id<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token class-name">String</span> address<span class="token punctuation">;</span></span>
<span class="line">getter and settrt</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6</p><p>Controller添加数据</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> userList<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    userList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bj&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    userList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;tj&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    userList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;c&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;nj&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;userList&quot;</span><span class="token punctuation">,</span> userList<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p>demo.html</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>下标<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>编号<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>姓名<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>住址<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>user,userStat:${userList}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${userStat.index}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${user.id}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${user.name}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${user.address}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14</p><p>测试效果</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211110154936019.3bb571cd.png" alt="image-20211110154936019"></p><p>(3) map取值</p><p>1action</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> dataMap<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    dataMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;No&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;123&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    dataMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;address&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bj&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;dataMap&quot;</span><span class="token punctuation">,</span> dataMap<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p>2 demo.html</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>map,mapStat:${dataMap}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${map}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span>
<span class="line">    key:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${mapStat.current.key}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    value:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${mapStat.current.value}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    ====================================</span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><p>3测试 启动工程 访问 http://localhost:8080/demo/hello</p><p>测试效果</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211110155326665.ea11dc25.png" alt="image-20211110155326665"></p><p>(4)数组遍历</p><p>1action</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> names<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;李四&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;王五&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;names&quot;</span><span class="token punctuation">,</span>names <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><p>2demo.html</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>nm,nmStat:${names}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${nmStat.count}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${nm}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    ====================================</span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p>3测试 启动工程 访问 http://localhost:8080/demo/test</p><p>测试效果</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211110155931741.ad4693a0.png" alt="image-20211110155931741"></p><p>(5)Date输出</p><p>1action</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line">model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;now&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>2demo.html</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>    </span>
<span class="line">	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${#dates.format(now,&#39;yyyy-MM-dd hh:mm:ss&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3</p><p>测试效果</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211110160251113.3bf674b6.png" alt="image-20211110160251113"></p><p>(6)th:if条件</p><p>1action</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>2demo.html</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>    </span>
<span class="line">	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${(age&gt;=18)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>终于成年了<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3</p><p>测试效果</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211110160627425.cf97510c.png" alt="image-20211110160627425"></p><p>(7)th:fragment 模块声明与页面包含</p><p>1 新建footer.html</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>th</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.thymeleaf.org<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>fragment<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>C<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>fragment</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>copy<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    关于我们<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12</p><p>2 demo.html</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">&lt;div id=&quot;W&quot; th:include=&quot;footer::copy&quot;&gt;&lt;/div&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>效果如下：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211110161046356.cabd3df3.png" alt="image-20211110161046356"></p><h2 id="_4-搜索页面渲染" tabindex="-1"><a class="header-anchor" href="#_4-搜索页面渲染"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_4-%E6%90%9C%E7%B4%A2%E9%A1%B5%E9%9D%A2%E6%B8%B2%E6%9F%93" target="_blank" rel="noopener noreferrer">#</a>4 搜索页面渲染</span></a></h2><h3 id="_4-1-搜索分析" tabindex="-1"><a class="header-anchor" href="#_4-1-搜索分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_4-1-%E6%90%9C%E7%B4%A2%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>4.1 搜索分析</span></a></h3><p>打开chapter01 框架搭建/资源/静态原型/前台/search.html</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211110175725130.6de32311.png" alt="image-20211110175725130"></p><p>搜索页面要显示的内容主要分为3块。</p><p>1)搜索的数据结果</p><p>2)筛选出的数据搜索条件</p><p>3)用户已经勾选的数据条件</p><h3 id="_4-2-搜索实现" tabindex="-1"><a class="header-anchor" href="#_4-2-搜索实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_4-2-%E6%90%9C%E7%B4%A2%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>4.2 搜索实现</span></a></h3><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211110181009088.077eb7a4.png" alt="image-20211110181009088"></p><p>搜索的业务流程如上图，用户每次搜索的时候，先经过搜索业务工程，搜索业务工程调用搜索微服务工程。</p><h4 id="_4-2-1-搜索工程搭建" tabindex="-1"><a class="header-anchor" href="#_4-2-1-搜索工程搭建"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_4-2-1-%E6%90%9C%E7%B4%A2%E5%B7%A5%E7%A8%8B%E6%90%AD%E5%BB%BA" target="_blank" rel="noopener noreferrer">#</a>4.2.1 搜索工程搭建</span></a></h4><p>(1)search搜索服务 添加依赖</p><p>在ydles-service_search工程中的pom.xml中引入如下依赖</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-thymeleaf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p>(2)静态资源导入</p><p>将资源中的<code>页面资源/所有内容</code>拷贝到工程的<code>resources</code>目录下如下图：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211110182123624.59d6bcba.png" alt="image-20211110182123624"></p><p>(3) 更改配置文件,在spring下添加内容</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">spring.thymeleaf.cache</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><h4 id="_4-2-1-基础数据渲染" tabindex="-1"><a class="header-anchor" href="#_4-2-1-基础数据渲染"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_4-2-1-%E5%9F%BA%E7%A1%80%E6%95%B0%E6%8D%AE%E6%B8%B2%E6%9F%93" target="_blank" rel="noopener noreferrer">#</a>4.2.1 基础数据渲染</span></a></h4><p>需求：以前前端json，前端渲染。现在跳转到项目页面，服务器端页面渲染出来。</p><p>(1)com.ydles.search.controller添加方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/list&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> searchMap<span class="token punctuation">,</span><span class="token class-name">Model</span> model<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//特殊符号处理</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleSearchMap</span><span class="token punctuation">(</span>searchMap<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//获取查询结果</span></span>
<span class="line">    <span class="token class-name">Map</span> resultMap <span class="token operator">=</span> searchService<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchMap<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;result&quot;</span><span class="token punctuation">,</span>resultMap<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;searchMap&quot;</span><span class="token punctuation">,</span>searchMap<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> <span class="token string">&quot;search&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12</p><p>类注解改为Controller,search方法添加ResponseBody</p><p>浏览器访问 http://localhost:9009/search/list?keywords=包包</p><p>(2) 搜索结果页面渲染</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211110210015785.5f310d14.png" alt="image-20211110210015785"></p><p>(2.1)用户选择条件回显</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">2 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>th</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.thymeleaf.org<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">481	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>active<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">     	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${searchMap.keywords}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">484                 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>with-x<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${#maps.containsKey(searchMap,&#39;brand&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                        品牌:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${searchMap.brand}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{${#strings.replace(url,&#39;&amp;brand=&#39;+searchMap.brand,&#39;&#39;)}}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>×<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>with-x<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${#maps.containsKey(searchMap,&#39;price&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                        价格:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${searchMap.price}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{${#strings.replace(url,&#39;&amp;price=&#39;+searchMap.price,&#39;&#39;)}}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>×<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                    <span class="token comment">&lt;!--规格--&gt;</span></span>
<span class="line">					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>with-x<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sm,mapStat:${searchMap}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${#strings.startsWith(sm.key,&#39;spec_&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${#strings.replace(sm.key,&#39;spec_&#39;,&#39;&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span> : <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${#strings.replace(sm.value,&#39;%2B&#39;,&#39;+&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{${#strings.replace(url,&#39;&amp;&#39;+sm.key+&#39;=&#39;+sm.value,&#39;&#39;)}}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>×<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13</p><p>3测试 访问 http://localhost:9009/search/list?keywords=包包&amp;brand=viney&amp;spec_颜色=黑色</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211110213102694.b8fe9aa9.png" alt="image-20211110213102694"></p><p>(2.2)品牌信息显示</p><p>1需求：实现下图功能</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211111105051917.247b84eb.png" alt="image-20211111105051917"></p><p>2修改search.html页面</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">512         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>type-wrap logo<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>unless</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${#maps.containsKey(searchMap,&#39;brand&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fl key brand<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>品牌<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>value logos<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>logo-list<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>brand,brandSate:${result.brandList}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${brand}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{${url}(brand=${brand})}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ext<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>javascript:void(0);<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sui-btn<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>多选<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>javascript:void(0);<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>更多<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14</p><p>3 测试 访问 http://localhost:9009/search/list?keywords=包包</p><p>访问 http://localhost:9009/search/list?keywords=包包</p><p>(2.3)规格信息数据转换</p><p>1需求访问规格接口 http://localhost:9009/search?keywords=包包&amp;spec_颜色=黑色</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211111105359517.cf1e901b.png" alt="image-20211111105359517"></p><p>==》颜色：蓝色，黑色，金色，粉色</p><p>版本：6GB+128GB,4GB+64GB</p><p>规格数据不好在前端展示。所以要转成map。</p><p>颜色：</p><p>2 SearchServiceImpl 增加方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">formartSpec</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> specList<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//1定义返回map</span></span>
<span class="line">        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> resultMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//2遍历specList</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>specList <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> specList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> specJsonString <span class="token operator">:</span> specList<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// 将json转为map</span></span>
<span class="line">                <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> specMap <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>specJsonString<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">//遍历每个商品的规格名字</span></span>
<span class="line">                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> specKey <span class="token operator">:</span> specMap<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token comment">//看返回map中有此规格没有</span></span>
<span class="line">                    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> specSet <span class="token operator">=</span> resultMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>specKey<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">if</span> <span class="token punctuation">(</span>specSet <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                        specSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                    <span class="token comment">//将此条数据中的规格放入set</span></span>
<span class="line">                    specSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>specMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>specKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token comment">//将set放入返回map</span></span>
<span class="line">                    resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>specKey<span class="token punctuation">,</span> specSet<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> resultMap<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24</p><p>3在封装规格信息时，调用</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;specList&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">formartSpec</span><span class="token punctuation">(</span>specList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211111110616418.9c07c00c.png" alt="image-20211111110616418"></p><p>(2.4)规格与价格显示</p><p>1修改search.html页面 规格</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">526</span>
<span class="line">                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>type-wrap<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>spec,specStat:${result.specList}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>unless</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${#maps.containsKey(searchMap,&#39;spec_&#39;+spec.key)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fl key<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${spec.key}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span>
<span class="line">                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fl value<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>type-list<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>op,opstat:${spec.value}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${op}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{${url}(&#39;spec_&#39;+${spec.key}=${op})}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fl ext<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14</p><p><img src="data:image/png;base64,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" alt="image-20211111112533466"></p><p>2修改search.html页面 价格</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">539</span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>type-wrap<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>unless</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${#maps.containsKey(searchMap,&#39;price&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fl key<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>价格<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fl value<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">						<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>type-list<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">							<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">								<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0-500元<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{${url}(price=&#39;0-500&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">							<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">							<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">								<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>500-1000元<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{${url}(price=&#39;500-1000&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">							<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">							<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">								<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1000-1500元<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{${url}(price=&#39;1000-1500&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">							<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">							<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">								<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1500-2000元<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{${url}(price=&#39;1500-2000&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">							<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">							<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">								<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2000-3000元<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{${url}(price=&#39;2000-3000&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">							<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">							<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">								<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>3000元以上<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{${url}(price=&#39;3000&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">							<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">						<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fl ext<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28</p><p>3测试： http://localhost:9009/search/list?keywords=包包&amp;price=0-5000</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211111114359768.cb4347b6.png" alt="image-20211111114359768"></p><p>(2.5)数据列表展示</p><p>1需求：显示下列内容</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211111115149240.59006398.png" alt="image-20211111115149240"></p><p>2 修改search.html页面</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">603-832</span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>yui3-u-1-5<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sku,skuStat:${result.rows}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">							<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>list-wrap<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">								<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>p-img<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">									<span class="token comment">&lt;!--&lt;a th:href=&quot;&#39;http://192.168.200.128:8081/&#39;+${sku.spuId}+&#39;.html&#39;&quot;  target=&quot;_blank&quot;&gt;&lt;img th:src=&quot;${sku.image}&quot; /&gt;&lt;/a&gt;--&gt;</span></span>
<span class="line">                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&#39;</span>http://192.168.200.128:8081/10000000616300.html&#39;<span class="token punctuation">&quot;</span></span>  <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>_blank<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name"><span class="token namespace">th:</span>src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${sku.image}<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">								<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">								<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>price<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">									<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">											<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>em</span><span class="token punctuation">&gt;</span></span>¥<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>em</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">											<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${sku.price}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">										<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">								<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">								<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>attr<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">									<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>_blank<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&#39;</span>http://192.168.200.128:8081/10000000616300.html&#39;<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${sku.spec}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>utext</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${sku.name}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">								<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">								<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>commit<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">									<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>command<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>已有<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>2000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>人评价<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">								<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">								<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>operate<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">									<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>success-cart.html<span class="token punctuation">&quot;</span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>_blank<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sui-btn btn-bordered btn-danger<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>加入购物车<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">									<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>javascript:void(0);<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sui-btn btn-bordered<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>收藏<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">								<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">							<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">						<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25</p><p>3测试：http://localhost:9009/search/list?keywords=包包&amp;brand=PRADA</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211111115149240.59006398.png" alt="image-20211111115149240"></p><h3 id="_4-3-关键字搜索" tabindex="-1"><a class="header-anchor" href="#_4-3-关键字搜索"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_4-3-%E5%85%B3%E9%94%AE%E5%AD%97%E6%90%9C%E7%B4%A2" target="_blank" rel="noopener noreferrer">#</a>4.3 关键字搜索</span></a></h3><p>1需求：用户输入关键字，查询。回显。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211111120053433.4ed16595.png" alt="image-20211111120053433"></p><p>2 修改search.html页面</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">40</span>
<span class="line">							<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span>  <span class="token attr-name"><span class="token namespace">th:</span>action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{/search/list}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sui-form form-inline<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">								<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>input-append<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">									<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name"><span class="token namespace">th:</span>type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>autocomplete<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>keywords<span class="token punctuation">&quot;</span></span>  <span class="token attr-name"><span class="token namespace">th:</span>value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${searchMap.keywords}<span class="token punctuation">&quot;</span></span>  <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>input-error input-xxlarge<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span></span>
<span class="line">									<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sui-btn btn-xlarge btn-danger<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>搜索<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">								<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">							<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><p>3测试：http://localhost:9009/search/list?keywords=包包</p><p>修改输入框</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211111120053433.4ed16595.png" alt="image-20211111120052305"></p><h3 id="_4-4-条件搜索实现" tabindex="-1"><a class="header-anchor" href="#_4-4-条件搜索实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_4-4-%E6%9D%A1%E4%BB%B6%E6%90%9C%E7%B4%A2%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>4.4 条件搜索实现</span></a></h3><p>1需求：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211111120444998.cffabb34.png" alt="image-20211111120444998"></p><ul><li>用户搜索：拼接url /search/list?keywords=包包</li><li>点击新规格：拼接 &quot;url /search/list?keywords=包包&amp;spec__颜色=红色</li></ul><p>(1)后台记录搜索URL</p><p>com.ydles.search.controller SearchController list方法中新增</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token comment">//拼接url</span></span>
<span class="line">    <span class="token class-name">StringBuilder</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token string">&quot;/search/list&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 如果有搜索条件</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>searchMap <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> searchMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        url<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//拼接</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> paramKey <span class="token operator">:</span> searchMap<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//排除特殊情况</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">&quot;sortRule&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>paramKey<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token operator">!</span><span class="token string">&quot;sortField&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>paramKey<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token operator">!</span><span class="token string">&quot;pageNum&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>paramKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                url<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>paramKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;=&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>searchMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>paramKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&amp;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">String</span> urlString <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//除去最后的&amp;</span></span>
<span class="line">        urlString<span class="token operator">=</span>urlString<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>urlString<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;url&quot;</span><span class="token punctuation">,</span> urlString<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;url&quot;</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20</p><p>(2)前端url拼接跳转</p><p>1需求：</p><p>用户点击相应品牌、规格、价格，跳转请求后端接口。</p><p>2修改search.html页面</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">516 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${brand}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{${url}(brand=${brand})}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">530 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${op}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{${url}(&#39;spec_&#39;+${spec.key}=${op})}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">543 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0-500元<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{${url}(price=&#39;0-500&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span> </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>3测试：http://localhost:9009/search/list?keywords=包包</p><p>依次点击品牌、规格、价格信息</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211112150251770.2bc8181c.png" alt="image-20211112150251770"></p><h3 id="_4-5-移除搜索条件" tabindex="-1"><a class="header-anchor" href="#_4-5-移除搜索条件"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_4-5-%E7%A7%BB%E9%99%A4%E6%90%9C%E7%B4%A2%E6%9D%A1%E4%BB%B6" target="_blank" rel="noopener noreferrer">#</a>4.5 移除搜索条件</span></a></h3><p>1需求：</p><p>用户点击X去除刚才的搜索条件。</p><p>2修改search.html页面</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">574-486</span>
<span class="line">                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>with-x<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${#maps.containsKey(searchMap,&#39;brand&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                        品牌:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${searchMap.brand}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{${#strings.replace(url,&#39;&amp;brand=&#39;+searchMap.brand,&#39;&#39;)}}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>×<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>with-x<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${#maps.containsKey(searchMap,&#39;price&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                        价格:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${searchMap.price}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{${#strings.replace(url,&#39;&amp;price=&#39;+searchMap.price,&#39;&#39;)}}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>×<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                    <span class="token comment">&lt;!--规格--&gt;</span></span>
<span class="line">                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>with-x<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sm:${searchMap}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${#strings.startsWith(sm.key,&#39;spec_&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${#strings.replace(sm.key,&#39;spec_&#39;,&#39;&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span> : <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${#strings.replace(sm.value,&#39;%2B&#39;,&#39;+&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{${#strings.replace(url,&#39;&amp;&#39;+sm.key+&#39;=&#39;+sm.value,&#39;&#39;)}}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>×<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14</p><p>3测试：http://localhost:9009/search/list?keywords=包包</p><p>添加搜索条件，去除搜索条件。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211112152034015.f90d6d3b.png" alt="image-20211112152034015"></p><h3 id="_4-6-排序" tabindex="-1"><a class="header-anchor" href="#_4-6-排序"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_4-6-%E6%8E%92%E5%BA%8F" target="_blank" rel="noopener noreferrer">#</a>4.6 排序</span></a></h3><p>1需求：</p><p>用户点击排序字段，返回排序好的内容。</p><p>2修改search.html页面</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">593-595</span>
<span class="line">							<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">								<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{${url}(sortRule=&#39;ASC&#39;,sortField=&#39;price&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>价格↑<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">							<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{${url}(sortRule=&#39;DESC&#39;,sortField=&#39;price&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>价格↓<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><p>3测试：http://localhost:9009/search/list?keywords=包包</p><p>点击价格升序、降序查看结果</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211112160101659.4ea90f75.png" alt="image-20211112160101659"></p><h3 id="_4-7-分页" tabindex="-1"><a class="header-anchor" href="#_4-7-分页"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_4-7-%E5%88%86%E9%A1%B5" target="_blank" rel="noopener noreferrer">#</a>4.7 分页</span></a></h3><p>真实的分页应该像百度那样，如下图：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/1561834387880.2f2c18ef.png" alt="1561834387880"></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/1561834414207.54261ad5.png" alt="1561834414207"></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/1561834458274.d09b5e6c.png" alt="1561834458274"></p><p><strong>分页后端实现</strong></p><p>1需求：</p><p><img src="data:image/png;base64,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" alt="image-20191218094011798"></p><p>分页。</p><p>2将资料Page.java 放到common工程entity下</p><p>3com.ydles.search.controller SearchController list方法中新增</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token comment">// 封装分页数据，并返回</span></span>
<span class="line">    <span class="token comment">//总记录数</span></span>
<span class="line">    <span class="token comment">// 当前页</span></span>
<span class="line">    <span class="token comment">// 每页几条</span></span>
<span class="line">    <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuInfo</span><span class="token punctuation">&gt;</span></span> page <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span></span>
<span class="line">            <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>resultMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;total&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>resultMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;pageNum&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token class-name">Page</span><span class="token punctuation">.</span>pageSize</span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;page&quot;</span><span class="token punctuation">,</span> page<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10</p><p><strong>分页前端实现</strong></p><p>1修改search.html页面</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">644</span>
<span class="line">						<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">							<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>prev disabled<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">								<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{${url}(pageNum=${page.upper})}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>«上一页<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">							<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">							<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>i:${#numbers.sequence(page.lpage,page.rpage)}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${i}==${page.currentpage}?&#39;active&#39;:&#39;&#39;<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">								<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{${url}(pageNum=${i})}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${i}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">							<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">							<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>next<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">								<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{${url}(pageNum=${page.next})}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>下一页»<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">							<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">						<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">						<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>共<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${page.last}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span>页<span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>共<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${page.total}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span>个商品<span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16</p><p>2测试：http://localhost:9009/search/list?keywords=包包</p><p>分页 上一页下一页</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211113110229518.9601c6fa.png" alt="image-20211113110229518"></p><h2 id="_5-元动力二奢商品详情页" tabindex="-1"><a class="header-anchor" href="#_5-元动力二奢商品详情页"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_5-%E5%85%83%E5%8A%A8%E5%8A%9B%E4%BA%8C%E5%A5%A2%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E9%A1%B5" target="_blank" rel="noopener noreferrer">#</a>5.元动力二奢商品详情页</span></a></h2><h3 id="_5-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_5-1-需求分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_5-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>5.1 需求分析</span></a></h3><p>当系统审核完成商品，需要将商品详情页进行展示，那么采用静态页面生成的方式生成，并部署到高性能的web服务器中进行访问是比较合适的。所以，开发流程如下图所示：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211113111645270.0214e5fa.png" alt="image-20211113111645270"></p><p>此处MQ我们使用Rabbitmq即可。</p><p><strong>流程：</strong></p><p>1商品上架-&gt;商品服务发送spuid-&gt;mq</p><p>2mq-&gt;静态页服务</p><p>3静态页服务-&gt;调商品服务获取spu-&gt;生成静态页面</p><h3 id="_5-2-商品静态化微服务创建" tabindex="-1"><a class="header-anchor" href="#_5-2-商品静态化微服务创建"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_5-2-%E5%95%86%E5%93%81%E9%9D%99%E6%80%81%E5%8C%96%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%88%9B%E5%BB%BA" target="_blank" rel="noopener noreferrer">#</a>5.2 商品静态化微服务创建</span></a></h3><h4 id="_5-2-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_5-2-1-需求分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_5-2-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>5.2.1 需求分析</span></a></h4><p>该微服务只用于生成商品静态页，不做其他事情。</p><h4 id="_5-2-2-搭建项目" tabindex="-1"><a class="header-anchor" href="#_5-2-2-搭建项目"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_5-2-2-%E6%90%AD%E5%BB%BA%E9%A1%B9%E7%9B%AE" target="_blank" rel="noopener noreferrer">#</a>5.2.2 搭建项目</span></a></h4><p>1 创建 静态页服务ydles_service_page</p><p>2依赖</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">    <span class="token comment">&lt;!--公共模块--&gt;</span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ydles_common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token comment">&lt;!--thymeleaf--&gt;</span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-thymeleaf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token comment">&lt;!--mq--&gt;</span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token comment">&lt;!--goods feigh--&gt;</span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ydles_service_goods_api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>   </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22</p><p>3配置文件application.yml</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">server</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9011</span></span>
<span class="line"><span class="token key atrule">spring</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">application</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> page</span>
<span class="line">  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.200.128</span>
<span class="line">  <span class="token key atrule">main</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">allow-bean-definition-overriding</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment">#当遇到同样名字的时候，是否允许覆盖注册</span></span>
<span class="line"><span class="token key atrule">eureka</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">client</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">service-url</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>6868/eureka</span>
<span class="line">  <span class="token key atrule">instance</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line"><span class="token key atrule">feign</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">hystrix</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></span>
<span class="line">  <span class="token key atrule">client</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">config</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">default</span><span class="token punctuation">:</span>   <span class="token comment">#配置全局的feign的调用超时时间  如果 有指定的服务配置 默认的配置不会生效</span></span>
<span class="line">        <span class="token key atrule">connectTimeout</span><span class="token punctuation">:</span> <span class="token number">600000</span> <span class="token comment"># 指定的是 消费者 连接服务提供者的连接超时时间 是否能连接  单位是毫秒</span></span>
<span class="line">        <span class="token key atrule">readTimeout</span><span class="token punctuation">:</span> <span class="token number">600000</span>  <span class="token comment"># 指定的是调用服务提供者的 服务 的超时时间（）  单位是毫秒</span></span>
<span class="line"><span class="token comment">#hystrix 配置</span></span>
<span class="line"><span class="token key atrule">hystrix</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">command</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">default</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">execution</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">timeout</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token comment">#如果enabled设置为false，则请求超时交给ribbon控制</span></span>
<span class="line">          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">        <span class="token key atrule">isolation</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">strategy</span><span class="token punctuation">:</span> SEMAPHORE</span>
<span class="line"><span class="token comment">#生成静态页的位置</span></span>
<span class="line"><span class="token key atrule">pagepath</span><span class="token punctuation">:</span> D<span class="token punctuation">:</span>\items</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35</p><p>4启动类 com.ydles.page.PageApplication</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@SpringBootApplication</span></span>
<span class="line"><span class="token annotation punctuation">@EnableEurekaClient</span></span>
<span class="line"><span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;com.ydles.goods.feign&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PageApplication</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">PageApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8</p><h3 id="_5-3-生成静态页" tabindex="-1"><a class="header-anchor" href="#_5-3-生成静态页"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_5-3-%E7%94%9F%E6%88%90%E9%9D%99%E6%80%81%E9%A1%B5" target="_blank" rel="noopener noreferrer">#</a>5.3 生成静态页</span></a></h3><h4 id="_5-3-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_5-3-1-需求分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_5-3-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>5.3.1 需求分析</span></a></h4><p>页面发送请求，传递要生成的静态页的商品的SpuID.后台controller 接收请求，调用thyemleaf的原生API生成商品静态页。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211113112830233.ca263eba.png" alt="image-20211113112830233"></p><p>上图是要生成的商品详情页，从图片上可以看出需要查询SPU的3个分类作为<strong>面包屑</strong>显示，同时还需要查询SKU和SPU信息。</p><h4 id="_5-3-2-feign创建" tabindex="-1"><a class="header-anchor" href="#_5-3-2-feign创建"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_5-3-2-feign%E5%88%9B%E5%BB%BA" target="_blank" rel="noopener noreferrer">#</a>5.3.2 Feign创建</span></a></h4><p>需求：查出3部分数据 资源/静态原型/前台/item.html</p><ul><li>分类</li><li>spu</li><li>sku</li></ul><p>1goods-api中 com.ydles.goods.feign</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;goods&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CategoryFeign</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/category/{id}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Category</span><span class="token punctuation">&gt;</span></span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p>2goods服务 spuController添加</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/findSpuById/{id}&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Spu</span><span class="token punctuation">&gt;</span></span> <span class="token function">findSpuById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">Spu</span> spu <span class="token operator">=</span> spuService<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span><span class="token string">&quot;查询成功&quot;</span><span class="token punctuation">,</span>spu<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p>3com.ydles.goods.feign</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;goods&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SpuFeign</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/spu/findSpuById/{id}&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Spu</span><span class="token punctuation">&gt;</span></span> <span class="token function">findSpuById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><h4 id="_5-3-3-静态页生成代码-重点掌握" tabindex="-1"><a class="header-anchor" href="#_5-3-3-静态页生成代码-重点掌握"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_5-3-3-%E9%9D%99%E6%80%81%E9%A1%B5%E7%94%9F%E6%88%90%E4%BB%A3%E7%A0%81-%E9%87%8D%E7%82%B9%E6%8E%8C%E6%8F%A1" target="_blank" rel="noopener noreferrer">#</a>5.3.3 静态页生成代码-重点掌握</span></a></h4><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211113114836186.cd773aab.png" alt="image-20211113114836186"></p><p>thymleaf页面静态化 数据+模板=静态html</p><p>1将资料的item.html放到项目templates下。作为详情页模板。</p><p>2page模块 service层 com.ydles.page.service</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PageService</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token comment">//生成静态化页面</span></span>
<span class="line">	<span class="token keyword">void</span> <span class="token function">generateHtml</span><span class="token punctuation">(</span><span class="token class-name">String</span> spuId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p>3 实现类 com.ydles.page.service.impl</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>page<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">Result</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>goods<span class="token punctuation">.</span>feign<span class="token punctuation">.</span></span><span class="token class-name">CategoryFeign</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>goods<span class="token punctuation">.</span>feign<span class="token punctuation">.</span></span><span class="token class-name">SkuFeign</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>goods<span class="token punctuation">.</span>feign<span class="token punctuation">.</span></span><span class="token class-name">SpuFeign</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>goods<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Category</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>goods<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Sku</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>goods<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Spu</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>page<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">PageService</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>thymeleaf<span class="token punctuation">.</span></span><span class="token class-name">TemplateEngine</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>thymeleaf<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">Context</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileWriter</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Writer</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * @Created by IT李老师</span>
<span class="line"> * 公主号 “IT李哥交朋友”</span>
<span class="line"> * 个人微 itlils</span>
<span class="line"> *</span>
<span class="line"> * 缺啥补啥</span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@Service</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PageServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">PageService</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">TemplateEngine</span> templateEngine<span class="token punctuation">;</span></span>
<span class="line">    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${pagepath}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token class-name">String</span> pagepath<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//生成静态化页面的方法</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">generateHtml</span><span class="token punctuation">(</span><span class="token class-name">String</span> spuId<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//1 上下文 包含数据</span></span>
<span class="line">        <span class="token class-name">Context</span> context<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//context.setVariable(&quot;name&quot;,&quot;value&quot;);</span></span>
<span class="line">        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> dataMap <span class="token operator">=</span> <span class="token function">getData</span><span class="token punctuation">(</span>spuId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        context<span class="token punctuation">.</span><span class="token function">setVariables</span><span class="token punctuation">(</span>dataMap<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//2文件</span></span>
<span class="line">        <span class="token class-name">File</span> dir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>pagepath<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//文件夹   d:/item</span></span>
<span class="line">        <span class="token comment">//如果文件夹不存在 创建</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>dir<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            dir<span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//d:/item/spuid.html</span></span>
<span class="line">        <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>pagepath <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> spuId <span class="token operator">+</span> <span class="token string">&quot;.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">Writer</span> writer<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            writer<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">FileWriter</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            templateEngine<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token string">&quot;item&quot;</span><span class="token punctuation">,</span>context<span class="token punctuation">,</span> writer<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//关闭流</span></span>
<span class="line">            <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">                writer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">SpuFeign</span> spuFeign<span class="token punctuation">;</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">SkuFeign</span> skuFeign<span class="token punctuation">;</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">CategoryFeign</span> categoryFeign<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//获取数据方法</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token class-name">String</span> spuId<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> resultMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//1spu</span></span>
<span class="line">        <span class="token class-name">Spu</span> spu <span class="token operator">=</span> spuFeign<span class="token punctuation">.</span><span class="token function">findSpuById</span><span class="token punctuation">(</span>spuId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;spu&quot;</span><span class="token punctuation">,</span>spu<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//4imageList</span></span>
<span class="line">        <span class="token class-name">String</span> images <span class="token operator">=</span> spu<span class="token punctuation">.</span><span class="token function">getImages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>images<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> imageList <span class="token operator">=</span> images<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;imageList&quot;</span><span class="token punctuation">,</span>imageList<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token comment">//5 specificationList</span></span>
<span class="line">        <span class="token class-name">String</span> specItems <span class="token operator">=</span> spu<span class="token punctuation">.</span><span class="token function">getSpecItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>specItems<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">Map</span> specMap <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>specItems<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;specificationList&quot;</span><span class="token punctuation">,</span>specMap<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//2sku</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Sku</span><span class="token punctuation">&gt;</span></span> skuList <span class="token operator">=</span> skuFeign<span class="token punctuation">.</span><span class="token function">findSkuListBySpuId</span><span class="token punctuation">(</span>spuId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;skuList&quot;</span><span class="token punctuation">,</span>skuList<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//3category</span></span>
<span class="line">        <span class="token class-name">Category</span> category1 <span class="token operator">=</span> categoryFeign<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>spu<span class="token punctuation">.</span><span class="token function">getCategory1Id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Category</span> category2 <span class="token operator">=</span> categoryFeign<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>spu<span class="token punctuation">.</span><span class="token function">getCategory2Id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Category</span> category3 <span class="token operator">=</span> categoryFeign<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>spu<span class="token punctuation">.</span><span class="token function">getCategory3Id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;category1&quot;</span><span class="token punctuation">,</span>category1<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;category2&quot;</span><span class="token punctuation">,</span>category2<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;category3&quot;</span><span class="token punctuation">,</span>category3<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> resultMap<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119</p><p><strong>静态页服务监听</strong></p><p>1com.ydles.page.config 粘贴canal服务中的配置</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PAGE_CREATE_QUEUE</span><span class="token operator">=</span><span class="token string">&quot;page_create_queue&quot;</span><span class="token punctuation">;</span> </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token constant">PAGE_CREATE_QUEUE</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">PAGE_CREATE_QUEUE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token constant">PAGE_CREATE_QUEUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Bean</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">PAGE_CREATE_QUEUE_BINDING</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token constant">PAGE_CREATE_QUEUE</span><span class="token punctuation">)</span><span class="token class-name">Queue</span> queue<span class="token punctuation">,</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token constant">GOODS_UP_EXCHANGE</span><span class="token punctuation">)</span><span class="token class-name">Exchange</span> exchange<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">noargs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p>2 com.ydles.page.listener</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PageListener</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token annotation punctuation">@Autowired</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token class-name">PageService</span> pageService<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token class-name">RabbitMQConfig</span><span class="token punctuation">.</span><span class="token constant">PAGE_CREATE_QUEUE</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> spuId<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;获取静态化页面的商品id,id的值为:   &quot;</span><span class="token operator">+</span>spuId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//条用业务层完成静态化页面生成</span></span>
<span class="line">    pageService<span class="token punctuation">.</span><span class="token function">generateHtml</span><span class="token punctuation">(</span>spuId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13</p><h4 id="_5-3-4-模板填充" tabindex="-1"><a class="header-anchor" href="#_5-3-4-模板填充"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_5-3-4-%E6%A8%A1%E6%9D%BF%E5%A1%AB%E5%85%85" target="_blank" rel="noopener noreferrer">#</a>5.3.4 模板填充</span></a></h4><p>(1)面包屑数据</p><p>修改item.html，填充三个分类数据作为面包屑，代码如下：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/1561858073684.554e5b07.png" alt="1561858073684"></p><p>(2)商品图片</p><p>修改item.html，将商品图片信息输出，在真实工作中需要做空判断，代码如下：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/1561858651061.2dc86223.png" alt="1561858651061"></p><p>(3)规格输出</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/1561859448044.28eb1d8b.png" alt="1561859448044"></p><p>(4)默认SKU显示</p><p>静态页生成后，需要显示默认的Sku，我们这里默认显示第1个Sku即可，这里可以结合着Vue一起实现。可以先定义一个集合，再定义一个spec和sku，用来存储当前选中的Sku信息和Sku的规格，代码如下：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/1561858986838.cb26c6ad.png" alt="1561858986838"></p><p>页面显示默认的Sku信息</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/1561859241651.3e4a7985.png" alt="1561859241651"></p><p>(5)记录选中的Sku</p><p>在当前Spu的所有Sku中spec值是唯一的，我们可以根据spec来判断用户选中的是哪个Sku，我们可以在Vue中添加代码来实现，代码如下：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/1561860041421.f83748d0.png" alt="1561860041421"></p><p>添加规格点击事件</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/1561860156033.abe35835.png" alt="1561860156033"></p><p>(6)样式切换</p><p>点击不同规格后，实现样式选中，我们可以根据每个规格判断该规格是否在当前选中的Sku规格中，如果在，则返回true添加selected样式，否则返回false不添加selected样式。</p><p>Vue添加代码：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/1561860749790.3ab81f0e.png" alt="1561860749790"></p><p>页面添加样式绑定，代码如下：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/1561860653870.31c469bf.png" alt="1561860653870"></p><h4 id="_5-3-5-启动测试" tabindex="-1"><a class="header-anchor" href="#_5-3-5-启动测试"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_5-3-5-%E5%90%AF%E5%8A%A8%E6%B5%8B%E8%AF%95" target="_blank" rel="noopener noreferrer">#</a>5.3.5 启动测试</span></a></h4><p>1page 服务com.ydles.page.service.impl.PageServiceImpl类getItemData方法中新增</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// 5获取商品规格信息</span></span>
<span class="line">resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;specificationList&quot;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>spu<span class="token punctuation">.</span><span class="token function">getSpecItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><p>2测试启动所有服务 修改goods表中一条数据 status 0-&gt;1</p><p>3生成文件 D:/items/1450862568687009792.html</p><p>4打开有数据，没样式</p><p>5将静态原型中的css,js,image,data,fonts包拷贝至D盘，刷新页面。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211113161651617.3f111594.png" alt="image-20211113161651617"></p><h4 id="_5-3-6-基于nginx完成静态页访问" tabindex="-1"><a class="header-anchor" href="#_5-3-6-基于nginx完成静态页访问"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_5-3-6-%E5%9F%BA%E4%BA%8Enginx%E5%AE%8C%E6%88%90%E9%9D%99%E6%80%81%E9%A1%B5%E8%AE%BF%E9%97%AE" target="_blank" rel="noopener noreferrer">#</a>5.3.6 基于nginx完成静态页访问</span></a></h4><p>1将1450862568687009792.html页面放入ngixn下。</p><p>/usr/local/openresty/nginx/html/1450862568687009792.html</p><p>2重启ngixn</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">./ngixn -s -reload</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>3访问 http://192.168.200.128/1450862568687009792.html</p><p>4修改search服务中的search.html</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">608-609</span>
<span class="line"><span class="token comment">&lt;!--&lt;a th:href=&quot;&#39;http://192.168.200.128:8081/&#39;+${sku.spuId}+&#39;.html&#39;&quot;  target=&quot;_blank&quot;&gt;&lt;img th:src=&quot;${sku.image}&quot; /&gt;&lt;/a&gt;--&gt;</span></span>
<span class="line">                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&#39;</span>http://192.168.200.128/1450862568687009792.html&#39;<span class="token punctuation">&quot;</span></span>  <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>_blank<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name"><span class="token namespace">th:</span>src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${sku.image}<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">618 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>_blank<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&#39;</span>http://192.168.200.128/1450862568687009792.html&#39;<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${sku.spec}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>utext</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${sku.name}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>5 访问搜索页面http://localhost:9009/search/list?keywords=包包</p><p>点击图片或名称都可以跳转至详情页。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211113172956605.c6370d74.png" alt="image-20211113172956605"></p><p>6域名访问</p><p>C:\Windows\System32\drivers\etc\hosts</p><p>添加：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">192.168.200.128 item.ydles.com</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211113172901475.d71ed41f.png" alt="image-20211113172901475"></p><p>总结：</p><p>1thymeleaf</p><p>页面静态化</p><p>为什么页面静态化</p><p>入门工程，标签</p><p>2搜索页面静态化渲染</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211110181009088.077eb7a4.png" alt="image-20211110181009088"></p><p>3商品详情页</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211113111645270.0214e5fa.png" alt="image-20211113111645270"></p><h2 id="第9章-用户认证" tabindex="-1"><a class="header-anchor" href="#第9章-用户认证"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#%E7%AC%AC9%E7%AB%A0-%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81" target="_blank" rel="noopener noreferrer">#</a>第9章 用户认证</span></a></h2><p><strong>角色</strong>：鉴权组，后端开发工程师。架构师。 难。</p><h2 id="_1-用户认证分析" tabindex="-1"><a class="header-anchor" href="#_1-用户认证分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_1-%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>1 用户认证分析</span></a></h2><h3 id="_1用户认证与授权" tabindex="-1"><a class="header-anchor" href="#_1用户认证与授权"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_1%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E4%B8%8E%E6%8E%88%E6%9D%83" target="_blank" rel="noopener noreferrer">#</a>1用户认证与授权</span></a></h3><p>什么是用户身份认证？</p><p>用户身份认证即用户去访问系统资源时系统要求验证用户的身份信息，身份合法方可继续访问。常见的用户身份认证表现形式有：用户名密码登录，指纹打卡等方式。</p><p>什么是用户授权？</p><p>用户认证通过后去访问系统的资源，系统会判断用户是否拥有访问资源的权限，只允许访问有权限的系统资源，没有权限的资源将无法访问，这个过程叫用户授权。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">5张表</span>
<span class="line"></span>
<span class="line">tb_user     username  password</span>
<span class="line"></span>
<span class="line">tb_user_role  关联表  user_id role_id</span>
<span class="line"></span>
<span class="line">tb_role     rolename</span>
<span class="line"></span>
<span class="line">tb_role_auth</span>
<span class="line"></span>
<span class="line">tb_auth        auth(删除首页图片)</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11</p><h3 id="_2单点登录需求-sso" tabindex="-1"><a class="header-anchor" href="#_2单点登录需求-sso"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_2%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95%E9%9C%80%E6%B1%82-sso" target="_blank" rel="noopener noreferrer">#</a>2单点登录需求 SSO</span></a></h3><p>让用户在一个系统中登录，其他任意受信任的系统都可以访问，这个功能就叫单点登录。</p><h3 id="_3第三方账号登录" tabindex="-1"><a class="header-anchor" href="#_3第三方账号登录"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3%E7%AC%AC%E4%B8%89%E6%96%B9%E8%B4%A6%E5%8F%B7%E7%99%BB%E5%BD%95" target="_blank" rel="noopener noreferrer">#</a>3第三方账号登录</span></a></h3><p>当需要访问第三方系统的资源时需要首先通过第三方系统的认证（例如：微信认证），由第三方系统对用户认证通过，并授权资源的访问权限。</p><p><img src="data:image/png;base64,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" alt="image-20211122102755245"></p><p>好处：</p><p>1用户：防止信息泄露</p><p>2网站：自己就不用再做一套登陆系统。</p><h2 id="_2-认证解决方案" tabindex="-1"><a class="header-anchor" href="#_2-认证解决方案"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_2-%E8%AE%A4%E8%AF%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" target="_blank" rel="noopener noreferrer">#</a>2 认证解决方案</span></a></h2><h3 id="_2-1-单点登录技术方案" tabindex="-1"><a class="header-anchor" href="#_2-1-单点登录技术方案"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_2-1-%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88" target="_blank" rel="noopener noreferrer">#</a>2.1 单点登录技术方案</span></a></h3><p>分布式系统要实现单点登录，通常将认证系统独立抽取出来，并且将用户身份信息存储在单独的存储介质，比如：MySQL、Redis，考虑性能要求，通常存储在Redis中，如下图：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211122101800309.8d47fe28.png" alt="image-20211122101800309"></p><p>特点：</p><p>1、认证系统为独立的系统。</p><p>2、各子系统通过Http或其它协议与认证系统通信，完成用户认证。</p><p>3、用户身份信息存储在Redis集群。</p><p>Java中有很多用户认证的框架都可以实现单点登录：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line"> 1、Apache Shiro. </span>
<span class="line"> 2、CAS </span>
<span class="line"> 3、Spring security CAS  </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3</p><h3 id="_2-2-第三方登录技术方案-重点掌握-oauth2" tabindex="-1"><a class="header-anchor" href="#_2-2-第三方登录技术方案-重点掌握-oauth2"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_2-2-%E7%AC%AC%E4%B8%89%E6%96%B9%E7%99%BB%E5%BD%95%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88-%E9%87%8D%E7%82%B9%E6%8E%8C%E6%8F%A1-oauth2" target="_blank" rel="noopener noreferrer">#</a>2.2 第三方登录技术方案-重点掌握 Oauth2</span></a></h3><h4 id="_2-2-1-oauth2认证流程" tabindex="-1"><a class="header-anchor" href="#_2-2-1-oauth2认证流程"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_2-2-1-oauth2%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B" target="_blank" rel="noopener noreferrer">#</a>2.2.1 Oauth2认证流程</span></a></h4><p>怎么用：</p><p>为什么：第三方认证技术方案最主要是解决<strong>认证协议的通用标准</strong>问题，因为要实现跨系统认证，各系统之间要遵循一定的 接口协议。 OAUTH协议为用户资源的授权提供了一个安全的、开放而又简易的标准。同时，任何第三方都可以使用OAUTH认 证服务，任何服务提供商都可以实现自身的OAUTH认证服务，因而OAUTH是开放的。业界提供了OAUTH的多种实现如PHP、JavaScript，Java，Ruby等各种语言开发包，大大节约了程序员的时间，因而OAUTH是简易的。互联网很多服务如Open API，很多大公司如Google，Yahoo，Microsoft等都提供了OAUTH认证服务，这些都足以说明OAUTH标准逐渐成为开放资源授权的标准。 Oauth协议目前发展到2.0版本，1.0版本过于复杂，2.0版本已得到广泛应用。 参考：https://baike.baidu.com/item/oAuth/7153134?fr=aladdin Oauth协议：https://tools.ietf.org/html/rfc6749 下边分析一个Oauth2认证的例子，4399网站使用微信认证的过程：</p><p>是什么：</p><p><strong>流程图</strong>：!!!!!!!!重点记忆</p><p>4399——————》微信第三方登录</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211122104426755.a59ac96f.png" alt="image-20211122104426755"></p><p>1.客户端请求第三方授权</p><p>用户进入4399的登录页面，点击微信的图标以微信账号登录系统，用户是自己在微信里信息的资源拥有者。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211122104539494.b23e5c0f.png" alt="image-20211122104539494"></p><p>点击“用微信账号登录”出现一个二维码，此时用户扫描二维码，开始给4399授权。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211122104558149.a3cb3a0a.png" alt="image-20211122104558149"></p><p>2.资源拥有者同意给客户端授权</p><p>资源拥有者扫描二维码表示资源拥有者同意给客户端授权，微信会对资源拥有者的身份进行验证， 验证通过后，QQ会询问用户是否给授权4399访问自己的QQ数据，用户点击“确认登录”表示同意授权，QQ认证服务器会 颁发一个授权码，并重定向到4399的网站。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211122112657000.148fe696.png" alt="image-20211122112657000"></p><p>3.客户端获取到授权码，请求认证服务器申请令牌 此过程用户看不到，客户端应用程序请求认证服务器，请求携带授权码。</p><p>4.认证服务器向客户端响应令牌 认证服务器验证了客户端请求的授权码，如果合法则给客户端颁发令牌，令牌是客户端访问资源的通行证。 此交互过程用户看不到，当客户端拿到令牌后，用户在4399看到已经登录成功。</p><p>5.客户端请求资源服务器的资源 客户端携带令牌访问资源服务器的资源。 4399网站携带令牌请求访问微信服务器获取用户的基本信息。</p><p>6.资源服务器返回受保护资源 资源服务器校验令牌的合法性，如果合法则向用户响应资源信息内容。 注意：资源服务器和认证服务器可以是一个服务也可以分开的服务，如果是分开的服务资源服务器通常要请求认证 服务器来校验令牌的合法性。</p><p><img src="data:image/png;base64,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" alt="image-20211122104649845"></p><p>Oauth2.0认证流程如下： 引自Oauth2.0协议rfc6749 https://tools.ietf.org/html/rfc6749</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/1564717418054.8dc394bd.png" alt="1564717418054"></p><p>Oauth2包括以下角色：</p><p>1、客户端 本身不存储资源，需要通过资源拥有者的授权去请求资源服务器的资源，比如：元动力二奢Android客户端、元动力二奢Web客户端（浏览器端）、微信客户端等。</p><p>2、资源拥有者 通常为用户，也可以是应用程序，即该资源的拥有者。</p><p>3、授权服务器（也称认证服务器） 用来对资源拥有的身份进行认证、对访问资源进行授权。客户端要想访问资源需要通过认证服务器由资源拥有者授 权后方可访问。</p><p>4、资源服务器 存储资源的服务器，比如，元动力二奢用户管理服务器存储了元动力二奢的用户信息，微信的资源服务存储了微信的用户信息等。客户端最终访问资源服务器获取资源信息。</p><h4 id="_2-2-2-oauth2在项目的应用" tabindex="-1"><a class="header-anchor" href="#_2-2-2-oauth2在项目的应用"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_2-2-2-oauth2%E5%9C%A8%E9%A1%B9%E7%9B%AE%E7%9A%84%E5%BA%94%E7%94%A8" target="_blank" rel="noopener noreferrer">#</a>2.2.2 Oauth2在项目的应用</span></a></h4><p>Oauth2是一个标准的开放的授权协议，应用程序可以根据自己的要求去使用Oauth2，项目中使用Oauth2可以实现实现如下功能：</p><p>1、本系统访问第三方系统的资源</p><p>2、外部系统访问本系统的资源</p><p>3、本系统前端（客户端） 访问本系统后端微服务的资源。</p><p>4、本系统微服务之间访问资源，例如：微服务A访问微服务B的资源，B访问A的资源。</p><h3 id="_2-3-spring-security-oauth2认证解决方案-了解" tabindex="-1"><a class="header-anchor" href="#_2-3-spring-security-oauth2认证解决方案-了解"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_2-3-spring-security-oauth2%E8%AE%A4%E8%AF%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-%E4%BA%86%E8%A7%A3" target="_blank" rel="noopener noreferrer">#</a>2.3 Spring security Oauth2认证解决方案-了解</span></a></h3><p>本项目采用 Spring security + Oauth2+JWT完成用户认证及用户授权，Spring security 是一个强大的和高度可定制的身份验证和访问控制框架，Spring security 框架集成了Oauth2协议，下图是项目认证架构图：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/1564732556537.53154e41.png" alt="1564732556537"></p><p><strong>登录</strong>：</p><p>1、用户请求认证服务完成认证。</p><p>2、认证服务下发用户身份令牌，拥有身份令牌表示身份合法。</p><p><strong>访问</strong>：</p><p>1、用户携带令牌请求资源服务，请求资源服务必先经过网关。</p><p>2、网关校验用户身份令牌的合法，不合法表示用户没有登录，如果合法则放行继续访问。</p><p>3、资源服务获取令牌，根据令牌完成授权。</p><p>4、资源服务完成授权则响应资源信息。</p><h2 id="_3-jwt令牌回顾" tabindex="-1"><a class="header-anchor" href="#_3-jwt令牌回顾"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-jwt%E4%BB%A4%E7%89%8C%E5%9B%9E%E9%A1%BE" target="_blank" rel="noopener noreferrer">#</a>3 Jwt令牌回顾</span></a></h2><p>JSON Web Token（JWT）是一个开放的行业标准（RFC 7519），它定义了一种简介的、自包含的协议格式，用于 在通信双方传递json对象，传递的信息经过数字签名可以被验证和信任。JWT可以使用HMAC算法或使用RSA的公 钥/私钥对来签名，防止被篡改。</p><p>官网：https://jwt.io/</p><p>标准：https://tools.ietf.org/html/rfc7519</p><p><strong>优点</strong>：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">1、jwt基于json，非常方便解析。 </span>
<span class="line">2、可以在令牌中自定义丰富的内容，易扩展。 </span>
<span class="line">3、通过非对称加密算法及数字签名技术，JWT防止篡改，安全性高。 </span>
<span class="line">4、资源服务使用JWT可不依赖认证服务即可完成授权。</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p><strong>缺点</strong>：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">１、JWT令牌较长，占存储空间比较大。    </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><h3 id="_3-1-令牌结构" tabindex="-1"><a class="header-anchor" href="#_3-1-令牌结构"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-1-%E4%BB%A4%E7%89%8C%E7%BB%93%E6%9E%84" target="_blank" rel="noopener noreferrer">#</a>3.1 令牌结构</span></a></h3><p>通过学习JWT令牌结构为自定义jwt令牌打好基础。</p><p>JWT令牌由三部分组成，每部分中间使用点（.）分隔，比如：xxxxx.yyyyy.zzzzz</p><p><strong>Header</strong></p><p>头部包括令牌的类型（即JWT）及使用的哈希算法（如HMAC SHA256或RSA）</p><p>一个例子如下：</p><p>下边是Header部分的内容</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">{</span>
<span class="line">    &quot;alg&quot;: &quot;HS256&quot;,</span>
<span class="line">    &quot;typ&quot;: &quot;JWT&quot;</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p>将上边的内容使用Base64Url编码，得到一个字符串就是JWT令牌的第一部分。</p><p><strong>Payload</strong></p><p>第二部分是负载，内容也是一个json对象，它是存放有效信息的地方，它可以存放jwt提供的现成字段，比 如：iss（签发者）,exp（过期时间戳）, sub（面向的用户）等，也可自定义字段。</p><p>此部分不建议存放敏感信息，因为此部分可以解码还原原始内容。</p><p>最后将第二部分负载使用Base64Url编码，得到一个字符串就是JWT令牌的第二部分。</p><p>一个例子：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">{</span>
<span class="line">    &quot;sub&quot;: &quot;1234567890&quot;,</span>
<span class="line">    &quot;name&quot;: &quot;456&quot;,</span>
<span class="line">    &quot;admin&quot;: true</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p><strong>Signature</strong></p><p>第三部分是签名，此部分用于防止jwt内容被篡改。</p><p>这个部分使用base64url将前两部分进行编码，编码后使用点（.）连接组成字符串，最后使用header中声明 签名算法进行签名。</p><p>一个例子：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">HMACSHA256(</span>
<span class="line">    base64UrlEncode(header) + &quot;.&quot; +</span>
<span class="line">    base64UrlEncode(payload),</span>
<span class="line">    secret)</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p>base64UrlEncode(header)：jwt令牌的第一部分。</p><p>base64UrlEncode(payload)：jwt令牌的第二部分。</p><p>secret：签名所使用的密钥。</p><h3 id="_3-2-生成私钥公钥-运维" tabindex="-1"><a class="header-anchor" href="#_3-2-生成私钥公钥-运维"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-2-%E7%94%9F%E6%88%90%E7%A7%81%E9%92%A5%E5%85%AC%E9%92%A5-%E8%BF%90%E7%BB%B4" target="_blank" rel="noopener noreferrer">#</a>3.2 生成私钥公钥-运维</span></a></h3><p>JWT令牌生成采用非对称加密算法</p><p>1、生成密钥证书 下边命令生成密钥证书，采用RSA 算法每个证书包含公钥和私钥</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">keytool -genkeypair -alias ydlershe -keyalg RSA -keypass ydlershe -keystore ydlershe.jks -storepass ydlershe </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>Keytool 是一个java提供的证书管理工具</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">-alias：密钥的别名 </span>
<span class="line">-keyalg：使用的hash算法 </span>
<span class="line">-keypass：密钥的访问密码 </span>
<span class="line">-keystore：密钥库文件名，ydles.jks保存了生成的证书 </span>
<span class="line">-storepass：密钥库的访问密码 </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211122114330894.e27ee1bc.png" alt="image-20211122114330894"></p><p>查询证书信息：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">keytool -list -keystore ydlershe.jks</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211122114427622.e07b7930.png" alt="image-20211122114427622"></p><p>2、导出公钥</p><p>openssl是一个加解密工具包，这里使用openssl来导出公钥信息。</p><p>安装 openssl：http://slproweb.com/products/Win32OpenSSL.html</p><p>安装资料目录下的Win64OpenSSL-1_1_1b.exe</p><p>配置openssl的path环境变量，</p><p>cmd进入ydles.jks文件所在目录执行如下命令：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">keytool -list -rfc --keystore ydlershe.jks | openssl x509 -inform pem -pubkey</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211122115012067.511419e8.png" alt="image-20211122115012067"></p><p>下面段内容是公钥</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">-----BEGIN PUBLIC KEY-----MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA1e+vuZYMGIGQnTWCfHlkzOXKmEpe4Mj4rK2sl2ykt0aDq2SVrBtUawfCUzSfyuC73OBdja7IevLcivgs0Vy4cd+T2jjaB0aOr9EwnJUB94TFplwoqMdGHHYrF2JTD4QnjdQDHvR8ugGNw7lqRRhttX/L1GoSBmXl6WwQAurfcl5dUqHekVYmCpOjQPS+29LaTNsdSYWUjzg/grDUD/FjjQDCZkQ6sTt1DxAlbFra/Td41ewbEF6xfK0oRFbuZKFeznCVp08dfSO5fL9JbtCeCxnCJsYwLO1142sVe5PpA9e+qML7i/UX6wiFixwRfcvHtRgLa2n6q9Sw38fnLKxPuwIDAQAB-----END PUBLIC KEY-----</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>将上边的公钥拷贝到文本public.key文件中，合并为一行,可以将它放到需要实现授权认证的工程中。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211122115208169.e7d11acf.png" alt="image-20211122115208169"></p><h3 id="_3-3-基于私钥生成jwt令牌-了解" tabindex="-1"><a class="header-anchor" href="#_3-3-基于私钥生成jwt令牌-了解"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-3-%E5%9F%BA%E4%BA%8E%E7%A7%81%E9%92%A5%E7%94%9F%E6%88%90jwt%E4%BB%A4%E7%89%8C-%E4%BA%86%E8%A7%A3" target="_blank" rel="noopener noreferrer">#</a>3.3 基于私钥生成jwt令牌-了解</span></a></h3><h4 id="_3-3-1导入认证服务" tabindex="-1"><a class="header-anchor" href="#_3-3-1导入认证服务"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-3-1%E5%AF%BC%E5%85%A5%E8%AE%A4%E8%AF%81%E6%9C%8D%E5%8A%A1" target="_blank" rel="noopener noreferrer">#</a>3.3.1导入认证服务</span></a></h4><ol><li>将课件中<code>ydles_user_auth</code>的工程导入到项目中去，如下图：</li></ol><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211122184808706.adb2aea7.png" alt="image-20211122184808706"></p><ol><li>启动eureka，再启动认证服务</li></ol><h4 id="_3-3-2-认证服务中创建测试类" tabindex="-1"><a class="header-anchor" href="#_3-3-2-认证服务中创建测试类"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-3-2-%E8%AE%A4%E8%AF%81%E6%9C%8D%E5%8A%A1%E4%B8%AD%E5%88%9B%E5%BB%BA%E6%B5%8B%E8%AF%95%E7%B1%BB" target="_blank" rel="noopener noreferrer">#</a>3.3.2 认证服务中创建测试类</span></a></h4><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211123101348853.90a43925.png" alt="image-20211123101348853"></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CreateJWTTest</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token annotation punctuation">@Test</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createJWT</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 基于私钥生成jwt</span></span>
<span class="line">    <span class="token comment">// 1创建秘钥工厂</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 1.1秘钥位置</span></span>
<span class="line">    <span class="token class-name">ClassPathResource</span> classPathResource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">&quot;ydlershe.jks&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//1.2秘钥库密码</span></span>
<span class="line">    <span class="token class-name">String</span> keyPass <span class="token operator">=</span> <span class="token string">&quot;ydlershe&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 1秘钥位置</span>
<span class="line">     * 2秘钥库密码</span>
<span class="line">     */</span></span>
<span class="line">    <span class="token class-name">KeyStoreKeyFactory</span> keyStoreKeyFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KeyStoreKeyFactory</span><span class="token punctuation">(</span>classPathResource<span class="token punctuation">,</span> keyPass<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 2基于工厂拿到私钥</span></span>
<span class="line">    <span class="token class-name">String</span> alias<span class="token operator">=</span><span class="token string">&quot;ydlershe&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">String</span> password<span class="token operator">=</span><span class="token string">&quot;ydlershe&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">KeyPair</span> keyPair <span class="token operator">=</span> keyStoreKeyFactory<span class="token punctuation">.</span><span class="token function">getKeyPair</span><span class="token punctuation">(</span>alias<span class="token punctuation">,</span> password<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//转化为rsa私钥</span></span>
<span class="line">    <span class="token class-name">RSAPrivateKey</span> rsaPrivateKey <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RSAPrivateKey</span><span class="token punctuation">)</span>keyPair<span class="token punctuation">.</span><span class="token function">getPrivate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 3生成jwt</span></span>
<span class="line">    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;conpany&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;itlils&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;address&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;taiyuan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">Jwt</span> jwt <span class="token operator">=</span> <span class="token class-name">JwtHelper</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">RsaSigner</span><span class="token punctuation">(</span>rsaPrivateKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token class-name">String</span> jwtEncoded <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">getEncoded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;jwtEncoded:&quot;</span><span class="token operator">+</span>jwtEncoded<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">String</span> claims <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">getClaims</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;claims:&quot;</span><span class="token operator">+</span>claims<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37</p><p>运行 查看输出</p><p>访问 http://tool.chinaz.com/Tools/Base64.aspx 解析base64</p><h3 id="_3-4-基于公钥解析jwt令牌" tabindex="-1"><a class="header-anchor" href="#_3-4-基于公钥解析jwt令牌"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-4-%E5%9F%BA%E4%BA%8E%E5%85%AC%E9%92%A5%E8%A7%A3%E6%9E%90jwt%E4%BB%A4%E7%89%8C" target="_blank" rel="noopener noreferrer">#</a>3.4 基于公钥解析jwt令牌</span></a></h3><p>上面创建令牌后，我们可以对JWT令牌进行解析，这里解析需要用到公钥，我们可以将之前生成的公钥public.key拷贝出来用字符串变量token存储，然后通过公钥解密。</p><p>在ydles-user-oauth创建测试类com.ydles.token.ParseJwtTest实现解析校验令牌数据，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ParseJwtTest</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token annotation punctuation">@Test</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">parseJwt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//基于公钥去解析jwt</span></span>
<span class="line">    <span class="token class-name">String</span> jwt <span class="token operator">=</span><span class="token string">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhZGRyZXNzIjoiYmVpamluZyIsImNvbXBhbnkiOiJoZWltYSJ9.cjZNz8G0m4noNYN2VM1SH3ujAtbHElW5Vtbadb0NDI0cjM1DaAXzMA53Qbj4pmVQPl_IfSKqUEXbLxowdRa5NHR43laFsR0kzGbJiTINfSVSroSslYpDdEVwCeAF_a7I-R819YTj4p6sjuYKXbzXpeZQErczFbWWWGR2_U44xH6u1ejRNv8PikFiuzNw-muL7zUJkvqeSJzbEMnQdZMbfvZp4LtSI6B4G_PqpdNXkv19-juxAh99VgJInH_ItF0y5IBOxofA7gRebCZmU8L57gO9ohf2L00D95kis_Ji8lmA1ptLIfXqO_qLVvLBUNH-VtgjGAF0-0pyB-5jlbHP7w&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token class-name">String</span> publicKey <span class="token operator">=</span><span class="token string">&quot;-----BEGIN PUBLIC KEY-----MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAvFsEiaLvij9C1Mz+oyAmt47whAaRkRu/8kePM+X8760UGU0RMwGti6Z9y3LQ0RvK6I0brXmbGB/RsN38PVnhcP8ZfxGUH26kX0RK+tlrxcrG+HkPYOH4XPAL8Q1lu1n9x3tLcIPxq8ZZtuIyKYEmoLKyMsvTviG5flTpDprT25unWgE4md1kthRWXOnfWHATVY7Y/r4obiOL1mS5bEa/iNKotQNnvIAKtjBM4RlIDWMa6dmz+lHtLtqDD2LF1qwoiSIHI75LQZ/CNYaHCfZSxtOydpNKq8eb1/PGiLNolD4La2zf0/1dlcr5mkesV570NxRmU1tFm8Zd3MZlZmyv9QIDAQAB-----END PUBLIC KEY-----&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//解析令牌</span></span>
<span class="line">    <span class="token class-name">Jwt</span> token <span class="token operator">=</span> <span class="token class-name">JwtHelper</span><span class="token punctuation">.</span><span class="token function">decodeAndVerify</span><span class="token punctuation">(</span>jwt<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">RsaVerifier</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//获取负载</span></span>
<span class="line">    <span class="token class-name">String</span> claims <span class="token operator">=</span> token<span class="token punctuation">.</span><span class="token function">getClaims</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15</p><p>运行验证</p><p>改错公钥或令牌，再测试</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211123101811894.753bb94b.png" alt="image-20211123101811894"></p><h2 id="_4-oauth2-0入门" tabindex="-1"><a class="header-anchor" href="#_4-oauth2-0入门"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_4-oauth2-0%E5%85%A5%E9%97%A8" target="_blank" rel="noopener noreferrer">#</a>4 Oauth2.0入门</span></a></h2><h3 id="_4-1-准备工作" tabindex="-1"><a class="header-anchor" href="#_4-1-准备工作"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_4-1-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C" target="_blank" rel="noopener noreferrer">#</a>4.1 准备工作</span></a></h3><ol><li>1ydles_user库中导入表oauth_client_details（已经存在了）</li></ol><p>观察表结构及数据</p><p>oauth框架必须有的表</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>oauth_client_details<span class="token punctuation">`</span></span> <span class="token punctuation">(</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>client_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">48</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;客户端ID，主要用于标识对应的应用&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>resource_ids<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>client_secret<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;客户端秘钥，BCryptPasswordEncoder加密&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>scope<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;对应的范围&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>authorized_grant_types<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;认证模式&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>web_server_redirect_uri<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;认证后重定向地址&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>authorities<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>access_token_validity<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;令牌有效期&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>refresh_token_validity<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;令牌刷新周期&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>additional_information<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">`</span>autoapprove<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>client_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14</p><p>导入1条初始化数据,其中加密字符明文为ydlershe：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">INSERT INTO `oauth_client_details` VALUES (&#39;ydlershe&#39;, null, &#39;$2a$10$NCbyxYr7Xaso0u584oEuMOgYsvxDDWzRz5i/Ha7VySKx9qPqKF4RS&#39;, &#39;app&#39;, &#39;authorization_code,password,refresh_token,client_credentials&#39;, &#39;http://localhost&#39;, null, &#39;43200&#39;, &#39;43200&#39;, null, null);</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><h3 id="_4-2-oauth2授权模式介绍" tabindex="-1"><a class="header-anchor" href="#_4-2-oauth2授权模式介绍"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_4-2-oauth2%E6%8E%88%E6%9D%83%E6%A8%A1%E5%BC%8F%E4%BB%8B%E7%BB%8D" target="_blank" rel="noopener noreferrer">#</a>4.2 Oauth2授权模式介绍</span></a></h3><p>Oauth2有以下授权模式：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">1.授权码模式（Authorization Code）</span>
<span class="line">2.隐式授权模式（Implicit） </span>
<span class="line">3.密码模式（Resource Owner Password Credentials） </span>
<span class="line">4.客户端模式（Client Credentials） </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p>其中<strong>授权码模式</strong>和<strong>密码模式</strong>应用较多，本小节介绍授权码模式。</p><h4 id="_4-2-1-授权码模式" tabindex="-1"><a class="header-anchor" href="#_4-2-1-授权码模式"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_4-2-1-%E6%8E%88%E6%9D%83%E7%A0%81%E6%A8%A1%E5%BC%8F" target="_blank" rel="noopener noreferrer">#</a>4.2.1 授权码模式</span></a></h4><h5 id="_4-2-1-1-授权码授权流程-结合流程图" tabindex="-1"><a class="header-anchor" href="#_4-2-1-1-授权码授权流程-结合流程图"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_4-2-1-1-%E6%8E%88%E6%9D%83%E7%A0%81%E6%8E%88%E6%9D%83%E6%B5%81%E7%A8%8B-%E7%BB%93%E5%90%88%E6%B5%81%E7%A8%8B%E5%9B%BE" target="_blank" rel="noopener noreferrer">#</a>4.2.1.1 授权码授权流程（结合流程图）</span></a></h5><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211122104426755.a59ac96f.png" alt="image-20211122104426755"></p><p>上边例举的4399网站使用微信认证的过程就是授权码模式，流程如下：</p><p>1、客户端请求第三方授权</p><p>2、用户同意给客户端授权</p><p>3、客户端获取到授权码，请求认证服务器申请 令牌</p><p>4、认证服务器向客户端响应令牌</p><p>5、客户端请求资源服务器的资源，资源服务校验令牌合法性，完成授权</p><p>6、资源服务器返回受保护资源</p><h5 id="_4-2-1-2-申请授权码" tabindex="-1"><a class="header-anchor" href="#_4-2-1-2-申请授权码"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_4-2-1-2-%E7%94%B3%E8%AF%B7%E6%8E%88%E6%9D%83%E7%A0%81" target="_blank" rel="noopener noreferrer">#</a>4.2.1.2 申请授权码</span></a></h5><p>浏览器访问 http://localhost:9200/oauth/authorize?client_id=ydlershe&amp;response_type=code&amp;scop=app&amp;redirect_uri=http://localhost</p><p>参数列表如下：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">client_id：客户端id，和授权配置类中设置的客户端id一致。 </span>
<span class="line">response_type：授权码模式固定为code </span>
<span class="line">scop：客户端范围，和授权配置类中设置的scop一致。 </span>
<span class="line">redirect_uri：跳转uri，当授权码申请成功后会跳转到此地址，并在后边带上code参数（授权码）</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p>首先跳转到登录页面：</p><p><strong>用户名密码都填为</strong>：ydles</p><p>接下来进入授权页面：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211123105807017.38b77d0f.png" alt="image-20211123105807017"></p><p>点击Authorize,接下来返回授权码： 认证服务携带授权码跳转redirect_uri,code=k45iLY就是返回的授权码, <strong>每一个授权码只能使用一次</strong></p><p><img src="data:image/png;base64,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" alt="image-20211123105729141"></p><p><strong>注意观察</strong>：此接口为oauth2提供，项目中没有写controller。</p><h5 id="_4-2-1-3-申请令牌" tabindex="-1"><a class="header-anchor" href="#_4-2-1-3-申请令牌"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_4-2-1-3-%E7%94%B3%E8%AF%B7%E4%BB%A4%E7%89%8C" target="_blank" rel="noopener noreferrer">#</a>4.2.1.3 申请令牌</span></a></h5><p>拿到授权码后，申请令牌。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">Post请求：</span>
<span class="line">http://localhost:9200/oauth/token</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><p>参数如下：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">grant_type：授权类型，填写authorization_code，表示授权码模式 </span>
<span class="line">code：授权码，就是刚刚获取的授权码，注意：授权码只使用一次就无效了，需要重新申请。 </span>
<span class="line">redirect_uri：申请授权码时的跳转url，一定和申请授权码时用的redirect_uri一致。 </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211123110305801.03a67472.png" alt="image-20211123110305801"></p><p>此链接需要使用 http Basic认证。</p><p>什么是http Basic认证？</p><p>http协议定义的一种认证方式，将客户端id和客户端密码按照“客户端ID:客户端密码”的格式拼接，并用base64编 码，放在header中请求服务端，一个例子：</p><p>Authorization：Basic WGNXZWJBcHA6WGNXZWJBcHA=WGNXZWJBcHA6WGNXZWJBcHA= 是用户名:密码的base64编码。 认证失败服务端返回 401 Unauthorized。</p><p>以上测试使用postman完成：</p><p>http basic认证：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211123110249161.77c026af.png" alt="image-20211123110249161"></p><p>客户端Id和客户端密码会匹配数据库oauth_client_details表中的客户端id及客户端密码。</p><p>点击发送： 申请令牌成功</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211123110241083.60056d32.png" alt="image-20211123110241083"></p><p>返回信如下:</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">access_token：访问令牌，携带此令牌访问资源 </span>
<span class="line">token_type：有MAC Token与Bearer Token两种类型，两种的校验算法不同，RFC 6750建议Oauth2采用 Bearer Token（http://www.rfcreader.com/#rfc6750）。 </span>
<span class="line">refresh_token：刷新令牌，使用此令牌可以延长访问令牌的过期时间。 </span>
<span class="line">expires_in：过期时间，单位为秒。 </span>
<span class="line">scope：范围，与定义的客户端范围一致。    </span>
<span class="line">jti：当前token的唯一标识</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6</p><p><strong>思考</strong>：</p><p>cookie redis放那些令牌？</p><p>cookie 长度限制的 4K。</p><h5 id="_4-2-1-4-令牌校验-了解" tabindex="-1"><a class="header-anchor" href="#_4-2-1-4-令牌校验-了解"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_4-2-1-4-%E4%BB%A4%E7%89%8C%E6%A0%A1%E9%AA%8C-%E4%BA%86%E8%A7%A3" target="_blank" rel="noopener noreferrer">#</a>4.2.1.4 令牌校验-了解</span></a></h5><p>Spring Security Oauth2提供校验令牌的端点，如下：</p><p>Get: http://localhost:9200/oauth/check_token?token= [access_token]</p><p>参数：</p><p>token：令牌</p><p>使用postman测试如下:</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211123143858748.508bcb71.png" alt="image-20211123143858748"></p><p>如果令牌校验失败，会出现如下结果：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211123143848280.13c0ee0f.png" alt="image-20211123143848280"></p><p>如果令牌过期了，会如下如下结果：</p><h5 id="_4-2-1-5-刷新令牌" tabindex="-1"><a class="header-anchor" href="#_4-2-1-5-刷新令牌"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_4-2-1-5-%E5%88%B7%E6%96%B0%E4%BB%A4%E7%89%8C" target="_blank" rel="noopener noreferrer">#</a>4.2.1.5 刷新令牌</span></a></h5><p>刷新令牌是当令牌快过期时重新生成一个令牌，它于授权码授权和密码授权生成令牌不同，刷新令牌不需要授权码 也不需要账号和密码，只需要一个刷新令牌、客户端id和客户端密码。</p><p>测试如下：</p><p>Post：http://localhost:9200/oauth/token</p><p>参数：</p><p>grant_type： 固定为 refresh_token</p><p>refresh_token：刷新令牌（注意不是access_token，而是refresh_token）</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211123144117362.c7e3f508.png" alt="image-20211123144117362"></p><p><strong>授权码模式讲解完毕。回顾。</strong></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211122104426755.a59ac96f.png" alt="image-20211122104426755"></p><ul><li>1、客户端请求第三方授权</li><li>2、用户同意给客户端授权</li><li>3、客户端获取到授权码，请求认证服务器申请令牌</li><li>4、认证服务器向客户端响应令牌</li><li>5、客户端请求资源服务器的资源，资源服务校验令牌合法性，完成授权</li><li>6、资源服务器返回受保护资源</li></ul><h4 id="_4-2-2-密码模式" tabindex="-1"><a class="header-anchor" href="#_4-2-2-密码模式"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_4-2-2-%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F" target="_blank" rel="noopener noreferrer">#</a>4.2.2 密码模式</span></a></h4><p>密码模式（Resource Owner Password Credentials）与授权码模式的区别是申请令牌不再使用授权码，而是<strong>直接 通过用户名和密码即可申请令牌</strong>。</p><h5 id="_4-2-2-1-申请令牌" tabindex="-1"><a class="header-anchor" href="#_4-2-2-1-申请令牌"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_4-2-2-1-%E7%94%B3%E8%AF%B7%E4%BB%A4%E7%89%8C" target="_blank" rel="noopener noreferrer">#</a>4.2.2.1 申请令牌</span></a></h5><p>测试如下：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">Post请求：</span>
<span class="line">http://localhost:9200/oauth/token</span>
<span class="line"></span>
<span class="line">携带参数： </span>
<span class="line">grant_type：密码模式授权填写password </span>
<span class="line">username：账号 </span>
<span class="line">password：密码 </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><p>并且此链接需要使用 http Basic认证。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211123145409768.cc8ad2dc.png" alt="image-20211123145409768"></p><p>测试数据如下：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211123145403687.f126649e.png" alt="image-20211123145403687"></p><h3 id="_4-3-资源服务授权" tabindex="-1"><a class="header-anchor" href="#_4-3-资源服务授权"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_4-3-%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1%E6%8E%88%E6%9D%83" target="_blank" rel="noopener noreferrer">#</a>4.3 资源服务授权</span></a></h3><p>资源服务拥有要访问的受保护资源，客户端携带令牌访问资源服务，如果令牌合法则可成功访问资源服务中的资源，如下图:</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211124121822950.8a6e9f47.png" alt="image-20211124121822950"></p><p>上图的业务流程如下:</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">1、客户端请求认证服务申请令牌</span>
<span class="line">2、认证服务生成令牌认证服务采用非对称加密算法，使用私钥生成令牌。</span>
<span class="line">3、客户端携带令牌访问资源服务客户端在Http header 中添加： Authorization：Bearer令牌。</span>
<span class="line">4、资源服务请求认证服务校验令牌的有效性资源服务接收到令牌，使用公钥校验令牌的合法性。</span>
<span class="line">5、令牌有效，资源服务向客户端响应资源信息</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><h4 id="_4-3-1-改造用户服务-对接oauth2" tabindex="-1"><a class="header-anchor" href="#_4-3-1-改造用户服务-对接oauth2"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_4-3-1-%E6%94%B9%E9%80%A0%E7%94%A8%E6%88%B7%E6%9C%8D%E5%8A%A1-%E5%AF%B9%E6%8E%A5oauth2" target="_blank" rel="noopener noreferrer">#</a>4.3.1 改造用户服务 对接Oauth2</span></a></h4><p>基本上所有微服务都是资源服务，这里我们在课程管理服务上配置授权控制，当配置了授权控制后如要访问课程信 息则必须提供令牌。</p><p>1、配置公钥 ，将 ydles_user_auth 项目中public.key复制到ydles_service_user中</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211123151535527.041dace5.png" alt="image-20211123151535527"></p><p>2、添加依赖</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-oauth2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p>3、配置每个系统的Http请求路径安全控制策略以及读取公钥信息识别令牌，看懂即可。如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Configuration</span></span>
<span class="line"><span class="token annotation punctuation">@EnableResourceServer</span></span>
<span class="line"><span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>prePostEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> securedEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token comment">//激活方法上的PreAuthorize注解</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ResourceServerConfig</span> <span class="token keyword">extends</span> <span class="token class-name">ResourceServerConfigurerAdapter</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token comment">//公钥</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PUBLIC_KEY</span> <span class="token operator">=</span> <span class="token string">&quot;public.key&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token doc-comment comment">/***</span>
<span class="line"> * 定义JwtTokenStore</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">jwtAccessTokenConverter</span></span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@Bean</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">TokenStore</span> <span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token class-name">JwtAccessTokenConverter</span> jwtAccessTokenConverter<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JwtTokenStore</span><span class="token punctuation">(</span>jwtAccessTokenConverter<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token doc-comment comment">/***</span>
<span class="line"> * 定义JJwtAccessTokenConverter</span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@Bean</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">JwtAccessTokenConverter</span> <span class="token function">jwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">JwtAccessTokenConverter</span> converter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    converter<span class="token punctuation">.</span><span class="token function">setVerifierKey</span><span class="token punctuation">(</span><span class="token function">getPubKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> converter<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 获取非对称加密公钥 Key</span>
<span class="line"> * <span class="token keyword">@return</span> 公钥 Key</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getPubKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">Resource</span> resource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token constant">PUBLIC_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">InputStreamReader</span> inputStreamReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">BufferedReader</span> br <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span>inputStreamReader<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> br<span class="token punctuation">.</span><span class="token function">lines</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ioe<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token doc-comment comment">/***</span>
<span class="line"> * Http安全配置，对每个到达系统的http请求链接进行校验</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">http</span></span>
<span class="line"> * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//所有请求必须认证通过</span></span>
<span class="line">    http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token comment">//下边的路径放行</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span></span>
<span class="line">                    <span class="token string">&quot;/user/add&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/user/load/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token comment">//配置地址放行</span></span>
<span class="line">            <span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span></span>
<span class="line">            <span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//其他地址需要认证授权</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59</p><h4 id="_4-3-2-资源服务授权测试" tabindex="-1"><a class="header-anchor" href="#_4-3-2-资源服务授权测试"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_4-3-2-%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1%E6%8E%88%E6%9D%83%E6%B5%8B%E8%AF%95" target="_blank" rel="noopener noreferrer">#</a>4.3.2 资源服务授权测试</span></a></h4><p>1不携带令牌访问http://localhost:9005/user</p><p>由于该地址受访问限制，需要授权，所以出现如下错误：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">{</span>
<span class="line">    &quot;error&quot;: &quot;unauthorized&quot;,</span>
<span class="line">    &quot;error_description&quot;: &quot;Full authentication is required to access this resource&quot;</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211123152023597.9e4c21c8.png" alt="image-20211123152023597"></p><p>2携带令牌访问http://localhost:9005/user</p><p>在http header中添加 Authorization： Bearer 令牌</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211123152205060.4a9a71e2.png" alt="image-20211123152205060"></p><p>当输入错误的令牌也无法正常访问资源。</p><h2 id="_5-认证开发" tabindex="-1"><a class="header-anchor" href="#_5-认证开发"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_5-%E8%AE%A4%E8%AF%81%E5%BC%80%E5%8F%91" target="_blank" rel="noopener noreferrer">#</a>5 认证开发</span></a></h2><h3 id="_5-1-需求分析-1" tabindex="-1"><a class="header-anchor" href="#_5-1-需求分析-1"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_5-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90-1" target="_blank" rel="noopener noreferrer">#</a>5.1 需求分析</span></a></h3><p>功能流程图如下：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211124121822950.8a6e9f47.png" alt="image-20211124121822950"></p><p>执行流程：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">1登陆：认证服务认证通过，生成jwt令牌，将jwt令牌及相关信息写入Redis，并且将身份令牌写入cookie </span>
<span class="line">2访问：用户访问资源页面，带着cookie到网关，网关从cookie获取token，并查询Redis校验token,如果token不存在则拒绝访问，否则放行</span>
<span class="line">3退出：请求认证服务，清除redis中的token，并且删除cookie中的token</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3</p><p>使用redis存储用户的身份令牌有以下作用：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">1、实现用户退出注销功能，服务端清除令牌后，即使客户端请求携带token也是无效的。 </span>
<span class="line">2、由于jwt令牌过长，不宜存储在cookie中，所以将jwt令牌存储在redis，由客户端请求服务端获取并在客户端存储。    </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><h3 id="_5-2-redis配置" tabindex="-1"><a class="header-anchor" href="#_5-2-redis配置"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_5-2-redis%E9%85%8D%E7%BD%AE" target="_blank" rel="noopener noreferrer">#</a>5.2 Redis配置</span></a></h3><p>将认证服务ydles_user_auth中的application.yml配置文件中的Redis配置改成自己对应的端口和密码。</p><h3 id="_5-3-认证服务" tabindex="-1"><a class="header-anchor" href="#_5-3-认证服务"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_5-3-%E8%AE%A4%E8%AF%81%E6%9C%8D%E5%8A%A1" target="_blank" rel="noopener noreferrer">#</a>5.3 认证服务</span></a></h3><h4 id="_5-3-1-认证需求分析" tabindex="-1"><a class="header-anchor" href="#_5-3-1-认证需求分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_5-3-1-%E8%AE%A4%E8%AF%81%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>5.3.1 认证需求分析</span></a></h4><p>认证服务需要实现的功能如下：</p><p>1、登录接口</p><p>前端post提交账号、密码等，用户身份校验通过，生成令牌，并将令牌存储到redis。 将令牌写入cookie。</p><p>2、退出接口</p><p>校验当前用户的身份为合法并且为已登录状态。 将令牌从redis删除。 删除cookie中的令牌。</p><h4 id="_5-3-2-授权参数配置" tabindex="-1"><a class="header-anchor" href="#_5-3-2-授权参数配置"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_5-3-2-%E6%8E%88%E6%9D%83%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE" target="_blank" rel="noopener noreferrer">#</a>5.3.2 授权参数配置</span></a></h4><p>修改ydles_user_auth中application.yml配置文件，修改对应的授权配置</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">auth:</span>
<span class="line">  ttl: 1200  #token存储到redis的过期时间</span>
<span class="line">  clientId: ydlershe    #客户端ID</span>
<span class="line">  clientSecret: ydlershe    #客户端秘钥</span>
<span class="line">  cookieDomain: localhost   #Cookie保存对应的域名</span>
<span class="line">  cookieMaxAge: -1          #Cookie过期时间，-1表示浏览器关闭则销毁</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6</p><p>配置redis</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">	redis:  </span>
<span class="line">		host: 192.168.200.128</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><h4 id="_5-3-3-申请令牌测试" tabindex="-1"><a class="header-anchor" href="#_5-3-3-申请令牌测试"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_5-3-3-%E7%94%B3%E8%AF%B7%E4%BB%A4%E7%89%8C%E6%B5%8B%E8%AF%95" target="_blank" rel="noopener noreferrer">#</a>5.3.3 申请令牌测试</span></a></h4><p>明确：request=请求头+请求体</p><p>所以postman</p><p>转化为：请求头中</p><p><strong>计算方法为</strong>：Basic base64(客户端名称：客户端密码)</p><p>为了不破坏Spring Security的代码，我们在Service方法中通过RestTemplate请求Spring Security所暴露的申请令 牌接口来申请令牌，下边是测试代码：</p><p><strong>启动类添加</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Bean</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span>  <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p><strong>写测试类</strong></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydles</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runner<span class="token punctuation">.</span></span><span class="token class-name">RunWith</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">ServiceInstance</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>client<span class="token punctuation">.</span>loadbalancer<span class="token punctuation">.</span></span><span class="token class-name">LoadBalanced</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>client<span class="token punctuation">.</span>loadbalancer<span class="token punctuation">.</span></span><span class="token class-name">LoadBalancerClient</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpEntity</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpMethod</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">ResponseEntity</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">ClientHttpResponse</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span></span><span class="token class-name">SpringRunner</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Base64Utils</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">LinkedMultiValueMap</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">MultiValueMap</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">DefaultResponseErrorHandler</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">RestTemplate</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">URI</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Base64</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * @Created by IT李老师</span>
<span class="line"> * 公主号 “IT李哥交朋友”</span>
<span class="line"> * 个人微 itlils</span>
<span class="line"> * 缺啥补啥</span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@SpringBootTest</span><span class="token punctuation">(</span>classes <span class="token operator">=</span> <span class="token class-name">OAuthApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplyTokenTest</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">LoadBalancerClient</span> loadBalancerClient<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//代码申请令牌</span></span>
<span class="line">    <span class="token annotation punctuation">@Test</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">applyToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//1 url http://localhost:9200/oauth/token</span></span>
<span class="line">        <span class="token class-name">ServiceInstance</span> serviceInstance <span class="token operator">=</span> loadBalancerClient<span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span><span class="token string">&quot;user-auth&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">URI</span> uri <span class="token operator">=</span> serviceInstance<span class="token punctuation">.</span><span class="token function">getUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//http://localhost:9200</span></span>
<span class="line">        <span class="token class-name">String</span> url<span class="token operator">=</span>uri<span class="token operator">+</span><span class="token string">&quot;/oauth/token&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//2.1 请求头</span></span>
<span class="line">        <span class="token class-name">MultiValueMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> headers<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">LinkedMultiValueMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        headers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">,</span> <span class="token function">getHttpHeaders</span><span class="token punctuation">(</span><span class="token string">&quot;ydlershe&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;ydlershe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//2.2 请求体</span></span>
<span class="line">        <span class="token class-name">MultiValueMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> body<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">LinkedMultiValueMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        body<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;grant_type&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        body<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;itlils&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        body<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;itlils&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//2 构建请求</span></span>
<span class="line">        <span class="token class-name">HttpEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MultiValueMap</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> requestEntity<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HttpEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>body<span class="token punctuation">,</span>headers<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//400 401 不报错，返回回来</span></span>
<span class="line">        restTemplate<span class="token punctuation">.</span><span class="token function">setErrorHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultResponseErrorHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//响应当中有错误 如何处理</span></span>
<span class="line">            <span class="token annotation punctuation">@Override</span></span>
<span class="line">            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleError</span><span class="token punctuation">(</span><span class="token class-name">URI</span> url<span class="token punctuation">,</span> <span class="token class-name">HttpMethod</span> method<span class="token punctuation">,</span> <span class="token class-name">ClientHttpResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getRawStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">400</span><span class="token operator">&amp;&amp;</span>response<span class="token punctuation">.</span><span class="token function">getRawStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">handleError</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span>method<span class="token punctuation">,</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//3发请求</span></span>
<span class="line">        <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&gt;</span></span> exchange <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">,</span> requestEntity<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//4请求中 拿数据</span></span>
<span class="line">        <span class="token class-name">Map</span> body1 <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>body1<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//请求头中Authorization值的计算方法</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getHttpHeaders</span><span class="token punctuation">(</span><span class="token class-name">String</span> clientId<span class="token punctuation">,</span><span class="token class-name">String</span> clinetSecret<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//Basic base64(客户端名称：客户端密码)</span></span>
<span class="line">        <span class="token class-name">String</span> str<span class="token operator">=</span>clientId<span class="token operator">+</span><span class="token string">&quot;:&quot;</span><span class="token operator">+</span>clinetSecret<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> encode <span class="token operator">=</span> <span class="token class-name">Base64Utils</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">&quot;Basic &quot;</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>encode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92</p><h4 id="_5-3-4-业务层" tabindex="-1"><a class="header-anchor" href="#_5-3-4-业务层"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_5-3-4-%E4%B8%9A%E5%8A%A1%E5%B1%82" target="_blank" rel="noopener noreferrer">#</a>5.3.4 业务层</span></a></h4><p>1service层添加接口 com.ydles.oauth.service</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AuthService</span> <span class="token punctuation">{</span>    </span>
<span class="line">	<span class="token class-name">AuthToken</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span><span class="token class-name">String</span> password<span class="token punctuation">,</span><span class="token class-name">String</span> clientId<span class="token punctuation">,</span><span class="token class-name">String</span> clientSecret<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3</p><p>2接口实现 com.ydles.oauth.service.impl</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Service</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AuthService</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">LoadBalancerClient</span> loadBalancerClient<span class="token punctuation">;</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span></span>
<span class="line">    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${auth.ttl}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">private</span> <span class="token keyword">long</span> ttl<span class="token punctuation">;</span></span>
<span class="line">	</span>
<span class="line">	<span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">AuthToken</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">String</span> clientId<span class="token punctuation">,</span> <span class="token class-name">String</span> clientSecret<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1申请令牌</span></span>
<span class="line">    <span class="token comment">//请求地址： http://localhost:9200/oauth/token</span></span>
<span class="line">    <span class="token class-name">ServiceInstance</span> serviceInstance <span class="token operator">=</span> loadBalancerClient<span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span><span class="token string">&quot;user-auth&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// http://localhost:9200</span></span>
<span class="line">    <span class="token class-name">URI</span> uri <span class="token operator">=</span> serviceInstance<span class="token punctuation">.</span><span class="token function">getUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">String</span> url <span class="token operator">=</span> uri <span class="token operator">+</span> <span class="token string">&quot;/oauth/token&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//请求体 body</span></span>
<span class="line">    <span class="token class-name">MultiValueMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedMultiValueMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    body<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;grant_type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    body<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    body<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//请求头</span></span>
<span class="line">    <span class="token class-name">MultiValueMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> headers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedMultiValueMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    headers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getHttpBasic</span><span class="token punctuation">(</span>clientId<span class="token punctuation">,</span> clientSecret<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//封装请求参数</span></span>
<span class="line">    <span class="token class-name">HttpEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MultiValueMap</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> requestEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> headers<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//后端401 400，不认为是异常，直接返回给前端</span></span>
<span class="line">    restTemplate<span class="token punctuation">.</span><span class="token function">setErrorHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultResponseErrorHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token annotation punctuation">@Override</span></span>
<span class="line">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleError</span><span class="token punctuation">(</span><span class="token class-name">ClientHttpResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getRawStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">400</span><span class="token operator">&amp;&amp;</span>response<span class="token punctuation">.</span><span class="token function">getRawStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">handleError</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 1 url</span>
<span class="line">     * 2请求方法</span>
<span class="line">     * 3请求头和体</span>
<span class="line">     * 4返回值类型</span>
<span class="line">     */</span></span>
<span class="line">    <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&gt;</span></span> responseMap <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">,</span> requestEntity<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">Map</span> map <span class="token operator">=</span> responseMap<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span>map<span class="token operator">==</span><span class="token keyword">null</span><span class="token operator">&amp;&amp;</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;access_token&quot;</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token keyword">null</span><span class="token operator">&amp;&amp;</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;refresh_token&quot;</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token keyword">null</span><span class="token operator">&amp;&amp;</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;jti&quot;</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;申请令牌失败！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">   <span class="token comment">// 2封装数据结果</span></span>
<span class="line">    <span class="token class-name">AuthToken</span> authToken<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">AuthToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    authToken<span class="token punctuation">.</span><span class="token function">setAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;access_token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    authToken<span class="token punctuation">.</span><span class="token function">setRefreshToken</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;refresh_token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    authToken<span class="token punctuation">.</span><span class="token function">setJti</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;jti&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">       <span class="token comment">// 3将jti：jwt存储到redis</span></span>
<span class="line">    redisTemplate<span class="token punctuation">.</span><span class="token function">boundValueOps</span><span class="token punctuation">(</span>authToken<span class="token punctuation">.</span><span class="token function">getJti</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>authToken<span class="token punctuation">.</span><span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>ttl <span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> authToken<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">//请求头中Authorization值的计算方法</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getHttpBasic</span><span class="token punctuation">(</span><span class="token class-name">String</span> clientId<span class="token punctuation">,</span> <span class="token class-name">String</span> clientSecret<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token class-name">String</span> value <span class="token operator">=</span> clientId <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> clientSecret<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> encode <span class="token operator">=</span> <span class="token class-name">Base64Utils</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token string">&quot;Basic &quot;</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>encode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73</p><h4 id="_5-3-5-控制层" tabindex="-1"><a class="header-anchor" href="#_5-3-5-控制层"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_5-3-5-%E6%8E%A7%E5%88%B6%E5%B1%82" target="_blank" rel="noopener noreferrer">#</a>5.3.5 控制层</span></a></h4><p>com.ydles.oauth.controller 添加</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>oauth<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">Result</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">StatusCode</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>oauth<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">AuthService</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>oauth<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">AuthToken</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Controller</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostMapping</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">ResponseBody</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">Cookie</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * @Created by IT李老师</span>
<span class="line"> * 公主号 “IT李哥交朋友”</span>
<span class="line"> * 个人微 itlils</span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@Controller</span></span>
<span class="line"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/oauth&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthController</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">AuthService</span> authService<span class="token punctuation">;</span></span>
<span class="line">    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${auth.clientId}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token class-name">String</span> clientId<span class="token punctuation">;</span></span>
<span class="line">    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${auth.clientSecret}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token class-name">String</span> clientSecret<span class="token punctuation">;</span></span>
<span class="line">    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${auth.cookieMaxAge}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">int</span> cookieMaxAge<span class="token punctuation">;</span></span>
<span class="line">    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${auth.cookieDomain}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token class-name">String</span> cookieDomain<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token annotation punctuation">@ResponseBody</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">AuthToken</span> authToken <span class="token operator">=</span> authService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> clientId<span class="token punctuation">,</span> clientSecret<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//三 responses cookie 放jti</span></span>
<span class="line">        <span class="token class-name">Cookie</span> cookie <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">(</span><span class="token string">&quot;uid&quot;</span><span class="token punctuation">,</span>authToken<span class="token punctuation">.</span><span class="token function">getJti</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        cookie<span class="token punctuation">.</span><span class="token function">setMaxAge</span><span class="token punctuation">(</span>cookieMaxAge<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        cookie<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        cookie<span class="token punctuation">.</span><span class="token function">setDomain</span><span class="token punctuation">(</span>cookieDomain<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        cookie<span class="token punctuation">.</span><span class="token function">setHttpOnly</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        response<span class="token punctuation">.</span><span class="token function">addCookie</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span><span class="token string">&quot;登陆成功&quot;</span><span class="token punctuation">,</span> authToken<span class="token punctuation">.</span><span class="token function">getJti</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54</p><p>拓展：cookie session 区别和联系 应用场景。</p><p>如何用代码来操作cookie session？</p><h4 id="_5-3-6-登录请求放行" tabindex="-1"><a class="header-anchor" href="#_5-3-6-登录请求放行"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_5-3-6-%E7%99%BB%E5%BD%95%E8%AF%B7%E6%B1%82%E6%94%BE%E8%A1%8C" target="_blank" rel="noopener noreferrer">#</a>5.3.6 登录请求放行</span></a></h4><p>修改认证服务WebSecurityConfig类中configure（），添加放行路径</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/1564737871413.31588cd6.png" alt="1564737871413"></p><h4 id="_5-3-7-测试认证接口" tabindex="-1"><a class="header-anchor" href="#_5-3-7-测试认证接口"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_5-3-7-%E6%B5%8B%E8%AF%95%E8%AE%A4%E8%AF%81%E6%8E%A5%E5%8F%A3" target="_blank" rel="noopener noreferrer">#</a>5.3.7 测试认证接口</span></a></h4><p>使用postman测试：</p><p>1重启认证服务</p><p>2postman测试</p><p>POST http://localhost:9200/oauth/login</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">username itlils</span>
<span class="line">password itlils</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211124114029840.6c4a7a30.png" alt="image-20211124114029840"></p><p>观察cookie</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211124114141440.1096c2b3.png" alt="image-20211124114141440"></p><p>观察redis中数据</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211124114309292.4e3565b2.png" alt="image-20211124114309292"></p><p>若key value有乱码，则使用 StringRedisTemplate。</p><h4 id="_5-3-8-动态获取用户信息" tabindex="-1"><a class="header-anchor" href="#_5-3-8-动态获取用户信息"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_5-3-8-%E5%8A%A8%E6%80%81%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF" target="_blank" rel="noopener noreferrer">#</a>5.3.8 动态获取用户信息</span></a></h4><p>1需求：</p><p>当前在认证服务中，用户密码是写死在用户认证类中。所以用户登录时，无论帐号输入什么，只要密码是itheima都可以访问。因此需要动态获取用户帐号与密码.</p><p>2用户服务 com.ydles.user.controller UserController中新增方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/load/{username}&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">findUserInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> username<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">User</span> user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> user<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p>3user-api中 新增 feigh客户端。com.ydles.user.feign</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserFeign</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/user/load/{username}&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">findUserInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p>4认证服务导入依赖</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ydles_service_user_api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p>5认证启动类添加注解</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;com.ydles.user.feign&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>6修改com.ydles.oauth.config UserDetailsServiceImpl 改为动态获取用户信息</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Service</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDetailsServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token annotation punctuation">@Autowired</span></span>
<span class="line"><span class="token class-name">ClientDetailsService</span> clientDetailsService<span class="token punctuation">;</span></span>
<span class="line"><span class="token annotation punctuation">@Autowired</span></span>
<span class="line"><span class="token class-name">UserFeign</span> userFeign<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token doc-comment comment">/****</span>
<span class="line"> * 自定义授权认证</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">username</span></span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">UsernameNotFoundException</span></span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//取出身份，如果身份为空说明没有认证</span></span>
<span class="line">    <span class="token class-name">Authentication</span> authentication <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//没有认证统一采用httpbasic认证，httpbasic中存储了client_id和client_secret，开始认证client_id和client_secret</span></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span>authentication<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">ClientDetails</span> clientDetails <span class="token operator">=</span> clientDetailsService<span class="token punctuation">.</span><span class="token function">loadClientByClientId</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span>clientDetails<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//秘钥</span></span>
<span class="line">            <span class="token class-name">String</span> clientSecret <span class="token operator">=</span> clientDetails<span class="token punctuation">.</span><span class="token function">getClientSecret</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">//静态方式</span></span>
<span class="line">            <span class="token comment">//return new User(username,new BCryptPasswordEncoder().encode(clientSecret), AuthorityUtils.commaSeparatedStringToAuthorityList(&quot;&quot;));</span></span>
<span class="line">            <span class="token comment">//数据库查找方式</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>clientSecret<span class="token punctuation">,</span> <span class="token class-name">AuthorityUtils</span><span class="token punctuation">.</span><span class="token function">commaSeparatedStringToAuthorityList</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//根据用户名查询用户信息</span></span>
<span class="line">    <span class="token comment">// String pwd = new BCryptPasswordEncoder().encode(&quot;itlils&quot;);</span></span>
<span class="line">    <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>user<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span>User</span> user <span class="token operator">=</span> userFeign<span class="token punctuation">.</span><span class="token function">findUserInfo</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//创建User对象</span></span>
<span class="line">    <span class="token class-name">String</span> permissions <span class="token operator">=</span> <span class="token string">&quot;goods_list,seckill_list&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">UserJwt</span> userDetails <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserJwt</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">AuthorityUtils</span><span class="token punctuation">.</span><span class="token function">commaSeparatedStringToAuthorityList</span><span class="token punctuation">(</span>permissions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> userDetails<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43</p><p>7重启测试 登陆 http://localhost:9200/oauth/login</p><p>报错401 因为用户服务已经受保护。</p><p>8用户服务 com.ydles.user.config ResourceServerConfig类的configure方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//所有请求必须认证通过</span></span>
<span class="line">    http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token comment">//下边的路径放行</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span></span>
<span class="line">                    <span class="token string">&quot;/user/add&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/user/load/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token comment">//配置地址放行</span></span>
<span class="line">            <span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span></span>
<span class="line">            <span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//其他地址需要认证授权</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11</p><p>9再次访问即可成功</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211124121717560.eda1f00e.png" alt="image-20211124121717560"></p><h2 id="_6-认证服务对接网关" tabindex="-1"><a class="header-anchor" href="#_6-认证服务对接网关"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_6-%E8%AE%A4%E8%AF%81%E6%9C%8D%E5%8A%A1%E5%AF%B9%E6%8E%A5%E7%BD%91%E5%85%B3" target="_blank" rel="noopener noreferrer">#</a>6 认证服务对接网关</span></a></h2><h3 id="_6-1-新建网关工程ydles-gateway-web" tabindex="-1"><a class="header-anchor" href="#_6-1-新建网关工程ydles-gateway-web"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_6-1-%E6%96%B0%E5%BB%BA%E7%BD%91%E5%85%B3%E5%B7%A5%E7%A8%8Bydles-gateway-web" target="_blank" rel="noopener noreferrer">#</a>6.1 新建网关工程ydles_gateway_web</span></a></h3><ol><li>ydles_gateway这个大模块，添加依赖</li></ol><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-hystrix<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token comment">&lt;!--redis--&gt;</span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis-reactive<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.3.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token comment">&lt;!--鉴权--&gt;</span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.jsonwebtoken<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jjwt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.9.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26</p><ol><li>创建ydles_gateway_web客户端网关模块。不用添加依赖，因为父依赖已有。</li><li>启动类com.ydles.web.gateway</li></ol><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@SpringBootApplication</span></span>
<span class="line"><span class="token annotation punctuation">@EnableEurekaClient</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebGatewayApplication</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">WebGatewayApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><ol><li>创建application.yml</li></ol><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">spring</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">application</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> gateway<span class="token punctuation">-</span>web</span>
<span class="line">  <span class="token key atrule">cloud</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">gateway</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">globalcors</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">cors-configurations</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">&#39;[/**]&#39;</span><span class="token punctuation">:</span> <span class="token comment"># 匹配所有请求</span></span>
<span class="line">            <span class="token key atrule">allowedOrigins</span><span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span> <span class="token comment">#跨域处理 允许所有的域</span></span>
<span class="line">            <span class="token key atrule">allowedMethods</span><span class="token punctuation">:</span> <span class="token comment"># 支持的方法</span></span>
<span class="line">              <span class="token punctuation">-</span> GET</span>
<span class="line">              <span class="token punctuation">-</span> POST</span>
<span class="line">              <span class="token punctuation">-</span> PUT</span>
<span class="line">              <span class="token punctuation">-</span> DELETE</span>
<span class="line">      <span class="token key atrule">routes</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> ydles_goods_route</span>
<span class="line">          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//goods</span>
<span class="line">          <span class="token key atrule">predicates</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> Path=/api/album/<span class="token important">**</span><span class="token punctuation">,</span>/api/brand/<span class="token important">**</span><span class="token punctuation">,</span>/api/cache/<span class="token important">**</span><span class="token punctuation">,</span>/api/categoryBrand/<span class="token important">**</span><span class="token punctuation">,</span>/api/category/<span class="token important">**</span><span class="token punctuation">,</span>/api/para/<span class="token important">**</span><span class="token punctuation">,</span>/api/pref/<span class="token important">**</span><span class="token punctuation">,</span>/api/sku/<span class="token important">**</span><span class="token punctuation">,</span>/api/spec/<span class="token important">**</span><span class="token punctuation">,</span>/api/spu/<span class="token important">**</span><span class="token punctuation">,</span>/api/stockBack/<span class="token important">**</span><span class="token punctuation">,</span>/api/template/<span class="token important">**</span></span>
<span class="line">          <span class="token key atrule">filters</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment">#- PrefixPath=/brand</span></span>
<span class="line">            <span class="token punctuation">-</span> StripPrefix=1</span>
<span class="line">          <span class="token comment">#用户微服务</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> ydles_user_route</span>
<span class="line">          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//user</span>
<span class="line">          <span class="token key atrule">predicates</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> Path=/api/user/<span class="token important">**</span><span class="token punctuation">,</span>/api/address/<span class="token important">**</span><span class="token punctuation">,</span>/api/areas/<span class="token important">**</span><span class="token punctuation">,</span>/api/cities/<span class="token important">**</span><span class="token punctuation">,</span>/api/provinces/<span class="token important">**</span></span>
<span class="line">          <span class="token key atrule">filters</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> StripPrefix=1</span>
<span class="line">          <span class="token comment">#认证微服务</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> ydles_oauth_user</span>
<span class="line">          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//user<span class="token punctuation">-</span>auth</span>
<span class="line">          <span class="token key atrule">predicates</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> Path=/api/oauth/<span class="token important">**</span></span>
<span class="line">          <span class="token key atrule">filters</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> StripPrefix=1</span>
<span class="line">  <span class="token key atrule">redis</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.200.128</span>
<span class="line"><span class="token key atrule">server</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8001</span></span>
<span class="line"><span class="token key atrule">eureka</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">client</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">service-url</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>6868/eureka</span>
<span class="line">  <span class="token key atrule">instance</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line"><span class="token key atrule">management</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">endpoint</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">gateway</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">    <span class="token key atrule">web</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">exposure</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53</p><h3 id="_6-2-网关全局过滤器" tabindex="-1"><a class="header-anchor" href="#_6-2-网关全局过滤器"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_6-2-%E7%BD%91%E5%85%B3%E5%85%A8%E5%B1%80%E8%BF%87%E6%BB%A4%E5%99%A8" target="_blank" rel="noopener noreferrer">#</a>6.2 网关全局过滤器</span></a></h3><p>1需求：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211124151858147.25901c4b.png" alt="image-20211124151858147"></p><p>先通过网关是确定用户是否拥有令牌，微服务是进行令牌的校验。</p><p>1.1登陆时：放行</p><p>1.2用户访问时：</p><ul><li>1）判断当前请求是否为登录请求，是的话，则放行</li><li>2 ) 判断cookie中是否存在信息, 没有的话，拒绝访问</li><li>3）判断redis中令牌是否存在，没有的话，拒绝访问</li></ul><p>2客户端网关工程 com.ydles.web.gateway.filter</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">AuthService</span> authService<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">ServerHttpResponse</span> response <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//1判断当前请求是否为登陆，是就放行</span></span>
<span class="line">    <span class="token class-name">String</span> path <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;/api/oauth/login&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//放行</span></span>
<span class="line">        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//  2从cookie中获取jti，不存在，拒绝访问</span></span>
<span class="line">    <span class="token class-name">String</span> jti<span class="token operator">=</span>authService<span class="token punctuation">.</span><span class="token function">getJtiFromCookie</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>jti<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//拒绝访问</span></span>
<span class="line">        response<span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">UNAUTHORIZED</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">setComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">   <span class="token comment">//  3从redis获取jwt，不存在，则拒绝访问</span></span>
<span class="line">    <span class="token class-name">String</span> jwt<span class="token operator">=</span>authService<span class="token punctuation">.</span><span class="token function">getJwtFromRedis</span><span class="token punctuation">(</span>jti<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>jwt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//拒绝访问</span></span>
<span class="line">        response<span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">UNAUTHORIZED</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">setComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">   <span class="token comment">//  4对当前请求增强，让其携带令牌信息</span></span>
<span class="line">    request<span class="token punctuation">.</span><span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Bearer &quot;</span><span class="token operator">+</span>jwt<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44</p><p>3com.ydles.web.gateway.service</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Service</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthService</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//从request中获取jti</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getJtiFromCookie</span><span class="token punctuation">(</span><span class="token class-name">ServerHttpRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">HttpCookie</span> httpCookie <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token string">&quot;uid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>httpCookie <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">String</span> jti <span class="token operator">=</span> httpCookie<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> jti<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getJwtFromRedis</span><span class="token punctuation">(</span><span class="token class-name">String</span> jti<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">String</span> jwt <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">boundValueOps</span><span class="token punctuation">(</span>jti<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> jwt<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19</p><p><strong>测试</strong>：</p><p>1启动用户网关</p><p>2测试Get http://localhost:8001/api/user/</p><p>401</p><p>3测试登陆</p><p>POST http://localhost:8001/api/oauth/login</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211124154032714.6bb5af40.png" alt="image-20211124154032714"></p><p>4再测试Get http://localhost:8001/api/user/ 成功。因为查看cookie中有uid。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211124160506030.631f659a.png" alt="image-20211124160506030"></p><h2 id="_7-自定义登录页面" tabindex="-1"><a class="header-anchor" href="#_7-自定义登录页面"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_7-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2" target="_blank" rel="noopener noreferrer">#</a>7 自定义登录页面</span></a></h2><p>需求：oauth自带登陆页面太丑，我们想要一个体验更好的登陆页面。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211124163728345.fd40bc02.png" alt="image-20211124163728345"></p><p>访问路径： http://localhost:8001/api/oauth/toLogin</p><p>流程： 1客户端网关-》认证服务controller-》login.html。</p><p>2点击登陆-》/api/oauth/login-》获取令牌登陆</p><p>1 认证服务添加依赖</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">    <span class="token comment">&lt;!--thymeleaf--&gt;</span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-thymeleaf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p>2 resources下 新增static、templates文件夹。放入资源里的数据。</p><p>3 AuthController中添加跳转</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/toLogin&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token string">&quot;login&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p>4 放行静态资源。com.ydles.oauth.config包 WebSecurityConfig类</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">WebSecurity</span> web<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">    web<span class="token punctuation">.</span><span class="token function">ignoring</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span>           <span class="token string">&quot;/oauth/login&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/oauth/logout&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/oauth/toLogin&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/login.html&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/css/**&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/data/**&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/fonts/**&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/./image/**&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/js/**&quot;</span></span>
<span class="line">            <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p>5登陆经过用户网关，所以将static目录copy至gateway_web一份</p><p>6开启表单登陆。com.ydles.oauth.config包 WebSecurityConfig类</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">    http<span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">httpBasic</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment">//启用Http基本身份验证</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>       <span class="token comment">//启用表单身份验证</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">//限制基于Request请求访问</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//其他请求都需要经过验证</span></span>
<span class="line"><span class="token comment">//开启表单登陆</span></span>
<span class="line">  http<span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token string">&quot;/oauth/toLogin&quot;</span><span class="token punctuation">)</span><span class="token comment">//设置访问登陆页面的路径</span></span>
<span class="line">          <span class="token punctuation">.</span><span class="token function">loginProcessingUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/oauth/login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置执行登陆操作的路径</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14</p><p>7login.html修改</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">2 &lt;html lang=&quot;en&quot; xmlns:th=&quot;http://www.thymeleaf.org&quot;&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">82 &lt;div class=&quot;login-box&quot; id=&quot;app&quot;&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><div class="language-html line-numbers-mode" data-highlighter="prismjs" data-ext="html" data-title="html"><pre><code><span class="line">101 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>inputName<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>username<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>邮箱/用户名/手机号<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>span2 input-xfat<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><div class="language-html line-numbers-mode" data-highlighter="prismjs" data-ext="html" data-title="html"><pre><code><span class="line">104 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>inputPassword<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>请输入密码<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>span2 input-xfat<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><div class="language-html line-numbers-mode" data-highlighter="prismjs" data-ext="html" data-title="html"><pre><code><span class="line">114-115</span>
<span class="line"><span class="token comment">&lt;!--&lt;a class=&quot;sui-btn btn-block btn-xlarge btn-danger&quot; href=&quot;home.html&quot; target=&quot;_blank&quot;&gt;登&amp;nbsp;&amp;nbsp;录&lt;/a&gt;--&gt;</span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sui-btn btn-block btn-xlarge btn-danger<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>login()<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>登<span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span>录<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3</p><div class="language-html line-numbers-mode" data-highlighter="prismjs" data-ext="html" data-title="html"><pre><code><span class="line">167-188</span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name"><span class="token namespace">th:</span>inline</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>javascript<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript"></span>
<span class="line">	<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">		<span class="token literal-property property">el</span><span class="token operator">:</span><span class="token string">&quot;#app&quot;</span><span class="token punctuation">,</span></span>
<span class="line">		<span class="token literal-property property">data</span><span class="token operator">:</span><span class="token punctuation">{</span></span>
<span class="line">			<span class="token literal-property property">username</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span></span>
<span class="line">			<span class="token literal-property property">password</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span></span>
<span class="line">			<span class="token literal-property property">msg</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span></span>
<span class="line">		<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">		<span class="token literal-property property">methods</span><span class="token operator">:</span><span class="token punctuation">{</span></span>
<span class="line">			<span class="token function-variable function">login</span><span class="token operator">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">				app<span class="token punctuation">.</span>msg<span class="token operator">=</span><span class="token string">&quot;正在登录&quot;</span><span class="token punctuation">;</span></span>
<span class="line">				axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/api/oauth/login?username=&quot;</span><span class="token operator">+</span>app<span class="token punctuation">.</span>username<span class="token operator">+</span><span class="token string">&quot;&amp;password=&quot;</span><span class="token operator">+</span>app<span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">					<span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>flag<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">						app<span class="token punctuation">.</span>msg<span class="token operator">=</span><span class="token string">&quot;登录成功&quot;</span><span class="token punctuation">;</span></span>
<span class="line">					<span class="token punctuation">}</span> <span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">						app<span class="token punctuation">.</span>msg<span class="token operator">=</span><span class="token string">&quot;登录失败&quot;</span><span class="token punctuation">;</span></span>
<span class="line">					<span class="token punctuation">}</span></span>
<span class="line">				<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">			<span class="token punctuation">}</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">	<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23</p><p>测试：</p><p>1geteway-web工程 com.ydles.web.gateway.filter AuthFilter。放行登陆跳转。</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">		<span class="token comment">//1判断当前请求是否为登陆，是就放行</span></span>
<span class="line">        <span class="token class-name">String</span> path <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;/api/oauth/login&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&quot;/api/oauth/toLogin&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//放行</span></span>
<span class="line">            <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6</p><p>2重启认证服务、客户网关</p><p>3 浏览器访问 http://localhost:8001/api/oauth/toLogin</p><p>输入itlils itlils666 ，显示登陆成功。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211124173405118.c6816cfd.png" alt="image-20211124173405118"></p><p>5F12查看浏览器cookie</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211124173431500.0df84f16.png" alt="image-20211124173431500"></p><p>6查看redis</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211124173445773.8cfedc06.png" alt="image-20211124173445773"></p><h2 id="_8自定义路径过滤器" tabindex="-1"><a class="header-anchor" href="#_8自定义路径过滤器"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_8%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B7%AF%E5%BE%84%E8%BF%87%E6%BB%A4%E5%99%A8" target="_blank" rel="noopener noreferrer">#</a><strong>8自定义路径过滤器</strong></span></a></h2><p>1需求：许多url我们需要经行令牌校验，许多url不需要。所以写一个工具类判断。</p><p>2写一个工具类，判断url是否需要过滤。com.ydles.web.gateway.filter</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>web<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>utils</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * @Created by IT李老师</span>
<span class="line"> * 公主号 “IT李哥交朋友”</span>
<span class="line"> * 个人微 itlils</span>
<span class="line"> */</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UrlUtil</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//哪些路径需要令牌</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> filterPath <span class="token operator">=</span> <span class="token string">&quot;/api/wseckillorder,/api/seckill,/api/wxpay,/api/wxpay/**,/api/worder/**,/api/user/**,/api/address/**,/api/wcart/**,/api/cart/**,/api/categoryReport/**,/api/orderConfig/**,/api/order/**,/api/orderItem/**,/api/orderLog/**,/api/preferential/**,/api/returnCause/**,/api/returnOrder/**,/api/returnOrderItem/**&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//传来一个路径 需不需要令牌</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">hasAuthorize</span><span class="token punctuation">(</span><span class="token class-name">String</span> url<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> split <span class="token operator">=</span> filterPath<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;**&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> s <span class="token operator">:</span> split<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25</p><p>3AuthFilter优化</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">        <span class="token comment">//1.1登陆时：放行</span></span>
<span class="line">        <span class="token class-name">String</span> path <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// /oauth/login</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;path:&quot;</span><span class="token operator">+</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">UrlUtil</span><span class="token punctuation">.</span><span class="token function">hasAuthorize</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//放行</span></span>
<span class="line">            <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><p>总结：</p><p>1登陆</p><p>登陆与鉴权 5张表</p><p>单点登录sso spring cas Shiro</p><p>第三方登录 oauth2</p><p>2jwt</p><p>构成 base64(头{}).base64(负载{}).sha256(前两部分，secret)</p><p>secret------&gt;私钥 jks</p><p>公钥 public.txt</p><p>3oauth2</p><p>授权码</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211122104426755.a59ac96f.png" alt="image-20211122104426755"></p><p>密码</p><p>postman 测试</p><p>4认证开发</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211124121822950.8a6e9f47.png" alt="image-20211124121822950"></p><p>作业：退出</p><p>5自定义登录页面</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211124163728345.fd40bc02.png" alt="image-20211124163728345"></p><p>路径过滤器</p><h2 id="第10章-购物车" tabindex="-1"><a class="header-anchor" href="#第10章-购物车"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#%E7%AC%AC10%E7%AB%A0-%E8%B4%AD%E7%89%A9%E8%BD%A6" target="_blank" rel="noopener noreferrer">#</a>第10章 购物车</span></a></h2><p><strong>角色</strong>：购物车模块后台工程师</p><h2 id="学习目标-2" tabindex="-1"><a class="header-anchor" href="#学习目标-2"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87-2" target="_blank" rel="noopener noreferrer">#</a>学习目标</span></a></h2><ul><li>能够通过SpringSecurity进行权限控制</li><li>掌握购物车流程</li><li>掌握购物车渲染</li><li>微服务之间的认证访问</li></ul><h2 id="_1-springsecurity权限控制-鉴权" tabindex="-1"><a class="header-anchor" href="#_1-springsecurity权限控制-鉴权"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_1-springsecurity%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6-%E9%89%B4%E6%9D%83" target="_blank" rel="noopener noreferrer">#</a>1 SpringSecurity权限控制 鉴权</span></a></h2><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211124232357515.0c3958a3.png" alt="image-20211124232357515"></p><p>用户每次访问微服务的时候，先去oauth2.0服务登录，登录后再访问微服务网关，微服务网关将请求转发给其他微服务处理。</p><p>由于我们项目使用了微服务，任何用户都有可能使用任意微服务，此时我们需要控制相关权限，例如：普通用户角色不能使用用户的删除操作，只有管理员才可以使用,那么这个时候就需要使用到SpringSecurity的权限控制功能了。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">user    user_role      role   role_auth      auth </span>
<span class="line"></span>
<span class="line">user</span>
<span class="line">id    name    password</span>
<span class="line">1     itlils  itlils666</span>
<span class="line">2     itnanls nangeniubi</span>
<span class="line"></span>
<span class="line">user_role</span>
<span class="line">userid      roleid</span>
<span class="line">1 	        1</span>
<span class="line">1           2</span>
<span class="line">1           3</span>
<span class="line">2           3</span>
<span class="line"></span>
<span class="line">role </span>
<span class="line">id   name</span>
<span class="line">1    管理员</span>
<span class="line">2    运维人员</span>
<span class="line">3    客户</span>
<span class="line"></span>
<span class="line">role_auth</span>
<span class="line">roleid    authid</span>
<span class="line">1         1</span>
<span class="line">1         2</span>
<span class="line">3         1</span>
<span class="line"></span>
<span class="line">auth</span>
<span class="line">id     auth</span>
<span class="line">1      查询商品</span>
<span class="line">2      删除商品</span>
<span class="line"></span>
<span class="line">User (id:1,name:itlils,password:itlils666,rolelist[管理员, 运维人员,客户],authList[查询商品,删除商品])</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-1-角色权限加载" tabindex="-1"><a class="header-anchor" href="#_1-1-角色权限加载"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_1-1-%E8%A7%92%E8%89%B2%E6%9D%83%E9%99%90%E5%8A%A0%E8%BD%BD" target="_blank" rel="noopener noreferrer">#</a>1.1 角色权限加载</span></a></h3><p>1ydles-user-oauth工程的com.ydles.oauth.confifig.UserDetailsServiceImpl该类实现了加载用户相关信息</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211124232753108.515dff9e.png" alt="image-20211124232753108"></p><p>2启动 eureka gateway_web user_oauth service_user工程</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211124232554421.a59662bc.png" alt="image-20211124232554421"></p><p>3通过网关申请令牌 POST http://localhost:8001/api/oauth/login</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211124232811751.46f050b8.png" alt="image-20211124232811751"></p><p>4 解析jwt</p><p>https://www.qqxiuzi.cn/bianma/base64.htm</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211124232943971.0fec9445.png" alt="image-20211124232943971"></p><h3 id="_1-2-角色权限控制" tabindex="-1"><a class="header-anchor" href="#_1-2-角色权限控制"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_1-2-%E8%A7%92%E8%89%B2%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6" target="_blank" rel="noopener noreferrer">#</a>1.2 角色权限控制</span></a></h3><p>1被调用的工程中，开启授权。如ydles-user-service工程的com.ydles.user.config.ResourceServerConfig中</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">@EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)//激活方法上的PreAuthorize注解</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211130180616128.ef390174.png" alt="image-20211130180616128"></p><p>2controller方法上添加。如ydles-user-service工程的com.ydles.user.controller findAll方法</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">@PreAuthorize(&quot;hasAnyAuthority(&#39;admin&#39;)&quot;)</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211130180636775.797ca28a.png" alt="image-20211130180636775"></p><p>3重启ydles-user-service，访问 GET http://localhost:8001/api/user/</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211130180654463.a518ba2c.png" alt="image-20211130180654463"></p><p>user服务后台</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211130180702834.e932feed.png" alt="image-20211130180702834"></p><p>4 改成能访问，findAll方法上，改为，重启user服务。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">@PreAuthorize(&quot;hasAnyAuthority(&#39;goods_list&#39;)&quot;)</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>5重新用postman访问，就能获取数据了</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211130180718000.ceaa3cbc.png" alt="image-20211130180718000"></p><p>企业开发中的用法：</p><p><strong>1</strong> 查询用户时，就把相关权限字符串一起查出来，放到jwt</p><p><strong>2</strong> 各个微服务中，每个controller的每个方法上 想要权限认证的方法才加</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">@PreAuthorize(&quot;hasAnyAuthority(&#39;goods_list&#39;)&quot;)</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p><strong>3</strong> 底层咋实现 spring securety Oauth2 框架实现。</p><h3 id="_1-3-小结" tabindex="-1"><a class="header-anchor" href="#_1-3-小结"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_1-3-%E5%B0%8F%E7%BB%93" target="_blank" rel="noopener noreferrer">#</a>1.3 小结</span></a></h3><p>如果希望一个方法能被多个角色访问，配置:<code>@PreAuthorize(&quot;hasAnyAuthority(&#39;admin&#39;,&#39;user&#39;)&quot;)</code></p><p>如果希望一个类都能被多个角色访问，在类上配置:<code>@PreAuthorize(&quot;hasAnyAuthority(&#39;admin&#39;,&#39;user&#39;)&quot;)</code></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211130180915359.f3566f83.png" alt="image-20211130180915359"></p><h2 id="_2-购物车" tabindex="-1"><a class="header-anchor" href="#_2-购物车"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_2-%E8%B4%AD%E7%89%A9%E8%BD%A6" target="_blank" rel="noopener noreferrer">#</a>2 购物车</span></a></h2><p>购物车分为用户登录购物车和未登录购物车操作</p><p>1京东用户登录和不登录都可以操作购物车，如果用户不登录，操作购物车可以将数据存储到Cookie，用户登录后购物车数据可以存储到Redis中，再将之前未登录加入的购物车合并到Redis中即可。</p><p>2淘宝天猫，用户要想将商品加入购物车，必须先登录才能操作购物车。</p><h3 id="_2-1-购物车业务分析" tabindex="-1"><a class="header-anchor" href="#_2-1-购物车业务分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_2-1-%E8%B4%AD%E7%89%A9%E8%BD%A6%E4%B8%9A%E5%8A%A1%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>2.1 购物车业务分析</span></a></h3><p><strong>我们实现天猫思路</strong></p><p>购物车需求：</p><p>1用户在商品详细页点击加入购物车，提交商品SKU编号和购买数量，添加到购物车。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211201092837615.4059ec5d.png" alt="image-20211201092837615"></p><p>2业务逻辑</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211201093507350.3adc0b8a.png" alt="image-20211201093507350"></p><p>添加和查看购物车都是去redis。</p><p>3购物车表结构：ydles_order数据中tb_order_item表</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211201093147467.bb6ceacd.png" alt="image-20211201093147467"></p><h3 id="_2-2-添加购物车" tabindex="-1"><a class="header-anchor" href="#_2-2-添加购物车"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_2-2-%E6%B7%BB%E5%8A%A0%E8%B4%AD%E7%89%A9%E8%BD%A6" target="_blank" rel="noopener noreferrer">#</a>2.2 添加购物车</span></a></h3><p>需求：订单服务远程调用商品服务</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211201093516858.28a4873f.png" alt="image-20211201093516858"></p><p>1将skucontroller的findById方法暴露</p><p>goods-api项目com.ydles.goods.feign.SkuFeign</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token comment">//skuId---&gt;sku</span></span>
<span class="line">    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/sku/{id}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Sku</span><span class="token punctuation">&gt;</span></span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3</p><p>2service-order 订单服务</p><p>导入依赖</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>           </span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ydles_service_goods_api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p>3启动类开启feign</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">&quot;com.ydles.goods.feign&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><h4 id="添加购物车-业务层实现-重点" tabindex="-1"><a class="header-anchor" href="#添加购物车-业务层实现-重点"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#%E6%B7%BB%E5%8A%A0%E8%B4%AD%E7%89%A9%E8%BD%A6-%E4%B8%9A%E5%8A%A1%E5%B1%82%E5%AE%9E%E7%8E%B0-%E9%87%8D%E7%82%B9" target="_blank" rel="noopener noreferrer">#</a>添加购物车 业务层实现-重点</span></a></h4><p>添加购物车 ：</p><p>1选择规格后的一个sku,往购物车添加。购物车redis里存着。</p><p>2相同sku可以叠加。不同sku可以都放在购物车中</p><p>3 点击加入购物车 skuid num</p><p><strong>拓展</strong>：回顾 redis 数据结构 string</p><p>value:string list set map zset</p><p>service-order 订单服务</p><p>1com.ydles.order.service.CartService</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>order<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * @Created by IT李老师</span>
<span class="line"> * 公主号 “IT李哥交朋友”</span>
<span class="line"> * 个人微 itlils</span>
<span class="line"> * 购物车服务层</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CartService</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//添加购物车</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addCart</span><span class="token punctuation">(</span><span class="token class-name">String</span> skuId<span class="token punctuation">,</span><span class="token class-name">Integer</span> num<span class="token punctuation">,</span><span class="token class-name">String</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14</p><p>2实现com.ydles.order.service.impl.CartServiceImpl</p><p>redis中数据格式</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211201102125278.cc91f9a0.png" alt="image-20211201102125278"></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>order<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>goods<span class="token punctuation">.</span>feign<span class="token punctuation">.</span></span><span class="token class-name">SkuFeign</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>goods<span class="token punctuation">.</span>feign<span class="token punctuation">.</span></span><span class="token class-name">SpuFeign</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>goods<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Sku</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>goods<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Spu</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>order<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">OrderItem</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>order<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">CartService</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">IdWorker</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RedisTemplate</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">StringRedisTemplate</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * @Created by IT李老师</span>
<span class="line"> * 公主号 “IT李哥交朋友”</span>
<span class="line"> * 个人微 itlils</span>
<span class="line"> * 缺啥补啥</span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@Service</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CartServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">CartService</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//购物车redis key 头</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CART</span> <span class="token operator">=</span> <span class="token string">&quot;cart_&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">SpuFeign</span> spuFeign<span class="token punctuation">;</span></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">SkuFeign</span> skuFeign<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//添加购物车 从购物车减一个，num=-1</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addCart</span><span class="token punctuation">(</span><span class="token class-name">String</span> skuId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> num<span class="token punctuation">,</span> <span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">String</span> orderItemStr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token constant">CART</span> <span class="token operator">+</span> username<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Sku</span> sku <span class="token operator">=</span> skuFeign<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Spu</span> spu <span class="token operator">=</span> spuFeign<span class="token punctuation">.</span><span class="token function">findSpuById</span><span class="token punctuation">(</span>sku<span class="token punctuation">.</span><span class="token function">getSpuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//判断  当前用户购物车里有没有添加的sku</span></span>
<span class="line">        <span class="token class-name">OrderItem</span> orderItem<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>orderItemStr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            orderItem <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>orderItemStr<span class="token punctuation">,</span> <span class="token class-name">OrderItem</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">//购物车里有  更新redis数据</span></span>
<span class="line">            orderItem<span class="token punctuation">.</span><span class="token function">setNum</span><span class="token punctuation">(</span>orderItem<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>orderItem<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">//总数小于1 redis删除</span></span>
<span class="line">                stringRedisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token constant">CART</span> <span class="token operator">+</span> username<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            orderItem<span class="token punctuation">.</span><span class="token function">setMoney</span><span class="token punctuation">(</span>orderItem<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> orderItem<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            orderItem<span class="token punctuation">.</span><span class="token function">setPayMoney</span><span class="token punctuation">(</span>orderItem<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> orderItem<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//满减</span></span>
<span class="line">            orderItem<span class="token punctuation">.</span><span class="token function">setWeight</span><span class="token punctuation">(</span>sku<span class="token punctuation">.</span><span class="token function">getWeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//新加入购物车的sku</span></span>
<span class="line">            orderItem <span class="token operator">=</span> <span class="token function">sku2OrderItem</span><span class="token punctuation">(</span>spu<span class="token punctuation">,</span> sku<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//放入redis</span></span>
<span class="line">        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token constant">CART</span> <span class="token operator">+</span> username<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>skuId<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>orderItem<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token class-name">IdWorker</span> idWorker<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//拼接 OrderItem</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">OrderItem</span> <span class="token function">sku2OrderItem</span><span class="token punctuation">(</span><span class="token class-name">Spu</span> spu<span class="token punctuation">,</span> <span class="token class-name">Sku</span> sku<span class="token punctuation">,</span> <span class="token class-name">Integer</span> num<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">OrderItem</span> orderItem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        orderItem<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>idWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        orderItem<span class="token punctuation">.</span><span class="token function">setCategoryId1</span><span class="token punctuation">(</span>spu<span class="token punctuation">.</span><span class="token function">getCategory1Id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        orderItem<span class="token punctuation">.</span><span class="token function">setCategoryId2</span><span class="token punctuation">(</span>spu<span class="token punctuation">.</span><span class="token function">getCategory2Id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        orderItem<span class="token punctuation">.</span><span class="token function">setCategoryId3</span><span class="token punctuation">(</span>spu<span class="token punctuation">.</span><span class="token function">getCategory3Id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        orderItem<span class="token punctuation">.</span><span class="token function">setSpuId</span><span class="token punctuation">(</span>spu<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        orderItem<span class="token punctuation">.</span><span class="token function">setSkuId</span><span class="token punctuation">(</span>sku<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        orderItem<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>sku<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        orderItem<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span>sku<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        orderItem<span class="token punctuation">.</span><span class="token function">setNum</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        orderItem<span class="token punctuation">.</span><span class="token function">setMoney</span><span class="token punctuation">(</span>sku<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        orderItem<span class="token punctuation">.</span><span class="token function">setPayMoney</span><span class="token punctuation">(</span>sku<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        orderItem<span class="token punctuation">.</span><span class="token function">setImage</span><span class="token punctuation">(</span>sku<span class="token punctuation">.</span><span class="token function">getImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        orderItem<span class="token punctuation">.</span><span class="token function">setWeight</span><span class="token punctuation">(</span>sku<span class="token punctuation">.</span><span class="token function">getWeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> orderItem<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87</p><h4 id="订单服务添加cartservice-实现添加购物车" tabindex="-1"><a class="header-anchor" href="#订单服务添加cartservice-实现添加购物车"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1%E6%B7%BB%E5%8A%A0cartservice-%E5%AE%9E%E7%8E%B0%E6%B7%BB%E5%8A%A0%E8%B4%AD%E7%89%A9%E8%BD%A6" target="_blank" rel="noopener noreferrer">#</a>订单服务添加cartService，实现添加购物车</span></a></h4><p>1 service-order工程 com.ydles.order.controller</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@RestController</span></span>
<span class="line"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/cart&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CartController</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">CartService</span> cartService<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">TokenDecode</span> tokenDecode<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/addCart&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">addCart</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> skuId<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> num<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//动态获取当前人信息,暂时静态</span></span>
<span class="line">        <span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token string">&quot;itlils&quot;</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        cartService<span class="token punctuation">.</span><span class="token function">addCart</span><span class="token punctuation">(</span>skuId<span class="token punctuation">,</span>num<span class="token punctuation">,</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span><span class="token string">&quot;加入购物车成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21</p><p>redis配置</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">spring:</span>
<span class="line">  redis:</span>
<span class="line">    host: 192.168.200.128</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3</p><p>网关配置</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">           #订单微服务</span>
<span class="line">        - id: ydles_order_route</span>
<span class="line">          uri: lb://order</span>
<span class="line">          predicates:</span>
<span class="line">            - Path=/api/cart/**,/api/cart</span>
<span class="line">          filters:</span>
<span class="line">            - StripPrefix=1</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><p>2启动 service-order、service-good,gateway_web</p><p>3通过网关访问服务 http://localhost:8001/api/cart/addCart?skuId=1450868238861729792&amp;num=5</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211201104528001.9f482dd0.png" alt="image-20211201104528001"></p><p>4redis检查</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211201104539261.666eecfc.png" alt="image-20211201104539261"></p><h3 id="_2-4-购物车列表" tabindex="-1"><a class="header-anchor" href="#_2-4-购物车列表"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_2-4-%E8%B4%AD%E7%89%A9%E8%BD%A6%E5%88%97%E8%A1%A8" target="_blank" rel="noopener noreferrer">#</a>2.4 购物车列表</span></a></h3><p>需求：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211201105212361.8ea00520.png" alt="image-20211201105212361"></p><h4 id="_2-4-1-思路分析" tabindex="-1"><a class="header-anchor" href="#_2-4-1-思路分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_2-4-1-%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>2.4.1 思路分析</span></a></h4><p>接着我们实现一次购物车列表操作。因为存的时候是根据用户名往Redis中存储用户的购物车数据的，所以我们这里可以将用户的名字作为key去Redis中查询对应的数据。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211201105337532.61c750ef.png" alt="image-20211201105337532"></p><h4 id="_3-4-2-代码实现" tabindex="-1"><a class="header-anchor" href="#_3-4-2-代码实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-4-2-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>3.4.2 代码实现</span></a></h4><p>1service-order 订单服务 com.ydles.order.service.CartService</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token comment">//查询购物车数据</span></span>
<span class="line">    <span class="token class-name">Map</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><p>2 实现类com.ydles.order.service.impl.CartServiceImpl 中增加</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">//查询购物车列表数据</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Map</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Map</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItem</span><span class="token punctuation">&gt;</span></span> orderItemList <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundHashOps</span><span class="token punctuation">(</span><span class="token constant">CART</span> <span class="token operator">+</span> username<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;orderItemList&quot;</span><span class="token punctuation">,</span>orderItemList<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//商品的总数量与总价格</span></span>
<span class="line">        <span class="token class-name">Integer</span> totalNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Integer</span> totalMoney <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">OrderItem</span> orderItem <span class="token operator">:</span> orderItemList<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            totalNum<span class="token operator">+=</span>orderItem<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            totalMoney<span class="token operator">+=</span>orderItem<span class="token punctuation">.</span><span class="token function">getMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;totalNum&quot;</span><span class="token punctuation">,</span>totalNum<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;totalMoney&quot;</span><span class="token punctuation">,</span>totalMoney<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> map<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22</p><p>3控制层</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/***</span>
<span class="line"> * 查询用户购物车列表</span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line">*/</span></span>
<span class="line"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/list&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Map</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//暂时静态，后续修改</span></span>
<span class="line">    <span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token string">&quot;itcast&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> cartService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10</p><p>4测试</p><p>使用Postman访问 GET http://localhost:8001/api/cart/list ,效果如下：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211201110522115.9cbd17ff.png" alt="image-20211201110522115"></p><h2 id="_3-购物车渲染" tabindex="-1"><a class="header-anchor" href="#_3-购物车渲染"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-%E8%B4%AD%E7%89%A9%E8%BD%A6%E6%B8%B2%E6%9F%93" target="_blank" rel="noopener noreferrer">#</a>3 购物车渲染</span></a></h2><p><strong>需求</strong>：展现如下页面</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211201105212361.8ea00520.png" alt="image-20211201105212361"></p><p><strong>思路分析</strong></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211201115148021.95f9e24e.png" alt="image-20211201115148021"></p><p>如上图所示,用户每次将商品加入购物车，或者点击购物车列表的时候，先经过订单购物车后端渲染服务，再通过feign调用购物车订单微服务来实现购物车的操作，例如：加入购物车、购物车列表。</p><h3 id="_3-1-购物车渲染服务搭建" tabindex="-1"><a class="header-anchor" href="#_3-1-购物车渲染服务搭建"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-1-%E8%B4%AD%E7%89%A9%E8%BD%A6%E6%B8%B2%E6%9F%93%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BA" target="_blank" rel="noopener noreferrer">#</a>3.1 购物车渲染服务搭建</span></a></h3><p>在ydles_web中搭建订单购物车微服务工程<code>ydles_web_order</code>，该工程主要实现购物车和订单的渲染操作。</p><p>在ydles_web中搭建订单购物车微服务工程 ydles_web_order</p><p>(1) pom.xml依赖</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">&quot;</span></span></span>
<span class="line">         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span></span>
<span class="line">         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ydles-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ydles_web_order<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">&lt;!--依赖--&gt;</span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ydles_service_order_api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ydles_common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-thymeleaf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30</p><p>(2)application.yml配置</p><div class="language-properties line-numbers-mode" data-highlighter="prismjs" data-ext="properties" data-title="properties"><pre><code><span class="line"><span class="token key attr-name">server</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token key attr-name">  port</span><span class="token punctuation">:</span> <span class="token value attr-value">9111</span></span>
<span class="line"><span class="token key attr-name">spring</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token key attr-name">  application</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token key attr-name">    name</span><span class="token punctuation">:</span> <span class="token value attr-value">order-web</span></span>
<span class="line"><span class="token key attr-name">  main</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token key attr-name">    allow-bean-definition-overriding</span><span class="token punctuation">:</span> <span class="token value attr-value">true   #当遇到同样名字的时候，是否允许覆盖注册</span></span>
<span class="line"><span class="token key attr-name">  thymeleaf</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token key attr-name">    cache</span><span class="token punctuation">:</span> <span class="token value attr-value">false</span></span>
<span class="line"><span class="token key attr-name">eureka</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token key attr-name">  client</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token key attr-name">    service-url</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token key attr-name">      defaultZone</span><span class="token punctuation">:</span> <span class="token value attr-value">http://127.0.0.1:6868/eureka</span></span>
<span class="line"><span class="token key attr-name">  instance</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token key attr-name">    prefer-ip-address</span><span class="token punctuation">:</span> <span class="token value attr-value">true</span></span>
<span class="line"><span class="token key attr-name">feign</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token key attr-name">  hystrix</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token key attr-name">    enabled</span><span class="token punctuation">:</span> <span class="token value attr-value">true</span></span>
<span class="line"><span class="token key attr-name">  client</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token key attr-name">    config</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token key attr-name">      default</span><span class="token punctuation">:</span>   <span class="token value attr-value">#配置全局的feign的调用超时时间  如果 有指定的服务配置 默认的配置不会生效</span></span>
<span class="line"><span class="token key attr-name">        connectTimeout</span><span class="token punctuation">:</span> <span class="token value attr-value">60000 # 指定的是 消费者 连接服务提供者的连接超时时间 是否能连接  单位是毫秒</span></span>
<span class="line"><span class="token key attr-name">        readTimeout</span><span class="token punctuation">:</span> <span class="token value attr-value">80000  # 指定的是调用服务提供者的 服务 的超时时间（）  单位是毫秒</span></span>
<span class="line"><span class="token comment">#hystrix 配置</span></span>
<span class="line"><span class="token key attr-name">hystrix</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token key attr-name">  command</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token key attr-name">    default</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token key attr-name">      execution</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token key attr-name">        timeout</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token comment">          #如果enabled设置为false，则请求超时交给ribbon控制</span></span>
<span class="line"><span class="token key attr-name">          enabled</span><span class="token punctuation">:</span> <span class="token value attr-value">true</span></span>
<span class="line"><span class="token key attr-name">        isolation</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token key attr-name">          strategy</span><span class="token punctuation">:</span> <span class="token value attr-value">SEMAPHORE</span></span>
<span class="line"><span class="token key attr-name">          thread</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token comment">            # 熔断器超时时间，默认：1000/毫秒</span></span>
<span class="line"><span class="token key attr-name">            timeoutInMilliseconds</span><span class="token punctuation">:</span> <span class="token value attr-value">80000</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36</p><p>(3)创建启动类</p><p>创建com.ydles.OrderWebApplication启动类，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@SpringBootApplication</span></span>
<span class="line"><span class="token annotation punctuation">@EnableEurekaClient</span></span>
<span class="line"><span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">&quot;com.ydles.order.feign&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderWebApplication</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">OrderWebApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9</p><p>(4)静态资源拷贝</p><p>资源\成品页面\cart.html页面拷贝到工程中，如下图：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211201115740089.30c7b78a.png" alt="image-20211201115740089"></p><h3 id="_3-2-购物车列表渲染" tabindex="-1"><a class="header-anchor" href="#_3-2-购物车列表渲染"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-2-%E8%B4%AD%E7%89%A9%E8%BD%A6%E5%88%97%E8%A1%A8%E6%B8%B2%E6%9F%93" target="_blank" rel="noopener noreferrer">#</a>3.2 购物车列表渲染</span></a></h3><h4 id="_3-2-1-feign创建" tabindex="-1"><a class="header-anchor" href="#_3-2-1-feign创建"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-2-1-feign%E5%88%9B%E5%BB%BA" target="_blank" rel="noopener noreferrer">#</a>3.2.1 Feign创建</span></a></h4><p>1 ydles_service_order_api中添加CartFeign接口，并在接口中创建添加购物车和查询购物车列表，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CartFeign</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 添加购物车</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">skuId</span></span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">num</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/cart/add&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> skuId<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/***</span>
<span class="line">     * 查询用户购物车列表</span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/cart/list&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Map</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19</p><p>2 导包</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ydles_common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p>3controller</p><p>在ydles_web_order中创建com.ydles.order.controller.CartController,并添加查询购物车集合方法和添加购物车方法，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Controller</span></span>
<span class="line"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/wcart&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CartController</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">//查询</span></span>
<span class="line">    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/list&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token class-name">Model</span> model<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Map</span> map <span class="token operator">=</span> cartFeign<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;items&quot;</span><span class="token punctuation">,</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">&quot;cart&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//添加</span></span>
<span class="line">    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/add&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token annotation punctuation">@ResponseBody</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&gt;</span></span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">,</span><span class="token class-name">Integer</span> num<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        cartFeign<span class="token punctuation">.</span><span class="token function">addCart</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Map</span> map <span class="token operator">=</span> cartFeign<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span><span class="token string">&quot;添加购物车成功&quot;</span><span class="token punctuation">,</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23</p><h4 id="_3-2-3-前端页面" tabindex="-1"><a class="header-anchor" href="#_3-2-3-前端页面"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-2-3-%E5%89%8D%E7%AB%AF%E9%A1%B5%E9%9D%A2" target="_blank" rel="noopener noreferrer">#</a>3.2.3 前端页面</span></a></h4><p>1资料的static和template放入resources下。</p><p>改造静态页面</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">2  &lt;html xmlns:th=&quot;http://www.thymeleaf.org&quot;&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">13-14 	</span>
<span class="line">	&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;/css/all.css&quot; /&gt;</span>
<span class="line">	&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;/css/pages-cart.css&quot; /&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">86 &lt;div class=&quot;cart py-container&quot; id=&quot;app&quot;&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">124-128</span>
<span class="line">					&lt;li class=&quot;yui3-u-1-8&quot;&gt;</span>
<span class="line">									&lt;a href=&quot;javascript:void(0)&quot; class=&quot;increment mins&quot; @click=&quot;add(item.skuId,-1)&quot;&gt;-&lt;/a&gt;</span>
<span class="line">									&lt;input autocomplete=&quot;off&quot; type=&quot;text&quot; v-model=&quot;item.num&quot; @blur=&quot;add(item.skuId,item.num)&quot; minnum=&quot;1&quot; class=&quot;itxt&quot; /&gt;</span>
<span class="line">									&lt;a href=&quot;javascript:void(0)&quot; class=&quot;increment plus&quot; @click=&quot;add(item.skuId,1)&quot;&gt;+&lt;/a&gt;</span>
<span class="line">								&lt;/li&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">362</span>
<span class="line">&lt;script th:inline=&quot;javascript&quot;&gt;</span>
<span class="line">		var app = new Vue({</span>
<span class="line">			el:&quot;#app&quot;,</span>
<span class="line">			data:{</span>
<span class="line">				items:[[${items}]]</span>
<span class="line">			},</span>
<span class="line">			methods:{</span>
<span class="line">				add:function (skuId,num) {</span>
<span class="line">					axios.get(&quot;/api/wcart/add?skuId=&quot;+skuId+&quot;&amp;num=&quot;+num).then(function (resp) {</span>
<span class="line">						if (resp.data.flag){</span>
<span class="line">							app.items=resp.data.data;</span>
<span class="line">						}</span>
<span class="line">					})</span>
<span class="line">				}</span>
<span class="line">			}</span>
<span class="line">		})</span>
<span class="line">	&lt;/script&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18</p><p>2若想访问页面渲染微服务，需修改网关配置 gateway-web，增加路由</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line">        <span class="token comment">#订单微服务</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> ydles_order_route</span>
<span class="line">          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//order</span>
<span class="line">          <span class="token key atrule">predicates</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> Path=/api/cart/<span class="token important">**</span><span class="token punctuation">,</span>/api/categoryReport/<span class="token important">**</span><span class="token punctuation">,</span>/api/orderConfig/<span class="token important">**</span><span class="token punctuation">,</span>/api/order/<span class="token important">**</span><span class="token punctuation">,</span>/api/orderItem/<span class="token important">**</span><span class="token punctuation">,</span>/api/orderLog/<span class="token important">**</span><span class="token punctuation">,</span>/api/preferential/<span class="token important">**</span><span class="token punctuation">,</span>/api/returnCause/<span class="token important">**</span><span class="token punctuation">,</span>/api/returnOrder/<span class="token important">**</span><span class="token punctuation">,</span>/api/returnOrderItem/<span class="token important">**</span></span>
<span class="line">          <span class="token key atrule">filters</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> StripPrefix=1</span>
<span class="line">        <span class="token comment">#购物车订单渲染微服务</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> ydles_order_web_route</span>
<span class="line">          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//order<span class="token punctuation">-</span>web</span>
<span class="line">          <span class="token key atrule">predicates</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> Path=/api/wcart/<span class="token important">**</span><span class="token punctuation">,</span>/api/worder/<span class="token important">**</span></span>
<span class="line">          <span class="token key atrule">filters</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> StripPrefix=1</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14</p><p>3启动相关微服务</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211201150753038.185c7534.png" alt="image-20211201150753038"></p><p>4先登陆 http://localhost:8001/api/oauth/toLogin itlils itlils666</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211201150837829.3ca2dcd7.png" alt="image-20211201150837829"></p><p>登陆成功</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211201150743386.a00268ad.png" alt="image-20211201150743386"></p><p>5 通过网关访问 购物车页面 http://localhost:8001/api/wcart/list</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211201154539067.d070de95.png" alt="image-20211201154539067"></p><h4 id="_3-2-4-微服务之间的认证访问-购物车渲染服务、订单服务对接网关" tabindex="-1"><a class="header-anchor" href="#_3-2-4-微服务之间的认证访问-购物车渲染服务、订单服务对接网关"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-2-4-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B9%8B%E9%97%B4%E7%9A%84%E8%AE%A4%E8%AF%81%E8%AE%BF%E9%97%AE-%E8%B4%AD%E7%89%A9%E8%BD%A6%E6%B8%B2%E6%9F%93%E6%9C%8D%E5%8A%A1%E3%80%81%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1%E5%AF%B9%E6%8E%A5%E7%BD%91%E5%85%B3" target="_blank" rel="noopener noreferrer">#</a>3.2.4 微服务之间的认证访问 购物车渲染服务、订单服务对接网关</span></a></h4><p>1<strong>订单服务对接oauth</strong></p><p>1配置公钥</p><p>将ydles_user_oauth项目的public.key拷贝到ydles_service_order项目的resource目录下</p><p>2ydles_service_order项目添加oauth依赖</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-oauth2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p>3ydles_service_order项目添加添加配置类</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Configuration</span></span>
<span class="line"><span class="token annotation punctuation">@EnableResourceServer</span></span>
<span class="line"><span class="token comment">//开启方法上的PreAuthorize注解</span></span>
<span class="line"><span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>prePostEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> securedEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ResourceServerConfig</span> <span class="token keyword">extends</span> <span class="token class-name">ResourceServerConfigurerAdapter</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//公钥</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PUBLIC_KEY</span> <span class="token operator">=</span> <span class="token string">&quot;public.key&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/***</span>
<span class="line">     * 定义JwtTokenStore</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">jwtAccessTokenConverter</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@Bean</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">TokenStore</span> <span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token class-name">JwtAccessTokenConverter</span> jwtAccessTokenConverter<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JwtTokenStore</span><span class="token punctuation">(</span>jwtAccessTokenConverter<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/***</span>
<span class="line">     * 定义JJwtAccessTokenConverter</span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@Bean</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">JwtAccessTokenConverter</span> <span class="token function">jwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">JwtAccessTokenConverter</span> converter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        converter<span class="token punctuation">.</span><span class="token function">setVerifierKey</span><span class="token punctuation">(</span><span class="token function">getPubKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> converter<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 获取非对称加密公钥 Key</span>
<span class="line">     * <span class="token keyword">@return</span> 公钥 Key</span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getPubKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Resource</span> resource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token constant">PUBLIC_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">InputStreamReader</span> inputStreamReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">BufferedReader</span> br <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span>inputStreamReader<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> br<span class="token punctuation">.</span><span class="token function">lines</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ioe<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/***</span>
<span class="line">     * Http安全配置，对每个到达系统的http请求链接进行校验</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">http</span></span>
<span class="line">     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//所有请求必须认证通过</span></span>
<span class="line">        http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span></span>
<span class="line">                <span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//其他地址需要认证授权</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57</p><h3 id="_3-3-微服务间认证-面试重点" tabindex="-1"><a class="header-anchor" href="#_3-3-微服务间认证-面试重点"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-3-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%97%B4%E8%AE%A4%E8%AF%81-%E9%9D%A2%E8%AF%95%E9%87%8D%E7%82%B9" target="_blank" rel="noopener noreferrer">#</a>3.3 微服务间认证-面试重点</span></a></h3><p>因为微服务之间并没有传递头文件，所以我们可以定义一个拦截器，每次微服务调用之前都先检查下头文件，将请求的头文件中的令牌数据再放入到header中，再调用其他微服务即可。</p><p>测试访问购物车，产生如下效果：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211201155307611.35356bd5.png" alt="image-20211201155307611"></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211201155318108.c56c5d1d.png" alt="image-20211201155318108"></p><p>feign拦截器实现微服务间认证</p><p>1创建拦截器</p><p>在ydles_common服务中创建一个com.ydles.interceptor.FeignInterceptor拦截器，并将所有头文件数据再次加入到Feign请求的微服务头文件中，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>interceptor</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">feign<span class="token punctuation">.</span></span><span class="token class-name">RequestInterceptor</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">feign<span class="token punctuation">.</span></span><span class="token class-name">RequestTemplate</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>context<span class="token punctuation">.</span>request<span class="token punctuation">.</span></span><span class="token class-name">RequestAttributes</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>context<span class="token punctuation">.</span>request<span class="token punctuation">.</span></span><span class="token class-name">RequestContextHolder</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>context<span class="token punctuation">.</span>request<span class="token punctuation">.</span></span><span class="token class-name">ServletRequestAttributes</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Enumeration</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * @Created by IT李老师</span>
<span class="line"> * 公主号 “IT李哥交朋友”</span>
<span class="line"> * 个人微 itlils</span>
<span class="line"> * feign拦截器    只要feign远程调用，作用：把上一次请求头jwt带到这一次请求中</span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeignInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">RequestInterceptor</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">RequestTemplate</span> requestTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//1拿到上一层请求头中的jwt</span></span>
<span class="line">        <span class="token comment">//这一次整体请求</span></span>
<span class="line">        <span class="token class-name">RequestAttributes</span> requestAttributes <span class="token operator">=</span> <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span>requestAttributes<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//拿到我们常用的这个请求</span></span>
<span class="line">            <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ServletRequestAttributes</span><span class="token punctuation">)</span> requestAttributes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">//请所有的求头</span></span>
<span class="line">                <span class="token class-name">Enumeration</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> headerNames <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeaderNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">//遍历</span></span>
<span class="line">                <span class="token keyword">while</span> <span class="token punctuation">(</span>headerNames<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token class-name">String</span> headName <span class="token operator">=</span> headerNames<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">if</span><span class="token punctuation">(</span>headName<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                        <span class="token class-name">String</span> jwt <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span>headName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Bearer jwt</span></span>
<span class="line">                        <span class="token comment">//2jwt 带到这一次 feign调用中</span></span>
<span class="line">                        requestTemplate<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span>headName<span class="token punctuation">,</span>jwt<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51</p><p>2 更改ydles_order_web启动类，添加拦截器声明</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Bean</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">FeignInterceptor</span> <span class="token function">feignInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FeignInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p>测试：通过网关访问 购物车页面 http://localhost:8001/api/wcart/list</p><p><strong>重点理解</strong>：谁用feign，拦截器就放在谁启动类里。</p><h3 id="_3-4-动态获取当前登陆人" tabindex="-1"><a class="header-anchor" href="#_3-4-动态获取当前登陆人"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-4-%E5%8A%A8%E6%80%81%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E7%99%BB%E9%99%86%E4%BA%BA" target="_blank" rel="noopener noreferrer">#</a>3.4 动态获取当前登陆人</span></a></h3><p>1添加资源中的TokenDecode工具类到ydles-service-order微服务config包下，用于解密令牌信息</p><p>2在ydles-common工程中引入鉴权包</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token comment">&lt;!--鉴权--&gt;</span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.jsonwebtoken<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jjwt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.9.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>provided<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><p>3order 服务增加bean对象</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">@Bean</span>
<span class="line">public TokenDecode tokenDecode() {</span>
<span class="line">    return new TokenDecode();</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4在CartController中注入TokenDecode，并调用TokenDecode的getUserInfo方法获取用户信息，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">TokenDecode</span> tokenDecode<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/addCart&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">addCart</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> skuId<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> num<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//动态获取当前人信息,暂时静态</span></span>
<span class="line">        <span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token string">&quot;itcast&quot;</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// String username = tokenDecode.getUserInfo().get(&quot;username&quot;);</span></span>
<span class="line">        cartService<span class="token punctuation">.</span><span class="token function">addCart</span><span class="token punctuation">(</span>skuId<span class="token punctuation">,</span>num<span class="token punctuation">,</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span><span class="token string">&quot;加入购物车成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/list&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Map</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//动态获取当前人信息,暂时静态</span></span>
<span class="line">        <span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token string">&quot;itcast&quot;</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// String username = tokenDecode.getUserInfo().get(&quot;username&quot;);</span></span>
<span class="line">        <span class="token class-name">Map</span> map <span class="token operator">=</span> cartService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> map<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21</p><h3 id="_3-5-页面配置" tabindex="-1"><a class="header-anchor" href="#_3-5-页面配置"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-5-%E9%A1%B5%E9%9D%A2%E9%85%8D%E7%BD%AE" target="_blank" rel="noopener noreferrer">#</a>3.5 页面配置</span></a></h3><h4 id="_3-5-1-未登录时登录跳转" tabindex="-1"><a class="header-anchor" href="#_3-5-1-未登录时登录跳转"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-5-1-%E6%9C%AA%E7%99%BB%E5%BD%95%E6%97%B6%E7%99%BB%E5%BD%95%E8%B7%B3%E8%BD%AC" target="_blank" rel="noopener noreferrer">#</a>3.5.1 未登录时登录跳转</span></a></h4><p>在用户没有登录的情况下，直接访问购物车页面，效果如下：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211201162900005.51e75c1c.png" alt="image-20211201162900005"></p><p>我们可以发现，返回的只是个错误状态码，这个毫无意义，我们应该重定向到登录页面，让用户登录，我们可以修改网关的头文件，让用户每次没登录的时候，都跳转到登录页面。</p><p>修改ydles-gateway-web的<code>com.ydles.filter.AuthFilter</code>，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token class-name">Authorization</span> <span class="token operator">=</span> <span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//登录地址</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">LOGIN_URL</span> <span class="token operator">=</span> <span class="token string">&quot;http://localhost:8001/api/oauth/toLogin&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">AuthService</span> authService<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//获取当前请求对象</span></span>
<span class="line">        <span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">ServerHttpResponse</span> response <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">String</span> path <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;/api/oauth/login&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token class-name">UrlFilter</span><span class="token punctuation">.</span><span class="token function">hasAuthorize</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//放行</span></span>
<span class="line">            <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//判断cookie上是否存在jti也就是短令牌</span></span>
<span class="line">        <span class="token class-name">String</span> jti <span class="token operator">=</span> authService<span class="token punctuation">.</span><span class="token function">getJtiFromCookie</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>jti<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//拒绝访问,请求跳转</span></span>
<span class="line"><span class="token comment">//            response.setStatusCode(HttpStatus.UNAUTHORIZED);</span></span>
<span class="line"><span class="token comment">//            return response.setComplete();</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toLoginPage</span><span class="token punctuation">(</span><span class="token constant">LOGIN_URL</span><span class="token punctuation">,</span> exchange<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//根据短令牌获取长令牌, 并且判断是否有长令牌</span></span>
<span class="line">        <span class="token class-name">String</span> token <span class="token operator">=</span> authService<span class="token punctuation">.</span><span class="token function">getTokenFromRedis</span><span class="token punctuation">(</span>jti<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//拒绝访问，请求跳转</span></span>
<span class="line"><span class="token comment">//            response.setStatusCode(HttpStatus.UNAUTHORIZED);</span></span>
<span class="line"><span class="token comment">//            return response.setComplete();</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toLoginPage</span><span class="token punctuation">(</span><span class="token constant">LOGIN_URL</span><span class="token punctuation">,</span> exchange<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//校验通过 , 请求头增强，放行(将长令牌放入请求头)</span></span>
<span class="line">        request<span class="token punctuation">.</span><span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token class-name">Authorization</span><span class="token punctuation">,</span><span class="token string">&quot;Bearer &quot;</span><span class="token operator">+</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 跳转到登录页面</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">loginUrl</span>  跳转的地址</span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">toLoginPage</span><span class="token punctuation">(</span><span class="token class-name">String</span> loginUrl<span class="token punctuation">,</span> <span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">ServerHttpResponse</span> response <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        response<span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">SEE_OTHER</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        response<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;Location&quot;</span><span class="token punctuation">,</span> loginUrl<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">setComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63</p><p>测试：访问：http://localhost:8001/api/wcart/list</p><p>拓展：</p><p>http code</p><p>2 200 201 请求没问题</p><p>3 303 请求没问题，但是需要客户端往外做一些东西</p><p>4 404 客户端的问题</p><p>5 服务器端有问题了</p><h4 id="_3-5-2-登录成功跳转原地址" tabindex="-1"><a class="header-anchor" href="#_3-5-2-登录成功跳转原地址"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/02/#_3-5-2-%E7%99%BB%E5%BD%95%E6%88%90%E5%8A%9F%E8%B7%B3%E8%BD%AC%E5%8E%9F%E5%9C%B0%E5%9D%80" target="_blank" rel="noopener noreferrer">#</a>3.5.2 登录成功跳转原地址</span></a></h4><p>刚才已经实现了未登录时跳转登录页，但是当登录成功后，并没有跳转到用户本来要访问的页面。</p><p>要实现这个功能的话，可以将用户要访问的页面作为参数传递到登录控制器，由登录控制器根据参数完成路径跳转。</p><p>2.1修改网关携带当前访问URI</p><p>修改ydles-gateway-web的<code>com.ydles.filter.AuthFilter</code>，在之前的URL后面添加ReturnUrl参数以及ReturnUrl参数的值为<code>request.getURI()</code>，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//获取当前请求对象</span></span>
<span class="line">    <span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">ServerHttpResponse</span> response <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token class-name">String</span> path <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;/api/oauth/login&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token class-name">UrlFilter</span><span class="token punctuation">.</span><span class="token function">hasAuthorize</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//放行</span></span>
<span class="line">        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//判断cookie上是否存在jti也就是短令牌</span></span>
<span class="line">    <span class="token class-name">String</span> jti <span class="token operator">=</span> authService<span class="token punctuation">.</span><span class="token function">getJtiFromCookie</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>jti<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//拒绝访问,请求跳转</span></span>
<span class="line">        <span class="token comment">//            response.setStatusCode(HttpStatus.UNAUTHORIZED);</span></span>
<span class="line">        <span class="token comment">//            return response.setComplete();</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toLoginPage</span><span class="token punctuation">(</span><span class="token constant">LOGIN_URL</span> <span class="token operator">+</span> <span class="token string">&quot;?FROM=&quot;</span> <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exchange<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//根据短令牌获取长令牌, 并且判断是否有长令牌</span></span>
<span class="line">    <span class="token class-name">String</span> token <span class="token operator">=</span> authService<span class="token punctuation">.</span><span class="token function">getTokenFromRedis</span><span class="token punctuation">(</span>jti<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//拒绝访问，请求跳转</span></span>
<span class="line">        <span class="token comment">//            response.setStatusCode(HttpStatus.UNAUTHORIZED);</span></span>
<span class="line">        <span class="token comment">//            return response.setComplete();</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toLoginPage</span><span class="token punctuation">(</span><span class="token constant">LOGIN_URL</span> <span class="token operator">+</span> <span class="token string">&quot;?FROM=&quot;</span> <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exchange<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">//........略</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31</p><p>2.2 登录控制器获取参数</p><p>修改ydles-user-oauth的<code>com.ydles.oauth.controller.AuthController</code>记录访问来源页，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/toLogin&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toLogin</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;FROM&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> from<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span></span>
<span class="line">     model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;from&quot;</span><span class="token punctuation">,</span>from<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">     <span class="token keyword">return</span> <span class="token string">&quot;login&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p>2.3修改登陆页面 login.html</p><div class="language-html line-numbers-mode" data-highlighter="prismjs" data-ext="html" data-title="html"><pre><code><span class="line">167 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name"><span class="token namespace">th:</span>inline</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>javascript<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript"></span>
<span class="line">	<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">		<span class="token literal-property property">el</span><span class="token operator">:</span><span class="token string">&quot;#app&quot;</span><span class="token punctuation">,</span></span>
<span class="line">		<span class="token literal-property property">data</span><span class="token operator">:</span><span class="token punctuation">{</span></span>
<span class="line">			<span class="token literal-property property">username</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span></span>
<span class="line">			<span class="token literal-property property">password</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span></span>
<span class="line">			<span class="token literal-property property">msg</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span></span>
<span class="line">			<span class="token literal-property property">from</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">[</span>$<span class="token punctuation">{</span>from<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span></span>
<span class="line">		<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">		<span class="token literal-property property">methods</span><span class="token operator">:</span><span class="token punctuation">{</span></span>
<span class="line">			<span class="token function-variable function">login</span><span class="token operator">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">				app<span class="token punctuation">.</span>msg<span class="token operator">=</span><span class="token string">&quot;正在登录&quot;</span><span class="token punctuation">;</span></span>
<span class="line">				axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/api/oauth/login?username=&quot;</span><span class="token operator">+</span>app<span class="token punctuation">.</span>username<span class="token operator">+</span><span class="token string">&quot;&amp;password=&quot;</span><span class="token operator">+</span>app<span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">					<span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>flag<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">						app<span class="token punctuation">.</span>msg<span class="token operator">=</span><span class="token string">&quot;登录成功&quot;</span><span class="token punctuation">;</span></span>
<span class="line">						<span class="token comment">//跳转原地址</span></span>
<span class="line">						location<span class="token punctuation">.</span>href<span class="token operator">=</span>app<span class="token punctuation">.</span>from<span class="token punctuation">;</span></span>
<span class="line">					<span class="token punctuation">}</span> <span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">						app<span class="token punctuation">.</span>msg<span class="token operator">=</span><span class="token string">&quot;登录失败&quot;</span><span class="token punctuation">;</span></span>
<span class="line">					<span class="token punctuation">}</span></span>
<span class="line">				<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">			<span class="token punctuation">}</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">	<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25</p><p>测试：访问：http://localhost:8001/api/wcart/list</p><p>总结：</p><p>1鉴权</p><p>5张表模型</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211201170435457.3a99886b.png" alt="image-20211201170435457"></p><p>oauth2</p><p>查询用户 权限字符串拼出来</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211201170504113.9151d8b8.png" alt="image-20211201170504113"></p><p>后端微服务 controll层</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">@PreAuthorize(&quot;hasAnyAuthority(&#39;seckill_list&#39;,&#39;user_list&#39;)&quot;)</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>2购物车模块</p><p>2.1添加</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211201093507350.3adc0b8a.png" alt="image-20211201093507350"></p><p>2.2查询</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211201105337532.61c750ef.png" alt="image-20211201105337532"></p><p>3购物车页面渲染</p><p>购物车页面渲染微服务搭建</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211201115148021.95f9e24e.png" alt="image-20211201115148021"></p><p>微服务认证</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211201170927459.91c98ead.png" alt="image-20211201170927459"></p><p>动态获取当前登录人</p><p>tokenDecode</p><p>页面配置</p><p>未登录--------》登陆页面</p><p>优化：未登录--------》登陆页面-----》跳回到购物车</p></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="vp-meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 2506956864@qq.com">zqb</span><!----><!--]--><!--]--></span></div></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/blogs/assets/app-lCTfir8o.js" defer></script>
  </body>
</html>
