import{_ as s,c as n,o as a,a as e}from"./app-us7mUOvw.js";const l={},p=e(`<h1 id="mysql进阶" tabindex="-1"><a class="header-anchor" href="#mysql进阶"><span>MySql进阶</span></a></h1><h2 id="mysql进阶-上" tabindex="-1"><a class="header-anchor" href="#mysql进阶-上"><span>mysql进阶-上</span></a></h2><h2 id="第一章-mysql架构" tabindex="-1"><a class="header-anchor" href="#第一章-mysql架构"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#%E7%AC%AC%E4%B8%80%E7%AB%A0-mysql%E6%9E%B6%E6%9E%84" target="_blank" rel="noopener noreferrer">#</a>第一章 mysql架构</span></a></h2><h3 id="一、mysql的系统架构" tabindex="-1"><a class="header-anchor" href="#一、mysql的系统架构"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#%E4%B8%80%E3%80%81mysql%E7%9A%84%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84" target="_blank" rel="noopener noreferrer">#</a>一、mysql的系统架构</span></a></h3><h4 id="_1、-数据库和数据库实例" tabindex="-1"><a class="header-anchor" href="#_1、-数据库和数据库实例"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_1%E3%80%81-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E4%BE%8B" target="_blank" rel="noopener noreferrer">#</a>1、 数据库和数据库实例</span></a></h4><p>在MySQL的学习研究中，存在几个非常容易混淆的概念，即【数据库】、【数据库软件】和【数据库实例】：</p><ul><li>数据库：按照数据结构来组织、存储和管理数据的仓库，通常由数据库管理系统进行管理。</li><li>数据库管理软件（RDBMS）：就是我们说的数据库管理系统软件，他强调软件。</li><li>数据库实例：启动数据库软件，在内存中运行一个独立进程，用来操作数据，这个正在运行的进程就是一个数据库实例，理论上可以在一台电脑上启动多个数据库实例，当然要监听在不同的端口。</li></ul><h4 id="_2、mysql架构" tabindex="-1"><a class="header-anchor" href="#_2、mysql架构"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_2%E3%80%81mysql%E6%9E%B6%E6%9E%84" target="_blank" rel="noopener noreferrer">#</a>2、MySQL架构</span></a></h4><p>复杂的架构是为了更好的工作，架构中的每一个角色都可以高效的单独处理一类事件，辅助整个系统的流畅运行，举个例子：</p><p>每天有很多人拜访市长，为了能合理的给市长安排拜访工作，需要对拜访流程做出复杂设计，比如先要在门卫处做身份认证、由传达室负责接通电话确认是否可以访问、市长办公室负责接待、你可能需要排队等候、你的事情如果办公室就能解决可能就不用见市长了，最后轮到你了，你才能见上市长，整个拜访流程就是设计的架构。</p><p>对于MySQL来说，虽然经历了多个版本迭代（MySQL5.5,MySQL 5.6,MySQL 5.7,MySQL 8）,但每次的迭代，都是基于MySQL基架的，MySQL基架大致包括如下几大模块组件，如下图：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220425170356906.b2a52c35.png" alt="image-20220425170356906"></p><p><strong>（1）MySQL向外提供的交互接口（Connectors）</strong></p><p>Connectors组件，是MySQL向外提供的交互组件，如java,.net,php等语言可以通过该组件来操作SQL语句，实现与SQL的交互。通过客户端/服务器通信协议与MySQL建立连接。MySQL 客户端与服务端的通信方式是 “ 半双工 ”。对于每一个 MySQL 的连接，时刻都有一个线程状态来标识这个连接正在做什么。</p><p><strong>（2）管理服务组件和工具组件(Management Service &amp; Utilities)</strong></p><p>提供MySQL的各项服务组件和管理工具，如备份(Backup)，恢复(Recovery)，安全管理(Security)等功能。</p><p><strong>（3）连接池组件(Connection Pool)</strong></p><p>负责监听客户端向MySQL Server端的各种请求，接收请求，转发请求到目标模块。每个成功连接MySQL Server的客户请求都会被创建或分配一个线程，该线程负责客户端与MySQL Server端的通信，接收客户端发送的命令，传递服务端的结果信息等。</p><p><strong>（4）SQL接口组件(SQL Interface)</strong></p><p>接收用户SQL命令，如DML,DDL和存储过程等，并将最终结果返回给用户。</p><p><strong>（5）查询分析器组件(Parser)</strong></p><p>首先分析SQL命令语法的合法性，并进行抽象语法树解析，如果sql有语法错误，会抛出异常信息。</p><p><strong>（6）优化器组件（Optimizer）</strong></p><p>对SQL命令按照标准流程进行优化分析，mysql会按照它认为的最优方式进行优化，选用成本最小的执行计划。</p><p><strong>（7）缓存主件（Caches &amp; Buffers）</strong></p><p>缓存和缓冲组件，这里边的内容我们后边会详细的讲解。</p><p><strong>（8）MySQL存储引擎</strong></p><p>MySQL属于关系型数据库，而关系型数据库的存储是以表的形式进行的，对于表的创建，数据的存储，检索，更新等都是由MySQL存储引擎完成的。</p><p>MySQL存储引擎在MySQL中扮演着重要角色。研究过SQL Server和Oracle的读者可能很清楚，这两种数据库的存储引擎只有一个，而MySQL的存储引擎种类比较多，如MyIsam存储引擎，InnoDB存储引擎和Memory存储引擎。</p><p>因为mysql本身就是开源的，他允许第三方基于MySQL骨架，开发适合自己业务需求的存储引擎。从MySQL存储引擎种类上来说，可以分为官方存储引擎和第三方存储引擎，比较常用的存储引擎包括InnoDB存储引擎，MyIsam存储引擎和Momery存储引擎。</p><p><strong>查询流程大致如下：</strong></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220424195802351.3a69069f.png" alt="image-20220424195802351"></p><p><strong>小问题：MySQL8.0为什么取消了查询缓存？</strong></p><p>【MySQL缓存机制】简单的说就是缓存sql文本及查询结果，如果运行完全相同的SQL，服务器直接从缓存中取到结果，而不需要再去解析和执行SQL。但如果表中任何数据或是结构发生改变，包括INSERT、UPDATE、DELETE、TRUNCATE、ALTER TABLE、DROP TABLE或DROP DATABASE等，那么使用这个表的所有缓存查询将不再有效，查询缓存中相关条目被清空。缓存是对系统性能优化的重要手段。但是有经验的DBA都建议生产环境中把MySQL Query Cache关闭。MySQL8.0更是直接取消了查询缓存，其原因有下：</p><ul><li>MySQL会对每条接收到的SELECT类型的查询进行hash计算，然后查找这个查询的缓存结果是否存在。虽然hash计算和查找的效率已经足够高了，一条查询语句所带来的开销可以忽略，但一旦涉及到高并发，有成千上万条查询语句时，hash计算和查找所带来的开销就必须重视了。</li><li>查询语句的字符大小写、空格或者注释的不同，Query Cache都会认为是不同的查询（因为他们的hash值会不同）。</li><li>当向某个表写入数据的时候，必须将和这个表相关的所有缓存设置为失效，如果缓存内容很多，则消耗也会很大，可能使系统僵死，因为这个操作是靠全局锁操作来保护的。</li></ul><p>当然还有一些其他原因，我们学习的过程中慢慢体会。</p><h3 id="二、目录结构" tabindex="-1"><a class="header-anchor" href="#二、目录结构"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#%E4%BA%8C%E3%80%81%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84" target="_blank" rel="noopener noreferrer">#</a>二、目录结构</span></a></h3><h4 id="_1、windows中的目录" tabindex="-1"><a class="header-anchor" href="#_1、windows中的目录"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_1%E3%80%81windows%E4%B8%AD%E7%9A%84%E7%9B%AE%E5%BD%95" target="_blank" rel="noopener noreferrer">#</a>1、windows中的目录</span></a></h4><p>在mysql启动的时候，会从【安装目录】加载软件数据，在运行过程中，会从【数据目录】中读取数据。这两个目录我们不要放在一起，避免重新安装软件导致数据丢失。</p><h5 id="_1-mysql安装目录" tabindex="-1"><a class="header-anchor" href="#_1-mysql安装目录"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_1-mysql%E5%AE%89%E8%A3%85%E7%9B%AE%E5%BD%95" target="_blank" rel="noopener noreferrer">#</a>（1） mysql安装目录</span></a></h5><p>默认安装目录：C:\\Program Files\\MySQL</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220424195435853.ffca9813.png" alt="image-20220424195435853"></p><ul><li><code>bin</code>目录：用于放置一些可执行的工具文件，如mysql.exe、mysqld.exe、mysqlshow.exe等。</li><li><code>include</code>目录：用于放置一些头文件，如：mysql.h、mysql_ername.h等。</li><li><code>lib</code>目录：用于放置一系列库文件。</li></ul><h5 id="_2-数据文件目录-重要" tabindex="-1"><a class="header-anchor" href="#_2-数据文件目录-重要"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_2-%E6%95%B0%E6%8D%AE%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95-%E9%87%8D%E8%A6%81" target="_blank" rel="noopener noreferrer">#</a>（2）数据文件目录（重要）</span></a></h5><p>默认数据目录：C:\\ProgramData\\MySQL\\MySQL Server 8.0，注意ProgramData是一个隐藏目录，需要设置为【显示隐藏文件】：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220424195619219.9d7ce386.png" alt="image-20220424195619219"></p><p><code>data</code>目录：用于放置一些日志文件以及数据库。</p><p>我们发现在data目录保存的是我们的真是的数据，每个数据库一个文件夹：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220424235111862.444cb544.png" alt="image-20220424235111862"></p><p>每张表又是一个独立的文件，不同的存储引擎的文件存储方式不同：不仅能快没了，</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220424235244545.35dc0cdb.png" alt="image-20220424235244545"></p><ul><li><p>my.ini的部分截图如下：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220424234944753.ede12acc.png" alt="image-20220424234944753"></p></li></ul><p>配置文件很重要，所谓配置文件就是配置一下你的mysql让他成为你想要的的样子，这里可以配置大量的信息，我们放在文档最后的附录。</p><h4 id="_2、linux中的文件目录" tabindex="-1"><a class="header-anchor" href="#_2、linux中的文件目录"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_2%E3%80%81linux%E4%B8%AD%E7%9A%84%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95" target="_blank" rel="noopener noreferrer">#</a>2、linux中的文件目录</span></a></h4><p>linux的各项目录可以在我们安装时自由选定，我们选取一个云服务器，看看里边的mysql的目录结构：</p><p>（1）我们可以通过配置文件查看当前mysql的一些基本信息，linux中的配置文件在etc目录 ，名称为my.cnf，如下：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220507095721892.f5e6adbd.png" alt="image-20220507095721892"></p><p>（2）bin目录，一些可执行文件，包括</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220507102512199.e2f47841.png" alt="image-20220507102512199"></p><p><strong>bin目录工具汇总：</strong></p><blockquote><p>MySQL服务器端工具</p></blockquote><ul><li>mysqld：SQL后台保护程序(MySQL服务器进程)。该程序必须运行之后。客户端才能通过连接服务器端程序访问和操作数据库。</li><li>mysqld_safe：MySQL服务脚本。mysql_safe增加了一些安全特性，如当出现错误时重启服务器，向错误日志文件写入运行时间信息。</li><li>mysql.server：MySQL服务启动服本。调用mysqld_safe来启动MySQL服务。</li><li>mysql_multi：服务器启动脚本，可以启动或停止系统上安装的多个服务。</li><li>myiasmchk：用来描述、检查、优化和维护MyISAM表的实用工具。</li><li>mysqlbu：MySQL缺陷报告脚本。它可以用来向MySQL邮件系统发送缺陷报告。</li><li>mysql_install_db：用于默认权限创建MySQ授权表。通常只是在系统上首次安装MySQL时执行一次。</li></ul><blockquote><p>MySQL客户端工具</p></blockquote><ul><li>mysql：交互式输入SQL语句或从文件以批处理模式执行SQL语句来操作数据库管理系统，就是我们的客户端。</li><li>mysqldump：将MySQL数据库转储到一个文件，可以用来备份数据库。</li><li>mysqladmin：用来检索版本、进程、以及服务器的状态信息。</li><li>mysqlbinlog：用于从二进制日志读取语句。在二进制日志文件中包含执行的语句，可用来帮助系统从崩溃中恢复。</li><li>mysqlcheck：检查、修复、分析以及优化表的表维护。</li><li>mysqlhotcopy：当服务器在运行时，快速备份MyISAM或ISAM表的工具。</li><li>mysql import：使用load data infile将文本文件导入相关表的客户程序。</li><li>perror：显示系统或MySQL错误代码含义的工具。</li><li>myisampack：压缩MyISAP表，产生更小的只读表。</li><li>mysaqlaccess：检查访问主机名、用户名和数据库组合的权限。</li></ul><p>mysql是一个很常用的【mysql客户端工具】，我们可以使用一下命令连接本机或者远程的mysql服务：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"> mysql <span class="token parameter variable">-h</span> <span class="token number">124.220</span>.197.17 <span class="token parameter variable">-P</span> <span class="token number">3306</span> <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>tips</strong>：我们看到在配置文件中有一个socket的配置，socket 即 Unix 域套接字文件，在类 unix 平台，客户端连接 MySQL 服务端的方式有两种，分别是 TCP/IP 方式与 socket 套接字文件方式。Unix 套接字文件连接的速度比 TCP/IP 快，但是只能连接到同一台计算机上的服务器使用。通过设置 socket 变量可配置套接字文件路径及名称，默认值为 /tmp/mysql.sock。本地客户端的连接默认会使用到该文件：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p</span> <span class="token parameter variable">-S</span> /tmp/mysql.sock</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>如果mysql.sock文件误删的话，就需要重启mysql服务</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220507102421872.f0e9cd30.png" alt="image-20220507102421872"></p><p>接着给大家介绍一个【数据备份工具】，mysqldump可以用来实现轻量级的【快速迁移或恢复数据库】。 mysqldump是将数据表导成 SQL 脚本文件，在不同的 MySQL 版本之间升级时相对比较合适，这也是最常用的备份方法。mysqldump一般在数据量很小的时候（几个G）可以用于 备份。当数据量比较大的情况下，就不建议用mysqldump工具进行备份了。下边我们简单的使用mysqldump工具进行备份数据，命令如下：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 备份一个表</span></span>
<span class="line">mysqldump <span class="token operator">-</span>u root <span class="token operator">-</span>p ydlclass ydl_user  <span class="token operator">&gt;</span> <span class="token operator">~</span><span class="token operator">/</span><span class="token keyword">dump</span><span class="token punctuation">.</span>txt</span>
<span class="line"><span class="token comment">-- 备份一个数据库</span></span>
<span class="line">mysqldump <span class="token operator">-</span>u root <span class="token operator">-</span>p ydlclass  <span class="token operator">&gt;</span> <span class="token operator">~</span><span class="token operator">/</span><span class="token keyword">dump</span><span class="token punctuation">.</span>txt</span>
<span class="line"><span class="token comment">-- 备份所有数据库</span></span>
<span class="line">mysqldump <span class="token operator">-</span>u root <span class="token operator">-</span>p <span class="token comment">--all-databases &gt; dump.txt</span></span>
<span class="line"></span>
<span class="line">备份完成之后使用</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>恢复数据，使用mysql指令：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line">mysql <span class="token operator">-</span>u root <span class="token operator">-</span>p ydl <span class="token operator">&lt;</span> <span class="token operator">~</span><span class="token operator">/</span><span class="token keyword">dump</span><span class="token punctuation">.</span>txt</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>（3）数据库文件，该文件我们同样可以自由指定，该文件夹包含了日志文件，以及我们的数据文件，这些在后边的课程中会详细介绍：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220507112543589.288eb8e4.png" alt="image-20220507112543589"></p><h3 id="三、字符集和排序规则" tabindex="-1"><a class="header-anchor" href="#三、字符集和排序规则"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#%E4%B8%89%E3%80%81%E5%AD%97%E7%AC%A6%E9%9B%86%E5%92%8C%E6%8E%92%E5%BA%8F%E8%A7%84%E5%88%99" target="_blank" rel="noopener noreferrer">#</a>三、字符集和排序规则</span></a></h3><p>mysql支持大量的字符集，但是我们通常使用的是utf8，【show collation】命令可以查看mysql支持的所有的排序规则和字符集，如下所示部分：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220427114132237.2a65cd95.png" alt="image-20220427114132237"></p><p>由上图可知，一种字符集对应的很多比较规则。</p><p>举个例子：</p><ul><li>utf8-polish-ci，表示utf-8的字符集的波兰语的比较规则，ci代表忽略大小写。</li><li>utf8-general-ci，就是通用的忽略大小写的utf8字符集比较规则。</li><li>utf8mb4_0900_ai_ci中的0900指的是Unicode 9.0的规范，后边的后缀代表不区分重音也不区分大小写，他是utf8mb4字符集一个新的通用排序归则。</li></ul><table><thead><tr><th>后缀</th><th>英文</th><th>描述</th></tr></thead><tbody><tr><td>_ai</td><td>accent insensitive</td><td>不区分重音（è，é，ê和ë）</td></tr><tr><td>_as</td><td>accent sensitive</td><td>区分重音</td></tr><tr><td>_ci</td><td>case insensitive</td><td>不区分大小写</td></tr><tr><td>_cs</td><td>case sensitive</td><td>区分大小写</td></tr><tr><td>_bin</td><td>binary</td><td>以二进制的形式进行比较</td></tr></tbody></table><p>utf8和utf8mb4的区别：</p><ul><li>utf8mb3(utf-8)：使用1~3个字节表示字符，utf8默认就是utf8mb3。</li><li>utf8mb4：使用1~4个字节表示字符，他是utf8的超集，甚至可以存储很多【emoji表情😀😃😄😁😆】，mysql8.0已经默认字符集设置为utf8mb4。</li></ul><p>【字符集】和【比较规则】可以作用在全局、数据库、表、甚至是列级别：</p><p>全局：</p><p>mysql提供两个变量，进行全局设置。【character_set_server】和【collate_server】对全局的字符集和排序规则进行设置。这两个设置可以在配置文件中修改。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220427160641490.e72633a5.png" alt="image-20220427160641490"></p><p>在创建表时，可以对数据库、表、列指定字符集和排序规则：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 指定数据库</span></span>
<span class="line"><span class="token keyword">create</span> <span class="token keyword">database</span> 数据库名 <span class="token keyword">character</span> <span class="token keyword">set</span> 字符集  <span class="token keyword">collate</span> 比较规则</span>
<span class="line"><span class="token comment">-- </span></span>
<span class="line"><span class="token keyword">create</span> <span class="token keyword">table</span> 表名<span class="token punctuation">(</span></span>
<span class="line">	列名 列类型 </span>
<span class="line"><span class="token punctuation">)</span> <span class="token keyword">character</span> <span class="token keyword">set</span> 字符集 <span class="token keyword">collate</span> 比较规则</span>
<span class="line"></span>
<span class="line"><span class="token keyword">create</span> <span class="token keyword">table</span> 表名<span class="token punctuation">(</span></span>
<span class="line">	列名 列类型 <span class="token punctuation">[</span><span class="token keyword">character</span> <span class="token keyword">set</span> 字符集<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">collate</span> 比较规则<span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="四、mysql修改配置的方法" tabindex="-1"><a class="header-anchor" href="#四、mysql修改配置的方法"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#%E5%9B%9B%E3%80%81mysql%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E7%9A%84%E6%96%B9%E6%B3%95" target="_blank" rel="noopener noreferrer">#</a>四、mysql修改配置的方法</span></a></h3><p>在mysql中变量分为全局变量和会话变量，我们一一讲解：</p><h4 id="_1、全局变量" tabindex="-1"><a class="header-anchor" href="#_1、全局变量"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_1%E3%80%81%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F" target="_blank" rel="noopener noreferrer">#</a>1、全局变量</span></a></h4><p>（1）查看全局变量</p><p>我们查看一个全局变量wait_timeout的值（这个值代表，客户端和服务器的连接不生交互后多久自动断开连接），语法如下：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">show</span> <span class="token keyword">global</span> variables <span class="token operator">like</span> <span class="token string">&#39;%wait_timeout%&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">select</span> @<span class="token variable">@global.wait_timeout</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）设置全局变量方法1，修改配置文件, 然后重启mysqld：</p><div class="language-ini line-numbers-mode" data-highlighter="prismjs" data-ext="ini" data-title="ini"><pre><code><span class="line"><span class="token comment"># vi /etc/my.cnf</span></span>
<span class="line"><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">mysqld</span><span class="token punctuation">]</span></span></span>
<span class="line"><span class="token key attr-name">wait_timeout</span><span class="token punctuation">=</span><span class="token value attr-value">10000</span></span>
<span class="line"><span class="token comment"># service mysqld restart</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（3）设置全局变量方法2（推荐），在命令行里通过SET来设置：</p><p>如果要修改全局变量, 必须要显示指定&quot;GLOBAL&quot;或者&quot;@@global.&quot;，同时必须要有SUPER权限.：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">set</span> <span class="token keyword">global</span> wait_timeout<span class="token operator">=</span><span class="token number">10000</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">set</span> @<span class="token variable">@global.wait_timeout</span><span class="token operator">=</span><span class="token number">10000</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>然后查看设置是否成功:</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">show</span> <span class="token keyword">global</span> variables <span class="token operator">like</span> <span class="token string">&#39;wait_timeout&#39;</span></span>
<span class="line"><span class="token keyword">select</span> @<span class="token variable">@global.wait_timeout</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2、当前会话的变量" tabindex="-1"><a class="header-anchor" href="#_2、当前会话的变量"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_2%E3%80%81%E5%BD%93%E5%89%8D%E4%BC%9A%E8%AF%9D%E7%9A%84%E5%8F%98%E9%87%8F" target="_blank" rel="noopener noreferrer">#</a>2、当前会话的变量</span></a></h4><p>如果要修改会话变量值, 可以指定&quot;SESSION&quot;或者&quot;@@session.&quot;或者&quot;@@&quot;或者&quot;LOCAL&quot;或者&quot;@@local.&quot;, 或者什么都不使用。语法语法：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line">mysql<span class="token operator">&gt;</span> <span class="token keyword">set</span> wait_timeout<span class="token operator">=</span><span class="token number">10000</span><span class="token punctuation">;</span></span>
<span class="line">mysql<span class="token operator">&gt;</span> <span class="token keyword">set</span> <span class="token keyword">session</span> wait_timeout<span class="token operator">=</span><span class="token number">10000</span><span class="token punctuation">;</span></span>
<span class="line">mysql<span class="token operator">&gt;</span> <span class="token keyword">set</span> <span class="token keyword">local</span> wait_timeout<span class="token operator">=</span><span class="token number">10000</span><span class="token punctuation">;</span></span>
<span class="line">mysql<span class="token operator">&gt;</span> <span class="token keyword">set</span> @<span class="token variable">@wait_timeout</span><span class="token operator">=</span><span class="token number">10000</span><span class="token punctuation">;</span></span>
<span class="line">mysql<span class="token operator">&gt;</span> <span class="token keyword">set</span> @<span class="token variable">@session.wait_timeout</span><span class="token operator">=</span><span class="token number">10000</span><span class="token punctuation">;</span></span>
<span class="line">mysql<span class="token operator">&gt;</span> <span class="token keyword">set</span> @<span class="token variable">@local.wait_timeout</span><span class="token operator">=</span><span class="token number">10000</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后查看设置是否成功:</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line">mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> @<span class="token variable">@wait_timeout</span><span class="token punctuation">;</span></span>
<span class="line">mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> @<span class="token variable">@session.wait_timeout</span><span class="token punctuation">;</span></span>
<span class="line">mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> @<span class="token variable">@local.wait_timeout</span><span class="token punctuation">;</span></span>
<span class="line">mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">&#39;wait_timeout&#39;</span><span class="token punctuation">;</span></span>
<span class="line">mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> <span class="token keyword">local</span> variables <span class="token operator">like</span> <span class="token string">&#39;wait_timeout&#39;</span><span class="token punctuation">;</span></span>
<span class="line">mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> <span class="token keyword">session</span> variables <span class="token operator">like</span> <span class="token string">&#39;wait_timeout&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="五、内置数据库" tabindex="-1"><a class="header-anchor" href="#五、内置数据库"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#%E4%BA%94%E3%80%81%E5%86%85%E7%BD%AE%E6%95%B0%E6%8D%AE%E5%BA%93" target="_blank" rel="noopener noreferrer">#</a>五、内置数据库</span></a></h3><ul><li>mysql：这个库很重要，他是mysql的核心数据库，负责存储数据库的用户、权限设置、关键字等mysql自己需要使用，控制和管理的信息。</li><li>information_schema：这个数据库维护了数据库其他表的一些描述性信息，也称为元数据。比如，当前有哪些表，哪些视图，哪些触发器，哪些列等。</li><li>performation_schema：这个数据库用来存储mysql服务器运行过程中的一些状态信息，是做性能监控的。比如最近执行了什么sql语句，内存使用情况等</li><li>sys：结合information_schema和performation_schema的数据，能更方便的了解mysql服务器的性能信息。</li></ul><h2 id="第二章-i-o和存储" tabindex="-1"><a class="header-anchor" href="#第二章-i-o和存储"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#%E7%AC%AC%E4%BA%8C%E7%AB%A0-i-o%E5%92%8C%E5%AD%98%E5%82%A8" target="_blank" rel="noopener noreferrer">#</a>第二章 I/O和存储</span></a></h2><p>**谈谈性能：**mysql通常决定了一个系统的性能瓶颈，执行一条sql的成本主要在于以下两个方面：</p><ul><li>I/O成本：我们经常使用的MyIsam和InnoDB存储引擎都是将数据存储在磁盘上，当查询表中的记录时，需要先将数据加载到内存中，然后进行操作，这个从磁盘到内存的加载过程损耗的时间成为I/O成本。</li><li>CPU成本：读取记录以及检测记录是否满足对应的搜索条件、对结果集进行排序等这些操作所消耗的时间称之为CPU成本。</li></ul><p>本章节我们聊一聊I/O成本。</p><h3 id="一、io成本" tabindex="-1"><a class="header-anchor" href="#一、io成本"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#%E4%B8%80%E3%80%81io%E6%88%90%E6%9C%AC" target="_blank" rel="noopener noreferrer">#</a>一、IO成本</span></a></h3><p>我们想想要了解mysql的I/O成本，就需要知道计算机的磁盘是怎么工作的。</p><h4 id="_1、磁盘的结构" tabindex="-1"><a class="header-anchor" href="#_1、磁盘的结构"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_1%E3%80%81%E7%A3%81%E7%9B%98%E7%9A%84%E7%BB%93%E6%9E%84" target="_blank" rel="noopener noreferrer">#</a>1、磁盘的结构</span></a></h4><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20201122150129276.837e618f.png" alt="image-20201122150129276"></p><h5 id="_1-盘片、片面和磁头" tabindex="-1"><a class="header-anchor" href="#_1-盘片、片面和磁头"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_1-%E7%9B%98%E7%89%87%E3%80%81%E7%89%87%E9%9D%A2%E5%92%8C%E7%A3%81%E5%A4%B4" target="_blank" rel="noopener noreferrer">#</a>（1）盘片、片面和磁头</span></a></h5><p>硬盘中一般会有多个【盘片】组成，每个盘片包含【两个面】，每个盘面都对应的有一个【读/写磁头】。受到硬盘整体体积和生产成本的限制，盘片数量都受到限制，一般都在5片以内。盘片的编号【自下向上】从0开始，如最下边的盘片有0面和1面，再上一个盘片就编号为2面和3面。</p><p>结构示意图，如图：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220424195930213.55095177.png" alt="image-20220424195930213"></p><h5 id="_2-扇区和磁道" tabindex="-1"><a class="header-anchor" href="#_2-扇区和磁道"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_2-%E6%89%87%E5%8C%BA%E5%92%8C%E7%A3%81%E9%81%93" target="_blank" rel="noopener noreferrer">#</a>（2）扇区和磁道</span></a></h5><p>下图显示的是一个盘面，盘面中一圈圈灰色同心圆为一条条磁道，从圆心向外画直线，可以将磁道划分为若干个弧段，每个磁道上一个弧段被称之为一个扇区（图践绿色部分）。扇区是磁盘的最小组成单元，通常是512字节。（由于不断提高磁盘的大小，部分厂商设定每个扇区的大小是4096字节）；</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220424195949755.9516f689.png" alt="image-20220424195949755"></p><h5 id="_3-磁头和柱面" tabindex="-1"><a class="header-anchor" href="#_3-磁头和柱面"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_3-%E7%A3%81%E5%A4%B4%E5%92%8C%E6%9F%B1%E9%9D%A2" target="_blank" rel="noopener noreferrer">#</a>（3）磁头和柱面</span></a></h5><p>硬盘通常由重叠的一组盘片构成，每个盘面都被划分为数目相等的磁道，并从外缘的“0”开始编号，具有相同编号的磁道形成一个圆柱，称之为磁盘的柱面。磁盘的柱面数与一个盘面上的磁道数是相等的。由于每个盘面都有自己的磁头，因此，盘面数等于总的磁头数。 如下图</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220425153537739.a5e991d6.png" alt="image-20220425153537739"></p><h4 id="_2、磁盘容量计算" tabindex="-1"><a class="header-anchor" href="#_2、磁盘容量计算"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_2%E3%80%81%E7%A3%81%E7%9B%98%E5%AE%B9%E9%87%8F%E8%AE%A1%E7%AE%97" target="_blank" rel="noopener noreferrer">#</a>2、磁盘容量计算</span></a></h4><p>存储容量 ＝ 磁头数 × 磁道(柱面)数 × 每道扇区数 × 每扇区字节数</p><p>图3中磁盘是一个 3个圆盘6个磁头，7个柱面（每个盘片7个磁道） 的磁盘，图3中每条磁道有12个扇区，所以此磁盘的容量为：</p><p>存储容量 6 * 7 * 12 * 512 = 258048</p><p>**tips：**有些【古老硬盘】每个磁道的扇区数一样，外圈的密度小，内圈的密度大，每圈可存储的数据量是一样的。现在的硬盘数据的密度都一致，这样磁道的周长越长，扇区就越多，存储的数据量就越大。</p><h4 id="_3、磁盘读取响应时间" tabindex="-1"><a class="header-anchor" href="#_3、磁盘读取响应时间"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_3%E3%80%81%E7%A3%81%E7%9B%98%E8%AF%BB%E5%8F%96%E5%93%8D%E5%BA%94%E6%97%B6%E9%97%B4" target="_blank" rel="noopener noreferrer">#</a>3、磁盘读取响应时间</span></a></h4><ol><li>寻道时间：磁头从开始移动到数据所在磁道所需要的时间，寻道时间越短，I/O操作越快，目前磁盘的平均寻道时间一般在3－15ms，一般都在10ms左右。</li><li>旋转延迟：盘片旋转将请求数据所在扇区移至读写磁头下方所需要的时间，旋转延迟取决于磁盘转速。普通硬盘一般都是7200rpm，大概一圈8ms，慢的5400rpm。</li><li>数据传输时间：完成传输所请求的数据所需要的时间。 小结一下：从上面的指标来看、其实最重要的、或者说、我们最关心的应该只有两个：寻道时间；旋转延迟。</li></ol><p>读写一次磁盘信息所需的时间可分解为：寻道时间、延迟时间、传输时间。为提高磁盘传输效率，软件程序应着重考虑减少寻道时间和延迟时间。</p><p>下图是计算机硬件延迟的对比图，供大家参考：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220425153556197.aef612b3.png" alt="image-20220425153556197"></p><h4 id="_4、交换单位" tabindex="-1"><a class="header-anchor" href="#_4、交换单位"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_4%E3%80%81%E4%BA%A4%E6%8D%A2%E5%8D%95%E4%BD%8D" target="_blank" rel="noopener noreferrer">#</a>4、交换单位</span></a></h4><p>【块】是操作系统中最小的逻辑存储单位，他是虚拟出来的一个单位。操作系统与磁盘打交道的最小单位是磁盘块。每个块可以包括2、4、8、16、32、64…2的n次方个扇区。</p><p><strong>为什么存在磁盘块？</strong></p><ul><li>读取方便：由于扇区的容量比较小，数目众多，在寻址时比较困难，所以操作系统就将相邻的扇区组合在一起，形成一个块，再对块进行整体的操作。</li><li>分离对底层的依赖：操作系统忽略对底层物理存储结构的设计。通过虚拟出来磁盘块的概念，在系统中认为块是最小的单位。</li></ul><p><strong>扇区、块/簇、page的关系：</strong></p><ol><li>扇区： 硬盘的最小读写单元</li><li>块/簇： 是操作系统针对硬盘读写的最小单元</li><li>page： 是内存与操作系统之间操作的最小单元</li></ol><p>扇区 &lt;= 块/簇 &lt;= page</p><h4 id="_5、局部性原理与磁盘预读" tabindex="-1"><a class="header-anchor" href="#_5、局部性原理与磁盘预读"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_5%E3%80%81%E5%B1%80%E9%83%A8%E6%80%A7%E5%8E%9F%E7%90%86%E4%B8%8E%E7%A3%81%E7%9B%98%E9%A2%84%E8%AF%BB" target="_blank" rel="noopener noreferrer">#</a>5、局部性原理与磁盘预读</span></a></h4><p>由于存储介质的特性，磁盘本身存取就【比主存慢很多】，再加上机械运动耗费，磁盘的存取速度往往是主存的【十万分之一】，因此为了提高效率，要【尽量减少磁盘I/O】。也是因为这个原因，磁盘往往不是严格的【按需读取】，而是每次都会预读，即使只需要一个字节，磁盘也会从这个位置开始，顺序向后读取一定长度的数据放入内存。这样做的理论依据是计算机科学中著名的<strong>局部性原理</strong>。</p><p>**局部性原理：**当一个数据被用到时，其附近的数据也通常会马上被使用，程序运行期间所需要的数据通常比较集中。</p><p>由于磁盘【顺序读取】的效率很高（不需要寻道时间，只需很少的旋转时间），因此对于具有局部性的程序来说，预读可以提高I/O效率。</p><p>预读的长度一般为【页（page）】的整倍数（在许多操作系统中，页得大小通常为4k）。当程序要读取的数据不在主存中时，会触发一个缺页异常，此时系统会向磁盘发出读盘信号，磁盘会找到数据的起始位置并向后连续读取一页或几页载入内存中，然后异常返回，程序继续运行。</p><h3 id="二、数据存储" tabindex="-1"><a class="header-anchor" href="#二、数据存储"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#%E4%BA%8C%E3%80%81%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8" target="_blank" rel="noopener noreferrer">#</a>二、数据存储</span></a></h3><p>对于mysql而言，数据是存储在文件系统中的，不同的存储存储引擎会有不同的文件格式和组织形式，我们还是以innodb为例给大家讲解。</p><h4 id="_1、innodb数据存储" tabindex="-1"><a class="header-anchor" href="#_1、innodb数据存储"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_1%E3%80%81innodb%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8" target="_blank" rel="noopener noreferrer">#</a>1、innodb数据存储</span></a></h4><p>对于innodb而言，数据是存储在表空间（文件空间file space）内的，表空间是一个抽象的概念，他对应着硬盘上的一个或多个文件，如下图：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220427104757135.00dc235b.png" alt="image-20220427104757135"></p><p>表空间存储数据的单位是【页】，我们可以这样类比，一个表空间就是个大大的本子，本子里是一页页的数据（innodb是以页为单位进行数据存储的），常用页面类型有很多，不同类型的页面可以存放【不同类型的数据】，这里不展开讲解，暂时统称为【数据页】、他的通用部分如下，每一页大概占用16k的空间：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220426220208824.0063a836.png" alt="image-20220426220208824"></p><ul><li>file header：记录页面的一些通用信息，比如当前页的校验和、页号、上页号、下页号、所属表空间等。</li><li>file trailer：主要的工作是检验页是否完整。</li><li>表空间中的每一个页，都有一个页号（File_PAGE_OFFSET），我们可以通过这个页号在表空间快速定位到指定的页面。这个页号由4个字节组成，也就是32位，所有最多能存放2的32次方页，如果按照一页16k计算，一个表空间最大支持【64TB】的数据。整体的排列中页是连续的，但是页有上下指针，不连续的页也能组成链表。</li></ul><p>表空间的示意图如下：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220427154308986.93b2bedb.png" alt="image-20220427154308986"></p><p>表空间可以分为系统表空间、独立表空间等：</p><h5 id="_1-系统表空间-the-system-tablespace" tabindex="-1"><a class="header-anchor" href="#_1-系统表空间-the-system-tablespace"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_1-%E7%B3%BB%E7%BB%9F%E8%A1%A8%E7%A9%BA%E9%97%B4-the-system-tablespace" target="_blank" rel="noopener noreferrer">#</a>（1）系统表空间（The System Tablespace）</span></a></h5><ul><li>系统表空间包含了很多【公共数据】，比如InnoDB的数据字典，回滚信息、系统事物信息、二次写缓冲等，老版本的mysql表中的数据也会存储在系统表空间。</li><li>系统表空间是一个共享的表空间因为它是被多个表共享的。</li><li>该空间的数据文件通过参数【innodb_data_file_path】控制，默认值是<code>ibdata1:12M:autoextend</code>（文件名为ibdata1、12MB、自动扩展）。</li><li>当然系统表空间也可以通过配置，修改文件的名称和个数。文件如下图：</li></ul><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220427181352706.d43290e2.png" alt="image-20220427181352706"></p><p>相关变量的设置：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 如果1代表开启，0代表关闭</span></span>
<span class="line"><span class="token keyword">show</span> variables <span class="token operator">like</span><span class="token string">&#39;innodb_file_per_table&#39;</span></span>
<span class="line"><span class="token comment">-- 设置对应的变量</span></span>
<span class="line"><span class="token keyword">set</span> <span class="token keyword">global</span> innodb_file_per_table<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">-- 查看系统表空间的配置</span></span>
<span class="line"><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">&quot;innodb_data_file_path&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">-- 配置文件的配置</span></span>
<span class="line">innodb_data_file_path<span class="token operator">=</span>data1:<span class="token number">512</span>M<span class="token punctuation">;</span>data2:<span class="token number">512</span>M:autoextend</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2-独立表空间-file-per-table-tablespaces" tabindex="-1"><a class="header-anchor" href="#_2-独立表空间-file-per-table-tablespaces"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_2-%E7%8B%AC%E7%AB%8B%E8%A1%A8%E7%A9%BA%E9%97%B4-file-per-table-tablespaces" target="_blank" rel="noopener noreferrer">#</a>（2）独立表空间（File-Per-Table Tablespaces）</span></a></h5><ul><li>独立表空间是默认开启的，在5.6.6以后，Innodb不在默认将各个表的数据存储在【系统表空间】当中，而是会为每一个表建立一个独立表空间，innodb存储引擎的独立表空间为【.ibd】文件。</li><li>如果启用了【innodb_file_per_table】参数，需要注意的是每张表的表空间内存放的只是【数据】、【索引】和【插入缓冲Bitmap页】，其他数据如：回滚信息、系统事物信息、二次写缓冲（Double write buffer）等还是放在原来的系统表空间内。</li><li>同时说明了一个问题：即使启用了【innodb_file_per_table】参数，系统表空间还是会不断的增加其大小的。</li></ul><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA68AAAAtCAYAAABBCF2nAAAKI0lEQVR4nO3dQUwj1x3H8Z+jSFVPzfZi7DPbQxR5hX2DuwWOD3tatYoiF8kyt4Gq2tZaNoqi4K0jLjCq2i5FSqwoF04cvDbyPdyMxSjqIXC2mUtQT1WlKu5hxvYY7LENBgb4fiQkPO/Ne2/GM2j+/OfNhNrtdlsAMKFms6loNHrXw8A9xfHzsPH9Xg/7DwAGe++uBwAAAAAAwCgErwAAAACAwCN4BQAAAAAEHsErAAAAACDwCF4BAAAAAIEX4mnDAAAAAICgI/MKAAAAAAg8glcAAAAAQOARvAIAAAAAAo/gFQAAAAAQeASvAAAAAIDAI3gFAAAAAAQewSsAAAAAIPAIXgEAAAAAgUfwCgAAAAAIPIJXAAAAAEDgvT/tBje/+ovOz38aWv7kya/1yacZRaPRaXcNAAAAAHigph68np//pC++fDO0/PPPXum7b7/RJ5/+ngAWAAAAADCWO7lt+Le/+0TfffuNms3mXXQPAAAAALhnbj14/eCDD/T3v/1V5+fn2v3nP6bTaHVFoYVtnToftBJaUXU6Ld+s020thBa0fSpJp9peCGllkoH3bTcA4Ops1YqGStaIalZJxZp9aZkxckUAAHBdU79teJQ//PFP3d8//+zVbXcP4LZYJRm7dfdDVOn1vJLhbqFKxq7qg8r81vNt02XXVCy0lDIzinn6aqXXlb9U+UL9scecULbb/tAdMLzfvn6GtDVyW0ds1z1nlQxVIr1ts0qGurtDkqJpreeTckpt1YoFlftu5hnnO/IKK5nPqmQUVRt0XHXG1WgpvtgZU1Fni3klJ9gu3Da/82RI2Th/Z7pVDTXmTGU6B5pdU7FQVjORlZmJjThuAQCTuvXgFR6zq/q+vXrXowBugKVSJaJ103Qu0qySjEJJM2ZGMdmqFZ0LRjMZvlDmt55fWY99fCSll91+Cio3E0okho+0V3/UmBuaM01l5AZSpTmZmUGh0Yh+rZIMbz9X2n+jt+shiqb7g9lCaabvO0hkPUGEVZJhGP3LugYFux4FQ+X+jp2Aw66p0opr2flS1GjFtRiWZA9sBXfK7zzxKxvv78xglkqFsiJZU3lP5VHHLQBgfASvAG5ATBnv1VtsTglVdGZLMR3rqJlQKu+GbrFFpaMFNayMYjGf9cJ+ZZ2Flg7KUnzdWZDMm0pKskp1tQaO01s/7NN+WMl8xlOUkCpnshUbEICGffq1Vau0lF7OjMi8+G2rX/uPRzgSle/GxzIy1yMqFkqyLgUevX1o14o6mMlfDnCtkopni30ZOfv4SM1Iyg1qGqo366obnTC3LsPNsEUfaDb8fvE7T/zKxvk7M4gni+sTl448bgEAvgL7ntfthZAWtj2zOS/Naw0p1PlJ7UzQclUroQVtV7e14K6/UnXbdz/39Xuhr16Z2872gPVOt7XgnXd78bPv8v7++ufAXme7gTtkNVRXRDNhSXZLzcScJ5gIayYitc4GpK+8641TZjVUj8b1bNy4wa++T99Wo65o/Nnkt/7ZxzpSXDowZBjOT3f+pF1T0Sjq4nTKUWN5nGwdHzWVmBuRvQo/UzxaV8NnOmr4WVytARWsRkvxvgPD0kE3Vev+E2LdlGmaMrMJKZF1fjdNAteHZKxzr3c3if93P+ZxCwAYKrDB6+rrnA733nUfRlTd31Hu9apmVdVKKCVV2mq3nZ9KbtLWD7W2IZXabbUrOe2kQgrtP3faO9mS1jbdgLKqldCGPjzp9HWiF3tPPQHlodb+5V0vo+1rPj1pJ7Wv5+52OWNb8YzlutsN3AG7puJuXYmsk/2yz8ZMO1xYb5wyq1FXIjX+fLKh9Qe1b9dUdAPOxtwVAxS7pWazrNacG/Ssp6Xy14MDVr+xPFLNcsEN+gsqK63FaeyQ8DPFW5X+78C9Pdgbu9q1ilqJhKKS80+ISGroPEg8EGOee/Vd53hcHnJA3MhxCwCPVGCDVy09V+5wT+9OJamq/Z2cni9Jqu5rZ35LL5e8VSeN4ua1VVrVbKcfzWur0+Dsb/SRftCPp25fOtTa006286nWDqUffjzttdNd72O9mL/65nbkKm/V3bSll9qa39F+VVPabuB22bWijMKR4uu9eYfhmciV1htZZtdUqSc0dlJjSP2h7YeTyruZtbmGIaNYu9pUx6jn4jWcVCrR1NGx7bbf/2AYv/3wGEXT693spplqqWCUNPoZv1FFfIPMsJLLcR193fk+LZUKR4ov9/9Tw1Zcy4vusRtOKs8X8qBNcu4lsqaykbIKQ/4mXO24BQAMEuA5r0t6ubWhzLtTfawN7eRe6+1dDGN+Syffu4Fun5M7GAxwf1glQ7vKyjQHXPm1vPNFbZ21pMhceOR6fmX28ZGaidTY2clB9X3H7BHLZJUwKjq2k5Nl38IRJ3M3hnHH8miNMxfROlBZca2P+o7CSeVTzgOehj1dNpZMSnbNbdf7NNqO3pxXnih7v13l3Itl1pUuFkY/jGnsObQAgEGCm3mVNPvxC2lvU5t76mU4l54rd7imzd6EUm1v3NDcz0t9SdWVcd8h62ZvJZ2+29NhZ3Hfu10v29nvtX66ndHaoZtxvs3tBq7LzWpmB13ExRaVVlkHndSDddC7lc5vPb+yieeSDag/ou+i5z2edq0y2dzajvAzxVXW1555rpV61Jlb6Z3z6rutkDR6LqJVkrHbUnp50iCyqdaolHos08ukDZjzahK43l9XPvecVy0l6rv+7/xl/joAXEuAM6+SZlf1+qOQUj9s6aSb+lzS20pOoVRITug2r62tnLR3EwNY0tuTLS08DSnkLslV2qMzwLOrKm3t6enTkNYkzedyGveO4pz2FQqlup8q7c5txLe53cA12S01Vdeu0Z+dcl5bElZyOa1iwZDhLFXWdC/2/daTT1n4WEdKa3n8tOvl+r5jTmo5UpRh7HaW9sY8EecCt2UU1HlIbSJrOlm+vjmXfmOZuNMHo1nu7bdB73Gt7xrq7rFoWuvmqKc6e94fm8jKNDPdZcYuTw1+lK517sWUMbOSsSuj5WTfpdHHLQBgfKF2u92eZoOv8i/1xZdvxqr7+Wev9Ka46VunuhLSxocn+n718o27ACA5wUYlMn6gMWl9PDS997z6BSV2rahCudn3ntfiwczl+a5WSUZj2Ht/AQDAtAQ783q6rY2dnF63CVwBDGOpUY923+06/fp4eHrv+fStlczLTPYtkOd1vz2xjJiaDADAzZt65nXzqzc6Pz8fq+6TJ0/08s+vBpZVV0JK7bi36S4NrDKC82qZi7NCr94eAAAAAOCuTD14BQAAAABg2gL9tGEAAAAAACSCVwAAAADAPUDwCgAAAAAIPIJXAAAAAEDgEbwCAAAAAAKP4BUAAAAAEHgErwAAAACAwCN4BQAAAAAEHsErAAAAACDw3r/qiv/5n/Tv/0o/t6c5HAAAgMfjvZD0q19Iv7zyFRkAPB5XzrwSuAIAAFzPz23nmgoAMNr/AVIyCC8o3UQ7AAAAAElFTkSuQmCC" alt="image-20220427163520350"></p><h5 id="_3-其他类型的表空间" tabindex="-1"><a class="header-anchor" href="#_3-其他类型的表空间"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_3-%E5%85%B6%E4%BB%96%E7%B1%BB%E5%9E%8B%E7%9A%84%E8%A1%A8%E7%A9%BA%E9%97%B4" target="_blank" rel="noopener noreferrer">#</a>（3）其他类型的表空间，</span></a></h5><p>除了以上两种表空间，，innodb还提供了很多其他类型的表空间，比如通用表空间，undolog表空间、临时表空间等，这里不在赘述。</p><p>**tips：**MyIsam数据存储</p><p>MyIsam没有表空间的概念，他会在目录中产生2个文件【.MYD】（数据文件）、【 .MYI】（索引文件）三个文件。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220427164333413.20982ce1.png" alt="image-20220427164333413"></p><p>**注意：**在5.7以前【数据文件】和【表信息文件】是分开的，相互独立的。会多一个【.frm】文件，8.0之后进行了合并。</p><h4 id="_2、组织结构" tabindex="-1"><a class="header-anchor" href="#_2、组织结构"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_2%E3%80%81%E7%BB%84%E7%BB%87%E7%BB%93%E6%9E%84" target="_blank" rel="noopener noreferrer">#</a>2、组织结构</span></a></h4><ul><li>区（extent）：：每一个表空间保存了大量的页，为了更好的管理这些页面，Innodb提出了【区】的概念，对于16k的页，连续64个页就是一个区，大概1M的空间，每一个表空间都是由若干个连续的区组成的，每256个区被划分为一组。</li><li>段（Segment）：分为索引段，数据段，回滚段等后边会将，段是为了区分不同的数据类型，相同的段存的数据类型是一致的。一个段包含256个区(256M大小)。</li></ul><p>inndb表空间结构如下图所示：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220505142327089.786fc468.png" alt="image-20220505142327089"></p><h4 id="_2、row-format-行记录格式" tabindex="-1"><a class="header-anchor" href="#_2、row-format-行记录格式"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_2%E3%80%81row-format-%E8%A1%8C%E8%AE%B0%E5%BD%95%E6%A0%BC%E5%BC%8F" target="_blank" rel="noopener noreferrer">#</a>2、Row Format(行记录格式)</span></a></h4><ul><li>一个表的【行记录格式】决定表中行的【物理存储模式】，决定了【DQL】和【DML】的操作性能。越多的行被匹配进独立的磁盘页，sql的性能会更好一些，需要的缓存及io操作就越少。</li><li>一条完整的信息记录分为：【记录的额外信息】和【记录的真实数据】两大部分，就如同一箱苹果里的苹果分为包装和苹果一样。</li><li>我们可以通过命令<code>SHOW TABLE STATUS LIKE &#39;table_name&#39;</code>来查看当前表使用的行格式，其中row_format就代表了当前使用的行记录结构类型。</li></ul><p>指定行格式的语法如下：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 创建数据表时,显示指定行格式</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> 表名 <span class="token punctuation">(</span>列的信息<span class="token punctuation">)</span> ROW_FORMAT<span class="token operator">=</span>行格式名称<span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">-- 创建数据表时,修改行格式</span></span>
<span class="line"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> 表名 ROW_FORMAT<span class="token operator">=</span>行格式名称<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 具体如下：</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">\`</span>ydl_user<span class="token punctuation">\`</span></span>  <span class="token punctuation">(</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">\`</span>user_id<span class="token punctuation">\`</span></span> <span class="token keyword">bigint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;用户ID&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">\`</span>user_name<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;用户账号&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span>
<span class="line">  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>user_id<span class="token punctuation">\`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span></span>
<span class="line"><span class="token punctuation">)</span> ROW_FORMAT <span class="token operator">=</span> DYNAMIC<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_1-compact" tabindex="-1"><a class="header-anchor" href="#_1-compact"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_1-compact" target="_blank" rel="noopener noreferrer">#</a><strong>（1）COMPACT</strong></span></a></h5><p>【compact行记录】是在MySQL 5.0时被引入的，其设计目标是能高效存放数据。Compact行记录以如下方式进行存储：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220505142826773.83792245.png" alt="image-20220505142826773"></p><ul><li>第一个部分是一个非NULL【变长字段长度列表】。这个其实很好理解，我们的数据类型除了定长的char、int还有不定长的如varchar、text等，变长列的真实长度就保存在这个部分，他是按照列的顺序【逆序放置】的。当列的长度小于255字节，如（varchar(50)），用1字节表示；若大于255个字节（varchar(600)），用2个字节表示，这其实也就说明了为什么<strong>varchar的最大长度是65536</strong>。</li><li>第二个部分是【NULL标志位】，他指示了当前行数据中哪些为null值，用一个bitmap表示。举一个例子：假如该标志位为06(二进制：00000110)则表示第二三列（可以为空的列）的数据为NULL。需要注意的是，NULL值标志位仅仅针对可以为【NULL的字段】，如果某个字段被定义为not null，那么这个字段就不会进入NULL值标志位的BitMap中，这样可以节省很多空间，NULL值标志位也是逆序排列，占用空间按照字节数高位补零，如有九个字段可以为空（00000001 01010101）。</li><li>第三部分为记录头信息（record header），固定占用5个字节（40位），每位的含义见下表：</li></ul><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220505142851556.e87bd07f.png" alt="image-20220505142851556"></p><ul><li><p>第四部分就是实际存储的每个列的数据了，需要特别注意的是，NULL不占该部分任何数据，即NULL除了占有NULL标志位，实际存储不占有任何空间。Innodb存储变长列（VARCHAR, VARBINARY, BLOB, TEXT）的前768字节，剩下的部分存储在溢出页中。固定长度列，超过768字节的视为变长列。内部存储前768字节，20字节指针存储列的溢出页的地址，所以长度为768+20字节。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220505181612836.38c0d037.png" alt="image-20220505181612836"></p></li></ul><p>**注意：**另外有一点需要注意的是，每行数据除了用户定义的列外，<strong>还有两个隐藏列，事务ID列和回滚指针列</strong>，分别为6个字节和7个字节的大小。若InnoDB表没有定义Primary Key，每行还会增加一个【6字节的RowID列】。</p><p>**例子：**我们不妨举一个例子，看看硬盘的存储格式，以下表为准：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">create</span> <span class="token keyword">table</span> test <span class="token punctuation">(</span></span>
<span class="line">　　t1 <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">　　t2 <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">　　t3 <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">　　t4 <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span> <span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">innodb</span> row_format<span class="token operator">=</span>compact<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">insert</span> <span class="token keyword">into</span> row_test <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">&#39;a&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;bb&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;bb&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;ccc&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line"><span class="token keyword">insert</span> <span class="token keyword">into</span> row_test <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">&#39;d&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;ee&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;ee&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;fff&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line"><span class="token keyword">insert</span> <span class="token keyword">into</span> row_test <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">&#39;d&#39;</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token string">&#39;fff&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>节选对应的【真实的表空间】中的的二进制结构表示：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">                         03 02 01 00 00 00 <span class="token number">10</span> 00 </span>
<span class="line">2c 00 00 00 00 2b <span class="token number">68</span> 00  00 00 00 06 05 <span class="token number">80</span> 00 00 </span>
<span class="line">00 <span class="token number">32</span> 01 <span class="token number">10</span> <span class="token number">61</span> <span class="token number">62</span> <span class="token number">62</span> <span class="token number">62</span>  <span class="token number">62</span> <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span> </span>
<span class="line"><span class="token number">20</span> <span class="token number">63</span> <span class="token number">63</span> <span class="token number">63</span> 03 02 01 00  00 00 <span class="token number">18</span> 00 2b 00 00 00  </span>
<span class="line">00 02 01 00 00 00 00 0f  <span class="token number">62</span> c9 00 00 01 b2 01 <span class="token number">10</span>  </span>
<span class="line"><span class="token number">64</span> <span class="token number">65</span> <span class="token number">65</span> <span class="token number">65</span> <span class="token number">65</span> <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span>  <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span> <span class="token number">66</span> <span class="token number">66</span> <span class="token number">66</span>  </span>
<span class="line">03 01 06 00 00 <span class="token number">20</span> ff <span class="token number">98</span>  00 00 00 00 02 02 00 00 </span>
<span class="line">00 00 0f <span class="token number">67</span> cc 00 00 01  b6 01 <span class="token number">10</span> <span class="token number">64</span> <span class="token number">66</span> <span class="token number">66</span> <span class="token number">66</span> </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第一行整理如下，需要注意，我们有三个变长列varchar：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">03 02 01 // 变长字段长度列表，逆序，t4列长度为3，t2列长度为2，t1列长度为1</span>
<span class="line">00 // NULL标志位，第一行没有NULL值</span>
<span class="line">00 00 10 00 2c // 记录头信息，固定5字节长度</span>
<span class="line">00 00 00 00 2b 68 // RowID我们建的表没有主键，因此会有RowID，固定6字节长度</span>
<span class="line">00 00 00 00 06 05 // 事务ID，固定6个字节</span>
<span class="line">80 00 00 00 32 01 10 // 回滚指针，固定7个字节</span>
<span class="line">61 // t1数据&#39;a&#39;</span>
<span class="line">62 62 // t2&#39;bb&#39;</span>
<span class="line">62 62 20 20 20 20 20 20 20 20 // t3数据&#39;bb&#39;  Ox20十进制是32对应ascii码是空字符</span>
<span class="line">63 63 63 // t4数据&#39;ccc&#39;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第二行整理如下：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">03 02 01 // 变长字段长度列表，逆序，t4列长度为3，t2列长度为2，t1列长度为1</span>
<span class="line">00 // NULL标志位，第二行没有NULL值</span>
<span class="line">00 00 <span class="token number">18</span> 00 2b // 记录头信息，固定5字节长度</span>
<span class="line">00 00 00 00 02 01 // RowID我们建的表没有主键，因此会有RowID，固定6字节长度</span>
<span class="line">00 00 00 00 0f <span class="token number">62</span> // 事务ID，固定6个字节</span>
<span class="line">c9 00 00 01 b2 01 <span class="token number">10</span> // 回滚指针，固定7个字节</span>
<span class="line"><span class="token number">64</span> // t1数据<span class="token string">&#39;d&#39;</span></span>
<span class="line"><span class="token number">65</span> <span class="token number">65</span> // t2数据<span class="token string">&#39;ee&#39;</span></span>
<span class="line"><span class="token number">65</span> <span class="token number">65</span> <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span> <span class="token number">20</span> // t3数据<span class="token string">&#39;ee&#39;</span></span>
<span class="line"><span class="token number">66</span> <span class="token number">66</span> <span class="token number">66</span> // t4数据<span class="token string">&#39;fff&#39;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第三行整理如下：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">03 01 // 变长字段长度列表，逆序，t4列长度为3，t1列长度为1</span>
<span class="line">06 // 00000110 NULL标志位，t2和t3列为空</span>
<span class="line">00 00 20 ff 98  // 记录头信息，固定5字节长度</span>
<span class="line">00 00 00 00 02 02 // RowID我们建的表没有主键，因此会有RowID，固定6字节长度</span>
<span class="line">00 00 00 00 0f 67 // 事务ID，固定6个字节</span>
<span class="line">cc 00 00 01 b6 01 10 // 回滚指针，固定7个字节</span>
<span class="line">64 // t1数据&#39;d&#39;</span>
<span class="line">66 66 66 // t4数据&#39;fff&#39;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2-redundant" tabindex="-1"><a class="header-anchor" href="#_2-redundant"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_2-redundant" target="_blank" rel="noopener noreferrer">#</a>（2）REDUNDANT</span></a></h5><p>【Redundant】是MySQL 5.0版本之前InnoDB的行记录存储方式。Redundant行记录以如下方式存储：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220505142609716.f073d2f3.png" alt="image-20220505142609716"></p><p>从上图可以看到，Redundant行格式如下：</p><ol><li><p>第一个部分保存了【字段长度偏移列表】，这个部分保存了该行数据所有列，包括隐藏列的长度偏移量。举一个例子说明一下偏移，假如第一个字段长度为x，第二个字段长度为y，那么列表中第一个字段就是x，第二个字段就是x+y。这个偏移列表是按照列的顺序【逆序排列】。</p></li><li><p>第二个部分为记录头信息【record header】，Redundant行格式固定占用6个字节（48位），每位的含义如下图：</p><p>有几个标志位我们可以注意一下，<code>n_fields</code>值代表一行中列的数量，占用10位，这也很好地解释了为什么MySQL【一个行支持最多的列为1023】。</p></li></ol><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220505142646478.14643b59.png" alt="image-20220505142646478"></p><p>3.第三个部分就是实际存储的每个列的数据了。</p><p><strong>null值的存储</strong>，在【字段长度列表】的每个字段长度最高位标记 1 表示这个字段为 NULL。</p><ul><li>对于一字节存储，通过【最高位标记字段】判断是否为 NULL，如果为 NULL，则最高位为1，否则为0。剩下的 7 位用来存储数据，所以最多是127。</li><li>对于两字节存储，通过【最高位标记字段】判断是否为 NULL，第二位标记这条记录是否在同一页，如果在则为0，如果不在则为1，这其实就涉及到了后面要说的溢出页。剩下的 14 位表示长度，所以最多是16383。</li><li>在这种类型的行格式中，无论字段是否为 NULL，或者长度是多少，<strong>char(M) 都会占用 M * 字节编码最大长度那么多字节</strong>。为 NULL 的话，填充的是 0x00，不为 NULL，长度不够的情况下，末尾补充 0x20。 对于varchar来说，NULL 还是不占用空间的。</li></ul><p><strong>小结：</strong></p><p>compact格式比redundant存储空间大约减少20%。如果受限于cache命中和磁盘速度，compact格式会快一些，若受限于CPU速度，compact格式会慢一些。</p><p><strong>（3）DYNAMIC</strong></p><p>InnoDB Plugin引入了两种新的文件格式（file format，可以理解为新的页格式），对于以前支持的Compact和Redundant格式将其称为Antelope文件格式，新的文件格式称为Barracuda。Barracuda文件格式下拥有两种新的行记录格式Compressed和Dynamic两种。</p><p>新的两种格式对于存放BLOB的数据采用了完全的行溢出的方式，在数据页中只存放20个字节的指针，实际的数据都存放在BLOB Page中，而之前的Compact和Redundant两种格式会存放768个前缀字节。mysql8.0默认此格式。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220505154503535.312b70d6.png" alt="image-20220505154503535"></p><p><strong>（4）COMPRESSED</strong> 基于dynamic格式，支持表和索引数据压缩。compressed行格式采用dynamic相同的页外存储细节，同时，存储在其中的行数据会以zlib的算法进行压缩，因此对于BLOB、TEXT、VARCHAR这类大长度类型的数据能进行非常有效的存储。</p><h2 id="第三章-缓冲池-buffer-pool" tabindex="-1"><a class="header-anchor" href="#第三章-缓冲池-buffer-pool"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#%E7%AC%AC%E4%B8%89%E7%AB%A0-%E7%BC%93%E5%86%B2%E6%B1%A0-buffer-pool" target="_blank" rel="noopener noreferrer">#</a>第三章 缓冲池 buffer pool</span></a></h2><p>我们在之前的章节中已经介绍过了，innodb中的数据是以【页】的形式存储在磁盘上的表空间内，但是我们一再强调过，【磁盘的速度】和【内存】相比简直不值一提，而【内存的速度】和【cpu的速度】同样不可同日而语，对于数据库而言，I/O成本永远是不可忽略的一项成本，我们不妨思考下面的小问题：</p><p><strong>小问题：一个全表扫描会产生有多少次磁盘I/O?</strong></p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">where</span> id <span class="token operator">between</span> <span class="token number">10</span> <span class="token operator">and</span> <span class="token number">1000</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>访问id为1的数据，需要访问当前表空间的第一行数据，一次I/O</li><li>访问id为2的数据，需要访问当前表空间的第二行数据，两次I/O</li><li>访问id为3的数据，需要访问当前表空间的第三行数据，三次I/O......</li></ul><p>我们发现id为1，2，3...的数据都在同一个【数据页】，这会导致一个严重的问题，一次简单的查询，会访问【同一个页很多次】，可能产生很几百次I/O操作。所以为了解决快如闪电的【cpu】，和慢如蜗牛的【磁盘】之间的矛盾，innodb设计了buffer pool，有了缓存之后我们的执行过程如下：</p><ul><li>访问id为1的数据，需要访问当前表空间的第一行数据，缓存当前页，一次I/O</li><li>访问id为2的数据，需要访问当前表空间的第二行数据，从缓存获取，无需I/O</li><li>访问id为3的数据，需要访问当前表空间的第三行数据，从缓存获取，无需I/O......</li></ul><p>Innodb引擎会在mysql启动的时候，向操作系统申请一块连续的空间当做buffer pool，空间的大小由变量<code>innodb_buffer_pool_size</code>确定，我这台电脑他使用了8G，你的可能是128M。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220509110739628.49731f16.png" alt="image-20220509110739628">这个缓冲区的大小可以结合自己服务器的性能而定，这就明白了内存大的好处了吧。</p><h3 id="一、内部结构" tabindex="-1"><a class="header-anchor" href="#一、内部结构"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#%E4%B8%80%E3%80%81%E5%86%85%E9%83%A8%E7%BB%93%E6%9E%84" target="_blank" rel="noopener noreferrer">#</a>一、内部结构</span></a></h3><p>整个buffer pool是由缓冲页和控制块组成的：</p><ul><li>**缓冲页：**buffer pool中存放的【数据页】我们称之为【缓冲页】，和磁盘上的数据页是一一对应的，都是16KB，缓冲页的数据，是从磁盘上加载到buffer pool当中的一个完整页。</li><li>**控制块：**他是缓冲页【描述信息】，这一块区域保存的是数据页所属的表空间号，数据页编号，数据页地址，以及一些链表相关的节点信息等，每个控制块大小是缓存页的5%左右，大约是800个字节。</li></ul><p>其内部结构如下，buffer pool的前一部分存储【控制块】，后一部分存储【缓冲页】，如果中间有未被利用的空间，就叫他【内存碎片】吧：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220509143231600.b665b8b0.png" alt="image-20220509143231600"></p><p><strong>tips：buffer pool的初始化</strong></p><p>数据库会在启动的时候，按照配置中的Buffer Pool大小，去向操作系统申请一块内存，作为Buffer Pool的内存区域，然后会按照默认的缓存页的的大小【16KB】以及对应的【800个字节左右】的【控制块】的大小，在Buffer Pool中划分出一个一个的缓存页和一个一个与其对应的描述数据（控制块）。此时的buffer pool像一个干净的本子，没有书写任何内容。</p><h3 id="二、free链" tabindex="-1"><a class="header-anchor" href="#二、free链"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#%E4%BA%8C%E3%80%81free%E9%93%BE" target="_blank" rel="noopener noreferrer">#</a>二、free链</span></a></h3><p>刚初始化的buffer pool，内存中都是【空白的缓冲页】，但是随着时间的推移，程序在执行过程中会不断的有新的页被缓存起来，那怎么来判断哪些缓冲页是【闲置状态】，可以被使用呢，此时就需要【控制块来进行标记和管理】了。innodb在设计之初，会将所有【空闲的缓冲页】所对应的【控制块】作为一个个的节点，形成一个链表，这个链表就是free链，翻译过来就是空闲链表，如下图：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220509153220595.930514e2.png" alt="image-20220509153220595"></p><p>由上图可知，free链表是一个双向链表，链表上除了控制块以外，还有一个基础节点，存储了free链有多少个描述信息块，也就是有多少个空闲的缓存页，以及指向链表头尾的指针。</p><p>当我们加载数据的时候，会从free链中找到空闲的缓存页，把数据页的【表空间号和数据页】号写入【控制块】。</p><p>加载数据到缓存页后，会把缓存页对应的控制块从free链表中移除。</p><h4 id="_1、怎么知道数据页是否被缓存" tabindex="-1"><a class="header-anchor" href="#_1、怎么知道数据页是否被缓存"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_1%E3%80%81%E6%80%8E%E4%B9%88%E7%9F%A5%E9%81%93%E6%95%B0%E6%8D%AE%E9%A1%B5%E6%98%AF%E5%90%A6%E8%A2%AB%E7%BC%93%E5%AD%98" target="_blank" rel="noopener noreferrer">#</a>1、怎么知道数据页是否被缓存？</span></a></h4><p>我们已经有了free链表用来【保存空闲的页】，但是，当下一次访问时，要如何知道当前要访问的页是不是已经被缓存了，最直观的思路就是将buffer poll里的缓存数据【全部遍历一遍】。显然，这要做并不合理，本来设计buffer pool是为了提升效率，如果有人将buffer pool配置的很大，比如32个G，那扫描这一片区域的功夫都可以喝一杯茶了，反而成了累赘。</p><p>事实上，使用【表空间号+页号】就可以确定一个唯一的页，那么我们能不能设计一个hash表，使用【表空间号+页】号当做key，使用【控制块地址】做value，每次查询的时候只需要通过key进行查找即可，大家都知道hash的时间复杂度是O(1)，这样就能迅速定位缓存的页。（和hashmap很像）</p><p>结合我们的free链表，查询/缓存一个页的流程大致如下：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220509161002976.2a06e1f4.png" alt="image-20220509161002976"></p><h3 id="三、flush链表" tabindex="-1"><a class="header-anchor" href="#三、flush链表"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#%E4%B8%89%E3%80%81flush%E9%93%BE%E8%A1%A8" target="_blank" rel="noopener noreferrer">#</a>三、flush链表</span></a></h3><h4 id="_1、脏页" tabindex="-1"><a class="header-anchor" href="#_1、脏页"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_1%E3%80%81%E8%84%8F%E9%A1%B5" target="_blank" rel="noopener noreferrer">#</a>1、脏页</span></a></h4><p>在sql的执行过程中，无论是增删改查，都是优先在buffer pool中进行的，这样可以极大的保证执行效率。但是同样会有一个问题，假如我们对缓存页的某些数据进行了修改（执行了一条update语句），就会导致buffer pool中的缓冲页和磁盘的数据页【数据不一致】，那么此时的缓冲页就称之为【脏页】。当然，这也就说明了，脏页的数据是要刷到磁盘上的。</p><p>我在看极客时间的专栏时，有一位老师的比喻很不错，在古代的酒楼中记账是个技术活，可能经常会有赊账行为。每次记账、赊账都会将相关记录记录在账本之上。但是当饭点高峰期，记账数据巨大，张三仗着自己的岳父是县令大人又来赊账一笔，掌柜一时间太忙没有时间翻阅账本，查看张三的历史记录，所以单独使用一个小黑板，记了一笔张三今天赊账10两银子，一会李四来赊账，再在上面记上一笔。等过了饭点，有时间了，再将记录誊抄至账本，计算张三和李四的总赊账额度，其实就是这么个原理。</p><h4 id="_2、链表结构" tabindex="-1"><a class="header-anchor" href="#_2、链表结构"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_2%E3%80%81%E9%93%BE%E8%A1%A8%E7%BB%93%E6%9E%84" target="_blank" rel="noopener noreferrer">#</a>2、链表结构</span></a></h4><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220509153249620.b602e7fa.png" alt="image-20220509153249620"></p><ul><li>flush链表同样是一个双向链表，链表结点是被【修改过的缓存页】的控制块。</li><li>和free链表一样，flush链表也有一个基础结点，链接首尾结点，并存储了有多少个控制块。</li></ul><h4 id="_3、刷盘时机" tabindex="-1"><a class="header-anchor" href="#_3、刷盘时机"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_3%E3%80%81%E5%88%B7%E7%9B%98%E6%97%B6%E6%9C%BA" target="_blank" rel="noopener noreferrer">#</a>3、刷盘时机</span></a></h4><p>后台会有专门的线程每隔一段时间就把flush链表中的脏页刷入磁盘中，刷新的速率取决与当前系统是否繁忙。在这样的机制下，万一系统奔溃，是会产生数据不一致的问题的，没有刷入磁盘的数据就会丢失，而mysql通过日志系统解决了这个问题，以后的章节会详细讲解。</p><h3 id="四、lru链表" tabindex="-1"><a class="header-anchor" href="#四、lru链表"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#%E5%9B%9B%E3%80%81lru%E9%93%BE%E8%A1%A8" target="_blank" rel="noopener noreferrer">#</a>四、LRU链表</span></a></h3><h4 id="_1、概述" tabindex="-1"><a class="header-anchor" href="#_1、概述"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_1%E3%80%81%E6%A6%82%E8%BF%B0" target="_blank" rel="noopener noreferrer">#</a>1、概述</span></a></h4><p>内存是有限的，buffer pool更是有限的，缓存只是数据的中转站，当我们的数据量很大以后，buffer pool其实是仅仅能容纳很少一部分数据，所以buffer pool的容量很有可能被使用殆尽，如果此时我们还想继续缓存数据页那该怎么办？</p><p>合理的做法就是，当需要更多的空间缓存【新的数据页】的时候，我们将最近使用最少的【缓冲页淘汰掉】就可以了，这就是典型的LRU（Least Recently Used）算法，我们在讲java的时候也手动实现过基于linkedhashmap的LRU算法。对于innodb而言，则是通过【LRU链表】来完成此功能的，他的结构和上边讲的free链表、flush链表基本相同，只是负责的功能不同而已。</p><p>于是，一个简单的思路诞生了，当客户端访问一条数据时，会加载对应的数据页到buffer pool，并会将缓冲页对应的控制块放置到【LRU链表的首位】。一旦buffer pool被占满，则从链表的末端开始淘汰数据，这是最简单的实现。</p><h4 id="_2、优化" tabindex="-1"><a class="header-anchor" href="#_2、优化"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_2%E3%80%81%E4%BC%98%E5%8C%96" target="_blank" rel="noopener noreferrer">#</a>2、优化</span></a></h4><p>但是，实际的在使用场景中，我们需要对原有的LRU链表进行优化，因为他在一下场景可能会出现一些问题：</p><ul><li>数据页预读：我们在讲多线程的时候是讲过【预读性原理】（当一个应用在访问一个数据时，很有可能会继续访问和他相邻的数据），cpu的高级缓冲区读取主存的数据也不是一个字节一个字节的读取，而是一下子会读取一个【缓存行】。同理，innodb从磁盘读取数据，也不一定是一页页读取，当mysql读取当前需要的页时，如果觉得后续操作会使用【附近的页】，就会将他们一起缓存到buffer pool，这样的作用是为了提升效率。但是，这也会导致大量的使用频率并不高的数据放置在LRU链表头部，反而将一些真正的【热点数据】淘汰。</li><li>全表扫描：一条【select * from user】 语句，会直接将一张表的全表数据缓存，并全部放在LRU链表头部，一样会淘汰很多热点数据。</li></ul><p>所以，innodb对该链表进行了优化，将【LRU链表】分成了两个区域，分为【热数据区】和【冷数据区】，默认情况下冷数据区占了总链表的37%，机构如下：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220509180031426.501d93db.png" alt="image-20220509180031426"></p><p>**tips：**一个select语句可能会多次访问一个页，因为你有【很多数据是保存在同一个页内】的。对于一个全表扫描的语句，每访问一条数据，就会访问一次相关的页，所以缓存确实能极大的提升效率：</p><ul><li><p>对于预读的数据页，会在第一次访问时放入old区域，如果在sql执行的过程中访问相邻数据时，再次访问访问到该数据页，则把他加入如热数据区。</p></li><li><p>【大表的全表扫描】是个使用频率很低的操作（小表怎么操作都无所谓），但是如果按照上边的操作，首先全表数据会被放在【old区】，全表扫描必然会因为访问相邻数据而产生第二次、第三次、甚至数百次的访问，也就以为着这些页面会被全部放在young区。为了解决这个问题，INnodb提供了这样一个参数【innodb_old_blocks_time】，默认是1s，他的执行流程大致如下：</p><p>1、页被首次访问时会记录访问的时间戳。</p><p>2、以后访问都和首次访问的时间进行对比，如果时间大于1s，就讲当前页放入yong区。</p><p>3、一个sql的扫描一个页的时间，哪怕在慢也不会低于1s，这样就解决了一个全表扫秒而导致全表成为热点数据的问题。</p></li></ul><p>tips：也就意味着，热点数据要求首次访问时间和最后一次访问时间的时间差不能低于1s。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220509180909014.c5327db9.png" alt="image-20220509180909014"></p><p>tips：使用以下的语句，可以查看innodb当前的状态：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">show engine innodb status</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">Total large memory allocated <span class="token number">8585216</span>                  <span class="token comment"># 为innodb 分配的总内存数(byte)</span></span>
<span class="line">Dictionary memory allocated <span class="token number">446370</span>                    <span class="token comment">#为innodb数据字典分配的内存数(byte)</span></span>
<span class="line">Buffer pool size   <span class="token number">512</span>                                <span class="token comment">#innodb_buffer_pool的大小(page)</span></span>
<span class="line">Free buffers       <span class="token number">101</span>                                <span class="token comment">#innodb_buffer_pool lru列表中的空闲页面数量</span></span>
<span class="line">Database pages     <span class="token number">277</span>                                <span class="token comment">#innodb_buffer_pool lru列表中的非空闲页面数</span></span>
<span class="line">Old database pages <span class="token number">0</span>                                  <span class="token comment">#innodb_buffer_pool old子列表的页面数量</span></span>
<span class="line">Modified db pages  <span class="token number">273</span>                                <span class="token comment">#innodb_buffer_pool 中脏页的数量</span></span>
<span class="line">Pending reads      <span class="token number">1</span>                                  <span class="token comment">#挂起读的数量</span></span>
<span class="line">Pending writes: LRU <span class="token number">0</span>, flush list <span class="token number">0</span>, single page <span class="token number">0</span>    <span class="token comment">#挂起写的数量</span></span>
<span class="line">Pages made young <span class="token number">0</span>, not young <span class="token number">0</span></span>
<span class="line"><span class="token number">0.00</span> youngs/s, <span class="token number">0.00</span> non-youngs/s</span>
<span class="line">Pages <span class="token builtin class-name">read</span> <span class="token number">8002054</span>, created <span class="token number">766955</span>, written <span class="token number">4652116</span></span>
<span class="line"><span class="token number">0.00</span> reads/s, <span class="token number">0.00</span> creates/s, <span class="token number">0.00</span> writes/s</span>
<span class="line">Buffer pool hit rate <span class="token number">993</span> / <span class="token number">1000</span>, young-making rate <span class="token number">0</span> / <span class="token number">1000</span> not <span class="token number">0</span> / <span class="token number">1000</span></span>
<span class="line">Pages <span class="token builtin class-name">read</span> ahead <span class="token number">0.00</span>/s, evicted without access <span class="token number">0.00</span>/s, Random <span class="token builtin class-name">read</span> ahead <span class="token number">0.00</span>/s</span>
<span class="line">LRU len: <span class="token number">277</span>, unzip_LRU len: <span class="token number">0</span></span>
<span class="line">I/O sum<span class="token punctuation">[</span><span class="token number">22009</span><span class="token punctuation">]</span>:cur<span class="token punctuation">[</span><span class="token number">1940</span><span class="token punctuation">]</span>, <span class="token function">unzip</span> sum<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>:cur<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="第四章-mysql临时表" tabindex="-1"><a class="header-anchor" href="#第四章-mysql临时表"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#%E7%AC%AC%E5%9B%9B%E7%AB%A0-mysql%E4%B8%B4%E6%97%B6%E8%A1%A8" target="_blank" rel="noopener noreferrer">#</a>第四章 MySQL临时表</span></a></h2><h3 id="一、临时表简介" tabindex="-1"><a class="header-anchor" href="#一、临时表简介"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#%E4%B8%80%E3%80%81%E4%B8%B4%E6%97%B6%E8%A1%A8%E7%AE%80%E4%BB%8B" target="_blank" rel="noopener noreferrer">#</a>一、临时表简介</span></a></h3><p>MySQL临时表在很多场景中都会用到，比如用户自己创建的临时表用于【保存临时数据】，以及MySQL内部在执行【复杂SQL】时，需要借助临时表进行【分组、排序、去重】等操作，临时表具有一下几个特点：</p><p>1）临时表不能通过<code>show tables</code>查看，在服务器重启之后，所有的临时表将全部被销毁。</p><p>2）临时表是每个进程独享的，当前进程（客户端）创建的临时表，其他进程（客户端）是查不到临时表里面的数据的，所以不同客户端可以创建同名的临时表。</p><h3 id="二、临时表分类" tabindex="-1"><a class="header-anchor" href="#二、临时表分类"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#%E4%BA%8C%E3%80%81%E4%B8%B4%E6%97%B6%E8%A1%A8%E5%88%86%E7%B1%BB" target="_blank" rel="noopener noreferrer">#</a>二、临时表分类</span></a></h3><h4 id="_1、外部临时表" tabindex="-1"><a class="header-anchor" href="#_1、外部临时表"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_1%E3%80%81%E5%A4%96%E9%83%A8%E4%B8%B4%E6%97%B6%E8%A1%A8" target="_blank" rel="noopener noreferrer">#</a>1、外部临时表</span></a></h4><p>通过create temporary table语句创建的临时表为外部临时表，创建语句如下：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">create</span> <span class="token keyword">temporary</span> <span class="token keyword">table</span> temp_table<span class="token punctuation">(</span></span>
<span class="line">	id <span class="token keyword">int</span><span class="token punctuation">,</span></span>
<span class="line">	name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">insert</span> <span class="token keyword">into</span> temp_table <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&#39;1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> temp_table <span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 删除临时表</span></span>
<span class="line"><span class="token keyword">DROP</span> <span class="token keyword">TEMPORARY</span> <span class="token keyword">TABLE</span> table_name<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2、内部临时表" tabindex="-1"><a class="header-anchor" href="#_2、内部临时表"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_2%E3%80%81%E5%86%85%E9%83%A8%E4%B8%B4%E6%97%B6%E8%A1%A8" target="_blank" rel="noopener noreferrer">#</a>2、内部临时表</span></a></h4><p>【内部临时表】用来存储某些操作的【中间结果】，这些操作可能包括在【优化阶段】或者【执行阶段】，这种内部表对用户来说是不可见的。通常在执行复杂SQL语句时，比如group by，distinct，union等语句时，MySQL内部将使用【自动生成的临时表】，以辅助SQL的执行。我们可以使用执行计划查看，如果一条sql语句的执行计划中【列extra】结果为Using temporary，那么也就说明这个查询要使用到临时表。执行计划，我们后边会详细讲解。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220512171531287.af1986a5.png" alt="image-20220512171531287"></p><h4 id="_3、group-by执行流程" tabindex="-1"><a class="header-anchor" href="#_3、group-by执行流程"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_3%E3%80%81group-by%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B" target="_blank" rel="noopener noreferrer">#</a>3、group by执行流程</span></a></h4><p>这个例子中我们使用，课程【mysql入门】中的一张学生表，执行以下sql，统计各个年龄的人数，并按照年龄大学排序：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">select</span> age<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> student <span class="token keyword">group</span> <span class="token keyword">by</span> age <span class="token keyword">order</span> <span class="token keyword">by</span> age</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>他的执行流程如下：</strong></p><p>（1）创建一个内部临时表，有两列，一列是age，一列是count(*)。</p><p>（2）全表扫描【原始表】（聚簇索引会在后边的内容讲解），每扫描一条数据进行一次判断，第一种情况，这条数据的年龄在临时表中不存在，则将年龄填入，count列填1。第二种情况，该条数据在临时表中存在，则将count列加1。临时表的存在是为了辅助计算。</p><p>（3）对临时表的数据按照年龄进行排序。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220512173136197.67e95f7b.png" alt="image-20220512173136197"></p><h4 id="_4、内部临时表创建时机" tabindex="-1"><a class="header-anchor" href="#_4、内部临时表创建时机"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_4%E3%80%81%E5%86%85%E9%83%A8%E4%B8%B4%E6%97%B6%E8%A1%A8%E5%88%9B%E5%BB%BA%E6%97%B6%E6%9C%BA" target="_blank" rel="noopener noreferrer">#</a>4、内部临时表创建时机</span></a></h4><p><strong>MySQL在以下几种情况会创建临时表，大家也要思考为什么会产生临时表：</strong></p><p>1、使用GROUP BY分组，且分组字段没有索引时。</p><p>2、使用DISTINCT查询。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220512180936503.7bb9f8be.png" alt="image-20220512180936503"></p><p>3、使用UNION进行结果合并，辅助去重。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220512181256543.8c827827.png" alt="image-20220512181256543"></p><p>注意：【union all】不会使用零时表，因为他不需要去重</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220512181433029.019f7ad6.png" alt="image-20220512181433029"></p><p>复杂的sql中很容易产生临时表，这需要大家在工作中不断的学习和积累。</p><p>**tips：**其实临时表还可以分为【内存临时表】和【磁盘临时表】。内存临时表使用memery引擎（Memory引擎不支持BOLB和TEXT类型），磁盘临时表默认使用innodb引擎。在以下几种情况下，会创建磁盘临时表：</p><p>1、数据表中包含BLOB/TEXT列；</p><p>2、在 GROUP BY 或者 DSTINCT 的列中有超过 512字符的字符类型列；</p><p>3、在SELECT、UNION、UNION ALL查询中，存在最大长度超过512的列（对于字符串类型是512个字符，对于二进制类型则是512字节）；</p><h2 id="第五章-mysql事务" tabindex="-1"><a class="header-anchor" href="#第五章-mysql事务"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#%E7%AC%AC%E4%BA%94%E7%AB%A0-mysql%E4%BA%8B%E5%8A%A1" target="_blank" rel="noopener noreferrer">#</a>第五章 MySQL事务</span></a></h2><h3 id="一、事务简介" tabindex="-1"><a class="header-anchor" href="#一、事务简介"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#%E4%B8%80%E3%80%81%E4%BA%8B%E5%8A%A1%E7%AE%80%E4%BB%8B" target="_blank" rel="noopener noreferrer">#</a>一、事务简介</span></a></h3><p>首先给大家举一个例子：我们有如下的销售业务，一个销售业务可能包含很多步骤，比如记录订单、添加积分、管理库存、扣减金额等等，每一个操作都可能对应一条或多条sql语句，但是这个业务却是不可分割的，不能下了订单，不扣减库存。此时我们就需要事务来统一管理这个业务当中的一系列sql语句了。</p><p>（1）在 MySQL 中只有使用了 Innodb 数据库引擎的数据库或表才支持事务。</p><p>（2）事务处理可以用来维护数据库的完整性，保证成批的 SQL 语句要么全部执行，要么全部不执行。</p><h3 id="二、事务分类" tabindex="-1"><a class="header-anchor" href="#二、事务分类"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#%E4%BA%8C%E3%80%81%E4%BA%8B%E5%8A%A1%E5%88%86%E7%B1%BB" target="_blank" rel="noopener noreferrer">#</a>二、事务分类</span></a></h3><h4 id="_1、显式事务和隐式事务" tabindex="-1"><a class="header-anchor" href="#_1、显式事务和隐式事务"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_1%E3%80%81%E6%98%BE%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%92%8C%E9%9A%90%E5%BC%8F%E4%BA%8B%E5%8A%A1" target="_blank" rel="noopener noreferrer">#</a>1、显式事务和隐式事务</span></a></h4><p>（1）mysql的事务可以分为【显式事务】和【隐式事务】。默认的事务是隐式事务，由变量【autocommit】控制。隐式事务的环境下，我们每执行一条sql都会【自动开启和关闭】事务，变量如下：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">SHOW VARIABLES LIKE &#39;autocommit&#39;;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220512184029517.66be300a.png" alt="image-20220512184029517"></p><p>（2）显式事务由我们【自己控制】事务的【开启，提交，回滚】等操作，我们创建一个表，同时展示事务的基础语法，如下：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">create</span> <span class="token keyword">database</span> ydlTrx<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">use</span> ydlTrx<span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">-- UNSIGNED代表无符号数，不能是负数 </span></span>
<span class="line"><span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">user</span><span class="token punctuation">(</span></span>
<span class="line">	id <span class="token keyword">int</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span></span>
<span class="line">	name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">	balance <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">user</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&#39;楠哥&#39;</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">user</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">&#39;楠哥老婆&#39;</span><span class="token punctuation">,</span><span class="token number">50000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 转账业务，必须都成功，或者都失败，所以不能一句一句执行，万一执行了一半，断电了咋办</span></span>
<span class="line"><span class="token comment">-- 所以要编程一个整体</span></span>
<span class="line"><span class="token comment">-- 都成功</span></span>
<span class="line"><span class="token comment">-- 开启事务;</span></span>
<span class="line"><span class="token keyword">start</span> <span class="token keyword">transaction</span><span class="token punctuation">;</span>    </span>
<span class="line"><span class="token keyword">UPDATE</span> <span class="token keyword">user</span> <span class="token keyword">set</span> balance <span class="token operator">=</span> balance <span class="token operator">-</span> <span class="token number">200</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">UPDATE</span> <span class="token keyword">user</span> <span class="token keyword">set</span> balance <span class="token operator">=</span> balance <span class="token operator">+</span> <span class="token number">200</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">-- 提交事务</span></span>
<span class="line"><span class="token keyword">commit</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 都失败</span></span>
<span class="line"><span class="token keyword">start</span> <span class="token keyword">transaction</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">UPDATE</span> <span class="token keyword">user</span> <span class="token keyword">set</span> balance <span class="token operator">=</span> balance <span class="token operator">-</span> <span class="token number">200</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">UPDATE</span> <span class="token keyword">user</span> <span class="token keyword">set</span> balance <span class="token operator">=</span> balance <span class="token operator">+</span> <span class="token number">200</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">-- 回滚事务</span></span>
<span class="line"><span class="token keyword">rollback</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们可以使用begin或start transaction开启一个事务，使用commit提交事务，使用rollback回滚当前事务。</p><h4 id="_2、只读事务和读写事务" tabindex="-1"><a class="header-anchor" href="#_2、只读事务和读写事务"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_2%E3%80%81%E5%8F%AA%E8%AF%BB%E4%BA%8B%E5%8A%A1%E5%92%8C%E8%AF%BB%E5%86%99%E4%BA%8B%E5%8A%A1" target="_blank" rel="noopener noreferrer">#</a>2、只读事务和读写事务</span></a></h4><p>我们可以使用read only开启只读事务，开启只读事务模式之后，事务执行期间任何【insert】或者【update】语句都是不允许的，具体语法如下：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">start</span> <span class="token keyword">transaction</span> <span class="token keyword">read</span> only</span>
<span class="line"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span>
<span class="line"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span>
<span class="line"><span class="token keyword">commit</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>有人可能会问，这样和不开事务有什么区别呢？这个在下边学了隔离级别就知道了。</p><h4 id="_3、保存点" tabindex="-1"><a class="header-anchor" href="#_3、保存点"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_3%E3%80%81%E4%BF%9D%E5%AD%98%E7%82%B9" target="_blank" rel="noopener noreferrer">#</a>3、保存点</span></a></h4><p>我们可以使用savepoint 关键字在事务执行中新建【保存点】，之后可以使用rollback向任意保存点回滚。</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">start</span> <span class="token keyword">transaction</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">UPDATE</span> <span class="token keyword">user</span> <span class="token keyword">set</span> balance <span class="token operator">=</span> balance <span class="token operator">-</span> <span class="token number">200</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">savepoint</span> a<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">UPDATE</span> <span class="token keyword">user</span> <span class="token keyword">set</span> balance <span class="token operator">=</span> balance <span class="token operator">+</span> <span class="token number">200</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">rollback</span> <span class="token keyword">to</span> a<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>**注意：**Mysql是不支持嵌套事务的，开启一个事务的情况下，若再开启一个事务，会隐式的提交上一个事务：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">start</span> <span class="token keyword">transaction</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">UPDATE</span> <span class="token keyword">user</span> <span class="token keyword">set</span> balance <span class="token operator">=</span> balance <span class="token operator">-</span> <span class="token number">200</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">start</span> <span class="token keyword">transaction</span><span class="token punctuation">;</span>    <span class="token comment">-- 这里会自动将第一个事务提交</span></span>
<span class="line">    <span class="token keyword">UPDATE</span> <span class="token keyword">user</span> <span class="token keyword">set</span> balance <span class="token operator">=</span> balance <span class="token operator">+</span> <span class="token number">200</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">commit</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">-- 回滚事务</span></span>
<span class="line"><span class="token keyword">rollback</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="三、事务四大特征-acid" tabindex="-1"><a class="header-anchor" href="#三、事务四大特征-acid"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#%E4%B8%89%E3%80%81%E4%BA%8B%E5%8A%A1%E5%9B%9B%E5%A4%A7%E7%89%B9%E5%BE%81-acid" target="_blank" rel="noopener noreferrer">#</a>三、事务四大特征（ACID）</span></a></h3><h4 id="_1、原子性-atomicity" tabindex="-1"><a class="header-anchor" href="#_1、原子性-atomicity"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_1%E3%80%81%E5%8E%9F%E5%AD%90%E6%80%A7-atomicity" target="_blank" rel="noopener noreferrer">#</a>1、原子性（Atomicity）</span></a></h4><p>一个事务（transaction）中的所有操作，<strong>要么全部完成，要么全部不完成</strong>，不会结束在中间某个环节。如果事务在执行过程中发生错误，会被回滚（Rollback）到事务开始前的状态，就像这个事务从来没有执行过一样，这个很好理解。</p><h4 id="_2、一致性-consistency" tabindex="-1"><a class="header-anchor" href="#_2、一致性-consistency"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_2%E3%80%81%E4%B8%80%E8%87%B4%E6%80%A7-consistency" target="_blank" rel="noopener noreferrer">#</a>2、一致性（Consistency）</span></a></h4><p>在事务【开始之前和结束以后】，数据库的完整性没有被破坏，数据库状态应该与业务规则保持一致。<strong>举一个例子</strong>：A向B转账，不可能A扣了钱，B却没有收到，也不可能A和B的总金额，在事务前后发生变化，产生数据不一致。其他的三个特性都在为他服务。</p><h4 id="_3、隔离性-isolation" tabindex="-1"><a class="header-anchor" href="#_3、隔离性-isolation"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_3%E3%80%81%E9%9A%94%E7%A6%BB%E6%80%A7-isolation" target="_blank" rel="noopener noreferrer">#</a>3、隔离性（Isolation）</span></a></h4><p>数据库【允许多个并发事务同时对其数据进行读取和修改】，隔离性可以防止多个事务在并发修改共享数据时产生【数据不一致】的现象，这里要联想到我们学习过的多线程。</p><p>事务隔离级别分为不同等级，包括读未提交（Read uncommitted）、读提交（read committed）、可重复读（repeatable read）和串行化（Serializable），后续会详细讲。</p><h4 id="_4、持久性-durability" tabindex="-1"><a class="header-anchor" href="#_4、持久性-durability"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_4%E3%80%81%E6%8C%81%E4%B9%85%E6%80%A7-durability" target="_blank" rel="noopener noreferrer">#</a>4、持久性（Durability）</span></a></h4><p>事务处理结束后，对数据的修改就是永久的，即便系统故障也不会丢失。</p><h3 id="四、事务隔离级别" tabindex="-1"><a class="header-anchor" href="#四、事务隔离级别"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#%E5%9B%9B%E3%80%81%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB" target="_blank" rel="noopener noreferrer">#</a>四、事务隔离级别</span></a></h3><p>对于数据库的四大特性中的【隔离级别】是比较难理解的，我们在本小结中详细介绍。</p><p>在多个事务【并发操作】相同的表数据时，为了让多个事务都可以得到正确的结果，不会因为互相的交叉操作产生干扰，同时还要保证一定的执行效率，故而提出了不同的隔离级别。</p><p><strong>隔离级别分类如下，在不同的隔离级别下可能产生不同的问题，如脏读、不可重复度、幻读等，我们会在后边的课程中一一讲解：</strong></p><table><thead><tr><th>隔离级别</th><th>脏读</th><th>不可重复读</th><th>幻读</th><th>解决方案</th></tr></thead><tbody><tr><td>Read uncommitted（读未提交）</td><td>√</td><td>√</td><td>√</td><td></td></tr><tr><td>Read committed（读已提交）</td><td>×</td><td>√</td><td>√</td><td>undo log</td></tr><tr><td>Repeatable read（可重复读）</td><td>×</td><td>×</td><td>√</td><td>MVCC版本控制+间隙锁（mysql的rr不存在幻读）</td></tr><tr><td>Serializable（串行化）</td><td>×</td><td>×</td><td>×</td><td></td></tr></tbody></table><p>注意：传统意义上的rr级别是存在幻读问题的，但是mysql的rr级别不存在。</p><p><strong>在mysql中查看和设置【事务的隔离级别】，语法如下：</strong></p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 查看全局和当前事务的隔离级别</span></span>
<span class="line"><span class="token keyword">SELECT</span> @<span class="token variable">@global.transaction_isolation</span><span class="token punctuation">,</span> @<span class="token variable">@transaction_isolation_isolation</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">&#39;transaction_isolation&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">--5.7   tx_isolation</span></span>
<span class="line"><span class="token comment">--8.0   transaction_isolation</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- 设置下一个事务的隔离级别</span></span>
<span class="line"><span class="token keyword">SET</span> <span class="token keyword">transaction</span> <span class="token keyword">isolation</span> <span class="token keyword">level</span> <span class="token keyword">read</span> <span class="token keyword">uncommitted</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">SET</span> <span class="token keyword">transaction</span> <span class="token keyword">isolation</span> <span class="token keyword">level</span> <span class="token keyword">read</span> <span class="token keyword">committed</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">set</span> <span class="token keyword">transaction</span> <span class="token keyword">isolation</span> <span class="token keyword">level</span> <span class="token keyword">repeatable</span> <span class="token keyword">read</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">SET</span> <span class="token keyword">transaction</span> <span class="token keyword">isolation</span> <span class="token keyword">level</span> <span class="token keyword">serializable</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">-- 设置当前会话的隔离级别</span></span>
<span class="line"><span class="token keyword">SET</span> <span class="token keyword">session</span> <span class="token keyword">transaction</span> <span class="token keyword">isolation</span> <span class="token keyword">level</span> <span class="token keyword">read</span> <span class="token keyword">uncommitted</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">SET</span> <span class="token keyword">session</span> <span class="token keyword">transaction</span> <span class="token keyword">isolation</span> <span class="token keyword">level</span> <span class="token keyword">read</span> <span class="token keyword">committed</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">set</span> <span class="token keyword">session</span> <span class="token keyword">transaction</span> <span class="token keyword">isolation</span> <span class="token keyword">level</span> <span class="token keyword">repeatable</span> <span class="token keyword">read</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">SET</span> <span class="token keyword">session</span> <span class="token keyword">transaction</span> <span class="token keyword">isolation</span> <span class="token keyword">level</span> <span class="token keyword">serializable</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">-- 设置全局事务的隔离级别</span></span>
<span class="line"><span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> <span class="token keyword">transaction</span> <span class="token keyword">isolation</span> <span class="token keyword">level</span> <span class="token keyword">read</span> <span class="token keyword">uncommitted</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> <span class="token keyword">transaction</span> <span class="token keyword">isolation</span> <span class="token keyword">level</span> <span class="token keyword">read</span> <span class="token keyword">committed</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">set</span> <span class="token keyword">GLOBAL</span> <span class="token keyword">transaction</span> <span class="token keyword">isolation</span> <span class="token keyword">level</span> <span class="token keyword">repeatable</span> <span class="token keyword">read</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> <span class="token keyword">transaction</span> <span class="token keyword">isolation</span> <span class="token keyword">level</span> <span class="token keyword">serializable</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">其中，<span class="token keyword">SESSION</span> 和 <span class="token keyword">GLOBAL</span> 关键字用来指定修改的事务隔离级别的范围：</span>
<span class="line"><span class="token keyword">SESSION</span>：表示修改的事务隔离级别将应用于当前 <span class="token keyword">session</span>（当前 cmd 窗口）内的所有事务；</span>
<span class="line"><span class="token keyword">GLOBAL</span>：表示修改的事务隔离级别将应用于所有 <span class="token keyword">session</span>（全局）中的所有事务，且当前已经存在的 <span class="token keyword">session</span> 不受影响；</span>
<span class="line">如果省略 <span class="token keyword">SESSION</span> 和 <span class="token keyword">GLOBAL</span>，表示修改的事务隔离级别将应用于当前 <span class="token keyword">session</span> 内的下一个还未开始的事务。</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1、读未提交-ru" tabindex="-1"><a class="header-anchor" href="#_1、读未提交-ru"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_1%E3%80%81%E8%AF%BB%E6%9C%AA%E6%8F%90%E4%BA%A4-ru" target="_blank" rel="noopener noreferrer">#</a>1、读未提交（RU）</span></a></h4><p>【ru隔离级别】说的简单一点就是，一个事务可以读取其他【未提交的事务】修改的数据，这种隔离级别最低，一般情况下，数据库隔离级别都要高于该级别，该隔离级别下，可能会存在脏读、不可重复度，幻读的问题。</p><p>**脏读：**指的是一个事务读到了其他事务未提交的数据，未提交意味着这些数据可能会回滚，读到的数据不一定准确。</p><p><strong>案例：</strong></p><p>楠哥发工资了，老婆让楠哥把工资打到他老婆的账号上，但是该事务并未提交，就让老婆去查看，老婆一看真的打了钱了，高高兴兴关了网页，此时楠哥急中生智进行回滚，钱瞬间回来，一次蒙混了一个月工资。所以楠哥老婆看到的数据我们称之为“脏数据”。</p><p>第一步：使用两个窗口，开启两个事务，且将隔离级别设置为RU。</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">use</span> ydlTrx<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">SET</span> <span class="token keyword">transaction</span> <span class="token keyword">isolation</span> <span class="token keyword">level</span> <span class="token keyword">read</span> <span class="token keyword">uncommitted</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>第二步：楠哥，给转账老婆转账10000元，但是不提交。</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">start</span> <span class="token keyword">transaction</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">UPDATE</span> <span class="token keyword">user</span> <span class="token keyword">set</span> balance <span class="token operator">=</span> balance <span class="token operator">-</span> <span class="token number">10000</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">UPDATE</span> <span class="token keyword">user</span> <span class="token keyword">set</span> balance <span class="token operator">=</span> balance <span class="token operator">+</span> <span class="token number">10000</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第三部步：楠哥通知老婆进行查账，确实读取到了楠哥未提交事务修改的数据。</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">start</span> <span class="token keyword">transaction</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">commit</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第四步：老婆查账结束，楠哥来一个回马枪，对自己的事务进行回滚操作。</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">rollback</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>第五步：楠哥老婆某天查账，突然发现，哎，怎么少了一万。</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">start</span> <span class="token keyword">transaction</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">commit</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2、读已提交-rc" tabindex="-1"><a class="header-anchor" href="#_2、读已提交-rc"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_2%E3%80%81%E8%AF%BB%E5%B7%B2%E6%8F%90%E4%BA%A4-rc" target="_blank" rel="noopener noreferrer">#</a>2、读已提交（RC）</span></a></h4><p>【RC读已提交】说的是当前事务只能读到别的事物已经提交的数据，该隔离级别可能会产生不可重复读和幻读。</p><p>【不可重复读】的官方解释是：【一个事务】（A事务）修改了【另一个未提交事务】（B事务）读取过的数据。那么B事务【再次读取】，会发现两次读取的数据不一致。也就是说在一个原子性的操作中一个事务两次读取相同的数据，却不一致，一行数据不能重复被读取。主要是【update】语句，会导致不可重复读。</p><p><strong>案例：</strong></p><p>楠哥拿着工资卡去消费，系统读取到卡里确实有10200元，而此时她的老婆也正好在网上转账，把楠哥工资卡的2000元转到另一账户，并在 楠哥之前提交了事务，当楠哥扣款时，系统检查到楠哥的工资卡和上次读取的不一样了，楠哥十分纳闷，明明卡里有钱，为何......</p><p>第一步：将事务的隔离级别设置为RC。</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">SET</span>  <span class="token keyword">transaction</span> <span class="token keyword">isolation</span> <span class="token keyword">level</span> <span class="token keyword">read</span> <span class="token keyword">committed</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>第二步：楠哥准备去消费了，检查存款显示有余额，贼高兴。</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">start</span> <span class="token keyword">transaction</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>第三步：楠哥老婆在楠哥没有提交事务的时候，进行了一笔转账，并且提交了事务。</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">start</span> <span class="token keyword">transaction</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">UPDATE</span> <span class="token keyword">user</span> <span class="token keyword">set</span> balance <span class="token operator">=</span> balance <span class="token operator">+</span> <span class="token number">500</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">UPDATE</span> <span class="token keyword">user</span> <span class="token keyword">set</span> balance <span class="token operator">=</span> balance <span class="token operator">-</span> <span class="token number">500</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">commit</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第四步：楠哥再次查账，同一个事务里，发现钱少了。</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>当隔离级别设置为Read committed 时，避免了脏读，但是可能会造成不可重复读。</p><p>大多数数据库的默认级别就是Read committed，比如Sql Server , Oracle。如何解决不可重复读这一问题，请看下一个隔离级别。</p><h4 id="_3、可重复读-rr" tabindex="-1"><a class="header-anchor" href="#_3、可重复读-rr"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_3%E3%80%81%E5%8F%AF%E9%87%8D%E5%A4%8D%E8%AF%BB-rr" target="_blank" rel="noopener noreferrer">#</a>3、可重复读（RR）</span></a></h4><p>学习完不可重复读，理解【可重复读】就简单多了，他的意思是，同一个事务中发出同一个SELECT语句【两次或更多次】，那么产生的结果数据集总是相同的，在RR隔离级别中可能出现幻读。</p><p>**幻读：**一个事务按照某些条件进行查询，事务提交前，有另一个事务插入了满足条件的其他数据，再次使用相同条件查询，却发现多了一些数据，就像出现了幻觉一样。幻读主要针对针对delete和insert语句。</p><p>不可重复读强调的是两次读取的数据【内容不同】，幻读前调的是两次读取的【行数不同】。</p><p><strong>案例</strong></p><p>楠哥的老婆在银行部门工作，她时常通过银行内部系统查看楠哥的账户信息。有一天，她正在查询到楠哥账户信息时发现楠哥只有一个账户，心想这家伙应该没有私房钱。此时楠哥在另外一家分行又开了一个账户，准备存私房钱。同时，楠哥老婆在同一个事务中又一次查询，结果显示出的楠哥账户居然多了一个，真实奇怪。</p><p>第一步：将数据库的隔离级别设置为RR。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">set  transaction isolation level repeatable read;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>第二步：楠哥开启事务。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">start transaction;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>第三步：老婆查账户。</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">start</span> <span class="token keyword">transaction</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">&#39;楠哥&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>第四步：楠哥趁机开户，并提交事务。</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">user</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">&#39;楠哥&#39;</span><span class="token punctuation">,</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">commit</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>第五步：老婆再查询并打印，应该发现楠哥多了一个账户，但是没有，并没有出现幻读。</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">&#39;楠哥&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>**注意：**在mysql中的RR隔离级别中，innodb使用mvcc+锁帮我们解决了绝大部分的幻读情况，</p><p>上边的例子稍微修改一下，我们就能看到幻读现象了。</p><p>第一步：将数据库的隔离级别设置为RR。</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">set</span>  <span class="token keyword">transaction</span> <span class="token keyword">isolation</span> <span class="token keyword">level</span> <span class="token keyword">repeatable</span> <span class="token keyword">read</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>第二步：楠哥开启事务。</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">start</span> <span class="token keyword">transaction</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>第三步：老婆查账户。</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">start</span> <span class="token keyword">transaction</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">&#39;楠哥&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>第四步：楠哥趁机开户，并提交事务。</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">user</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">&#39;楠哥&#39;</span><span class="token punctuation">,</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">commit</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>第五步：老婆好心给所有的账户充值100，再查询并打印，结果发现楠哥多了一个账户，出现幻读。</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 先给所有的账户钱充值一百</span></span>
<span class="line"><span class="token keyword">UPDATE</span> <span class="token keyword">user</span> <span class="token keyword">set</span> balance <span class="token operator">=</span> balance <span class="token operator">+</span> <span class="token number">100</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">&#39;楠哥&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里边的原理过于复杂，目前我们先卖个关子，等我们学完【锁和mvcc】以后回来在看，就能明白了。</p><h4 id="_4、串行化" tabindex="-1"><a class="header-anchor" href="#_4、串行化"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#_4%E3%80%81%E4%B8%B2%E8%A1%8C%E5%8C%96" target="_blank" rel="noopener noreferrer">#</a>4、串行化</span></a></h4><ul><li>事务A和事务B，事务A在操作数据库时，事务B只能排队等待</li><li>这种隔离级别很少使用，吞吐量太低，用户体验差</li><li>这种级别可以避免“幻读”，每一次读取的都是数据库中真实存在数据，事务A与事务B串行，而不并发。</li></ul><p>第一步：修改数据库的隔离级别</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">SET</span>  <span class="token keyword">transaction</span> <span class="token keyword">isolation</span> <span class="token keyword">level</span> <span class="token keyword">serializable</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>第一步：楠哥执行查询操作</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">begin</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>第二步：楠哥老婆执行查询操作</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">begin</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>第三部：楠哥老婆想执行一个删除操作，发现事务被阻塞了，需要等待</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">delete</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>第四部：楠哥这边一提交，老婆那边就能操作了</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">commit</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><hr><hr><hr><hr><h2 id="mysql进阶-下" tabindex="-1"><a class="header-anchor" href="#mysql进阶-下"><span>mysql进阶-下</span></a></h2><h2 id="第六章-索引" tabindex="-1"><a class="header-anchor" href="#第六章-索引"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#%E7%AC%AC%E5%85%AD%E7%AB%A0-%E7%B4%A2%E5%BC%95" target="_blank" rel="noopener noreferrer">#</a>第六章 索引</span></a></h2><p>学习本章节内容，我们最好能模拟一个数据量比较大的环境，我使用nodejs模拟了600多万条数据，大家可自行下载：</p><p>数据库表如下：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">\`</span>user<span class="token punctuation">\`</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">\`</span>user<span class="token punctuation">\`</span></span>  <span class="token punctuation">(</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">\`</span>user_id<span class="token punctuation">\`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;用户ID&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">\`</span>user_name<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;用户账号&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">\`</span>nick_name<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;用户昵称&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">\`</span>email<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;&#39;</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;用户邮箱&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">\`</span>sex<span class="token punctuation">\`</span></span> <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;0&#39;</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;用户性别（0男 1女 2未知）&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">\`</span>avatar<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;&#39;</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;头像地址&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">\`</span>password<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;&#39;</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;密码&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">\`</span>login_ip<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;&#39;</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;最后登录IP&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">\`</span>login_date<span class="token punctuation">\`</span></span> <span class="token keyword">datetime</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;最后登录时间&#39;</span><span class="token punctuation">,</span></span>
<span class="line">   <span class="token identifier"><span class="token punctuation">\`</span>text<span class="token punctuation">\`</span></span> <span class="token keyword">text</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="token keyword">COMMENT</span> <span class="token string">&#39;测试文本&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>user_id<span class="token punctuation">\`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span></span>
<span class="line"><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token operator">=</span> <span class="token number">2</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8mb4 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8mb4_0900_ai_ci <span class="token keyword">COMMENT</span> <span class="token operator">=</span> <span class="token string">&#39;用户信息表&#39;</span> ROW_FORMAT <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我这里使用nodejs（后边会学）的脚本导入了600万条数据，用来模拟，脚本如下，大家也可以在我们网站自行获取：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token comment">// 使用 Mock</span></span>
<span class="line"><span class="token keyword">var</span> Mock <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;mockjs&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">// mysql8.0需要执行下边的sql，否则nodejs不支持</span></span>
<span class="line"><span class="token comment">// ALTER USER &#39;root&#39;@&#39;localhost&#39; IDENTIFIED WITH mysql_native_password BY &#39;自己的密码&#39;;</span></span>
<span class="line"><span class="token keyword">var</span> mysql <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;mysql&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 定义连接池</span></span>
<span class="line"><span class="token keyword">const</span> pool <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createPool</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 主机地址</span></span>
<span class="line">    <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">3306</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">database</span><span class="token operator">:</span> <span class="token string">&quot;ydl&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 数据库名字</span></span>
<span class="line">    <span class="token literal-property property">user</span><span class="token operator">:</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 连接数据库的用户名</span></span>
<span class="line">    <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 连接数据库密码</span></span>
<span class="line">    <span class="token literal-property property">connectionLimit</span><span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token comment">// 连接池最大连接数</span></span>
<span class="line">    <span class="token literal-property property">multipleStatements</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">// 允许执行多条sql语句</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token parameter">connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> content <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 使用mock.js模拟数据</span></span>
<span class="line">        <span class="token keyword">var</span> user <span class="token operator">=</span> Mock<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">userName</span><span class="token operator">:</span> Mock<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">&#39;@name(true)&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">nickName</span><span class="token operator">:</span> Mock<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">&#39;@cname()&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">email</span><span class="token operator">:</span> Mock<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">&#39;@email()&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">sex</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0.5</span> <span class="token operator">?</span> <span class="token string">&#39;男&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;女&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">loginIp</span><span class="token operator">:</span> Mock<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">&#39;@ip()&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">loginDate</span><span class="token operator">:</span> Mock<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">&#39;@datetime()&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">password</span><span class="token operator">:</span> Mock<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">&#39;@word(5, 10)&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">avatar</span><span class="token operator">:</span> Mock<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">&#39;@url()&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">text</span><span class="token operator">:</span> Mock<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">&#39;@cparagraph(30)&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// 每次存入1000条</span></span>
<span class="line">        <span class="token keyword">let</span> insertData <span class="token operator">=</span> <span class="token string">&#39;(&#39;</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            insertData <span class="token operator">+=</span> <span class="token string">&#39;\\&#39;&#39;</span> <span class="token operator">+</span> user<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">&#39;\\&#39;&#39;</span> <span class="token operator">+</span> <span class="token string">&#39;,&#39;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        insertData <span class="token operator">=</span> insertData<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> insertData<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39;)&#39;</span><span class="token punctuation">;</span></span>
<span class="line">        content <span class="token operator">+=</span> insertData <span class="token operator">+</span> <span class="token string">&#39;,&#39;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    content <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> content<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">insert into user (user_name,</span>
<span class="line">        nick_name,email,sex,login_ip,login_date,password,avatar,text) values</span>
<span class="line">        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">    connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    connection<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token comment">// 循环60000万次，总计能插入600万条</span></span>
<span class="line"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">60000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span></span>
<span class="line"> <span class="token punctuation">{</span></span>
<span class="line">    </span>
<span class="line">    pool<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 代码</span></span>
<span class="line">        <span class="token function">insert</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;第&#39;</span><span class="token operator">+</span>i<span class="token operator">+</span><span class="token string">&#39;条sql执行成功！&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span> </span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对应的sql文件也准备好了，文件大小1.18G，大家可以自行下载：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220429163430651.514ed3af.png" alt="image-20220429163430651"></p><p>准备工作做好之后，我们就可以深入的去学习这些知识了。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">select count(*) from ydl_user;  -- 5.429</span>
<span class="line">select * from ydl_user where user_id = 1000000; -- 0.355s</span>
<span class="line">select * from ydl_user where user_name = &#39;Jennifer Susan Johnson&#39;;   -- 4.715s</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="一、数据结构" tabindex="-1"><a class="header-anchor" href="#一、数据结构"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#%E4%B8%80%E3%80%81%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84" target="_blank" rel="noopener noreferrer">#</a>一、数据结构</span></a></h3><p>一方面mysql的数据是存储在磁盘上的，另一方面还要满足对日常操作如【增删改查】的高效稳定的支持，我们当然可以采用更好的硬件来提升性能，但是选用合适的数据结构也很关键，innodb采用的是一种名为【b+树】的数据结构。</p><p>我们之前已经学习过innodb中的数据是以【行】为单位，存在一个个大小为16k的【页】中，刚才的b+树的作用就是按照一个的组织形式，将所有的【页】组织关联起来。</p><h4 id="_1、b-树" tabindex="-1"><a class="header-anchor" href="#_1、b-树"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_1%E3%80%81b-%E6%A0%91" target="_blank" rel="noopener noreferrer">#</a>1、B-树</span></a></h4><p>我们要了解【B+树】，首先要了解一下【B-树】，这里的 B 表示 balance( 平衡的意思)，B-树是一种【多路自平衡的搜索树】，它类似普通的平衡二叉树，不同的一点是B-树允许每个节点有更多的子节点。下图是 B-树的简化图.</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220429152229620.0c8ec149.png" alt="image-20220429152229620"></p><p>B-树有如下特点:</p><ol><li>所有键值分布在整颗树中；</li><li>任何一个关键字出现且只出现在一个结点中；</li><li>搜索有可能在非叶子结点结束；</li><li>在关键字全集内做一次查找，性能逼近二分查找；</li></ol><h4 id="_2、b-树" tabindex="-1"><a class="header-anchor" href="#_2、b-树"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_2%E3%80%81b-%E6%A0%91" target="_blank" rel="noopener noreferrer">#</a>2、B+树</span></a></h4><p>【B+树】是【B-树】的变体，也是一种多路搜索树, 它与 B- 树的不同之处在于:</p><ol><li>所有关键字存储在叶子节点</li><li>为所有叶子结点增加了一个双向指针</li></ol><p>简化 B+树 如下图：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220429152436442.1eacd588.png" alt="image-20220429152436442"></p><h4 id="_3、选型缘由" tabindex="-1"><a class="header-anchor" href="#_3、选型缘由"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_3%E3%80%81%E9%80%89%E5%9E%8B%E7%BC%98%E7%94%B1" target="_blank" rel="noopener noreferrer">#</a>3、选型缘由</span></a></h4><p><strong>问题一：为什么在b-树或b+树中选择？</strong></p><ul><li>mysql数据模型更适合用这类数据结构，一条数据中通常包含【id】+【其他列数据】，我们可以很轻松的根据id组织一颗B+树。</li><li>我们知道innodb使用【页】（这是inndb管理数据的最小单位）保存数据，一页（16k），b+树中的每个节点都是一页数据。</li></ul><p><strong>问题二：为什么选择B+树？</strong></p><ul><li>相同的空间，不存放【整行数据】就能存【更多的id】，b+树能使每个节点能检索的【范围更大、更精确，极大的减少了I/O操作，保证b+树的层高较低，通常3到4层的层高就能支持百万级别的访问】。</li><li>Mysql是一种关系型数据库，【区间访问】是很常见的一种情况，B+树叶节点增加的双向指针，加强了区间访问性，可使用在范围区间查询的情况。</li></ul><h4 id="_4、发现索引" tabindex="-1"><a class="header-anchor" href="#_4、发现索引"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_4%E3%80%81%E5%8F%91%E7%8E%B0%E7%B4%A2%E5%BC%95" target="_blank" rel="noopener noreferrer">#</a>4、发现索引</span></a></h4><p>我们发现当使用id去查询数据时，效率很高，因为使用id可以利用B+树的特性，加速查询，请看以下两条sql的执行效率：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ydl_user <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span>                              <span class="token comment">-- 使用时间0.011s</span></span>
<span class="line"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ydl_user <span class="token keyword">where</span> email <span class="token operator">=</span> <span class="token string">&#39;m.szi@xwsrnhp.pl&#39;</span>          <span class="token comment">-- 使用时间4.284s</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>我们发现，查询相同的记录，使用【id列】比使用【emil列】快了389倍，原因如下：</p><ul><li>使用id列可以利用B+树的特性，由上自下查询。</li><li>使用email列只能从叶子节点进行【全表扫描】，一个一个的比较。</li></ul><p>那么如果我想提升使用其他字段的查询效率，应该怎么做呢？</p><p>首先，我们应该想到的思路就是，按照这个逻辑再给其他的字段也创建一个这样的结构不就好了，如下：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220429114638247.8094d895.png" alt="image-20220429114638247"></p><p>但是我们会发现，如果我们不断的创建类似的结构，数据会保存很多次，1个G的数据可以膨胀为5G甚至10G，所以我们可以进行优化，在叶子节点中只【保存id】而不保存全部数据，查到id后再【回表】（回到原来的结构中根据id进行查询）查询整条记录，其结构如下：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220429114616461.2471a114.png" alt="image-20220429114616461"></p><p>其实这就是我们日常工作中经常创建的【索引】。</p><h3 id="二、索引的分类和创建" tabindex="-1"><a class="header-anchor" href="#二、索引的分类和创建"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#%E4%BA%8C%E3%80%81%E7%B4%A2%E5%BC%95%E7%9A%84%E5%88%86%E7%B1%BB%E5%92%8C%E5%88%9B%E5%BB%BA" target="_blank" rel="noopener noreferrer">#</a>二、索引的分类和创建</span></a></h3><h4 id="_1、聚簇索引和非聚簇索引" tabindex="-1"><a class="header-anchor" href="#_1、聚簇索引和非聚簇索引"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_1%E3%80%81%E8%81%9A%E7%B0%87%E7%B4%A2%E5%BC%95%E5%92%8C%E9%9D%9E%E8%81%9A%E7%B0%87%E7%B4%A2%E5%BC%95" target="_blank" rel="noopener noreferrer">#</a>1、聚簇索引和非聚簇索引</span></a></h4><p>我们在上边的例子中，【主键和数据】共存的索引被称之为【聚簇索引】，其他的，比如我们使用【姓名列+主键】建立的索引，可以称为【非聚簇索引】，或者【辅助索引】，或者【二级索引】，同时聚簇索引只有在innodb引擎中才存在，而在myIsam中是不存在的，如下图：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220513141318848.e4599efe.png" alt="image-20220513141318848"></p><p>InnoDB使用的是【聚簇索引】，他会将【主键】组织到一棵B+树中，而【行数据】就储存在叶子节点上，若使用<code>where id = 14</code>这样的条件查找主键，则按照B+树的检索算法即可查找到对应的叶节点，之后获得行数据。</p><p>若对Name列进行条件搜索，且name列已建立【索引】，则需要两个步骤：</p><ul><li>第一步在辅助索引B+树中检索Name，到达其叶子节点获取对应的主键。</li><li>第二步使用主键在主索引B+树种再执行一次B+树检索操作，最终到达叶子节点即可获取整行数据。（重点在于通过其他键需要建立辅助索引）</li></ul><p>如下图：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220429171436220.e060a1c3.png" alt="image-20220429171436220"></p><p>MyIsam使用的是【非聚簇索引】，非聚簇索引的两棵B+树看上去没什么不同，节点的结构完全一致只是存储的内容不同而已，主键索引B+树的节点存储了主键，辅助键索引B+树存储了辅助列。表数据存储在独立的地方，这两颗B+树的叶子节点都使用一个【地址指向真正的表数据】，对于表数据来说，这两个键没有任何差别。由于索引树是独立的，通过辅助键检索无需访问主键的索引树。</p><p><strong>tips：</strong></p><ul><li>聚簇索引【默认使用主键】，如果表中没有定义主键，InnoDB 会选择一个【唯一且非空】的列代替。如果没有这样的列，InnoDB 会隐式定义一个主键【类似oracle中的RowId】rowid来作为聚簇索引的列。</li><li>如果涉及到大数据量的排序、全表扫描、count之类的操作的话，还是MyIsam占优势些，因为索引所占空间小，这些操作是需要在内存中完成的。</li></ul><p><strong>小问题：主键为什么建议使用自增id?</strong></p><ul><li>主键最好不要使用uuid，因为uuid的值太过离散，不适合排序且可能出现新增加记录的uuid，会插入在索引树中间的位置，出现页分裂，导致索引树调整复杂度变大，消耗更多的时间和资源。</li><li>聚簇索引的数据的物理存放顺序与索引顺序是一致的，即：只要索引是相邻的，那么对应的数据一定也是相邻地存放在磁盘上的。如果主键不是自增id，它会不断地调整数据的物理地址、分页，当然也有其他一些措施来减少这些操作，但却无法彻底避免。但如果是自增的id，它只需要一 页一页地写，索引结构相对紧凑，磁盘碎片少，效率也高。</li></ul><p>本章节中讲述了聚簇索引和二级键索引，对于【二级索引】而言，根据其不同的特性，我们又可以分为普通索引、唯一索引、复合索引等，接下来会一一讲解。</p><h4 id="_2、普通索引-常规索引-normal" tabindex="-1"><a class="header-anchor" href="#_2、普通索引-常规索引-normal"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_2%E3%80%81%E6%99%AE%E9%80%9A%E7%B4%A2%E5%BC%95-%E5%B8%B8%E8%A7%84%E7%B4%A2%E5%BC%95-normal" target="_blank" rel="noopener noreferrer">#</a>2、普通索引 （常规索引）(normal)</span></a></h4><p>就是普普通通的索引，没有什么特殊要求，理论上任何列都可以当做普通索引，创建方式如下：</p><p>**第一步：**创建索引前先执行下列语句，观察执行时间：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span> <span class="token keyword">where</span> user_name <span class="token operator">=</span><span class="token string">&#39;Dorothy William Harris&#39;</span><span class="token punctuation">;</span>  <span class="token comment">-- 整个执行时间为4.297s</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>第二步：创建user_name列的索引：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">create</span> <span class="token keyword">index</span> idx_user_name <span class="token keyword">on</span> <span class="token keyword">user</span><span class="token punctuation">(</span>user_name<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">-- 整个索引创建时间为24.502s</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>**结论：**创建索引是一个很费时间的操作。</p><p>**第三步：**再次执行下列语句</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ydl_user <span class="token keyword">where</span> user_name <span class="token operator">=</span><span class="token string">&#39;Dorothy William Harris&#39;</span><span class="token punctuation">;</span>   <span class="token comment">-- 执行时间0.031s</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>**结论：**创建索引后，我们的执行效率提升了138倍。</p><p>**第四部：**删除索引</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">drop</span> <span class="token keyword">index</span> idx_user_name <span class="token keyword">on</span> ydl_user<span class="token punctuation">;</span> </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>其他创建索引的方法，如下：</p><p>（1）创建email列的索引，索引可以截取length长度，只使用这一列的前几个字符</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">create</span> <span class="token keyword">index</span> idx_email <span class="token keyword">on</span> <span class="token keyword">user</span><span class="token punctuation">(</span>email<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">--执行时间16.174s</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>重点：</strong></p><p>有的列【数据量比较大】，使用前几个字符就能【很快标识】出来一行数据，那我们就可以使用这种方式建立索引，比如我们的邮箱，邮箱很多后缀是相同的我们完全可以忽略。</p><p>（2）使用修改表的方式添加索引</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">alter</span> <span class="token keyword">table</span> <span class="token keyword">user</span> <span class="token keyword">add</span> <span class="token keyword">index</span> idx_email <span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>（3）建表时时，同时创建索引</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">create</span> <span class="token keyword">table</span> tbl_name<span class="token punctuation">(</span></span>
<span class="line">    tid <span class="token keyword">int</span><span class="token punctuation">,</span></span>
<span class="line">    tname <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    gender <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">index</span> <span class="token punctuation">[</span>indexName<span class="token punctuation">]</span> <span class="token punctuation">(</span>fieldName<span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3、唯一索引-unique" tabindex="-1"><a class="header-anchor" href="#_3、唯一索引-unique"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_3%E3%80%81%E5%94%AF%E4%B8%80%E7%B4%A2%E5%BC%95-unique" target="_blank" rel="noopener noreferrer">#</a>3、唯一索引（UNIQUE ）</span></a></h4><p>对列的要求：索引列的值不能重复</p><p>创建表的同时，创建索引：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">create</span> <span class="token keyword">table</span> tbl_name<span class="token punctuation">(</span></span>
<span class="line">    tid <span class="token keyword">int</span><span class="token punctuation">,</span></span>
<span class="line">    tname <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    gender <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">unique</span> <span class="token keyword">index</span> unique_index_tname <span class="token punctuation">(</span>tname<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>独立的sql语句创建索引，我们的邮箱，用户名就应该创建唯一索引，姓名就应该是普通索引：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">create</span> <span class="token keyword">unique</span> <span class="token keyword">index</span> idx_email <span class="token keyword">on</span> <span class="token keyword">user</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>通过alter语句添加索引：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">ALTER</span> <span class="token keyword">table</span> mytable <span class="token keyword">ADD</span> <span class="token keyword">UNIQUE</span> <span class="token punctuation">[</span>ux_indexName<span class="token punctuation">]</span> <span class="token punctuation">(</span>username<span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>唯一索引和主键的区别：</p><ul><li>唯一索引列允许空值，而主键列不允许为空值。</li><li>主键列在创建时，已经默认为非空值 + 唯一索引了。</li><li>主键可以被其他表引用为外键，而唯一索引不能。</li><li>一个表最多只能创建一个主键，但可以创建多个唯一索引。</li><li>主键更适合那些不容易更改的唯一标识，如自动递增列、身份证号等。</li></ul><p>唯一约束和唯一索引的区别：</p><ul><li>唯一约束和唯一索引，都可以实现列数据的唯一，列值可以为null。</li><li>创建唯一约束，会自动创建一个同名的唯一索引，该索引不能单独删除，删除约束会自动删除索引。唯一约束是通过唯一索引来实现数据唯一。</li><li>创建一个唯一索引，这个索引就是独立的索引，可以单独删除。</li><li>如果一个列上想有约束和索引，且两者可以单独的删除。可以先建唯一索引，再建同名的唯一约束。</li></ul><h4 id="_4、多个二级索引的组合使用" tabindex="-1"><a class="header-anchor" href="#_4、多个二级索引的组合使用"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_4%E3%80%81%E5%A4%9A%E4%B8%AA%E4%BA%8C%E7%BA%A7%E7%B4%A2%E5%BC%95%E7%9A%84%E7%BB%84%E5%90%88%E4%BD%BF%E7%94%A8" target="_blank" rel="noopener noreferrer">#</a>4、多个二级索引的组合使用</span></a></h4><p><strong>记住一点</strong>：mysql在执行查询语句的时候一般只会使用【一个索引】，除非是使【用or连接的两个索引列】会产生索引合并。</p><p>我们针对某电商平台的检索功能做了优化，添加了三个索引，三个字段分别为【品牌】、【价格】、【销量】这三个的索引结构如下:</p><p><strong>（1）品牌的索引结构：</strong></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220517162932935.819a308c.png" alt="image-20220517162932935"></p><p><strong>（2）价格的索引结构：</strong></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220516145308003.e5328734.png" alt="image-20220516145308003"></p><p><strong>（3）销量的索引结构：</strong></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220516145354413.ca508ef0.png" alt="image-20220516145354413"></p><p>针对以上的索引我们进行如下的查询，分析检索过程：</p><ol><li><p>我们要检索品牌为阿玛尼（Armani）的包包</p><p>**第一步：**通过【品牌索引】检索出所有阿玛尼的商品id，回表查询，得到结果。</p><p>**结论：**会使用一个索引。</p></li><li><p>我们要检索名称为阿玛尼（Armani），价格在1万到3万之间的包包</p><p>查询的步骤如下：</p><p>**第一步：**通过【品牌索引】检索出所有阿玛尼的商品id。</p><p>**第二步：**直接回表扫描，根据剩余条件检索结果。</p><p>**结论：**只会使用第一个索引。</p></li><li><p>我们要检索名称为阿玛尼（Armani），价格为26800，且销量在50以上的包包</p><p>查询的步骤如下：</p><p>**第一步：**通过【品牌索引】检索出所有阿玛尼的商品id，进行缓存。</p><p>**第二步：**直接回表扫描，根据剩余条件检索结果。</p><p>**结论：**只会使用第一个索引。</p></li><li><p>我们要检索名称为阿玛尼（Armani）或名称为LV的包包</p><p>**第一步：**通过【品牌索引】检索出所有阿玛尼的商品id，得到结果。</p><p>**结论：**我们经常听说，有or索引会失效，但是像这样的【type =‘Armani’ or type = ‘LV’】并不会，他相当于一个in关键字，会使用一个索引。</p></li><li><p>我们要检索名称为阿玛尼（Armani）或价格大于8000的包包</p><p>**第一步：**通过【品牌索引】检索出所有阿玛尼的商品id，进行缓存。</p><p>**第二步：**通过【价格索引】检索出价格在5万到7万之间的商品id，这是一个连接条件带有【or的查询】，所以需要和上一步的结果进行【并集】，得到结果。</p><p>**结论：**这个过程叫【索引合并】当检索条件有or但是所有的条件都有索引时，索引不失效，可以走【两个索引】。</p></li><li><p>我们要检索名称为阿玛尼（Armani），且价格大于8000，且【产地（该列无索引）】在北京的包包</p><p>**第一步：**通过【品牌索引】检索出所有阿玛尼的商品id。</p><p>**第二步：**直接回表扫描，根据剩余条件检索结果。</p><p>**结论：**只会使用第一个索引。</p></li><li><p>我们要检索名称为阿玛尼（Armani）或价格大于8000，或【产地（该列无索引）】在北京的包包</p><p>**第一步：**优化器发现【产地列】无索引，同时连接的逻辑是【or】没有办法利用【索引】优化，只能全表扫描，索引失效。</p><p>**结论：**发生全表扫描，索引失效，条件中有没建立索引的列，同时关联条件是or。</p></li></ol><h4 id="_5、复合索引-联合索引-重要" tabindex="-1"><a class="header-anchor" href="#_5、复合索引-联合索引-重要"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_5%E3%80%81%E5%A4%8D%E5%90%88%E7%B4%A2%E5%BC%95-%E8%81%94%E5%90%88%E7%B4%A2%E5%BC%95-%E9%87%8D%E8%A6%81" target="_blank" rel="noopener noreferrer">#</a>5、复合索引（联合索引）重要</span></a></h4><p>当【查询语句】中包含【多个查询条件，且查询的顺序基本保持一致】时，我们推荐使用复合索引，索引的【组合使用】效率是低于【复合索引】的。</p><p>比如：我们经常按照A列、B列、C列进行查询时，通常的做法是建立一个由三个列共同组成的【复合索引】而不是对每一个列建立【普通索引】。</p><p>创建联合索引的方式如下：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line">alert <span class="token keyword">table</span> test <span class="token keyword">add</span> idx_a1_a2_a3 <span class="token keyword">table</span> <span class="token punctuation">(</span>a1<span class="token punctuation">,</span>a2<span class="token punctuation">,</span>a3<span class="token punctuation">)</span> </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 28.531s</span></span>
<span class="line"><span class="token keyword">create</span> <span class="token keyword">index</span> idx_user_nick_name <span class="token keyword">on</span> ydl_user<span class="token punctuation">(</span>user_name<span class="token punctuation">,</span>nick_name<span class="token punctuation">,</span>email<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>复合索引的结构如下，复合索引会优先按照第一列排序，第一列相同的情况下会按照第二列排序，以此类推，如下图：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220516130601156.241ed88b.png" alt="image-20220516130601156"></p><p>我们不妨把上边的图，转化为下边的表格，看起来会好一些：</p><table><thead><tr><th>品牌</th><th>价格</th><th>销量</th><th>id</th></tr></thead><tbody><tr><td>Armani</td><td>16800</td><td>35</td><td>13,24,76</td></tr><tr><td>Armani</td><td>26800</td><td>35</td><td>12,14,16</td></tr><tr><td>Armani</td><td>26800</td><td>100</td><td>34,56,17</td></tr><tr><td>Armani</td><td>68888</td><td>15</td><td>1,4,5,6,7</td></tr><tr><td>GUCCI</td><td>8999</td><td>135</td><td>78,92</td></tr><tr><td>LV</td><td>9999</td><td>326</td><td>55,63</td></tr><tr><td>LV</td><td>12888</td><td>99</td><td>57,99</td></tr><tr><td>LV</td><td>42888</td><td>69</td><td>11,22</td></tr><tr><td>PRADA</td><td>9588</td><td>125</td><td>111,202</td></tr></tbody></table><p>认真阅读了上边的介绍和图形，我们再次思考以下几个问题：</p><ol><li><p>我们要检索名称为阿玛尼（Armani）的包包</p><p>**第一步：**通过【品牌索引】检索出所有阿玛尼的商品id，回表查询，得到结果。</p><p>**结论：**会使用第一部分索引。</p></li><li><p>我们要检索名称为阿玛尼（Armani），价格在1万到3万之间的包包</p><p>查询的步骤如下：</p><p>**第一步：**通过【品牌索引】检索出所有阿玛尼的叶子节点。</p><p>**第二步：**在【满足上一步条件的叶子节点中】查询价格在1万到3万之间的包包的列，查询出对应的id，回表查询列数据。</p><p>**结论：**会使用复合索引的两个部分。</p></li><li><p>我们要检索名称为阿玛尼（Armani）或价格大于8000的包包</p><p>**第一步：**优化器发现我们并没有一个【价格列】的单独的二级索引，此时要查询价格大于8000的包，必须进行全表扫描。</p><p>**结论：**但凡查询的条件中没有【复合索引的第一部分】，索引直接【失效】，全表扫描。</p></li><li><p>我们要检索名称为阿玛尼（Armani），且价格大于8000，且【产地（该列无索引）】在北京的包包</p><p>**第一步：**通过【品牌索引】检索出所有阿玛尼的叶子节点。</p><p>**第二步：**在【满足上一步条件的叶子节点中】查询价格大于8000元的包包的叶子节点。</p><p>**第三步：**因为【产地列】无索引，但是是【and】的关系，我们只需要将上一步得到的结果回表查询，在这个很小的范围内，检索产地是不是北京即可。</p><p>**结论：**可以使用复合索引的两个部分。</p></li><li><p>我们要检索名称为阿玛尼（Armani）和LV之间，价格为在1万到3万的包包</p><p>查询的步骤如下：</p><p>**第一步：**通过【品牌索引】检索出所有阿玛尼和LV的所有叶子节点。</p><p>**第二步：**我们本想在第一步的结果中，快速定位价格的范围，但是发现一个问题，由于第一步不是等值查询，会导致后边的结果不连续，必须对【上一步的结果】全部遍历，才能拿到对应的结果。</p><p>**结论：**只会使用复合索引的第一个部分，这个就引出了【复合索引中特别重要的一个概念】-【最左前缀原则】。</p></li></ol><p>**重点：**最左前缀原则：</p><p>（1）最左前缀匹配原则，非常重要的原则，mysql会一直向右匹配直到遇到范围查询（&gt;、&lt;、between、like）就停止匹配，比如a = 1 and b = 2 and c &gt; 3 and d = 4 ，如果建立（a,b,c,d）顺序的联合索引，d是用不到索引的，如果建立(a,b,d,c)的索引则都可以用到，a,b,d的顺序可以任意调整。</p><p>（2）=和in可以乱序，比如a = 1 and b &lt; 2 and c = 3 ，咱们建立的索引就可以是（a,c,b）或者（c,a,b）。</p><p>**思考：**为什么联合索引的性能会比索引的组合使用效率高。</p><h4 id="_6、全文索引-fulltext" tabindex="-1"><a class="header-anchor" href="#_6、全文索引-fulltext"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_6%E3%80%81%E5%85%A8%E6%96%87%E7%B4%A2%E5%BC%95-fulltext" target="_blank" rel="noopener noreferrer">#</a>6、全文索引（FULLTEXT）</span></a></h4><p>做全文检索（不如百度的搜索功能）使用的索引，但是这种场景，我们有更好的替代品，如：ElacticSearch，所以实际使用不多，只当了解。</p><p>使用 like + % 实现的模糊匹配有点类似全文索引。但是对于大量的文本数据检索，全文索引比 like + % 快 N 倍，速度不是一个数量级，但是全文索引可能存在【精度问题】。同时普通索引在使用like时如果%放在首位，索引会失效。</p><blockquote><p>全文索引的版本支持</p></blockquote><ol><li>MySQL 5.6 以前的版本，只有 MyIsam 存储引擎支持全文索引。</li><li>MySQL 5.6 及以后的版本，MyIsam 和 InnoDB 存储引擎均支持全文索引。</li><li>只有字段的数据类型为 char、varchar、text 及其系列才可以建全文索引。</li></ol><blockquote><p>使用全文索引的注意</p></blockquote><ol><li>使用全文索引前，搞清楚版本支持情况。</li><li>全文索引比 like + % 快 N 倍，但是可能存在精度问题。</li><li>如果需要全文索引的是大量数据，建议先添加数据，再创建索引。</li><li>对于中文，可以使用 MySQL 5.7.6 之后的版本，或者第三方插件。</li></ol><p>（1）创建表时创建全文索引</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">create</span> <span class="token keyword">table</span> ydlclass_user <span class="token punctuation">(</span>    </span>
<span class="line">    <span class="token punctuation">.</span><span class="token punctuation">.</span>   </span>
<span class="line">    FULLTEXT <span class="token keyword">KEY</span> fulltext_text<span class="token punctuation">(</span><span class="token keyword">text</span><span class="token punctuation">)</span>  </span>
<span class="line"><span class="token punctuation">)</span> </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）在已存在的表上创建全文索引</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">create</span> fulltext <span class="token keyword">index</span> fulltext_text  <span class="token keyword">on</span> ydlclass_user<span class="token punctuation">(</span><span class="token keyword">text</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>本次创建用时143s：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220517172713080.7a8ee702.png" alt="image-20220517172713080"></p><p>（3）通过 SQL 语句 ALTER TABLE 创建全文索引</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">alter</span> <span class="token keyword">table</span> ydlclass_user <span class="token keyword">add</span> fulltext <span class="token keyword">index</span> fulltext_text<span class="token punctuation">(</span><span class="token keyword">text</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>（4）直接使用 DROP INDEX 删除全文索引</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">drop</span> <span class="token keyword">index</span> fulltext <span class="token keyword">index</span> <span class="token keyword">on</span> ydlclass_user<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>（5）全文检索的语法</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ydlclass_user <span class="token keyword">where</span> <span class="token keyword">match</span><span class="token punctuation">(</span><span class="token keyword">text</span><span class="token punctuation">)</span> against<span class="token punctuation">(</span><span class="token string">&#39;高号便法还历只办二主厂向际&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_8、hash索引" tabindex="-1"><a class="header-anchor" href="#_8、hash索引"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_8%E3%80%81hash%E7%B4%A2%E5%BC%95" target="_blank" rel="noopener noreferrer">#</a>8、hash索引</span></a></h4><p>hash索引是Memory存储引擎的默认方式，而且只有memory引擎支持hash索引，memory的数据是放在内存中的，一旦服务关闭，表中的数据就会丢失，我们可以使用如下的sql创建一张表:</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">\`</span>hash_user<span class="token punctuation">\`</span></span>  <span class="token punctuation">(</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">\`</span>user_id<span class="token punctuation">\`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;用户ID&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">\`</span>user_name<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;用户账号&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span>
<span class="line"><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> Memory <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8mb4 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8mb4_0900_ai_ci <span class="token keyword">COMMENT</span> <span class="token operator">=</span> <span class="token string">&#39;用户信息表&#39;</span> ROW_FORMAT <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>合理的使用memory引擎可以极大的提升性能，针对memory引擎的特点重启丢失），我们最好在其中存储一些公共的、常用的、不经常发生改变的数据，比如一些字典数据、配置数据等。同时，这些数据最好持久化在一些其他的地方，比如配置文件、其他的表，在程序启动的时候，主动的进行加载，我们可以使用如下sql，将一张表的数据加载到内存中：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">insert</span> <span class="token keyword">into</span> hash_user <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ydl_user <span class="token keyword">where</span> user_id <span class="token operator">&lt;</span> <span class="token number">2000000</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>我们在执行的过程种，可能有如下错误：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAxgAAABCCAYAAADUgHBoAAANZElEQVR4nO3dPXa6Th+G8ZtnLZLC4wpwBZomla0dltL8O8t0vwZK7dJa2QRWoCvwWAh7mafAFzCCiGhMcn3OsUjIMMMwGL7MDGMZY4wAAAAAoAH/++4CAAAAAPg9CDAAAAAANIYAAwAAAEBjCDAAAAAANIYAAwAAAEBj8gFGEqhrWRpF31SaJvyGYwCAZ8N3KwCgoiftwYg0skZ63P+xpvO7R/kfXSfPJFHQtWRZlqynOU+RRt1AydXpssdiyXr6u7VsHd3rPDyLv3yNNeUBdbgLdCzLknV6DWa3WV0FyZNuA4BfLh9gtMZaGqNp75tK04TfcAw40dJ4aWRMKPe7i7K7ye4GUnvwonh0ZZAQ/ZPXCWWMST8/qqE+03nAw93xuzUaVe0ZSRQMN5rsrp+w42l4uHOPNLI9dcLdtRUPNLf3wc4zbQOAP8AYY4yJje/ISDKSa0KTFRpXrvF9Z7ddxvHj4+bYN450fpsJjZvZ5mZ2HLqO8cNMWsc3sTEmdI9/f/i4+RKdV+8YLuZ3cnyVinImv/yx5/PL7bOwPsv3eaksYdHPDZ+/i2rmd/5YqqXL1fduY/12tj8M54pzkE+XP+Z9GUvqs6gNhq5xXDfd5vjGdyu2i9g3Tq4e02vnkO4kv6LrqfqhP08bPFf/x99dusbqluVSuz7neeqs/Lv1a1nO/s2FfZ+7Jiql9p3jdRu6uePJXaPPtA0A/oBdD8alJ5MzeZvJ7kmML80/d93SiYLhXIPYHJ7ILsetXZpEQXeht/2TWhNK/ewTnJW8d+kj8yTqXyT1pvtyuAqvespb7xjK84s0sjPHF/ta96t2defzW78fu/LTPLP7zAxBKazP8n3W0/z5u19+JfssSReNLPX1tcegfjtLezCGmsj3Q70tqvVgJEFXlmXJ9lZaefaZYRNF9VneBlczaWJCuStP83as2He03l5oFa1XDZyZFvtiJ5+ad8Ldk+mT/O7eW/HYNth66Wi1iXU6lKfzss+z6BqrW5a67fp56qz8u/WW9hJpZNmaD+KT77nq4s1K7lt63SbbtdR5UUvpdW/PB/J3hXmmbQDwF1Scg+Eq3N98tV7UWW0Upz/odSB5tqXu6V138qn5aqb+YQxqXzOtlb33cSdj7f+t9Kb3HtZUdAwlooVm7kSH/32tsSbuSpuLCS/kF42OY/BtT6tDmpL6rHsMpR59/m7L76zSdJEWM0f+f002rPRmazmWNvOt7Gm1wKQ1XsoYo9h35Pjx7mZsqex91dn6vNQG3TelubuaVL5Ja2k8cTXbRRjRv7kG+zo6ze/uHtwG7bYcSUq2krPWIpLijdS2D3s8f43VLUvddl3qib5367aXJFDX6kvh6UOUa3bRVX/tK3t5O20p6Fp6b8cyy7Fe9JzbAOC3u3mS9/7G6UPDr5NWHV+xOT5lO72h+psijfpr+QVP/Err8w4eff7ukl9puo5e7tLmepoujzdqP07vTe5soUiRFuuBXr/xQB7+HbLeKvrcqD0ZSNtI23XFdHdpn/X8+O/d1lhLE0r9oocp5ZKgK3s+UJy5BlsvHa28vjaTfdCSHM7tM20DgL+gsbdItcZLmdiXs96mQwpaL+qsqnS/F7n1KV8D+dltObP34zCWJND7zMk87bxdNOprdub3X+rzJsdjq5zfzeevXGP5labr6c2d6b30BubR7exKd2uDad0sRgsp80Q7zW+ReWvU+fZyvSdpg7teiYXaeu29qr1ZaFMlCL1L+7zkSeqszE3tpaepiTWY21cFGeeCi3R3b3KVuTaif/K06+F4pm0A8BekUzHykwKVm/xXNtnwNJ1jcnP1Tif/ZSa9hW75hLc4M9Gy2uTbusdwIb/QLT6+0rIU55edYOz4fsX6vHwMReLc5Paq+Zmbzl9xvdTJr+zclpfzS9qTQl/fzm5TPMm7pD6L2mDo7sp8bAtF+y8ozMlk72MZ9/m5Ydn1Xn1y//O0wd2E5exk/6rfE3XLUto+S0r6NHVWft6L28sVOVQu15myFJ6jk3I80zYA+OUsY4ypF5oA+MmSoKuhPmqPgQcAADjnSRfaQ3WRRocJnSefp1/EDd/h8EarzaSh4II2+LNx/gAAzaIHAwAAAEBj6MEAAAAA0BgCDAAAAACNIcAAHikJ1LUsMbQdAAD8Vg0EGImCbjoh8OtNU91t2e0j3fVeLLuq9uHT3a07EGl0l/zr7LcszbEuG6+vJFD3UB9VylLXver6Ts7Wy3fJnv8qE3PL2ssd2xIAAPgTDgFGNKqzomqioDuUPmL5TlPbdn8RDOV13Nwq13fRm2ZW1HYVPuvKt6VaGi+/rgqOJ9Qaa2mMpk0uuBX9k9cJjys3X9x5WXuhLQEAgNscAozeNF1R9brXErY0XhbdjNfdJikJNPQ6CqdvV5Tlfra713p+7W3Jv96xStVFI0uW1ddMM/XPPHFOtxfvM1uW6gHh9eU8aL2oU7DScVG9lB7DbohQ0TEU13XZsWWftJ/8XJpfcb1Eo66CKJO2G+RXVC+pl/Mu9AxcqJfSPW/Xcr4s7X2hXgAAAO4kM0QqfXIZt9+/eWhEomDoqRNO1eRD3vpm8jaT9Mlw7Gv9vr/RTBR0F3rbPzU2odS/XG+96WlvSf6Jc7rdHPPL7TNTFhOq4w0rDNGpV85MiTU1585FUb2UHUOiYDjXID5uz6/DULzPesryu1QvK3nv0sdue9jx9C9XaUX1UqSsZ+BSvRQc3X49C2+llWefDO8DAAD4Hl/mYLTGS5lQ6n/TjUo6NCqsNYQkyTz9bi5IchXuC9N6UWe1USxJyafmq0wvhNXXTGttb62z7JwQ29OqqCyy1XZW2sQX9nevchbVS+kxtPQ6kDy76Al9yT5rKcmvQr24k7H2t/m9acPDmqqWsyzVeCljjGLfkePHu+Dkpw3vAwAAv82XACMJurL6UvgtNyqJPucradbP3PSlN4FVhsvsb7jSzwN6QBxfsck8rb+5ziKN+mv58fGpevk4eEdfRsY8pJxlyo9hf44+NHzISsGl+T20Xm4oJwAAwA+SCzCikSV7M3nMzflZ+2Ek2ZvTdCjR/Z4e19R6UWd1OmzmGpd7EaJRX7PCjf/krSrMAbi5nLcpOobWeCkT+3LW2xuHQUnZuqyc3zfXS5FH1wsAAEDTcm+Rem/HFd5Ak7WfuGrLW0mzfnZoUt1tP0VP09jXup+Z0Hw6Ebgk7X9+OiQm/7S6pzd3dfj9e9s/6cHIDOnpS+EhENxPVs5MHj+U5ZZy1lF2DPlJ1ZY91+DjOAypbn7Zuqye36PrpewcfVe9lJXl3DYAAIDLLGOM+e5CAAAAAPgdWMkbT+7k6X72wzwFAACAp0MPBgAAAIDG0IMBAAAAoDH3DzCSQKNucH4CdzS6blVpAAAAAE+t0QAjSc6/a2bdeTn/2tveVG+LdHGxaFQwzt66bvExAAAAAN/nxgBj/7rZ9GPbdvUeiWgkqxvInhotxy31ptn1L46f2Hc1eG1g9bMkUPcQtFyxSvnFdPs6yL5mN18vV+UHAAAA/GC5dTCu7ylo6aWTLoRnjFHoutLipAfC9rQ6rMydv9F2Bq/pu/6j0Zdei2aHTkUa2Z464S5wiQea21XW3bicLgmG8jruyXoVJwsGhh15z7aiGwAAAHAHhwCjN401mNs3v/rz7bQnIvbluOHu56XGBZ0Rjh8f0oSuq7ey9f6SQN1regWihWaOr/92+0w+51pppsWlQ72ULgk09DoKp2+lu0m2azlt+6T8DAEDAADA75MZIpU+dY/b71euqn1cXbo/S39zdW+I3ZY8+3DDvd9PU5LtWuq8qLUrmz0fyHcvJruQLlEw9NQJp+fnl2TWb7DnA30cIqtEwXCuQXwMwpZFURcAAADww3yZg9EaL2VCqV+5hyA7RCr9TdobMrxq3kEn14Nx4Y9bYy1LekPOcdpS0LX03o5llmO93JguHRoValrY09LTdN+LM9nI7gZKq6Ol14Hk2fRcAAAA4Pf5EmAkQVdWXwqvvIHPa2m8vCV9s1ovHa28vjaTfW9Bou36lnSJPucr6TC3pK/Zrifn7Aiz3pvc1Vyfu3iiNV7KGKMPDVmRGgAAAL9KLsCIRpbszUTGFA37OZVou/46ROpq8Uaza4ZIXTsHo/cmV44O0yCif/J0nFuR/m70dXJ5YbqTSdwmlLvryTnboxEtNHMGOn0ZVmu8TOeorLeiLwMAAAC/Qe4tUu/tWKZ4zE+B4xCp6oHJid705PW0UykIGrzp7mkaDzS3dxOr+1K4HOtyB0vddMf5F5ZlyXpvKz6kO9lmzzX4qLJPAAAA4PlZxhhzlz0ngbq2p5UkNzzzZD8aqbv9r3iC8yG9q7Bu4AIAAADgoe4XYAAAAAD4c25cyRsAAAAAjggwAAAAADSGAAMAAABAYwgwAAAAADSGAAMAAABAYwgwAAAAADSGAAMAAABAYwgwAAAAADSGAAMAAABAYwgwAAAAADSGAAMAAABAYwgwAAAAADSGAAMAAABAYwgwAAAAADSGAAMAAABAYwgwAAAAADSGAAMAAABAYwgwAAAAADSGAAMAAABAYwgwAAAAADSGAAMAAABAY/4PwjlY6BTO+5EAAAAASUVORK5CYII=" alt="image-20220517192903131"></p><p>他告诉我，这个表使用的内存满了，放不下了，我们只需要调节下边两个参数，修改配置文件重启即可：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">tmp_table_size = 4096M</span>
<span class="line">max_heap_table_size = 4096M</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>基础工作完成，写几个sql语句尝试一下，我们发现真的一个字：快。</p><p>我们执行一下的sql</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> hash_user <span class="token keyword">where</span> email <span class="token operator">=</span> <span class="token string">&#39;i.jnoyelrsg@rpnglcvh.museum&#39;</span>  <span class="token comment">-- 0.189s</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>创建一个hash索引</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">create</span> <span class="token keyword">index</span> hash_idx_user_name <span class="token keyword">using</span> <span class="token keyword">hash</span> <span class="token keyword">on</span> hash_user<span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>再次查询</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> hash_user <span class="token keyword">where</span> email <span class="token operator">=</span> <span class="token string">&#39;i.jnoyelrsg@rpnglcvh.museum&#39;</span>  <span class="token comment">-- 0.017s</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>也有不错的效果。</p><p>关于hash索引需要了解的几点：</p><ul><li>hash是一种key-value形式的数据结构。实现一般是数组+链表的结构，通过hash函数计算出key在数组中的位置，然后如果出现hash冲突就通过链表来解决。当然还有其他的解决hash冲突的方法。hash这种数据结构是很常用的，比如我们系统使用HashMap来构建热点数据缓存，存取效率很好。</li><li>即使是相近的key，hash的取值也完全没有规律，索引hash索引不支持范围查询。</li><li>hash索引存储的是hash值和行指针，所以通过hash索引查询数据需要进行两次查询（首先查询行的位置，然后找到具体的数据）。</li><li>hash索引查询数据的前提就是计算hash值，也就是要求key为一个能准确指向一条数据的key，所以对于like等一类的匹配查询是不支持的。</li><li>只要是只需要做等值比较查询，而不包含排序或范围查询的需求，都适合使用哈希索引。</li></ul><h4 id="_7、空间索引-spatial" tabindex="-1"><a class="header-anchor" href="#_7、空间索引-spatial"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_7%E3%80%81%E7%A9%BA%E9%97%B4%E7%B4%A2%E5%BC%95-spatial" target="_blank" rel="noopener noreferrer">#</a>7、空间索引（SPATIAL）</span></a></h4><p>MySQL在5.7之后的版本支持了空间索引，而且支持OpenGIS几何数据模型。这是在地理位置领域使用的一种索引，其他场景用的很少，所以不需要深入学习。</p><h3 id="三、explain的用法" tabindex="-1"><a class="header-anchor" href="#三、explain的用法"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#%E4%B8%89%E3%80%81explain%E7%9A%84%E7%94%A8%E6%B3%95" target="_blank" rel="noopener noreferrer">#</a>三、explain的用法</span></a></h3><p>explain关键字可以模拟MySQL优化器执行SQL语句，可以很好的分析SQL语句或表结构的性能瓶颈。</p><p>explain的使用很简单，只需要在目标sql前加上这个关键字就可以了：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220513190241307.0f115ff8.png" alt="image-20220513190241307"></p><p><strong>执行explain会产生以下11列内容，如下：</strong></p><table><thead><tr><th>列号</th><th>列</th><th>说明</th></tr></thead><tbody><tr><td>1</td><td>id</td><td>select查询的序列号，包含一组数字，表示查询中执行select子句或操作表的顺序</td></tr><tr><td>2</td><td>select_type</td><td>查询类型</td></tr><tr><td>3</td><td>table</td><td>正在访问哪个表</td></tr><tr><td>4</td><td>partitions</td><td>匹配的分区</td></tr><tr><td>5</td><td>type</td><td>/访问的类型</td></tr><tr><td>6</td><td>possible_keys</td><td>显示可能应用在这张表中的索引，一个或多个，但不一定实际使用到</td></tr><tr><td>7</td><td>key</td><td>实际使用到的索引，如果为NULL，则没有使用索引</td></tr><tr><td>8</td><td>key_len</td><td>表示索引中使用的字节数，可通过该列计算查询中使用的索引的长度</td></tr><tr><td>9</td><td>ref</td><td>显示索引的哪一列被使用了，如果可能的话，是一个常数，哪些列或常量被用于查找索引列上的值</td></tr><tr><td>10</td><td>rows</td><td>根据表统计信息及索引选用情况，大致估算出找到所需的记录所需读取的行数 filtered //查询的表行占表的百分比</td></tr><tr><td>11</td><td>filtered</td><td>查询的表行占表的百分比</td></tr><tr><td>12</td><td>Extra</td><td>包含不适合在其它列中显示但十分重要的额外信息</td></tr></tbody></table><h4 id="_1、id字段" tabindex="-1"><a class="header-anchor" href="#_1、id字段"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_1%E3%80%81id%E5%AD%97%E6%AE%B5" target="_blank" rel="noopener noreferrer">#</a>1、id字段</span></a></h4><p>select查询的序列号，包含一组数字，表示查询中执行select子句或操作表的顺序</p><p>（1） id相同</p><p>id如果相同，可以认为是一组，执行顺序从上至下，如下查询语句：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student s<span class="token punctuation">,</span> scores sc <span class="token keyword">where</span> s<span class="token punctuation">.</span>id <span class="token operator">=</span> sc<span class="token punctuation">.</span>s_id</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220516175632471.aec555f3.png" alt="image-20220516175632471"></p><p>（2） id不同</p><p>如果是子查询，id的序号会递增，id的值越大优先级越高，越先被执行例子</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> age <span class="token operator">&gt;</span> <span class="token punctuation">(</span></span>
<span class="line">	<span class="token keyword">select</span> age <span class="token keyword">from</span> student <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">&#39;连宇栋&#39;</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220516180258900.0f568bab.png" alt="image-20220516180258900"></p><p>（3）id部分相同部分不同</p><p>id如果相同，可以认为是一组，从上往下顺序执行在所有组中，id值越大，优先级越高，越先执行例子：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">explain</span> </span>
<span class="line"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student s<span class="token punctuation">,</span> scores sc <span class="token keyword">where</span> s<span class="token punctuation">.</span>id <span class="token operator">=</span> sc<span class="token punctuation">.</span>s_id</span>
<span class="line"><span class="token keyword">union</span></span>
<span class="line"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student s<span class="token punctuation">,</span> scores sc <span class="token keyword">where</span> s<span class="token punctuation">.</span>id <span class="token operator">=</span> sc<span class="token punctuation">.</span>s_id<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220516180459139.b4df1b84.png" alt="image-20220516180459139"></p><h4 id="_2、select-type字段" tabindex="-1"><a class="header-anchor" href="#_2、select-type字段"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_2%E3%80%81select-type%E5%AD%97%E6%AE%B5" target="_blank" rel="noopener noreferrer">#</a>2、select_type字段</span></a></h4><p><strong>（1）SIMPLE</strong></p><p>简单查询，不包含子查询或Union查询的sql语句。</p><p><strong>（2）PRIMARY</strong></p><p>查询中若包含任何复杂的子部分，最外层查询则被标记为主查询。</p><p><strong>（3） SUBQUERY</strong></p><p>在select或where中包含子查询。</p><p><strong>（4）UNION</strong></p><p>若第二个select出现在uion之后，则被标记为UNION。</p><p><strong>（6）UNION RESULT</strong></p><p>从UNION表获取结果的合并操作。</p><h4 id="_3、type字段" tabindex="-1"><a class="header-anchor" href="#_3、type字段"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_3%E3%80%81type%E5%AD%97%E6%AE%B5" target="_blank" rel="noopener noreferrer">#</a>3、type字段</span></a></h4><p>最好到最差备注：掌握以下10种常见的即可NULL&gt;system&gt;const&gt;eq_ref&gt;ref&gt;ref_or_null&gt;index_merge&gt;range&gt;index&gt;ALL</p><p><strong>（1） NULL</strong></p><p>MySQL能够在优化阶段分解查询语句，在执行阶段用不着再访问表或索引，比如通过id没有找到例子：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token function">min</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">from</span> student<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220516180830093.f1e439bd.png" alt="image-20220516180830093"></p><p><strong>（2）system</strong></p><p>表只有一行记录（等于系统表），这是const类型的特列，平时不大会出现，可以忽略，我也没有实测出来。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">explain select * from mysql.proxies_priv</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>我实测一个只有一行记录的系统表，同样是all。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220518115948496.44153fd6.png" alt="image-20220518115948496"></p><p><strong>（3） const</strong></p><p>表示通过索引一次就找到了，const用于比较primary key或uique索引，因为只匹配一行数据，所以很快，如主键置于where列表中，MySQL就能将该查询转换为一个常量例子：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220516181115548.7e73b3f8.png" alt="image-20220516181115548"></p><p><strong>4. eq_ref</strong></p><p>唯一性索引扫描，对于每个索引键，表中只有一条记录与之匹配，常见于主键或唯一索引扫描例子：</p><p>被驱动表使用主键索面，结果唯一</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> scores sc <span class="token keyword">left</span> <span class="token keyword">join</span> student s <span class="token keyword">on</span> s<span class="token punctuation">.</span>id <span class="token operator">=</span> sc<span class="token punctuation">.</span>s_id</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220516183031354.2de188ef.png" alt="image-20220516183031354"></p><p><strong>5. ref</strong></p><p>非唯一性索引扫描，返回匹配某个单独值的所有行，本质上也是一种索引访问，返回所有匹配某个单独值的行，然而可能会找到多个符合条件的行，应该属于查找和扫描的混合体例子：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">&#39;白杰&#39;</span></span>
<span class="line"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student s <span class="token keyword">left</span> <span class="token keyword">join</span> scores sc <span class="token keyword">on</span> s<span class="token punctuation">.</span>id <span class="token operator">=</span> sc<span class="token punctuation">.</span>s_id</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220516183118398.d08c2df6.png" alt="image-20220516183118398"></p><p><strong>6. ref_or_null</strong></p><p>类似ref，但是可以搜索值为NULL的行例子：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student s <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">&#39;白杰&#39;</span> <span class="token operator">or</span> name <span class="token operator">is</span> <span class="token boolean">null</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220516183229589.daa35de1.png" alt="image-20220516183229589"></p><p><strong>7. index_merge</strong></p><p>表示使用了索引合并的优化方法例子：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">explain select * from student where id = 1 or name =&#39;李兴&#39;;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220516181626267.12ca24b4.png" alt="image-20220516181626267"></p><p><strong>8. range</strong></p><p>只检索给定范围的行，使用一个索引来选择行，key列显示使用了哪个索引一般就是在你的where语句中出现between、&lt;&gt;、in等的查询。例子：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">explain select * from student where id between 4 and 7;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220516181716830.9c6ab949.png" alt="image-20220516181716830"></p><p><strong>9. index</strong>（全索引扫描）</p><p>Full index Scan，Index与All区别：index只遍历索引树，通常比All快因为索引文件通常比数据文件小，也就是虽然all和index都是读全表，但index是从索引中读取的，而all是从硬盘读的。例子：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">explain select name from student;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220516181813844.c49ee252.png" alt="image-20220516181813844"></p><p><strong>10. ALL</strong>（全表扫）</p><p>Full Table Scan，将遍历全表以找到匹配行例子：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">explain select * from student;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220516181840924.dcb02ba6.png" alt="image-20220516181840924"></p><h4 id="_4、table字段" tabindex="-1"><a class="header-anchor" href="#_4、table字段"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_4%E3%80%81table%E5%AD%97%E6%AE%B5" target="_blank" rel="noopener noreferrer">#</a>4、table字段</span></a></h4><p>表示数据来自哪张表</p><h4 id="_5、possible-keys字段" tabindex="-1"><a class="header-anchor" href="#_5、possible-keys字段"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_5%E3%80%81possible-keys%E5%AD%97%E6%AE%B5" target="_blank" rel="noopener noreferrer">#</a>5、possible_keys字段</span></a></h4><p>显示可能应用在这张表中的索引，一个或多个查询涉及到的字段若存在索引，则该索引将被列出，但不一定被实际使用</p><h4 id="_6、key字段" tabindex="-1"><a class="header-anchor" href="#_6、key字段"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_6%E3%80%81key%E5%AD%97%E6%AE%B5" target="_blank" rel="noopener noreferrer">#</a>6、key字段</span></a></h4><p>实际使用到的索引，如果为NULL，则没有使用索引查询中若使用了覆盖索引（查询的列刚好是索引），则该索引仅出现在key列表</p><h4 id="_7、key-len字段" tabindex="-1"><a class="header-anchor" href="#_7、key-len字段"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_7%E3%80%81key-len%E5%AD%97%E6%AE%B5" target="_blank" rel="noopener noreferrer">#</a>7、key_len字段</span></a></h4><p>表示索引中使用的字节数，可通过该列计算查询中使用的索引的长度在不损失精确度的情况下，长度越短越好key_len显示的值为索引字段最大的可能长度，并非实际使用长度即key_len是根据定义计算而得，不是通过表内检索出的</p><h4 id="_8、ref字段" tabindex="-1"><a class="header-anchor" href="#_8、ref字段"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_8%E3%80%81ref%E5%AD%97%E6%AE%B5" target="_blank" rel="noopener noreferrer">#</a>8、ref字段</span></a></h4><p>哪些列或常量被用于查找索引列上的值</p><h4 id="_9、rows字段" tabindex="-1"><a class="header-anchor" href="#_9、rows字段"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_9%E3%80%81rows%E5%AD%97%E6%AE%B5" target="_blank" rel="noopener noreferrer">#</a>9、rows字段</span></a></h4><p>根据表统计信息及索引选用情况，大致估算出找到所需的记录所需读取的行数</p><h4 id="_10、partitions字段" tabindex="-1"><a class="header-anchor" href="#_10、partitions字段"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_10%E3%80%81partitions%E5%AD%97%E6%AE%B5" target="_blank" rel="noopener noreferrer">#</a>10、partitions字段</span></a></h4><p>匹配的分区</p><h4 id="_11、filtered字段" tabindex="-1"><a class="header-anchor" href="#_11、filtered字段"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_11%E3%80%81filtered%E5%AD%97%E6%AE%B5" target="_blank" rel="noopener noreferrer">#</a>11、filtered字段</span></a></h4><p>它指返回结果的行占需要读到的行(rows列的值)的百分比</p><h4 id="_12、extra字段" tabindex="-1"><a class="header-anchor" href="#_12、extra字段"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_12%E3%80%81extra%E5%AD%97%E6%AE%B5" target="_blank" rel="noopener noreferrer">#</a>12、Extra字段</span></a></h4><p>该列包含不适合在其它列中显示，但十分重要的额外信息，我们列举几个例子：</p><p><strong>（1）Using filesort</strong></p><p>只要使用非索引字段排序，就会出现这样的内容。</p><p><strong>（2）Using temporary</strong></p><p>使用了临时表保存中间结果，MySQL在对结果排序时使用临时表，常见于排序order by 和分组查询group by例子：</p><p><strong>（3）Using where</strong></p><p>使用了where条件例子：</p><p><strong>（4）impossible where</strong></p><p>where子句的值总是false，不能用来获取任何数据：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">explain select * from student where name = &#39;白洁&#39; and name = &#39;李兴&#39;;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220516182510228.1803ac6c.png" alt="image-20220516182510228"></p><p><strong>（5）Select tables optimized away</strong></p><p>SELECT操作已经优化到不能再优化了（MySQL根本没有遍历表或索引就返回数据了）例子：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token function">min</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">from</span> student<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220516182125161.920194f5.png" alt="image-20220516182125161"></p><p><strong>（6）no matching row in const table</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">explain select * from student where id &lt; 100 and id &gt; 200;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220516182318832.7e012d1a.png" alt="image-20220516182318832"></p><h3 id="三、使用索引的问题" tabindex="-1"><a class="header-anchor" href="#三、使用索引的问题"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#%E4%B8%89%E3%80%81%E4%BD%BF%E7%94%A8%E7%B4%A2%E5%BC%95%E7%9A%84%E9%97%AE%E9%A2%98" target="_blank" rel="noopener noreferrer">#</a>三、使用索引的问题</span></a></h3><p>设计好MySql的索引可以让你的数据库飞起来。但是，不合理的创建索引同样会产生很多问题？我们在设计MySql索引的时候有一下几点注意：</p><h4 id="_1、哪些情况下适合建索引" tabindex="-1"><a class="header-anchor" href="#_1、哪些情况下适合建索引"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_1%E3%80%81%E5%93%AA%E4%BA%9B%E6%83%85%E5%86%B5%E4%B8%8B%E9%80%82%E5%90%88%E5%BB%BA%E7%B4%A2%E5%BC%95" target="_blank" rel="noopener noreferrer">#</a>1、哪些情况下适合建索引</span></a></h4><ul><li>频繁作为where条件语句查询的字段</li><li>关联字段需要建立索引</li><li>分组，排序字段可以建立索引</li><li>统计字段可以建立索引，例如count()，max()等</li></ul><p><strong>小案例</strong>：还记得在学习临时表时，分析过group by的执行流程吗（分组字段没有索引）？有了索引之后的分组执行流程如下：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220512173224645.3b81778d.png" alt="image-20220512173224645"></p><p>直接使用索引信息，统计每个组的人数，直接返回。</p><h4 id="_2、哪些情况下不适合建索引" tabindex="-1"><a class="header-anchor" href="#_2、哪些情况下不适合建索引"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_2%E3%80%81%E5%93%AA%E4%BA%9B%E6%83%85%E5%86%B5%E4%B8%8B%E4%B8%8D%E9%80%82%E5%90%88%E5%BB%BA%E7%B4%A2%E5%BC%95" target="_blank" rel="noopener noreferrer">#</a>2、哪些情况下不适合建索引</span></a></h4><ul><li>频繁更新的字段不适合建立索引</li><li>where条件中用不到的字段不适合建立索引</li><li>表数据可以确定比较少的不需要建索引</li><li>数据重复且发布比较均匀的的字段不适合建索引（唯一性太差的字段不适合建立索引），例如性别，真假值</li><li>参与列计算的列不适合建索引，索引会失效</li></ul><h4 id="_3、能用复合索引的要使用复合索引" tabindex="-1"><a class="header-anchor" href="#_3、能用复合索引的要使用复合索引"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_3%E3%80%81%E8%83%BD%E7%94%A8%E5%A4%8D%E5%90%88%E7%B4%A2%E5%BC%95%E7%9A%84%E8%A6%81%E4%BD%BF%E7%94%A8%E5%A4%8D%E5%90%88%E7%B4%A2%E5%BC%95" target="_blank" rel="noopener noreferrer">#</a>3、能用复合索引的要使用复合索引</span></a></h4><h4 id="_4、null值也是可以走索引的-他被处理成最小值放在b-树的最左侧" tabindex="-1"><a class="header-anchor" href="#_4、null值也是可以走索引的-他被处理成最小值放在b-树的最左侧"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_4%E3%80%81null%E5%80%BC%E4%B9%9F%E6%98%AF%E5%8F%AF%E4%BB%A5%E8%B5%B0%E7%B4%A2%E5%BC%95%E7%9A%84-%E4%BB%96%E8%A2%AB%E5%A4%84%E7%90%86%E6%88%90%E6%9C%80%E5%B0%8F%E5%80%BC%E6%94%BE%E5%9C%A8b-%E6%A0%91%E7%9A%84%E6%9C%80%E5%B7%A6%E4%BE%A7" target="_blank" rel="noopener noreferrer">#</a>4、null值也是可以走索引的，他被处理成最小值放在b+树的最左侧</span></a></h4><h4 id="_5、使用短索引" tabindex="-1"><a class="header-anchor" href="#_5、使用短索引"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_5%E3%80%81%E4%BD%BF%E7%94%A8%E7%9F%AD%E7%B4%A2%E5%BC%95" target="_blank" rel="noopener noreferrer">#</a>5、使用短索引</span></a></h4><p>对字符串的列创建索引，如果可能，应该指定一个前缀长度。例如，如果有一个CHAR(255)的 列，如果在前10 个或20 个字符内，多数值是惟一的，那么就不要对整个列进行索引。短索引不仅可以提高查询速度而且可以节省磁盘空间和I/O操作。</p><h4 id="_6-排序的索引问题" tabindex="-1"><a class="header-anchor" href="#_6-排序的索引问题"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_6-%E6%8E%92%E5%BA%8F%E7%9A%84%E7%B4%A2%E5%BC%95%E9%97%AE%E9%A2%98" target="_blank" rel="noopener noreferrer">#</a>6，排序的索引问题</span></a></h4><p>mysql查询只使用一个索引，因此如果where子句中已经使用了索引的话，那么order by中的列是不会使用索引的。因此数据库默认排序可以符合要求的情况下不要使用排序操作；尽量不要包含多个列的排序，如果需要，最好给这些列创建<code>复合索引</code>。</p><h4 id="_7、mysql索引失效的几种情况" tabindex="-1"><a class="header-anchor" href="#_7、mysql索引失效的几种情况"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_7%E3%80%81mysql%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88%E7%9A%84%E5%87%A0%E7%A7%8D%E6%83%85%E5%86%B5" target="_blank" rel="noopener noreferrer">#</a>7、MySQL索引失效的几种情况</span></a></h4><ul><li>如果条件中有or，即使其中有条件带索引也不会使用走索引，除非全部条件都有索引</li><li>复合索引不满足最左原则就不能使用全部索引</li><li>like查询以%开头</li><li>存在列计算</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">explain select * from student where age = (18-1)</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>如果mysql估计使用全表扫描要比使用索引快，则不使用索引，比如结果的量很大</li><li>存在类型转化</li></ul><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token comment">-- 索引不失效</span></span>
<span class="line"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> age <span class="token operator">=</span> <span class="token string">&#39;18&#39;</span>  </span>
<span class="line"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ydl_user <span class="token keyword">where</span> login_date <span class="token operator">=</span> <span class="token string">&#39;2008-05-31 17:20:54&#39;</span></span>
<span class="line"><span class="token comment">-- 索引失效 本来是字符串，你使用数字和他比较</span></span>
<span class="line"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> gander <span class="token operator">=</span> <span class="token number">1</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220518183149811.7d62b011.png" alt="image-20220518183149811"></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220518183122831.b15ccfd6.png" alt="image-20220518183122831"></p><h2 id="第七章-锁机制" tabindex="-1"><a class="header-anchor" href="#第七章-锁机制"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#%E7%AC%AC%E4%B8%83%E7%AB%A0-%E9%94%81%E6%9C%BA%E5%88%B6" target="_blank" rel="noopener noreferrer">#</a>第七章 锁机制</span></a></h2><p>锁是为了保证数据库中数据的一致性，使各种【共享资源】在被访问时变得【有序】而设计的一种规则。</p><p>MysQL中不同的存储引擎支持不同的锁机制。 InoDB支持【行锁】，有时也会升级为表锁，MyIsam只支持表锁。</p><ul><li><p>【表锁】的特点就是开销小、加锁快，不会出现死锁。锁粒度大，发生锁冲突的概率小，并发度相对低。</p></li><li><p>【行锁】的特点就是开销大、加锁慢，会出现死锁。锁粒度小，发生锁冲突的概率高，并发度高。</p><p>今天我们讲锁主要从InnoDB引擎来讲，因为它既支持行锁、也支持表锁。</p></li></ul><h3 id="一、innodb的锁类型" tabindex="-1"><a class="header-anchor" href="#一、innodb的锁类型"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#%E4%B8%80%E3%80%81innodb%E7%9A%84%E9%94%81%E7%B1%BB%E5%9E%8B" target="_blank" rel="noopener noreferrer">#</a>一、InnoDB的锁类型</span></a></h3><p>InnoDB的锁类型主要有读锁(共享锁)、写锁(排他锁)、意向锁和MDL锁。</p><h4 id="_1、s锁" tabindex="-1"><a class="header-anchor" href="#_1、s锁"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_1%E3%80%81s%E9%94%81" target="_blank" rel="noopener noreferrer">#</a>1、s锁</span></a></h4><p>读锁（共享锁，shared lock）简称S锁。一个事务获取了一个数据行的读锁，其他事务也能获得该行对应的读锁，但不能获得写锁，即一个事务在读取一个数据行时，其他事务也可以读，但不能对该数行增删改的操作。</p><p>**注：**读锁是共享锁，多个事务可以同时持有，当有一个或多个事务持有共享锁时，被锁的数据就不能修改。</p><p>简而言之：就是可以多个事务读，但只能一个事务写。</p><p>读锁是通过【select.... lock in share mode】语句给被读取的行记录或行记录的范围上加一个读锁,让其他事务可以读，但是要想申请加写锁，那就会被阻塞。</p><p>事务一：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">begin</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ydl_student <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">lock</span> <span class="token operator">in</span> <span class="token keyword">share</span> <span class="token keyword">mode</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>事务二：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">begin</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">update</span> ydl_student <span class="token keyword">set</span> score <span class="token operator">=</span> <span class="token string">&#39;90&#39;</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>卡住了，说明程序被阻塞，确实加了锁。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220517195919549.32b88fda.png" alt="image-20220517195919549"></p><p>s锁是可以被多个事务同时获取的，我们在两个不同的事务中分别对同一行数据加上s锁，结果都可以成功，如下图：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220517202512738.401cab24.png" alt="image-20220517202512738"></p><h4 id="_2、x锁" tabindex="-1"><a class="header-anchor" href="#_2、x锁"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_2%E3%80%81x%E9%94%81" target="_blank" rel="noopener noreferrer">#</a>2、x锁</span></a></h4><p>写锁，也叫排他锁，或者叫独占所，简称x锁（exclusive）。一个事务获取了一个数据行的写锁，既可以读该行的记录，也可以修改该行的记录。但其他事务就不能再获取该行的其他任何的锁，包括s锁，直到当前事务将锁释放。【这保证了其他事务在当前事务释放锁之前不能再修改数据】。</p><p>**注：**写锁是独占锁，只有一个事务可以持有，当这个事务持有写锁时，被锁的数据就不能被其他事务修改。</p><p>（1）一些DML语句的操作都会对行记录加写锁。</p><p>事务一：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">begin</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">update</span> ydl_student <span class="token keyword">set</span> score <span class="token operator">=</span> <span class="token string">&#39;90&#39;</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>事务二：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">begin</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">update</span> ydl_student <span class="token keyword">set</span> score <span class="token operator">=</span> <span class="token string">&#39;88&#39;</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>卡住了，说明程序被阻塞，确实加了锁。但是，我们发现其他事务还能读，有点不符合逻辑，这是应为mysql实现了MVCC模型，后边会详细介绍。</p><p>（2）比较特殊的就是select for update，它会对读取的行记录上加一个写锁，那么其他任何事务不能对被锁定的行上加任何锁了，要不然会被阻塞。</p><p>事务一：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">begin</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ydl_student <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">for</span> <span class="token keyword">update</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>事务二：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">begin</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">update</span> teacher <span class="token keyword">set</span> name <span class="token operator">=</span> <span class="token string">&#39;lucy2&#39;</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>卡住了，说明加了锁了。</p><p>（3）x锁是只能被一个事务获取，我们在两个不同的事务中分别对同一行数据加上x锁，发现后者会被阻塞，如下图：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220517202800421.b9a51153.png" alt="image-20220517202800421"></p><h4 id="_3、记录锁-record-lock" tabindex="-1"><a class="header-anchor" href="#_3、记录锁-record-lock"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_3%E3%80%81%E8%AE%B0%E5%BD%95%E9%94%81-record-lock" target="_blank" rel="noopener noreferrer">#</a>3、记录锁（Record Lock）</span></a></h4><p>记录锁就是我们常说的行锁，只有innodb才支持，我们使用以下四个案例来验证记录锁的存在：</p><p>（1）两个事务修改【同一行】记录，该场景下，where条件中的列不加索引。</p><p>事务一：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">begin</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">update</span> ydl_student <span class="token keyword">set</span> score <span class="token operator">=</span> <span class="token string">&#39;77&#39;</span> <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">&#39;jack&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>事务二：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">begin</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">update</span> ydl_student <span class="token keyword">set</span> score <span class="token operator">=</span> <span class="token string">&#39;80&#39;</span> <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">&#39;jack&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>发现事务二卡住了，只有事务一提交了，事务二才能继续执行，很明显，这一行数据被【锁】住了。</p><p>（2）两个事务修改同表【不同行】记录，此时where条件也不加索。</p><p>事务一：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">begin</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">update</span> ydl_student <span class="token keyword">set</span> score <span class="token operator">=</span> <span class="token string">&#39;76&#39;</span> <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">&#39;hellen&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>事务二：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">begin</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">update</span> ydl_student <span class="token keyword">set</span> score <span class="token operator">=</span> <span class="token string">&#39;66&#39;</span> <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">&#39;jack&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>现事务二卡住了，只有事务一提交了，事务二才能继续执行，很明显，表被【锁】住了。</p><p>（3）两个事务修改【同一行】记录，where条件加索引</p><p>事务一：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">begin</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">update</span> ydl_student <span class="token keyword">set</span> score <span class="token operator">=</span> <span class="token string">&#39;99&#39;</span> <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">&#39;jack&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>事务二：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">begin</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">update</span> ydl_student <span class="token keyword">set</span> score <span class="token operator">=</span> <span class="token string">&#39;79&#39;</span> <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">&#39;jack&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>现事务二卡住了，只有事务一提交了，事务二才能继续执行，很明显，这一行数据被【锁】住了。</p><p>（4）两个事务修改同表【不同行】记录，此时where条件加索。</p><p>事务一：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">begin</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">update</span> ydl_student <span class="token keyword">set</span> score <span class="token operator">=</span> <span class="token string">&#39;77&#39;</span> <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">&#39;hellen&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>事务二：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">begin</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">update</span> ydl_student <span class="token keyword">set</span> score <span class="token operator">=</span> <span class="token string">&#39;77&#39;</span> <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">&#39;jack&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>发现都可以顺利修改，说明锁的的确是行。</p><p>**证明：**行锁是加在索引上的，这是标准的行级锁。</p><h4 id="_4、间隙锁-gap-lock" tabindex="-1"><a class="header-anchor" href="#_4、间隙锁-gap-lock"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_4%E3%80%81%E9%97%B4%E9%9A%99%E9%94%81-gap-lock" target="_blank" rel="noopener noreferrer">#</a>4、间隙锁（GAP Lock）</span></a></h4><p>间隙锁帮我们解决了mysql在rr级别下的一部分幻读问题。间隙锁锁定的是记录范围，不包含记录本身，也就是不允许在某个范围内插入数据。</p><p>间隙锁生成的条件：</p><p>1、A事务使用where进行范围检索时未提交事务，此时B事务向A满足检索条件的范围内插入数据。</p><p>2、where条件必须有索引。</p><p>第一步把teacher表的id的4改成8</p><p>事务一：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">begin</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ydl_student <span class="token keyword">where</span> id <span class="token operator">between</span> <span class="token number">3</span> <span class="token operator">and</span> <span class="token number">7</span> <span class="token keyword">lock</span> <span class="token operator">in</span> <span class="token keyword">share</span> <span class="token keyword">mode</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>事务二：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">begin</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">insert</span> <span class="token keyword">into</span> ydl_student <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string">&#39;tom&#39;</span><span class="token punctuation">,</span><span class="token number">66</span><span class="token punctuation">,</span><span class="token string">&#39;d&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>发现卡住了，第一个事务会将id在3到7之间的数据全部锁定，不允许在缝隙间插入。</p><p>事务三：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">begin</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">insert</span> <span class="token keyword">into</span> ydl_student <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token string">&#39;tom&#39;</span><span class="token punctuation">,</span><span class="token number">66</span><span class="token punctuation">,</span><span class="token string">&#39;d&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>插入一个id为11的数据，竟然成功了，因为11不在事务一的检索的范围。</p><h4 id="_5、记录锁和间隙锁的组合-next-key-lock" tabindex="-1"><a class="header-anchor" href="#_5、记录锁和间隙锁的组合-next-key-lock"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_5%E3%80%81%E8%AE%B0%E5%BD%95%E9%94%81%E5%92%8C%E9%97%B4%E9%9A%99%E9%94%81%E7%9A%84%E7%BB%84%E5%90%88-next-key-lock" target="_blank" rel="noopener noreferrer">#</a>5、记录锁和间隙锁的组合（next-key lock）</span></a></h4><p><strong>临键锁</strong>，是<strong>记录锁与间隙锁的组合</strong>，它的封锁范围，既包含【索引记录】，又包含【索引区间】。</p><p>**注：*<em>临键锁的主要目的，也是为了避免*<em>幻读</em></em>(Phantom Read)。如果把事务的隔离级别降级为RC，临键锁则也会失效。</p><h4 id="_6、mdl锁" tabindex="-1"><a class="header-anchor" href="#_6、mdl锁"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_6%E3%80%81mdl%E9%94%81" target="_blank" rel="noopener noreferrer">#</a>6、MDL锁</span></a></h4><p>MySQL 5.5引入了meta data lock，简称MDL锁，用于保证表中<code>元数据</code>的信息。在会话A中，表开启了查询事务后，会自动获得一个MDL锁，会话B就不可以执行任何DDL语句，不能执行为表中添加字段的操作，会用MDL锁来保证数据之间的一致性。</p><p>元数据就是描述数据的数据，也就是你的表结构。意识是在你开启了事务之后获得了意向锁，其他事务就不能更改你的表结构。MDL锁都是为了防止在事务进行中，执行DDL语句导致数据不一致。</p><h4 id="_7、死锁问题" tabindex="-1"><a class="header-anchor" href="#_7、死锁问题"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_7%E3%80%81%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98" target="_blank" rel="noopener noreferrer">#</a>7、死锁问题</span></a></h4><p>发生死锁的<strong>必要条件</strong>有4个，分别为互斥条件、不可剥夺条件、请求与保持条件和循环等待条件：</p><ul><li><strong>互斥条件</strong>，在一段时间内，计算机中的某个资源只能被一个进程占用。此时，如果其他进程请求该资源，则只能等待。</li><li><strong>不可剥夺条件</strong>，某个进程获得的资源在使用完毕之前，不能被其他进程强行夺走，只能由获得资源的进程主动释放。</li><li><strong>请求与保持条件</strong>，进程已经获得了至少一个资源，又要请求其他资源，但请求的资源已经被其他进程占有，此时请求的进程就会被阻塞，并且不会释放自己已获得的资源。</li><li><strong>循环等待条件</strong>，系统中的进程之间相互等待，同时各自占用的资源又会被下一个进程所请求。例如有进程A、进程B和进程C三个进程，进程A请求的资源被进程B占用，进程B请求的资源被进程C占用，进程C请求的资源被进程A占用，于是形成了循环等待条件，如图1-7所示。</li></ul><p>我模拟了一个死锁场景，如下：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220517205641323.59d24a58.png" alt="image-20220517205641323"></p><p>InnoDB使用的是行级锁，在某种情况下会产生死锁问题，所以InnoDB存储引擎采用了一种叫作<strong>等待图</strong>（wait-for graph）的方法来自动检测死锁，如果发现死锁，就会自动回滚一个事务。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220517205123881.a8b4a1ca.png" alt="image-20220517205123881"></p><p><strong>在MySQL中，通常通过以下几种方式来避免死锁。</strong></p><ul><li>尽量让数据表中的数据检索都通过索引来完成，避免无效索引导致行锁升级为表锁。</li><li>合理设计索引，尽量缩小锁的范围。</li><li>尽量减少查询条件的范围，尽量避免间隙锁或缩小间隙锁的范围。</li><li>尽量控制事务的大小，减少一次事务锁定的资源数量，缩短锁定资源的时间。如果一条SQL语句涉及事务加锁操作，则尽量将其放在整个事务的最后执行。</li></ul><h3 id="二、表锁" tabindex="-1"><a class="header-anchor" href="#二、表锁"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#%E4%BA%8C%E3%80%81%E8%A1%A8%E9%94%81" target="_blank" rel="noopener noreferrer">#</a>二、表锁</span></a></h3><p>1、对于InnoDB表，在绝大部分情况下都应该使用【行级锁】，因为事务和行锁往往是我们之所以选择InnoDB表的理由。但在个另特殊事务中，也可以考虑使用表级锁。</p><ul><li>第一种情况是：事务需要更新【大部分或全部数据】，表又比较大，如果使用默认的行锁，不仅这个事务执行效率低，而且可能造成其他事务长时间锁等待和锁冲突，这种情况下可以考虑使用表锁来提高该事务的执行速度。</li><li>第二种情况是：事务涉及多个表，比较复杂，很可能引起死锁，造成大量事务回滚。这种情况也可以考虑一次性锁定事务涉及的表，从而避免死锁、减少数据库因事务回滚带来的开销。</li></ul><p>2、在InnoDB下 ，主动上表锁的方式如下：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">lock</span> <span class="token keyword">tables</span> teacher <span class="token keyword">write</span><span class="token punctuation">,</span>student <span class="token keyword">read</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> teacher<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">commit</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">unlock</span> <span class="token keyword">tables</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用时有几点需要额外注意：</p><ul><li>使用【LOCK TALBES】虽然可以给InnoDB加表级锁，但必须说明的是，表锁不是由InnoDB存储引擎层管理的，而是由其上一层ＭySQL Server负责的，仅当autocommit=0、innodb_table_lock=1（默认设置）时，InnoDB层才能感知MySQL加的表锁，ＭySQL Server才能感知InnoDB加的行锁，这种情况下，InnoDB才能自动识别涉及表级锁的死锁；否则，InnoDB将无法自动检测并处理这种死锁。</li><li>在用LOCAK TABLES对InnoDB加锁时要注意，事务结束前，不要用UNLOCAK TABLES释放表锁，因为UNLOCK TABLES会隐含地提交事务；COMMIT或ROLLBACK不能释放用LOCAK TABLES加的表级锁，必须用UNLOCK TABLES释放表锁，正确的方式见如下语句。</li><li>表锁的力度很大，慎用。</li></ul><h3 id="三、从另一个角度区分锁的分类" tabindex="-1"><a class="header-anchor" href="#三、从另一个角度区分锁的分类"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#%E4%B8%89%E3%80%81%E4%BB%8E%E5%8F%A6%E4%B8%80%E4%B8%AA%E8%A7%92%E5%BA%A6%E5%8C%BA%E5%88%86%E9%94%81%E7%9A%84%E5%88%86%E7%B1%BB" target="_blank" rel="noopener noreferrer">#</a>三、从另一个角度区分锁的分类</span></a></h3><h4 id="_1、乐观锁" tabindex="-1"><a class="header-anchor" href="#_1、乐观锁"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_1%E3%80%81%E4%B9%90%E8%A7%82%E9%94%81" target="_blank" rel="noopener noreferrer">#</a>1、乐观锁</span></a></h4><p>乐观锁大多是基于数据【版本记录机制】实现，一般是给数据库表增加一个&quot;version&quot;字段。</p><p>读取数据时，将此版本号一同读出，</p><p>更新时，对此版本号加一。此时将提交数据的版本数据与数据库表对应记录的当前版本信息进行比对，如果提交的数据版本号大于数据库表当前版本号，则予以更新，否则认为是过期数据。</p><p>事务一：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">select * from ydl_student where id = 1;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>事务二：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ydl_student <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">update</span> ydl_student <span class="token keyword">set</span> score <span class="token operator">=</span> <span class="token number">99</span><span class="token punctuation">,</span>version <span class="token operator">=</span> version <span class="token operator">+</span> <span class="token number">1</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">and</span> version <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">commit</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>事务一：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">update</span> ydl_student <span class="token keyword">set</span> score <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">,</span>version <span class="token operator">=</span> version <span class="token operator">+</span> <span class="token number">1</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">and</span> version <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">commit</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>发现更新失败，应为版本号被事务二、提前修改了，这使用了不加锁的方式，实现了一个事务修改期间，禁止其他事务修改的能力。</p><h4 id="_2、悲观锁" tabindex="-1"><a class="header-anchor" href="#_2、悲观锁"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_2%E3%80%81%E6%82%B2%E8%A7%82%E9%94%81" target="_blank" rel="noopener noreferrer">#</a>2、悲观锁</span></a></h4><p>总有刁民想害朕</p><p>悲观锁依靠数据库提供的锁机制实现。MySQL中的共享锁和排它锁都是悲观锁。数据库的增删改操作默认都会加排他锁，而查询不会加任何锁。此处不赘述。</p><h2 id="第八章-日志系统" tabindex="-1"><a class="header-anchor" href="#第八章-日志系统"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#%E7%AC%AC%E5%85%AB%E7%AB%A0-%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F" target="_blank" rel="noopener noreferrer">#</a>第八章 日志系统</span></a></h2><p>mysql给我们提供了很多有用的日志，这是mysql服务层给我们提供的：</p><table><thead><tr><th>日志类型</th><th>写入日志的信息</th></tr></thead><tbody><tr><td>二进制日志</td><td>记录了对MySQL数据库执行更改的所有操作</td></tr><tr><td>慢查询日志</td><td>记录所有执行时间超过 long_query_time 秒的所有查询或不使用索引的查询</td></tr><tr><td>错误日志</td><td>记录在启动，运行或停止mysqld时遇到的问题</td></tr><tr><td>通用查询日志</td><td>记录建立的客户端连接和执行的语句</td></tr><tr><td>中继日志</td><td>从复制主服务器接收的数据更改</td></tr></tbody></table><h3 id="一、bin-log日志" tabindex="-1"><a class="header-anchor" href="#一、bin-log日志"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#%E4%B8%80%E3%80%81bin-log%E6%97%A5%E5%BF%97" target="_blank" rel="noopener noreferrer">#</a>一、bin log日志</span></a></h3><h4 id="_1、概述-1" tabindex="-1"><a class="header-anchor" href="#_1、概述-1"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_1%E3%80%81%E6%A6%82%E8%BF%B0" target="_blank" rel="noopener noreferrer">#</a>1、概述</span></a></h4><p>二进制日志（binnary log）以【事件形式】记录了对MySQL数据库执行更改的所有操作。</p><p>binlog记录了所有数据库【表结构】变更（例如CREATE、ALTER TABLE…）以及【表数据】修改（INSERT、UPDATE、DELETE…）的二进制日志。不会记录SELECT和SHOW这类操作，因为这类操作对数据本身并没有修改，但可以通过查询通用日志来查看MySQL执行过的所有语句。</p><p>binlog是mysql server层维护的，跟采用何种引擎没有关系，记录的是所有的更新操作的日志记录。binlog是在事务最终commit前写入的。我们执行SELECT等不涉及数据更新的语句是不会记binlog的，而涉及到数据更新则会记录。要注意的是，对支持事务的引擎如innodb而言，必须要提交了事务才会记录binlog。</p><p>binlog 文件写满后，会自动切换到下一个日志文件继续写，而不会覆盖以前的日志，这个也区别于 redo log，redo log 是循环写入的，即后面写入的可能会覆盖前面写入的。</p><p>binlog有两个常用的使用场景：</p><ul><li>主从复制：我们会专门有一个章节代领大家搭建一个主从同步的两台mysql服务。</li><li>数据恢复：通过mysqlbinlog工具来恢复数据。</li></ul><p>mysql8中的binLog默认是开启的，5.7默认是关闭的，可以通过参数<code>log_bin</code>控制：</p><h4 id="_2、数据恢复" tabindex="-1"><a class="header-anchor" href="#_2、数据恢复"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_2%E3%80%81%E6%95%B0%E6%8D%AE%E6%81%A2%E5%A4%8D" target="_blank" rel="noopener noreferrer">#</a>2、数据恢复</span></a></h4><p>（1）确认binlog开启，log_bin变量的值为ON代表binlog是开启状态：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">show variables like <span class="token string">&#39;%log_bin%&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>（2）为了防止干扰，我们flush刷新log日志，自此刻会产生一个新编号的binlog日志文件：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">flush logs<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>（3）查看所有binlog日志列表：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">show master logs<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220507135555872.fabcd807.png" alt="image-20220507135555872"></p><p>（4）查看master状态，即最后(最新)一个binlog日志的编号名称，及其最后一个操作事件pos结束点(Position)值，这一步可有可无： <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAyIAAAA/CAYAAAAc7XyGAAANLUlEQVR4nO3dP2zb6BnH8R97Bxw6ebngpgLFmXKQq70VKCyjXbqUSlBocjolnaSiw1lG4S13Q+OigwdRNxSVhuIuU0+TWiTiFWiXFpHR4ja7CWLRRYGbgstgj0VRsINIiZL1h5IpSpS/H0CD/NovX77va4oP+byUcXFx4cm3trYmSTo7O9N7772ntHn9+rU2NjYW3YxYpHkM0truVZk7AAAAaWCEA5HXr18vsi2xWJWTybOzs0U3AQAAAJgbY9gdEQAAAACYp28sugEAAAAAbh4CEQAAAACJIxABAAAAkDgCEQAAAACJe3vWPzw/P9f/1r4VZ1uQcm9dfqX19fVFN+PGOT8/p99TjPHDMMwLjMLcwCrhjggAAACAxBGIAAAAAEgcgQgAAACAxBGIAAAAAEjcfAORf32i+7e+r0//JUlf6ONbP9df57pBrDTXVtbIynanLENP5H5yVDSKcpJoE6Jj/JBWTlFG1lash+hJ/w/z2CaAWMUUiLj61HpHt2+FXtYn+nc8lSOVXNlZQ4bRexU5K0qEU+zv9+X8IL46P4xYTpyj1bvMfbTMbQtzioayqYn80z4v5vX/sowG93Xe++moyOcUsDCx3hG5//v/6NXX/sv5UN9+/0N9/vXf9NP349wK0mNb5bYnz/Pktcs6yV3zjoVZUstrqWRKwYdV90Ojrwzb5Xan3z1Pza19ZYKOWrJ+KjS9bju9ppSL6UQgSr0j+2gJpGX80ibt86Kv/V5VVqJbHzjmzmUTtrJGRi8/Cu9nXo1uQBj3cd9R0chJ3X5t687jKIFPAn0B3BCsEUEyzJI+Khyr/nQ5ri/eJJk724tuQjRW1Q9YY74CGqHeZe6jZW5bqqV8XqweV/aDfW01PVX7IixL1VZJc4m93Vc62S7roLs9U6VW0gEecLMlsEZk1LqQL/RxKJXr/m85Qb1Z+m+HD95+d+3s1TLXVtYoypGjopHR/rFUy/npE92yKPU7KhpZ2XaxW55NTYrJtFw9rR+rkPc/Wvv6aZp+GD9e/eV+nbOktZj3tLtdU6Nb+aTtzlpv2EAfLZU0jd+4Oia1dVz7gqvP/u/01Wlc7384tfOip3Os7PWXUzRkdC/Vj+ujIWWDx9Fxx9wp6zdytQk78lR1hYOCQTMc9ydt07ytreN9HY08qAzbv1F9AWAWsQYin/8kamDxhT6+9Su9//cgleufsv7wHX38lzhbg6Xi2npc29buPVPB7fCTUApEJ02iF3A82N9Sc2QKgqWq11Z5209VuHK1bEL9kqRj7b/Md9PGtP9gpRa6H+9n/A/PjPbHfrhH6YdJ/TmY3vBEqk84AYgkyjjOLnofJS994xeljlFtjTbOtVxDeS/4f3dUNB7rTruXUrNbz8SSKrPM86KWC51k+ztrllpqFmp6bLuSU1TupKx21ZLG9tHVPm+NzW8adsydXL9CqWTNwoSda7/Ucfi9ayvbF5hGO+5PtU1ZqjYLfr8OC86H7d+kdgCYxtzWiHz+szH/mn/5oz7XP/Tr7wWBy3f06y+lV+0VOhOEpGPtZ/wPkkxdu20/l9dpqLZd1pPwB591oHJwZdK8rS3VlJv1KViT6pckbascnGGY97S7YhkY4Tx376OXyow8eY/QD5P60y/vS2/4aOIZwLjW604mwnZnrTd4F7mPkpe68YtUx4i2RhznQjN0QcJpqBY+vvhXqE9ezXLASM+86FsjEspfsqpNbe1nZOROVH7inxiP66NhfT6tCPWHgzgrP+WcMktqeZ48r6lIfznrNq2qPM9Tu3yiXCjAi3eOARhlcWtEvnukP30dWtw+KXhBCoUWq0daUBicEFiqBldVH/hpHrEc+/tPOG4MK6+CThT/5+cc+tM50r52dW/sXJlhu5PqnVsfxSBN4xerCe3bLqvthU7MJ17VHyLN8yKKOPooqfqtvArHdS1qGaFZanWCnlqud2dt3v0HYEGByA9/rPtfHuh3oVSsv/6C7xi5May8Csf7ehCOLsInBK4t25E6CwfbKm8f62U7xvpvGqehmrZ0e9Z9n9Sffnkvz9qV/XiG1Cyn2H9FN65xHKx36O9cs4/mKQ3jd506ZhnnK9uTnOKUdy7SPi9CnGInzaqT8eavWRjXR1fKHNnd/u8FXu7Ten+6VNhU9UeZD5YOytJ+ZsYLT7Ns07WVvZLP5wfAccwxABMt6I7Ij/TLvx/pVWhNyZ9zv9EPFtMYJM5S1fNTCbqLCqVmkGtrlnS7EbodvtUceIqKJJm6t7s9YrHghPpvgOPBfb/Woz4n9aelarusk27++gNpN1oaRl/O++M7avfdOZt9HMfX2xFvH8UrLePXt42Z65hlnAe3Z6iRn9xHaZ8Xfe337xQ7RUO5k06alVl6orKCRw6P66PBsoZul0zJLOlJWd10pAcvt9TL9hs85k6ov7v2Ivp8MEstee1d1TPh/czppHzg1zvhuD/tNs2Sntx53LctNYM5MW7/xrUDwDSMi4sLL3iztrYW+Q/Pz8/1v7VvzaVRSKe3Lr/S+vr6optx45yfny9fvzvFzoneDQr+ZrWy48ccuJalnBdYCswNrBK+RwTANbmyswOP0MzVtL17jxPQVIhj/JgDAIDpEYgAuCZTpSd39LgvlaLtL+oc/H6Izuv6j1mdV703URzjN66OJDEvlt8ixoh5ASwrUrMQG1KzFoPb9OnG+GEY5gVGYW5glXBHBAAAAEDiCEQAAAAAJK4vNevNmzeLbAsAAAAmIDULq+Lt8Jtp1nywHgCDLi8vp1pnhHjQ7+nG+GEY5gVGuby8XHQTgNiQmgUAAAAgcQQiAAAAABJHIAIAAAAgcQQiAAAAABI3MhC5feudJNtxDY6KRlGjvyDVVWVnzDeouhXtGDuquPNpHQAAAICrxt4RSU8wsgiOioYhwzBkXAlkEi5zK9rplo0JurBgnTHcGYh63cpOd+wMw5AxOIBOMVQ+LugGAABIj4mpWSsfjJh7eu491545zR+5quzkdGq35XmevOamSpngBDHpMkfFTEmbTc8vK6iW42R1uXTuyhlGQypcLW2/aCkbjK3nyatavUKnKOPwA7WDMq8q62oVAAAAqRNpjcjKByPTcp+p3iroURC9WAeyszU1nAWUSZIKygdnp1ZeBZ3qjFSzJWJq73kniMiP+I3NjWGRsKvK4ansz/Y0VZwMAACQApEXq48PRhwVjR1VnF6KUNFRX0pJJx2lc2W4LzXFKcrYqcjVYIpK+Kp+OC3Jf/l/E11/Hd3sF7eiHSN0d8HYUaUy2O4B7RdqFfKhK9OmNjal0zM3+TJZOrBPdRi002moVng05R0eLI6rs1Oplhsy791nqmtXOjLGz0cAAIAUmuqpWeODkZZKh9Jn3fQgQ0Yj30knadtS6UiOTO09KqhVf9YNIpxGTYVHezLdih6WNtW8koLiqGjkpCD1yPPUHJLeMkkt11Dei5K+1FLpRbjdD68sZHfPTkduJ+myQKuU6Zys5mrKfpCZ+PtYFsHdks6rbZ8qFwTZ7RdqtUp6kffGzkcAAIA0mioQefX1f8aUZnspJFZeBWVlH/jX8M0NbQbpQlZehVZdz1xJctSo+WlF5oY2VVNucCG201Ata+sglBhv5UdFIqMXdBeaodz6K6lNA/vRbfdd7Wav/oa5sTmyF5Iuk1vRw5Jkt4OT2aY2SxkWrKeUufco9P8hKTz3zT09KrRUf0YkAgAA0i9yIDI+CJmGpQNbqj9z5VYOVeumHFmqep487zPp4bCnRkWru9q9ozLtAvQpnZ6FUsM66TXdPP8Ey9xndbX6UrEs5QtB2hZSLfOBhsTBAAAAKyFSIBJfENJh3t2V6kc6qqt398GtqOJInVSVtuxsSy/a8u+glHTUS5xX5bA29TZrodsfbuWhSq3QAu8owt83Yh3IVqhNzpFK8q9cJ1xm3t1VtnYYCtocNWqjFj9j+bhy+5ZM5VTL7uquqc4dOZX0MBhct6LDWla7dxlbAACQfm9P+oW4gxBJnRSTTUO5U1tts/ezjSNDRs5/X2jKsyTJUrVZkJEz1Ak/srLtglSfbpMFNWT0KlfzWo9BNbX3ma2djCGjW1/wZKOEy8w9PW++kJExVAr2rumpyjNeU+PZQ0Ollv8ma6v9PDTuz5t6YWRk+INbaHo8iAAAAKwE4+LiwgvevP7vN7sFt2+9MzYIeevyK62vr8+8Yado6PCDtp7PclYVfLfCcx5rukwuLy+1tra26GbcOPR7ujF+GIZ5gVGYG1glI++IzOVOSMCt6LBW0COPMAIAAAC4iSamZsXNKRrK1TopJmQPAQAAADdT4oGIVfXkVa9dib9+BAAAAEAaTfU9IgAAAAAQBwIRAAAAAInre2rWmzdvpvrjd999N/YGAQAAYDSemoVV0ReIMLEBAAAAJIHULAAAAACJIxABAAAAkDgCEQAAAACJIxABAAAAkDgCEQAAAACJIxABAAAAkDgCEQAAAACJIxABAAAAkDgCEQAAAACJIxABAAAAkDgCEQAAAACJ+z9jsuXX0dkffQAAAABJRU5ErkJggg==" alt="image-20220507135613665"> （5）执行sql</p><p>先创建表，并插入一些数据：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ydl_student<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">\`</span>ydl_student<span class="token punctuation">\`</span></span> <span class="token punctuation">(</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">\`</span>name<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">\`</span>score<span class="token punctuation">\`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token identifier"><span class="token punctuation">\`</span>grade<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">\`</span>ydl_student<span class="token punctuation">\`</span></span><span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">\`</span>name<span class="token punctuation">\`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">\`</span>score<span class="token punctuation">\`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">\`</span>grade<span class="token punctuation">\`</span></span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&#39;lucy&#39;</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token string">&#39;a&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">\`</span>ydl_student<span class="token punctuation">\`</span></span><span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">\`</span>name<span class="token punctuation">\`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">\`</span>score<span class="token punctuation">\`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">\`</span>grade<span class="token punctuation">\`</span></span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&#39;lily&#39;</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token string">&#39;a&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">\`</span>ydl_student<span class="token punctuation">\`</span></span><span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">\`</span>name<span class="token punctuation">\`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">\`</span>score<span class="token punctuation">\`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">\`</span>grade<span class="token punctuation">\`</span></span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&#39;jack&#39;</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token string">&#39;c&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">\`</span>ydl_student<span class="token punctuation">\`</span></span><span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">\`</span>name<span class="token punctuation">\`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">\`</span>score<span class="token punctuation">\`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">\`</span>grade<span class="token punctuation">\`</span></span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">&#39;hellen&#39;</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token string">&#39;d&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">\`</span>ydl_student<span class="token punctuation">\`</span></span><span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">\`</span>name<span class="token punctuation">\`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">\`</span>score<span class="token punctuation">\`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">\`</span>grade<span class="token punctuation">\`</span></span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">&#39;tom&#39;</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token string">&#39;c&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">\`</span>ydl_student<span class="token punctuation">\`</span></span><span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">\`</span>name<span class="token punctuation">\`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">\`</span>score<span class="token punctuation">\`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">\`</span>grade<span class="token punctuation">\`</span></span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">&#39;jerry&#39;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">&#39;d&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">\`</span>ydl_student<span class="token punctuation">\`</span></span><span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">\`</span>name<span class="token punctuation">\`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">\`</span>score<span class="token punctuation">\`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">\`</span>grade<span class="token punctuation">\`</span></span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">&#39;sily&#39;</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">&#39;d&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行删除操作，假装误删除，直接全部删除也可以，把表删了都行，一样的道理：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">delete</span> <span class="token keyword">from</span> ydl_student <span class="token keyword">where</span> id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>（6）查看binlog日志，我们因为刷新了日志，所以本次操作都会在最新的日志文件上：</p><p>因为 binlog 的日志文件是二进制文件，不能用文本编辑器直接打开，需要用特定的工具来打开，MySQL 提供了 mysqlbinlog 来帮助我们查看日志文件内容：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 查看全部的日志信息</span></span>
<span class="line">/www/server/mysql/bin/mysqlbinlog <span class="token parameter variable">-v</span> mysql-bin.000008</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 指定位置范围</span></span>
<span class="line">/usr/bin/mysqlbinlog <span class="token parameter variable">-v</span> mysql-bin.000013 --start-position<span class="token operator">=</span><span class="token number">0</span> --stop-position<span class="token operator">=</span><span class="token number">986</span></span>
<span class="line"><span class="token comment"># 指定时间范围</span></span>
<span class="line">/usr/bin/mysqlbinlog <span class="token parameter variable">-v</span> mysql-bin.000013 --start-datetime<span class="token operator">=</span><span class="token string">&quot;2022-06-01 11:18:00&quot;</span> --stop-datetime<span class="token operator">=</span><span class="token string">&quot;2022-06-01 12:18:00&quot;</span> </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>真实的情况下，我们的日志文件比较复杂，内容比较多使用时间范围查询后任然可能需要花费时间去排查问题，这里我们找到了误删除的位置：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220507143313649.eea2e039.png" alt="image-20220507143313649"></p><p>（7）执行恢复，通过上一步的操作，我们找到了删除的位置3228（即第二个红框），执行下面的语句：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">/www/server/mysql/bin/mysqlbinlog <span class="token parameter variable">-v</span> mysql-bin.000008 --stop-position<span class="token operator">=</span><span class="token number">3228</span> <span class="token parameter variable">-v</span> <span class="token operator">|</span> mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>（8）至此，数据已完全恢复了：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220507143456337.cf176c97.png" alt="image-20220507143456337"></p><p>binlog的数据恢复的本质，就是将之前执行过的sql，从开始到指定位置全部执行一遍，如果报错【当前表已经存在】，就将数据库的表删除，重新恢复。</p><h4 id="_3、格式分类" tabindex="-1"><a class="header-anchor" href="#_3、格式分类"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_3%E3%80%81%E6%A0%BC%E5%BC%8F%E5%88%86%E7%B1%BB" target="_blank" rel="noopener noreferrer">#</a>3、格式分类</span></a></h4><p>binlog 有三种格式， 使用变量<code>binlog_format</code>查看当前使用的是哪一种：</p><ul><li>Statement（Statement-Based Replication,SBR）：每一条会修改数据的 SQL 都会记录在 binlog 中。</li><li>Row（Row-Based Replication,RBR）：不记录 SQL 语句上下文信息，仅保存哪条记录被修改。</li><li>Mixed（Mixed-Based Replication,MBR）：Statement 和 Row 的混合体，当前默认的选项，5.7中默认row。</li></ul><p>我们举一个例子来说明row和statement的区别，在下面的插入语句中我们有一个函数uuid()，如果日志文件仅仅保存sql语句，下一次执行的结果可能不一致，所以Row格式的文件，他保存的是具体哪一行，修改成了什么数据，记录的是数据的变化，不是简单的sql：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">insert</span> <span class="token keyword">into</span> ydl_student <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span>UUID<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">45</span><span class="token punctuation">,</span><span class="token string">&#39;d&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220507150522596.8036d797.png" alt="image-20220507150522596"></p><blockquote><p>Statement和row的优劣</p></blockquote><ul><li>Statement 模式只记录执行的 SQL，不需要记录每一行数据的变化，因此极大的减少了 binlog 的日志量，避免了大量的 IO 操作，提升了系统的性能。</li><li>由于 Statement 模式只记录 SQL，而如果一些 SQL 中 包含了函数，那么可能会出现执行结果不一致的情况。比如说 uuid() 函数，每次执行的时候都会生成一个随机字符串，在 master 中记录了 uuid，当同步到 slave 之后，再次执行，就得到另外一个结果了。所以使用 Statement 格式会出现一些数据一致性问题。</li><li>从 MySQL5.1.5 版本开始，binlog 引入了 Row 格式，Row 格式不记录 SQL 语句上下文相关信息，仅仅只需要记录某一条记录被修改成什么样子了。</li><li>不过 Row 格式也有一个很大的问题，那就是日志量太大了，特别是批量 update、整表 delete、alter 表等操作，由于要记录每一行数据的变化，此时会产生大量的日志，大量的日志也会带来 IO 性能问题。</li></ul><h4 id="_4、日志格式" tabindex="-1"><a class="header-anchor" href="#_4、日志格式"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_4%E3%80%81%E6%97%A5%E5%BF%97%E6%A0%BC%E5%BC%8F" target="_blank" rel="noopener noreferrer">#</a>4、日志格式</span></a></h4><ul><li>binlog文件以一个值为0Xfe62696e的魔数开头，这个魔数对应0xfebin。</li><li>binlog由一系列的binlog event构成。每个binlog event包含header和data两部分。 <ul><li>header部分提供的是event的公共的类型信息，包括event的创建时间，服务器等等。</li><li>data部分提供的是针对该event的具体信息，如具体数据的修改。</li></ul></li></ul><blockquote><p>常见的事件类型有：</p></blockquote><ul><li><strong>FORMAT_DESCRIPTION_EVENT</strong>：该部分位于整个文件的头部，每个binlog文件都必定会有唯一一个该event</li><li><strong>WRITE_ROW_EVENT</strong>：插入操作。</li><li><strong>DELETE_ROW_EVENT</strong>：删除操作。</li><li><strong>UPDATE_ROW_EVENT</strong>：更新操作。记载的是一条记录的完整的变化情况，即从<strong>前量</strong>变为<strong>后量</strong>的过程</li><li><strong>ROTATE_EVENT</strong>：Binlog结束时的事件，用于说明下一个binlog文件。</li></ul><p>一个event的结构如下，我们在恢复数据的时候已经看到了：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220507142122405.84f6da7b.png" alt="image-20220507142122405"></p><ul><li>每个日志的最后都包含一个<code>rotate event</code>用于说明下一个binlog文件。</li><li>binlog索引文件是一个文本文件，其中内容为当前的binlog文件列表，比如下面就是一个mysql-bin.index文件的内容。</li></ul><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220507153011412.b6b2b640.png" alt="image-20220507153011412"></p><h4 id="_5、binlog刷盘" tabindex="-1"><a class="header-anchor" href="#_5、binlog刷盘"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_5%E3%80%81binlog%E5%88%B7%E7%9B%98" target="_blank" rel="noopener noreferrer">#</a>5、binlog刷盘</span></a></h4><p>二进制日志文件并不是每次写的时候同步到磁盘。因此当数据库所在操作系统发生宕机时，可能会有最后一部分数据没有写入二进制日志文件中，这给恢复和复制带来了问题。 参数<code>sync_binlog=[N]</code>表示每写多少次就同步到磁盘。如果将N设为1，即sync_binlog=1表示采用同步写磁盘的方式来写二进制日志，这时写操作不使用操作系统的缓冲来写二进制日志。（备注：该值默认为0，采用操作系统机制进行缓冲数据同步）。</p><h4 id="_6、binlog实现主从同步" tabindex="-1"><a class="header-anchor" href="#_6、binlog实现主从同步"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_6%E3%80%81binlog%E5%AE%9E%E7%8E%B0%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5" target="_blank" rel="noopener noreferrer">#</a>6、binlog实现主从同步</span></a></h4><p>数据库单点部署的问题：</p><ul><li>服务器宕机，会导致业务停顿，影响客户体验。</li><li>服务器损坏，数据丢失，不能及时备份，造成巨大损失。</li><li>读写操作都在同一台服务器，在并发量大的情况下性能存在瓶颈。</li></ul><p>那么我们就可以使用mysql的binlog搭建一个一主多从的mysql集群服务。这样的服务可以帮助我们异地备份数据、进行读写分离，提高系统的可用性。</p><h5 id="_1-主从复制工作原理剖析" tabindex="-1"><a class="header-anchor" href="#_1-主从复制工作原理剖析"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_1-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a><strong>（1） 主从复制工作原理剖析</strong></span></a></h5><ul><li>Master 数据库只要发生变化，立马记录到Binary log 日志文件中</li><li>Slave数据库启动一个I/O thread连接Master数据库，请求Master变化的二进制日志</li><li>Slave I/O获取到的二进制日志，保存到自己的Relay log 日志文件中。</li><li>Slave 有一个 SQL thread定时检查Realy log是否变化，变化那么就更新数据</li></ul><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220424200331288.9a3461d4.png" alt="image-20220424200331288"></p><h5 id="_2-怎么配置mysql主从复制" tabindex="-1"><a class="header-anchor" href="#_2-怎么配置mysql主从复制"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_2-%E6%80%8E%E4%B9%88%E9%85%8D%E7%BD%AEmysql%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6" target="_blank" rel="noopener noreferrer">#</a><strong>（2）怎么配置mysql主从复制</strong></span></a></h5><hr><blockquote><p>环境准备</p></blockquote><p>安装两个mysql，使用vmvare安装两个linux系统就可以：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">mysql1(master): 42.192.181.133:3306</span>
<span class="line">mysql2(slave):  124.220.197.17:3306</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>mysql 配置文件配</p></blockquote><p>mysql1（master）: 配置文件设置，开启bin_log（已经开启的可以忽略）且需要配置一个server-id</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment">#mysql master1 config </span></span>
<span class="line"><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span></span>
<span class="line">server-id <span class="token operator">=</span> <span class="token number">1</span>            <span class="token comment"># 节点ID，确保唯一</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># log config</span></span>
<span class="line">log-bin <span class="token operator">=</span> master-bin     <span class="token comment">#开启mysql的binlog日志功能</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>mysql2（slave）: 需要开启中继日志</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span></span>
<span class="line">server-id<span class="token operator">=</span><span class="token number">2</span></span>
<span class="line">relay-log<span class="token operator">=</span>mysql-relay-bin</span>
<span class="line">replicate-wild-ignore-table<span class="token operator">=</span>mysql.%</span>
<span class="line">replicate-wild-ignore-table<span class="token operator">=</span>sys.%</span>
<span class="line">replicate-wild-ignore-table<span class="token operator">=</span>information_schema.%</span>
<span class="line">replicate-wild-ignore-table<span class="token operator">=</span>performance_schema.%</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启两个mysql，让配置生效。</p><p><strong>第三步 在master数据库创建复制用户并授权</strong></p><p>1.进入master的数据库，为master创建复制用户</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">USER</span> <span class="token string">&#39;repl&#39;</span><span class="token variable">@&#39;124.220.197.17&#39;</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">&#39;Root12345_&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>2.赋予该用户复制的权利</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs" data-title="cs"><pre><code><span class="line">grant replication slave <span class="token keyword">on</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> to &#39;repl<span class="token char">&#39;@&#39;</span><span class="token number">124.220</span><span class="token number">.197</span><span class="token number">.17</span>&#39; </span>
<span class="line"><span class="token class-name">FLUSH</span> PRIVILEGES<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>3.查看master的状态</p><div class="language-ruby line-numbers-mode" data-highlighter="prismjs" data-ext="rb" data-title="rb"><pre><code><span class="line">show master status<span class="token punctuation">;</span></span>
<span class="line">mysql<span class="token operator">&gt;</span> show master status<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span></span>
<span class="line"><span class="token operator">|</span> <span class="token builtin">File</span>             <span class="token operator">|</span> Position <span class="token operator">|</span> Binlog_Do_DB <span class="token operator">|</span> Binlog_Ignore_DB <span class="token operator">|</span> Executed_Gtid_Set <span class="token operator">|</span></span>
<span class="line"><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span></span>
<span class="line"><span class="token operator">|</span> mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token number">000005</span>      <span class="token number">120</span><span class="token operator">|</span>              <span class="token operator">|</span> mysql            <span class="token operator">|</span>                   <span class="token operator">|</span></span>
<span class="line"><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">+</span></span>
<span class="line"><span class="token number">1</span> row <span class="token keyword">in</span> set <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4,配置从库</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">CHANGE MASTER TO </span>
<span class="line">MASTER_HOST <span class="token operator">=</span> <span class="token string">&#39;42.192.181.133&#39;</span>,  </span>
<span class="line">MASTER_USER <span class="token operator">=</span> <span class="token string">&#39;repl&#39;</span>, </span>
<span class="line">MASTER_PASSWORD <span class="token operator">=</span> <span class="token string">&#39;Root12345_&#39;</span>,</span>
<span class="line">MASTER_PORT <span class="token operator">=</span> <span class="token number">3306</span>,</span>
<span class="line"><span class="token assign-left variable">MASTER_LOG_FILE</span><span class="token operator">=</span><span class="token string">&#39;mysql-bin.000020&#39;</span>,</span>
<span class="line"><span class="token assign-left variable">MASTER_LOG_POS</span><span class="token operator">=</span><span class="token number">2735</span>,</span>
<span class="line">MASTER_HEARTBEAT_PERIOD <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span> </span>
<span class="line"></span>
<span class="line"><span class="token comment"># MASTER_LOG_FILE与主库File 保持一致</span></span>
<span class="line"><span class="token comment"># MASTER_LOG_POS=120 , #与主库Position 保持一致</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>解释：MASTER_HEARTBEAT_PERIOD表示心跳的周期。当MASTER_HEARTBEAT_PERIOD时间之内，master没有binlog event发送给slave的时候，就会发送心跳数据给slave。</p><p>5.启动从库slave进程</p><div class="language-css line-numbers-mode" data-highlighter="prismjs" data-ext="css" data-title="css"><pre><code><span class="line">mysql&gt; start slave<span class="token punctuation">;</span></span>
<span class="line">Query OK<span class="token punctuation">,</span> 0 rows affected <span class="token punctuation">(</span>0.04 sec<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>6.查看是否配置成功</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">show slave status \\G;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>Slave_IO_Running：从库的IO线程，用来接收master发送的binlog，并将其写入到中继日志relag log</li><li>Slave_SQL_Running：从库的SQL线程，用来从relay log中读取并执行binlog。</li><li>Slave_IO_Running、Slave_SQL_Running：这两个进程的状态需全部为 YES，只要有一个为 NO，则复制就会停止。</li><li>Master_Log_File：要同步的主库的binlog文件名。</li><li>Read_Master_Log_Pos：已同步的位置，即同步的 binlog 文件内的字节偏移量，该值会随着主从同步的进行而不断地增长。</li><li>Relay_Log_File：从库的中继日志文件，对接收到的主库的 binlog 进行缓冲。从库的SQL线程不断地从 relay log 中读取 binlog 并执行。</li><li>Relay_Log_Pos：relay log 中已读取的位置偏移量。</li><li>Seconds_Behind_Master: 主从同步延时, 值为 0 为正常情况，正值表示已经出现延迟，数字越大从库落后主库越多。</li></ul><p>7.在主库创建一个数据库、创建一张表，执行一些sql语句进行测试。</p><h5 id="_3-可能遇到的问题" tabindex="-1"><a class="header-anchor" href="#_3-可能遇到的问题"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_3-%E5%8F%AF%E8%83%BD%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98" target="_blank" rel="noopener noreferrer">#</a>（3）可能遇到的问题</span></a></h5><p>在配置mysql主从复制的时候可能出现一下错误：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">Fatal error: The slave I/O thread stops because master and slave have equal MySQL server UUIDs; these UUIDs must be different for replication to work.</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>原因</strong></p><p>如果你使用了两台虚拟机，一主一从，从库的mysql是直接克隆的。在mysql 5.6的复制引入了uuid的概念，各个复制结构中的server_uuid得保证不一样，但是查看到直接克隆data文件夹后server_uuid是相同的。</p><p><strong>解决</strong></p><p>找到data文件夹下的auto.cnf文件，修改里面的server_uuid值，保证各个db的server_uuid不一样，重启db即可。</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"> <span class="token builtin class-name">cd</span> /www/server/data</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>修改server_uuid的值</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220517180545563.de94e863.png" alt="image-20220517180545563"></p><p>使用</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">select</span> uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>生成一个uuid即可，重启数据库。</p><h3 id="二、其他日志" tabindex="-1"><a class="header-anchor" href="#二、其他日志"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#%E4%BA%8C%E3%80%81%E5%85%B6%E4%BB%96%E6%97%A5%E5%BF%97" target="_blank" rel="noopener noreferrer">#</a>二、其他日志</span></a></h3><h4 id="_1、通用查询日志-默认关闭" tabindex="-1"><a class="header-anchor" href="#_1、通用查询日志-默认关闭"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_1%E3%80%81%E9%80%9A%E7%94%A8%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97-%E9%BB%98%E8%AE%A4%E5%85%B3%E9%97%AD" target="_blank" rel="noopener noreferrer">#</a>1、通用查询日志，默认关闭</span></a></h4><p>MySQL通用查询日志，它是记录建立的客户端连接和执行的所有DDL和DML语句(不管是成功语句还是执行有错误的语句)，默认情况下，它是不开启的。请注意，它也是一个文本文件。</p><p>可以通过以下的sql查看查询日志的状态：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220507154040417.4f619c0d.png" alt="image-20220507154040417"></p><p>使用以下命令开启通用查询日志，一般不开启，这是为了测试，当然也可以修改配置文件，重启服务：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 在全局模式下，开启通用查询日志，1表示开启，0表示关闭</span></span>
<span class="line">SET global <span class="token assign-left variable">general_log</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>开启后，我们随便执行sql语句之后，你会发现data目录多了以下文件：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220507154728204.b2cfd978.png" alt="image-20220507154728204"></p><p>使用more命令查看该文件：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">more VM-12-17-centos.log </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220507154844881.2734c9b5.png" alt="image-20220507154844881"></p><h4 id="_2、慢查询日志" tabindex="-1"><a class="header-anchor" href="#_2、慢查询日志"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_2%E3%80%81%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97" target="_blank" rel="noopener noreferrer">#</a>2、慢查询日志</span></a></h4><p>当前版本慢查询日志默认是开启的，有的版本是关闭的，使用如下命令查看慢查询日志的状态：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220507160012005.cee5dfa1.png" alt="image-20220507160012005"></p><p>那么，何为慢？mysql通过一个变量‘long_query_time’来确定sql慢不慢，执行时间大于该值就会被记录在慢查询日志中，默认是3s：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">&#39;long_query_time&#39;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220507160149874.196fb203.png" alt="image-20220507160149874"></p><p>以下是【慢查询日志】的记录文本：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220507154539012.bfc82d0b.png" alt="image-20220507154539012"></p><h4 id="_3、错误日志" tabindex="-1"><a class="header-anchor" href="#_3、错误日志"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_3%E3%80%81%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97" target="_blank" rel="noopener noreferrer">#</a>3、错误日志</span></a></h4><p>错误日志（Error Log）主要记录 MySQL 服务器启动和停止过程中的信息、服务器在运行过程中发生的故障和异常情况等。一旦发生mysql服务无法启动、程序崩溃一定要记得去查询错误日志：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220507155123988.72e86ff4.png" alt="image-20220507155123988"></p><p>我们随便人为一个错误导致他无法启动，重新启动mysql命令如下：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">service</span> mysqld restart</span>
<span class="line">systemctl mysqld restart</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>我们将inndb的系统表空间文件重命名，重新启动mysql服务，发生问题：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220507161525384.b896b188.png" alt="image-20220507161525384"></p><p>查询错误日志，寻找蛛丝马迹：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220507161639367.14d97ab2.png" alt="image-20220507161639367"></p><p>修改回正确的名字，重新启动成功：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220507161102642.5881b0da.png" alt="image-20220507161102642"></p><h3 id="三、redo-log日志" tabindex="-1"><a class="header-anchor" href="#三、redo-log日志"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#%E4%B8%89%E3%80%81redo-log%E6%97%A5%E5%BF%97" target="_blank" rel="noopener noreferrer">#</a>三、redo log日志</span></a></h3><p>接下来的两个日志，是innodb为解决不同问题而引出的两类日志文件。</p><p>redo log（重做日志）的设计主要是为了防止因系统崩溃而导致的数据丢失，其实解决因系统崩溃导致数据丢失的思路如下：</p><p>1、每次提交事务之前，必须将所有和当前事务相关的【buffer pool中的脏页】刷入磁盘，但是，这个效率比较低，可能会影响主线程的效率，产生用户等待，降低响应速度，因为刷盘是I/O操作，同时一个事务的读写操作也不是顺序读写。</p><p>2、把当前事务中修改的数据内容在日志中记录下来，日志记录是顺序写，性能很高。其实mysql就是这么做的，这个日志被称为redo log。执行事务中，每执行一条语句，就可能有若干redo日志，并按产生的顺序写入磁盘，redo日志占用的空间非常小，当redo log空间满了之后又会从头开始以循环的方式进行覆盖式的写入。</p><p>redo log的格式比较简单，包含一下几个部分：</p><ul><li>type：该日志的类型，在5.7版本中，大概有53种不同类型的redo log，占用一个字节</li><li>space id：表空间id</li><li>page number：页号</li><li>data：日志数据</li></ul><h4 id="_1、mtr" tabindex="-1"><a class="header-anchor" href="#_1、mtr"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_1%E3%80%81mtr" target="_blank" rel="noopener noreferrer">#</a>1、MTR</span></a></h4><p>在innodb执行任务时，有很多操作，必须具有原子性，我们把这一类操作称之为MIni Transaction，我们以下边的例子为例：</p><p>在我们向B+树中插入一条记录的时候，需要定位这条数据将要插入的【数据页】，因为插入的位置不同，可能会有以下情况：</p><p>1、待插入的页拥有【充足的剩余空间】，足以容纳这条数据，那就直接插入就好了，这种情况需要记录一条【MLOG_COMP_REC_INSERT类型】的redo日志就好了，这种情况成为乐观插入。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220510121537504.a3ac363a.png" alt="image-20220510121537504"></p><p>2、待插入的页【剩余空间不足】以容纳该条记录，这样就比较麻烦了，必须进行【页分裂】了。必须新建一个页面，将原始页面的数据拷贝一部分到新页面，然后插入数据。这其中对应了好几个操作，必须记录多条rede log，包括申请新的数据页、修改段、区的信息、修改各种链表信息等操作，需要记录的redo log可能就有二三十条，但是本次操作必须是一个【原子性操作】，在记录的过程中，要全部记录，要么全部失败，这种情况就被称之为一个MIni Transaction（最小事务）。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220510121522561.cee67760.png" alt="image-20220510121522561"></p><p><strong>（1）MTR的按组写入</strong></p><p>对于一个【MTR】操作必须是原子的，为了保证原子性，innodb使用了组的形式来记录redo 日志，在恢复时，要么这一组的的日志全部恢复，要么一条也不恢复。innodb使用一条类型为<code>MLO_MULTI_REC_END</code>类型的redo log作为组的结尾标志，在系统崩溃恢复时只有解析到该项日志，才认为解析到了一组完整的redo log，否则直接放弃前边解析的日志。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220510121447118.6fc6234d.png" alt="image-20220510121447118"></p><p><strong>（2）单条redolog的标识方法</strong></p><p>有些操作只会产生一条redo log，innodb是通过【类型标识】的第一个字符来判断，这个日志是单一日志还是组日志，如下图：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220510121610230.f3c4f4b4.png" alt="image-20220510121610230"></p><p><strong>（3）事务、sql、MTR、redolog的关系如下</strong></p><ul><li>一个事务包含一条或多条sql</li><li>一条sql包含一个或多个MTR</li><li>一个MTR包含一个或多个redo log</li></ul><h4 id="_2、log-buffer" tabindex="-1"><a class="header-anchor" href="#_2、log-buffer"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_2%E3%80%81log-buffer" target="_blank" rel="noopener noreferrer">#</a>2、log buffer</span></a></h4><p>任何可能产生大量I/O的操作，一般情况下都会设计【缓冲层】，mysql启动时也会向操作系统申请一片空间作为redo log的【缓冲区】，innodb使用一个变量<code>buf_free</code>来标记下一条redo log的插入位置（标记偏移量），log buffer会在合适的时机进行刷盘：</p><ul><li>log buffer空间不足。logbuffer的容量由<code>innodb_log_buffer_size</code>指定，当写入log buffer的日志大于容量的50%，就会进行刷盘。</li><li>提交事务时，如果需要实现崩溃恢复，保证数据的持久性，提交事务时必须提交redo log，当然你也可以为了效率不去提交，可以通过修改配置文件设置该项目。</li><li>后台有独立线程大约每隔一秒会刷新盘一次。</li><li>正常关闭服务器。</li><li>做checkpoint时，后边会讲。</li></ul><p>有缓冲就可能存在数据不一致，咱们接着往下看。</p><h4 id="_3、checkpoint" tabindex="-1"><a class="header-anchor" href="#_3、checkpoint"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_3%E3%80%81checkpoint" target="_blank" rel="noopener noreferrer">#</a>3、checkpoint</span></a></h4><p>redolog日志文件容量是有限的，需要循环使用，redo log的作用仅仅是为了在崩溃时恢复脏页数据使用的，如果脏页已经刷到磁盘上，其对应的redo log也就没用了，他也就可以被重复利用了。<strong>checkpoint的作用就是用来标记哪些旧的redo log可以被覆盖。</strong></p><p>我们已经知道，判断redo log占用的磁盘空间是否可以被重新利用的标志就是，对应的脏页有没有被刷新到磁盘。为了实现这个目的，我们需要了解一下下边几个记录值的作用：</p><p><strong>（1）lsn</strong></p><p>lsn（log sequence number）是一个全局变量。mysql在运行期间，会不断的产生redo log，日志的量会不断增加，innodb使用lsn来记录当前总计写入的日志量，lsn的初始值不是0，而是8704，原因未知。系统在记录lsn时是按照【偏移量】不断累加的。<strong>lsn的值越小说明redo log产生的越早。</strong></p><p>每一组redo log都有一个唯一的lsn值和他对应，你可以理解为lsn是redo log的年龄。</p><p><strong>（2）flush_to_disk_lsn</strong></p><p><code>flush_to_disk_lsn</code>也是一个全局变量，表示已经刷入磁盘的redo log的量，他小于等于lsn，举个例子：</p><p>1、将redo log写入log buffer，lsn增加，假如：8704+1024 = 9728，此时flush_to_disk_lsn不变。</p><p>2、刷如512字节到磁盘，此时flush_to_disk_lsn=8704+512=9256。</p><p>如果两者数据相同，说明已经全部刷盘。</p><p><strong>（3）flush链中的lsn</strong></p><p>其实要保证数据不丢失，核心的工作是要将buffer pool中的脏页进行刷盘，但是刷盘工作比较损耗性能，需要独立的线程在后台静默操作。</p><p>回顾一下flush链，当第一次修改某个已经加载到buffer pool中的页面时，他会变成【脏页】，会把他放置在flush链表的头部，flush链表是按照第一次修改的时间排序的。再第一次修改缓冲页时，会在【缓冲页对应的控制块】中，记录以下两个属性：</p><ul><li>oldest_modification：<strong>第一次</strong>修改缓冲页时，就将【修改该页面的第一组redo log的lsn值】记录在对应的控制块。</li><li>newest_modification：<strong>每一次</strong>修改缓冲页时，就将【修改该页面的最后组redo log的lsn值】记录在对应的控制块。</li></ul><p>既然flush链表是按照修改日期排序的，那么也就意味着，oldest_modification的值也是有序的。</p><p><strong>（4）checkpoint过程</strong></p><p>执行一个check point可以分为两个步骤</p><p>**第一步：**计算当前redo log文件中可以被覆盖的redo日志对应的lsn的值是多少：</p><p>1、flush链是按照第一次修改的时间排序的，当然控制块内的【oldest_modification】记录的lsn值也是有序的。</p><p>2、我们找到flush链表的头节点上的【oldest_modification】所记录的lsn值，也就找到了一个可以刷盘的最大的lsn值，小于这个值的脏页，肯定已经刷入磁盘。</p><p>3、所有小于这个lsn值的redo log，都可以被覆盖重用。</p><p>4、将这个lsn值赋值给一个全局变量checkpoint_lsn，他代表可以被覆盖的量。</p><p>**第二步：**将checkpoint_lsn与对应的redo log日志文件组偏移量以及此次checkpoint的编号（checkpoint_no也是一个变量，记录了checkpoint的次数）全部记录在日志文件的管理信息内。</p><h4 id="_4、一个事务的执行流程" tabindex="-1"><a class="header-anchor" href="#_4、一个事务的执行流程"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_4%E3%80%81%E4%B8%80%E4%B8%AA%E4%BA%8B%E5%8A%A1%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B" target="_blank" rel="noopener noreferrer">#</a>4、一个事务的执行流程</span></a></h4><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220510174411661.951cbbb0.png" alt="image-20220510174411661"></p><p>主线程</p><p>1、客户端访问mysql服务，在buffer pool中进行操作（如果目标页不在缓冲区，需要加载进入缓冲区），此时会形成脏页。</p><p>2、记录redo log，可能产生很多组日志，redo log优先记录在缓冲区，会在提交事务前刷盘。</p><p>3、刷盘时根据checkpoint的结果，选择可以使用的日志空间进行记录。</p><p>4、成功后即可返回，此时数据不会落盘，这个过程很多操作只在内存进行，只需要记录redo log（顺序写），所以速度很快。</p><p>线程1：</p><p>1、不断的对flush链表的脏页进行刷盘，对响应时间没有过高要求。</p><p>线程2：</p><p>1、不断的进行checkpoin操作，保证redo log可以及时写入。</p><h4 id="_5、系统崩溃的影响" tabindex="-1"><a class="header-anchor" href="#_5、系统崩溃的影响"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_5%E3%80%81%E7%B3%BB%E7%BB%9F%E5%B4%A9%E6%BA%83%E7%9A%84%E5%BD%B1%E5%93%8D" target="_blank" rel="noopener noreferrer">#</a>5、系统崩溃的影响</span></a></h4><p>（1）**log buffer中的日志丢失，**log buffer中的日志会在每次事务前进行刷盘，如果在事务进行中崩溃，事务本来就需要回滚。</p><p>（2）<strong>buffer pool中的脏页丢失</strong>，崩溃后可以通过redo log恢复，通过checkpoint操作，我们可以确保，内存中脏页对应的记录都会在redo log日志中存在。</p><p>redo log保证了崩溃后，数据不丢失，但是一个事务进行中，如果一部分redo log已经刷盘，那么系统会将本应回滚的数据同样恢复，为了解决回滚的问题，innodb提出了undo log。</p><h3 id="四、undo-log日志" tabindex="-1"><a class="header-anchor" href="#四、undo-log日志"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#%E5%9B%9B%E3%80%81undo-log%E6%97%A5%E5%BF%97" target="_blank" rel="noopener noreferrer">#</a>四、undo log日志</span></a></h3><h4 id="_1、概述-2" tabindex="-1"><a class="header-anchor" href="#_1、概述-2"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_1%E3%80%81%E6%A6%82%E8%BF%B0-1" target="_blank" rel="noopener noreferrer">#</a>1、概述</span></a></h4><p>undo log（也叫撤销日志或者回滚日志），他的主要作用是为了实现回滚操作。同时，他是MVCC多版本控制的核心模块。undo log保存在共享表空间【ibdata1文件】中。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220511132907318.a045fd84.png" alt="image-20220511132907318"></p><p>**注意：**8.0以后undolog有了独立的表空间：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220511132953019.0170b963.png" alt="image-20220511132953019"></p><p>在讲undo log之前需要先了解行数据中的两个隐藏列：</p><h4 id="_2、事务id-trx-id" tabindex="-1"><a class="header-anchor" href="#_2、事务id-trx-id"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_2%E3%80%81%E4%BA%8B%E5%8A%A1id-trx-id" target="_blank" rel="noopener noreferrer">#</a>2、事务id（trx_id）</span></a></h4><p>我们已经讲过，在innodb的行数据中，会自动添加两个隐藏列，一个是【trx_id】，一个是【roll_pointer】，本章节会详细介绍这两列的具体作用，如果该表中没有定义主键，也没有定义【非空唯一】列，则还会生成一个隐藏列【row_id】，这个我们之间也讲过，是为了生成聚簇索引使用的。</p><p>事务id是一个自增的全局变量，如果一个【事务】对任意表做了【增删改】的操作，那么innodb就会给他分配一个独一无二的事务id。</p><p><strong>冷知识：</strong></p><ul><li>事务id保存在一个全局变量【MAX_TRX_ID】上，每次事务需要分配事务id，就会从这个全局变量中获取，然后自增1。</li><li>该变量每次自增到256的倍数会进行一个落盘（保存在表空间页号为5的页面中），发生服务停止或者系统崩溃后，再起启动服务，会读取这个数字，然后再加256。这样做既保证不会有太多I/O操作，还能保证id的有序增长。比如：读到256进行落盘，后来有涨到302，突然崩溃了，下次启动后，第一个事务的id就是256+256=512，保证新的事务id一定大。</li></ul><h4 id="_3、roll-pointer" tabindex="-1"><a class="header-anchor" href="#_3、roll-pointer"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_3%E3%80%81roll-pointer" target="_blank" rel="noopener noreferrer">#</a>3、roll_pointer</span></a></h4><p>undo log在记录日志时是这样记录的，每次修改数据，都会将修改的数据标记一个【新的版本】，同时，这个版本的数据的地址会保存在修改之前的数据的roll_pointer列中，如下：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220512155454781.dbad9b39.png" alt="image-20220512155454781"></p><h4 id="_4、分类" tabindex="-1"><a class="header-anchor" href="#_4、分类"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_4%E3%80%81%E5%88%86%E7%B1%BB" target="_blank" rel="noopener noreferrer">#</a>4、分类</span></a></h4><p>当我们对数据库的数据进行一个操作时必须记录之前的信息，将来才能【悔棋】，如下：</p><ul><li>插入一条数据时，至少要把这条数据的主键记录下来，以后不想要了直接根据主键删除。</li><li>删除一条数据时，至少要把这个数据所有的内容全部记录下来，以后才能全量恢复。但事实上不需要，每行数据都有一个delete_flag，事务中将其置1，记录id，如需要回滚根据id复原即可，提交事务后又purge线程处理垃圾。</li><li>修改一条数据时，至少要将修改前后的数据都保存下来。</li></ul><p>innodb将undo log分为两类：</p><ul><li>一类日志只记录插入类型的操作（insert）</li><li>一类日志只记录修改类型的操作（delete，update）</li></ul><p>什么分为这两类呢？</p><ul><li>插入型的记录不需要记录版本，事务提交以后这一片空间就可以重复利用了。</li><li>修改型的必须将每次修改作为一个版本记录下来，即使当前事务已经提交，也不一定能回收空间，应为其他事务可能在用。</li></ul><h4 id="_5、物理存储结构" tabindex="-1"><a class="header-anchor" href="#_5、物理存储结构"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_5%E3%80%81%E7%89%A9%E7%90%86%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84" target="_blank" rel="noopener noreferrer">#</a>5、物理存储结构</span></a></h4><p>undo同样是以页的形式进行存储的，多个页是使用链表的形式进行管理，针对【普通表和零时表】，【插入型和修改型】的数据，一个事务可能会产生以下四种链表：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220511190027272.aa4a4815.png" alt="image-20220511190027272"></p><p>这是物理存储模型，分成四种类型，是为了更好的管理。</p><h4 id="_6、记录流程" tabindex="-1"><a class="header-anchor" href="#_6、记录流程"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_6%E3%80%81%E8%AE%B0%E5%BD%95%E6%B5%81%E7%A8%8B" target="_blank" rel="noopener noreferrer">#</a>6、记录流程</span></a></h4><ol><li><p>开启事务，执行【增删改】时获得【事务id】。</p></li><li><p>在系统表空间中第5号页中，分配一个回滚段，回滚段是轮动分配的，比如，当前事务使用第5个回滚段，下个事务就使用第6个。</p><p>【回滚段】是一个【数据页】，里边划分了1024个undo slot，用来存储日志链表的头节点地址。</p></li><li><p>在当前回滚段的cached链表（回收可复用的）和空闲solt中，找到一个可用的slot，找不到就报错。</p></li><li><p>创建或复用一个undo log页，作为first undo page，并把他的地址写入undo solt中。</p></li></ol><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220511150345487.f4cdf002.png" alt="image-20220511150345487"></p><h4 id="_7、回滚过程" tabindex="-1"><a class="header-anchor" href="#_7、回滚过程"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_7%E3%80%81%E5%9B%9E%E6%BB%9A%E8%BF%87%E7%A8%8B" target="_blank" rel="noopener noreferrer">#</a>7、回滚过程</span></a></h4><ol><li>服务再次启动时，通过表空间5号页面定位到128个回滚段的位置，</li><li>遍历所有的slot，找到所有状态不为空闲的slot，并且通过undolog的标记为找到现在活跃（未提交）的所有的事务id</li><li>根据undo log的记录，将数据全部回滚</li></ol><h2 id="第九章、隔离级别和mvcc" tabindex="-1"><a class="header-anchor" href="#第九章、隔离级别和mvcc"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#%E7%AC%AC%E4%B9%9D%E7%AB%A0%E3%80%81%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E5%92%8Cmvcc" target="_blank" rel="noopener noreferrer">#</a>第九章、隔离级别和MVCC</span></a></h2><p>【MVCC】，全称Multi-Version Concurrency Control，即【多版本并发控制】。MVCC在MySQL InnoDB中的实现主要是为了提高数据库的并发性能，用更好的方式去处理【读-写冲突】，做到即使有【读写冲突】时，也能做到不加锁，非阻塞并发读，学习mvcc之前我们需要学习一些新的概念。</p><h3 id="一、read-view-读视图" tabindex="-1"><a class="header-anchor" href="#一、read-view-读视图"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#%E4%B8%80%E3%80%81read-view-%E8%AF%BB%E8%A7%86%E5%9B%BE" target="_blank" rel="noopener noreferrer">#</a>一、Read View（读视图）</span></a></h3><p>在学习MVCC多版本并发控制之前，我们必须先了解一下，什么是MySQL InnoDB下的【当前读】和【快照读】，我们都知道undo log会记录一个事务对一条数据的所有修改，并形成版本链：</p><ul><li><strong>当前读</strong>：像select lock in share mode（锁）、 select for update、 update、insert、delete（排他锁）这些操作都是【当前读】，他读取的是记录的【最新版本】，读取时还要保证其他【并发事务】不能修改当前记录，会对读取的记录进行加锁。</li><li><strong>快照读</strong>：像不加锁的select操作就是快照读，即不加锁的【非阻塞读】；快照读的前提是【隔离级别不是串行级别】，串行级别下的快照读会【退化成当前读】，顾名思义，快照读读取的是【快照】，他是通过readView实现的。</li></ul><h4 id="_1、实现原理" tabindex="-1"><a class="header-anchor" href="#_1、实现原理"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_1%E3%80%81%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86" target="_blank" rel="noopener noreferrer">#</a>1、实现原理</span></a></h4><p>Read View就是事务进行【快照读】的时候生产的【读视图】(Read View)，在该事务【执行快照读】的那一刻，会生成数据库系统当前的一个快照。</p><p><strong>注意：</strong>【快照】不是说将数据库复制一份，【Read View】的主要作用是做【可见性判断】， 快照的实现逻辑是通过undo log的【版本链】，配合一些【参数】，比如事务id，来确定当前事务可以读取的版本。</p><h4 id="_2、readview的结构" tabindex="-1"><a class="header-anchor" href="#_2、readview的结构"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_2%E3%80%81readview%E7%9A%84%E7%BB%93%E6%9E%84" target="_blank" rel="noopener noreferrer">#</a>2、readView的结构</span></a></h4><p>举一个列子，当前有事务id为12、13、14、16、20的五个事务，他们在同时修改一条数据，此时，事务13发生读取行为，在【事务13】读取之前【事务14】已经提交，当前场景下，将产生一个readview如下：</p><p>一个readView就是一个【结构体】，你甚至可以理解成为java里的实例（readview）和属性，包含属性如下：</p><ul><li>m_ids：生成该readview时，当前系统中【活跃的事务】id列表。对于当前案例，因为14已经提交，就不活跃了，所以该变量的值为[12,13,16,20]。</li><li>min_trx_id：当前系统【活跃事务】中最小的【事务id】，他也是m_ids的最小值，当前案例的值就是12。</li><li>max_trx_id：当前系统中计划分配给下一个事务的id，他可能是m_ids的最大值+1，也可能比他大。当前案例值假设为22。</li><li>creator_trx_id：生成这个readView的事务id，当前案例的值为12。</li></ul><p>以上readview配合undo log就可以形成一个【快照】，那他是怎么读取的呢？</p><h3 id="二、快照读原理解析" tabindex="-1"><a class="header-anchor" href="#二、快照读原理解析"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#%E4%BA%8C%E3%80%81%E5%BF%AB%E7%85%A7%E8%AF%BB%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>二、快照读原理解析</span></a></h3><p>在一个事务读取数据时，会根据当前数据形成一个readview，读取时会按照以下逻辑进行读取：</p><ul><li><p>如果【被访问数据的事务trx_id】和readView中的【creator_trx_id值】相同，意味着自己在访问自己修改过的记录，当然可以被访问。</p></li><li><p>如果【被访问数据的事务trx_id】小于readView中的【min_trx_id】值，说明生成这个版本数据的事务，在生成readview前已经提交，这样的数据也可以访问。</p><p>**通俗一点：**这个数据之前被其他的事务修改过，但是事务已经提交，所以这个版本的数据是可以使用的，这样不会产生脏读。</p></li><li><p>如果【被访问数据的事务trx_id】大于等于readView中的max_trx_id值，说明生成这个版本数据的事务，是在生成readview后开启，这样的数据不应该被访问。</p><p>**通俗一点：**你读取数据之后，有人修改了当前数据，那人家后边修改的数据，你也不能读。</p></li><li><p>如果【被访问数据的事务trx_id】如果在min_trx_id和max_trx_id范围内，则需要判断是不是在【m_ids】中（目的是判断这个数据是不是已经提交）。如果在，说明生成这个版本的事务还是活跃的，没有提交的事务产生的数据当然不能读，如果不在，说明事务已经提交，该数据可以被访问。</p><p>**通俗一点：**这个数据被现在活跃的其他事务正在修改中，读取时要看此时这个事务是不是已经提交，目的也是为了不要读取别人未提交的事务。</p></li></ul><p>我们用下边的案例来看一下这个过程：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220512152116264.d7d80219.png" alt="image-20220512152116264"></p><h3 id="三、解决脏读和不可重复读" tabindex="-1"><a class="header-anchor" href="#三、解决脏读和不可重复读"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#%E4%B8%89%E3%80%81%E8%A7%A3%E5%86%B3%E8%84%8F%E8%AF%BB%E5%92%8C%E4%B8%8D%E5%8F%AF%E9%87%8D%E5%A4%8D%E8%AF%BB" target="_blank" rel="noopener noreferrer">#</a>三、解决脏读和不可重复读</span></a></h3><p>对于RU隔离级别的事务来说，由于可以读取到未提交的事务，所有直接读取【最新的记录】（当前读）就可以，对于serializable的事务来说，必须使用加锁的方式来访问。</p><h4 id="_1、解决脏读" tabindex="-1"><a class="header-anchor" href="#_1、解决脏读"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_1%E3%80%81%E8%A7%A3%E5%86%B3%E8%84%8F%E8%AF%BB" target="_blank" rel="noopener noreferrer">#</a>1、解决脏读</span></a></h4><p>先思考一个问题，脏读指的是在当前事务中读取到了其他事务未提交的数据，那解决的思路是什么：</p><p><strong>（1）没有undo+mvcc</strong></p><p>一个事务读取了数据之后，立马给这个数据加写锁，不允许其他事务进行修改，这是加锁解决脏读。</p><p><strong>（2）使用undo+mvcc</strong></p><p>所有事务对数据的修改，记录成版本链，使用readview进行版本选择，每个事务只能读取满足条件的数据，这个过程不需要加锁。</p><p>使用mvcc很好的解决了【读写操作】的并发执行，而且采用了无锁机制。</p><h4 id="_2、解决不可重复读" tabindex="-1"><a class="header-anchor" href="#_2、解决不可重复读"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_2%E3%80%81%E8%A7%A3%E5%86%B3%E4%B8%8D%E5%8F%AF%E9%87%8D%E5%A4%8D%E8%AF%BB" target="_blank" rel="noopener noreferrer">#</a>2、解决不可重复读</span></a></h4><p>RC和RR两个隔离级别解决不可重复读是通过生成readview时间不同</p><p><strong>（1）RC隔离级别</strong>，同一个事务中【每次读取数据时都生成一个新的ReadView】，两次读取时，如果中间有其他事务进行提交，可能会生成两个不同的readview，导致当前事务中，两次读取的数据不一致，这就是不可重复读。具体的执行流程如下：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220512154853148.129aabc5.png" alt="image-20220512154853148"></p><p><strong>（2）RR隔离级别</strong>，同一个事务中【只在第一次读取数据时生成一个ReadView】，以后这个事务中一直使用这个readview，那么同一个事务中就能保证多次读取的数据是一致的，具体的执行流程如下：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20220512155222410.cf20dd90.png" alt="image-20220512155222410"></p><h4 id="_3、解决幻读" tabindex="-1"><a class="header-anchor" href="#_3、解决幻读"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_3%E3%80%81%E8%A7%A3%E5%86%B3%E5%B9%BB%E8%AF%BB" target="_blank" rel="noopener noreferrer">#</a>3、解决幻读</span></a></h4><p>他是通过间隙锁实现的，一旦锁定某一个范围的数据，就会对这个范围的数据加锁，间隙锁保证我们<strong>不能在这个范围内插入新的数据。</strong></p><h2 id="第十章-其他知识" tabindex="-1"><a class="header-anchor" href="#第十章-其他知识"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#%E7%AC%AC%E5%8D%81%E7%AB%A0-%E5%85%B6%E4%BB%96%E7%9F%A5%E8%AF%86" target="_blank" rel="noopener noreferrer">#</a>第十章 其他知识</span></a></h2><h3 id="一、触发器" tabindex="-1"><a class="header-anchor" href="#一、触发器"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#%E4%B8%80%E3%80%81%E8%A7%A6%E5%8F%91%E5%99%A8" target="_blank" rel="noopener noreferrer">#</a>一、触发器</span></a></h3><p>与表有关的数据对象，在满足某种条件的时候，被动执行的SQL语句。</p><h4 id="_1、触发器的特性" tabindex="-1"><a class="header-anchor" href="#_1、触发器的特性"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_1%E3%80%81%E8%A7%A6%E5%8F%91%E5%99%A8%E7%9A%84%E7%89%B9%E6%80%A7" target="_blank" rel="noopener noreferrer">#</a>1、触发器的特性</span></a></h4><ol><li>有begin、end的结构体（多条sql语句）</li><li>需要指定触发的条件：INSERT，UPDATE，DELETE</li><li>有指定的触发时间：BEFORE，AFTER</li></ol><h4 id="_2、触发器的创建" tabindex="-1"><a class="header-anchor" href="#_2、触发器的创建"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_2%E3%80%81%E8%A7%A6%E5%8F%91%E5%99%A8%E7%9A%84%E5%88%9B%E5%BB%BA" target="_blank" rel="noopener noreferrer">#</a>2、触发器的创建</span></a></h4><ul><li>单条业务逻辑的触发器创建</li></ul><div class="language-mysql line-numbers-mode" data-highlighter="prismjs" data-ext="mysql" data-title="mysql"><pre><code><span class="line">/*</span>
<span class="line">CREATE TRIGGER 触发器名称 BEFORE|AFTER INSERT|UPDATE|DELETE ON 表名</span>
<span class="line">FOR EACH ROW 业务逻辑</span>
<span class="line">*/</span>
<span class="line">#当b_user表中插入数据后，b_log表中也插入一条数据</span>
<span class="line">CREATE TRIGGER trigger_insert AFTER INSERT ON b_user</span>
<span class="line">FOR EACH ROW INSERT INTO b_log(字段) VALUES(&#39;插入数据&#39;)</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>多条业务逻辑的触发器</li></ul><div class="language-mysql line-numbers-mode" data-highlighter="prismjs" data-ext="mysql" data-title="mysql"><pre><code><span class="line">/*</span>
<span class="line">DELIMITER $</span>
<span class="line">CREATE TRIGGER 触发器名称 BEFORE|AFTER INSERT|UPDATE|DELETE ON 表名</span>
<span class="line">FOR EACH ROW</span>
<span class="line">BIGIN</span>
<span class="line">INSERT...;</span>
<span class="line">UPDATE...;</span>
<span class="line">END;$</span>
<span class="line">*/</span>
<span class="line">#在b_user表中插入数据前，b_log表中插入2条数据</span>
<span class="line">DELIMITER $</span>
<span class="line">CREATE TRIGGER trigger_ insert_before BEFORE INSERT ON b_user</span>
<span class="line">FOR EACH ROW</span>
<span class="line">BEGIN</span>
<span class="line">INSERT INTO b_log(comments,name) values(&#39;insert1&#39; ，NEW.name);</span>
<span class="line">INSERT INTO b_log(comments,name) values(&#39;insert2&#39; , NEW.name) ;</span>
<span class="line">END;$</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>总结</strong></p><ul><li>BEFORE|AFTER INSERT用于获取将要插入的数据</li><li>BEFORE|AFTER UPDATE|DELETE用于获取已经修改或删除的数据</li></ul><h4 id="_3、删除触发器" tabindex="-1"><a class="header-anchor" href="#_3、删除触发器"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_3%E3%80%81%E5%88%A0%E9%99%A4%E8%A7%A6%E5%8F%91%E5%99%A8" target="_blank" rel="noopener noreferrer">#</a>3、删除触发器</span></a></h4><div class="language-mysql line-numbers-mode" data-highlighter="prismjs" data-ext="mysql" data-title="mysql"><pre><code><span class="line">DROP TRIGGER 触发器名称</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="二、存储过程" tabindex="-1"><a class="header-anchor" href="#二、存储过程"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#%E4%BA%8C%E3%80%81%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B" target="_blank" rel="noopener noreferrer">#</a>二、存储过程</span></a></h3><h4 id="_1、-变量" tabindex="-1"><a class="header-anchor" href="#_1、-变量"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_1%E3%80%81-%E5%8F%98%E9%87%8F" target="_blank" rel="noopener noreferrer">#</a>1、 变量</span></a></h4><h5 id="_1-1-系统变量" tabindex="-1"><a class="header-anchor" href="#_1-1-系统变量"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_1-1-%E7%B3%BB%E7%BB%9F%E5%8F%98%E9%87%8F" target="_blank" rel="noopener noreferrer">#</a>1.1 系统变量</span></a></h5><p>由mysql数据库管理系统提供的，变量名称固定，可以修改和查看值，分为<strong>全局变量</strong>和<strong>会话变量</strong></p><p><strong>全局变量</strong>：当mysql服务没有重启时，我们可以查看和修改的变量</p><p><strong>会话变量</strong>：和MySQL连接形成的会话，生命周期在整个会话过程中</p><p>全局变量用global修饰，会话变量用session修饰，通常session可以省略</p><ul><li>查看系统变量</li></ul><div class="language-mysql line-numbers-mode" data-highlighter="prismjs" data-ext="mysql" data-title="mysql"><pre><code><span class="line">SHOW GLOBAL variables; -- 查看全局变量</span>
<span class="line">SHOW SESSION variables; -- 查看会话变量</span>
<span class="line">SHOW variables; -- 查看会话变量</span>
<span class="line">SHOW GLOBAL variables like &#39;%dir%&#39;; -- 模糊查询环境变量</span>
<span class="line">SELECT @@datadir; -- 查看全局系统变量</span>
<span class="line">SELECT @@session_track_transaction_info;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>修改系统变量</li></ul><div class="language-mysql line-numbers-mode" data-highlighter="prismjs" data-ext="mysql" data-title="mysql"><pre><code><span class="line">SHOW GLOBAL variables like &#39;autocommit&#39;; -- 全局系统变量中为自动提交事务</span>
<span class="line">SET GLOBAL autocommit=0; -- 将全局的自动提交的事务改为手动提交</span>
<span class="line">SHOW SESSION variables link &#39;autocommit&#39;; -- 查看会话变量中自动提交事务</span>
<span class="line">SET SESSION autocommit=0; -- 将会话变量中自动提交的事务改为手动提交</span>
<span class="line">SET @@session.autocommit=1;</span>
<span class="line">SET @@global.autocommit=1;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>全局变量</strong>在修改后，在不同的会话中都会立即生效，但是在重新启动mysql服务后，全局变量会恢复为默认值，如果想让全局变量依旧有效，需要去修改.ini文件（MySQL配置文件）</p><p><strong>会话变量</strong>在修改后只对当前会话有效。一般在开发过程中修改会话变量。如：字符编码格式等可以在ini文件中进行设置</p><h5 id="_1-2-用户变量" tabindex="-1"><a class="header-anchor" href="#_1-2-用户变量"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_1-2-%E7%94%A8%E6%88%B7%E5%8F%98%E9%87%8F" target="_blank" rel="noopener noreferrer">#</a>1.2 用户变量</span></a></h5><p>MySQL允许用户自定义变量，分为用户变量和局部变量</p><ul><li><p>用户变量</p><p>作用域：当前会话有效</p><div class="language-mysql line-numbers-mode" data-highlighter="prismjs" data-ext="mysql" data-title="mysql"><pre><code><span class="line">#设置方式1，先去声明并初始化用户变量，赋值操作既可以使用=进行赋值，也可以使用:=进行赋值</span>
<span class="line">SET @变量名=值;</span>
<span class="line">SET @变量名:=值;</span>
<span class="line">SELECT @变量名:=值;</span>
<span class="line">#设置方式2</span>
<span class="line">SELECT 字段 into @变量名 FROM 表名;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>局部变量</p><p>作用域：在begin end的结构体中，声明必须是begin end结构体的第一句</p><div class="language-mysql line-numbers-mode" data-highlighter="prismjs" data-ext="mysql" data-title="mysql"><pre><code><span class="line">#声明方式，必须在begin后面从第一行开始</span>
<span class="line">DECLARE 变量名 类型;</span>
<span class="line">DECLARE 变量名 类型 DEFAULT 值;</span>
<span class="line"></span>
<span class="line">#局部变量的赋值</span>
<span class="line">SET 变量名:=值;</span>
<span class="line">SELECT @变量名:=值;</span>
<span class="line">SELECT 字段 into 变量名 FROM 表名;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h4 id="_2、存储过程的创建" tabindex="-1"><a class="header-anchor" href="#_2、存储过程的创建"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_2%E3%80%81%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E7%9A%84%E5%88%9B%E5%BB%BA" target="_blank" rel="noopener noreferrer">#</a>2、存储过程的创建</span></a></h4><p>存储过程是一组已经预先编译好的sql语句的集合，理解为批处理语句（增加流程控制语句），一般在复杂逻辑中才会使用存储过程</p><ul><li><p>存储过程的优点</p><ul><li>提供了代码的可用性</li><li>简化了数据库操作，将业务逻辑的细节隐藏在存储过程中</li><li>减少了编译次数，减少了网络IO的次数，从而提高操作效率</li></ul></li><li><p>存储过程的创建</p><div class="language-mysql line-numbers-mode" data-highlighter="prismjs" data-ext="mysql" data-title="mysql"><pre><code><span class="line">/*</span>
<span class="line">DELIMITER $</span>
<span class="line">CREATE PROCEDURE 存储过程的名称(参数列表)</span>
<span class="line">BEGIN</span>
<span class="line">局部变量的定义</span>
<span class="line">多条sql语句</span>
<span class="line">流程控制语句</span>
<span class="line">END;$</span>
<span class="line">*/</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果存储过程中只有一条SQL语句可以省略BEGIN END</p><p>参数列表</p><table><thead><tr><th>参数模式</th><th>形参名称</th><th>参数类型</th></tr></thead><tbody><tr><td>IN</td><td>username</td><td>mysql数据库中的数据类型（数值型，字符型，日期型）</td></tr><tr><td>OUT</td><td>pwd</td><td>mysql数据库中的数据类型（数值型，字符型，日期型）</td></tr><tr><td>INOUT</td><td>xxx</td><td>mysql数据库中的数据类型（数值型，字符型，日期型）</td></tr></tbody></table><p>IN：声明该参数是一个输入姓参数（类似于java中的形参）</p><p>OUT：声明该参数为一个输出型参数（类似于java中的返回值），在一个存储过程中可以定义多个out类型的参数</p><p>INOUT：声明该参数可以为输入型参数，也可以为输出型参数</p><ul><li><p>存储过程调用</p><div class="language-mysql line-numbers-mode" data-highlighter="prismjs" data-ext="mysql" data-title="mysql"><pre><code><span class="line">CALL 存储过程的名称(实参列表) </span>
<span class="line">-- 实参列表中包含由输出类型的参数</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>存储过程演示</p><ul><li><p>无参的存储过程</p><div class="language-mysql line-numbers-mode" data-highlighter="prismjs" data-ext="mysql" data-title="mysql"><pre><code><span class="line">#用于向b_user表中插入2条数据</span>
<span class="line">DELIMITER $</span>
<span class="line">CREATE PROCEDURE pro_insert()</span>
<span class="line">BEGIN</span>
<span class="line">INSERT INTO b_user(name,sex) VALUES(&#39;1&#39;,&#39;1&#39;);</span>
<span class="line">INSERT INTO b_user(name,sex) VALUES(&#39;2&#39;,&#39;2&#39;);</span>
<span class="line">END;$</span>
<span class="line"></span>
<span class="line">CALL pro_insert();</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>带有IN模式参数的存储过程</p><div class="language-mysql line-numbers-mode" data-highlighter="prismjs" data-ext="mysql" data-title="mysql"><pre><code><span class="line">#用于向b_user插入2条数据，性别由客户输入</span>
<span class="line">DELIMITER $</span>
<span class="line">CREATE PROCEDURE pro_insert2(IN sex CHAR(1))</span>
<span class="line">BEGIN</span>
<span class="line">INSERT INTO b_user(name,sex) VALUES(&#39;1&#39;,sex);</span>
<span class="line">INSERT INTO b_user(name,sex) VALUES(&#39;2&#39;,sex);</span>
<span class="line">END;$</span>
<span class="line"></span>
<span class="line">CALl pro_insert2(&#39;男&#39;);</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>多个带有IN参数的存储过程</p><div class="language-mysql line-numbers-mode" data-highlighter="prismjs" data-ext="mysql" data-title="mysql"><pre><code><span class="line">#用于向b_user插入2条数据，用户名和密码由客户输入</span>
<span class="line">DELIMITER $</span>
<span class="line">CREATE PROCEDURE pro_insert3(IN name VARCHAR(10),IN sex VARCHAR(20))</span>
<span class="line">BEGIN</span>
<span class="line">INSERT INTO b_user(name,sex) VALUES(name,sex);</span>
<span class="line">INSERT INTO b_user(name,sex) VALUES(name,sex);</span>
<span class="line">END;$</span>
<span class="line"></span>
<span class="line">CALL pro_insert2(&#39;uname&#39;,&#39;男&#39;);</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>带IN，OUT参数的存储过程</p><div class="language-mysql line-numbers-mode" data-highlighter="prismjs" data-ext="mysql" data-title="mysql"><pre><code><span class="line">#判断用户登录，如果用户名和密码输入正确登录成功，否则登录失败</span>
<span class="line">#根据输入的用户名和密码作为条件去b_user表中查询，如果查询总行数==1，则认为登录成功，让result返回登录成功，否则登录失败</span>
<span class="line">DELIMITER $</span>
<span class="line">CREATE PROCEDURE pro_login(IN name VARCHAR(20),IN pwd VARCHAR(20),OUT result VARCHAR(20))</span>
<span class="line">BEGIN</span>
<span class="line">DECLARE total INT DEFAULT 0;-- 用于存放查询总行数</span>
<span class="line">select count(*) from b_user u where u.name=name and u.pwd=pwd;-- 将查询结果赋值给total局部变量</span>
<span class="line">SET result:=IF(total=1,&#39;登录成功&#39;,&#39;登录失败&#39;);</span>
<span class="line">END;$</span>
<span class="line">#存储过程如何执行</span>
<span class="line">-- 解决判断，使用自定义变量</span>
<span class="line">SET @result:=&#39;&#39;;</span>
<span class="line">CAll pro_login(&#39;李四&#39;,&#39;123&#39;,@result);</span>
<span class="line">select @result;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>删除存储过程</p><div class="language-mysql line-numbers-mode" data-highlighter="prismjs" data-ext="mysql" data-title="mysql"><pre><code><span class="line">DROP PROCEDURE 存储过程名称</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p>查看存储过程</p><div class="language-mysql line-numbers-mode" data-highlighter="prismjs" data-ext="mysql" data-title="mysql"><pre><code><span class="line">SHOW CREATE PROCEDURE 存储过程名称;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p>修改存储过程</p><div class="language-mysql line-numbers-mode" data-highlighter="prismjs" data-ext="mysql" data-title="mysql"><pre><code><span class="line">DROP</span>
<span class="line">CREATE</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li></ul></li></ul><h5 id="_2-1-流程控制语句" tabindex="-1"><a class="header-anchor" href="#_2-1-流程控制语句"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_2-1-%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E8%AF%AD%E5%8F%A5" target="_blank" rel="noopener noreferrer">#</a>2.1 流程控制语句</span></a></h5><blockquote><p>选择结构</p></blockquote><ul><li><p>IF函数</p><ul><li>功能：三目运算</li><li>语法：IF(逻辑表达式，表达式1，表达式2)</li></ul></li><li><p>IF结构</p><ul><li><p>功能：实现多路选择</p></li><li><p>注意：只能用在BEGIN END结构体中</p><div class="language-mysql line-numbers-mode" data-highlighter="prismjs" data-ext="mysql" data-title="mysql"><pre><code><span class="line">/*</span>
<span class="line">IF 逻辑表达式 THEN 语句1;</span>
<span class="line">ELSEIF 逻辑表达式2 THEN 语句2;</span>
<span class="line">...</span>
<span class="line">ELSE 语句n;</span>
<span class="line">END IF;</span>
<span class="line">*/</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li><li><p>CASE结构</p><ul><li>等值选择</li></ul><div class="language-mysql line-numbers-mode" data-highlighter="prismjs" data-ext="mysql" data-title="mysql"><pre><code><span class="line">CASE 字段|变量|表达式</span>
<span class="line">WHEN 值 THEN 值|语句</span>
<span class="line">WHEN 值 THEN 值</span>
<span class="line">...</span>
<span class="line">ELSE 值</span>
<span class="line">END</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>不等值选择</li></ul><div class="language-mysql line-numbers-mode" data-highlighter="prismjs" data-ext="mysql" data-title="mysql"><pre><code><span class="line">CASE</span>
<span class="line">WHEN 逻辑表达式 THEN 语句1</span>
<span class="line">...</span>
<span class="line">ELSE 语句n</span>
<span class="line">END</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><blockquote><p>循环结构</p></blockquote><ul><li><p>WHILE</p><div class="language-mysql line-numbers-mode" data-highlighter="prismjs" data-ext="mysql" data-title="mysql"><pre><code><span class="line">/*</span>
<span class="line">WHILE 逻辑表达式 DO</span>
<span class="line">循环体</span>
<span class="line">END WHILE;</span>
<span class="line">*/</span>
<span class="line">#需求：创建存储过程，输入一个值，返回1到该值的和</span>
<span class="line">#分析：一个输入参数，一个返回值，在结构体中，从1循环到输入的值，求和</span>
<span class="line">DELIMITER //</span>
<span class="line">CREATE PROCEDURE pro_sum(IN input INT,OUT total INT)</span>
<span class="line">BEGIN</span>
<span class="line">DECLARE i INT DEFAULT 1;</span>
<span class="line">DECLARE sum_ INT DEFAULT 0;</span>
<span class="line">WHILE i&lt;=input do</span>
<span class="line">SET sum_=sum_+i;</span>
<span class="line">SET i=i+1;</span>
<span class="line">END WHILE;</span>
<span class="line">SET totle:=sum_;</span>
<span class="line">END;//</span>
<span class="line"></span>
<span class="line">SET @result=0;</span>
<span class="line">CALL por_sun(10,@result);</span>
<span class="line">SELECT @result;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>LOOP</p><div class="language-mysql line-numbers-mode" data-highlighter="prismjs" data-ext="mysql" data-title="mysql"><pre><code><span class="line">#Loopnaem是定义的循环名称，为了跳出循环时指定跳出的循环</span>
<span class="line">loopname:LOOP;</span>
<span class="line">	IF 逻辑表达式 THEN</span>
<span class="line">	LEAVE loopname; -- 跳出当前指定的循环，类似于java中的break</span>
<span class="line">	END IF;</span>
<span class="line">END LOOP;</span>
<span class="line"></span>
<span class="line">DElIMITER //</span>
<span class="line">CREATE PROCEDURE pro_sum_loop(IN input INT,OUT total INT)</span>
<span class="line">BEGIN </span>
<span class="line">DECLARE i INT DEFAULT 1;</span>
<span class="line">DECLARE sum_ INT DEFAULT 0;</span>
<span class="line">a:LOOP;</span>
<span class="line">SET sum_:=sum_+i;</span>
<span class="line">SET i:=i+1;</span>
<span class="line">IF i&gt;input THEN</span>
<span class="line">LEAVE a;</span>
<span class="line">END IF;</span>
<span class="line">END LOOP;</span>
<span class="line">SET total:=sum_;</span>
<span class="line">END;//</span>
<span class="line"></span>
<span class="line">SET @result=0;</span>
<span class="line">CALL por_sum_loop(10,@result);</span>
<span class="line">SELECT @result;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>REPEAT</p><div class="language-mysql line-numbers-mode" data-highlighter="prismjs" data-ext="mysql" data-title="mysql"><pre><code><span class="line">REPEAT</span>
<span class="line">循环体</span>
<span class="line">UNTIL 逻辑表达式 -- 当满足逻辑表达式，跳出循环</span>
<span class="line">END REPEAT;</span>
<span class="line"></span>
<span class="line">DELIMITER //</span>
<span class="line">CREATE PROCEDURE pro_sum_loop(IN input INT,OUT total INT)</span>
<span class="line">BEGIN </span>
<span class="line">DECLARE i INT DEFAULT 1;</span>
<span class="line">DECLARE sum_ INT DEFAULT 0;</span>
<span class="line">REPEAT</span>
<span class="line">SET sum_:=sum_+i;</span>
<span class="line">SET i:=i+1</span>
<span class="line">UNTIL i&gt;input</span>
<span class="line">END REPEAT;</span>
<span class="line">SET total:=sum_;</span>
<span class="line">END;//</span>
<span class="line"></span>
<span class="line">SET @result=0;</span>
<span class="line">CALL por_sum_loop(10,@result);</span>
<span class="line">SELECT @result;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="三、存储函数" tabindex="-1"><a class="header-anchor" href="#三、存储函数"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#%E4%B8%89%E3%80%81%E5%AD%98%E5%82%A8%E5%87%BD%E6%95%B0" target="_blank" rel="noopener noreferrer">#</a>三、存储函数</span></a></h3><p>函数也是一组预先编译好的sql的集合，基本和存储过程相似</p><p><strong>函数和存储过程的区别</strong></p><ol><li>存储过程可以有0个，1个或多个返回值，适用于insert、update、delete操作</li><li>函数只能有一个返回值，适用于在处理数据以后，返回一个已知的结果</li></ol><h4 id="_1、创建函数" tabindex="-1"><a class="header-anchor" href="#_1、创建函数"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_1%E3%80%81%E5%88%9B%E5%BB%BA%E5%87%BD%E6%95%B0" target="_blank" rel="noopener noreferrer">#</a>1、创建函数</span></a></h4><div class="language-mysql line-numbers-mode" data-highlighter="prismjs" data-ext="mysql" data-title="mysql"><pre><code><span class="line">CREATE FUNCTION 函数名称(参数列表) RETURNS 返回类型 BINLOG参数</span>
<span class="line">BEGIN</span>
<span class="line">函数体</span>
<span class="line">END</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>参数列表</strong>：参数名称 参数类型</p><p><strong>BINLOG参数</strong></p><ul><li>NO SQL：函数体中没有sql语句， 也不会改参数</li><li>READS SQL DATE：函数体中存在sql语句，但是整个数据是只读的，不会修改数据</li><li>MODIFIES SQL DATE ：函数体中存在SQL语句，并且会修改数据</li><li>CONTAINS SQL：函数体中包含有SQL语句</li></ul><p><strong>函数体</strong>：在函数体汇总必须包含return语句，将return放在函数体最后一行执行</p><div class="language-mysql line-numbers-mode" data-highlighter="prismjs" data-ext="mysql" data-title="mysql"><pre><code><span class="line">#写一个函数，用于求两数之和</span>
<span class="line">DELIMITER //</span>
<span class="line">CREATE FUNCTION sum_(input1 INT,input2 INT) RETURNS INT NO SQL</span>
<span class="line">BEGIN</span>
<span class="line">return input1+input2;</span>
<span class="line">END;//</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2、使用函数" tabindex="-1"><a class="header-anchor" href="#_2、使用函数"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_2%E3%80%81%E4%BD%BF%E7%94%A8%E5%87%BD%E6%95%B0" target="_blank" rel="noopener noreferrer">#</a>2、使用函数</span></a></h4><div class="language-mysql line-numbers-mode" data-highlighter="prismjs" data-ext="mysql" data-title="mysql"><pre><code><span class="line">SELECT 函数名(参数列表);</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_3、查看函数" tabindex="-1"><a class="header-anchor" href="#_3、查看函数"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_3%E3%80%81%E6%9F%A5%E7%9C%8B%E5%87%BD%E6%95%B0" target="_blank" rel="noopener noreferrer">#</a>3、查看函数</span></a></h4><div class="language-mysql line-numbers-mode" data-highlighter="prismjs" data-ext="mysql" data-title="mysql"><pre><code><span class="line">SHOW CREATE FUNCTION 函数名;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_4、删除函数" tabindex="-1"><a class="header-anchor" href="#_4、删除函数"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_4%E3%80%81%E5%88%A0%E9%99%A4%E5%87%BD%E6%95%B0" target="_blank" rel="noopener noreferrer">#</a>4、删除函数</span></a></h4><div class="language-mysql line-numbers-mode" data-highlighter="prismjs" data-ext="mysql" data-title="mysql"><pre><code><span class="line">DROP FUNCTION 函数名;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="四、定时任务" tabindex="-1"><a class="header-anchor" href="#四、定时任务"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#%E5%9B%9B%E3%80%81%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1" target="_blank" rel="noopener noreferrer">#</a>四、定时任务</span></a></h3><h4 id="_1、查看定时策略是否开启" tabindex="-1"><a class="header-anchor" href="#_1、查看定时策略是否开启"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_1%E3%80%81%E6%9F%A5%E7%9C%8B%E5%AE%9A%E6%97%B6%E7%AD%96%E7%95%A5%E6%98%AF%E5%90%A6%E5%BC%80%E5%90%AF" target="_blank" rel="noopener noreferrer">#</a>1、查看定时策略是否开启</span></a></h4><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">&#39;%event_sche%&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>开启定时策略：</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">set</span> <span class="token keyword">global</span> event_scheduler<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_2、创建定时任务" tabindex="-1"><a class="header-anchor" href="#_2、创建定时任务"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_2%E3%80%81%E5%88%9B%E5%BB%BA%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1" target="_blank" rel="noopener noreferrer">#</a>2、创建定时任务</span></a></h4><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">create</span> event run_event</span>
<span class="line"><span class="token keyword">on</span> schedule every <span class="token number">1</span> <span class="token keyword">minute</span></span>
<span class="line"><span class="token keyword">on</span> completion preserve <span class="token keyword">disable</span></span>
<span class="line"><span class="token keyword">do</span> <span class="token keyword">call</span> test_procedure <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1、create event day_event：是创建名为run_event的事件 2、创建周期定时的规则，意思是每分钟执行一次 3、on completion preserve disable是表示创建后并不开始生效。 4、do call test_procedure ()是该event(事件)的操作内容</p><h4 id="_3、定时任务操作" tabindex="-1"><a class="header-anchor" href="#_3、定时任务操作"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_3%E3%80%81%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E6%93%8D%E4%BD%9C" target="_blank" rel="noopener noreferrer">#</a>3、定时任务操作</span></a></h4><p>1、查看定期任务</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">SELECT</span> event_name<span class="token punctuation">,</span>event_definition<span class="token punctuation">,</span>interval_value<span class="token punctuation">,</span>interval_field<span class="token punctuation">,</span><span class="token keyword">status</span> </span>
<span class="line"><span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span>EVENTS<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>2、开启或关闭定时任务</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">alter</span> event run_event <span class="token keyword">on</span> completion preserve <span class="token keyword">enable</span><span class="token punctuation">;</span><span class="token comment">//开启定时任务</span></span>
<span class="line"><span class="token keyword">alter</span> event run_event <span class="token keyword">on</span> completion preserve <span class="token keyword">disable</span><span class="token punctuation">;</span><span class="token comment">//关闭定时任务</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4、定时规则" tabindex="-1"><a class="header-anchor" href="#_4、定时规则"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#_4%E3%80%81%E5%AE%9A%E6%97%B6%E8%A7%84%E5%88%99" target="_blank" rel="noopener noreferrer">#</a>4、定时规则</span></a></h4><p>1、周期执行–关键字 EVERY 单位有：second、minute、hour、day、week(周)、quarter(季度)、month、year</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">on</span> schedule every <span class="token number">1</span> week <span class="token comment">//每周执行1次</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>2、在具体某个时间执行–关键字 AT</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">on</span> schedule at <span class="token keyword">current_timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">interval</span> <span class="token number">5</span> <span class="token keyword">day</span> <span class="token comment">//5天后执行</span></span>
<span class="line"><span class="token keyword">on</span> schedule at <span class="token string">&#39;2019-01-01 00:00:00&#39;</span> <span class="token comment">//在2019年1月1日，0点整执行</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>3、在某个时间段执行–关键字STARTS ENDS</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">on</span> schedule every <span class="token number">1</span> <span class="token keyword">day</span> starts <span class="token keyword">current_timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">interval</span> <span class="token number">5</span> <span class="token keyword">day</span> ends <span class="token keyword">current_timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">interval</span> <span class="token number">1</span> <span class="token keyword">month</span> <span class="token comment">//5天后开始每天都执行执行到下个月底</span></span>
<span class="line"><span class="token keyword">on</span> schedule every <span class="token number">1</span> <span class="token keyword">day</span> ends <span class="token keyword">current_timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">interval</span> <span class="token number">5</span> <span class="token keyword">day</span> <span class="token comment">//从现在起每天执行，执行5天</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="附录" tabindex="-1"><a class="header-anchor" href="#附录"><span><a href="https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance2.html#%E9%99%84%E5%BD%95" target="_blank" rel="noopener noreferrer">#</a>附录</span></a></h2><p>1、配置文件的举例</p><div class="language-ini line-numbers-mode" data-highlighter="prismjs" data-ext="ini" data-title="ini"><pre><code><span class="line"><span class="token comment">#[client]</span></span>
<span class="line"><span class="token comment">#MySQL默认密码</span></span>
<span class="line"><span class="token comment">#password=88888888</span></span>
<span class="line"><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">mysqld</span><span class="token punctuation">]</span></span></span>
<span class="line"><span class="token comment">#MySQL以什么用户运行</span></span>
<span class="line"><span class="token comment">#user=mysql</span></span>
<span class="line"><span class="token comment">#MySQL运行在哪个端口</span></span>
<span class="line"><span class="token comment">#port=3306</span></span>
<span class="line"><span class="token comment">#改参数指定了安装MySQL的安装路径，填写全路径可以解决相对路径所造成的问题</span></span>
<span class="line"><span class="token comment">#basedir</span></span>
<span class="line"><span class="token comment">#指定MySQL的数据库文件放在什么路径下</span></span>
<span class="line"><span class="token key attr-name">datadir</span><span class="token punctuation">=</span><span class="token value attr-value">/usr/local/mysql/data</span></span>
<span class="line"><span class="token comment">#mysql以socket方式运行的sock文件位置</span></span>
<span class="line"><span class="token key attr-name">socket</span><span class="token punctuation">=</span><span class="token value attr-value">/usr/local/mysql/mysql.sock</span></span>
<span class="line"><span class="token comment">#是否支持符号链接，即数据库或表可以存储在my.cnf中指定datadir之外的分区或者目录，为0不开启</span></span>
<span class="line"><span class="token key attr-name">symbolic-links</span><span class="token punctuation">=</span><span class="token value attr-value">0</span></span>
<span class="line"><span class="token comment">#服务器使用的字符集</span></span>
<span class="line"><span class="token key attr-name">character-set-server</span><span class="token punctuation">=</span><span class="token value attr-value">utf8</span></span>
<span class="line"><span class="token comment">#默认存储引擎</span></span>
<span class="line"><span class="token key attr-name">default-storage-engine</span><span class="token punctuation">=</span><span class="token value attr-value">INNODB</span></span>
<span class="line"><span class="token comment">#表示默认将日志文件存入文件，默认值是&#39;FILE&#39; </span></span>
<span class="line"><span class="token comment">#如果时候log-output=TABLE表示将日志存入数据库，这样日志信息就会被写入到mysql.slow_log表中</span></span>
<span class="line"><span class="token key attr-name">log-output</span><span class="token punctuation">=</span><span class="token value attr-value">FILE</span></span>
<span class="line"><span class="token comment">#1开启，0关闭 将所有到达MySQL Server的SQL语句记录下来</span></span>
<span class="line"><span class="token key attr-name">general-log</span><span class="token punctuation">=</span><span class="token value attr-value">0</span></span>
<span class="line"><span class="token comment">#设置日志文件保存位置</span></span>
<span class="line"><span class="token key attr-name">general_log_file</span><span class="token punctuation">=</span><span class="token value attr-value">&quot;<span class="token inner-value">JOYWANG.log</span>&quot;</span></span>
<span class="line"><span class="token comment">#慢查询日志是否开启1,0</span></span>
<span class="line"><span class="token key attr-name">slow-query-log</span><span class="token punctuation">=</span><span class="token value attr-value">1</span></span>
<span class="line"><span class="token comment">#慢查询日志文件保存</span></span>
<span class="line"><span class="token key attr-name">slow_query_log_file</span><span class="token punctuation">=</span><span class="token value attr-value">&quot;<span class="token inner-value">JOYWANG-slow.log</span>&quot;</span></span>
<span class="line"><span class="token comment">#慢查询日志设置时间单位秒 S</span></span>
<span class="line"><span class="token key attr-name">long_query_time</span><span class="token punctuation">=</span><span class="token value attr-value">10</span></span>
<span class="line"><span class="token comment">#是否启用错误日志的功能和错误日志的存储位置</span></span>
<span class="line"><span class="token key attr-name">log-error</span><span class="token punctuation">=</span><span class="token value attr-value">&quot;<span class="token inner-value">JOYWANG.err</span>&quot;</span></span>
<span class="line"><span class="token comment">#如果不设置则server-id是根据服务器ip地址后2位生成的，默认0或1</span></span>
<span class="line"><span class="token comment">#当配置MySQL复制时，是必填项，用来区分复制拓扑中的各个实例</span></span>
<span class="line"><span class="token key attr-name">server-id</span><span class="token punctuation">=</span><span class="token value attr-value">1</span></span>
<span class="line"><span class="token comment">#限制导入和导出的目录权限NULL表示禁止、如果是文件目录，允许该目录下文件（测试子目录不行）、如果为空则表示不限制目录，一定要有等号，否则mysql无法启动</span></span>
<span class="line"><span class="token key attr-name">secure-file-priv</span><span class="token punctuation">=</span></span>
<span class="line"><span class="token comment">#最大并发连接数，mysql会为每个连接提供缓冲区，会开销越多的内存，所以要适当的调整该值，不能盲目的提高设置值</span></span>
<span class="line"><span class="token key attr-name">max_connections</span><span class="token punctuation">=</span><span class="token value attr-value">151</span></span>
<span class="line"><span class="token comment">#指定高速缓存的大小，每当MySQL访问一个表时，如果在表缓冲区中还有空间，该表就被打开并放入其中，这样可以更快地访问表内容单位M</span></span>
<span class="line"><span class="token key attr-name">table_open_cache</span><span class="token punctuation">=</span><span class="token value attr-value">2000</span></span>
<span class="line"><span class="token comment">#增加一张临时表大小，提高查询速度</span></span>
<span class="line"><span class="token key attr-name">tmp_table_size</span><span class="token punctuation">=</span><span class="token value attr-value">16M</span></span>
<span class="line"><span class="token comment">#线程池缓存大小，当客户端断开连接后，将当前线程缓存起来，当在接到新的连接请求时快速响应，无需创建新的线程</span></span>
<span class="line"><span class="token key attr-name">thread_cache_size</span><span class="token punctuation">=</span><span class="token value attr-value">10</span></span>
<span class="line"><span class="token comment">#MySQL重建索引时允许使用的临时文件最大大小</span></span>
<span class="line"><span class="token key attr-name">MyIsam_max_sort_file_size</span><span class="token punctuation">=</span><span class="token value attr-value">100G</span></span>
<span class="line"><span class="token comment">#设置在REPAIR TABLE，或者用 CREATE INDEX 创建索引或 ALTER TABLE 的过程中排序索引所分配的缓冲区大小。可设置范围4Bytes 至 4GB，默认为8MB。</span></span>
<span class="line"><span class="token key attr-name">MyIsam_sort_buffer_size</span><span class="token punctuation">=</span><span class="token value attr-value">8M</span></span>
<span class="line"><span class="token comment">#指定索引缓冲区的大小，决定了索引处理的速度，尤其是索引读的速度，建议设置成物理内存的1/4，甚至物理内存的30%-40%，如果设置太大，系统就会频繁的换页，降低系统性能</span></span>
<span class="line"><span class="token key attr-name">key_buffer_size</span><span class="token punctuation">=</span><span class="token value attr-value">8M</span></span>
<span class="line"><span class="token comment">#MySQL读入缓冲区大小，对表进行顺序扫描的请求将分配一个读入缓冲区，MySQL会为它分配一段内存缓冲区。read_buffer_size变量控制这一缓冲区的大小。如果对表的顺序扫描请求非常频繁，并且你认为频繁扫描进行得太慢，可以通过增加该变量值以及内存缓冲区大小提高其性能。</span></span>
<span class="line"><span class="token key attr-name">read_buffer_size</span><span class="token punctuation">=</span><span class="token value attr-value">0</span></span>
<span class="line"><span class="token comment">#参数用在sort查询之后 ，以保证获取以顺序的方式获取到查询的数据。如果你有很多order by 查询语句，增长这值能够提升性能</span></span>
<span class="line"><span class="token key attr-name">read_rnd_buffer_size</span><span class="token punctuation">=</span><span class="token value attr-value">0</span></span>
<span class="line"><span class="token comment">#0：log buffer将每秒一次地写入log file中，并且log file的flush(刷到磁盘)操作同时进行。该模式下在事务提交的时候，不会主动触发写入磁盘的操作。</span></span>
<span class="line"><span class="token comment">#1：每次事务提交时MySQL都会把log buffer的数据写入log file，并且flush(刷到磁盘)中去，该模式为系统默认。</span></span>
<span class="line"><span class="token comment">#2：每次事务提交时MySQL都会把log buffer的数据写入log file，但是flush(刷到磁盘)操作并不会同时进行。该模式下，MySQL会每秒执行一次 flush(刷到磁盘)操作。</span></span>
<span class="line"><span class="token key attr-name">innodb_flush_log_at_trx_commit</span><span class="token punctuation">=</span><span class="token value attr-value">1</span></span>
<span class="line"><span class="token comment">#确保有足够大的日志缓冲区来保存脏数据在被写入到日志文件之前</span></span>
<span class="line"><span class="token key attr-name">innodb_log_buffer_size</span><span class="token punctuation">=</span><span class="token value attr-value">1M</span></span>
<span class="line"><span class="token comment">#指定表数据和索引存储的空间，可以是一个或者多个文件。最后一个数据文件必须是自动扩充的，也只有最后一个文件允许自动扩充。这样，当空间用完后，自动扩充数据文件就会自动增长（以8MB为单位）以容纳额外的数据。例如： innodb_data_file_path=/disk1/ibdata1:900M;/disk2/ibdata2:50M:autoextend两个数据文件放在不同的磁盘上。数据首先放在ibdata1中，当达到900M以后，数据就放在ibdata2中。一旦达到50MB，ibdata2将以 8MB为单位自动增长。如果磁盘满了，需要在另外的磁盘上面增加一个数据文件。</span></span>
<span class="line"><span class="token key attr-name">innodb_data_file_path</span><span class="token punctuation">=</span><span class="token value attr-value">/disk1/ibdata1:900M;/disk2/ibdata2:50M:autoextend</span></span>
<span class="line"><span class="token comment">#这是InnoDB最重要的设置，对InnoDB性能有决定性的影响。默认的设置只有8M，所以默认的数据库设置下面InnoDB性能很差。在只有InnoDB存储引擎的数据库服务器上面，可以设置60-80%的内存。更精确一点，在内存容量允许的情况下面设置比InnoDB tablespaces大10%的内存大小。</span></span>
<span class="line"><span class="token key attr-name">innodb_buffer_pool_size</span><span class="token punctuation">=</span><span class="token value attr-value">8M</span></span>
<span class="line"><span class="token comment">#放置表空间数据的目录，默认在mysql的数据目录，设置到和MySQL安装文件不同的分区可以提高性能。</span></span>
<span class="line"><span class="token key attr-name">innodb_data_home_dir</span><span class="token punctuation">=</span></span>
<span class="line"><span class="token comment">#该参数决定了recovery speed。太大的话recovery就会比较慢，太小了影响查询性能，一般取256M可以兼顾性能和recovery的速度</span></span>
<span class="line"><span class="token key attr-name">innodb_log_file_size</span><span class="token punctuation">=</span><span class="token value attr-value">48M</span></span>
<span class="line"><span class="token comment">#该参数设定了事务提交时内存中log信息的处理。</span></span>
<span class="line"><span class="token key attr-name">1)</span> <span class="token punctuation">=</span><span class="token value attr-value">1时，在每个事务提交时，日志缓冲被写到日志文件，对日志文件做到磁盘操作的刷新。Truly ACID。速度慢。</span></span>
<span class="line"><span class="token key attr-name">2)</span> <span class="token punctuation">=</span><span class="token value attr-value">2时，在每个事务提交时，日志缓冲被写到文件， 但不对日志文件做到磁盘操作的刷新。只有操作系统崩溃或掉电才会删除最后一秒的事务，不然不会丢失事务。</span></span>
<span class="line"><span class="token key attr-name">3)</span> <span class="token punctuation">=</span><span class="token value attr-value">0时， 日志缓冲每秒一次地被写到日志文件，并且对日志文件做到磁盘操作的刷新。任何mysqld进程的崩溃会删除崩溃前最后一秒的事务</span></span>
<span class="line"><span class="token key attr-name">innodb_flush_logs_at_trx_commit</span><span class="token punctuation">=</span><span class="token value attr-value">2</span></span>
<span class="line"><span class="token comment">#设置InnoDB同步IO的方式：</span></span>
<span class="line">) Default – 使用fsync（）。</span>
<span class="line">2) O_SYNC 以sync模式打开文件，通常比较慢。</span>
<span class="line">3) O_DIRECT，在Linux上使用Direct IO。可以显著提高速度，特别是在RAID系统上。避免额外的数据复制和double buffering（mysql buffering 和OS buffering）。</span>
<span class="line"><span class="token key attr-name">innodb_flush_method</span><span class="token punctuation">=</span><span class="token value attr-value">Default</span></span>
<span class="line"><span class="token comment">#InnoDB kernel最大的线程数。</span></span>
<span class="line">1) 最少设置为(num_disks+num_cpus)*2。</span>
<span class="line">2) 可以通过设置成1000来禁止这个限制</span>
<span class="line"><span class="token key attr-name">innodb_thread_concurrency</span><span class="token punctuation">=</span><span class="token value attr-value">25</span></span>
<span class="line"><span class="token comment">#此配置项作用主要是当tablespace 空间已经满了后，需要MySQL系统需要自动扩展多少空间，每次tablespace 扩展都会让各个SQL 处于等待状态。增加自动扩展Size可以减少tablespace自动扩展次数。</span></span>
<span class="line"><span class="token key attr-name">innodb_autoextend_increment</span><span class="token punctuation">=</span><span class="token value attr-value">64</span></span>
<span class="line"><span class="token comment">#可以开启多个内存缓冲池，把需要缓冲的数据hash到不同的缓冲池中，这样可以并行的内存读写。</span></span>
<span class="line"><span class="token key attr-name">innodb_buffer_pool_instances</span><span class="token punctuation">=</span><span class="token value attr-value">8</span></span>
<span class="line"><span class="token comment">#这个参数设置为一种tickets,默认是5000，我也不清楚到底它代表多久，从官方文档来看它和事物处理的行数有关，大事物需要处理的行数自然更多，小事物当然也就越少至少我们可以想成获得CPU的时间，干活期间他会不断减少，如果减少到0，这个线程将被提出innodb层次，进入前面说的等待队列，当然也就在队尾部了，这里假设有一个小的事物正在排队进入innodb层，又或者它已经进入了innodb层没有获得CPU时间轮片，突然一个大的事物tickets耗尽被提出了innodb层，那么这个小事物就自然而然能够获得CPU轮片干活，而小事物执行非常快，执行完成后，另外的事物又能尽快的获得CPU干活，不会由于OS线程调度不均匀的问题而造成的小事物饥饿问题，这很好理解。也就是前面我说的与其依赖OS的调度策略不如自己设置一种规则，让用到了一定时间轮片的线程先处于睡眠态放弃CPU的使用</span></span>
<span class="line"><span class="token key attr-name">innodb_concurrency_tickets</span><span class="token punctuation">=</span><span class="token value attr-value">5000</span></span>
<span class="line"><span class="token key attr-name">innodb_old_blocks_time</span><span class="token punctuation">=</span><span class="token value attr-value">1000</span></span>
<span class="line"><span class="token key attr-name">innodb_open_files</span><span class="token punctuation">=</span><span class="token value attr-value">300</span></span>
<span class="line"><span class="token key attr-name">innodb_stats_on_metadata</span><span class="token punctuation">=</span><span class="token value attr-value">0</span></span>
<span class="line"><span class="token comment">#可以存储每个InnoDB表和它的索引在它自己的文件中。</span></span>
<span class="line"><span class="token key attr-name">innodb_file_per_table</span><span class="token punctuation">=</span><span class="token value attr-value">1</span></span>
<span class="line"><span class="token comment">#如果应用程序可以运行在READ-COMMITED隔离级别，做此设定会有一定的性能提升。</span></span>
<span class="line"><span class="token key attr-name">transaction-isolation</span><span class="token punctuation">=</span><span class="token value attr-value">READ-COMITTED</span></span>
<span class="line"><span class="token comment">#这个参数用来表示 页读取到mid位置后，需要等待多久才会被加入到LRU列表的热端。使LRU列表中的热点数据不被刷出</span></span>
<span class="line"><span class="token key attr-name">innodb_checksum_algorithm</span><span class="token punctuation">=</span><span class="token value attr-value">0</span></span>
<span class="line"><span class="token comment">#MySQL暂时停止回答新请求之前的短时间内多少个请求可以被存在堆栈中</span></span>
<span class="line"><span class="token key attr-name">back_log</span><span class="token punctuation">=</span><span class="token value attr-value">80</span></span>
<span class="line"><span class="token key attr-name">flush_time</span><span class="token punctuation">=</span><span class="token value attr-value">0</span></span>
<span class="line"><span class="token comment">#如果按照检索的性能方式来细分，那么无论是两表 INNER JOIN 还是多表 INNER JOIN，都大致可以分为以下几类：1.JOIN KEY 有索引，主键2.JOIN KEY 有索引， 二级索引3.JOIN KEY 无索引；JOIN BUFFER 是 MySQL 用来缓存以上第二、第三这两类 JOIN 检索的一个 BUFFER 内存区域块。</span></span>
<span class="line"><span class="token key attr-name">join_buffer_size</span><span class="token punctuation">=</span><span class="token value attr-value">256K</span></span>
<span class="line"><span class="token comment">#可以增大此值以便于server端接收更大的SQL</span></span>
<span class="line"><span class="token key attr-name">max_allowed_packet</span><span class="token punctuation">=</span><span class="token value attr-value">4M</span></span>
<span class="line"><span class="token comment">#同一主机最大连续请求错误次数，如果还没成功建立连接，mysql服务器会组织这台主机后续的所有请求</span></span>
<span class="line"><span class="token key attr-name">max_connect_errors</span><span class="token punctuation">=</span><span class="token value attr-value">100</span></span>
<span class="line"><span class="token comment">#限制mysqld能打开文件的最大数</span></span>
<span class="line"><span class="token key attr-name">open_files_limit</span><span class="token punctuation">=</span><span class="token value attr-value">4161</span></span>
<span class="line"><span class="token comment">#一个connection级参数，在每个connection第一次需要使用这个buffer的时候，一次性分配设置的内存</span></span>
<span class="line"><span class="token key attr-name">sort_buffer_size</span><span class="token punctuation">=</span><span class="token value attr-value">256K</span></span>
<span class="line"><span class="token comment">#就是控制总frm文件的数量，还是个hash表，内部维护。如果打开的表实例的数量超过了table_definition_cache设置，LRU机制将开始标记表实例以进行清除，并最终将它们从数据字典缓存中删除。简单通俗点frm文件有多少，就设置多少了</span></span>
<span class="line"><span class="token key attr-name">table_definition_cache</span><span class="token punctuation">=</span><span class="token value attr-value">1400</span></span>
<span class="line"><span class="token comment">#指定基于行的二进制日志事件的最大大小</span></span>
<span class="line"><span class="token key attr-name">binlog_row_event_max_size</span><span class="token punctuation">=</span><span class="token value attr-value">8K</span></span>
<span class="line"><span class="token comment">#本参数用于主从库中配置从库大于0作用为每个命令之后刷盘，小与0作为为永不刷盘，默认均为1000</span></span>
<span class="line"><span class="token key attr-name">sync_master_info</span><span class="token punctuation">=</span><span class="token value attr-value">10000</span></span>
<span class="line"><span class="token comment">#这个参数和sync_binlog是一样的，当设置为1时，slave的I/O线程每次接收到master发送过来的binlog日志都要写入系统缓冲区，然后刷入relay log中继日志里，这样是最安全的，因为在崩溃的时候，你最多会丢失一个事务，但会造成磁盘的大量I/O。当设置为0时，并不是马上就刷入中继日志里，而是由操作系统决定何时来写入，虽然安全性降低了，但减少了大量的磁盘I/O操作。这个值默认是0，可动态修改，建议采用默认值。</span></span>
<span class="line"><span class="token key attr-name">sync_relay_log</span><span class="token punctuation">=</span><span class="token value attr-value">10000</span></span>
<span class="line"><span class="token comment">#这个参数和sync_relay_log参数一样，当设置为1时，slave的I/O线程每次接收到master发送过来的binlog日志都要写入系统缓冲区，然后刷入relay-log.info里，这样是最安全的，因为在崩溃的时候，你最多会丢失一个事务，但会造成磁盘的大量I/O。当设置为0时，并不是马上就刷入relay-log.info里，而是由操作系统决定何时来写入，虽然安全性降低了，但减少了大量的磁盘I/O操作。这个值默认是0，可动态修改，建议采用默认值</span></span>
<span class="line"><span class="token key attr-name">sync_relay_log_info</span><span class="token punctuation">=</span><span class="token value attr-value">10000</span></span>
<span class="line"><span class="token comment">#参数不可动态修改，必须重启数据库</span></span>
<span class="line"><span class="token comment">#1:存储在磁盘是小写，比较时不区分大小写</span></span>
<span class="line"><span class="token comment">#2:存储为给定的大小写但是比较时是小写</span></span>
<span class="line"><span class="token comment">#0:存储为给定的大小写和比较时区分大小写的</span></span>
<span class="line"><span class="token key attr-name">lower_case_table_names</span> <span class="token punctuation">=</span> <span class="token value attr-value">1</span></span>
<span class="line"><span class="token comment">#ONLY_FULL_GROUP_BY：归于GROUP BY聚合操作，如果在SELECT中的列，没有在GROUP BY中出现，那么这个SQL是不合法的，因为列不在GROUP BY从句中</span></span>
<span class="line"><span class="token comment">#NO_AUTO_VALUE_ON_ZERO：该值影响自增常烈的插入。默认设置下，插入0或者NULL代表生成下一个自增长值。如果用户希望插入的值为0，而该列又是自增长的，那么这个选项就有用了</span></span>
<span class="line"><span class="token comment">#STRICT_TRANS_TABLES：如果一个值不能插入到一个事物中，则中断当前操作，对非事物不做限制</span></span>
<span class="line"><span class="token comment">#NO_ZERO_IN_DATE：在严格模式下，不允许日期和月份为零</span></span>
<span class="line"><span class="token comment">#NO_ZERO_DATE：mysql不允许插入零日期，插入零日期会抛出错误而不是警告</span></span>
<span class="line"><span class="token comment">#ERROR_FOR_DIVISION_BY_ZERO：在insert或update过程中，如果数据被清除，则产生错误而非警告。如果未给出该模式，那么数据被清除时Mysql返回NULL</span></span>
<span class="line"><span class="token comment">#NO_AUTO_CREATE_USER：禁止GRANT创建密码为空的用户</span></span>
<span class="line"><span class="token comment">#NO_ENGINE_SUBSTITUTION：如果需要的存储引擎被禁用或未编译，那么抛出错误。不设置此值时，用默认的存储引擎替代，并抛出一个异常</span></span>
<span class="line"><span class="token comment">#PIPES_AS_CONCAT：将“||”是为字符串的链接操作符而非运算符，这和Oracle数据库是一样是，也和字符串的拼接函数Concat相类似</span></span>
<span class="line"><span class="token comment">#ANSI_QUOTES：不能用双引号来引用字符串，因为它被解释为识别符</span></span>
<span class="line"><span class="token key attr-name">sql_mode</span><span class="token punctuation">=</span><span class="token value attr-value">STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1161),t=[p];function i(o,c){return a(),n("div",null,t)}const d=s(l,[["render",i],["__file","index.html.vue"]]),u=JSON.parse('{"path":"/mysql2/","title":"MySql进阶","lang":"zh-CN","frontmatter":{},"headers":[{"level":2,"title":"mysql进阶-上","slug":"mysql进阶-上","link":"#mysql进阶-上","children":[]},{"level":2,"title":"#第一章 mysql架构","slug":"第一章-mysql架构","link":"#第一章-mysql架构","children":[{"level":3,"title":"#一、mysql的系统架构","slug":"一、mysql的系统架构","link":"#一、mysql的系统架构","children":[]},{"level":3,"title":"#二、目录结构","slug":"二、目录结构","link":"#二、目录结构","children":[]},{"level":3,"title":"#三、字符集和排序规则","slug":"三、字符集和排序规则","link":"#三、字符集和排序规则","children":[]},{"level":3,"title":"#四、mysql修改配置的方法","slug":"四、mysql修改配置的方法","link":"#四、mysql修改配置的方法","children":[]},{"level":3,"title":"#五、内置数据库","slug":"五、内置数据库","link":"#五、内置数据库","children":[]}]},{"level":2,"title":"#第二章 I/O和存储","slug":"第二章-i-o和存储","link":"#第二章-i-o和存储","children":[{"level":3,"title":"#一、IO成本","slug":"一、io成本","link":"#一、io成本","children":[]},{"level":3,"title":"#二、数据存储","slug":"二、数据存储","link":"#二、数据存储","children":[]}]},{"level":2,"title":"#第三章 缓冲池 buffer pool","slug":"第三章-缓冲池-buffer-pool","link":"#第三章-缓冲池-buffer-pool","children":[{"level":3,"title":"#一、内部结构","slug":"一、内部结构","link":"#一、内部结构","children":[]},{"level":3,"title":"#二、free链","slug":"二、free链","link":"#二、free链","children":[]},{"level":3,"title":"#三、flush链表","slug":"三、flush链表","link":"#三、flush链表","children":[]},{"level":3,"title":"#四、LRU链表","slug":"四、lru链表","link":"#四、lru链表","children":[]}]},{"level":2,"title":"#第四章 MySQL临时表","slug":"第四章-mysql临时表","link":"#第四章-mysql临时表","children":[{"level":3,"title":"#一、临时表简介","slug":"一、临时表简介","link":"#一、临时表简介","children":[]},{"level":3,"title":"#二、临时表分类","slug":"二、临时表分类","link":"#二、临时表分类","children":[]}]},{"level":2,"title":"#第五章 MySQL事务","slug":"第五章-mysql事务","link":"#第五章-mysql事务","children":[{"level":3,"title":"#一、事务简介","slug":"一、事务简介","link":"#一、事务简介","children":[]},{"level":3,"title":"#二、事务分类","slug":"二、事务分类","link":"#二、事务分类","children":[]},{"level":3,"title":"#三、事务四大特征（ACID）","slug":"三、事务四大特征-acid","link":"#三、事务四大特征-acid","children":[]},{"level":3,"title":"#四、事务隔离级别","slug":"四、事务隔离级别","link":"#四、事务隔离级别","children":[]}]},{"level":2,"title":"mysql进阶-下","slug":"mysql进阶-下","link":"#mysql进阶-下","children":[]},{"level":2,"title":"#第六章 索引","slug":"第六章-索引","link":"#第六章-索引","children":[{"level":3,"title":"#一、数据结构","slug":"一、数据结构","link":"#一、数据结构","children":[]},{"level":3,"title":"#二、索引的分类和创建","slug":"二、索引的分类和创建","link":"#二、索引的分类和创建","children":[]},{"level":3,"title":"#三、explain的用法","slug":"三、explain的用法","link":"#三、explain的用法","children":[]},{"level":3,"title":"#三、使用索引的问题","slug":"三、使用索引的问题","link":"#三、使用索引的问题","children":[]}]},{"level":2,"title":"#第七章 锁机制","slug":"第七章-锁机制","link":"#第七章-锁机制","children":[{"level":3,"title":"#一、InnoDB的锁类型","slug":"一、innodb的锁类型","link":"#一、innodb的锁类型","children":[]},{"level":3,"title":"#二、表锁","slug":"二、表锁","link":"#二、表锁","children":[]},{"level":3,"title":"#三、从另一个角度区分锁的分类","slug":"三、从另一个角度区分锁的分类","link":"#三、从另一个角度区分锁的分类","children":[]}]},{"level":2,"title":"#第八章 日志系统","slug":"第八章-日志系统","link":"#第八章-日志系统","children":[{"level":3,"title":"#一、bin log日志","slug":"一、bin-log日志","link":"#一、bin-log日志","children":[]},{"level":3,"title":"#二、其他日志","slug":"二、其他日志","link":"#二、其他日志","children":[]},{"level":3,"title":"#三、redo log日志","slug":"三、redo-log日志","link":"#三、redo-log日志","children":[]},{"level":3,"title":"#四、undo log日志","slug":"四、undo-log日志","link":"#四、undo-log日志","children":[]}]},{"level":2,"title":"#第九章、隔离级别和MVCC","slug":"第九章、隔离级别和mvcc","link":"#第九章、隔离级别和mvcc","children":[{"level":3,"title":"#一、Read View（读视图）","slug":"一、read-view-读视图","link":"#一、read-view-读视图","children":[]},{"level":3,"title":"#二、快照读原理解析","slug":"二、快照读原理解析","link":"#二、快照读原理解析","children":[]},{"level":3,"title":"#三、解决脏读和不可重复读","slug":"三、解决脏读和不可重复读","link":"#三、解决脏读和不可重复读","children":[]}]},{"level":2,"title":"#第十章 其他知识","slug":"第十章-其他知识","link":"#第十章-其他知识","children":[{"level":3,"title":"#一、触发器","slug":"一、触发器","link":"#一、触发器","children":[]},{"level":3,"title":"#二、存储过程","slug":"二、存储过程","link":"#二、存储过程","children":[]},{"level":3,"title":"#三、存储函数","slug":"三、存储函数","link":"#三、存储函数","children":[]},{"level":3,"title":"#四、定时任务","slug":"四、定时任务","link":"#四、定时任务","children":[]}]},{"level":2,"title":"#附录","slug":"附录","link":"#附录","children":[]}],"git":{"updatedTime":1723708439000,"contributors":[{"name":"zqb","email":"2506956864@qq.com","commits":1}]},"filePathRelative":"mysql2/README.md","excerpt":"\\n<h2>mysql进阶-上</h2>\\n<h2><a class=\\"header-anchor\\" href=\\"#第一章-mysql架构\\"><span></span></a><a href=\\"https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#%E7%AC%AC%E4%B8%80%E7%AB%A0-mysql%E6%9E%B6%E6%9E%84\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">#</a>第一章 mysql架构</h2>\\n<h3><a class=\\"header-anchor\\" href=\\"#一、mysql的系统架构\\"><span></span></a><a href=\\"https://www.ydlclass.com/doc21xnv/database/mysqladvance/mysqlAdvance1.html#%E4%B8%80%E3%80%81mysql%E7%9A%84%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">#</a>一、mysql的系统架构</h3>"}');export{d as comp,u as data};
