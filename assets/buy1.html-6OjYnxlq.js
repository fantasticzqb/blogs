import{_ as n,c as s,o as a,a as p}from"./app-CiSBoDQ3.js";const e={},t=p(`<h1 id="二手交易网项目" tabindex="-1"><a class="header-anchor" href="#二手交易网项目"><span>二手交易网项目</span></a></h1><h2 id="第1章-框架搭建" tabindex="-1"><a class="header-anchor" href="#第1章-框架搭建"><span>第1章 框架搭建</span></a></h2><p>元动力二奢交易平台：一线互联网大厂的一个<strong>二手奢侈品交易平台</strong>项目</p><p>总共16章 ：每章都是相对独立的，难度由简单到复杂。</p><p>前置技术：springboot springcloud(alibaba) es rabbitmq 支付 短信</p><h2 id="学习目标" tabindex="-1"><a class="header-anchor" href="#学习目标"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87" target="_blank" rel="noopener noreferrer">#</a>学习目标</span></a></h2><p>目标1：了解电商的技术特点和主要电商模式</p><p>目标2：理解元动力二奢平台的需求与系统设计</p><p>目标3：能够完成元动力二奢平台工程框架的搭建</p><p>目标4：能够完成商品微服务品牌增删改查功能</p><h2 id="_1-走进电商-面试了解" tabindex="-1"><a class="header-anchor" href="#_1-走进电商-面试了解"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_1-%E8%B5%B0%E8%BF%9B%E7%94%B5%E5%95%86-%E9%9D%A2%E8%AF%95%E4%BA%86%E8%A7%A3" target="_blank" rel="noopener noreferrer">#</a>1. 走进电商-面试了解</span></a></h2><h3 id="_1-1-电商行业分析" tabindex="-1"><a class="header-anchor" href="#_1-1-电商行业分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_1-1-%E7%94%B5%E5%95%86%E8%A1%8C%E4%B8%9A%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>1.1 电商行业分析</span></a></h3><p><strong>我国电商发展很快</strong></p><p><strong>萌芽初生阶段</strong>（1991-1999 年）。EDI 电子商务是电商行业的最初雏形。1997 年，我国最早的两家电子商务公司：中国商品交易中心和中国化工网分别上线，B2B 业务开始逐步得到发展。1999年，国内第一家 C2C 电商 8848 正式成立。同年8 月，易趣网成立。11 月，当当网成立。1999 年9 月，招商银行率先在国内全面启动“一网通”网上银行服务，成为国内首先实现全国联通“网上银行”的商业银行。这一时期的中国电商行业仍处于萌芽引入阶段，真正的互联网应用市场还没有形成雏形，电子商务环境远未成熟，网络零售也才刚刚起步。</p><p><strong>初期竞争阶段</strong>（2000-2009年）。2000 年国际范围内的互联网泡沫破灭导致了我国电子商务也受到巨大的影响，8848 逐步没落，易趣被 eBay 收购，一大批新兴的电商网站关闭。但是机遇与挑战并存，2003 年，中国电商发展史上最为重要的两家企业淘宝网、京东相继成立。易趣与淘宝之争是电商发展史上第一次激烈的同业竞争，淘宝网以免费策略与行业老大易趣开展竞争，在 3 年的时间里，淘宝在这次竞争中大获全胜。在这一阶段中，C2C 也逐步成为当时我国网络购物市场（包括 B2C 和 C2C）的主流商业模式。2008 年我国成为全球网民最多的国家，电子商务交易额突破 3 万亿元，2009 年网购人数突破 1 亿。</p><p><strong>高速成长阶段</strong>（2010-2014 年）。2010 年，淘宝迎来第二个双十一购物节，GMV 规模从 2009 年的 0.5 亿元猛增至 9.36 亿元，双十一当天共有 2100 万用户参与了这次历史级别的购物节，全天诞生了 181 家百万级店铺。 2011-2014 年电商交易额继续高速增长，其中网络购物市场依然火爆，占社会商品零售总额的比例大幅度提高，双十一已经成为行业独有的网络购物节。在这一时期，苏宁易购、京东、国美等电商巨头发起了最为激烈的电商价格战，行业在竞争中高速成长。截止 2014年年底，中国电商行业已经全面超越欧盟、日本等经济体，部分领域甚至超越了美国。</p><p><strong>稳定发展阶段</strong>（2015-2017 年）。以腾讯和京东的战略合作达成成为标志，2015 年起，资本推动下的激烈竞争正式结束，多领域的电商平台纷纷走向合作。2015 年出现的从美团大众点评、携程去哪儿、滴滴快的、58 与赶集等生活服务电商均实现了合并。2015-2017 年网购人数、电商交易总额、网络零售交易额与 2010-2014 年相比规模明显增大，但增长速度放缓。电商市场由蓝海逐渐变为红海，发展进入相对稳定的阶段。</p><p><strong>新的变化阶段</strong>（2018-2020 年）。这一阶段之前，淘系与腾讯系京东已经基本坐稳了行业的前两位座次，随着行业发展逐步成熟，两家巨头的规模逐渐扩大，整体增长速度慢慢放缓。进入 2018 年，拼多多的迅速崛起打破了这一平衡，2018 年，成立仅 2 年的拼多多的用户数突破 3 亿，GMV 突破 4700 亿。2019 年，拼多多推出“百亿补贴”这一在电商发展历史上具有重要意义的营销活动，也拉开了又一轮电商行业的激烈竞争。也是在 2018-2020 年，短视频领域迎来爆发，两大巨头纷纷入局电商领域，成为行业在几年内少有的新进大型玩家。电商行业在经历短暂几年的平稳后，持续迎来新的变化。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/1-1.3040cbb8.png" alt="img"></p><p>我们盯住一个垂直行业做</p><p><strong>二手奢侈品行业成新蓝海</strong></p><p>《中国二手奢侈品市场发展研究报告2020》（以下简称报告）显示，二奢的消费主力军<strong>已逐渐从高收入、高阶层群体向普通大众靠拢，呈现年轻化趋势</strong>。2019年，<strong>76%的二奢</strong>被36岁以下的人群买走。</p><p>实体店生意如火如荼，二手奢侈品线上赛道也很火热，刺激了资本的入局。</p><p>●去年5月12日，二手奢侈品流通服务商胖虎科技完成1.75亿元B轮融资。据悉，胖虎成立于2015年，是一家闲置奢侈品线上平台。2019年胖虎营收约6亿元，GMV（网站成交金额）超过10亿元。截至2020年4月，胖虎APP用户数超过120万。</p><p>●另一家二手奢侈品平台妃鱼也在去年2月完成了千万美元的A轮融资。记者了解到，相较于胖虎，妃鱼更专注于二手奢侈品直播电商。早在2018年，妃鱼就开始在淘宝直播卖二手奢侈品。2019年妃鱼整体销售额近十亿元。在60名自营主播中，月销百万的高达50%以上。</p><p>●红布林也是二手奢侈品赛道中的一个重量级选手。2019年8月，红布林已完成两千万美元B+轮融资。据悉，红布林采取C2B2C模式，从卖家手中回收，经过鉴定和重新定价之后，再进行售卖。2019年，Plum红布林平台交易量实现了数十倍的增长，月GMV（网站成交金额）数千万。</p><p>●除了垂直二手奢侈品电商外，越来越多的时尚或电商平台也加入了这一赛道。例如，时尚电商平台寺库同时售卖全新和二手奢侈品，以分级标注区分两者；奢侈品服务平台包大师由奢侈品养护切入，后延展至二手奢侈品和新品交易；京东2019年7月开设了售价奢侈品服务体验中心“京东奢护”，店内设有二手奢侈品售卖区。</p><h3 id="_1-2-电商系统技术特点" tabindex="-1"><a class="header-anchor" href="#_1-2-电商系统技术特点"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_1-2-%E7%94%B5%E5%95%86%E7%B3%BB%E7%BB%9F%E6%8A%80%E6%9C%AF%E7%89%B9%E7%82%B9" target="_blank" rel="noopener noreferrer">#</a>1.2 电商系统技术特点</span></a></h3><p><strong>技术新</strong>：单体架构-》微服务 dubbo mycat</p><p><strong>技术范围广</strong>: java go python 阿里招聘物理学博士 阿里云，改进光纤，水冷、油冷。</p><p><strong>分布式</strong>：分开部署 user 北京机房</p><p>user 上海机房</p><p><strong>高并发</strong>: 秒杀 玛莎拉蒂 500w-&gt;500块 100w请求--》order</p><p><strong>集群</strong>: 一件事儿-&gt;按照逻辑分成多个微服务 下单---减库存99（10份） 支付 物流服务</p><p><strong>负载均衡</strong>: 10wqps---- 5w-北京 5w-上海 F5 nginx</p><p><strong>高可用</strong>: 北京机房 上海机房 深圳机房</p><p><strong>海量数据</strong>：1亿 10亿 100亿的订单 TB----&gt;PB-----&gt;EB</p><p><strong>业务复杂</strong>：大数据分析 打标签 ：手机淘宝 长腿小姐姐 ------》 手机淘宝 小米粥 卫生纸</p><p><strong>系统安全</strong>：支付宝 改钱：1进去了 2进淘宝了</p><h3 id="_1-3-主要电商模式" tabindex="-1"><a class="header-anchor" href="#_1-3-主要电商模式"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_1-3-%E4%B8%BB%E8%A6%81%E7%94%B5%E5%95%86%E6%A8%A1%E5%BC%8F" target="_blank" rel="noopener noreferrer">#</a>1.3 主要电商模式</span></a></h3><p><strong>B2B</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">B2B （ Business to Business）是指进行电子商务交易的供需双方都是商家（或企业、公司），她（他）们使用了互联网的技术或各种商务网络平台，完成商务交易的过程。电子商务是现代 B2B marketing的一种具体主要的表现形式。</span>
<span class="line"></span>
<span class="line">案例：阿里巴巴（1688）</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>C2C</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">C2C即 Customer to Customer，意思就是消费者个人间的电子商务行为。比如一个消费者有一台电脑，通过网络进行交易，把它出售给另外一个消费者，此种交易类型就称为C2C电子商务。</span>
<span class="line"></span>
<span class="line">案例：咸鱼、转转、瓜子二手车</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>B2C</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">B2C是Business-to-Customer的缩写，而其中文简称为“商对客”。“商对客”是电子商务的一种模式，也就是通常说的直接面向消费者销售产品和服务商业零售模式。这种形式的电子商务一般以网络零售业为主，主要借助于互联网开展在线销售活动。B2C即企业通过互联网为消费者提供一个新型的购物环境——网上商店，消费者通过网络在网上购物、网上支付等消费行为。</span>
<span class="line"></span>
<span class="line">案例：唯品会、乐蜂网</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>C2B</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">C2B（Consumer to Business，即消费者到企业），是互联网经济时代新的商业模式。这一模式改变了原有生产者（企业和机构）和消费者的关系，是一种消费者贡献价值（Create Value）， 企业和机构消费价值（Consume Value）。</span>
<span class="line"></span>
<span class="line">C2B模式和我们熟知的供需模式（DSM, Demand SupplyModel）恰恰相反，真正的C2B 应该先有消费者需求产生而后有企业生产，即先有消费者提出需求，后有生产企业按需求组织生产。通常情况为消费者根据自身需求定制产品和价格，或主动参与产品设计、生产和定价，产品、价格等彰显消费者的个性化需求，生产企业进行定制化生产。</span>
<span class="line"></span>
<span class="line">案例：海尔商城</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>O2O</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">O2O即Online To Offline（在线离线/线上到线下），是指将线下的商务机会与互联网结合，让互联网成为线下交易的平台，这个概念最早来源于美国。O2O的概念非常广泛，既可涉及到线上，又可涉及到线下,可以通称为O2O。主流商业管理课程均对O2O这种新型的商业模式有所介绍及关注。</span>
<span class="line"></span>
<span class="line">案例：美团、饿了吗</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>F2C</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">F2C指的是Factory to customer，即从厂商到消费者的电子商务模式。</span>
<span class="line"></span>
<span class="line">案例：代工厂</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>B2B2C</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">B2B2C（Business to Business to Consumer）是一种电子商务类型的网络购物商业模式，B是BUSINESS的简称，C是CUSTOMER的简称，第一个B指的是商品或服务的供应商，第二个B指的是从事电子商务的企业，C则是表示消费者。</span>
<span class="line"></span>
<span class="line">案例：京东商城、天猫商城</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-元动力二奢-需求分析与系统设计" tabindex="-1"><a class="header-anchor" href="#_2-元动力二奢-需求分析与系统设计"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-%E5%85%83%E5%8A%A8%E5%8A%9B%E4%BA%8C%E5%A5%A2-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90%E4%B8%8E%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1" target="_blank" rel="noopener noreferrer">#</a>2. 元动力二奢-需求分析与系统设计</span></a></h2><h3 id="_2-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_2-1-需求分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>2.1 需求分析</span></a></h3><p><strong>网站前台</strong>：静态原型全流程演示，打开<code>资料\\静态原型\\前台</code>，首页<code>index.html</code></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211008213033650.5c1f4ebd.png" alt="image-20211008213033650"></p><p>里面的功能可以依次点击搜索</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211008213132574.8642b22e.png" alt="image-20211008213132574"></p><p>商品详情页：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211008213324214.36348d97.png" alt="image-20211008213324214"></p><p>加入购物车：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211008213351346.6be0602b.png" alt="image-20211008213351346"></p><p>下单页面：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211008213417824.7650acc3.png" alt="image-20211008213417824"></p><p>选择支付页面：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211008213454485.15ab001b.png" alt="image-20211008213454485"></p><p>微信支付页面：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211008213510887.3f90e1a3.png" alt="image-20211008213510887"></p><p>支付成功页面：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211008213530598.7bdd1dd2.png" alt="image-20211008213530598"></p><p>这一整套购物流程。</p><p>还包括秒杀流程：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211008213622354.e29dfd25.png" alt="image-20211008213622354"></p><p><strong>网站管理后台</strong>（商家所见页面）：</p><p>静态原型演示，打开<code>资料\\静态原型\\后台</code>,首页<code>登录界面.html</code></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211008213828253.e0a325e9.png" alt="image-20211008213828253"></p><p>商家所见页面：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211008213901719.ee753e71.png" alt="image-20211008213901719"></p><p>其中有商品的上下架功能，报表统计功能。</p><p>我们的动力二奢平台采用的模式为：<strong>B2B2C</strong> 模式。</p><p>补充：企业开发流程</p><p>0 项目（产品）经理。UI 原型图 需求文档：登录页面 商品详情页</p><p>1项目经理让美工做出原型页面</p><p>2项目经理 拉着后端开发 前端开发工程师 讨论</p><p>3定义业务（业务）接口 post http://ip:port/goods/add {name:手表,price:200}</p><p>4前后端分离开发</p><p>5前后端联调 dev 服务器</p><p>6测试环境发布，测试部门测试</p><p>7预发布环境（业务部门老大 、技术部门老大）</p><p>8运维人员 正式上线 生产环境</p><p>9线上bug：快速修复，当天晚上11-12 部署上线。程序员回不了家原因。</p><h3 id="_2-2-系统设计" tabindex="-1"><a class="header-anchor" href="#_2-2-系统设计"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-2-%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1" target="_blank" rel="noopener noreferrer">#</a>2.2 系统设计</span></a></h3><h4 id="_2-2-1-前后端分离" tabindex="-1"><a class="header-anchor" href="#_2-2-1-前后端分离"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-2-1-%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB" target="_blank" rel="noopener noreferrer">#</a>2.2.1 前后端分离</span></a></h4><p>网站后台的部分采用前后端分离方式。</p><p>以前的JavaWeb项目大多数都是java程序员又当爹又当妈，又搞前端jsp，又搞后端。随着时代的发展，渐渐的许多大中小公司开始把前后端的界限分的越来越明确，前端工程师只管前端的事情，后端工程师只管后端的事情。正所谓术业有专攻，一个人如果什么都会，那么他毕竟什么都不精。</p><p>对于后端java工程师：</p><p>把精力放在设计模式，spring+springmvc，linux，mysql事务隔离与锁机制，mongodb，http/tcp，多线程，分布式架构，弹性计算架构，微服务架构，java性能优化，以及相关的项目管理等等。</p><p>对于前端工程师：</p><p>把精力放在html5，css3，vuejs，webpack，nodejs，Google V8引擎，javascript多线程，模块化，面向切面编程，设计模式，浏览器兼容性，性能优化等等。</p><p>我们在本课程中提供与项目课程配套的管理后台的前端代码，但是不讲解前端的内容。这样我们会将更多的精力放在<strong>后端代码</strong>的开发上！</p><p>以往：jsp页面</p><p>特点：包含后端代码，页面html等混杂。</p><p>缺点：不利于大型项目协作</p><p>现在：术业有专攻。</p><p>前端：各种js（angular.js vue.js react.js） ajax axios 异步请求。</p><p>后端：spring全家桶 中间件</p><p>交互格式：json</p><h4 id="_2-2-2-技术架构-面试" tabindex="-1"><a class="header-anchor" href="#_2-2-2-技术架构-面试"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-2-2-%E6%8A%80%E6%9C%AF%E6%9E%B6%E6%9E%84-%E9%9D%A2%E8%AF%95" target="_blank" rel="noopener noreferrer">#</a>2.2.2 技术架构-面试</span></a></h4><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211009163750326.bdf6f6cc.png" alt="image-20211009163750326"></p><p>面试：你们上个项目中，技术架构，用到哪些技术呢？</p><h4 id="_2-2-3-系统架构图-面试" tabindex="-1"><a class="header-anchor" href="#_2-2-3-系统架构图-面试"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-2-3-%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E5%9B%BE-%E9%9D%A2%E8%AF%95" target="_blank" rel="noopener noreferrer">#</a>2.2.3 系统架构图-面试</span></a></h4><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211009170804497.08e99c3d.png" alt="image-20211009170804497"></p><p>面试：你们上个项目中，业务架构？</p><h2 id="_3-元动力二奢-框架搭建" tabindex="-1"><a class="header-anchor" href="#_3-元动力二奢-框架搭建"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-%E5%85%83%E5%8A%A8%E5%8A%9B%E4%BA%8C%E5%A5%A2-%E6%A1%86%E6%9E%B6%E6%90%AD%E5%BB%BA" target="_blank" rel="noopener noreferrer">#</a>3. 元动力二奢-框架搭建</span></a></h2><h3 id="_3-1-环境准备" tabindex="-1"><a class="header-anchor" href="#_3-1-环境准备"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-1-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87" target="_blank" rel="noopener noreferrer">#</a>3.1 环境准备</span></a></h3><h4 id="导入虚拟机" tabindex="-1"><a class="header-anchor" href="#导入虚拟机"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#%E5%AF%BC%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA" target="_blank" rel="noopener noreferrer">#</a>导入虚拟机</span></a></h4><p>补充：虚拟机：复制了？选<strong>移动</strong>了？</p><p>IP:192.168.200.128</p><p>root 123456</p><p>ifconfig 显示ip</p><p>导入虚拟机：注意修改相关号段</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/2020-04-05-11-26-50-image.ffc91bef.png" alt="img"></p><h4 id="_1修改vmware-vmnet8" tabindex="-1"><a class="header-anchor" href="#_1修改vmware-vmnet8"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_1%E4%BF%AE%E6%94%B9vmware-vmnet8" target="_blank" rel="noopener noreferrer">#</a>1修改vmware vmnet8</span></a></h4><p><img src="https://www.ydlclass.com/doc21xnv/assets/2020-04-05-11-29-30-image.625bd38f.png" alt="img"></p><p>子网IP:192.168.200.0</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/2020-04-05-11-30-22-image.cd0fe5f8.png" alt="img"></p><p>DHCP设置：起始结束号段 200</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/2020-04-05-11-30-51-image.045e73cc.png" alt="img"></p><p>NAT设置：网关 192.168.200.2</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/2020-04-05-11-31-25-image.d5610301.png" alt="img"></p><h4 id="_2修改本机vmnet8-地址" tabindex="-1"><a class="header-anchor" href="#_2修改本机vmnet8-地址"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2%E4%BF%AE%E6%94%B9%E6%9C%AC%E6%9C%BAvmnet8-%E5%9C%B0%E5%9D%80" target="_blank" rel="noopener noreferrer">#</a>2修改本机vmnet8 地址</span></a></h4><p>右键网络打开共享中心</p><p>修改适配器设置</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/2020-04-05-11-32-12-image.f586abdb.png" alt="img"></p><p>vnet8网卡 右键 属性</p><p>ipv4协议 修改</p><p>本机IP 192.168.200.1</p><p>网关 192.168.200.2</p><p>dns 192.168.200.2</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20200406011408858.000b8157.png" alt="image-20200406011408858"></p><h4 id="_3启动虚拟机" tabindex="-1"><a class="header-anchor" href="#_3启动虚拟机"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3%E5%90%AF%E5%8A%A8%E8%99%9A%E6%8B%9F%E6%9C%BA" target="_blank" rel="noopener noreferrer">#</a>3启动虚拟机</span></a></h4><p>root 123456</p><h4 id="_4xshell-crt-finalshell-连接到虚拟机" tabindex="-1"><a class="header-anchor" href="#_4xshell-crt-finalshell-连接到虚拟机"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_4xshell-crt-finalshell-%E8%BF%9E%E6%8E%A5%E5%88%B0%E8%99%9A%E6%8B%9F%E6%9C%BA" target="_blank" rel="noopener noreferrer">#</a>4xshell crt finalshell 连接到虚拟机</span></a></h4><p>作业：linux 相关命令复习 vim命令</p><h3 id="_3-2-项目结构说明" tabindex="-1"><a class="header-anchor" href="#_3-2-项目结构说明"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-2-%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84%E8%AF%B4%E6%98%8E" target="_blank" rel="noopener noreferrer">#</a>3.2 项目结构说明</span></a></h3><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211009104138637.b7517fce.png" alt="image-20211009104138637"></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211009104247340.bd04ec28.png" alt="image-20211009104247340"></p><p>结构说明：</p><p>ydleses_gateway</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">网关模块，根据网站的规模和需要，可以将综合逻辑相关的服务用网关路由组合到一起。在这里还可以做鉴权和限流相关操作。</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>ydleses_service</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">微服务模块，该模块用于存放所有独立的微服务工程。</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>ydleses_service_api <strong>bean</strong> <strong>feign</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">对应工程的JavaBean、Feign、以及Hystrix配置，该工程主要对外提供依赖。</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>ydleses_transaction_fescar</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">分布式事务模块，将分布式事务抽取到该工程中，任何工程如需要使用分布式事务，只需依赖该工程即可。</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>ydleses_web</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">web服务工程，对应功能模块如需要调用多个微服务，可以将他们写入到该模块中，例如网站后台、网站前台等</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>面试问题：</p><p>1微服务好处：</p><p>2分布式事务：</p><h3 id="_3-3-父工程搭建" tabindex="-1"><a class="header-anchor" href="#_3-3-父工程搭建"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-3-%E7%88%B6%E5%B7%A5%E7%A8%8B%E6%90%AD%E5%BB%BA" target="_blank" rel="noopener noreferrer">#</a>3.3 父工程搭建</span></a></h3><h4 id="_3-3-1-一级父工程搭建" tabindex="-1"><a class="header-anchor" href="#_3-3-1-一级父工程搭建"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-3-1-%E4%B8%80%E7%BA%A7%E7%88%B6%E5%B7%A5%E7%A8%8B%E6%90%AD%E5%BB%BA" target="_blank" rel="noopener noreferrer">#</a>3.3.1 一级父工程搭建</span></a></h4><p>创建java maven父工程 ydles_parent 注意：<strong>com.ydles</strong></p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.4.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>skipTests</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>skipTests</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">&lt;!--依赖包--&gt;</span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token comment">&lt;!--测试包--&gt;</span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>Greenwich.SR1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>删除src</p><h4 id="_3-3-2-二级父工程模块搭建" tabindex="-1"><a class="header-anchor" href="#_3-3-2-二级父工程模块搭建"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-3-2-%E4%BA%8C%E7%BA%A7%E7%88%B6%E5%B7%A5%E7%A8%8B%E6%A8%A1%E5%9D%97%E6%90%AD%E5%BB%BA" target="_blank" rel="noopener noreferrer">#</a>3.3.2 二级父工程模块搭建</span></a></h4><p>创建ydles_gateway、ydles_service、ydles_service_api、ydles_web工程，工程全部为pom工程，并将所有工程的src文件删除。</p><h3 id="_3-4-eureka微服务搭建" tabindex="-1"><a class="header-anchor" href="#_3-4-eureka微服务搭建"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-4-eureka%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BA" target="_blank" rel="noopener noreferrer">#</a>3.4 Eureka微服务搭建</span></a></h3><p>（1）pom.xml依赖</p><p>创建模块ydles_eureka，pom.xml引入依赖</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6</p><p>（2） application.yml配置</p><p>创建配置文件application.yml</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">server</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6868</span></span>
<span class="line"><span class="token key atrule">eureka</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">client</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment">#是否将自己注册到eureka中</span></span>
<span class="line">    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment">#是否从eureka中获取信息</span></span>
<span class="line">    <span class="token key atrule">service-url</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>$<span class="token punctuation">{</span>server.port<span class="token punctuation">}</span>/eureka/</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8</p><p>（3）启动类配置</p><p>创建包com.ydles.eureka 包下创建启动类</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@SpringBootApplication</span></span>
<span class="line"><span class="token annotation punctuation">@EnableEurekaServer</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EurekaApplication</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">EurekaApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><h3 id="_3-5-公共模块搭建" tabindex="-1"><a class="header-anchor" href="#_3-5-公共模块搭建"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-5-%E5%85%AC%E5%85%B1%E6%A8%A1%E5%9D%97%E6%90%AD%E5%BB%BA" target="_blank" rel="noopener noreferrer">#</a>3.5 公共模块搭建</span></a></h3><h4 id="_3-5-1-全局公共模块" tabindex="-1"><a class="header-anchor" href="#_3-5-1-全局公共模块"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-5-1-%E5%85%A8%E5%B1%80%E5%85%AC%E5%85%B1%E6%A8%A1%E5%9D%97" target="_blank" rel="noopener noreferrer">#</a>3.5.1 全局公共模块</span></a></h4><p>（1）pom.xml依赖</p><p>创建公共子模块ydles_common，pom.xml引入依赖</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token comment">&lt;!--web起步依赖--&gt;</span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token comment">&lt;!-- redis 使用--&gt;</span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.51<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）常用对象</p><p>创建com.ydles.entity包 ，包下封装相关公共实体类。将&#39;资源/common_entity&#39;下的相关资源导入工程</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211009115407557.9e25d9d8.png" alt="image-20211009115407557"></p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>entity</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 返回结果实体类</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> flag<span class="token punctuation">;</span><span class="token comment">//是否成功</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Integer</span> code<span class="token punctuation">;</span><span class="token comment">//返回码</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> message<span class="token punctuation">;</span><span class="token comment">//返回消息</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">T</span> data<span class="token punctuation">;</span><span class="token comment">//返回数据</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> flag<span class="token punctuation">,</span> <span class="token class-name">Integer</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">,</span> <span class="token class-name">Object</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>flag <span class="token operator">=</span> flag<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> code<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>message <span class="token operator">=</span> message<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span>data<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> flag<span class="token punctuation">,</span> <span class="token class-name">Integer</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>flag <span class="token operator">=</span> flag<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> code<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>message <span class="token operator">=</span> message<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> <span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>message <span class="token operator">=</span> <span class="token string">&quot;执行成功&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//getter and setter..</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>建立类用于承载分页的数据结果</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 分页结果类</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PageResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Long</span> total<span class="token punctuation">;</span><span class="token comment">//总记录数</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> rows<span class="token punctuation">;</span><span class="token comment">//记录</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">PageResult</span><span class="token punctuation">(</span><span class="token class-name">Long</span> total<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> rows<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>total <span class="token operator">=</span> total<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>rows <span class="token operator">=</span> rows<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">PageResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//getter and setter ......</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建返回状态码实体类</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 返回码</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StatusCode</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">OK</span><span class="token operator">=</span><span class="token number">20000</span><span class="token punctuation">;</span><span class="token comment">//成功</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">ERROR</span> <span class="token operator">=</span><span class="token number">20001</span><span class="token punctuation">;</span><span class="token comment">//失败</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">LOGINERROR</span> <span class="token operator">=</span><span class="token number">20002</span><span class="token punctuation">;</span><span class="token comment">//用户名或密码错误</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">ACCESSERROR</span> <span class="token operator">=</span><span class="token number">20003</span><span class="token punctuation">;</span><span class="token comment">//权限不足</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">REMOTEERROR</span> <span class="token operator">=</span><span class="token number">20004</span><span class="token punctuation">;</span><span class="token comment">//远程调用失败</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">REPERROR</span> <span class="token operator">=</span><span class="token number">20005</span><span class="token punctuation">;</span><span class="token comment">//重复操作</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-5-2-数据访问公共模块搭建" tabindex="-1"><a class="header-anchor" href="#_3-5-2-数据访问公共模块搭建"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-5-2-%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E5%85%AC%E5%85%B1%E6%A8%A1%E5%9D%97%E6%90%AD%E5%BB%BA" target="_blank" rel="noopener noreferrer">#</a>3.5.2 数据访问公共模块搭建</span></a></h4><p>这个公共模块是连接mysql数据库的公共微服务模块，所以需要连接mysql的微服务都继承自此工程。</p><p>创建公共模块ydles_common_db，pom文件引入依赖</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ydles_common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token comment">&lt;!--通用mapper起步依赖--&gt;</span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>tk.mybatis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mapper-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.0.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token comment">&lt;!--MySQL数据库驱动--&gt;</span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token comment">&lt;!--mybatis分页插件--&gt;</span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.github.pagehelper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>pagehelper-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-6-商品微服务搭建" tabindex="-1"><a class="header-anchor" href="#_3-6-商品微服务搭建"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-6-%E5%95%86%E5%93%81%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BA" target="_blank" rel="noopener noreferrer">#</a>3.6 商品微服务搭建</span></a></h3><h4 id="_3-6-1-商品微服务api工程搭建" tabindex="-1"><a class="header-anchor" href="#_3-6-1-商品微服务api工程搭建"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-6-1-%E5%95%86%E5%93%81%E5%BE%AE%E6%9C%8D%E5%8A%A1api%E5%B7%A5%E7%A8%8B%E6%90%AD%E5%BB%BA" target="_blank" rel="noopener noreferrer">#</a>3.6.1 商品微服务API工程搭建</span></a></h4><p>（1）ydles_service_api 引入依赖</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>provided<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>javax.persistence<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>persistence-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>compile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）ydles_service_api 下创建ydles_service_goods_api子模块并添加common依赖</p><h4 id="_3-6-2-微服务工程搭建" tabindex="-1"><a class="header-anchor" href="#_3-6-2-微服务工程搭建"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-6-2-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%B7%A5%E7%A8%8B%E6%90%AD%E5%BB%BA" target="_blank" rel="noopener noreferrer">#</a>3.6.2 微服务工程搭建</span></a></h4><p>项目结构中：</p><p>1ydles_service_api 微服务的feignClient,实体类。</p><p>2ydles_service 微服务：启动类 controller service dao。</p><p>ydles_service_api：微服务接口工程。</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>javax.persistence<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>persistence-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>compile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8</p><p>ydles_service_goods_api：商品微服务工程,实体类。</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ydles_common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><p>ydles_service_goods工程</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line">	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ydles_common_db<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ydles_service_goods_api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12</p><p>application.yml</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">server</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9011</span></span>
<span class="line"><span class="token key atrule">spring</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">application</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> goods</span>
<span class="line">  <span class="token key atrule">datasource</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver</span>
<span class="line">    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//192.168.200.128<span class="token punctuation">:</span>3306/ydles_goods<span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC</span></span>
<span class="line">    <span class="token key atrule">username</span><span class="token punctuation">:</span> root</span>
<span class="line">    <span class="token key atrule">password</span><span class="token punctuation">:</span> root</span>
<span class="line"><span class="token key atrule">eureka</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">client</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">service-url</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>6868/eureka</span>
<span class="line">  <span class="token key atrule">instance</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line"><span class="token key atrule">feign</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">hystrix</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">#hystrix 配置</span></span>
<span class="line"><span class="token key atrule">hystrix</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">command</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">default</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">execution</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">timeout</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token comment">#如果enabled设置为false，则请求超时交给ribbon控制</span></span>
<span class="line">          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">        <span class="token key atrule">isolation</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">strategy</span><span class="token punctuation">:</span> SEMAPHORE</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>com.ydles.goods</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@SpringBootApplication</span></span>
<span class="line"><span class="token annotation punctuation">@EnableEurekaClient</span></span>
<span class="line"><span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">&quot;com.ydles.goods.dao&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GoodsApplication</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">GoodsApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8</p><p><strong>注意：@MapperScan是tk.mybatis.spring.annotation包下的，用于扫描Mapper接口</strong></p><h2 id="_4-商品微服务-品牌增删改查" tabindex="-1"><a class="header-anchor" href="#_4-商品微服务-品牌增删改查"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_4-%E5%95%86%E5%93%81%E5%BE%AE%E6%9C%8D%E5%8A%A1-%E5%93%81%E7%89%8C%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5" target="_blank" rel="noopener noreferrer">#</a>4. 商品微服务-品牌增删改查</span></a></h2><h3 id="_4-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_4-1-需求分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_4-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>4.1 需求分析</span></a></h3><p>创建商品微服务，实现对品牌表的增删改查功能。具体包括</p><p>（1）查询全部列表数据</p><p>（2）根据ID查询实体数据</p><p>（3）增加</p><p>（4）修改</p><p>（5）删除</p><p>（6）条件查询</p><p>（7）分页查询</p><p>（8）分页+条件查询</p><p>写一个测试controller</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/demo&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token annotation punctuation">@RestController</span> <span class="token comment">//组合注解</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoController</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">&quot;demo mesage&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8</p><p>测试时先启动注册中心</p><h3 id="_4-2-表结构分析" tabindex="-1"><a class="header-anchor" href="#_4-2-表结构分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_4-2-%E8%A1%A8%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>4.2 表结构分析</span></a></h3><table><thead><tr><th>字段名称</th><th>字段含义</th><th>字段类型</th><th>字段长度</th><th>备注</th></tr></thead><tbody><tr><td>id</td><td>品牌id</td><td>INT</td><td></td><td></td></tr><tr><td>name</td><td>品牌名称</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>img</td><td>品牌图片地址</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>letter</td><td>品牌的首字母</td><td>CHAR</td><td></td><td></td></tr><tr><td>seq</td><td>排序</td><td>INT</td><td></td><td></td></tr></tbody></table><h3 id="_4-3-代码实现" tabindex="-1"><a class="header-anchor" href="#_4-3-代码实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_4-3-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>4.3 代码实现</span></a></h3><p><strong>注意</strong>：写代码要由底往上写。</p><p>定义接口：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">GET ip:port/brand/findAll</span>
<span class="line"></span>
<span class="line">返回</span>
<span class="line">{</span>
<span class="line">flag:true</span>
<span class="line">code:20000</span>
<span class="line">msg:&quot;成功&quot;，</span>
<span class="line">data:[]</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9</p><h4 id="_4-3-1-品牌列表" tabindex="-1"><a class="header-anchor" href="#_4-3-1-品牌列表"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_4-3-1-%E5%93%81%E7%89%8C%E5%88%97%E8%A1%A8" target="_blank" rel="noopener noreferrer">#</a>4.3.1 品牌列表</span></a></h4><p>（1）在ydles_service_goods_api创建com.ydles.goods.pojo包，包下创建Brand实体类</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;tb_brand&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Brand</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Id</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Integer</span> id<span class="token punctuation">;</span><span class="token comment">//品牌id</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span><span class="token comment">//品牌名称</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> image<span class="token punctuation">;</span><span class="token comment">//品牌图片地址</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> letter<span class="token punctuation">;</span><span class="token comment">//品牌的首字母</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Integer</span> seq<span class="token punctuation">;</span><span class="token comment">//排序</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// getter and setter  .....(省略)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11</p><p>@Table和@Id都是JPA注解，@Table用于配置表与实体类的映射关系，@Id用于标识主键属性。</p><p>（2）Dao创建</p><p>在ydles_service_goods微服务下创建com.ydles.goods.dao.BrandMapper接口，代码如下：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BrandMapper</span> <span class="token keyword">extends</span> <span class="token class-name">Mapper</span><span class="token operator">&lt;</span>Brand<span class="token operator">&gt;</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><p>继承了Mapper接口，就自动实现了增删改查的常用方法。</p><p>（3）业务层</p><p>创建com.ydles.goods.service.BrandService接口，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BrandService</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/***</span>
<span class="line">     * 查询所有品牌</span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">  <span class="token keyword">public</span>  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Brand</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8</p><p>创建com.ydles.goods.service.impl包，包下创建服务实现类 BrandServiceImpl，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Service</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BrandServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">BrandService</span> <span class="token punctuation">{</span></span>
<span class="line">    </span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">BrandMapper</span> brandMapper<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Brand</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> brandMapper<span class="token punctuation">.</span><span class="token function">selectAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span>   </span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11</p><p>（3）控制层</p><p>控制层 com.ydles.goods包下创建controller包 ，包下创建类</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@RestController</span></span>
<span class="line"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/brand&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BrandController</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">BrandService</span> brandService<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@GetMapping</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Brand</span><span class="token punctuation">&gt;</span></span> brandList <span class="token operator">=</span> brandService<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span><span class="token string">&quot;查询成功&quot;</span><span class="token punctuation">,</span>brandList<span class="token punctuation">)</span> <span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  </span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最后测试 http://localhost:9011/brand</p><p>可用postman测试</p><h4 id="_4-3-2-根据id查询品牌" tabindex="-1"><a class="header-anchor" href="#_4-3-2-根据id查询品牌"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_4-3-2-%E6%A0%B9%E6%8D%AEid%E6%9F%A5%E8%AF%A2%E5%93%81%E7%89%8C" target="_blank" rel="noopener noreferrer">#</a>4.3.2 根据ID查询品牌</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">GET ip:port/brand/102</span>
<span class="line"></span>
<span class="line">{</span>
<span class="line">flag:true</span>
<span class="line">code:20000</span>
<span class="line">msg:&quot;成功&quot;，</span>
<span class="line">data:{}</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8</p><p><strong>套路代码</strong></p><p>（1） 业务层接口</p><p>修改com.ydles.goods.service.BrandService接口，添加根据ID查询品牌数据方法，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 根据ID查询</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">id</span></span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Brand</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6</p><p>（2）业务层实现</p><p>修改com.ydles.goods.service.impl.BrandServiceImpl新增方法，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 根据ID查询</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">id</span></span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Brand</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span>  brandMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9</p><p>（3） 控制层</p><p>BrandController新增方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/***</span>
<span class="line"> * 根据ID查询品牌数据</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">id</span></span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/{id}&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">Brand</span> brand <span class="token operator">=</span> brandService<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span><span class="token string">&quot;查询成功&quot;</span><span class="token punctuation">,</span>brand<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10</p><p>测试http://localhost:9011/brand/102</p><h4 id="_4-3-3-新增品牌" tabindex="-1"><a class="header-anchor" href="#_4-3-3-新增品牌"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_4-3-3-%E6%96%B0%E5%A2%9E%E5%93%81%E7%89%8C" target="_blank" rel="noopener noreferrer">#</a>4.3.3 新增品牌</span></a></h4><p>需求：POST http://localhost:9011/brand/insert</p><p>json</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">{</span>
<span class="line">	&quot;name&quot;: &quot;Cartier&quot;,</span>
<span class="line">	&quot;image&quot;: &quot;123&quot;</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">返回</span>
<span class="line">{</span>
<span class="line">flag:true</span>
<span class="line">code:20000</span>
<span class="line">msg:&quot;成功&quot;</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6</p><p>（1）业务层接口 修改com.ydles.goods.service.BrandService，新增方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/***</span>
<span class="line"> * 新增品牌</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">brand</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Brand</span> brand<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p>（2）业务层实现 修改com.ydles.goods.service.impl.BrandServiceImpl，新增增加品牌方法代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 增加</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">brand</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Brand</span> brand<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    brandMapper<span class="token punctuation">.</span><span class="token function">insertSelective</span><span class="token punctuation">(</span>brand<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8</p><p>（3）控制层 BrandController新增方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/***</span>
<span class="line"> * 新增品牌数据</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">brand</span></span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@PostMapping</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Brand</span> brand<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    brandService<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>brand<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span><span class="token string">&quot;添加成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10</p><h4 id="_4-3-4-修改品牌" tabindex="-1"><a class="header-anchor" href="#_4-3-4-修改品牌"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_4-3-4-%E4%BF%AE%E6%94%B9%E5%93%81%E7%89%8C" target="_blank" rel="noopener noreferrer">#</a>4.3.4 修改品牌</span></a></h4><p>需求：PUT http://localhost:9011/brand/update/102</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">{</span>
<span class="line">  &quot;name&quot;: &quot;卡地亚&quot;</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3</p><p><strong>修改某一个品牌时，只修改传进来的数据。</strong></p><p>（1） 业务层接口</p><p>需改com.ydles.goods.service.BrandService,添加修改品牌方法，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/***</span>
<span class="line"> * 修改品牌数据</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">brand</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Brand</span> brand<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p>（2）业务层实现 修改com.ydles.goods.service.impl.BrandServiceImpl，添加修改品牌方法，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 修改</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">brand</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Brand</span> brand<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    brandMapper<span class="token punctuation">.</span><span class="token function">updateByPrimaryKeySelective</span><span class="token punctuation">(</span>brand<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8</p><p>（3）控制层</p><p>BrandController新增方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/***</span>
<span class="line"> * 修改品牌数据</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">brand</span></span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">id</span></span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@PutMapping</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">&quot;/{id}&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Brand</span> brand<span class="token punctuation">,</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    brand<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    brandService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>brand<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span><span class="token string">&quot;修改成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12</p><h4 id="_4-3-5-删除品牌" tabindex="-1"><a class="header-anchor" href="#_4-3-5-删除品牌"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_4-3-5-%E5%88%A0%E9%99%A4%E5%93%81%E7%89%8C" target="_blank" rel="noopener noreferrer">#</a>4.3.5 删除品牌</span></a></h4><p>需求：DELETE http://localhost:9011/brand/325414</p><p>（1）业务层接口</p><p>修改com.ydles.goods.service.BrandService，添加删除品牌方法，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/***</span>
<span class="line"> * 删除品牌</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">id</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p>（2）业务层实现 修改com.ydles.goods.service.impl.BrandServiceImpl，新增删除品牌方法，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 删除</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">id</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    brandMapper<span class="token punctuation">.</span><span class="token function">deleteByPrimaryKey</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8</p><p>（3）控制层 BrandController新增方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/***</span>
<span class="line"> * 根据ID删除品牌数据</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">id</span></span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@DeleteMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/{id}&quot;</span> <span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    brandService<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span><span class="token string">&quot;删除成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10</p><p>代码优化：</p><p>1代码里的魔法值 ----》常量或者枚举</p><p>2<strong>resful风格</strong> ：</p><p>前后端交互中，json传递数据。</p><p>数据的增删改查，使用http的不同方法。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">查询 GET  </span>
<span class="line">新增 POST</span>
<span class="line">修改 PUT</span>
<span class="line">删除 DELETE</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><h4 id="_4-3-6-品牌列表条件查询" tabindex="-1"><a class="header-anchor" href="#_4-3-6-品牌列表条件查询"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_4-3-6-%E5%93%81%E7%89%8C%E5%88%97%E8%A1%A8%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2" target="_blank" rel="noopener noreferrer">#</a>4.3.6 品牌列表条件查询</span></a></h4><p>需求：Get http://localhost:9011/brand/search?name=奈儿&amp;letter=C</p><p>sql:select * from tb_brand where name like &#39;%奈儿%&#39; and letter=C</p><p>（1） 业务层接口</p><p>修改com.ydles.goods.service.BrandService，增加根据条件搜索品牌方法，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/***</span>
<span class="line"> * 多条件搜索品牌方法</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">searchMap</span></span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Brand</span><span class="token punctuation">&gt;</span></span> <span class="token function">findList</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> searchMap<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6</p><p>（2）业务层实现 修改com.ydles.goods.service.impl.BrandServiceImpl，添加根据多条件搜索品牌方法的实现，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">//缺啥补啥</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Brand</span><span class="token punctuation">&gt;</span></span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> searchMap<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//sql: select * from tb_brand where letter=C and name like &quot;%奈儿%&quot;</span></span>
<span class="line">        <span class="token class-name">Example</span> example<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Example</span><span class="token punctuation">(</span><span class="token class-name">Brand</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//criteria 放搜索条件</span></span>
<span class="line">        <span class="token class-name">Example<span class="token punctuation">.</span>Criteria</span> criteria <span class="token operator">=</span> example<span class="token punctuation">.</span><span class="token function">createCriteria</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span>searchMap<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>searchMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">//and name like &quot;%奈儿%&quot;</span></span>
<span class="line">                criteria<span class="token punctuation">.</span><span class="token function">andLike</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;%&quot;</span><span class="token operator">+</span>searchMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;%&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>searchMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;letter&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">//and name like &quot;%奈儿%&quot;</span></span>
<span class="line">                criteria<span class="token punctuation">.</span><span class="token function">andEqualTo</span><span class="token punctuation">(</span><span class="token string">&quot;letter&quot;</span><span class="token punctuation">,</span>searchMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;letter&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Brand</span><span class="token punctuation">&gt;</span></span> brandList <span class="token operator">=</span> brandMapper<span class="token punctuation">.</span><span class="token function">selectByExample</span><span class="token punctuation">(</span>example<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> brandList<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（3） 控制层 BrandController新增方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/***</span>
<span class="line"> * 多条件搜索品牌数据</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">searchMap</span></span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/search&quot;</span> <span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">findList</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">Map</span> searchMap<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Brand</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> brandService<span class="token punctuation">.</span><span class="token function">findList</span><span class="token punctuation">(</span>searchMap<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span><span class="token string">&quot;查询成功&quot;</span><span class="token punctuation">,</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10</p><p>postman测试 http://localhost:9011/brand/search?name=</p><h4 id="_4-3-7-品牌列表分页查询" tabindex="-1"><a class="header-anchor" href="#_4-3-7-品牌列表分页查询"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_4-3-7-%E5%93%81%E7%89%8C%E5%88%97%E8%A1%A8%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2" target="_blank" rel="noopener noreferrer">#</a>4.3.7 品牌列表分页查询</span></a></h4><p>需求 GET http://localhost:9011/brand/search/3/5</p><p>sql:select * from tb_brand limit 20,10</p><p>（1） 业务层接口 修改com.ydles.goods.service.BrandService添加分页方法，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/***</span>
<span class="line"> * 分页查询</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">page</span></span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">size</span></span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Brand</span><span class="token punctuation">&gt;</span></span> <span class="token function">findPage</span><span class="token punctuation">(</span><span class="token keyword">int</span> page<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）业务层实现 修改com.ydles.goods.service.impl.BrandServiceImpl添加分页方法实现，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 分页查询</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">pagejava</span></span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">size</span></span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Brand</span><span class="token punctuation">&gt;</span></span> <span class="token function">findPage</span><span class="token punctuation">(</span><span class="token keyword">int</span> page<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">PageHelper</span><span class="token punctuation">.</span><span class="token function">startPage</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Brand</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>brandMapper<span class="token punctuation">.</span><span class="token function">selectAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（3） 控制层 BrandController新增方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/***</span>
<span class="line"> * 分页搜索实现</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">page</span></span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">size</span></span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/search/{page}/{size}&quot;</span> <span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">findPage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span>  <span class="token keyword">int</span> page<span class="token punctuation">,</span> <span class="token annotation punctuation">@PathVariable</span>  <span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Brand</span><span class="token punctuation">&gt;</span></span> pageList <span class="token operator">=</span> brandService<span class="token punctuation">.</span><span class="token function">findPage</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">PageResult</span> pageResult<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">PageResult</span><span class="token punctuation">(</span>pageList<span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>pageList<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span><span class="token string">&quot;查询成功&quot;</span><span class="token punctuation">,</span>pageResult<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-3-8-品牌列表条件-分页查询" tabindex="-1"><a class="header-anchor" href="#_4-3-8-品牌列表条件-分页查询"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_4-3-8-%E5%93%81%E7%89%8C%E5%88%97%E8%A1%A8%E6%9D%A1%E4%BB%B6-%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2" target="_blank" rel="noopener noreferrer">#</a>4.3.8 品牌列表条件+分页查询</span></a></h4><p>需求： GET http://localhost:9011/brand/searchPage/2/5?lettrt=I&amp;name=&quot;奈儿&quot;</p><p>（1） 业务层接口 修改com.ydles.goods.service.BrandService，增加多条件分页查询方法，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/***</span>
<span class="line"> * 多条件分页查询</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">searchMap</span></span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">page</span></span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">size</span></span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Brand</span><span class="token punctuation">&gt;</span></span> <span class="token function">findPage</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> searchMap<span class="token punctuation">,</span> <span class="token keyword">int</span> page<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）业务层实现 修改com.ydles.goods.service.impl.BrandServiceImpl，添加多条件分页查询方法代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line">     * 条件+分页查询</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">searchMap</span> 查询条件</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">page</span> 页码</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">size</span> 页大小</span>
<span class="line">     * <span class="token keyword">@return</span> 分页结果</span>
<span class="line">     */</span></span>
<span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Brand</span><span class="token punctuation">&gt;</span></span> <span class="token function">findPage</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> searchMap<span class="token punctuation">,</span> <span class="token keyword">int</span> page<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">PageHelper</span><span class="token punctuation">.</span><span class="token function">startPage</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">Example</span> example<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Example</span><span class="token punctuation">(</span><span class="token class-name">Brand</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">Example<span class="token punctuation">.</span>Criteria</span> criteria <span class="token operator">=</span> example<span class="token punctuation">.</span><span class="token function">createCriteria</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span>searchMap<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 品牌名称</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span>searchMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token string">&quot;&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>searchMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            criteria<span class="token punctuation">.</span><span class="token function">andLike</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;%&quot;</span><span class="token operator">+</span>searchMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;%&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token comment">// 品牌的首字母</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span>searchMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;letter&quot;</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token string">&quot;&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>searchMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;letter&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            criteria<span class="token punctuation">.</span><span class="token function">andEqualTo</span><span class="token punctuation">(</span><span class="token string">&quot;letter&quot;</span><span class="token punctuation">,</span>searchMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;letter&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Brand</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>brandMapper<span class="token punctuation">.</span><span class="token function">selectByExample</span><span class="token punctuation">(</span>example<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（3）控制层 BrandController新增方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/***</span>
<span class="line"> * 分页搜索实现</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">searchMap</span></span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">page</span></span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">size</span></span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/search/{page}/{size}&quot;</span> <span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">findPage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">Map</span> searchMap<span class="token punctuation">,</span> <span class="token annotation punctuation">@PathVariable</span>  <span class="token keyword">int</span> page<span class="token punctuation">,</span> <span class="token annotation punctuation">@PathVariable</span>  <span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Brand</span><span class="token punctuation">&gt;</span></span> pageList <span class="token operator">=</span> brandService<span class="token punctuation">.</span><span class="token function">findPage</span><span class="token punctuation">(</span>searchMap<span class="token punctuation">,</span> page<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">PageResult</span> pageResult<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">PageResult</span><span class="token punctuation">(</span>pageList<span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>pageList<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span><span class="token string">&quot;查询成功&quot;</span><span class="token punctuation">,</span>pageResult<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-公共异常处理" tabindex="-1"><a class="header-anchor" href="#_5-公共异常处理"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_5-%E5%85%AC%E5%85%B1%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86" target="_blank" rel="noopener noreferrer">#</a>5. 公共异常处理</span></a></h2><p>为了使我们的代码更容易维护，我们创建一个类集中处理异常</p><p>在com.ydles.goods.handler包下创建公共异常处理类BaseExceptionHandler</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 统一异常处理类</span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@ControllerAdvice</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BaseExceptionHandler</span> <span class="token punctuation">{</span></span>
<span class="line">    </span>
<span class="line">    <span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token annotation punctuation">@ResponseBody</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">error</span><span class="token punctuation">(</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        </span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">ERROR</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>拓展：java 异常错误分类</p><p>总结：</p><p>1走进电商 元动力二奢 -面试</p><p>电商是什么 有技术特点</p><p>二奢市场地位</p><p>2元动力二奢 需求</p><p>技术架构</p><p>业务架构</p><p>3搭建项目</p><p>导入虚拟机</p><p>代码架构</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211009104138637.b7517fce.png" alt="image-20211009104138637"></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211009104247340.bd04ec28.png" alt="image-20211009104247340"></p><p>父工程 二级父工程 注册中心</p><p>商品微服务</p><p>4品牌的crud</p><p>查询：tk.mybatis</p><p>条件查询：example</p><p>分页：pageHelper</p><p>5公共异常处理</p><p>异常分类</p><h2 id="第2章-分布式文件存储" tabindex="-1"><a class="header-anchor" href="#第2章-分布式文件存储"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#%E7%AC%AC2%E7%AB%A0-%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8" target="_blank" rel="noopener noreferrer">#</a>第2章 分布式文件存储</span></a></h2><p>角色：商品 后端开发</p><h2 id="学习目标-1" tabindex="-1"><a class="header-anchor" href="#学习目标-1"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87-1" target="_blank" rel="noopener noreferrer">#</a>学习目标</span></a></h2><p>目标1：能够CORS解决跨域问题</p><p>目标2：理解规格参数模板与商品分类表结构</p><p>目标3：掌握通用mapper自定义方法的使用</p><p>目标4：能够使用分布式文件存储FastDFS上传文件</p><h2 id="_1-跨域解决方案cors-面试" tabindex="-1"><a class="header-anchor" href="#_1-跨域解决方案cors-面试"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_1-%E8%B7%A8%E5%9F%9F%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88cors-%E9%9D%A2%E8%AF%95" target="_blank" rel="noopener noreferrer">#</a>1. 跨域解决方案CORS-面试</span></a></h2><h3 id="_1-1-什么是跨域" tabindex="-1"><a class="header-anchor" href="#_1-1-什么是跨域"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_1-1-%E4%BB%80%E4%B9%88%E6%98%AF%E8%B7%A8%E5%9F%9F" target="_blank" rel="noopener noreferrer">#</a>1.1 什么是跨域</span></a></h3><p>面试：</p><p>1什么是跨域问题：<strong>浏览器</strong>的<strong>同源策略</strong>，导致不能向其他域名发送<strong>异步</strong>请求。</p><p>2同源策略：具有相同的协议（protocol），主机（host）和端口号（port）</p><p>页面：http://192.168.1.1:8080/search 商品搜索页面</p><p>https://192.168.1.1:8080/search?name=手表 -----&gt;no</p><p>http://192.168.1.2:8080/search -------------&gt;no</p><p>http://192.168.1.1:8081/goods/add -------------&gt;no</p><p>http://192.168.1.1:8080/goods/add -------------&gt; YES</p><p>出于浏览器的同源策略限制。同源策略（Sameoriginpolicy）是一种约定，它是浏览器最核心也最基本的安全功能，如果缺少了同源策略，则浏览器的正常功能可能都会受到影响。可以说Web是构建在同源策略基础之上的，浏览器只是针对同源策略的一种实现。同源策略会阻止一个域的javascript脚本和另外一个域的内容进行交互。所谓同源（即指在同一个域）就是两个页面具有相同的协议（protocol），主机（host）和端口号（port）</p><p>跨域问题：浏览器的同源策略限制。会报错。</p><p>如果跨域调用，会出现如下错误：</p><blockquote><p>No &#39;Access-Control-Allow-Origin&#39; header is present on the requested resource. Origin &#39;http://localhost:9100&#39; is therefore not allowed access. The response had HTTP status code 400.</p></blockquote><p>由于我们采用的是前后端分离的编程方式，前端和后端必定存在跨域问题。解决跨域问题可以采用CORS</p><h3 id="_1-2-cors简介" tabindex="-1"><a class="header-anchor" href="#_1-2-cors简介"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_1-2-cors%E7%AE%80%E4%BB%8B" target="_blank" rel="noopener noreferrer">#</a>1.2 CORS简介</span></a></h3><p>CORS:跨域资源共享</p><p>条件：IE10以上</p><p>本质：请求头增加一个参数，开启跨域请求。</p><p>CORS 是一个 W3C 标准，全称是&quot;跨域资源共享&quot;（Cross-origin resource sharing）。CORS需要浏览器和服务器同时支持。目前，所有浏览器都支持该功能，IE 浏览器不能低于 IE10。它允许浏览器向跨源服务器，发出 XMLHttpRequest 请求，从而克服了 AJAX 只能同源使用的限制。整个 CORS 通信过程，都是浏览器自动完成，不需要用户参与。对于开发者来说，CORS 通信与同源的 AJAX 通信没有差别，代码完全一样。浏览器一旦发现 AJAX 请求跨源，就会自动添加一些附加的头信息，有时还会多出一次附加的请求，但用户不会有感觉。因此，实现 CORS 通信的关键是服务器。只要服务器实现了 CORS 接口，就可以跨源通信。</p><p>请求过程如下图:</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211012160627209.d53aaa3d.png" alt="image-20211012160627209"></p><p>Preflight Request：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/2-6.1acd3a28.png" alt="img"></p><p>然后服务器端给我们返回一个PreflightResponse</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/2-7.0991966f.png" alt="img"></p><p><strong>我们怎么做</strong>：那么具体如何实现呢？springMVC的版本在4.2或以上版本，可以使用注解实现跨域。 我们只需要在Controller类上添加注解<code>@CrossOrigin</code>就可以了。</p><h2 id="_2-导入基础架构项目-了解" tabindex="-1"><a class="header-anchor" href="#_2-导入基础架构项目-了解"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-%E5%AF%BC%E5%85%A5%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84%E9%A1%B9%E7%9B%AE-%E4%BA%86%E8%A7%A3" target="_blank" rel="noopener noreferrer">#</a>2. 导入基础架构项目（了解）</span></a></h2><p>需求：刚进一家新公司，你会拿到是代码呢？几十个人写了几年。</p><p>解压项目基础架构包 即可。</p><p>使用idea打开，观察项目架构。</p><h3 id="_2-1-导入项目" tabindex="-1"><a class="header-anchor" href="#_2-1-导入项目"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-1-%E5%AF%BC%E5%85%A5%E9%A1%B9%E7%9B%AE" target="_blank" rel="noopener noreferrer">#</a>2.1 导入项目</span></a></h3><p>在<code>idea</code>下点击<code>file</code>菜单中的<code>open</code>项, 找到ydles_parent位置打开</p><h2 id="_3-规格参数与分类管理-后台-重点" tabindex="-1"><a class="header-anchor" href="#_3-规格参数与分类管理-后台-重点"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-%E8%A7%84%E6%A0%BC%E5%8F%82%E6%95%B0%E4%B8%8E%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86-%E5%90%8E%E5%8F%B0-%E9%87%8D%E7%82%B9" target="_blank" rel="noopener noreferrer">#</a>3.规格参数与分类管理（后台）-重点</span></a></h2><p>我们本小节只需同学们理解管理后台规格参数与分类管理的需求和表结构的设计，没有代码实现，因为管理后台所需的代码在基础工程中已经帮我们生成了，无需自己编写。</p><p>打开day01静态页面-后台首页。查看商品-规格参数。</p><p>分类：分类 衣物---》裙子---》连衣裙、百褶裙、婚纱</p><p>模板：裙子模板------》大小：s m l 裙子颜色：黑色、红色 胸围：100 腰围：100 臀围：100</p><p>手机模板----》手机颜色：黑色、红色 内存：4G 6G 存储：128G 256G</p><p>参数：量变 胸围：110 腰围：100 臀围：100 内存：4G 6G 存储：128G 256G</p><p>规格：质变 大小：s m l 手机颜色：黑色、红色</p><p>分类：手机 电脑 电视</p><p>品牌：华为 小米 苹果</p><p>表：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211012173736017.9c51f123.png" alt="image-20211012173736017"></p><h3 id="_3-1-规格参数管理" tabindex="-1"><a class="header-anchor" href="#_3-1-规格参数管理"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-1-%E8%A7%84%E6%A0%BC%E5%8F%82%E6%95%B0%E7%AE%A1%E7%90%86" target="_blank" rel="noopener noreferrer">#</a>3.1 规格参数管理</span></a></h3><h4 id="_3-1-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_3-1-1-需求分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-1-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>3.1.1 需求分析</span></a></h4><p>规格参数模板是用于管理规格参数的单元。</p><p>前端交互方式见管理后台的静态原型</p><h4 id="_3-1-2-表结构分析" tabindex="-1"><a class="header-anchor" href="#_3-1-2-表结构分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-1-2-%E8%A1%A8%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>3.1.2 表结构分析</span></a></h4><p>规格参数模板相关的表有3个</p><p>tb_template表（模板表）</p><table><thead><tr><th>字段名称</th><th>字段含义</th><th>字段类型</th><th>字段长度</th><th>备注</th></tr></thead><tbody><tr><td>id</td><td>ID</td><td>INT</td><td></td><td></td></tr><tr><td>name</td><td>模板名称</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>spec_num</td><td>规格数量</td><td>INT</td><td></td><td></td></tr><tr><td>para_num</td><td>参数数量</td><td>INT</td><td></td><td></td></tr></tbody></table><p>tb_spec表（规格表）</p><table><thead><tr><th>字段名称</th><th>字段含义</th><th>字段类型</th><th>字段长度</th><th>备注</th></tr></thead><tbody><tr><td>id</td><td>ID</td><td>INT</td><td></td><td></td></tr><tr><td>name</td><td>名称</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>options</td><td>规格选项</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>seq</td><td>排序</td><td>INT</td><td></td><td></td></tr><tr><td>template_id</td><td>模板ID</td><td>INT</td><td></td><td></td></tr></tbody></table><p>tb_para表（参数表）</p><table><thead><tr><th>字段名称</th><th>字段含义</th><th>字段类型</th><th>字段长度</th><th>备注</th></tr></thead><tbody><tr><td>id</td><td>id</td><td>INT</td><td></td><td></td></tr><tr><td>name</td><td>名称</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>options</td><td>选项</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>seq</td><td>排序</td><td>INT</td><td></td><td></td></tr><tr><td>template_id</td><td>模板ID</td><td>INT</td><td></td><td></td></tr></tbody></table><p>模板与规格是一对多关系 ，模板与参数是一对多关系</p><h3 id="_3-2-分类管理" tabindex="-1"><a class="header-anchor" href="#_3-2-分类管理"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-2-%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86" target="_blank" rel="noopener noreferrer">#</a>3.2 分类管理</span></a></h3><h4 id="_3-2-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_3-2-1-需求分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-2-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>3.2.1 需求分析</span></a></h4><p>商品分类一共分三级管理，主要作用是在网站首页中显示商品导航，以及在管理后台管理商品时使用。</p><h4 id="_3-2-2-表结构分析" tabindex="-1"><a class="header-anchor" href="#_3-2-2-表结构分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-2-2-%E8%A1%A8%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>3.2.2 表结构分析</span></a></h4><p>tb_category 表 （<strong>商品分类</strong>）</p><table><thead><tr><th>字段名称</th><th>字段含义</th><th>字段类型</th><th>字段长度</th><th>备注</th></tr></thead><tbody><tr><td>id</td><td>分类ID</td><td>INT</td><td></td><td></td></tr><tr><td>name</td><td>分类名称</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>goods_num</td><td>商品数量</td><td>INT</td><td></td><td></td></tr><tr><td>is_show</td><td>是否显示</td><td>CHAR</td><td></td><td>0 不显示 1显示</td></tr><tr><td>is_menu</td><td>是否导航</td><td>CHAR</td><td></td><td>0 不时导航 1 为导航</td></tr><tr><td>seq</td><td>排序</td><td>INT</td><td></td><td></td></tr><tr><td>parent_id</td><td>上级ID</td><td>INT</td><td></td><td></td></tr><tr><td>template_id</td><td>模板ID</td><td>INT</td><td></td><td></td></tr></tbody></table><p>商品分类与模板是多对一关系</p><h2 id="_4-通用mapper自定义方法-重点掌握" tabindex="-1"><a class="header-anchor" href="#_4-通用mapper自定义方法-重点掌握"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_4-%E9%80%9A%E7%94%A8mapper%E8%87%AA%E5%AE%9A%E4%B9%89%E6%96%B9%E6%B3%95-%E9%87%8D%E7%82%B9%E6%8E%8C%E6%8F%A1" target="_blank" rel="noopener noreferrer">#</a>4.通用mapper自定义方法-重点掌握</span></a></h2><h3 id="_4-1-根据商品分类名称查询品牌列表" tabindex="-1"><a class="header-anchor" href="#_4-1-根据商品分类名称查询品牌列表"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_4-1-%E6%A0%B9%E6%8D%AE%E5%95%86%E5%93%81%E5%88%86%E7%B1%BB%E5%90%8D%E7%A7%B0%E6%9F%A5%E8%AF%A2%E5%93%81%E7%89%8C%E5%88%97%E8%A1%A8" target="_blank" rel="noopener noreferrer">#</a>4.1 根据商品分类名称查询品牌列表</span></a></h3><p>需求：根据商品分类名称查询品牌列表</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">http://localhost:9001/brand/category/女士包袋</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><h4 id="_4-1-1-表结构分析" tabindex="-1"><a class="header-anchor" href="#_4-1-1-表结构分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_4-1-1-%E8%A1%A8%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>4.1.1 表结构分析</span></a></h4><p>基于上述的讲解已知分类与品牌之间的关系属于多对多关系，这里通过tb_category_brand表来建立关联关系。</p><p>分类-品牌中间表</p><table><thead><tr><th>列名</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td>category_id</td><td>int(11)</td><td>分类ID</td></tr><tr><td>brand_id</td><td>int(11)</td><td>品牌ID</td></tr></tbody></table><h4 id="_4-1-2-代码实现" tabindex="-1"><a class="header-anchor" href="#_4-1-2-代码实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_4-1-2-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>4.1.2 代码实现</span></a></h4><p>写出sql</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">SELECT</span> NAME<span class="token punctuation">,</span>image <span class="token keyword">FROM</span> tb_brand <span class="token keyword">WHERE</span> id <span class="token operator">IN</span> <span class="token punctuation">(</span> <span class="token keyword">SELECT</span> brand_id <span class="token keyword">FROM</span> tb_category_brand <span class="token keyword">WHERE</span> category_id <span class="token operator">IN</span> <span class="token punctuation">(</span> <span class="token keyword">SELECT</span> id <span class="token keyword">FROM</span> tb_category <span class="token keyword">WHERE</span> NAME <span class="token operator">=</span> <span class="token string">&#39;女士包袋&#39;</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>（1）修改BrandMapper，新增方法定义</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 根据分类名称查询品牌列表</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">categoryName</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT name,img FROM tb_brand WHERE id  IN (SELECT brand_id FROM tb_category_brand WHERE  category_id IN (SELECT id FROM tb_category WHERE NAME=#{name}) )order by seq&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&gt;</span></span> <span class="token function">findListByCategoryName</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> categoryName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><p>（2）修改BrandService，新增方法定义</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line">     * 根据商品分类名称查询品牌列表</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">categoryName</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&gt;</span></span> <span class="token function">findListByCategoryName</span><span class="token punctuation">(</span><span class="token class-name">String</span> categoryName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6</p><p>（3）BrandServiceImpl实现方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&gt;</span></span> <span class="token function">findListByCategoryName</span><span class="token punctuation">(</span><span class="token class-name">String</span> categoryName<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> brandMapper<span class="token punctuation">.</span><span class="token function">findListByCategoryName</span><span class="token punctuation">(</span>categoryName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p>（4）BrandController新增方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 根据分类名称查询品牌列表</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token parameter">category</span></span>
<span class="line"> * <span class="token keyword">@return</span></span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/category/{category}&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Result</span>  <span class="token function">findListByCategoryName</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> category<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>category<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&gt;</span></span> brandList <span class="token operator">=</span> brandService<span class="token punctuation">.</span><span class="token function">findListByCategoryName</span><span class="token punctuation">(</span>category<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span><span class="token string">&quot;查询成功&quot;</span><span class="token punctuation">,</span>brandList<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试： http://localhost:9001/brand/category/女士包袋</p><h3 id="_4-2-根据商品分类名称查询规格列表" tabindex="-1"><a class="header-anchor" href="#_4-2-根据商品分类名称查询规格列表"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_4-2-%E6%A0%B9%E6%8D%AE%E5%95%86%E5%93%81%E5%88%86%E7%B1%BB%E5%90%8D%E7%A7%B0%E6%9F%A5%E8%AF%A2%E8%A7%84%E6%A0%BC%E5%88%97%E8%A1%A8" target="_blank" rel="noopener noreferrer">#</a>4.2 根据商品分类名称查询规格列表</span></a></h3><p>http://localhost:9001/spec/category/女士包袋</p><h4 id="_4-2-1-表结构分析" tabindex="-1"><a class="header-anchor" href="#_4-2-1-表结构分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_4-2-1-%E8%A1%A8%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>4.2.1 表结构分析</span></a></h4><p>我们这里会用到规格表、模板表、分类表 <strong>注意：以下表结构已省略无关字段</strong></p><p>tb_template 表（模板表）</p><table><thead><tr><th>字段名称</th><th>字段含义</th><th>字段类型</th><th>字段长度</th><th>备注</th></tr></thead><tbody><tr><td>id</td><td>ID</td><td>INT</td><td></td><td></td></tr><tr><td>name</td><td>模板名称</td><td>VARCHAR</td><td></td><td></td></tr></tbody></table><p>tb_spec 表（ 规格表）</p><table><thead><tr><th>字段名称</th><th>字段含义</th><th>字段类型</th><th>字段长度</th><th>备注</th></tr></thead><tbody><tr><td>id</td><td>ID</td><td>INT</td><td></td><td></td></tr><tr><td>name</td><td>名称</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>options</td><td>规格选项</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>seq</td><td>排序</td><td>INT</td><td></td><td></td></tr><tr><td>template_id</td><td>模板ID</td><td>INT</td><td></td><td></td></tr></tbody></table><p>tb_category 表 （商品分类）</p><table><thead><tr><th>字段名称</th><th>字段含义</th><th>字段类型</th><th>字段长度</th><th>备注</th></tr></thead><tbody><tr><td>id</td><td>分类ID</td><td>INT</td><td></td><td></td></tr><tr><td>name</td><td>分类名称</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>parent_id</td><td>上级ID</td><td>INT</td><td></td><td></td></tr><tr><td>template_id</td><td>模板ID</td><td>INT</td><td></td><td></td></tr></tbody></table><h4 id="_4-2-2-代码实现" tabindex="-1"><a class="header-anchor" href="#_4-2-2-代码实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_4-2-2-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>4.2.2 代码实现</span></a></h4><p><strong>sql</strong>:</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">select</span> name<span class="token punctuation">,</span>options <span class="token keyword">from</span> tb_spec <span class="token keyword">where</span> template_id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> template_id <span class="token keyword">from</span> tb_category <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">&#39;女士包袋&#39;</span><span class="token punctuation">)</span> <span class="token keyword">order</span> <span class="token keyword">by</span> seq</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>（1）SpecMapper新增方法定义</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"> <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT name,options FROM tb_spec WHERE template_id IN ( SELECT template_id FROM tb_category WHERE NAME=#{categoryName}) order by seq&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&gt;</span></span> <span class="token function">findListByCategoryName</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;categoryName&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> categoryName<span class="token punctuation">)</span><span class="token punctuation">;</span>  </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><p>（2）SpecService新增方法定义</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line">     * 根据商品分类名称查询规格列表</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">categoryName</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&gt;</span></span> <span class="token function">findListByCategoryName</span><span class="token punctuation">(</span><span class="token class-name">String</span> categoryName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6</p><p>（3）SpecServiceImpl实现方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&gt;</span></span> <span class="token function">findListByCategoryName</span><span class="token punctuation">(</span><span class="token class-name">String</span> categoryName<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&gt;</span></span> specList <span class="token operator">=</span> specMapper<span class="token punctuation">.</span><span class="token function">findListByCategoryName</span><span class="token punctuation">(</span>categoryName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Map</span> spec<span class="token operator">:</span>specList<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> options <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> spec<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;options&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//规格选项列表</span></span>
<span class="line">        spec<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;options&quot;</span><span class="token punctuation">,</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> specList<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9</p><p>（4）SpecController新增方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line">     * 根据商品分类名称查询规格列表</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">category</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/category/{category}&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">findListByCategoryName</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span>  <span class="token class-name">String</span> category<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&gt;</span></span> specList <span class="token operator">=</span> specService<span class="token punctuation">.</span><span class="token function">findListByCategoryName</span><span class="token punctuation">(</span>category<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>specList<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试： http://localhost:9001/spec/category/%E5%A5%B3%E5%A3%AB%E5%8C%85%E8%A2%8B</p><h2 id="_5-分布式文件存储-fastdfs" tabindex="-1"><a class="header-anchor" href="#_5-分布式文件存储-fastdfs"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_5-%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8-fastdfs" target="_blank" rel="noopener noreferrer">#</a>5. 分布式文件存储-FastDFS</span></a></h2><p>FastDFS:Fast distribite file system 有小有多的小文件</p><p>HDFS:hadoop distribite file system 大文件</p><h3 id="_5-1-fastdfs简介" tabindex="-1"><a class="header-anchor" href="#_5-1-fastdfs简介"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_5-1-fastdfs%E7%AE%80%E4%BB%8B" target="_blank" rel="noopener noreferrer">#</a>5.1 FastDFS简介</span></a></h3><h4 id="_5-1-1-fastdfs体系结构" tabindex="-1"><a class="header-anchor" href="#_5-1-1-fastdfs体系结构"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_5-1-1-fastdfs%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84" target="_blank" rel="noopener noreferrer">#</a>5.1.1 FastDFS体系结构</span></a></h4><p>FastDFS是一个开源的轻量级<a href="https://baike.baidu.com/item/%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/1250388" target="_blank" rel="noopener noreferrer">分布式文件系统open in new window</a>，它对文件进行管理，功能包括：文件存储、文件同步、文件访问（文件上传、文件下载）等，解决了大容量存储和负载均衡的问题。特别适合以文件为载体的在线服务，如相册网站、视频网站等等。</p><p><strong>作者</strong>：阿里 P8 200w年薪 余庆大神</p><p>FastDFS为互联网量身定制，充分考虑了冗余备份、负载均衡、线性扩容等机制，并注重高可用、高性能等指标，使用FastDFS很容易搭建一套高性能的文件服务器集群提供文件上传、下载等服务。</p><p>FastDFS 架构包括 Tracker server 和 Storage server。客户端请求 Tracker server 进行文件上传、下载，通过Tracker server 调度最终由 Storage server 完成文件上传和下载。</p><p>Tracker server 作用是负载均衡和调度，通过 Tracker server 在文件上传时可以根据一些策略找到Storage server 提供文件上传服务。可以将 tracker 称为追踪服务器或调度服务器。Storage server 作用是文件存储，客户端上传的文件最终存储在 Storage 服务器上，Storageserver 没有实现自己的文件系统而是利用操作系统的文件系统来管理文件。可以将storage称为存储服务器。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/1559117928459.b872dd99.png" alt="1559117928459"></p><p>tracker: 元数据信息，文件上传时间、地址、大小。</p><p>记录storage集群信息。</p><p>storage:存数据。</p><h4 id="_5-1-2-上传流程" tabindex="-1"><a class="header-anchor" href="#_5-1-2-上传流程"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_5-1-2-%E4%B8%8A%E4%BC%A0%E6%B5%81%E7%A8%8B" target="_blank" rel="noopener noreferrer">#</a>5.1.2 上传流程</span></a></h4><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211013013254634.da427543.png" alt="image-20211013013254634"></p><p>客户端上传文件后存储服务器将文件 ID 返回给客户端，此文件 ID 用于以后访问该文件的索引信息。文件索引信息包括：组名，虚拟磁盘路径，数据两级目录，文件名。</p><p><strong>fileId</strong>: group1/M00/00/00/asdfsadfsadfsadfsadfsadfsa.png</p><p><strong>组名</strong>：文件上传后所在的 storage 组名称，在文件上传成功后有storage 服务器返回，需要客户端自行保存。</p><p><strong>虚拟磁盘路径</strong>：storage 配置的虚拟路径，与磁盘选项store_path对应。如果配置了</p><p>/data/00-ff/00-ff/-----&gt;/M00</p><p>/data2----&gt;/M01</p><p><strong>数据两级目录</strong>：storage 服务器在每个虚拟磁盘路径下创建的两级目录，用于存储数据</p><p>文件。</p><p><strong>文件名</strong>：与文件上传时不同。是由存储服务器根据特定信息生成，文件名包含：源存储</p><p>服务器 IP 地址、文件创建时间戳、文件大小、随机数和文件拓展名等信息。</p><h3 id="_5-2-fastdfs搭建-了解" tabindex="-1"><a class="header-anchor" href="#_5-2-fastdfs搭建-了解"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_5-2-fastdfs%E6%90%AD%E5%BB%BA-%E4%BA%86%E8%A7%A3" target="_blank" rel="noopener noreferrer">#</a>5.2 FastDFS搭建-了解</span></a></h3><p>已经在虚拟机中搭建完毕。</p><p>我们使用Docker搭建FastDFS的开发环境</p><p>拉取镜像</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">docker pull morunchang/fastdfs</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>运行tracker</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">docker run -d --name tracker --net=host morunchang/fastdfs sh tracker.sh</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>运行storage</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">docker run -d --name storage --net=host -e TRACKER_IP=&lt;your tracker server address&gt;:22122 -e GROUP_NAME=&lt;group name&gt; morunchang/fastdfs sh storage.sh</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><ul><li>使用的网络模式是–net=host, 替换为你机器的Ip即可</li><li>是组名，即storage的组</li><li>如果想要增加新的storage服务器，再次运行该命令，注意更换 新组名</li></ul><p>（4）修改nginx的配置</p><p>进入storage的容器内部，修改nginx.conf</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">docker exec -it storage  /bin/bash</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>进入后</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">vi /data/nginx/conf/nginx.conf</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>添加以下内容</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">location /group1/M00 {</span>
<span class="line">   proxy_next_upstream http_502 http_504 error timeout invalid_header;</span>
<span class="line">     proxy_cache http-cache;</span>
<span class="line">     proxy_cache_valid  200 304 12h;</span>
<span class="line">     proxy_cache_key $uri$is_args$args;</span>
<span class="line">     proxy_pass http://fdfs_group1;</span>
<span class="line">     expires 30d;</span>
<span class="line"> }</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（5）退出容器</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">exit</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>（6）重启storage容器</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">docker restart storage</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_5-3-文件存储微服务" tabindex="-1"><a class="header-anchor" href="#_5-3-文件存储微服务"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_5-3-%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8%E5%BE%AE%E6%9C%8D%E5%8A%A1" target="_blank" rel="noopener noreferrer">#</a>5.3 文件存储微服务</span></a></h3><p>创建文件管理微服务ydles_service_file，该工程主要用于实现文件上传以及文件删除等功能。</p><p>（1）修改pom.xml，引入依赖</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>net.oschina.zcx7878<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastdfs-client-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.27.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ydles<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>ydles_common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）在resources文件夹下创建fasfDFS的配置文件<strong>fdfs_client.conf</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">connect_timeout = 60</span>
<span class="line">network_timeout = 60</span>
<span class="line">charset = UTF-8</span>
<span class="line">http.tracker_http_port = 8080</span>
<span class="line">tracker_server = 192.168.200.128:22122</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p>connect_timeout：连接超时时间，单位为秒。</p><p>network_timeout：通信超时时间，单位为秒。发送或接收数据时。假设在超时时间后还不能发送或接收数据，则本次网络通信失败</p><p>charset： 字符集</p><p>http.tracker_http_port ：.tracker的http端口</p><p>tracker_server： tracker服务器IP和端口设置</p><p>（3）在resources文件夹下创建application.yml</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">spring</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">servlet</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">multipart</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">max-file-size</span><span class="token punctuation">:</span> 10MB</span>
<span class="line">      <span class="token key atrule">max-request-size</span><span class="token punctuation">:</span> 10MB</span>
<span class="line"><span class="token key atrule">server</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9008</span></span>
<span class="line"><span class="token key atrule">eureka</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">client</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">service-url</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>6868/eureka</span>
<span class="line">  <span class="token key atrule">instance</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line"><span class="token key atrule">feign</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">hystrix</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>max-file-size是单个文件大小，max-request-size是设置总上传的数据大小</p><p>（4）创建com.ydles.file包，创建启动类FileApplication</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@SpringBootApplication</span></span>
<span class="line"><span class="token annotation punctuation">@EnableEurekaClient</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileApplication</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">FileApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8</p><h3 id="_5-4-文件上传-重点" tabindex="-1"><a class="header-anchor" href="#_5-4-文件上传-重点"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_5-4-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0-%E9%87%8D%E7%82%B9" target="_blank" rel="noopener noreferrer">#</a>5.4 文件上传-重点</span></a></h3><h4 id="_5-4-1-文件信息封装" tabindex="-1"><a class="header-anchor" href="#_5-4-1-文件信息封装"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_5-4-1-%E6%96%87%E4%BB%B6%E4%BF%A1%E6%81%AF%E5%B0%81%E8%A3%85" target="_blank" rel="noopener noreferrer">#</a>5.4.1 文件信息封装</span></a></h4><p>文件上传一般都有文件的名字、文件的内容、文件的扩展名、文件的md5值、文件的作者等相关属性，我们可以创建一个对象封装这些属性，代码如下：</p><p><strong>FastDFSFile：文件实体类</strong></p><p><strong>FastDFSClient：文件工具类，封装底层方法。</strong></p><p><strong>FileController：接口</strong></p><p>创建com.ydles.file.pojo.FastDFSFile</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FastDFSFile</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//文件名字</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//文件内容</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> content<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//文件扩展名</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> ext<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//文件MD5摘要值</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> md5<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//文件创建作者</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> author<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">FastDFSFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> content<span class="token punctuation">,</span> <span class="token class-name">String</span> ext<span class="token punctuation">,</span> <span class="token class-name">String</span> height<span class="token punctuation">,</span></span>
<span class="line">                       <span class="token class-name">String</span> width<span class="token punctuation">,</span> <span class="token class-name">String</span> author<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>content <span class="token operator">=</span> content<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>ext <span class="token operator">=</span> ext<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>author <span class="token operator">=</span> author<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">FastDFSFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> content<span class="token punctuation">,</span> <span class="token class-name">String</span> ext<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>content <span class="token operator">=</span> content<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>ext <span class="token operator">=</span> ext<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// getter and setter ...</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-4-2-文件操作" tabindex="-1"><a class="header-anchor" href="#_5-4-2-文件操作"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_5-4-2-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C" target="_blank" rel="noopener noreferrer">#</a>5.4.2 文件操作</span></a></h4><p>创建FastDFSClient类,放在com.ydles.file.util下在该类中实现FastDFS信息获取以及文件的相关操作，</p><p>代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FastDFSClient</span> <span class="token punctuation">{</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span>Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">FastDFSClient</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/***</span>
<span class="line">     * 初始化加载FastDFS的TrackerServer配置</span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">static</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">String</span> filePath <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">&quot;fdfs_client.conf&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">ClientGlobal</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;FastDFS Client Init Fail!&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/***</span>
<span class="line">     * 文件上传</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">file</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token class-name">FastDFSFile</span> file<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//获取文件的作者</span></span>
<span class="line">        <span class="token class-name">NameValuePair</span><span class="token punctuation">[</span><span class="token punctuation">]</span> meta_list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NameValuePair</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        meta_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NameValuePair</span><span class="token punctuation">(</span><span class="token string">&quot;author&quot;</span><span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">getAuthor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//接收返回数据</span></span>
<span class="line">        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> uploadResults <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">StorageClient</span> storageClient<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//创建StorageClient客户端对象</span></span>
<span class="line">            storageClient <span class="token operator">=</span> <span class="token function">getTrackerClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token doc-comment comment">/***</span>
<span class="line">             * 文件上传</span>
<span class="line">             * 1)文件字节数组</span>
<span class="line">             * 2)文件扩展名</span>
<span class="line">             * 3)文件作者</span>
<span class="line">             */</span></span>
<span class="line">            uploadResults <span class="token operator">=</span> storageClient<span class="token punctuation">.</span><span class="token function">upload_file</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">getExt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> meta_list<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Exception when uploadind the file:&quot;</span> <span class="token operator">+</span> file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>uploadResults <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> storageClient<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;upload file fail, error code:&quot;</span> <span class="token operator">+</span> storageClient<span class="token punctuation">.</span><span class="token function">getErrorCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token comment">//获取组名</span></span>
<span class="line">        <span class="token class-name">String</span> groupName <span class="token operator">=</span> uploadResults<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//获取文件存储路径</span></span>
<span class="line">        <span class="token class-name">String</span> remoteFileName <span class="token operator">=</span> uploadResults<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> uploadResults<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/***</span>
<span class="line">     * 获取文件信息</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">groupName</span>:组名</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">remoteFileName</span>：文件存储完整名</span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">FileInfo</span> <span class="token function">getFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> groupName<span class="token punctuation">,</span> <span class="token class-name">String</span> remoteFileName<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">StorageClient</span> storageClient <span class="token operator">=</span> <span class="token function">getTrackerClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> storageClient<span class="token punctuation">.</span><span class="token function">get_file_info</span><span class="token punctuation">(</span>groupName<span class="token punctuation">,</span> remoteFileName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Exception: Get File from Fast DFS failed&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/***</span>
<span class="line">     * 文件下载</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">groupName</span></span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">remoteFileName</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">InputStream</span> <span class="token function">downFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> groupName<span class="token punctuation">,</span> <span class="token class-name">String</span> remoteFileName<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//创建StorageClient</span></span>
<span class="line">            <span class="token class-name">StorageClient</span> storageClient <span class="token operator">=</span> <span class="token function">getTrackerClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">//下载文件</span></span>
<span class="line">            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fileByte <span class="token operator">=</span> storageClient<span class="token punctuation">.</span><span class="token function">download_file</span><span class="token punctuation">(</span>groupName<span class="token punctuation">,</span> remoteFileName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">InputStream</span> ins <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>fileByte<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> ins<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Exception: Get File from Fast DFS failed&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/***</span>
<span class="line">     * 文件删除</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">groupName</span></span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">remoteFileName</span></span>
<span class="line">     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">deleteFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> groupName<span class="token punctuation">,</span> <span class="token class-name">String</span> remoteFileName<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//创建StorageClient</span></span>
<span class="line">        <span class="token class-name">StorageClient</span> storageClient <span class="token operator">=</span> <span class="token function">getTrackerClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//删除文件</span></span>
<span class="line">        <span class="token keyword">int</span> i <span class="token operator">=</span> storageClient<span class="token punctuation">.</span><span class="token function">delete_file</span><span class="token punctuation">(</span>groupName<span class="token punctuation">,</span> remoteFileName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/***</span>
<span class="line">     * 获取Storage组</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">groupName</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">IOException</span></span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">StorageServer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getStoreStorages</span><span class="token punctuation">(</span><span class="token class-name">String</span> groupName<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//创建TrackerClient</span></span>
<span class="line">        <span class="token class-name">TrackerClient</span> trackerClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TrackerClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//获取TrackerServer</span></span>
<span class="line">        <span class="token class-name">TrackerServer</span> trackerServer <span class="token operator">=</span> trackerClient<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//获取Storage组</span></span>
<span class="line">        <span class="token keyword">return</span> trackerClient<span class="token punctuation">.</span><span class="token function">getStoreStorages</span><span class="token punctuation">(</span>trackerServer<span class="token punctuation">,</span> groupName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/***</span>
<span class="line">     * 获取Storage信息,IP和端口</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">groupName</span></span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">remoteFileName</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">IOException</span></span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ServerInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getFetchStorages</span><span class="token punctuation">(</span><span class="token class-name">String</span> groupName<span class="token punctuation">,</span></span>
<span class="line">                                                <span class="token class-name">String</span> remoteFileName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">TrackerClient</span> trackerClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TrackerClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">TrackerServer</span> trackerServer <span class="token operator">=</span> trackerClient<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> trackerClient<span class="token punctuation">.</span><span class="token function">getFetchStorages</span><span class="token punctuation">(</span>trackerServer<span class="token punctuation">,</span> groupName<span class="token punctuation">,</span> remoteFileName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/***</span>
<span class="line">     * 获取Tracker服务地址</span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">IOException</span></span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getTrackerUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">&quot;http://&quot;</span><span class="token operator">+</span><span class="token function">getTrackerServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInetSocketAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHostString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;:&quot;</span><span class="token operator">+</span><span class="token class-name">ClientGlobal</span><span class="token punctuation">.</span><span class="token function">getG_tracker_http_port</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/***</span>
<span class="line">     * 获取Storage客户端</span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">IOException</span></span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">StorageClient</span> <span class="token function">getTrackerClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">TrackerServer</span> trackerServer <span class="token operator">=</span> <span class="token function">getTrackerServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">StorageClient</span> storageClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StorageClient</span><span class="token punctuation">(</span>trackerServer<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span>  storageClient<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/***</span>
<span class="line">     * 获取Tracker</span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">IOException</span></span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">TrackerServer</span> <span class="token function">getTrackerServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">TrackerClient</span> trackerClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TrackerClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">TrackerServer</span> trackerServer <span class="token operator">=</span> trackerClient<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span>  trackerServer<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-4-3-文件上传" tabindex="-1"><a class="header-anchor" href="#_5-4-3-文件上传"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_5-4-3-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0" target="_blank" rel="noopener noreferrer">#</a>5.4.3 文件上传</span></a></h4><p>创建一个FileController，在该控制器中实现文件上传操作，代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@RestController</span></span>
<span class="line"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/file&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileController</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/upload&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">uploadFile</span><span class="token punctuation">(</span><span class="token class-name">MultipartFile</span> file<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//判断文件是否存在</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;文件不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token comment">//获取文件的完整名称</span></span>
<span class="line">            <span class="token class-name">String</span> originalFilename <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getOriginalFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>originalFilename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;文件不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">//获取文件的扩展名称  abc.jpg   jpg</span></span>
<span class="line">            <span class="token class-name">String</span> extName <span class="token operator">=</span> originalFilename<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>originalFilename<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">//获取文件内容</span></span>
<span class="line">            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> content <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">//创建文件上传的封装实体类</span></span>
<span class="line">            <span class="token class-name">FastDFSFile</span> fastDFSFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FastDFSFile</span><span class="token punctuation">(</span>originalFilename<span class="token punctuation">,</span>content<span class="token punctuation">,</span>extName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">//基于工具类进行文件上传,并接受返回参数  String[]</span></span>
<span class="line">            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> uploadResult <span class="token operator">=</span> <span class="token class-name">FastDFSClient</span><span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span>fastDFSFile<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">//封装返回结果</span></span>
<span class="line">            <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token class-name">FastDFSClient</span><span class="token punctuation">.</span><span class="token function">getTrackerUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>uploadResult<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">&quot;/&quot;</span><span class="token operator">+</span>uploadResult<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span><span class="token string">&quot;文件上传成功&quot;</span><span class="token punctuation">,</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">ERROR</span><span class="token punctuation">,</span><span class="token string">&quot;文件上传失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-5-postman测试文件上传" tabindex="-1"><a class="header-anchor" href="#_5-5-postman测试文件上传"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_5-5-postman%E6%B5%8B%E8%AF%95%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0" target="_blank" rel="noopener noreferrer">#</a>5.5 Postman测试文件上传</span></a></h3><p>步骤：</p><p>1、选择post请求方式，输入请求地址 http://localhost:9008/upload 2、填写Headers</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">Key：Content-Type </span>
<span class="line">Value：multipart/form-data</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20200406180731441.a2267e13.png" alt="image-20200406180731441"></p><p>3、填写body 选择form-data 然后选择文件file 点击添加文件，最后发送即可。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20200406180804793.d63a8a7f.png" alt="image-20200406180804793"></p><p>总结：</p><p>1跨域-面试</p><p>什么是跨域：由于浏览器的同源策略，导致不能向其他域发送异步请求。</p><p>什么是同源策略：协议，域名，端口号</p><p>CORS @CrossOrigin</p><p>2回看其他同事写的代码</p><p>3规格参数模板分类品牌 关系</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211012173736017.9c51f123.png" alt="image-20211012173736017"></p><p>4自定义mapper</p><p>复杂sql需求，自定义mapper方法 sql书写</p><p>5fastDFS</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211013013254634.da427543.png" alt="image-20211013013254634"></p><p>上传写完</p><p>作业：删除 下载图片 fileID</p><h2 id="第3章-微服务网关限流-鉴权" tabindex="-1"><a class="header-anchor" href="#第3章-微服务网关限流-鉴权"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#%E7%AC%AC3%E7%AB%A0-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3%E9%99%90%E6%B5%81-%E9%89%B4%E6%9D%83" target="_blank" rel="noopener noreferrer">#</a>第3章 微服务网关限流&amp;鉴权</span></a></h2><p><strong>角色</strong>：网关组一员。</p><h2 id="课程目标" tabindex="-1"><a class="header-anchor" href="#课程目标"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#%E8%AF%BE%E7%A8%8B%E7%9B%AE%E6%A0%87" target="_blank" rel="noopener noreferrer">#</a>课程目标</span></a></h2><ul><li>掌握微服务网关Gateway的系统搭建。</li><li>掌握网关限流的实现</li><li>能够使用BCrypt实现对密码的加密与验证</li><li>了解加密算法</li><li>能够使用JWT实现微服务鉴权</li></ul><h2 id="_1-微服务网关gateway-过滤-路由" tabindex="-1"><a class="header-anchor" href="#_1-微服务网关gateway-过滤-路由"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_1-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3gateway-%E8%BF%87%E6%BB%A4-%E8%B7%AF%E7%94%B1" target="_blank" rel="noopener noreferrer">#</a>1.微服务网关Gateway 过滤+路由</span></a></h2><h3 id="_1-1-微服务网关概述-面试" tabindex="-1"><a class="header-anchor" href="#_1-1-微服务网关概述-面试"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_1-1-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3%E6%A6%82%E8%BF%B0-%E9%9D%A2%E8%AF%95" target="_blank" rel="noopener noreferrer">#</a>1.1 微服务网关概述-面试</span></a></h3><p>不同的微服务一般会有不同的网络地址，而外部客户端可能需要调用多个服务的接口才能完成一个业务需求，如果让客户端直接与各个微服务通信，会有以下的问题：</p><ul><li>客户端会多次请求不同的微服务，增加了客户端的复杂性</li><li>存在跨域请求，在一定场景下处理相对复杂</li><li>认证复杂，每个服务都需要独立认证</li><li>难以重构，随着项目的迭代，可能需要重新划分微服务。例如，可能将多个服务合并成一个或者将一个服务拆分成多个。如果客户端直接与微服务通信，那么重构将会很难实施</li></ul><p>以上这些问题可以借助网关解决。</p><p>网关是介于客户端和服务器端之间的中间层，所有的外部请求都会先经过 网关这一层。也就是说，API 的实现方面更多的考虑业务逻辑，而安全、性能、监控可以交由 网关来做，这样既提高业务灵活性又不缺安全性，典型的架构图如图所示：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211016171713891.b8806f17.png" alt="image-20211016171713891"></p><p>画图</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211016171720573.d639eed8.png" alt="image-20211016171720573"></p><p>优点如下：</p><ul><li>安全 ，只有网关系统对外进行暴露，微服务可以隐藏在内网，通过防火墙保护。</li><li>易于监控。可以在网关收集监控数据并将其推送到外部系统进行分析。</li><li>易于统一认证授权。可以在网关上进行认证，然后再将请求转发到后端的微服务，而无须在每个微服务中进行认证。</li><li>减少了客户端与各个微服务之间的交互次数</li></ul><p>总结：微服务网关就是一个系统，通过暴露该微服务网关系统，方便我们进行相关的鉴权，安全控制，日志统一处理，易于监控的相关功能。</p><p>实现微服务网关的技术有很多，</p><ul><li><strong>nginx</strong> Nginx (engine x) 是一个高性能的<a href="https://baike.baidu.com/item/HTTP" target="_blank" rel="noopener noreferrer">HTTPopen in new window</a>和<a href="https://baike.baidu.com/item/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/7793488" target="_blank" rel="noopener noreferrer">反向代理open in new window</a>web服务器，同时也提供了IMAP/POP3/SMTP服务</li><li><strong>zuul</strong> ,Zuul 是 Netflix 出品的一个基于 JVM 路由和服务端的负载均衡器。 不维护了，弃用。</li><li><strong>spring-cloud-gateway</strong>, 是spring 出品的 基于spring 的网关项目，集成断路器，路径重写，性能比Zuul好。</li></ul><p>我们使用gateway这个网关技术，无缝衔接到基于spring cloud的微服务开发中来。</p><p>gateway官网：</p><p>https://spring.io/projects/spring-cloud-gateway</p><h3 id="_1-2-微服务网关微服务搭建" tabindex="-1"><a class="header-anchor" href="#_1-2-微服务网关微服务搭建"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_1-2-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BA" target="_blank" rel="noopener noreferrer">#</a>1.2 微服务网关微服务搭建</span></a></h3><p>由于我们开发的系统 有包括前台系统和后台系统，后台的系统给管理员使用。那么也需要调用各种微服务，所以我们针对管理后台搭建一个网关微服务。分析如下：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211017093610888.7d484295.png" alt="image-20211017093610888"></p><p><strong>搭建步骤：</strong></p><p>创建项目 ydles_gateway_system</p><p>1依赖。二级父工程导入了，所以也可以不导。</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-hystrix<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12</p><p>2启动类：com.ydles.system.GatewayApplication</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@SpringBootApplication</span></span>
<span class="line"><span class="token annotation punctuation">@EnableEurekaClient</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GatewayApplication</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    	<span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">GatewayApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7</p><p>3配置文件：application.yml</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">spring</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">application</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> sysgateway</span>
<span class="line">  <span class="token key atrule">cloud</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">gateway</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">routes</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> goods</span>
<span class="line">        <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//goods</span>
<span class="line">        <span class="token key atrule">predicates</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> Path=/goods/<span class="token important">**</span></span>
<span class="line">        <span class="token key atrule">filters</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> StripPrefix= 1</span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> system</span>
<span class="line">        <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//system</span>
<span class="line">        <span class="token key atrule">predicates</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> Path=/system/<span class="token important">**</span></span>
<span class="line">        <span class="token key atrule">filters</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> StripPrefix= 1</span>
<span class="line">  <span class="token key atrule">redis</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.200.128</span>
<span class="line"><span class="token key atrule">server</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9101</span></span>
<span class="line"><span class="token key atrule">eureka</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">client</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">service-url</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>6868/eureka</span>
<span class="line">  <span class="token key atrule">instance</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>参考官方手册：</p><p>https://cloud.spring.io/spring-cloud-gateway/spring-cloud-gateway.html#_stripprefix_gatewayfilter_factory</p><p>测试：</p><p>直接访问goods服务：http://localhost:9001/brand</p><p>通过网关访问：http://localhost:9101/goods/brand</p><p>localhost:9001/brand</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211017094741750.442a3c80.png" alt="image-20211017094741750"></p><p>路由功能：</p><p>1网关访问：<a href="http://localhost:9101/goods/brand/category/%E6%89%8B%E6%9C%BA" target="_blank" rel="noopener noreferrer">http://localhost:9101/goods/brand/category/手机open in new window</a></p><p>2uri: /goods/brand/category/女士包袋</p><p>3商品微服务：http://localhost:9001/brand/category/女士包袋</p><h3 id="_1-3-微服务网关跨域" tabindex="-1"><a class="header-anchor" href="#_1-3-微服务网关跨域"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_1-3-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3%E8%B7%A8%E5%9F%9F" target="_blank" rel="noopener noreferrer">#</a>1.3 微服务网关跨域</span></a></h3><p>修改application.yml ,在spring.cloud.gateway节点添加配置，</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line">  <span class="token key atrule">globalcors</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">cors-configurations</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">&#39;[/**]&#39;</span><span class="token punctuation">:</span> <span class="token comment"># 匹配所有请求</span></span>
<span class="line">        <span class="token key atrule">allowedOrigins</span><span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span> <span class="token comment">#跨域处理 允许所有的域</span></span>
<span class="line">        <span class="token key atrule">allowedMethods</span><span class="token punctuation">:</span> <span class="token comment"># 支持的方法</span></span>
<span class="line">          <span class="token punctuation">-</span> GET</span>
<span class="line">          <span class="token punctuation">-</span> POST</span>
<span class="line">          <span class="token punctuation">-</span> PUT</span>
<span class="line">          <span class="token punctuation">-</span> DELETE  </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9</p><p>最终配置文件如下：</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">spring</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">application</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> sysgateway</span>
<span class="line">  <span class="token key atrule">cloud</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">gateway</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">globalcors</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">cors-configurations</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">&#39;[/**]&#39;</span><span class="token punctuation">:</span> <span class="token comment"># 匹配所有请求</span></span>
<span class="line">            <span class="token key atrule">allowedOrigins</span><span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span> <span class="token comment">#跨域处理 允许所有的域</span></span>
<span class="line">            <span class="token key atrule">allowedMethods</span><span class="token punctuation">:</span> <span class="token comment"># 支持的方法</span></span>
<span class="line">            <span class="token punctuation">-</span> GET</span>
<span class="line">            <span class="token punctuation">-</span> POST</span>
<span class="line">            <span class="token punctuation">-</span> PUT</span>
<span class="line">            <span class="token punctuation">-</span> DELETE</span>
<span class="line">      <span class="token key atrule">routes</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> goods</span>
<span class="line">        <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//goods</span>
<span class="line">        <span class="token key atrule">predicates</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> Path=/goods/<span class="token important">**</span></span>
<span class="line">        <span class="token key atrule">filters</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> StripPrefix= 1</span>
<span class="line"><span class="token key atrule">server</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9101</span></span>
<span class="line"><span class="token key atrule">eureka</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">client</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">service-url</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>6868/eureka</span>
<span class="line">  <span class="token key atrule">instance</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-4-微服务网关过滤器" tabindex="-1"><a class="header-anchor" href="#_1-4-微服务网关过滤器"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_1-4-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3%E8%BF%87%E6%BB%A4%E5%99%A8" target="_blank" rel="noopener noreferrer">#</a>1.4 微服务网关过滤器</span></a></h3><p>我们可以通过网关过滤器，实现一些逻辑的处理，比如ip黑白名单拦截、特定地址的拦截等。下面的代码中做了两个过滤器，并且设定的先后顺序，只演示过滤器与运行效果。（具体逻辑处理部分学员实现）</p><p>需求：</p><p>1 ip拦截。pdd ip是淘宝，不让你百亿补贴。</p><p>2 危险操作日志打印：/admin/delete 记录</p><p>（1）ydles_gateway_system创建IpFilter</p><p>需求：ip黑名单拦截</p><p>IpFilter com.ydles.system.filter包下</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IpFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token comment">//具体业务逻辑</span></span>
<span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//获取客户端的访问ip</span></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;经过了第一个过滤器&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">InetSocketAddress</span> remoteAddress <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRemoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ip:&quot;</span><span class="token operator">+</span>remoteAddress<span class="token punctuation">.</span><span class="token function">getHostName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//放行</span></span>
<span class="line">    <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">//过滤器的执行优先级,返回值越小,执行优先级越高</span></span>
<span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（1）ydles_gateway_system创建UrlFilter</p><p>需求：特定地址的拦截 /admin/delete log</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UrlFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;经过了第二个过滤器&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">String</span> path <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;path:&quot;</span><span class="token operator">+</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//放行</span></span>
<span class="line">        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>访问测试： http://localhost:9101/goods/brand/category/%E6%89%8B%E6%9C%BA</p><h2 id="_2-网关限流" tabindex="-1"><a class="header-anchor" href="#_2-网关限流"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-%E7%BD%91%E5%85%B3%E9%99%90%E6%B5%81" target="_blank" rel="noopener noreferrer">#</a>2 网关限流</span></a></h2><p>概念：两个概念</p><p>限流：当我们的系统被频繁的请求的时候，就有可能将系统压垮，需要在每一个微服务中做限流操作</p><p>网关限流：在网关系统做限流 goods 1w/s search 5w/s</p><h3 id="_2-1-思路分析" tabindex="-1"><a class="header-anchor" href="#_2-1-思路分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-1-%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>2.1 思路分析</span></a></h3><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211017165438658.5996c1bb.png" alt="image-20211017165438658"></p><h3 id="_2-2-令牌桶算法" tabindex="-1"><a class="header-anchor" href="#_2-2-令牌桶算法"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-2-%E4%BB%A4%E7%89%8C%E6%A1%B6%E7%AE%97%E6%B3%95" target="_blank" rel="noopener noreferrer">#</a>2.2 令牌桶算法</span></a></h3><p>令牌桶算法是比较常见的限流算法之一，大概描述如下：</p><p>1）所有的请求在处理之前都需要拿到一个可用的令牌才会被处理；</p><p>2）根据限流大小，设置按照一定的速率往桶里添加令牌；</p><p>3）桶设置最大的放置令牌限制，当桶满时、新添加的令牌就被丢弃或者拒绝；</p><p>4）请求达到后首先要获取令牌桶中的令牌，拿着令牌才可以进行其他的业务逻辑，处理完业务逻辑之后，将令牌直接删除；</p><p>5）令牌桶有最低限额，当桶中的令牌达到最低限额的时候，请求处理完之后将不会删除令牌，以此保证足够的限流</p><p>如下图：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211017170219974.4441be58.png" alt="image-20211017170219974"></p><p>这个算法的实现，有很多技术，Guava(读音: 瓜哇)是其中之一，redis客户端也有其实现。</p><h3 id="_2-3-网关限流代码实现" tabindex="-1"><a class="header-anchor" href="#_2-3-网关限流代码实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-3-%E7%BD%91%E5%85%B3%E9%99%90%E6%B5%81%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>2.3 网关限流代码实现</span></a></h3><p>需求：每个ip地址1秒内只能发送1次请求goods，多出来的请求返回429错误。</p><p>代码实现：</p><p>（1）spring cloud gateway 默认使用redis的RateLimter限流算法来实现。所以我们要使用首先需要引入redis的依赖</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis-reactive<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.3.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）定义KeyResolver</p><p>在GatewayApplicatioin引导类中添加如下代码，KeyResolver用于计算某一个类型的限流的KEY也就是说，可以通过KeyResolver来指定限流的Key。</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Bean</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">KeyResolver</span> <span class="token function">ipKeyResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">KeyResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token annotation punctuation">@Override</span></span>
<span class="line">        <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRemoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHostName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9</p><p>（3）配置文件配置redis及限流策略。某个服务的filters下，加入如下代码。</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">spring</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">application</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> sysgateway</span>
<span class="line">  <span class="token key atrule">cloud</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">gateway</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">globalcors</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">cors-configurations</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">&#39;[/**]&#39;</span><span class="token punctuation">:</span> <span class="token comment"># 匹配所有请求</span></span>
<span class="line">            <span class="token key atrule">allowedOrigins</span><span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span> <span class="token comment">#跨域处理 允许所有的域</span></span>
<span class="line">            <span class="token key atrule">allowedMethods</span><span class="token punctuation">:</span> <span class="token comment"># 支持的方法</span></span>
<span class="line">            <span class="token punctuation">-</span> GET</span>
<span class="line">            <span class="token punctuation">-</span> POST</span>
<span class="line">            <span class="token punctuation">-</span> PUT</span>
<span class="line">            <span class="token punctuation">-</span> DELETE</span>
<span class="line">      <span class="token key atrule">routes</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> goods</span>
<span class="line">        <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//goods</span>
<span class="line">        <span class="token key atrule">predicates</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> Path=/goods/<span class="token important">**</span></span>
<span class="line">        <span class="token key atrule">filters</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> StripPrefix= 1</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> RequestRateLimiter <span class="token comment">#请求数限流 名字不能随便写 </span></span>
<span class="line">          <span class="token key atrule">args</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">key-resolver</span><span class="token punctuation">:</span> <span class="token string">&quot;#{@ipKeyResolver}&quot;</span></span>
<span class="line">            <span class="token key atrule">redis-rate-limiter.replenishRate</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment">#令牌桶每秒填充平均速率</span></span>
<span class="line">            <span class="token key atrule">redis-rate-limiter.burstCapacity</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment">#令牌桶总容量</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> system</span>
<span class="line">        <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//system</span>
<span class="line">        <span class="token key atrule">predicates</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> Path=/system/<span class="token important">**</span></span>
<span class="line">        <span class="token key atrule">filters</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> StripPrefix= 1</span>
<span class="line">  <span class="token comment"># 配置Redis 127.0.0.1可以省略配置</span></span>
<span class="line">  <span class="token key atrule">redis</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.200.128</span>
<span class="line">    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span></span>
<span class="line"><span class="token key atrule">server</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9101</span></span>
<span class="line"><span class="token key atrule">eureka</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">client</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">service-url</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>6868/eureka</span>
<span class="line">  <span class="token key atrule">instance</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>解释：</p><ul><li>burstCapacity：令牌桶总容量。</li><li>replenishRate：令牌桶每秒填充平均速率。</li><li>key-resolver：用于限流的键的解析器的 Bean 对象的名字。它使用 SpEL 表达式根据#{@beanName}从 Spring 容器中获取 Bean 对象。</li></ul><p>通过在<code>replenishRate</code>和中设置相同的值来实现稳定的速率<code>burstCapacity</code>。设置<code>burstCapacity</code>高于时，可以允许临时突发<code>replenishRate</code>。在这种情况下，需要在突发之间允许速率限制器一段时间（根据<code>replenishRate</code>），因为2次连续突发将导致请求被丢弃（<code>HTTP 429 - Too Many Requests</code>）</p><p>key-resolver: &quot;#{@userKeyResolver}&quot; 用于通过SPEL表达式来指定使用哪一个KeyResolver.</p><p>如上配置：</p><p>表示 一秒内，允许 一个请求通过，令牌桶的填充速率也是一秒钟添加一个令牌。</p><p>最大突发状况 也只允许 一秒内有一次请求，可以根据业务来调整 。</p><p>（4）测试</p><p>启动redis</p><p>启动注册中心</p><p>启动商品微服务</p><p>启动gateway网关</p><p>打开浏览器 http://localhost:9101/goods/brand</p><p>快速刷新，当1秒内发送多次请求，就会返回429错误。</p><p>http 响应码</p><p>2 没问题</p><p>200</p><p>3 没问题，需要浏览器做操作</p><p>302 303 转发</p><p>4 客户端有问题</p><p>404 not found 429</p><p>5服务端</p><p>501 系统繁忙，请稍后再试</p><h2 id="_3-bcrypt密码加密" tabindex="-1"><a class="header-anchor" href="#_3-bcrypt密码加密"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-bcrypt%E5%AF%86%E7%A0%81%E5%8A%A0%E5%AF%86" target="_blank" rel="noopener noreferrer">#</a>3. BCrypt密码加密</span></a></h2><h3 id="_3-1-bcrypt快速入门" tabindex="-1"><a class="header-anchor" href="#_3-1-bcrypt快速入门"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-1-bcrypt%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8" target="_blank" rel="noopener noreferrer">#</a>3.1 BCrypt快速入门</span></a></h3><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211018160603550.9d975ae1.png" alt="image-20211018160603550"></p><p>在用户模块，对于用户密码的保护，通常都会进行加密。我们通常对密码进行加密，然后存放在数据库中，在用户进行登录的时候，将其输入的密码进行加密然后与数据库中存放的密文进行比较，以验证用户密码是否正确。 目前，MD5和BCrypt比较流行。相对来说，BCrypt比MD5更安全。因为其内部引入的加盐机制</p><p>BCrypt 官网http://www.mindrot.org/projects/jBCrypt/</p><p>（1）新建测试类，main方法中编写代码，实现对密码的加密</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestBcrypt</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token doc-comment comment">/**</span>
<span class="line">         * 得到盐</span>
<span class="line">         * 盐是一个随机生成的含有29个字符的字符串,并且会与密码一起合并进行最终的密文生成</span>
<span class="line">         * 并且每一次生成的盐的值都是不同的</span>
<span class="line">         */</span></span>
<span class="line">        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">String</span> gensalt <span class="token operator">=</span> <span class="token class-name">BCrypt</span><span class="token punctuation">.</span><span class="token function">gensalt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;salt:&quot;</span><span class="token operator">+</span>gensalt<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">String</span> saltPassword <span class="token operator">=</span> <span class="token class-name">BCrypt</span><span class="token punctuation">.</span><span class="token function">hashpw</span><span class="token punctuation">(</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">,</span> gensalt<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;本次生成的密码:&quot;</span><span class="token operator">+</span>saltPassword<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）main方法中编写代码，实现对密码的校验。BCrypt不支持反运算，只支持密码校验。</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">//校验密码</span></span>
<span class="line"><span class="token keyword">boolean</span> checkpw <span class="token operator">=</span> <span class="token class-name">BCrypt</span><span class="token punctuation">.</span><span class="token function">checkpw</span><span class="token punctuation">(</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">,</span> saltPassword<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;密码校验结果:&quot;</span><span class="token operator">+</span>checkpw<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3</p><p><strong>结果</strong>：每次盐不一样，加密后不一样，但都能验证。</p><h3 id="_3-2-新增管理员密码加密-掌握" tabindex="-1"><a class="header-anchor" href="#_3-2-新增管理员密码加密-掌握"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-2-%E6%96%B0%E5%A2%9E%E7%AE%A1%E7%90%86%E5%91%98%E5%AF%86%E7%A0%81%E5%8A%A0%E5%AF%86-%E6%8E%8C%E6%8F%A1" target="_blank" rel="noopener noreferrer">#</a>3.2 新增管理员密码加密-掌握</span></a></h3><h4 id="_3-2-1-需求与表结构分析" tabindex="-1"><a class="header-anchor" href="#_3-2-1-需求与表结构分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-2-1-%E9%9C%80%E6%B1%82%E4%B8%8E%E8%A1%A8%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>3.2.1 需求与表结构分析</span></a></h4><p>ydles_system下tb_admin新增管理员，使用BCrypt进行密码加密</p><table><thead><tr><th>id</th><th>int</th><th>主键id</th></tr></thead><tbody><tr><td>login_name</td><td>varchar</td><td>登录名</td></tr><tr><td>password</td><td>varchar</td><td>密码</td></tr><tr><td>status</td><td>char</td><td>状态</td></tr></tbody></table><h4 id="_3-2-2-代码实现" tabindex="-1"><a class="header-anchor" href="#_3-2-2-代码实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-2-2-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>3.2.2 代码实现</span></a></h4><p>（1）修改ydles_service_system项目的AdminServiceImpl</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">	<span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Admin</span> admin<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//获取盐</span></span>
<span class="line">        <span class="token class-name">String</span> gensalt <span class="token operator">=</span> <span class="token class-name">BCrypt</span><span class="token punctuation">.</span><span class="token function">gensalt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//对用户的密码进行加密</span></span>
<span class="line">        <span class="token class-name">String</span> hashpw <span class="token operator">=</span> <span class="token class-name">BCrypt</span><span class="token punctuation">.</span><span class="token function">hashpw</span><span class="token punctuation">(</span>admin<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> gensalt<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        admin<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>hashpw<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        adminMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>admin<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9</p><p>测试：postman http://localhost:9101/system/admin</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">	<span class="token property">&quot;loginName&quot;</span><span class="token operator">:</span><span class="token string">&quot;test1&quot;</span><span class="token punctuation">,</span></span>
<span class="line">	<span class="token property">&quot;password&quot;</span><span class="token operator">:</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">,</span></span>
<span class="line">	<span class="token property">&quot;status&quot;</span><span class="token operator">:</span><span class="token string">&quot;1&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><h3 id="_3-3-管理员登录密码验证" tabindex="-1"><a class="header-anchor" href="#_3-3-管理员登录密码验证"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-3-%E7%AE%A1%E7%90%86%E5%91%98%E7%99%BB%E5%BD%95%E5%AF%86%E7%A0%81%E9%AA%8C%E8%AF%81" target="_blank" rel="noopener noreferrer">#</a>3.3 管理员登录密码验证</span></a></h3><h4 id="_3-3-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_3-3-1-需求分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-3-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>3.3.1 需求分析</span></a></h4><p>系统管理用户需要管理后台，需要先输入用户名和密码进行登录，才能进入管理后台。</p><p>思路：</p><p>用户发送请求，输入用户名和密码</p><p>后台管理微服务controller接收参数，验证用户名和密码是否正确，如果正确则返回用户登录成功结果</p><h4 id="_3-3-2-代码实现" tabindex="-1"><a class="header-anchor" href="#_3-3-2-代码实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-3-2-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>3.3.2 代码实现</span></a></h4><p>（1）AdminService新增方法定义</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 登录验证密码</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">admin</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">boolean</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">Admin</span> admin<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6</p><p>（2）AdminServiceImpl实现此方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">Admin</span> admin<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//根据登录名查询管理员</span></span>
<span class="line">        <span class="token class-name">Admin</span> admin1<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        admin1<span class="token punctuation">.</span><span class="token function">setLoginName</span><span class="token punctuation">(</span>admin<span class="token punctuation">.</span><span class="token function">getLoginName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        admin1<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Admin</span> admin2 <span class="token operator">=</span> adminMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>admin1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//数据库查询出的对象</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span>admin2<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//验证密码, Bcrypt为spring的包, 第一个参数为明文密码, 第二个参数为密文密码</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token class-name">BCrypt</span><span class="token punctuation">.</span><span class="token function">checkpw</span><span class="token punctuation">(</span>admin<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>admin2<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（3）AdminController新增方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 登录</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">admin</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Admin</span> admin<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">boolean</span> login <span class="token operator">=</span> adminService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>admin<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span>login<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">LOGINERROR</span><span class="token punctuation">,</span><span class="token string">&quot;用户名或密码错误&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试：postman http://localhost:9101/system/admin/login</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">	<span class="token property">&quot;loginName&quot;</span><span class="token operator">:</span><span class="token string">&quot;test1&quot;</span><span class="token punctuation">,</span></span>
<span class="line">	<span class="token property">&quot;password&quot;</span><span class="token operator">:</span><span class="token string">&quot;1234561&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><h2 id="_4-加密算法-了解" tabindex="-1"><a class="header-anchor" href="#_4-加密算法-了解"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_4-%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95-%E4%BA%86%E8%A7%A3" target="_blank" rel="noopener noreferrer">#</a>4.加密算法(了解)</span></a></h2><p><strong>由于在学习JWT的时候会涉及使用很多加密算法, 所以在这里做下扫盲, 简单了解就可以</strong></p><p>加密算法种类有:</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211019155118932.7c384b74.png" alt="image-20211019155118932"></p><h3 id="_4-1-可逆加密算法" tabindex="-1"><a class="header-anchor" href="#_4-1-可逆加密算法"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_4-1-%E5%8F%AF%E9%80%86%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95" target="_blank" rel="noopener noreferrer">#</a>4.1.可逆加密算法</span></a></h3><p><strong>解释:</strong> 加密后, 密文可以反向解密得到密码原文.</p><h4 id="_4-1-1-对称加密" tabindex="-1"><a class="header-anchor" href="#_4-1-1-对称加密"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_4-1-1-%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86" target="_blank" rel="noopener noreferrer">#</a>4.1.1. 对称加密</span></a></h4><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20191207093647995.4428f190.png" alt="image-20191207093647995"></p><p>秘钥：2（每位向后推2个）</p><p>abc----cde-------&gt;abc</p><p>【<strong>文件加密和解密使用相同的密钥，即加密密钥也可以用作解密密钥</strong>】</p><p><strong>解释:</strong> 在对称加密算法中，数据发信方将明文和加密密钥一起经过特殊的加密算法处理后，使其变成复杂的加密密文发送出去，收信方收到密文后，若想解读出原文，则需要使用加密时用的密钥以及相同加密算法的逆算法对密文进行解密，才能使其回复成可读明文。在对称加密算法中，使用的密钥只有一个，收发双方都使用这个密钥，这就需要解密方事先知道加密密钥。</p><p><strong>优点:</strong> 对称加密算法的优点是算法公开、计算量小、加密速度快、加密效率高。</p><p><strong>缺点:</strong> 没有非对称加密安全.</p><p><strong>用途：</strong> 一般用于保存用户手机号、身份证等敏感但能解密的信息。</p><p><strong>常见的对称加密算法有</strong>: <code>AES、DES、3DES、Blowfish、IDEA、RC4、RC5、RC6、HS256</code></p><h4 id="_4-1-2-非对称加密" tabindex="-1"><a class="header-anchor" href="#_4-1-2-非对称加密"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_4-1-2-%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86" target="_blank" rel="noopener noreferrer">#</a>4.1.2. 非对称加密</span></a></h4><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20191207093855574.59b7cfda.png" alt="image-20191207093855574"></p><p>【<strong>两个密钥：公开密钥（publickey）和私有密钥，公有密钥加密，私有密钥解密</strong>】</p><p><strong>解释:</strong> 同时生成两把密钥：私钥和公钥，私钥隐秘保存，公钥可以下发给信任客户端.</p><p>加密与解密:</p><ul><li>私钥加密，持有私钥或公钥才可以解密</li><li>公钥加密，持有私钥才可解密</li></ul><p>签名:</p><ul><li>私钥签名, 持有公钥进行验证是否被篡改过.</li></ul><p><strong>优点:</strong> 非对称加密与对称加密相比，其安全性更好；</p><p><strong>缺点:</strong> 非对称加密的缺点是加密和解密花费时间长、速度慢，只适合对少量数据进行加密。 <strong>用途：</strong> 一般用于签名和认证。私钥服务器保存, 用来加密, 公钥客户拿着用于对于令牌或者签名的解密或者校验使用.</p><p><strong>常见的非对称加密算法有：</strong> <code>RSA、DSA（数字签名用）、ECC（移动设备用）、RS256 (采用SHA-256 的 RSA 签名)</code></p><p><strong>拓展</strong>：linux 免密登陆。</p><h3 id="_4-2-不可逆加密算法" tabindex="-1"><a class="header-anchor" href="#_4-2-不可逆加密算法"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_4-2-%E4%B8%8D%E5%8F%AF%E9%80%86%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95" target="_blank" rel="noopener noreferrer">#</a>4.2.不可逆加密算法</span></a></h3><p><strong>解释:</strong> 一旦加密就不能反向解密得到密码原文.</p><p><strong>种类:</strong> Hash加密算法, 散列算法, 摘要算法等</p><p>**用途：**一般用于效验下载文件正确性，一般在网站上下载文件都能见到；存储用户敏感信息，如密码、 卡号等不可解密的信息。</p><p><strong>常见的不可逆加密算法有：</strong> <code>MD5、SHA、HMAC</code></p><h3 id="_4-3-base64编码" tabindex="-1"><a class="header-anchor" href="#_4-3-base64编码"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_4-3-base64%E7%BC%96%E7%A0%81" target="_blank" rel="noopener noreferrer">#</a>4.3.Base64编码</span></a></h3><p>Base64是网络上最常见的用于传输8Bit字节代码的编码方式之一。Base64编码可用于在HTTP环境下传递较长的标识信息。采用Base64编码解码具有不可读性，即所编码的数据不会被人用肉眼所直接看到。<strong>注意：Base64只是一种编码方式，不算加密方法。</strong></p><p>在线编码工具：</p><p>http://www.jsons.cn/img2base64/</p><p>拓展：字符编码相关知识。</p><h2 id="_5-jwt-实现微服务鉴权" tabindex="-1"><a class="header-anchor" href="#_5-jwt-实现微服务鉴权"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_5-jwt-%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%89%B4%E6%9D%83" target="_blank" rel="noopener noreferrer">#</a>5. JWT 实现微服务鉴权</span></a></h2><h3 id="_5-1-什么是微服务鉴权" tabindex="-1"><a class="header-anchor" href="#_5-1-什么是微服务鉴权"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_5-1-%E4%BB%80%E4%B9%88%E6%98%AF%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%89%B4%E6%9D%83" target="_blank" rel="noopener noreferrer">#</a>5.1 什么是微服务鉴权</span></a></h3><p>我们之前已经搭建过了网关，使用网关在系统中比较适合进行权限校验。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211019155804648.624eb051.png" alt="image-20211019155804648"></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211019160152399.4f334736.png" alt="image-20211019160152399"></p><p><strong>单点登录</strong>的特点是：</p><p>1、认证系统为独立的系统。</p><p>2、各子系统通过Http或其它协议与认证系统通信，完成用户认证。</p><p>3、用户身份信息存储在Redis集群。</p><p>Java中有很多用户认证的框架都可以实现单点登录：</p><p>1、Apache Shiro.</p><p>2、CAS</p><p>3、Spring security CAS</p><h3 id="_5-2-jwt" tabindex="-1"><a class="header-anchor" href="#_5-2-jwt"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_5-2-jwt" target="_blank" rel="noopener noreferrer">#</a>5.2 JWT</span></a></h3><p>JSON Web Token（JWT）是一个非常轻巧的规范。这个规范允许我们使用JWT在用户和服务器之间传递安全可靠的信息。</p><p>一个JWT实际上就是一个字符串，它由三部分组成，头部、载荷与签名。</p><p><strong>头部（Header）</strong></p><p>头部用于描述关于该JWT的最基本的信息，例如其类型以及签名所用的算法等。这也可以被表示成一个JSON对象。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">{&quot;typ&quot;:&quot;JWT&quot;,&quot;alg&quot;:&quot;HS256&quot;}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>在头部指明了签名算法是HS256算法。 我们进行BASE64编码http://base64.xpcha.com/，编码后的字符串如下：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p><strong>载荷（playload）</strong></p><p>载荷就是存放有效信息的地方。</p><p>定义一个payload:</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">{&quot;sub&quot;:&quot;1234567890&quot;,&quot;name&quot;:&quot;itlils&quot;,&quot;admin&quot;:true,&quot;age&quot;:18}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>然后将其进行base64加密，得到Jwt的第二部分。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6Iml0bGlscyIsImFkbWluIjp0cnVlLCJhZ2UiOjE4fQ==</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p><strong>签证（signature）</strong></p><p>jwt的第三部分是一个签证信息，这个签证信息由三部分组成：</p><blockquote><p>header (base64后的)</p><p>payload (base64后的)</p><p>secret</p></blockquote><p>这个部分需要base64加密后的header和base64加密后的payload使用.连接组成的字符串，然后通过header中声明的加密方式进行加盐secret组合加密，然后就构成了jwt的第三部分。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">hs256(&quot;eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6Iml0bGlscyIsImFkbWluIjp0cnVlLCJhZ2UiOjE4fQ==&quot;,secret)</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>将这三部分用.连接成一个完整的字符串,构成了最终的jwt:</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">JTdCJTIydHlwJTIyJTNBJTIySldUJTIyJTJDJTIyYWxnJTIyJTNBJTIySFMyNTYlMjIlN0Q=.JTdCJTIyc3ViJTIyJTNBJTIyMTIzNDU2Nzg5MCUyMiUyQyUyMm5hbWUlMjIlM0ElMjJqYWNrJTIyJTJDJTIyYWRtaW4lMjIlM0F0cnVlJTdE.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><h3 id="_5-3-jjwt签发与验证token" tabindex="-1"><a class="header-anchor" href="#_5-3-jjwt签发与验证token"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_5-3-jjwt%E7%AD%BE%E5%8F%91%E4%B8%8E%E9%AA%8C%E8%AF%81token" target="_blank" rel="noopener noreferrer">#</a>5.3 JJWT签发与验证token</span></a></h3><p>JJWT是一个提供端到端的JWT创建和验证的Java库。永远免费和开源(Apache License，版本2.0)，JJWT很容易使用和理解。它被设计成一个以建筑为中心的流畅界面，隐藏了它的大部分复杂性。</p><p>官方文档：</p><p>https://github.com/jwtk/jjwt</p><h4 id="_5-3-1-创建token" tabindex="-1"><a class="header-anchor" href="#_5-3-1-创建token"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_5-3-1-%E5%88%9B%E5%BB%BAtoken" target="_blank" rel="noopener noreferrer">#</a>5.3.1 创建token</span></a></h4><p>（1）新建项目jwtTest中的pom.xml中添加依赖：</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.jsonwebtoken<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jjwt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.9.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p>(2) 创建测试类，代码如下</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    </span>
<span class="line"><span class="token comment">//获取系统的当前时间</span></span>
<span class="line">    <span class="token keyword">long</span> currentTimeMillis <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">Date</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>currentTimeMillis<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//生成jwt令牌</span></span>
<span class="line">    <span class="token class-name">JwtBuilder</span> jwtBuilder <span class="token operator">=</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token string">&quot;66&quot;</span><span class="token punctuation">)</span><span class="token comment">//设置jwt编码</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span><span class="token string">&quot;元动力二奢&quot;</span><span class="token punctuation">)</span><span class="token comment">//设置jwt主题</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">setIssuedAt</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//设置jwt签发日期</span></span>
<span class="line">            <span class="token comment">//.setExpiration(date)//设置jwt的过期时间</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">signWith</span><span class="token punctuation">(</span><span class="token class-name">SignatureAlgorithm</span><span class="token punctuation">.</span><span class="token constant">HS256</span><span class="token punctuation">,</span> <span class="token string">&quot;ydlershe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//生成jwt</span></span>
<span class="line">    <span class="token class-name">String</span> jwtToken <span class="token operator">=</span> jwtBuilder<span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jwtToken<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行打印结果：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiIyNyIsInN1YiI6InlkbGVyc2hlc2hhbmdjaGVuZyIsImlhdCI6MTYzNDYzMjA0N30.ZTrtNXaAQzFIr1MipUTMaprB2xYcvz5_XbNlvN4Adeoxxxxxxxxxx eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiIyNyIsInN1YiI6InlkbGVyc2hlc2hhbmdjaGVuZyIsImlhdCI6MTYzNDYzMjA0N30.ZTrtNXaAQzFIr1MipUTMaprB2xYcvz5_XbNlvN4Adeoey</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>再次运行，会发现每次运行的结果是不一样的，因为我们的载荷中包含了时间。</p><p>验证base64 https://tool.oschina.net/encrypt?type=3</p><h4 id="_5-3-2-解析token" tabindex="-1"><a class="header-anchor" href="#_5-3-2-解析token"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_5-3-2-%E8%A7%A3%E6%9E%90token" target="_blank" rel="noopener noreferrer">#</a>5.3.2 解析token</span></a></h4><p>我们刚才已经创建了token ，在web应用中这个操作是由服务端进行然后发给客户端，客户端在下次向服务端发送请求时需要携带这个token（这就好像是拿着一张门票一样），那服务端接到这个token 应该解析出token中的信息（例如用户id）,根据这些信息查询数据库返回相应的结果。</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">String</span> compactJwt<span class="token operator">=</span><span class="token string">&quot;eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiIyNyIsInN1YiI6InlkbGVyc2hlc2hhbmdjaGVuZyIsImlhdCI6MTYzNDYzMjMyNn0.orvxPJcAsOquRjcjj947vMmD11QoZn8BuHKSeCEbV8g&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name">Claims</span> claims <span class="token operator">=</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span><span class="token string">&quot;ydlershe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parseClaimsJws</span><span class="token punctuation">(</span>compactJwt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p>运行打印效果：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">{jti=27, sub=ydlersheshangcheng, iat=1634632326}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>试着将token或签名秘钥篡改一下，会发现运行时就会报错，所以解析token也就是验证token.</p><p><strong>注意</strong>：设置签名key必须和生成时一致。</p><h4 id="_5-3-3-设置过期时间" tabindex="-1"><a class="header-anchor" href="#_5-3-3-设置过期时间"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_5-3-3-%E8%AE%BE%E7%BD%AE%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4" target="_blank" rel="noopener noreferrer">#</a>5.3.3 设置过期时间</span></a></h4><p>有很多时候，我们并不希望签发的token是永久生效的，所以我们可以为token添加一个过期时间。</p><p>（1）创建token 并设置过期时间</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">//当前时间</span></span>
<span class="line"><span class="token keyword">long</span> currentTimeMillis <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">Date</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>currentTimeMillis<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">JwtBuilder</span> builder<span class="token operator">=</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token string">&quot;888&quot;</span><span class="token punctuation">)</span>   <span class="token comment">//设置唯一编号</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span><span class="token string">&quot;小白&quot;</span><span class="token punctuation">)</span><span class="token comment">//设置主题  可以是JSON数据</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">setIssuedAt</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//设置签发日期</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">setExpiration</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">signWith</span><span class="token punctuation">(</span><span class="token class-name">SignatureAlgorithm</span><span class="token punctuation">.</span><span class="token constant">HS256</span><span class="token punctuation">,</span><span class="token string">&quot;ydlershe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置签名 使用HS256算法，并设置SecretKey(字符串)</span></span>
<span class="line"><span class="token comment">//构建 并返回一个字符串</span></span>
<span class="line"><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span> builder<span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11</p><p>解释：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token punctuation">.</span><span class="token function">setExpiration</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token comment">//用于设置过期时间 ，参数为Date类型数据</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>运行，打印效果如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">eyJhbGciOiJIUzI1NiJ9<span class="token punctuation">.</span>eyJqdGkiOiI4ODgiLCJzdWIiOiLlsI_nmb0iLCJpYXQiOjE1NTc5MDUzMDgsImV4cCI6MTU1NzkwNTMwOH0<span class="token punctuation">.</span><span class="token number">4</span>q5AaTyBRf8SB9B3Tl<span class="token operator">-</span><span class="token class-name">I53PrILGyicJC3fgR3gWbvUI</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>（2）解析TOKEN</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name">String</span> compactJwt<span class="token operator">=</span><span class="token string">&quot;eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODgiLCJzdWIiOiLlsI_nmb0iLCJpYXQiOjE1NTc5MDUzMDgsImV4cCI6MTU1NzkwNTMwOH0.4q5AaTyBRf8SB9B3Tl-I53PrILGyicJC3fgR3gWbvUI&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name">Claims</span> claims <span class="token operator">=</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span><span class="token string">&quot;ydlershe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parseClaimsJws</span><span class="token punctuation">(</span>compactJwt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>打印效果：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211019163701578.8687048e.png" alt="image-20211019163701578"></p><p>当前时间超过过期时间，则会报错。</p><h4 id="_5-3-4-自定义claims" tabindex="-1"><a class="header-anchor" href="#_5-3-4-自定义claims"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_5-3-4-%E8%87%AA%E5%AE%9A%E4%B9%89claims" target="_blank" rel="noopener noreferrer">#</a>5.3.4 自定义claims</span></a></h4><p>我们刚才的例子只是存储了id和subject两个信息，如果你想存储更多的信息（例如角色）可以定义自定义claims。</p><p>创建测试类，并设置测试方法：</p><p>创建token:</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Test</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createJWT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//当前时间</span></span>
<span class="line">    <span class="token keyword">long</span> currentTimeMillis <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    currentTimeMillis<span class="token operator">+=</span><span class="token number">1000000L</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">Date</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>currentTimeMillis<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">JwtBuilder</span> builder<span class="token operator">=</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token string">&quot;888&quot;</span><span class="token punctuation">)</span>   <span class="token comment">//设置唯一编号</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span><span class="token string">&quot;小白&quot;</span><span class="token punctuation">)</span><span class="token comment">//设置主题  可以是JSON数据</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">setIssuedAt</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//设置签发日期</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">setExpiration</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token comment">//设置过期时间</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">claim</span><span class="token punctuation">(</span><span class="token string">&quot;roles&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span><span class="token comment">//设置角色</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">signWith</span><span class="token punctuation">(</span><span class="token class-name">SignatureAlgorithm</span><span class="token punctuation">.</span><span class="token constant">HS256</span><span class="token punctuation">,</span><span class="token string">&quot;ydlershe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置签名 使用HS256算法，并设置SecretKey(字符串)</span></span>
<span class="line">    <span class="token comment">//构建 并返回一个字符串</span></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span> builder<span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行打印效果：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token class-name"><span class="token namespace">eyJhbGciOiJIUzI1NiJ9<span class="token punctuation">.</span>eyJqdGkiOiI4ODgiLCJzdWIiOiLlsI_nmb0iLCJpYXQiOjE1NTc5MDU4MDIsImV4cCI6MTU1NzkwNjgwMiwicm9sZXMiOiJhZG1pbiJ9<span class="token punctuation">.</span></span>AS5Y2fNCwUzQQxXh_QQWMpaB75YqfuK</span><span class="token operator">-</span><span class="token number">2</span>P7VZiCXEJI</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>解析TOKEN:</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">//解析</span></span>
<span class="line"><span class="token annotation punctuation">@Test</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">parseJWT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">String</span> compactJwt<span class="token operator">=</span><span class="token string">&quot;eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODgiLCJzdWIiOiLlsI_nmb0iLCJpYXQiOjE1NTc5MDU4MDIsImV4cCI6MTU1NzkwNjgwMiwicm9sZXMiOiJhZG1pbiJ9.AS5Y2fNCwUzQQxXh_QQWMpaB75YqfuK-2P7VZiCXEJI&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">Claims</span> claims <span class="token operator">=</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span><span class="token string">&quot;ydlershe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parseClaimsJws</span><span class="token punctuation">(</span>compactJwt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行效果：</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211019163914827.628adf98.png" alt="image-20211019163914827"></p><h3 id="_5-4-元动力二奢微服务鉴权代码实现-重点" tabindex="-1"><a class="header-anchor" href="#_5-4-元动力二奢微服务鉴权代码实现-重点"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_5-4-%E5%85%83%E5%8A%A8%E5%8A%9B%E4%BA%8C%E5%A5%A2%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%89%B4%E6%9D%83%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-%E9%87%8D%E7%82%B9" target="_blank" rel="noopener noreferrer">#</a>5.4 元动力二奢微服务鉴权代码实现-重点</span></a></h3><h4 id="_5-4-1-思路分析-重点理解" tabindex="-1"><a class="header-anchor" href="#_5-4-1-思路分析-重点理解"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_5-4-1-%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90-%E9%87%8D%E7%82%B9%E7%90%86%E8%A7%A3" target="_blank" rel="noopener noreferrer">#</a>5.4.1 思路分析-重点理解</span></a></h4><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211019171251313.b155f49f.png" alt="image-20211019171251313"></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">1.1 用户进入网关开始登陆，网关过滤器进行判断，如果是登录，则路由到后台管理微服务进行登录</span>
<span class="line">1.2. 用户登录成功，后台管理微服务签发JWT TOKEN信息返回给用户</span>
<span class="line">2.1 用户再次进入网关开始访问，网关过滤器接收用户携带的TOKEN </span>
<span class="line">2.2 网关过滤器解析TOKEN ，判断是否有权限，如果有，则放行，如果没有则返回未认证错误</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>一、<strong>登陆</strong>：</p><p>1用户进入网关开始登陆，网关过滤器进行判断，如果是登录，则路由到后台管理微服务进 行登录</p><p>2用户登录成功，后台管理微服务签发JWT TOKEN信息返回给用户</p><p>二、<strong>访问资源</strong>：</p><p>1用户再次进入网关开始访问，网关过滤器接收用户携带的TOKEN</p><p>2网关过滤器解析TOKEN ，判断是否有权限，如果有，则放行，如果没有则返回未认证错误</p><h4 id="_5-4-2-系统微服务签发token" tabindex="-1"><a class="header-anchor" href="#_5-4-2-系统微服务签发token"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_5-4-2-%E7%B3%BB%E7%BB%9F%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%AD%BE%E5%8F%91token" target="_blank" rel="noopener noreferrer">#</a>5.4.2 系统微服务签发token</span></a></h4><p>（1）在ydles_service_system添加依赖</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.jsonwebtoken<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jjwt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.9.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）在ydles_service_system中粘贴JwtUtil工具类。看懂即可。</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>system<span class="token punctuation">.</span>util</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>jsonwebtoken<span class="token punctuation">.</span></span><span class="token class-name">JwtBuilder</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>jsonwebtoken<span class="token punctuation">.</span></span><span class="token class-name">Jwts</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>jsonwebtoken<span class="token punctuation">.</span></span><span class="token class-name">SignatureAlgorithm</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span><span class="token class-name">SecretKey</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>spec<span class="token punctuation">.</span></span><span class="token class-name">SecretKeySpec</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Base64</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * JWT工具类</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtUtil</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//有效期为</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Long</span> <span class="token constant">JWT_TTL</span> <span class="token operator">=</span> <span class="token number">3600000L</span><span class="token punctuation">;</span><span class="token comment">// 60 * 60 *1000  一个小时</span></span>
<span class="line">    <span class="token comment">//设置秘钥明文</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">JWT_KEY</span> <span class="token operator">=</span> <span class="token string">&quot;ydlershe&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 创建token</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">id</span></span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">subject</span></span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">ttlMillis</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">createJWT</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">,</span> <span class="token class-name">String</span> subject<span class="token punctuation">,</span> <span class="token class-name">Long</span> ttlMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">SignatureAlgorithm</span> signatureAlgorithm <span class="token operator">=</span> <span class="token class-name">SignatureAlgorithm</span><span class="token punctuation">.</span><span class="token constant">HS256</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">long</span> nowMillis <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Date</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>nowMillis<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span>ttlMillis<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            ttlMillis<span class="token operator">=</span><span class="token class-name">JwtUtil</span><span class="token punctuation">.</span><span class="token constant">JWT_TTL</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">long</span> expMillis <span class="token operator">=</span> nowMillis <span class="token operator">+</span> ttlMillis<span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Date</span> expDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>expMillis<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">SecretKey</span> secretKey <span class="token operator">=</span> <span class="token function">generalKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">JwtBuilder</span> builder <span class="token operator">=</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>              <span class="token comment">//唯一的ID</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span>subject<span class="token punctuation">)</span>   <span class="token comment">// 主题  可以是JSON数据</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">setIssuer</span><span class="token punctuation">(</span><span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span>     <span class="token comment">// 签发者</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">setIssuedAt</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span>      <span class="token comment">// 签发时间</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">signWith</span><span class="token punctuation">(</span>signatureAlgorithm<span class="token punctuation">,</span> secretKey<span class="token punctuation">)</span> <span class="token comment">//使用HS256对称加密算法签名, 第二个参数为秘钥</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">setExpiration</span><span class="token punctuation">(</span>expDate<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 设置过期时间</span></span>
<span class="line">        <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 生成加密后的秘钥 secretKey</span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">SecretKey</span> <span class="token function">generalKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> encodedKey <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">JwtUtil</span><span class="token punctuation">.</span><span class="token constant">JWT_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">SecretKey</span> key <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecretKeySpec</span><span class="token punctuation">(</span>encodedKey<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> encodedKey<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token string">&quot;AES&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> key<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（3）修改AdminController的login方法, 用户登录成功则签发TOKEN</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 登录</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">admin</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Admin</span> admin<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">boolean</span> login <span class="token operator">=</span> adminService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>admin<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span>login<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment">//如果验证成功</span></span>
<span class="line">            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> info <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            info<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">,</span>admin<span class="token punctuation">.</span><span class="token function">getLoginName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token class-name">JwtUtil</span><span class="token punctuation">.</span><span class="token function">createJWT</span><span class="token punctuation">(</span><span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> admin<span class="token punctuation">.</span><span class="token function">getLoginName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            info<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">,</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span><span class="token string">&quot;登录成功&quot;</span><span class="token punctuation">,</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">LOGINERROR</span><span class="token punctuation">,</span><span class="token string">&quot;用户名或密码错误&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用postman 测试 http://localhost:9101/system/admin/login</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span><span class="token property">&quot;loginName&quot;</span><span class="token operator">:</span><span class="token string">&quot;itlilaoshi&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;password&quot;</span><span class="token operator">:</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211019172438539.3124e6e0.png" alt="image-20211019172438539"></p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211019172548033.ac3b96d2.png" alt="image-20211019172548033"></p><h4 id="_5-4-3-网关过滤器验证token" tabindex="-1"><a class="header-anchor" href="#_5-4-3-网关过滤器验证token"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_5-4-3-%E7%BD%91%E5%85%B3%E8%BF%87%E6%BB%A4%E5%99%A8%E9%AA%8C%E8%AF%81token" target="_blank" rel="noopener noreferrer">#</a>5.4.3 网关过滤器验证token</span></a></h4><p>（1）在ydles_gateway_system网关系统添加依赖</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token comment">&lt;!--鉴权--&gt;</span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.jsonwebtoken<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jjwt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.9.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）导入jwt工具类</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ydles<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>util</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>jsonwebtoken<span class="token punctuation">.</span></span><span class="token class-name">Claims</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>jsonwebtoken<span class="token punctuation">.</span></span><span class="token class-name">Jwts</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span><span class="token class-name">SecretKey</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>spec<span class="token punctuation">.</span></span><span class="token class-name">SecretKeySpec</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Base64</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * jwt校验工具类</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtUtil</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//有效期为</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Long</span> <span class="token constant">JWT_TTL</span> <span class="token operator">=</span> <span class="token number">3600000L</span><span class="token punctuation">;</span><span class="token comment">// 60 * 60 *1000  一个小时</span></span>
<span class="line">    <span class="token comment">//设置秘钥明文</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">JWT_KEY</span> <span class="token operator">=</span> <span class="token string">&quot;ydlershe&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 生成加密后的秘钥 secretKey</span>
<span class="line">     *</span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">SecretKey</span> <span class="token function">generalKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> encodedKey <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">JwtUtil</span><span class="token punctuation">.</span><span class="token constant">JWT_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">SecretKey</span> key <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecretKeySpec</span><span class="token punctuation">(</span>encodedKey<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> encodedKey<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token string">&quot;AES&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> key<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 解析</span>
<span class="line">     *</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">jwt</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Claims</span> <span class="token function">parseJWT</span><span class="token punctuation">(</span><span class="token class-name">String</span> jwt<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">SecretKey</span> secretKey <span class="token operator">=</span> <span class="token function">generalKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span>secretKey<span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">parseClaimsJws</span><span class="token punctuation">(</span>jwt<span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（3）创建过滤器，用于token验证</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 鉴权过滤器 验证token</span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@Component</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizeFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">AUTHORIZE_TOKEN</span> <span class="token operator">=</span> <span class="token string">&quot;token&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//1. 获取请求</span></span>
<span class="line">        <span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//2. 则获取响应</span></span>
<span class="line">        <span class="token class-name">ServerHttpResponse</span> response <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//3. 如果是登录请求则放行</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;/admin/login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token comment">//4. 获取请求头</span></span>
<span class="line">        <span class="token class-name">HttpHeaders</span> headers <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//5. 请求头中获取令牌</span></span>
<span class="line">        <span class="token class-name">String</span> token <span class="token operator">=</span> headers<span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token constant">AUTHORIZE_TOKEN</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//6. 判断请求头中是否有令牌</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//7. 响应中放入返回的状态吗, 没有权限访问</span></span>
<span class="line">            response<span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">UNAUTHORIZED</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">//8. 返回</span></span>
<span class="line">            <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">setComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//9. 如果请求头中有令牌则解析令牌</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">JwtUtil</span><span class="token punctuation">.</span><span class="token function">parseJWT</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">//10. 解析jwt令牌出错, 说明令牌过期或者伪造等不合法情况出现</span></span>
<span class="line">            response<span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">UNAUTHORIZED</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">//11. 返回</span></span>
<span class="line">            <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">setComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token comment">//12. 放行</span></span>
<span class="line">        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（4）测试：</p><p><strong>注意: 数据库中管理员账户为 : itlilaoshi, 密码为 : 123456</strong></p><p>如果不携带token直接访问，则返回401错误</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211019175512769.d7add392.png" alt="image-20211019175512769"></p><p>如果携带正确的token，则返回查询结果</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211019175633553.8c2bf1c6.png" alt="image-20211019175633553"></p><p>1首先登陆拿到令牌</p><p>http://localhost:9101/system/admin/login</p><p>2访问某个资源</p><p>http://localhost:9101/system/admin</p><p>返回401</p><p>3header中带上token</p><p>可以是正常访问</p><p>总结：</p><p>1网关 过滤+路由</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211016171720573.d639eed8.png" alt="image-20211016171720573"></p><p>2网关限流</p><p>令牌桶</p><p>代码实现 reyresolver 配置流速，桶大小</p><p>3密码加密</p><p>密码 存成密文</p><p>md5+ 加盐</p><p>BCrypt</p><p>4加密算法</p><p>可逆</p><p>对称加密</p><p>非对称</p><p>不可逆</p><p>5jwt实现网关鉴权</p><p>jwt base64( head).base64(payload).hs256(前两部分,secret)</p><p>jjwt 生成jwt 解析</p><p>图：网关集成鉴权逻辑</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211019171251313.b155f49f.png" alt="image-20211019171251313"></p><h2 id="第4章-商品管理" tabindex="-1"><a class="header-anchor" href="#第4章-商品管理"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#%E7%AC%AC4%E7%AB%A0-%E5%95%86%E5%93%81%E7%AE%A1%E7%90%86" target="_blank" rel="noopener noreferrer">#</a>第4章 商品管理</span></a></h2><p><strong>角色</strong>：商品组，后端开发。</p><h2 id="学习目标-2" tabindex="-1"><a class="header-anchor" href="#学习目标-2"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87-2" target="_blank" rel="noopener noreferrer">#</a>学习目标</span></a></h2><ul><li>能够使用开源算法snowflake生成分布式id</li><li>完成新增和修改商品功能</li><li>完成商品审核和上下架功能</li><li>完成删除与还原商品功能</li></ul><h2 id="_1-分布式id生成解决方案-面试" tabindex="-1"><a class="header-anchor" href="#_1-分布式id生成解决方案-面试"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_1-%E5%88%86%E5%B8%83%E5%BC%8Fid%E7%94%9F%E6%88%90%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-%E9%9D%A2%E8%AF%95" target="_blank" rel="noopener noreferrer">#</a>1. 分布式ID生成解决方案-面试</span></a></h2><h3 id="为什么生成唯一id" tabindex="-1"><a class="header-anchor" href="#为什么生成唯一id"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#%E4%B8%BA%E4%BB%80%E4%B9%88%E7%94%9F%E6%88%90%E5%94%AF%E4%B8%80id" target="_blank" rel="noopener noreferrer">#</a>为什么生成唯一ID</span></a></h3><p>背景：互联网多模块微服务情况下，高并发。</p><p>程序：goods order</p><p>数据库：goods order</p><p>order微服务 100 id 1 id 1</p><p>采用分库分表。order1\\order2等。</p><p>所以主键的生成成为问题。</p><p>每个模块存入数据库时，需要生成唯一的ID。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211020150542889.e8029396.png" alt="image-20211020150542889"></p><h3 id="_1-1-分布式id生成解决方案" tabindex="-1"><a class="header-anchor" href="#_1-1-分布式id生成解决方案"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_1-1-%E5%88%86%E5%B8%83%E5%BC%8Fid%E7%94%9F%E6%88%90%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" target="_blank" rel="noopener noreferrer">#</a>1.1 分布式ID生成解决方案</span></a></h3><h4 id="_1-1-1-uuid" tabindex="-1"><a class="header-anchor" href="#_1-1-1-uuid"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_1-1-1-uuid" target="_blank" rel="noopener noreferrer">#</a>1.1.1 UUID</span></a></h4><p>常见的方式。可以利用数据库也可以利用程序生成，一般来说全球唯一。</p><p>gateway服务下测试uuid生成</p><p>代码例子：a8fb5e44-f841-49ff-b10b-01d3afb2b238</p><p>36*8=288bit</p><p>优点：</p><p>1）简单，代码方便。</p><p>2）生成ID性能非常好，基本不会有性能问题。</p><p>3）全球唯一，在遇见数据迁移，系统数据合并，或者数据库变更等情况下，可以从容应对。</p><p>缺点：</p><p>1）没有排序，无法保证趋势递增。</p><p>2）UUID往往是使用字符串存储，查询的效率比较低。 id int 快！</p><p>3）存储空间比较大，如果是海量数据库，就需要考虑存储量的问题。32string*8=256bit</p><p>4）传输数据量大</p><p>5）不可读。</p><h4 id="_1-1-2-redis" tabindex="-1"><a class="header-anchor" href="#_1-1-2-redis"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_1-1-2-redis" target="_blank" rel="noopener noreferrer">#</a>1.1.2 Redis</span></a></h4><p>gateway服务下测试redis递增</p><p>long 1=incr(id&quot;)</p><p>long 2=incr(&quot;id&quot;)</p><p>当使用数据库来生成ID性能不够要求的时候，我们可以尝试使用Redis来生成ID。这主要依赖于Redis是单线程的，所以也可以用生成全局唯一的ID。可以用Redis的原子操作 INCR和INCRBY来实现。</p><p>优点：</p><p>1）不依赖于数据库，灵活方便，且性能优于数据库。</p><p>2）数字ID天然排序，对分页或者需要排序的结果很有帮助。 id long</p><p>缺点：</p><p>1）如果系统中没有Redis，还需要引入新的组件，增加系统复杂度。</p><p>2）需要编码和配置的工作量比较大。</p><p>3）网络传输造成性能下降。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211020153248879.a88d1e75.png" alt="image-20211020153248879"></p><h4 id="_1-1-3-开源算法snowflake" tabindex="-1"><a class="header-anchor" href="#_1-1-3-开源算法snowflake"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_1-1-3-%E5%BC%80%E6%BA%90%E7%AE%97%E6%B3%95snowflake" target="_blank" rel="noopener noreferrer">#</a>1.1.3 开源算法snowflake</span></a></h4><p>64位bit数字。详情见拓展资料。</p><p>1000000000000000000000000000000000000000000000000000000000000001</p><p>0 1010101010000000 0000100001 0000000001</p><p>0 1010101010000000 0000100001 0000000010</p><p>0 1010101010000011 0000100001 0000000001 4096</p><p>同一毫秒下同一机器 4096</p><p>同一机器1秒 4096000</p><p>snowflake是Twitter开源的分布式ID生成算法，结果是一个long型的ID。其核心思想是：使用41bit作为毫秒数，10bit作为机器的ID（5个bit是数据中心，5个bit的机器ID），12bit作为毫秒内的流水号（意味着每个节点在每毫秒可以产生 4096 个 ID），最后还有一个符号位，永远是0</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/4-2.93574354.png" alt="img"></p><p>优点：</p><ul><li>毫秒数在高位，自增序列在低位，整个ID都是趋势递增的。</li><li>不依赖数据库等第三方系统，以服务的方式部署，稳定性更高，生成ID的性能也是非常高的。</li><li>可以根据自身业务特性分配bit位，非常灵活。 32机房 32台goods</li></ul><p>缺点： 强依赖机器时钟，如果机器上时钟回拨，会导致发号重复或者服务会处于不可用状态。</p><p>我们在《元动力二奢》系统中采用的就是开源算法snowflake</p><h3 id="_1-2-snowflake快速入门-掌握" tabindex="-1"><a class="header-anchor" href="#_1-2-snowflake快速入门-掌握"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_1-2-snowflake%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8-%E6%8E%8C%E6%8F%A1" target="_blank" rel="noopener noreferrer">#</a>1.2 snowflake快速入门-掌握</span></a></h3><h4 id="_1-2-1-快速入门" tabindex="-1"><a class="header-anchor" href="#_1-2-1-快速入门"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_1-2-1-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8" target="_blank" rel="noopener noreferrer">#</a>1.2.1 快速入门</span></a></h4><p>（1）common下导入IdWorker工具类，方便其他模块调用。（2）编写代码</p><p>然后goods工程下，创建测试类。</p><p>观察特性：唯一性、增长性</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">IdWorker</span> idWorker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IdWorker</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">1000</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">long</span> id <span class="token operator">=</span> idWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-2-2-配置分布式id生成器" tabindex="-1"><a class="header-anchor" href="#_1-2-2-配置分布式id生成器"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_1-2-2-%E9%85%8D%E7%BD%AE%E5%88%86%E5%B8%83%E5%BC%8Fid%E7%94%9F%E6%88%90%E5%99%A8" target="_blank" rel="noopener noreferrer">#</a>1.2.2 配置分布式ID生成器</span></a></h4><p>（1）IdWorker.java拷贝到ydles_common工程com.ydles.util包中</p><p>（2）ydles_service_goods的application.yml添加配置</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">workerId</span><span class="token punctuation">:</span> <span class="token number">0</span></span>
<span class="line"><span class="token key atrule">datacenterId</span><span class="token punctuation">:</span> <span class="token number">0</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><p>（3）修改GoodsApplication，增加代码</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${workerId}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Integer</span> workerId<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${datacenterId}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Integer</span> datacenterId<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Bean</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">IdWorker</span> <span class="token function">idWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">IdWorker</span><span class="token punctuation">(</span>workerId<span class="token punctuation">,</span>datacenterId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-新增和修改商品" tabindex="-1"><a class="header-anchor" href="#_2-新增和修改商品"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-%E6%96%B0%E5%A2%9E%E5%92%8C%E4%BF%AE%E6%94%B9%E5%95%86%E5%93%81" target="_blank" rel="noopener noreferrer">#</a>2 新增和修改商品</span></a></h2><h3 id="_2-1-概念与表结构分析" tabindex="-1"><a class="header-anchor" href="#_2-1-概念与表结构分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-1-%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%A1%A8%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>2.1 概念与表结构分析</span></a></h3><h4 id="_2-1-1-spu与sku概念" tabindex="-1"><a class="header-anchor" href="#_2-1-1-spu与sku概念"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-1-1-spu%E4%B8%8Esku%E6%A6%82%E5%BF%B5" target="_blank" rel="noopener noreferrer">#</a>2.1.1 SPU与SKU概念</span></a></h4><p><strong>SPU = Standard Product Unit （标准产品单位）</strong></p><ul><li><p>概念 : SPU 是商品信息聚合的最小单位，是一组可复用、易检索的标准化信息的集合，该集合描述了一个产品的特性。</p></li><li><p>通俗点讲，属性值、特性相同的货品就可以称为一个 SPU</p><p>例如：<strong>华为P50 就是一个 SPU</strong></p><p>https://item.jd.com/100024533316.html</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211020111925671.072476dc.png" alt="image-20211020111925671"></p></li></ul><p><strong>SKU=stock keeping unit( 库存量单位)</strong></p><ul><li><p>SKU 即库存进出计量的单位， 可以是以件、盒、托盘等为单位。</p></li><li><p>SKU 是物理上不可分割的最小存货单元。在使用时要根据不同业态，不同管理模式来处理。</p></li><li><p>在服装、鞋类商品中使用最多最普遍。</p><p>例如：<strong>华为P50 红色 64G 就是一个 SKU</strong></p><p>华为P50 红色 8+64G 3000 就是一个 SKU。我们真实能买到的具有具体数据的一个物品。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20191207110032892.ed8dfc9d.png" alt="image-20191207110032892"></p></li></ul><h4 id="_2-1-2-表结构分析" tabindex="-1"><a class="header-anchor" href="#_2-1-2-表结构分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-1-2-%E8%A1%A8%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>2.1.2 表结构分析</span></a></h4><p>tb_spu 表 （SPU表）</p><table><thead><tr><th>字段名称</th><th>字段含义</th><th>字段类型</th><th>字段长度</th><th>备注</th></tr></thead><tbody><tr><td>id</td><td>主键</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>sn</td><td>货号</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>name</td><td>SPU名</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>caption</td><td>副标题</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>brand_id</td><td>品牌ID</td><td>INT</td><td></td><td></td></tr><tr><td>category1_id</td><td>一级分类</td><td>INT</td><td></td><td></td></tr><tr><td>category2_id</td><td>二级分类</td><td>INT</td><td></td><td></td></tr><tr><td>category3_id</td><td>三级分类</td><td>INT</td><td></td><td></td></tr><tr><td>template_id</td><td>模板ID</td><td>INT</td><td></td><td></td></tr><tr><td>freight_id</td><td>运费模板id</td><td>INT</td><td></td><td></td></tr><tr><td>img</td><td>图片</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>imgs</td><td>图片列表</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>sale_service</td><td>售后服务</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>introduction</td><td>介绍</td><td>TEXT</td><td></td><td></td></tr><tr><td>spec_items</td><td>规格列表</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>para_items</td><td>参数列表</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>sale_num</td><td>销量</td><td>INT</td><td></td><td></td></tr><tr><td>comment_num</td><td>评论数</td><td>INT</td><td></td><td></td></tr><tr><td>is_marketable</td><td>是否上架</td><td>CHAR</td><td></td><td></td></tr><tr><td>is_enable_spec</td><td>是否启用规格</td><td>CHAR</td><td></td><td></td></tr><tr><td>is_delete</td><td>是否删除</td><td>CHAR</td><td></td><td></td></tr><tr><td>status</td><td>审核状态</td><td>CHAR</td><td></td><td></td></tr></tbody></table><p>tb_sku 表（SKU商品表）</p><table><thead><tr><th>字段名称</th><th>字段含义</th><th>字段类型</th><th>字段长度</th><th>备注</th></tr></thead><tbody><tr><td>id</td><td>商品id</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>sn</td><td>商品条码</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>name</td><td>SKU名称</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>price</td><td>价格（分）</td><td>INT</td><td></td><td></td></tr><tr><td>num</td><td>库存数量</td><td>INT</td><td></td><td></td></tr><tr><td>alert_num</td><td>库存预警数量</td><td>INT</td><td></td><td></td></tr><tr><td>img</td><td>商品图片</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>imgs</td><td>商品图片列表</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>weight</td><td>重量（克）</td><td>INT</td><td></td><td></td></tr><tr><td>create_time</td><td>创建时间</td><td>DATETIME</td><td></td><td></td></tr><tr><td>update_time</td><td>更新时间</td><td>DATETIME</td><td></td><td></td></tr><tr><td>spu_id</td><td>SPUID</td><td>BIGINT</td><td></td><td></td></tr><tr><td>category_id</td><td>类目ID</td><td>INT</td><td></td><td></td></tr><tr><td>category_name</td><td>类目名称</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>brand_name</td><td>品牌名称</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>spec</td><td>规格</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>sale_num</td><td>销量</td><td>INT</td><td></td><td></td></tr><tr><td>comment_num</td><td>评论数</td><td>INT</td><td></td><td></td></tr><tr><td>status</td><td>商品状态 1-正常，2-下架，3-删除</td><td>CHAR</td><td></td><td></td></tr></tbody></table><h3 id="_2-2-实现思路" tabindex="-1"><a class="header-anchor" href="#_2-2-实现思路"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-2-%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF" target="_blank" rel="noopener noreferrer">#</a>2.2 实现思路</span></a></h3><p>前端传递给后端的数据格式 是一个spu对象和sku列表组成的对象</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;spu&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;PRADA包包2020秋季限量版&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;caption&quot;</span><span class="token operator">:</span> <span class="token string">&quot;PRADA最新包包&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;brandId&quot;</span><span class="token operator">:</span> <span class="token number">103</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;category1Id&quot;</span><span class="token operator">:</span> <span class="token number">903</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;category2Id&quot;</span><span class="token operator">:</span> <span class="token number">945</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;category3Id&quot;</span><span class="token operator">:</span> <span class="token number">946</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;freightId&quot;</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;image&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://img14.360buyimg.com/n1/jfs/t1/181065/5/3216/48663/6098c03fEad0ea4e5/659d59d79f8d0043.jpg&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;images&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://img14.360buyimg.com/n1/jfs/t1/181065/5/3216/48663/6098c03fEad0ea4e5/659d59d79f8d0043.jpg,//img14.360buyimg.com/n1/jfs/t1/198898/26/12864/27744/61655645E38886d5d/a27cd7700b92b5ca.jpg,https://img14.360buyimg.com/n1/jfs/t1/191847/24/2416/44441/6098c03fEfe505a38/b00b22b4e091f1c3.jpg&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;introduction&quot;</span><span class="token operator">:</span> <span class="token string">&quot;PRADA包包2020秋季限量版,抢完为止&quot;</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token property">&quot;paraItems&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{&quot;</span>出厂年份<span class="token string">&quot;:&quot;</span><span class="token number">2020</span><span class="token string">&quot;,&quot;</span>赠品<span class="token string">&quot;:&quot;</span>袋子<span class="token string">&quot;}&quot;</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token property">&quot;saleService&quot;</span><span class="token operator">:</span> <span class="token string">&quot;八天包退,闪电退货&quot;</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token property">&quot;sn&quot;</span><span class="token operator">:</span> <span class="token string">&quot;020102331&quot;</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token property">&quot;specItems&quot;</span><span class="token operator">:</span>  <span class="token string">&quot;{&quot;</span>颜色<span class="token string">&quot;:[&quot;</span>黑<span class="token string">&quot;,&quot;</span>蓝<span class="token string">&quot;],&quot;</span>二手程度<span class="token string">&quot;:[&quot;</span>崭新出厂<span class="token string">&quot;,&quot;</span>略有磨损<span class="token string">&quot;,&quot;</span>久经沙场<span class="token string">&quot;,&quot;</span>破损不堪<span class="token string">&quot;,&quot;</span>战痕累累<span class="token string">&quot;]}&quot;</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token property">&quot;templateId&quot;</span><span class="token operator">:</span> <span class="token number">42</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;skuList&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">         <span class="token property">&quot;sn&quot;</span><span class="token operator">:</span> <span class="token string">&quot;10192010293&quot;</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token property">&quot;num&quot;</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token property">&quot;alertNum&quot;</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token number">10000</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token property">&quot;spec&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{&quot;</span>颜色<span class="token string">&quot;:&quot;</span>黑<span class="token string">&quot;,&quot;</span>二手程度<span class="token string">&quot;:&quot;</span>崭新出厂<span class="token string">&quot;}&quot;</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token property">&quot;image&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://img14.360buyimg.com/n1/jfs/t1/181065/5/3216/48663/6098c03fEad0ea4e5/659d59d79f8d0043.jpg&quot;</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token property">&quot;images&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://img14.360buyimg.com/n1/jfs/t1/181065/5/3216/48663/6098c03fEad0ea4e5/659d59d79f8d0043.jpg,//img14.360buyimg.com/n1/jfs/t1/198898/26/12864/27744/61655645E38886d5d/a27cd7700b92b5ca.jpg,https://img14.360buyimg.com/n1/jfs/t1/191847/24/2416/44441/6098c03fEfe505a38/b00b22b4e091f1c3.jpg&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;weight&quot;</span><span class="token operator">:</span> <span class="token number">530</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;sn&quot;</span><span class="token operator">:</span> <span class="token string">&quot;10192010292&quot;</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token property">&quot;num&quot;</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token property">&quot;alertNum&quot;</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token number">8000</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token property">&quot;spec&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{&quot;</span>颜色<span class="token string">&quot;:&quot;</span>蓝色<span class="token string">&quot;,&quot;</span>二手程度<span class="token string">&quot;:&quot;</span>略有磨损<span class="token string">&quot;}&quot;</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token property">&quot;image&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://img14.360buyimg.com/n1/jfs/t1/181065/5/3216/48663/6098c03fEad0ea4e5/659d59d79f8d0043.jpg&quot;</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token property">&quot;images&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://img14.360buyimg.com/n1/jfs/t1/181065/5/3216/48663/6098c03fEad0ea4e5/659d59d79f8d0043.jpg,//img14.360buyimg.com/n1/jfs/t1/198898/26/12864/27744/61655645E38886d5d/a27cd7700b92b5ca.jpg,https://img14.360buyimg.com/n1/jfs/t1/191847/24/2416/44441/6098c03fEfe505a38/b00b22b4e091f1c3.jpg&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;weight&quot;</span><span class="token operator">:</span> <span class="token number">530</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;sn&quot;</span><span class="token operator">:</span> <span class="token string">&quot;10192010292&quot;</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token property">&quot;num&quot;</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token property">&quot;alertNum&quot;</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token number">4000</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token property">&quot;spec&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{&quot;</span>颜色<span class="token string">&quot;:&quot;</span>红色<span class="token string">&quot;,&quot;</span>二手程度<span class="token string">&quot;:&quot;</span>久经沙场<span class="token string">&quot;}&quot;</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token property">&quot;image&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://img14.360buyimg.com/n1/jfs/t1/181065/5/3216/48663/6098c03fEad0ea4e5/659d59d79f8d0043.jpg&quot;</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token property">&quot;images&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://img14.360buyimg.com/n1/jfs/t1/181065/5/3216/48663/6098c03fEad0ea4e5/659d59d79f8d0043.jpg,//img14.360buyimg.com/n1/jfs/t1/198898/26/12864/27744/61655645E38886d5d/a27cd7700b92b5ca.jpg,https://img14.360buyimg.com/n1/jfs/t1/191847/24/2416/44441/6098c03fEfe505a38/b00b22b4e091f1c3.jpg&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;weight&quot;</span><span class="token operator">:</span> <span class="token number">530</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">  <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3-代码实现-日常工作" tabindex="-1"><a class="header-anchor" href="#_2-3-代码实现-日常工作"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-3-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-%E6%97%A5%E5%B8%B8%E5%B7%A5%E4%BD%9C" target="_blank" rel="noopener noreferrer">#</a>2.3 代码实现-日常工作</span></a></h3><h4 id="_2-3-1-spu与sku列表的保存" tabindex="-1"><a class="header-anchor" href="#_2-3-1-spu与sku列表的保存"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-3-1-spu%E4%B8%8Esku%E5%88%97%E8%A1%A8%E7%9A%84%E4%BF%9D%E5%AD%98" target="_blank" rel="noopener noreferrer">#</a>2.3.1 SPU与SKU列表的保存</span></a></h4><p>代码实现：</p><p>（1）ydles_service_goods_api工程创建组合实体类Goods</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 商品组合实体类</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Goods</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Spu</span> spu<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Sku</span><span class="token punctuation">&gt;</span></span> skuList<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Spu</span> <span class="token function">getSpu</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> spu<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSpu</span><span class="token punctuation">(</span><span class="token class-name">Spu</span> spu<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>spu <span class="token operator">=</span> spu<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Sku</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSkuList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> skuList<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSkuList</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Sku</span><span class="token punctuation">&gt;</span></span> skuList<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>skuList <span class="token operator">=</span> skuList<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）ydles_service_goods工程SpuService新增方法add(Goods goods)</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token doc-comment comment">/***</span>
<span class="line">     * 新增</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">goods</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Goods</span> goods<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p>（3）ydles_service_goods工程SpuServiceImpl实现此方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">CategoryMapper</span> categoryMapper<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">SkuMapper</span> skuMapper<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">BrandMapper</span> brandMapper<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">IdWorker</span> idWorker<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 保存商品 SPU+SKU列表</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">goods</span> 商品组合实体类</span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@Transactional</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Goods</span> goods<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Spu</span> spu <span class="token operator">=</span> goods<span class="token punctuation">.</span><span class="token function">getSpu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">long</span> spuId <span class="token operator">=</span> idWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        spu<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>spuId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        spu<span class="token punctuation">.</span><span class="token function">setIsDelete</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        spu<span class="token punctuation">.</span><span class="token function">setIsMarketable</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        spu<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        spuMapper<span class="token punctuation">.</span><span class="token function">insertSelective</span><span class="token punctuation">(</span>spu<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//保存sku集合数据到数据库</span></span>
<span class="line">        <span class="token function">saveSkuList</span><span class="token punctuation">(</span>goods<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 保存sku列表</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">goods</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">saveSkuList</span><span class="token punctuation">(</span><span class="token class-name">Goods</span> goods<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//获取spu对象</span></span>
<span class="line">        <span class="token class-name">Spu</span> spu <span class="token operator">=</span> goods<span class="token punctuation">.</span><span class="token function">getSpu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//当前日期</span></span>
<span class="line">        <span class="token class-name">Date</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//获取品牌对象</span></span>
<span class="line">        <span class="token class-name">Brand</span> brand <span class="token operator">=</span> brandMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>spu<span class="token punctuation">.</span><span class="token function">getBrandId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//获取分类对象</span></span>
<span class="line">        <span class="token class-name">Category</span> category <span class="token operator">=</span> categoryMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>spu<span class="token punctuation">.</span><span class="token function">getCategory3Id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//获取sku集合对象</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Sku</span><span class="token punctuation">&gt;</span></span> skuList <span class="token operator">=</span> goods<span class="token punctuation">.</span><span class="token function">getSkuList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>skuList <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Sku</span> sku <span class="token operator">:</span> skuList<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">//设置sku主键ID</span></span>
<span class="line">                sku<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>idWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">//设置sku规格</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>sku<span class="token punctuation">.</span><span class="token function">getSpec</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>sku<span class="token punctuation">.</span><span class="token function">getSpec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    sku<span class="token punctuation">.</span><span class="token function">setSpec</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                <span class="token comment">//设置sku名称(商品名称 + 规格)</span></span>
<span class="line">                <span class="token class-name">String</span> name <span class="token operator">=</span> spu<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">//将规格json字符串转换成Map</span></span>
<span class="line">                <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> specMap <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>sku<span class="token punctuation">.</span><span class="token function">getSpec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>specMap <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> specMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">String</span> value <span class="token operator">:</span> specMap<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                        name <span class="token operator">+=</span> <span class="token string">&quot; &quot;</span><span class="token operator">+</span> value<span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">                sku<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//名称</span></span>
<span class="line">                sku<span class="token punctuation">.</span><span class="token function">setSpuId</span><span class="token punctuation">(</span>spu<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置spu的ID</span></span>
<span class="line">                sku<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建日期</span></span>
<span class="line">                sku<span class="token punctuation">.</span><span class="token function">setUpdateTime</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//修改日期</span></span>
<span class="line">                sku<span class="token punctuation">.</span><span class="token function">setCategoryId</span><span class="token punctuation">(</span>category<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//商品分类ID</span></span>
<span class="line">                sku<span class="token punctuation">.</span><span class="token function">setCategoryName</span><span class="token punctuation">(</span>category<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//商品分类名称</span></span>
<span class="line">                sku<span class="token punctuation">.</span><span class="token function">setBrandName</span><span class="token punctuation">(</span>brand<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//品牌名称</span></span>
<span class="line">                skuMapper<span class="token punctuation">.</span><span class="token function">insertSelective</span><span class="token punctuation">(</span>sku<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//插入sku表数据</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（3）修改SpuController的add方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token doc-comment comment">/***</span>
<span class="line">     * 新增数据</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">goods</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@PostMapping</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Goods</span> goods<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        spuService<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>goods<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span><span class="token string">&quot;添加成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10</p><h4 id="_2-3-2-品牌与分类关联" tabindex="-1"><a class="header-anchor" href="#_2-3-2-品牌与分类关联"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-3-2-%E5%93%81%E7%89%8C%E4%B8%8E%E5%88%86%E7%B1%BB%E5%85%B3%E8%81%94" target="_blank" rel="noopener noreferrer">#</a>2.3.2 品牌与分类关联</span></a></h4><p>实现思路：</p><p>将分类ID与SPU的品牌ID 一起插入到tb_category_brand表中</p><p>（1）创建实体类</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;tb_category_brand&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CategoryBrand</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Id</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Integer</span> categoryId<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Id</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Integer</span> brandId<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getCategoryId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> categoryId<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCategoryId</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> categoryId<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>categoryId <span class="token operator">=</span> categoryId<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getBrandId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> brandId<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setBrandId</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> brandId<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>brandId <span class="token operator">=</span> brandId<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个表是联合主键，所以templateId和brandId都有@Id注解</p><p>（2）新建数据访问接口</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CategoryBrandMapper</span> <span class="token keyword">extends</span> <span class="token class-name">Mapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryBrand</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><p>（3）SpuServiceImpl引入</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token annotation punctuation">@Autowired</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">CategoryBrandMapper</span> categoryBrandMapper<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><p>（4）修改SpuServiceImpl的saveSkuList方法，添加分类与品牌之间的关联, 修改后代码如下:</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">saveSkuList</span><span class="token punctuation">(</span><span class="token class-name">Goods</span> goods<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//获取spu对象</span></span>
<span class="line">        <span class="token class-name">Spu</span> spu <span class="token operator">=</span> goods<span class="token punctuation">.</span><span class="token function">getSpu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//当前日期</span></span>
<span class="line">        <span class="token class-name">Date</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//获取品牌对象</span></span>
<span class="line">        <span class="token class-name">Brand</span> brand <span class="token operator">=</span> brandMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>spu<span class="token punctuation">.</span><span class="token function">getBrandId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//获取分类对象</span></span>
<span class="line">        <span class="token class-name">Category</span> category <span class="token operator">=</span> categoryMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>spu<span class="token punctuation">.</span><span class="token function">getCategory3Id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token doc-comment comment">/**</span>
<span class="line">         * 添加分类与品牌之间的关联</span>
<span class="line">         */</span></span>
<span class="line">        <span class="token class-name">CategoryBrand</span> categoryBrand <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CategoryBrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        categoryBrand<span class="token punctuation">.</span><span class="token function">setBrandId</span><span class="token punctuation">(</span>spu<span class="token punctuation">.</span><span class="token function">getBrandId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        categoryBrand<span class="token punctuation">.</span><span class="token function">setCategoryId</span><span class="token punctuation">(</span>spu<span class="token punctuation">.</span><span class="token function">getCategory3Id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">int</span> count <span class="token operator">=</span> categoryBrandMapper<span class="token punctuation">.</span><span class="token function">selectCount</span><span class="token punctuation">(</span>categoryBrand<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//判断是否有这个品牌和分类的关系数据</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//如果没有关系数据则添加品牌和分类关系数据</span></span>
<span class="line">            categoryBrandMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>categoryBrand<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//获取sku集合对象</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Sku</span><span class="token punctuation">&gt;</span></span> skuList <span class="token operator">=</span> goods<span class="token punctuation">.</span><span class="token function">getSkuList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>skuList <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Sku</span> sku <span class="token operator">:</span> skuList<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">//设置sku主键ID</span></span>
<span class="line">                sku<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>idWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">//设置sku规格</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>sku<span class="token punctuation">.</span><span class="token function">getSpec</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>sku<span class="token punctuation">.</span><span class="token function">getSpec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    sku<span class="token punctuation">.</span><span class="token function">setSpec</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                <span class="token comment">//设置sku名称(商品名称 + 规格)</span></span>
<span class="line">                <span class="token class-name">String</span> name <span class="token operator">=</span> spu<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">//将规格json字符串转换成Map</span></span>
<span class="line">                <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> specMap <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>sku<span class="token punctuation">.</span><span class="token function">getSpec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>specMap <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> specMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">String</span> value <span class="token operator">:</span> specMap<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                        name <span class="token operator">+=</span> <span class="token string">&quot; &quot;</span><span class="token operator">+</span> value<span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">                sku<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//名称</span></span>
<span class="line">                sku<span class="token punctuation">.</span><span class="token function">setSpuId</span><span class="token punctuation">(</span>spu<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置spu的ID</span></span>
<span class="line">                sku<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建日期</span></span>
<span class="line">                sku<span class="token punctuation">.</span><span class="token function">setUpdateTime</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//修改日期</span></span>
<span class="line">                sku<span class="token punctuation">.</span><span class="token function">setCategoryId</span><span class="token punctuation">(</span>category<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//商品分类ID</span></span>
<span class="line">                sku<span class="token punctuation">.</span><span class="token function">setCategoryName</span><span class="token punctuation">(</span>category<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//商品分类名称</span></span>
<span class="line">                sku<span class="token punctuation">.</span><span class="token function">setBrandName</span><span class="token punctuation">(</span>brand<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//品牌名称</span></span>
<span class="line">                skuMapper<span class="token punctuation">.</span><span class="token function">insertSelective</span><span class="token punctuation">(</span>sku<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//插入sku表数据</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-3-3-根据id查询商品" tabindex="-1"><a class="header-anchor" href="#_2-3-3-根据id查询商品"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-3-3-%E6%A0%B9%E6%8D%AEid%E6%9F%A5%E8%AF%A2%E5%95%86%E5%93%81" target="_blank" rel="noopener noreferrer">#</a>2.3.3 根据ID查询商品</span></a></h4><p>需求：根据id 查询SPU和SKU列表 ，显示效果如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token string">&quot;spu&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token string">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;12312312312&quot;</span></span>
<span class="line">        <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;PRADA包包2021秋季限量版&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;caption&quot;</span><span class="token operator">:</span> <span class="token string">&quot;PRADA最新包包&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;brandId&quot;</span><span class="token operator">:</span> <span class="token number">103</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;category1Id&quot;</span><span class="token operator">:</span> <span class="token number">903</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;category2Id&quot;</span><span class="token operator">:</span> <span class="token number">945</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;category3Id&quot;</span><span class="token operator">:</span> <span class="token number">946</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;freightId&quot;</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;img&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://img14.360buyimg.com/n1/jfs/t1/181065/5/3216/48663/6098c03fEad0ea4e5/659d59d79f8d0043.jpg&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;imgs&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://img14.360buyimg.com/n1/jfs/t1/181065/5/3216/48663/6098c03fEad0ea4e5/659d59d79f8d0043.jpg,//img14.360buyimg.com/n1/jfs/t1/198898/26/12864/27744/61655645E38886d5d/a27cd7700b92b5ca.jpg,https://img14.360buyimg.com/n1/jfs/t1/191847/24/2416/44441/6098c03fEfe505a38/b00b22b4e091f1c3.jpg&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;introduction&quot;</span><span class="token operator">:</span> <span class="token string">&quot;商品介绍&quot;</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token string">&quot;paraItems&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{&quot;</span>出厂年份<span class="token string">&quot;:&quot;</span><span class="token number">2020</span><span class="token string">&quot;,&quot;</span>赠品<span class="token string">&quot;:&quot;</span>袋子<span class="token string">&quot;}&quot;</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token string">&quot;saleService&quot;</span><span class="token operator">:</span> <span class="token string">&quot;七天包退,闪电退货&quot;</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token string">&quot;sn&quot;</span><span class="token operator">:</span> <span class="token string">&quot;020102331&quot;</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token string">&quot;specItems&quot;</span><span class="token operator">:</span>  <span class="token string">&quot;{&quot;</span>颜色<span class="token string">&quot;:[&quot;</span>黑<span class="token string">&quot;,&quot;</span>蓝<span class="token string">&quot;],&quot;</span>二手程度<span class="token string">&quot;:[&quot;</span>崭新出厂<span class="token string">&quot;,&quot;</span>略有磨损<span class="token string">&quot;,&quot;</span>久经沙场<span class="token string">&quot;,&quot;</span>破损不堪<span class="token string">&quot;,&quot;</span>战痕累累<span class="token string">&quot;]}&quot;</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token string">&quot;templateId&quot;</span><span class="token operator">:</span> <span class="token number">42</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">&quot;skuList&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">         <span class="token string">&quot;sn&quot;</span><span class="token operator">:</span> <span class="token string">&quot;10192010293&quot;</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token string">&quot;num&quot;</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token string">&quot;alertNum&quot;</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token string">&quot;price&quot;</span><span class="token operator">:</span> <span class="token number">10000</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token string">&quot;spec&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{&quot;</span>颜色<span class="token string">&quot;:&quot;</span>黑<span class="token string">&quot;,&quot;</span>二手程度<span class="token string">&quot;:&quot;</span>崭新出厂<span class="token string">&quot;}&quot;</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token string">&quot;img&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://img14.360buyimg.com/n1/jfs/t1/181065/5/3216/48663/6098c03fEad0ea4e5/659d59d79f8d0043.jpg&quot;</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token string">&quot;imgs&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://img14.360buyimg.com/n1/jfs/t1/181065/5/3216/48663/6098c03fEad0ea4e5/659d59d79f8d0043.jpg,//img14.360buyimg.com/n1/jfs/t1/198898/26/12864/27744/61655645E38886d5d/a27cd7700b92b5ca.jpg,https://img14.360buyimg.com/n1/jfs/t1/191847/24/2416/44441/6098c03fEfe505a38/b00b22b4e091f1c3.jpg&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;status&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;weight&quot;</span><span class="token operator">:</span> <span class="token number">530</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">        <span class="token string">&quot;sn&quot;</span><span class="token operator">:</span> <span class="token string">&quot;10192010292&quot;</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token string">&quot;num&quot;</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token string">&quot;alertNum&quot;</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token string">&quot;price&quot;</span><span class="token operator">:</span> <span class="token number">5000</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token string">&quot;spec&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{&quot;</span>颜色<span class="token string">&quot;:&quot;</span>黑<span class="token string">&quot;,&quot;</span>二手程度<span class="token string">&quot;:&quot;</span>战痕累累<span class="token string">&quot;}&quot;</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token string">&quot;img&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://img14.360buyimg.com/n1/jfs/t1/181065/5/3216/48663/6098c03fEad0ea4e5/659d59d79f8d0043.jpg&quot;</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token string">&quot;imgs&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://img14.360buyimg.com/n1/jfs/t1/181065/5/3216/48663/6098c03fEad0ea4e5/659d59d79f8d0043.jpg,//img14.360buyimg.com/n1/jfs/t1/198898/26/12864/27744/61655645E38886d5d/a27cd7700b92b5ca.jpg,https://img14.360buyimg.com/n1/jfs/t1/191847/24/2416/44441/6098c03fEfe505a38/b00b22b4e091f1c3.jpg&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;status&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;weight&quot;</span><span class="token operator">:</span> <span class="token number">530</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>代码实现：</p><p>（1）ydles_service_goods工程SpuService新增方法定义</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 根据ID查询商品</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">id</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Goods</span> <span class="token function">findGoodsById</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）ydles_service_goods工程SpuServiceImpl实现此方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 根据ID查询商品</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">id</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Goods</span> <span class="token function">findGoodsById</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//查询spu</span></span>
<span class="line">        <span class="token class-name">Spu</span> spu <span class="token operator">=</span> spuMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//查询SKU 列表</span></span>
<span class="line">        <span class="token class-name">Example</span> example<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Example</span><span class="token punctuation">(</span><span class="token class-name">Sku</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Example<span class="token punctuation">.</span>Criteria</span> criteria <span class="token operator">=</span> example<span class="token punctuation">.</span><span class="token function">createCriteria</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        criteria<span class="token punctuation">.</span><span class="token function">andEqualTo</span><span class="token punctuation">(</span><span class="token string">&quot;spuId&quot;</span><span class="token punctuation">,</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Sku</span><span class="token punctuation">&gt;</span></span> skuList <span class="token operator">=</span> skuMapper<span class="token punctuation">.</span><span class="token function">selectByExample</span><span class="token punctuation">(</span>example<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">//封装，返回</span></span>
<span class="line">        <span class="token class-name">Goods</span> goods<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Goods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        goods<span class="token punctuation">.</span><span class="token function">setSpu</span><span class="token punctuation">(</span>spu<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        goods<span class="token punctuation">.</span><span class="token function">setSkuList</span><span class="token punctuation">(</span>skuList<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> goods<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（3）修改SpuController的findById方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/{id}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Goods</span> goods <span class="token operator">=</span> spuService<span class="token punctuation">.</span><span class="token function">findGoodsById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span><span class="token string">&quot;查询成功&quot;</span><span class="token punctuation">,</span>goods<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><h4 id="_2-3-4-保存修改" tabindex="-1"><a class="header-anchor" href="#_2-3-4-保存修改"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-3-4-%E4%BF%9D%E5%AD%98%E4%BF%AE%E6%94%B9" target="_blank" rel="noopener noreferrer">#</a>2.3.4 保存修改</span></a></h4><p>（1）ydles_service_goods工程SpuService新增方法定义</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token doc-comment comment">/***</span>
<span class="line">     * 修改数据</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">spu</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Goods</span> goods<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p>（2）ydles_service_goods工程SpuServiceImpl实现此方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Goods</span> goods <span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//取出spu部分</span></span>
<span class="line">        <span class="token class-name">Spu</span> spu <span class="token operator">=</span> goods<span class="token punctuation">.</span><span class="token function">getSpu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        spuMapper<span class="token punctuation">.</span><span class="token function">updateByPrimaryKey</span><span class="token punctuation">(</span>spu<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//删除原sku列表</span></span>
<span class="line">        <span class="token class-name">Example</span> example<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Example</span><span class="token punctuation">(</span><span class="token class-name">Sku</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Example<span class="token punctuation">.</span>Criteria</span> criteria <span class="token operator">=</span> example<span class="token punctuation">.</span><span class="token function">createCriteria</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        criteria<span class="token punctuation">.</span><span class="token function">andEqualTo</span><span class="token punctuation">(</span><span class="token string">&quot;spuId&quot;</span><span class="token punctuation">,</span>spu<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        skuMapper<span class="token punctuation">.</span><span class="token function">deleteByExample</span><span class="token punctuation">(</span>example<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token function">saveSkuList</span><span class="token punctuation">(</span>goods<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//保存sku列表</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（3）修改SpuController的update方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token doc-comment comment">/***</span>
<span class="line">     * 修改数据</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">goods</span></span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">id</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@PutMapping</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">&quot;/{id}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Goods</span> goods<span class="token punctuation">,</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        spuService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>goods<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span><span class="token string">&quot;修改成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11</p><h2 id="_3-商品审核与上下架-日常工作" tabindex="-1"><a class="header-anchor" href="#_3-商品审核与上下架-日常工作"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-%E5%95%86%E5%93%81%E5%AE%A1%E6%A0%B8%E4%B8%8E%E4%B8%8A%E4%B8%8B%E6%9E%B6-%E6%97%A5%E5%B8%B8%E5%B7%A5%E4%BD%9C" target="_blank" rel="noopener noreferrer">#</a>3 商品审核与上下架-日常工作</span></a></h2><h3 id="_3-1-需求分析" tabindex="-1"><a class="header-anchor" href="#_3-1-需求分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>3.1 需求分析</span></a></h3><p>商品指spu</p><p>1商品新增后，审核状态为0（未审核），默认为下架状态。</p><p>2审核商品，需要校验是否是被删除的商品，如果未删除则修改审核状态为1，并自动上架。</p><p>3下架商品，需要校验是否是被删除的商品，如果未删除则修改上架状态为0</p><p>4上架商品，需要审核状态为1,如果为1,则更改上下架状态为1</p><h3 id="_3-2-实现思路" tabindex="-1"><a class="header-anchor" href="#_3-2-实现思路"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-2-%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF" target="_blank" rel="noopener noreferrer">#</a>3.2 实现思路</span></a></h3><p>（1）按照ID查询SPU信息</p><p>（2）判断修改审核、上架下架状态</p><p>（3）保存SPU</p><h3 id="_3-3-代码实现" tabindex="-1"><a class="header-anchor" href="#_3-3-代码实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-3-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>3.3 代码实现</span></a></h3><h4 id="_3-3-1-商品审核" tabindex="-1"><a class="header-anchor" href="#_3-3-1-商品审核"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-3-1-%E5%95%86%E5%93%81%E5%AE%A1%E6%A0%B8" target="_blank" rel="noopener noreferrer">#</a>3.3.1 商品审核</span></a></h4><p><strong>需求</strong>：校验是否是被删除的商品，如果未删除则修改审核状态为1，并自动上架</p><p>/audit/{id}</p><p><strong>回顾</strong>，updateByPrimaryKey与updateByPrimaryKeySelective区别。</p><p>（1）SpuService新增方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 审核</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">id</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">audit</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p>（2）SpuServiceImpl实现方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">	<span class="token annotation punctuation">@Transactional</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">audit</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//查询spu对象</span></span>
<span class="line">        <span class="token class-name">Spu</span> spu <span class="token operator">=</span> spuMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>spu <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;当前商品不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token comment">//判断当前spu是否处于删除状态</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>spu<span class="token punctuation">.</span><span class="token function">getIsDelete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;当前商品处于删除状态&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token comment">//不处于删除状态,修改审核状态为1,上下架状态为1</span></span>
<span class="line">        spu<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        spu<span class="token punctuation">.</span><span class="token function">setIsMarketable</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//执行修改操作</span></span>
<span class="line">        spuMapper<span class="token punctuation">.</span><span class="token function">updateByPrimaryKeySelective</span><span class="token punctuation">(</span>spu<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）SpuController新增方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 审核</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">id</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@PutMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/audit/{id}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">audit</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        spuService<span class="token punctuation">.</span><span class="token function">audit</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试</p><h4 id="_3-3-2-下架商品" tabindex="-1"><a class="header-anchor" href="#_3-3-2-下架商品"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-3-2-%E4%B8%8B%E6%9E%B6%E5%95%86%E5%93%81" target="_blank" rel="noopener noreferrer">#</a>3.3.2 下架商品</span></a></h4><p><strong>需求</strong>：校验是否是被删除的商品，如果未删除则修改上架状态为0</p><p>/pull/{id}</p><p>（1）SpuService新增方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 下架商品</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">id</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">pull</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p>（2）SpuServiceImpl实现方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Transactional</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">pull</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//查询spu</span></span>
<span class="line">        <span class="token class-name">Spu</span> spu <span class="token operator">=</span> spuMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>spu <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;当前商品不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token comment">//判断当前商品是否处于删除状态</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>spu<span class="token punctuation">.</span><span class="token function">getIsDelete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;当前商品处于删除状态&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token comment">//商品处于未删除状态的话,则修改上下架状态为已下架(0)</span></span>
<span class="line">        spu<span class="token punctuation">.</span><span class="token function">setIsMarketable</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        spuMapper<span class="token punctuation">.</span><span class="token function">updateByPrimaryKeySelective</span><span class="token punctuation">(</span>spu<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）SpuController新增方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 下架</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">id</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@PutMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/pull/{id}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">pull</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        spuService<span class="token punctuation">.</span><span class="token function">pull</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试</p><h4 id="_3-3-3-上架商品" tabindex="-1"><a class="header-anchor" href="#_3-3-3-上架商品"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-3-3-%E4%B8%8A%E6%9E%B6%E5%95%86%E5%93%81" target="_blank" rel="noopener noreferrer">#</a>3.3.3 上架商品</span></a></h4><p>需求：必须是通过审核的商品才能上架</p><p>/put/{id}</p><p>（1）SpuService新增方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 上架商品</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">id</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p>（2）SpuServiceImpl 实现此方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 上架商品</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">id</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Spu</span> spu <span class="token operator">=</span> spuMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>spu<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;未通过审核的商品不能上架！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        spu<span class="token punctuation">.</span><span class="token function">setIsMarketable</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//上架状态</span></span>
<span class="line">        spuMapper<span class="token punctuation">.</span><span class="token function">updateByPrimaryKeySelective</span><span class="token punctuation">(</span>spu<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（3）SpuController新增方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 上架</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">id</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@PutMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/put/{id}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        spuService<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10</p><p>测试</p><h2 id="_4-删除与还原商品-日常工作" tabindex="-1"><a class="header-anchor" href="#_4-删除与还原商品-日常工作"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_4-%E5%88%A0%E9%99%A4%E4%B8%8E%E8%BF%98%E5%8E%9F%E5%95%86%E5%93%81-%E6%97%A5%E5%B8%B8%E5%B7%A5%E4%BD%9C" target="_blank" rel="noopener noreferrer">#</a>4 删除与还原商品-日常工作</span></a></h2><h3 id="_4-1-需求分析-1" tabindex="-1"><a class="header-anchor" href="#_4-1-需求分析-1"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_4-1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90-1" target="_blank" rel="noopener noreferrer">#</a>4.1 需求分析</span></a></h3><p>商品列表中的删除商品功能，并非真正的删除(物理删除)，而是采用逻辑删除将删除标记的字段设置为1.</p><p>在回收站中有还原商品的功能，将删除标记的字段设置为0</p><p>在回收站中有删除商品的功能，是真正的物理删除,将数据从数据库中删除掉。</p><h3 id="_4-2-实现思路" tabindex="-1"><a class="header-anchor" href="#_4-2-实现思路"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_4-2-%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF" target="_blank" rel="noopener noreferrer">#</a>4.2 实现思路</span></a></h3><p>商品列表中的删除商品,执行逻辑删除，修改spu表is_delete字段为1</p><p>商品回收站中的还原商品,修改spu表is_delete字段为0</p><p>商品回收站中的删除商品,执行delete操作,进行物理删除</p><h3 id="_4-3-代码实现-1" tabindex="-1"><a class="header-anchor" href="#_4-3-代码实现-1"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_4-3-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-1" target="_blank" rel="noopener noreferrer">#</a>4.3 代码实现</span></a></h3><h4 id="_4-3-1-逻辑删除商品" tabindex="-1"><a class="header-anchor" href="#_4-3-1-逻辑删除商品"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_4-3-1-%E9%80%BB%E8%BE%91%E5%88%A0%E9%99%A4%E5%95%86%E5%93%81" target="_blank" rel="noopener noreferrer">#</a>4.3.1 逻辑删除商品</span></a></h4><p><strong>需求</strong>：商品列表中的删除商品,执行逻辑删除，判断其已下架，修改spu表is_delete字段为1。</p><p>SpuController</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token annotation punctuation">@DeleteMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/{id}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        spuService<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">StatusCode</span><span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span> <span class="token string">&quot;删除成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p>SpuService</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>SpuServiceImpl</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token annotation punctuation">@Transactional</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//逻辑删除</span></span>
<span class="line">        <span class="token comment">//查询spu</span></span>
<span class="line">    <span class="token class-name">Spu</span> spu <span class="token operator">=</span> spuMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//判断是否处于下架</span></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>spu<span class="token punctuation">.</span><span class="token function">getIsMarketable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;下架状态才能删除商品&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//是下架状态 经行软删除</span></span>
<span class="line">    spu<span class="token punctuation">.</span><span class="token function">setIsDelete</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    spu<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">//存入数据库</span></span>
<span class="line">    spuMapper<span class="token punctuation">.</span><span class="token function">updateByPrimaryKeySelective</span><span class="token punctuation">(</span>spu<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试</p><h4 id="_4-3-2-还原被删除的商品" tabindex="-1"><a class="header-anchor" href="#_4-3-2-还原被删除的商品"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_4-3-2-%E8%BF%98%E5%8E%9F%E8%A2%AB%E5%88%A0%E9%99%A4%E7%9A%84%E5%95%86%E5%93%81" target="_blank" rel="noopener noreferrer">#</a>4.3.2 还原被删除的商品</span></a></h4><p>回收站显示数据：select * from spu where is_delete=1</p><p><strong>需求</strong>：恢复已删除状态的商品，设置其已删除属性为0，未审核。</p><p>/restore/{id}</p><p>（1）SpuService新增方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 恢复数据</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">id</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">restore</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p>（2）SpuServiceImpl实现此方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 恢复数据</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">id</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">restore</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Spu</span> spu <span class="token operator">=</span> spuMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//检查是否删除的商品</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>spu<span class="token punctuation">.</span><span class="token function">getIsDelete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;此商品未删除！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        spu<span class="token punctuation">.</span><span class="token function">setIsDelete</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//未删除</span></span>
<span class="line">        spu<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//未审核</span></span>
<span class="line">        spuMapper<span class="token punctuation">.</span><span class="token function">updateByPrimaryKeySelective</span><span class="token punctuation">(</span>spu<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span>    </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15</p><p>（3）SpuController新增方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 恢复数据</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">id</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@PutMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/restore/{id}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">restore</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        spuService<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10</p><h4 id="_4-3-3-物理删除商品" tabindex="-1"><a class="header-anchor" href="#_4-3-3-物理删除商品"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_4-3-3-%E7%89%A9%E7%90%86%E5%88%A0%E9%99%A4%E5%95%86%E5%93%81" target="_blank" rel="noopener noreferrer">#</a>4.3.3 物理删除商品</span></a></h4><p>需求：判断必须逻辑删除商品才能物理删除</p><p>（1）SpuService 新增方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 物理删除</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">id</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">realDelete</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5</p><p>（2）SpuServiceImpl 实现方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">realDelete</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Spu</span> spu <span class="token operator">=</span> spuMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//检查是否删除的商品</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>spu<span class="token punctuation">.</span><span class="token function">getIsDelete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;此商品未删除！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        spuMapper<span class="token punctuation">.</span><span class="token function">deleteByPrimaryKey</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10</p><p>（3）SpuController新增方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 物理删除</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token parameter">id</span></span>
<span class="line">     * <span class="token keyword">@return</span></span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@DeleteMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/realDelete/{id}&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">realDelete</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        spuService<span class="token punctuation">.</span><span class="token function">realDelete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10</p><p>测试</p><p>总结：</p><p>1分布式id</p><p>为什么：同一个模块，分布式部署，需要不重复的id</p><p>怎么做：uuid redis 雪花算法</p><p>二奢 idworker</p><p>2crud</p><p>spu---&gt;sku(spuId)</p><p>iphone 13-----&gt;8+128 5000,8+512 8000</p><p>增：goods(spu,skuList) 品牌分类关联</p><p>删: 逻辑 还原 物理删除</p><p>改：原来sku关联删除掉，新增</p><p>查：id</p><h2 id="第5章-网站首页高可用-nginx-lua" tabindex="-1"><a class="header-anchor" href="#第5章-网站首页高可用-nginx-lua"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#%E7%AC%AC5%E7%AB%A0-%E7%BD%91%E7%AB%99%E9%A6%96%E9%A1%B5%E9%AB%98%E5%8F%AF%E7%94%A8-nginx-lua" target="_blank" rel="noopener noreferrer">#</a>第5章 网站首页高可用 nginx+lua</span></a></h2><p><strong>角色</strong>：<strong>运维</strong>。linux简单的命令，vim基本操作。</p><h2 id="学习目标-3" tabindex="-1"><a class="header-anchor" href="#学习目标-3"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87-3" target="_blank" rel="noopener noreferrer">#</a>学习目标</span></a></h2><ul><li>了解Lua语言的基本语法</li><li>使用nginx+Lua+redis实现广告缓存-重点</li><li>掌握nginx限流的基本使用方法</li></ul><h2 id="_1-lua介绍" tabindex="-1"><a class="header-anchor" href="#_1-lua介绍"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_1-lua%E4%BB%8B%E7%BB%8D" target="_blank" rel="noopener noreferrer">#</a>1 Lua介绍</span></a></h2><h3 id="_1-1-lua是什么" tabindex="-1"><a class="header-anchor" href="#_1-1-lua是什么"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_1-1-lua%E6%98%AF%E4%BB%80%E4%B9%88" target="_blank" rel="noopener noreferrer">#</a>1.1 lua是什么</span></a></h3><p>Lua 是一个小巧的**<a href="https://baike.baidu.com/item/%E8%84%9A%E6%9C%AC%E8%AF%AD%E8%A8%80" target="_blank" rel="noopener noreferrer">脚本语言open in new window</a>**。 html js python 弱类型语言</p><p>简单来说：</p><p>Lua 是一种轻量小巧的脚本语言，用标准C语言编写并以源代码形式开放， 其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。</p><p><strong>lua 语言具有以下特性</strong></p><ul><li>支持<strong>面向过程</strong>(procedure-oriented)编程和<strong>函数式编程</strong>(functional programming)；</li><li>自动内存管理；只提供了一种通用类型的表（table），用它可以实现数组，哈希表，集合，对象；</li><li>语言内置模式匹配；闭包(closure)；函数也可以看做一个值；提供多线程（协同进程，并非操作系统所支持的线程）支持；</li><li>通过闭包和table可以很方便地支持面向对象编程所需要的一些关键机制，比如数据抽象，虚函数，继承和重载等。</li></ul><p><strong>应用场景</strong></p><ul><li>游戏开发</li><li>独立应用脚本</li><li>Web 应用脚本</li><li>扩展和数据库插件如：MySQL Proxy 和 MySQL WorkBench</li><li>安全系统，如入侵检测系统</li><li>redis中嵌套调用实现类似事务的功能。 redis 注入 lua脚本，redis增强。 incr(&quot;id&quot;)</li><li>web容器中应用处理一些过滤 缓存等等的逻辑，例如nginx。</li></ul><h3 id="_1-2-lua的安装" tabindex="-1"><a class="header-anchor" href="#_1-2-lua的安装"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_1-2-lua%E7%9A%84%E5%AE%89%E8%A3%85" target="_blank" rel="noopener noreferrer">#</a>1.2 lua的安装</span></a></h3><p>虚拟机中已安装。建议对照pdf自己安装。</p><p>有linux版本的安装也有mac版本的安装。。我们采用linux版本的安装，首先我们准备一个linux虚拟机。</p><p>安装步骤,在linux系统中执行下面的命令。</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">yum <span class="token function">install</span> <span class="token parameter variable">-y</span> gcc</span>
<span class="line"></span>
<span class="line">yum <span class="token function">install</span> libtermcap-devel ncurses-devel libevent-devel readline-devel</span>
<span class="line"></span>
<span class="line"><span class="token function">curl</span> <span class="token parameter variable">-R</span> <span class="token parameter variable">-O</span> http://www.lua.org/ftp/lua-5.3.5.tar.gz</span>
<span class="line"></span>
<span class="line"><span class="token function">tar</span> <span class="token parameter variable">-zxf</span> lua-5.3.5.tar.gz</span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">cd</span> lua-5.3.5</span>
<span class="line"></span>
<span class="line"><span class="token function">make</span> linux <span class="token builtin class-name">test</span></span>
<span class="line"></span>
<span class="line"><span class="token function">make</span> <span class="token function">install</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13</p><h3 id="_1-3-快速入门" tabindex="-1"><a class="header-anchor" href="#_1-3-快速入门"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_1-3-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8" target="_blank" rel="noopener noreferrer">#</a>1.3 快速入门</span></a></h3><p>创建hello.lua文件，内容为</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">print(&quot;hello&quot;);</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>保存。执行命令</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">lua helloworld.lua</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>输出为：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">Hello</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><h3 id="_1-4-lua的基本语法" tabindex="-1"><a class="header-anchor" href="#_1-4-lua的基本语法"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_1-4-lua%E7%9A%84%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95" target="_blank" rel="noopener noreferrer">#</a>1.4 LUA的基本语法</span></a></h3><ul><li>lua有交互式编程和脚本式编程。</li><li>交互式编程就是直接输入语法，就能执行。</li><li>脚本式编程需要编写脚本文件，然后再执行。</li></ul><p>一般采用脚本式编程。（例如：编写一个hello.lua的文件，输入文件内容，并执行lua hell.lua即可）</p><p><strong>拓展</strong>：编写lua脚本。回忆linux基本操作。vim基本操作。参见拓展资料。</p><p>linux:https://www.runoob.com/linux/linux-command-manual.html</p><p>vim:https://blog.csdn.net/weixin_37657720/article/details/80645991</p><h4 id="_1-4-1-注释" tabindex="-1"><a class="header-anchor" href="#_1-4-1-注释"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_1-4-1-%E6%B3%A8%E9%87%8A" target="_blank" rel="noopener noreferrer">#</a>1.4.1 注释</span></a></h4><p>单行注释：两个减号是单行注释:</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">--</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>多行注释：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">--[[</span>
<span class="line"> 多行注释</span>
<span class="line"> 多行注释</span>
<span class="line">--]]</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><h4 id="_1-4-2-关键字" tabindex="-1"><a class="header-anchor" href="#_1-4-2-关键字"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_1-4-2-%E5%85%B3%E9%94%AE%E5%AD%97" target="_blank" rel="noopener noreferrer">#</a>1.4.2 关键字</span></a></h4><p>关键字就好比java中的 break if else等等一样的效果。lua的关键字如下：</p><table><thead><tr><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><td>and</td><td>break</td><td>do</td><td>else</td></tr><tr><td>elseif</td><td>end</td><td>false</td><td>for</td></tr><tr><td>function</td><td>if</td><td>in</td><td>local</td></tr><tr><td>nil</td><td>not</td><td>or</td><td>repeat</td></tr><tr><td>return</td><td>then</td><td>true</td><td>until</td></tr><tr><td>while</td><td></td><td></td><td></td></tr></tbody></table><h4 id="_1-4-3-定义变量" tabindex="-1"><a class="header-anchor" href="#_1-4-3-定义变量"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_1-4-3-%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F" target="_blank" rel="noopener noreferrer">#</a>1.4.3 定义变量</span></a></h4><p>全局变量，默认的情况下，定义一个变量都是全局变量，</p><p>如果要用局部变量 需要声明为local.例如：</p><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line"><span class="token comment">-- 全局变量赋值</span></span>
<span class="line">a<span class="token operator">=</span><span class="token number">1</span></span>
<span class="line"><span class="token comment">-- 局部变量赋值</span></span>
<span class="line"><span class="token keyword">local</span> b<span class="token operator">=</span><span class="token number">2</span> </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4</p><p>如果变量没有初始化：则 它的值为<strong>nil</strong> 这和java中的null不同。</p><h4 id="_1-4-4-lua中的数据类型" tabindex="-1"><a class="header-anchor" href="#_1-4-4-lua中的数据类型"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_1-4-4-lua%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B" target="_blank" rel="noopener noreferrer">#</a>1.4.4 Lua中的数据类型</span></a></h4><p>Lua 是<strong>动态类型语言</strong>，变量不要类型定义,只需要为变量赋值。 值可以存储在变量中，作为参数传递或结果返回。</p><p>Lua 中有 8 个基本类型分别为：nil、boolean、number、string、userdata、function、thread 和 table。</p><table><thead><tr><th>数据类型</th><th>描述</th></tr></thead><tbody><tr><td>nil</td><td>这个最简单，只有值nil属于该类，表示一个无效值（在条件表达式中相当于false）。</td></tr><tr><td>boolean</td><td>包含两个值：false和true。</td></tr><tr><td>number</td><td>表示双精度类型的实浮点数</td></tr><tr><td>string</td><td>字符串由一对双引号或单引号来表示</td></tr><tr><td>function</td><td>由 C 或 Lua 编写的函数</td></tr><tr><td>userdata</td><td>表示任意存储在变量中的C数据结构</td></tr><tr><td>thread</td><td>表示执行的独立线路，用于执行协同程序</td></tr><tr><td>table</td><td>Lua 中的表（table）其实是一个&quot;关联数组&quot;（associative arrays），数组的索引可以是数字、字符串或表类型。在 Lua 里，table 的创建是通过&quot;构造表达式&quot;来完成，最简单构造表达式是{}，用来创建一个空表。</td></tr></tbody></table><h4 id="_1-4-5-流程控制" tabindex="-1"><a class="header-anchor" href="#_1-4-5-流程控制"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_1-4-5-%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6" target="_blank" rel="noopener noreferrer">#</a>1.4.5 流程控制</span></a></h4><p>如下：类似于if else</p><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line"><span class="token comment">--[ 0 为 true ]</span></span>
<span class="line"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">then</span></span>
<span class="line">    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;0 为 true&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">else</span></span>
<span class="line">    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;0 不为true&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">end</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6</p><p>执行:</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">lua hello.lua</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>结果：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">0为true</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><h4 id="_1-4-6-函数" tabindex="-1"><a class="header-anchor" href="#_1-4-6-函数"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_1-4-6-%E5%87%BD%E6%95%B0" target="_blank" rel="noopener noreferrer">#</a>1.4.6 函数</span></a></h4><p>lua中也可以定义函数，类似于java中的方法。例如：</p><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line"><span class="token comment">--[[ 函数返回两个值的最大值 --]]</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">max</span><span class="token punctuation">(</span>num1<span class="token punctuation">,</span> num2<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">   <span class="token keyword">if</span> <span class="token punctuation">(</span>num1 <span class="token operator">&gt;</span> num2<span class="token punctuation">)</span> <span class="token keyword">then</span></span>
<span class="line">      result <span class="token operator">=</span> num1<span class="token punctuation">;</span></span>
<span class="line">   <span class="token keyword">else</span></span>
<span class="line">      result <span class="token operator">=</span> num2<span class="token punctuation">;</span></span>
<span class="line">   <span class="token keyword">end</span></span>
<span class="line"></span>
<span class="line">   <span class="token keyword">return</span> result<span class="token punctuation">;</span> </span>
<span class="line"><span class="token keyword">end</span></span>
<span class="line"><span class="token comment">-- 调用函数</span></span>
<span class="line"><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;两值比较最大值为 &quot;</span><span class="token punctuation">,</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;两值比较最大值为 &quot;</span><span class="token punctuation">,</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6 7 8 9 10 11 12 13 14</p><p>执行:</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">lua hello.lua</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>结果：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">10</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><h4 id="_1-4-7-require-函数" tabindex="-1"><a class="header-anchor" href="#_1-4-7-require-函数"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_1-4-7-require-%E5%87%BD%E6%95%B0" target="_blank" rel="noopener noreferrer">#</a>1.4.7 require 函数</span></a></h4><p>require 用于 引入其他的模块，类似于java中的类要引用别的类的效果。</p><p>用法：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">require &quot;&lt;模块名&gt;&quot;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><h2 id="_2-nginx-lua-redis实现广告缓存-重点" tabindex="-1"><a class="header-anchor" href="#_2-nginx-lua-redis实现广告缓存-重点"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-nginx-lua-redis%E5%AE%9E%E7%8E%B0%E5%B9%BF%E5%91%8A%E7%BC%93%E5%AD%98-%E9%87%8D%E7%82%B9" target="_blank" rel="noopener noreferrer">#</a>2.nginx+lua+redis实现广告缓存-重点</span></a></h2><p><strong>面试</strong>:</p><p><strong>1</strong>ngxin有什么作用？</p><p>1.1负载均衡</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211023123424137.ddc8d36e.png" alt="image-20211023123424137"></p><p>1.2反向代理</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211023124014197.4414ba00.png" alt="image-20211023124014197"></p><p>1.3静态网页服务器</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211023124341749.7da10c24.png" alt="image-20211023124341749"></p><p><strong>2</strong>tomcat与nginx,网页服务器，他们的区别是什么呢？</p><p>网页服务器：tomcat与nginx。</p><p>1从应用方面：</p><p>tomcat一般是做动态解析才会用得到，支持jsp(html+java)的解析，需要配置JDK支持。</p><p>nginx，则一般是做静态html ，1负载均衡、2反向代理、3http服务器。</p><p>2性能方面 ：</p><p>tomcat并发500</p><p>nginx 上万 tps</p><p>需要在页面上显示广告的信息。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211023114235735.19e2222a.png" alt="image-20211023114235735"></p><h3 id="_2-2-openresty" tabindex="-1"><a class="header-anchor" href="#_2-2-openresty"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-2-openresty" target="_blank" rel="noopener noreferrer">#</a>2.2 OpenResty</span></a></h3><h4 id="_2-2-1-openresty介绍" tabindex="-1"><a class="header-anchor" href="#_2-2-1-openresty介绍"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-2-1-openresty%E4%BB%8B%E7%BB%8D" target="_blank" rel="noopener noreferrer">#</a>2.2.1 OpenResty介绍</span></a></h4><p><strong>罗永浩</strong> 锤子发布会 今晚票钱 68w 捐给<strong>OpenResty</strong> 基金会</p><p>OpenResty(又称：ngx_openresty) 是一个基于 NGINX 的可伸缩的 Web 平台，由中国人章亦春发起，提供了很多高质量的第三方模块。</p><p>OpenResty 是一个强大的 Web 应用服务器，Web 开发人员可以使用 Lua 脚本语言调动 Nginx 支持的各种 C 以及 Lua 模块,更主要的是在性能方面，OpenResty可以 快速构造出足以胜任 10K 乃至1000K以上并发连接响应的超高性能 Web 应用系统。</p><p>360，UPYUN，阿里云，新浪，腾讯网，去哪儿网，酷狗音乐等都是 OpenResty 的深度用户。</p><p>OpenResty 简单理解，就相当于封装了nginx,并且集成了LUA脚本，开发人员只需要简单的其提供了模块就可以实现相关的逻辑，而不再像之前，还需要在nginx中自己编写lua的脚本，再进行调用了。</p><h4 id="_2-2-2-openresty安装" tabindex="-1"><a class="header-anchor" href="#_2-2-2-openresty安装"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-2-2-openresty%E5%AE%89%E8%A3%85" target="_blank" rel="noopener noreferrer">#</a>2.2.2 OpenResty安装</span></a></h4><p>虚拟机中已安装。</p><p>linux安装openresty:</p><p>1.添加仓库执行命令</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">yum <span class="token function">install</span> yum-utils</span>
<span class="line"></span>
<span class="line">yum-config-manager --add-repo https://openresty.org/package/centos/openresty.repo</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3</p><p>2.执行安装</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">yum <span class="token function">install</span> openresty</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><p>3.安装成功后 会在默认的目录如下：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">/usr/local/openresty</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>1</p><h4 id="_2-2-3-安装nginx" tabindex="-1"><a class="header-anchor" href="#_2-2-3-安装nginx"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-2-3-%E5%AE%89%E8%A3%85nginx" target="_blank" rel="noopener noreferrer">#</a>2.2.3 安装nginx</span></a></h4><p>默认已经安装好了nginx,在目录：/usr/local/openresty/nginx 下。</p><p>修改/usr/local/openresty/nginx/conf/nginx.conf ,将配置文件使用的根设置为root,目的就是将来要使用lua脚本的时候 ，直接可以加载在root下的lua脚本。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">#user nobody; 配置文件第一行原来为这样, 现改为下面的配置</span>
<span class="line">user root root;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2</p><p>测试访问 http://192.168.200.128</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211023152642713.453d3e06.png" alt="image-20211023152642713"></p><h3 id="_2-3-实现思路" tabindex="-1"><a class="header-anchor" href="#_2-3-实现思路"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-3-%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF" target="_blank" rel="noopener noreferrer">#</a>2.3 实现思路</span></a></h3><h4 id="_2-3-1-表结构分析" tabindex="-1"><a class="header-anchor" href="#_2-3-1-表结构分析"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-3-1-%E8%A1%A8%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90" target="_blank" rel="noopener noreferrer">#</a>2.3.1 表结构分析</span></a></h4><p>banner</p><p>查看数据库：ydles_business库下tb_ad表，分析表结构。</p><p>广告位置：不同位置价位不同。查看jd.com</p><p>tb_ad （广告表）</p><table><thead><tr><th>字段名称</th><th>字段含义</th><th>字段类型</th><th>字段长度</th><th>备注</th></tr></thead><tbody><tr><td>id</td><td>ID</td><td>INT</td><td></td><td></td></tr><tr><td>name</td><td>广告名称</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>position</td><td>广告位置</td><td>VARCHAR</td><td></td><td>系统定义</td></tr><tr><td>start_time</td><td>开始时间</td><td>DATETIME</td><td></td><td></td></tr><tr><td>end_time</td><td>到期时间</td><td>DATETIME</td><td></td><td></td></tr><tr><td>status</td><td>状态</td><td>CHAR</td><td></td><td>0：无效 1:有效</td></tr><tr><td>image</td><td>图片地址</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>url</td><td>URL</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>remarks</td><td>备注</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>web_index_lb</td><td>首页轮播图</td><td></td><td></td><td></td></tr><tr><td>web_index_amusing</td><td>有趣区</td><td></td><td></td><td></td></tr><tr><td>web_index_ea_lb</td><td>家用电器楼层轮播图</td><td></td><td></td><td></td></tr><tr><td>web_index_ea</td><td>家用电器楼层广告</td><td></td><td></td><td></td></tr><tr><td>web_index_mobile_lb</td><td>手机通讯楼层轮播图</td><td></td><td></td><td></td></tr><tr><td>web_index_mobile</td><td>手机通讯楼层广告</td><td></td><td></td><td></td></tr></tbody></table><h4 id="_2-3-2-缓存预热与二级缓存查询" tabindex="-1"><a class="header-anchor" href="#_2-3-2-缓存预热与二级缓存查询"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-3-2-%E7%BC%93%E5%AD%98%E9%A2%84%E7%83%AD%E4%B8%8E%E4%BA%8C%E7%BA%A7%E7%BC%93%E5%AD%98%E6%9F%A5%E8%AF%A2" target="_blank" rel="noopener noreferrer">#</a>2.3.2 缓存预热与二级缓存查询</span></a></h4><p>缓存预热与二-级缓存查询</p><p>1缓存预热：编写lua脚本实现缓存预热（将mysql里的数据查询出来存入redis）</p><p>2一级缓存查询:</p><p>3 二级缓存查询</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211026160529570.7a611b6a.png" alt="image-20211026160529570"></p><h3 id="_2-4-代码实现" tabindex="-1"><a class="header-anchor" href="#_2-4-代码实现"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-4-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener noreferrer">#</a>2.4 代码实现</span></a></h3><h4 id="_2-4-1-缓存预热" tabindex="-1"><a class="header-anchor" href="#_2-4-1-缓存预热"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-4-1-%E7%BC%93%E5%AD%98%E9%A2%84%E7%83%AD" target="_blank" rel="noopener noreferrer">#</a>2.4.1 缓存预热</span></a></h4><p>运维人员，脚本，每天凌晨2点，nginx发一个请求</p><p>（ http://192.168.200.128/ad_update?position=web_index_lb），让nginx来做的。</p><p>实现思路：</p><p>定义请求：用于查询数据库中的数据更新到redis中。</p><p>（1）连接mysql ，按照广告分类ID读取广告列表，转换为json字符串。</p><p>（2）连接redis，将广告列表json字符串存入redis 。</p><p>定义请求：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">请求：</span>
<span class="line">    /ad_update</span>
<span class="line">参数：</span>
<span class="line">    position  --指定广告位置</span>
<span class="line">返回值：</span>
<span class="line">    json </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1 2 3 4 5 6</p><p>1编写/root/lua/ad_update.lua。大致看懂即可。</p><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line">ngx<span class="token punctuation">.</span>header<span class="token punctuation">.</span>content_type<span class="token operator">=</span><span class="token string">&quot;application/json;charset=utf8&quot;</span></span>
<span class="line"><span class="token keyword">local</span> cjson <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;cjson&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">local</span> mysql <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;resty.mysql&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">local</span> uri_args <span class="token operator">=</span> ngx<span class="token punctuation">.</span>req<span class="token punctuation">.</span><span class="token function">get_uri_args</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">local</span> position <span class="token operator">=</span> uri_args<span class="token punctuation">[</span><span class="token string">&quot;position&quot;</span><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">local</span> db <span class="token operator">=</span> mysql<span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">db<span class="token punctuation">:</span><span class="token function">set_timeout</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">local</span> props <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    host <span class="token operator">=</span> <span class="token string">&quot;192.168.200.128&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    port <span class="token operator">=</span> <span class="token number">3306</span><span class="token punctuation">,</span></span>
<span class="line">    database <span class="token operator">=</span> <span class="token string">&quot;ydles_business&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    user <span class="token operator">=</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    password <span class="token operator">=</span> <span class="token string">&quot;root&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">local</span> res <span class="token operator">=</span> db<span class="token punctuation">:</span><span class="token function">connect</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">local</span> select_sql <span class="token operator">=</span> <span class="token string">&quot;select url,image from tb_ad where status =&#39;1&#39; and position=&#39;&quot;</span><span class="token operator">..</span>position<span class="token operator">..</span><span class="token string">&quot;&#39; and start_time&lt;= NOW() AND end_time&gt;= NOW()&quot;</span></span>
<span class="line">res <span class="token operator">=</span> db<span class="token punctuation">:</span><span class="token function">query</span><span class="token punctuation">(</span>select_sql<span class="token punctuation">)</span></span>
<span class="line">db<span class="token punctuation">:</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">local</span> redis <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;resty.redis&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">local</span> red <span class="token operator">=</span> redis<span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">red<span class="token punctuation">:</span><span class="token function">set_timeout</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">local</span> ip <span class="token operator">=</span><span class="token string">&quot;192.168.200.128&quot;</span></span>
<span class="line"><span class="token keyword">local</span> port <span class="token operator">=</span> <span class="token number">6379</span></span>
<span class="line">red<span class="token punctuation">:</span><span class="token function">connect</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span>port<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">red<span class="token punctuation">:</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;ad_&quot;</span><span class="token operator">..</span>position<span class="token punctuation">,</span>cjson<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">red<span class="token punctuation">:</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">ngx<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token string">&quot;{\\&quot;flag\\&quot;:true,\\&quot;position\\&quot;:\\&quot;&quot;</span><span class="token operator">..</span>position<span class="token operator">..</span><span class="token string">&quot;\\&quot;}&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>redis key:ad_web_index_lb value:&quot;{url:http://asdfasdf,image:asdfasdf}&quot;</p><p>2 使nginx执行lua脚本</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">vim /usr/local/openresty/nginx/conf/nginx.conf</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>在server 80 localhost中添加转发</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">#添加广告</span>
<span class="line">location /ad_update {</span>
<span class="line">	content_by_lua_file /root/lua/ad_update.lua;</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试：重启nginx</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">cd /usr/local/openresty/nginx/sbin</span>
<span class="line">./nginx -s reload</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>访问：运维 页面 http://192.168.200.128/ad_update?position=web_index_lb</p><p>查看redis中有没有数据。</p><h4 id="_2-4-2-广告缓存读取" tabindex="-1"><a class="header-anchor" href="#_2-4-2-广告缓存读取"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-4-2-%E5%B9%BF%E5%91%8A%E7%BC%93%E5%AD%98%E8%AF%BB%E5%8F%96" target="_blank" rel="noopener noreferrer">#</a>2.4.2 广告缓存读取</span></a></h4><p>用户访问首页，钩子方法里，请求（http://192.168.200.128/ad_read?position=web_index_lb），显示在页面上。</p><p>实现思路：</p><p>通过lua脚本直接从redis中获取数据即可。</p><p>定义请求：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">请求:/ad_read</span>
<span class="line">参数：position</span>
<span class="line">返回值：json</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建文件 vim /root/lua/ad_read.lua。看懂即可。</p><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line">ngx<span class="token punctuation">.</span>header<span class="token punctuation">.</span>content_type<span class="token operator">=</span><span class="token string">&quot;application/json;charset=utf8&quot;</span> </span>
<span class="line"><span class="token keyword">local</span> uri_args <span class="token operator">=</span> ngx<span class="token punctuation">.</span>req<span class="token punctuation">.</span><span class="token function">get_uri_args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line"><span class="token keyword">local</span> position <span class="token operator">=</span> uri_args<span class="token punctuation">[</span><span class="token string">&quot;position&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span> </span>
<span class="line"><span class="token keyword">local</span> redis <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;resty.redis&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line"><span class="token keyword">local</span> red <span class="token operator">=</span> redis<span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> </span>
<span class="line">red<span class="token punctuation">:</span><span class="token function">set_timeout</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span> </span>
<span class="line"><span class="token keyword">local</span> ok<span class="token punctuation">,</span> err <span class="token operator">=</span> red<span class="token punctuation">:</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.200.128&quot;</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span> </span>
<span class="line"><span class="token keyword">local</span> rescontent<span class="token operator">=</span>red<span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;ad_&quot;</span><span class="token operator">..</span>position<span class="token punctuation">)</span> </span>
<span class="line">ngx<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span>rescontent<span class="token punctuation">)</span> </span>
<span class="line">red<span class="token punctuation">:</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改：nginx读取lua脚本</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">vim /usr/local/openresty/nginx/conf/nginx.conf</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>在server 80 localhost中添加转发</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">#读取广告</span>
<span class="line">location /ad_read {</span>
<span class="line">	content_by_lua_file /root/lua/ad_read.lua;</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启nginx</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">cd /usr/local/openresty/nginx/sbin</span>
<span class="line">./nginx -s reload</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>测试访问： 用户登录首页 http://192.168.200.128/ad_read?position=web_index_lb</p><h4 id="_2-4-3-二级缓存-加入openresty本地缓存" tabindex="-1"><a class="header-anchor" href="#_2-4-3-二级缓存-加入openresty本地缓存"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-4-3-%E4%BA%8C%E7%BA%A7%E7%BC%93%E5%AD%98-%E5%8A%A0%E5%85%A5openresty%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98" target="_blank" rel="noopener noreferrer">#</a>2.4.3 二级缓存-加入openresty本地缓存</span></a></h4><p>问题：如上的方式没有问题，但是如果请求都到redis，redis压力也很大，所以我们一般采用多 级缓存的方式来减少下游系统的服务压力。</p><p>解决方案：先查询openresty本地缓存 如果没有再查询redis中的数据</p><p>操作： 看懂内容即可。</p><ul><li>修改/root/lua目录下ad_read文件, 内容如下:</li></ul><div class="language-lua line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre><code><span class="line"><span class="token comment">--设置响应头类型</span></span>
<span class="line">ngx<span class="token punctuation">.</span>header<span class="token punctuation">.</span>content_type<span class="token operator">=</span><span class="token string">&quot;application/json;charset=utf8&quot;</span></span>
<span class="line"><span class="token comment">--获取请求中的参数ID</span></span>
<span class="line"><span class="token keyword">local</span> uri_args <span class="token operator">=</span> ngx<span class="token punctuation">.</span>req<span class="token punctuation">.</span><span class="token function">get_uri_args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">local</span> position <span class="token operator">=</span> uri_args<span class="token punctuation">[</span><span class="token string">&quot;position&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">--获取本地缓存</span></span>
<span class="line"><span class="token keyword">local</span> cache_ngx <span class="token operator">=</span> ngx<span class="token punctuation">.</span>shared<span class="token punctuation">.</span>dis_cache<span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">--根据ID 获取本地缓存数据</span></span>
<span class="line"><span class="token keyword">local</span> adCache <span class="token operator">=</span> cache_ngx<span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;ad_cache_&#39;</span><span class="token operator">..</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">if</span> adCache <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token keyword">or</span> adCache <span class="token operator">==</span> <span class="token keyword">nil</span> <span class="token keyword">then</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">--引入redis库</span></span>
<span class="line">    <span class="token keyword">local</span> redis <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;resty.redis&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">--创建redis对象</span></span>
<span class="line">    <span class="token keyword">local</span> red <span class="token operator">=</span> redis<span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">--设置超时时间</span></span>
<span class="line">    red<span class="token punctuation">:</span><span class="token function">set_timeout</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">--连接</span></span>
<span class="line">    <span class="token keyword">local</span> ok<span class="token punctuation">,</span> err <span class="token operator">=</span> red<span class="token punctuation">:</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.200.128&quot;</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">--获取key的值</span></span>
<span class="line">    <span class="token keyword">local</span> rescontent<span class="token operator">=</span>red<span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;ad_&quot;</span><span class="token operator">..</span>position<span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">--输出到返回响应中</span></span>
<span class="line">    ngx<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span>rescontent<span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">--关闭连接</span></span>
<span class="line">    red<span class="token punctuation">:</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">--将redis中获取到的数据存入nginx本地缓存</span></span>
<span class="line">    cache_ngx<span class="token punctuation">:</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;ad_cache_&#39;</span><span class="token operator">..</span>position<span class="token punctuation">,</span> rescontent<span class="token punctuation">,</span> <span class="token number">10</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">else</span></span>
<span class="line"> <span class="token comment">--nginx本地缓存中获取到数据直接输出</span></span>
<span class="line"> ngx<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span>adCache<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">end</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>修改nginx配置文件vi /usr/local/openresty/nginx/conf/nginx.conf ，http节点下添加配置:</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">#包含redis初始化模块</span>
<span class="line">lua_shared_dict dis_cache 5m;  #共享内存开启</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-4-4-前端页面实现-了解" tabindex="-1"><a class="header-anchor" href="#_2-4-4-前端页面实现-了解"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_2-4-4-%E5%89%8D%E7%AB%AF%E9%A1%B5%E9%9D%A2%E5%AE%9E%E7%8E%B0-%E4%BA%86%E8%A7%A3" target="_blank" rel="noopener noreferrer">#</a>2.4.4 前端页面实现（了解）</span></a></h4><p>（1）修改index.html，编写脚本</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line">  <span class="token operator">&lt;</span>script<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">el</span><span class="token operator">:</span><span class="token string">&quot;#app&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">data</span><span class="token operator">:</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">ad</span><span class="token operator">:</span><span class="token punctuation">{</span></span>
<span class="line">          <span class="token literal-property property">web_index_lb</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">methods</span><span class="token operator">:</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token function-variable function">adRead</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">position</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">          axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;ad_read?position=&#39;</span><span class="token operator">+</span>position<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">               <span class="token keyword">this</span><span class="token punctuation">.</span>ad<span class="token punctuation">[</span>position<span class="token punctuation">]</span><span class="token operator">=</span>response<span class="token punctuation">.</span>data</span>
<span class="line">          <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token function">created</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">adRead</span><span class="token punctuation">(</span><span class="token string">&#39;web_index_lb&#39;</span><span class="token punctuation">)</span></span>
<span class="line">          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">adRead</span><span class="token punctuation">(</span><span class="token string">&#39;web_index_lb&#39;</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在页面上添加<code>...</code></p><p>（2）修改index.html，渲染广告轮播图</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">&lt;div id=&quot;myCarousel&quot; data-ride=&quot;carousel&quot; data-interval=&quot;4000&quot; class=&quot;sui-carousel slide&quot;&gt;</span>
<span class="line">    &lt;ol class=&quot;carousel-indicators&quot;&gt;</span>
<span class="line">        &lt;li data-target=&quot;#myCarousel&quot; data-slide-to=&quot;0&quot; class=&quot;active&quot; v-for=&quot;item in ad.web_index_lb&quot;&gt;&lt;/li&gt;</span>
<span class="line">    &lt;/ol&gt;</span>
<span class="line">    &lt;div class=&quot;carousel-inner&quot; id=&quot;lbt&quot;&gt;</span>
<span class="line">        &lt;div class=&quot;item&quot; v-for=&quot;item in contentList&quot;&gt;</span>
<span class="line">            &lt;a :href=&quot;item.url&quot;&gt;</span>
<span class="line">            &lt;img :src=&quot;item.pic&quot;  /&gt;</span>
<span class="line">          &lt;/a&gt;</span>
<span class="line">        &lt;/div&gt;      </span>
<span class="line">    &lt;/div&gt;</span>
<span class="line">    &lt;a href=&quot;#myCarousel&quot; data-slide=&quot;prev&quot; class=&quot;carousel-control left&quot;&gt;‹&lt;/a&gt;</span>
<span class="line">    &lt;a href=&quot;#myCarousel&quot; data-slide=&quot;next&quot; class=&quot;carousel-control right&quot;&gt;›&lt;/a&gt;</span>
<span class="line">&lt;/div&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（3）上传至服务器并测试</p><p>更改</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line"># 加载首页</span>
<span class="line">        location / {</span>
<span class="line">            root   html;</span>
<span class="line">            index  index.html index.htm;</span>
<span class="line">        }</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>访问 ： http://192.168.200.128/</p><p>域名访问：C:\\Windows\\System32\\drivers\\etc\\hosts</p><p>添加 192.168.200.128 www.ydles.com</p><p>访问 ：http://www.ydles.com/</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211026151431725.848ccf2c.png" alt="image-20211026151431725"></p><h2 id="_3-nginx限流" tabindex="-1"><a class="header-anchor" href="#_3-nginx限流"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-nginx%E9%99%90%E6%B5%81" target="_blank" rel="noopener noreferrer">#</a>3 nginx限流</span></a></h2><p>回顾网关限流：令牌桶。</p><p>一般情况下，首页的并发量是比较大的，即使有了多级缓存，如果有大量恶意的请求，也会对系统造成影响。而限流就是保护措施之一。</p><p>nginx提供两种限流的方式：</p><ul><li>一是控制速率</li><li>二是控制并发连接数</li></ul><h3 id="_3-1-控制速率" tabindex="-1"><a class="header-anchor" href="#_3-1-控制速率"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-1-%E6%8E%A7%E5%88%B6%E9%80%9F%E7%8E%87" target="_blank" rel="noopener noreferrer">#</a>3.1 控制速率</span></a></h3><p>控制速率的方式之一就是采用漏桶算法。</p><h4 id="_3-1-1-漏桶算法实现控制速率限流" tabindex="-1"><a class="header-anchor" href="#_3-1-1-漏桶算法实现控制速率限流"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-1-1-%E6%BC%8F%E6%A1%B6%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0%E6%8E%A7%E5%88%B6%E9%80%9F%E7%8E%87%E9%99%90%E6%B5%81" target="_blank" rel="noopener noreferrer">#</a>3.1.1 漏桶算法实现控制速率限流</span></a></h4><p>1漏桶(Leaky Bucket)算法思路很简单,水(请求)先进入到漏桶里,漏桶以一定的速度出水(接口有响应速率),当水流入速度过大会直接溢出(访问频率超过接口响应速率),然后就拒绝请求,可以看出漏桶算法能强行限制数据的传输速率.示意图如下:</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/1559033998856.e19cc7e1.png" alt="1559033998856"></p><p><strong>2与令牌桶区别：</strong></p><p>令牌桶控制进的速度</p><p>漏桶算法控制出的速度</p><p>漏桶算法实现 nginx的配置</p><p>3配置示意图如下：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfYAAADdCAYAAABJ91D9AAAKvElEQVR4nO3d646juBYG0HBU7/9E/W6cHyM0tMdX4hCzay1p1DUQXyCEDwMJ277v+wsACOF/Vwr9+fNndj8AgAkuBTsAsCbBDgCBCHYACESwA0Aggh0AAhHsABCIYAeAQAQ7AAQi2AEgkF8T7Nu2vbZt+3Y3AOCjPhbsKwapn8UHILqPBXsrRGuhv9oBAQA8xa85FQ8Av8HPHY0cI/B93/8ajZ+nn/+/VubgtDoA/NfHg33btr+CO/f3oTTvCPfztFz5nj4AQGQfPxW/QqCWRv0AEI1r7AAQiGAHgEA++j3287/p9OP0eOnGuNy8Y5pr5gCQ97Gb53LBW7pZ7mr5UQ4IAIjuEafiS6P/Efu+C3UAwrvle+zvEsgA0OcRI3YAoI9gB4BABDsABCLYmcov/AEp+4V7hQj28/fbS/Ov1MmY87cXcn+3ynGP1mfF+zEmt75a+6QnurosvmZ8vxDB3voq25WNqlQm0gd1pvOHN32AT8tv/9DfvU3N/qz8ZqVQP/ZJ33xOxcx27feeJUSwsx4BwW/wW7bzq8tptP4dj/ge+1Xno8z0ka+p3DPhS2XS58j39OF85N5qK9fHVlujy1TrV6tvOa2RSa0PpbZH+5YrV+tjbblG+1Bb/z1lStvU6PtQK9P7/uT61LvNt9ZDaR3U2uhZ159oJ50+45cva31ulevdh7S2q1aZkf5d2UZy7V19JDd5oYO9tNGen++e/lsrc0wf2ejOv3tf23hrz6rvPQ3W89z783Km/UrXRamvo8t67lvah9zyXe1bz7rO1TG6LKX6S//WyuTmtdqpafXtPL1WprUOanqWOe1baX3MXgcz2xnV2kZa5XrXZ227apW5ukw9bdX6kNbJe0IH+0pKG/js+q/uhFPv9K13h9VTT2larX+5g4qRHWmrD632Zxptp2f9jJoR6u+0cdeyXB213qV0sDy6fj6x7V4Z7Bx/r7J+IxHsX7TyBj3atztPn6UjrW+4a1mvtLPC+pkpNxLsed277TzBlfd6ZJBxdZ209gdXDwDp4+a5RczYAX9qh75SOFzdEcw6i1Dq0x162llhR/nJA4vzqeP0v9ntnP9e6TNwmPFepyPnT67TtM2j3RXX7dOFGLGnH8LXq35zUmlDSqefyxzS00i9fUvLpP0otdErbadUV7rDrV2PzPWt5FymdL2t1Ifz37V6cn3LTR95f0pqdeXWT22bOnaSPe93q52WnvXT6tsxL/37yvZe61vPez1jHXyqnaN8Wm/rM5ero+cSQWsfUutHz36nprb+0r71HHDU+rDCwenThQj20kbQM/28wb/b3uhre+f1hPxoO61pM0fF77w/I31r7Rxnvse1ZSxtU1e2havvw2hds3ak76y3kdeM9uOddma9b1f3O++8b72f/at9mFkX84QI9m/69A03tRHQzHZmWa0/tYOip6zTsyf2md/l3W3Rtvw+wf6mT2+ENvL33DFKvdMT+wzcy81zABCIYAeAQAQ7AAQi2AEgEMEOAIEIdgAIRLADQCCCHQACEewAEIhgB4BABDsABCLYASAQwQ4AgQh2AAhEsANAIIIdAAIR7AAQiGAHgEAEOwAEItgBIBDBDgCBCHYACESwA0Aggh0AAhHsABCIYAeAQAQ7AAQSIti3bXtt29Y9vTUPAJ4qRLADAP/4+XYHZtj3fWh6ax4APJUROwAEItgBIBDBDgCBCHYACESwA0Aggh0AAhHsABCIYAeAQAQ7AAQi2AEgEMEOAIEIdgAIRLADQCCCHQACEewAEIhgB4BABDsABCLYASAQwQ4AgQh2AAhEsANAIIJ9Adu2vbZt+3Y3AAhAsC9i3/dvdwGAAAQ7AAQi2AEgkJ9vd2CW9Br1cWr7PP18uvuYvu979vp2Or1WX64up9YB+IYQwb5tWza0c9OP/z9CuOc15wDPvbZU15W+A8A7QgR7OlLOhXyt7IhafVcCOj14AIB3hAj21+tVHFWPBuY5aHOBK4ABWFmIm+fS696lUfXs74r77jkAqwkzYs/d1Fa6Ae78+tzNbrXReu3mOTfOAfBtIYK9FqSlea3wHSk3I8hdZwdghhDB/nQCHYBZQlxjBwD+IdgBIBDBDgCBCHYACESwA0Aggh0AAhHsABCIYAeAQAQ7AAQi2AEgEMEOAIEIdgAIRLADQCCCHQACEewAEIhgB4BABDsABCLYASAQwQ4AgQh2AAhEsANAIIIdAAIR7AAQiGAHgEAEOwAEItgBIBDBDgCBCHYACESwD9i27bVtW/f01jwAmE2wA0AgP9/uwJPs+z40vTUPAGYzYgeAQAQ7AAQi2AEgEMEOAIEIdgAIRLADQCCCHQACEewAEIhgB4BABDsABCLYASAQwQ4AgQh2AAhEsANAIIIdAAIR7AAQiGAHgEAEOwAEItgBIBDBDgCBCHYACESw07Rt27e7cMlov7dte+yyAhwE+4Bjx//tnf+d7W/b9tr3/bb2akbW/dV+r7KsAFcJ9gH7vt+2468F2G8Nn9+63AAjBDtFK43WRzy13wAz/Hy7A1GcR9hpqKSj72N+rsx52vF37fW1PpzLp3W9Y2R5Sn07Tyv1r9ROWhaAfwn2CdIR4vn/c/NqZUrlXq98gLb6cFyXrtXbs0y1dq6sg2NZ0/612umte5RRPhCFYL/ZER61kP5Um7PqOo+WayPstP3W/Fa7I68fdSyXcAeeTrB/UTryXEUr4Eqj5VqZO5ZVMAO4ee52pVPXT1G6jl973YxlXenAB2BlRuwDSje2pQGXjmJz83KheA7A3A1ltRvrcu30XP/OLWMrhHuWp7YOWstyZXnS8gC/lWAf0HN6emReK4hKN8+98/p3w2/2Ohhpq7Y8s0b0Tz2TAnAQ7PzlqaE2o99PXXaAM9fYASAQwQ4AgQh2AAhEsANAIIIdAAJxV/yCeh72MnoHt69xrWf179/nvkK4al+BfxmxL6j13PcZ3wk/+EW377k7JK+818e22NomgXUIdgAIxKn4Bymdoq+dMu0pM3JKuPYM9SvPpG+1kyvz7rPde582N6udllY7tXZ7nmOfa+uddZDWZyQPaxHsD1LaGZ8fOZr+WytzTB/ZMZeeoX7lmfQ9bfXUdf69/txra2VKZrbTu5y5ds6vSQO99zn2tfd65GeKr5QH7ifYuaQ0eptd/5UDj5zZ9xKscM9C6bfz0wcUzawfWJ9gZ5qVg2DkQOTpYThyUFRbB06zwzMJdj5i1jPYr47ce+r9dGh9Ixhzj/6d/Q0LYG2CfUGlG9t6ppfqScscSjdgtfrW8zz4XBu90nZKdaX3EJSuMY/e1HZXO+c60zK59dZz02NPfe+sg7QtBwewFsG+oNKOsmf6OWjfbW/0tb3zekJ+tJ3WtCvhc0c7IzevrVgfsB7Bzl8+cd05V7+RXgzeQ1iPYOcvn95RCwKAz/LLcwAQiGAHgEAEOwAEItgHHD/jCQCrEuwD3PgFwOoEOwAEItgBIBDBDgCBCPZBV373HADuItgH+SlUAFYm2AEgEMEOAIEIdgAIRLAPcNMcAKvz2NYBbpoDYHVG7AAQiGAHgEAEOwAEItgBIBDBDgCBCHYACESwA0Aggh0AAhHsABCIYAeAQLbd76QCQBhG7AAQiGAHgEAEOwAEItgBIBDBDgCBCHYACESwA0Aggh0AAhHsABCIYAeAQAQ7AATyf8TJlnNZ2+DAAAAAAElFTkSuQmCC" alt="1559034089505"></p><p>看懂即可，注意位置。</p><p>修改/usr/local/openresty/nginx/conf/nginx.conf:</p><div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx" data-title="nginx"><pre><code><span class="line"><span class="token comment"># 设置限流配置 限速，每秒2个,内存区域10m，大概16万个session</span></span>
<span class="line"><span class="token directive"><span class="token keyword">limit_req_zone</span> <span class="token variable">$binary_remote_addr</span> zone=myRateLimit:10m rate=2r/s</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span></span>
<span class="line">     <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">8081</span></span><span class="token punctuation">;</span></span>
<span class="line">     <span class="token directive"><span class="token keyword">server_name</span>  localhost</span><span class="token punctuation">;</span></span>
<span class="line">     <span class="token directive"><span class="token keyword">charset</span> utf-8</span><span class="token punctuation">;</span></span>
<span class="line">     <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token directive"><span class="token keyword">limit_req</span> zone=myRateLimit</span><span class="token punctuation">;</span></span>
<span class="line">          <span class="token directive"><span class="token keyword">root</span>   html</span><span class="token punctuation">;</span></span>
<span class="line">          <span class="token directive"><span class="token keyword">index</span>  index.html index.htm</span><span class="token punctuation">;</span></span>
<span class="line">     <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>解释：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">binary_remote_addr 是一种key，表示基于 remote_addr(客户端IP) 来做限流，binary_ 的目的是压缩内存占用量。</span>
<span class="line">zone：定义共享内存区来存储访问信息， myRateLimit:10m 表示一个大小为10M，名字为myRateLimit的内存区域。1M能存储16000 IP地址的访问信息，10M可以存储16W IP地址访问信息。</span>
<span class="line">rate 用于设置最大访问速率，rate=10r/s 表示每秒最多处理10个请求。Nginx 实际上以毫秒为粒度来跟踪请求信息，因此 10r/s 实际上是限制：每100毫秒处理一个请求。这意味着，自上一个请求处理完后，若后续100毫秒内又有请求到达，将拒绝处理该请求.我们这里设置成2 方便测试。</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试：重新加载配置文件</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">cd /usr/local/openresty/nginx/sbin</span>
<span class="line"></span>
<span class="line">./nginx -s reload</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>快速刷新： http://192.168.200.128:8081/</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211026155137306.8287e9f9.png" alt="image-20211026155137306"></p><p>http 503: 由于临时的<a href="https://baike.baidu.com/item/%E6%9C%8D%E5%8A%A1%E5%99%A8" target="_blank" rel="noopener noreferrer">服务器open in new window</a>维护或者过载，服务器当前无法处理请求。</p><h4 id="_3-1-2-处理突发流量" tabindex="-1"><a class="header-anchor" href="#_3-1-2-处理突发流量"><span><a href="https://www.ydlclass.com/doc21xnv/project/mall/01/#_3-1-2-%E5%A4%84%E7%90%86%E7%AA%81%E5%8F%91%E6%B5%81%E9%87%8F" target="_blank" rel="noopener noreferrer">#</a>3.1.2 处理突发流量</span></a></h4><p>上面例子限制 2r/s，如果有时正常流量突然增大，超出的请求将被拒绝，无法处理突发流量，可以结合 <strong>burst</strong> 参数使用来解决该问题。</p><p>例如，如下配置表示：</p><div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx" data-title="nginx"><pre><code><span class="line"><span class="token directive"><span class="token keyword">limit_req_zone</span> <span class="token variable">$binary_remote_addr</span> zone=myRateLimit:10m rate=2r/s</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span></span>
<span class="line">     <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">8081</span></span><span class="token punctuation">;</span></span>
<span class="line">     <span class="token directive"><span class="token keyword">server_name</span>  localhost</span><span class="token punctuation">;</span></span>
<span class="line">     <span class="token directive"><span class="token keyword">charset</span> utf-8</span><span class="token punctuation">;</span></span>
<span class="line">     <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token directive"><span class="token keyword">limit_req</span> zone=myRateLimit burst=5 nodelay</span><span class="token punctuation">;</span></span>
<span class="line">          <span class="token directive"><span class="token keyword">root</span>   html</span><span class="token punctuation">;</span></span>
<span class="line">          <span class="token directive"><span class="token keyword">index</span>  index.html index.htm</span><span class="token punctuation">;</span></span>
<span class="line">     <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>burst 译为突发、爆发，表示在超过设定的处理速率后能额外处理的请求数,当 rate=2r/s 时，将1s拆成2份，即每500ms可处理1个请求。</p><p>此处，<strong>burst=5</strong> ，若同时有6个请求到达，Nginx 会处理第一个请求，剩余5个请求将放入队列，然后每隔500ms从队列中获取一个请求进行处理。若请求数大于6，将拒绝处理多余的请求，直接返回503.</p><p>不过，单独使用 burst 参数并不实用。假设 burst=50 ，rate为10r/s，排队中的50个请求虽然每100ms会处理一个，但第50个请求却需要等待 50 * 100ms即 5s，这么长的处理时间自然难以接受。</p><p>因此，burst 往往结合 nodelay 一起使用。</p><p>例如：如下配置：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">server {</span>
<span class="line">    location / {</span>
<span class="line">        limit_req zone=myRateLimit burst=5 nodelay;</span>
<span class="line">        root   html;</span>
<span class="line">        index  index.html index.htm;</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如上表示：</p><p>处理突发5个请求的时候，没有延迟，等到完成之后，按照正常的速率处理。</p><p>如上两种配置结合就达到了速率稳定，但突然流量也能正常处理的效果。配置代码如下：</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">#user  nobody;</span>
<span class="line">user root root;</span>
<span class="line">worker_processes  1;</span>
<span class="line"></span>
<span class="line">#error_log  logs/error.log;</span>
<span class="line">#error_log  logs/error.log  notice;</span>
<span class="line">#error_log  logs/error.log  info;</span>
<span class="line"></span>
<span class="line">#pid        logs/nginx.pid;</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">events {</span>
<span class="line">    worker_connections  1024;</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">http {</span>
<span class="line">    include       mime.types;</span>
<span class="line">    default_type  application/octet-stream;</span>
<span class="line"></span>
<span class="line">    #log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span>
<span class="line">    #                  &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span>
<span class="line">    #                  &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;</span>
<span class="line"></span>
<span class="line">    #access_log  logs/access.log  main;</span>
<span class="line"></span>
<span class="line">    sendfile        on;</span>
<span class="line">    #tcp_nopush     on;</span>
<span class="line"></span>
<span class="line">    #keepalive_timeout  0;</span>
<span class="line">    keepalive_timeout  65;</span>
<span class="line"></span>
<span class="line">    #gzip  on;</span>
<span class="line"></span>
<span class="line">    # 设置限流配置</span>
<span class="line">    limit_req_zone $binary_remote_addr zone=myRateLimit:10m rate=2r/s;</span>
<span class="line"></span>
<span class="line">    server {  </span>
<span class="line">        listen       8081;</span>
<span class="line">        server_name  localhost;</span>
<span class="line">        charset utf-8;</span>
<span class="line">        location / {</span>
<span class="line">            limit_req zone=myRateLimit burst = 5 nodelay;</span>
<span class="line">            root   html;</span>
<span class="line">            index  index.html index.htm;</span>
<span class="line">        }</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试：如下图 在1秒钟之内可以刷新5次，正常处理。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211026160018237.5a60fa08.png" alt="image-20211026160018237"></p><p>但是超过之后，连续刷新5次，抛出异常。</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211026155137306.8287e9f9.png" alt="image-20211026155102861"></p><p>总结： 运维</p><p>1lua脚本</p><p>js lua python go</p><p>2重点-----首页广告缓存</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211026160529570.7a611b6a.png" alt="image-20211026160529570"></p><p>3nginx限流</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211026160329109.9fc328d5.png" alt="image-20211026160329109"></p><p>漏桶算法：漏洞</p><p><img src="https://www.ydlclass.com/doc21xnv/assets/image-20211026160434768.8a4d1b7a.png" alt="image-20211026160434768"></p><p>burst=5 nodelay</p>`,1457),l=[t];function c(i,o){return a(),s("div",null,l)}const r=n(e,[["render",c],["__file","buy1.html.vue"]]),d=JSON.parse('{"path":"/shopping1/buy1.html","title":"二手交易网项目","lang":"zh-CN","frontmatter":{},"headers":[{"level":2,"title":"第1章 框架搭建","slug":"第1章-框架搭建","link":"#第1章-框架搭建","children":[]},{"level":2,"title":"#学习目标","slug":"学习目标","link":"#学习目标","children":[]},{"level":2,"title":"#1. 走进电商-面试了解","slug":"_1-走进电商-面试了解","link":"#_1-走进电商-面试了解","children":[{"level":3,"title":"#1.1 电商行业分析","slug":"_1-1-电商行业分析","link":"#_1-1-电商行业分析","children":[]},{"level":3,"title":"#1.2 电商系统技术特点","slug":"_1-2-电商系统技术特点","link":"#_1-2-电商系统技术特点","children":[]},{"level":3,"title":"#1.3 主要电商模式","slug":"_1-3-主要电商模式","link":"#_1-3-主要电商模式","children":[]}]},{"level":2,"title":"#2. 元动力二奢-需求分析与系统设计","slug":"_2-元动力二奢-需求分析与系统设计","link":"#_2-元动力二奢-需求分析与系统设计","children":[{"level":3,"title":"#2.1 需求分析","slug":"_2-1-需求分析","link":"#_2-1-需求分析","children":[]},{"level":3,"title":"#2.2 系统设计","slug":"_2-2-系统设计","link":"#_2-2-系统设计","children":[]}]},{"level":2,"title":"#3. 元动力二奢-框架搭建","slug":"_3-元动力二奢-框架搭建","link":"#_3-元动力二奢-框架搭建","children":[{"level":3,"title":"#3.1 环境准备","slug":"_3-1-环境准备","link":"#_3-1-环境准备","children":[]},{"level":3,"title":"#3.2 项目结构说明","slug":"_3-2-项目结构说明","link":"#_3-2-项目结构说明","children":[]},{"level":3,"title":"#3.3 父工程搭建","slug":"_3-3-父工程搭建","link":"#_3-3-父工程搭建","children":[]},{"level":3,"title":"#3.4 Eureka微服务搭建","slug":"_3-4-eureka微服务搭建","link":"#_3-4-eureka微服务搭建","children":[]},{"level":3,"title":"#3.5 公共模块搭建","slug":"_3-5-公共模块搭建","link":"#_3-5-公共模块搭建","children":[]},{"level":3,"title":"#3.6 商品微服务搭建","slug":"_3-6-商品微服务搭建","link":"#_3-6-商品微服务搭建","children":[]}]},{"level":2,"title":"#4. 商品微服务-品牌增删改查","slug":"_4-商品微服务-品牌增删改查","link":"#_4-商品微服务-品牌增删改查","children":[{"level":3,"title":"#4.1 需求分析","slug":"_4-1-需求分析","link":"#_4-1-需求分析","children":[]},{"level":3,"title":"#4.2 表结构分析","slug":"_4-2-表结构分析","link":"#_4-2-表结构分析","children":[]},{"level":3,"title":"#4.3 代码实现","slug":"_4-3-代码实现","link":"#_4-3-代码实现","children":[]}]},{"level":2,"title":"#5. 公共异常处理","slug":"_5-公共异常处理","link":"#_5-公共异常处理","children":[]},{"level":2,"title":"#第2章 分布式文件存储","slug":"第2章-分布式文件存储","link":"#第2章-分布式文件存储","children":[]},{"level":2,"title":"#学习目标","slug":"学习目标-1","link":"#学习目标-1","children":[]},{"level":2,"title":"#1. 跨域解决方案CORS-面试","slug":"_1-跨域解决方案cors-面试","link":"#_1-跨域解决方案cors-面试","children":[{"level":3,"title":"#1.1 什么是跨域","slug":"_1-1-什么是跨域","link":"#_1-1-什么是跨域","children":[]},{"level":3,"title":"#1.2 CORS简介","slug":"_1-2-cors简介","link":"#_1-2-cors简介","children":[]}]},{"level":2,"title":"#2. 导入基础架构项目（了解）","slug":"_2-导入基础架构项目-了解","link":"#_2-导入基础架构项目-了解","children":[{"level":3,"title":"#2.1 导入项目","slug":"_2-1-导入项目","link":"#_2-1-导入项目","children":[]}]},{"level":2,"title":"#3.规格参数与分类管理（后台）-重点","slug":"_3-规格参数与分类管理-后台-重点","link":"#_3-规格参数与分类管理-后台-重点","children":[{"level":3,"title":"#3.1 规格参数管理","slug":"_3-1-规格参数管理","link":"#_3-1-规格参数管理","children":[]},{"level":3,"title":"#3.2 分类管理","slug":"_3-2-分类管理","link":"#_3-2-分类管理","children":[]}]},{"level":2,"title":"#4.通用mapper自定义方法-重点掌握","slug":"_4-通用mapper自定义方法-重点掌握","link":"#_4-通用mapper自定义方法-重点掌握","children":[{"level":3,"title":"#4.1 根据商品分类名称查询品牌列表","slug":"_4-1-根据商品分类名称查询品牌列表","link":"#_4-1-根据商品分类名称查询品牌列表","children":[]},{"level":3,"title":"#4.2 根据商品分类名称查询规格列表","slug":"_4-2-根据商品分类名称查询规格列表","link":"#_4-2-根据商品分类名称查询规格列表","children":[]}]},{"level":2,"title":"#5. 分布式文件存储-FastDFS","slug":"_5-分布式文件存储-fastdfs","link":"#_5-分布式文件存储-fastdfs","children":[{"level":3,"title":"#5.1 FastDFS简介","slug":"_5-1-fastdfs简介","link":"#_5-1-fastdfs简介","children":[]},{"level":3,"title":"#5.2 FastDFS搭建-了解","slug":"_5-2-fastdfs搭建-了解","link":"#_5-2-fastdfs搭建-了解","children":[]},{"level":3,"title":"#5.3 文件存储微服务","slug":"_5-3-文件存储微服务","link":"#_5-3-文件存储微服务","children":[]},{"level":3,"title":"#5.4 文件上传-重点","slug":"_5-4-文件上传-重点","link":"#_5-4-文件上传-重点","children":[]},{"level":3,"title":"#5.5 Postman测试文件上传","slug":"_5-5-postman测试文件上传","link":"#_5-5-postman测试文件上传","children":[]}]},{"level":2,"title":"#第3章 微服务网关限流&鉴权","slug":"第3章-微服务网关限流-鉴权","link":"#第3章-微服务网关限流-鉴权","children":[]},{"level":2,"title":"#课程目标","slug":"课程目标","link":"#课程目标","children":[]},{"level":2,"title":"#1.微服务网关Gateway 过滤+路由","slug":"_1-微服务网关gateway-过滤-路由","link":"#_1-微服务网关gateway-过滤-路由","children":[{"level":3,"title":"#1.1 微服务网关概述-面试","slug":"_1-1-微服务网关概述-面试","link":"#_1-1-微服务网关概述-面试","children":[]},{"level":3,"title":"#1.2 微服务网关微服务搭建","slug":"_1-2-微服务网关微服务搭建","link":"#_1-2-微服务网关微服务搭建","children":[]},{"level":3,"title":"#1.3 微服务网关跨域","slug":"_1-3-微服务网关跨域","link":"#_1-3-微服务网关跨域","children":[]},{"level":3,"title":"#1.4 微服务网关过滤器","slug":"_1-4-微服务网关过滤器","link":"#_1-4-微服务网关过滤器","children":[]}]},{"level":2,"title":"#2 网关限流","slug":"_2-网关限流","link":"#_2-网关限流","children":[{"level":3,"title":"#2.1 思路分析","slug":"_2-1-思路分析","link":"#_2-1-思路分析","children":[]},{"level":3,"title":"#2.2 令牌桶算法","slug":"_2-2-令牌桶算法","link":"#_2-2-令牌桶算法","children":[]},{"level":3,"title":"#2.3 网关限流代码实现","slug":"_2-3-网关限流代码实现","link":"#_2-3-网关限流代码实现","children":[]}]},{"level":2,"title":"#3. BCrypt密码加密","slug":"_3-bcrypt密码加密","link":"#_3-bcrypt密码加密","children":[{"level":3,"title":"#3.1 BCrypt快速入门","slug":"_3-1-bcrypt快速入门","link":"#_3-1-bcrypt快速入门","children":[]},{"level":3,"title":"#3.2 新增管理员密码加密-掌握","slug":"_3-2-新增管理员密码加密-掌握","link":"#_3-2-新增管理员密码加密-掌握","children":[]},{"level":3,"title":"#3.3 管理员登录密码验证","slug":"_3-3-管理员登录密码验证","link":"#_3-3-管理员登录密码验证","children":[]}]},{"level":2,"title":"#4.加密算法(了解)","slug":"_4-加密算法-了解","link":"#_4-加密算法-了解","children":[{"level":3,"title":"#4.1.可逆加密算法","slug":"_4-1-可逆加密算法","link":"#_4-1-可逆加密算法","children":[]},{"level":3,"title":"#4.2.不可逆加密算法","slug":"_4-2-不可逆加密算法","link":"#_4-2-不可逆加密算法","children":[]},{"level":3,"title":"#4.3.Base64编码","slug":"_4-3-base64编码","link":"#_4-3-base64编码","children":[]}]},{"level":2,"title":"#5. JWT 实现微服务鉴权","slug":"_5-jwt-实现微服务鉴权","link":"#_5-jwt-实现微服务鉴权","children":[{"level":3,"title":"#5.1 什么是微服务鉴权","slug":"_5-1-什么是微服务鉴权","link":"#_5-1-什么是微服务鉴权","children":[]},{"level":3,"title":"#5.2 JWT","slug":"_5-2-jwt","link":"#_5-2-jwt","children":[]},{"level":3,"title":"#5.3 JJWT签发与验证token","slug":"_5-3-jjwt签发与验证token","link":"#_5-3-jjwt签发与验证token","children":[]},{"level":3,"title":"#5.4 元动力二奢微服务鉴权代码实现-重点","slug":"_5-4-元动力二奢微服务鉴权代码实现-重点","link":"#_5-4-元动力二奢微服务鉴权代码实现-重点","children":[]}]},{"level":2,"title":"#第4章 商品管理","slug":"第4章-商品管理","link":"#第4章-商品管理","children":[]},{"level":2,"title":"#学习目标","slug":"学习目标-2","link":"#学习目标-2","children":[]},{"level":2,"title":"#1. 分布式ID生成解决方案-面试","slug":"_1-分布式id生成解决方案-面试","link":"#_1-分布式id生成解决方案-面试","children":[{"level":3,"title":"#为什么生成唯一ID","slug":"为什么生成唯一id","link":"#为什么生成唯一id","children":[]},{"level":3,"title":"#1.1 分布式ID生成解决方案","slug":"_1-1-分布式id生成解决方案","link":"#_1-1-分布式id生成解决方案","children":[]},{"level":3,"title":"#1.2 snowflake快速入门-掌握","slug":"_1-2-snowflake快速入门-掌握","link":"#_1-2-snowflake快速入门-掌握","children":[]}]},{"level":2,"title":"#2 新增和修改商品","slug":"_2-新增和修改商品","link":"#_2-新增和修改商品","children":[{"level":3,"title":"#2.1 概念与表结构分析","slug":"_2-1-概念与表结构分析","link":"#_2-1-概念与表结构分析","children":[]},{"level":3,"title":"#2.2 实现思路","slug":"_2-2-实现思路","link":"#_2-2-实现思路","children":[]},{"level":3,"title":"#2.3 代码实现-日常工作","slug":"_2-3-代码实现-日常工作","link":"#_2-3-代码实现-日常工作","children":[]}]},{"level":2,"title":"#3 商品审核与上下架-日常工作","slug":"_3-商品审核与上下架-日常工作","link":"#_3-商品审核与上下架-日常工作","children":[{"level":3,"title":"#3.1 需求分析","slug":"_3-1-需求分析","link":"#_3-1-需求分析","children":[]},{"level":3,"title":"#3.2 实现思路","slug":"_3-2-实现思路","link":"#_3-2-实现思路","children":[]},{"level":3,"title":"#3.3 代码实现","slug":"_3-3-代码实现","link":"#_3-3-代码实现","children":[]}]},{"level":2,"title":"#4 删除与还原商品-日常工作","slug":"_4-删除与还原商品-日常工作","link":"#_4-删除与还原商品-日常工作","children":[{"level":3,"title":"#4.1 需求分析","slug":"_4-1-需求分析-1","link":"#_4-1-需求分析-1","children":[]},{"level":3,"title":"#4.2 实现思路","slug":"_4-2-实现思路","link":"#_4-2-实现思路","children":[]},{"level":3,"title":"#4.3 代码实现","slug":"_4-3-代码实现-1","link":"#_4-3-代码实现-1","children":[]}]},{"level":2,"title":"#第5章 网站首页高可用 nginx+lua","slug":"第5章-网站首页高可用-nginx-lua","link":"#第5章-网站首页高可用-nginx-lua","children":[]},{"level":2,"title":"#学习目标","slug":"学习目标-3","link":"#学习目标-3","children":[]},{"level":2,"title":"#1 Lua介绍","slug":"_1-lua介绍","link":"#_1-lua介绍","children":[{"level":3,"title":"#1.1 lua是什么","slug":"_1-1-lua是什么","link":"#_1-1-lua是什么","children":[]},{"level":3,"title":"#1.2 lua的安装","slug":"_1-2-lua的安装","link":"#_1-2-lua的安装","children":[]},{"level":3,"title":"#1.3 快速入门","slug":"_1-3-快速入门","link":"#_1-3-快速入门","children":[]},{"level":3,"title":"#1.4 LUA的基本语法","slug":"_1-4-lua的基本语法","link":"#_1-4-lua的基本语法","children":[]}]},{"level":2,"title":"#2.nginx+lua+redis实现广告缓存-重点","slug":"_2-nginx-lua-redis实现广告缓存-重点","link":"#_2-nginx-lua-redis实现广告缓存-重点","children":[{"level":3,"title":"#2.2 OpenResty","slug":"_2-2-openresty","link":"#_2-2-openresty","children":[]},{"level":3,"title":"#2.3 实现思路","slug":"_2-3-实现思路","link":"#_2-3-实现思路","children":[]},{"level":3,"title":"#2.4 代码实现","slug":"_2-4-代码实现","link":"#_2-4-代码实现","children":[]}]},{"level":2,"title":"#3 nginx限流","slug":"_3-nginx限流","link":"#_3-nginx限流","children":[{"level":3,"title":"#3.1 控制速率","slug":"_3-1-控制速率","link":"#_3-1-控制速率","children":[]}]}],"git":{},"filePathRelative":"shopping1/buy1.md","excerpt":"\\n<h2>第1章 框架搭建</h2>\\n<p>元动力二奢交易平台：一线互联网大厂的一个<strong>二手奢侈品交易平台</strong>项目</p>\\n<p>总共16章 ：每章都是相对独立的，难度由简单到复杂。</p>\\n<p>前置技术：springboot springcloud(alibaba) es rabbitmq 支付 短信</p>\\n<h2><a class=\\"header-anchor\\" href=\\"#学习目标\\"><span></span></a><a href=\\"https://www.ydlclass.com/doc21xnv/project/mall/01/#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">#</a>学习目标</h2>"}');export{r as comp,d as data};
